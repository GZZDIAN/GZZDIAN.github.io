

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="gaozhe">
  <meta name="keywords" content="">
  
    <meta name="description" content="SpringSecurity å®æˆ˜ç¬¬ä¸€ç«  å¤§ä½“æ¡†æ¶ æƒé™ç®¡ç† SpringSecurity ç®€ä»‹ æ•´ä½“æ¶æ„  1.1 æƒé™ç®¡ç†åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶ï¼ŒæŒ‰ç…§å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥æ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·èº«ä»½è®¤è¯å’Œæˆæƒä¸¤éƒ¨åˆ†ï¼Œç®€ç§°è®¤è¯æˆæƒã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡èº«ä»½è®¤è¯ï¼Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity">
<meta property="og:url" content="http://example.com/2022/01/26/SpringSecurity/index.html">
<meta property="og:site_name" content="gzzear&#39;s blog">
<meta property="og:description" content="SpringSecurity å®æˆ˜ç¬¬ä¸€ç«  å¤§ä½“æ¡†æ¶ æƒé™ç®¡ç† SpringSecurity ç®€ä»‹ æ•´ä½“æ¶æ„  1.1 æƒé™ç®¡ç†åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶ï¼ŒæŒ‰ç…§å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥æ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·èº«ä»½è®¤è¯å’Œæˆæƒä¸¤éƒ¨åˆ†ï¼Œç®€ç§°è®¤è¯æˆæƒã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡èº«ä»½è®¤è¯ï¼Œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110112541559.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110104531129.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110103518334.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110104815645.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110110946267.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110111011018.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110111037603.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113408799.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113534290.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113757100.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114044889.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114109713.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114258671.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114227714.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110120349053.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110115946010.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111211538604.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111211436764.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112095052138.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112095638356.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111100643506.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230716151856457.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230716152418188.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230712144937006.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230214222306844.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230214222758742.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111110043474.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111111244739.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150612023.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150820284.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150929998.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113050533209-2023951.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113054514897-2023963.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062644363-2026405.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113060257662.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062114741.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062617937-2026380.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113114133687.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113115956334.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113125407538-2049649.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113124141492.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113124639102.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212213216653.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212215627835.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220211491.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220651187.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220803330.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212221126723.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212221335962.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060526805.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061756972.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060824066.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061343516.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220114163045543.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215233755090.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215234327892.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230216000810983.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230216095646474.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215224147534.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215230305042.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230718112719806.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230312213646207.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230313214804744.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230312220109915.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215232503921.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215233159036.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230718154226258.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215234757406.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230716212401489.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230313215553853.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323174059920.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323165755959.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323172948891.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220127162622771.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220127162759461.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308185102746.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308190409305.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317194843649.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308191736005.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317195930708.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317200522015.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317201055784.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220318142054096.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230121004712057.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308192413735.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220319124115432.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220319104657210.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220224142025628.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184455083.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184605516.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184651238.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814185157418.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308195448860.png">
<meta property="og:image" content="http://example.com/https%20:/bank.xxx.com/withdraw">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418191456109.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418193519717.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418194059737.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220521074711128.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230402223226568.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220430213210778.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230402223444247-0446086.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220430213344621.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220523110143445.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220523153200373.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409212440889.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409213647550.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409220927740.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409224527191.png">
<meta property="article:published_time" content="2022-01-26T03:53:15.000Z">
<meta property="article:modified_time" content="2023-07-21T09:11:26.179Z">
<meta property="article:author" content="gaozhe">
<meta property="article:tag" content="SpringSecurity">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110112541559.png">
  
  
  
  <title>SpringSecurity - gzzear&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringSecurity"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-01-26 11:53" pubdate>
          2022å¹´1æœˆ26æ—¥ ä¸­åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          272k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          2266 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">SpringSecurity</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="SpringSecurity-å®æˆ˜"><a href="#SpringSecurity-å®æˆ˜" class="headerlink" title="SpringSecurity å®æˆ˜"></a>SpringSecurity å®æˆ˜</h1><h1 id="ç¬¬ä¸€ç« -å¤§ä½“æ¡†æ¶"><a href="#ç¬¬ä¸€ç« -å¤§ä½“æ¡†æ¶" class="headerlink" title="ç¬¬ä¸€ç«  å¤§ä½“æ¡†æ¶"></a>ç¬¬ä¸€ç«  å¤§ä½“æ¡†æ¶</h1><ul>
<li>æƒé™ç®¡ç†</li>
<li>SpringSecurity ç®€ä»‹</li>
<li>æ•´ä½“æ¶æ„</li>
</ul>
<h2 id="1-1-æƒé™ç®¡ç†"><a href="#1-1-æƒé™ç®¡ç†" class="headerlink" title="1.1 æƒé™ç®¡ç†"></a>1.1 æƒé™ç®¡ç†</h2><p>åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°<code>å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶</code>ï¼ŒæŒ‰ç…§<code>å®‰å…¨è§„åˆ™</code>æˆ–è€…<code>å®‰å…¨ç­–ç•¥</code>æ§åˆ¶ç”¨æˆ·<code>å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æº</code>ã€‚</p>
<p>æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>æˆæƒ</strong>ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°<strong>è®¤è¯æˆæƒ</strong>ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡èº«ä»½è®¤è¯ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„è®¿é—®æƒé™æ–¹å¯è®¿é—®ã€‚</p>
<h3 id="1-1-1-è®¤è¯"><a href="#1-1-1-è®¤è¯" class="headerlink" title="1.1.1 è®¤è¯"></a>1.1.1 è®¤è¯</h3><p>**<code>èº«ä»½è®¤è¯</code>**ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚æœ€å¸¸ç”¨çš„ç®€å•èº«ä»½è®¤è¯æ–¹å¼æ˜¯ç³»ç»Ÿé€šè¿‡æ ¸å¯¹ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œçœ‹å…¶æ˜¯å¦ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„è¯¥ç”¨æˆ·çš„ç”¨æˆ·åå’Œå£ä»¤ä¸€è‡´ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚å¯¹äºé‡‡ç”¨<a target="_blank" rel="noopener" href="http://baike.baidu.com/view/5628.htm">æŒ‡çº¹</a>ç­‰ç³»ç»Ÿï¼Œåˆ™å‡ºç¤ºæŒ‡çº¹ï¼›å¯¹äºç¡¬ä»¶Keyç­‰åˆ·å¡ç³»ç»Ÿï¼Œåˆ™éœ€è¦åˆ·å¡ã€‚</p>
<h3 id="1-1-2-æˆæƒ"><a href="#1-1-2-æˆæƒ" class="headerlink" title="1.1.2 æˆæƒ"></a>1.1.2 æˆæƒ</h3><p>**<code>æˆæƒ</code>**ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ä¸»ä½“è¿›è¡Œèº«ä»½è®¤è¯åéœ€è¦åˆ†é…æƒé™æ–¹å¯è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œå¯¹äºæŸäº›èµ„æºæ²¡æœ‰æƒé™æ˜¯æ— æ³•è®¿é—®çš„</p>
<h3 id="1-1-3-è§£å†³æ–¹æ¡ˆ"><a href="#1-1-3-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="1.1.3 è§£å†³æ–¹æ¡ˆ"></a>1.1.3 è§£å†³æ–¹æ¡ˆ</h3><p>å’Œå…¶ä»–é¢†åŸŸä¸åŒï¼Œåœ¨ Java ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œå®‰å…¨ç®¡ç†æ¡†æ¶éå¸¸å°‘ï¼Œç›®å‰æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ï¼š</p>
<ul>
<li>Shiro<ul>
<li>Shiro æœ¬èº«æ˜¯ä¸€ä¸ªè€ç‰Œçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œæœ‰ç€ä¼—å¤šçš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚è½»é‡ã€ç®€å•ã€æ˜“äºé›†æˆã€å¯ä»¥åœ¨JavaSEç¯å¢ƒä¸­ä½¿ç”¨ç­‰ã€‚ä¸è¿‡ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼ŒShiro å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ï¼Œåœ¨å¾®æœåŠ¡é¢å‰å’Œæ‰©å±•æ–¹é¢ï¼Œæ— æ³•å……åˆ†å±•ç¤ºè‡ªå·±çš„ä¼˜åŠ¿ã€‚</li>
</ul>
</li>
<li>å¼€å‘è€…è‡ªå®šä¹‰<ul>
<li>ä¹Ÿæœ‰å¾ˆå¤šå…¬å¸é€‰æ‹©è‡ªå®šä¹‰æƒé™ï¼Œå³è‡ªå·±å¼€å‘æƒé™ç®¡ç†ã€‚ä½†æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯ç™»å½•å’Œæƒé™æ§åˆ¶è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ç§å„æ ·å¯èƒ½å­˜åœ¨çš„ç½‘ç»œæ”¿å‡»ä»¥åŠé˜²å½»ç­–ç•¥ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œå¼€å‘è€…ç™½å·±å®ç°å®‰å…¨ç®¡ç†ä¹Ÿå¹¶éæ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œåªæœ‰å¤§å…¬å¸æ‰æœ‰è¶³å¤Ÿçš„äººåŠ›ç‰©åŠ›å»æ”¯æŒè¿™ä»¶äº‹æƒ…ã€‚</li>
</ul>
</li>
<li>Spring Security<ul>
<li>Spring Security,ä½œä¸ºspring å®¶æ—çš„ä¸€å‘˜ï¼Œåœ¨å’Œ Spring å®¶æ—çš„å…¶ä»–æˆå‘˜å¦‚ Spring Boot Spring Clondç­‰è¿›è¡Œæ•´åˆæ—¶ï¼Œå…·æœ‰å…¶ä»–æ¡†æ¶æ— å¯æ¯”æ‹Ÿçš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¯¹ OAuth2 æœ‰ç€è‰¯å¥½çš„æ”¯æŒï¼Œå†åŠ ä¸ŠSpring Cloudå¯¹ Spring Securityçš„ä¸æ–­åŠ æŒï¼ˆå¦‚æ¨å‡º Spring Cloud Security )ï¼Œè®© Spring Securiy ä¸çŸ¥ä¸è§‰ä¸­æˆä¸ºå¾®æœåŠ¡é¡¹ç›®çš„é¦–é€‰å®‰å…¨ç®¡ç†æ–¹æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<h2 id="1-2-ç®€ä»‹"><a href="#1-2-ç®€ä»‹" class="headerlink" title="1.2 ç®€ä»‹"></a>1.2 ç®€ä»‹</h2><h3 id="1-2-1-å®˜æ–¹å®šä¹‰"><a href="#1-2-1-å®˜æ–¹å®šä¹‰" class="headerlink" title="1.2.1 å®˜æ–¹å®šä¹‰"></a>1.2.1 å®˜æ–¹å®šä¹‰</h3><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li>
</ul>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
<p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚å®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªé¢å‘Javaåº”ç”¨ç¨‹åºæä¾›èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§çš„æ¡†æ¶ã€‚ä¸æ‰€æœ‰Springé¡¹ç›®ä¸€æ ·ï¼ŒSpring Securityçš„çœŸæ­£å¨åŠ›åœ¨äºå®ƒå¯ä»¥è½»æ¾åœ°æ‰©å±•ä»¥æ»¡è¶³å®šåˆ¶éœ€æ±‚ã€‚</p>
<ul>
<li>æ€»ç»“</li>
</ul>
<blockquote>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„<code>èº«ä»½éªŒè¯</code>å’Œ<code>è®¿é—®æ§åˆ¶</code>çš„æ¡†æ¶ã€‚æˆ–è€…è¯´ç”¨æ¥å®ç°ç³»ç»Ÿä¸­æƒé™ç®¡ç†çš„æ¡†æ¶ã€‚</p>
</blockquote>
<h3 id="1-2-2-å†å²"><a href="#1-2-2-å†å²" class="headerlink" title="1.2.2 å†å²"></a>1.2.2 å†å²</h3><p>Spring Security æœ€æ—©å« Acegi Securityï¼Œ è¿™ä¸ªåç§°å¹¶ä¸æ˜¯è¯´å®ƒå’Œ Spring å°±æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¾ç„¶æ˜¯ä¸ºSpring æ¡†æ¶æä¾›å®‰å…¨æ”¯æŒçš„ã€‚Acegi Security åŸºäº Springï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸ºé¡¹ç›®å»ºç«‹ä¸°å¯Œçš„è§’è‰²ä¸æƒé™ç®¡ç†ç³»ç»Ÿã€‚Acegi security è™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„åˆ™æ˜¯å®ƒè‡ƒè‚¿çƒ¦ççš„é…ç½®è¿™ä¸€é—®é¢˜æœ€ç»ˆä¹Ÿé—ä¼ ç»™äº† Spring Securityã€‚</p>
<p>â€‹	Acegi Security æœ€ç»ˆè¢«å¹¶å…¥ Spring Security é¡¹ç›®ä¸­ï¼Œå¹¶äº 2008 å¹´4æœˆå‘å¸ƒäº†æ”¹ååçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Spring Security 2.0.0ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Security çš„æœ€æ–°ç‰ˆæœ¬å·±ç»åˆ°äº† 5.6.1ã€‚å’Œ Shiro ç›¸æ¯”ï¼ŒSpring Securityé‡é‡çº§å¹¶ä¸”é…ç½®çƒ¦çï¼Œç›´è‡³ä»Šå¤©ï¼Œä¾ç„¶æœ‰äººä»¥æ­¤ä¸ºç†ç”±è€Œæ‹’ç»äº†è§£ Spring Securityã€‚å…¶å®ï¼Œè‡ªä» Spring Boot æ¨å‡ºåï¼Œå°±å½»åº•é¢ è¦†äº†ä¼ ç»Ÿäº† JavaEE å¼€å‘ï¼Œè‡ªåŠ¨åŒ–é…ç½®è®©è®¸å¤šäº‹æƒ…å˜å¾—éå¸¸å®¹æ˜“ï¼ŒåŒ…æ‹¬ Spring Security çš„é…ç½®ã€‚åœ¨ä¸€ä¸ª Spring Boot é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–é…ç½®ï¼Œé¡¹ç›®çš„æ‰€æœ‰æ¥å£å°±ä¼šè¢«è‡ªåŠ¨ä¿æŠ¤èµ·æ¥äº†ã€‚åœ¨ Spring Cloudä¸­ï¼Œå¾ˆå¤šæ¶‰åŠå®‰å…¨ç®¡ç†çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Spring Security ä¾èµ–ä¸¤è¡Œé…ç½®å°±èƒ½æå®šï¼Œåœ¨å’Œ Spring å®¶æ—çš„äº§å“ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒSpring Security çš„ä¼˜åŠ¿å°±éå¸¸æ˜æ˜¾äº†ã€‚</p>
<p>â€‹	å› æ­¤ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼Œæˆ‘ä»¬ä¸éœ€è¦çº ç»“è¦ä¸è¦å­¦ä¹  Spring Securityï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•å¿«é€ŸæŒæ¡Spring Securityï¼Œ å¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ Spring Security å®ç°æˆ‘ä»¬å¾®æœåŠ¡çš„å®‰å…¨ç®¡ç†ã€‚</p>
<h2 id="1-3-æ•´ä½“æ¶æ„"><a href="#1-3-æ•´ä½“æ¶æ„" class="headerlink" title="1.3 æ•´ä½“æ¶æ„"></a>1.3 æ•´ä½“æ¶æ„</h2><p>åœ¨<Spring security>çš„æ¶æ„è®¾è®¡ä¸­ï¼Œ**<code>è®¤è¯</code><strong><Authentication>å’Œ</Authentication></strong><code>æˆæƒ</code>** <Authorization>æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼ã€‚éƒ½ä¸ä¼šå½±å“æˆæƒï¼Œè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å­˜åœ¨ï¼Œè¿™ç§ç‹¬ç«‹å¸¦æ¥çš„å¥½å¤„ä¹‹ä¸€ï¼Œå°±æ˜¯å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ•´åˆä¸€äº›å¤–éƒ¨çš„è§£å†³æ–¹æ¡ˆã€‚</Authorization></Spring></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110112541559.png" srcset="/img/loading.gif" lazyload alt="image-20220110112541559"></p>
<h3 id="1-3-1-è®¤è¯"><a href="#1-3-1-è®¤è¯" class="headerlink" title="1.3.1 è®¤è¯"></a>1.3.1 è®¤è¯</h3><h4 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h4><p>åœ¨Spring Securityä¸­è®¤è¯æ˜¯ç”±<code>AuthenticationManager</code>æ¥å£æ¥è´Ÿè´£çš„ï¼Œæ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110104531129.png" srcset="/img/loading.gif" lazyload alt="image-20220110104531129"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123; <br>	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <br>  														<span class="hljs-keyword">throws</span> AuthenticationException;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>è¿”å› Authentication è¡¨ç¤ºè®¤è¯æˆåŠŸ</li>
<li>è¿”å› AuthenticationException å¼‚å¸¸ï¼Œè¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚</li>
</ul>
<p>AuthenticationManager ä¸»è¦å®ç°ç±»ä¸º ProviderManagerï¼Œåœ¨ ProviderManager ä¸­ç®¡ç†äº†ä¼—å¤š AuthenticationProvider å®ä¾‹ã€‚åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯æµç¨‹ä¸­ï¼ŒSpring Security å…è®¸å­˜åœ¨å¤šä¸ª AuthenticationProvider ï¼Œç”¨æ¥å®ç°å¤šç§è®¤è¯æ–¹å¼ï¼Œè¿™äº› AuthenticationProvider éƒ½æ˜¯ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†çš„ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110103518334.png" srcset="/img/loading.gif" lazyload alt="image-20220110103518334"></p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>è®¤è¯ä»¥åŠè®¤è¯æˆåŠŸçš„ä¿¡æ¯ä¸»è¦æ˜¯ç”± Authentication çš„å®ç°ç±»è¿›è¡Œä¿å­˜çš„ï¼Œå…¶æ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110104815645.png" srcset="/img/loading.gif" lazyload alt="image-20220110104815645"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable &#123;<br>	Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br>	Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;<br>	Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;<br>	Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;<br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;<br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isAuthenticated)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>getAuthorities 	 è·å–ç”¨æˆ·æƒé™ä¿¡æ¯</li>
<li>getCredentials 	è·å–ç”¨æˆ·å‡­è¯ä¿¡æ¯ï¼Œä¸€èˆ¬æŒ‡å¯†ç </li>
<li>getDetails 			 è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</li>
<li>getPrincipal 		 è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œç”¨æˆ·åã€ç”¨æˆ·å¯¹è±¡ç­‰</li>
<li>isAuthenticated   ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸ</li>
</ul>
<h4 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>SecurityContextHolder ç”¨æ¥è·å–ç™»å½•ä¹‹åç”¨æˆ·ä¿¡æ¯ã€‚Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ° SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°† Security SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚è¿™ä¸€ç­–ç•¥éå¸¸æ–¹ä¾¿ç”¨æˆ·åœ¨ Controllerã€Service å±‚ä»¥åŠä»»ä½•ä»£ç ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·æ•°æ®ã€‚</p>
<h3 id="1-3-2-æˆæƒ"><a href="#1-3-2-æˆæƒ" class="headerlink" title="1.3.2 æˆæƒ"></a>1.3.2 æˆæƒ</h3><p>å½“å®Œæˆè®¤è¯åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆæƒäº†ã€‚åœ¨ Spring Security çš„æˆæƒä½“ç³»ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ¥å£ï¼Œ</p>
<h4 id="AccessDecisionManager"><a href="#AccessDecisionManager" class="headerlink" title="AccessDecisionManager"></a>AccessDecisionManager</h4><blockquote>
<p> AccessDecisionManager (è®¿é—®å†³ç­–ç®¡ç†å™¨)ï¼Œç”¨æ¥å†³å®šæ­¤æ¬¡è®¿é—®æ˜¯å¦è¢«å…è®¸ã€‚</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110110946267.png" srcset="/img/loading.gif" lazyload alt="image-20220110110946267"></p>
<h4 id="AccessDecisionVoter"><a href="#AccessDecisionVoter" class="headerlink" title="AccessDecisionVoter"></a>AccessDecisionVoter</h4><blockquote>
<p>AccessDecisionVoter (è®¿é—®å†³å®šæŠ•ç¥¨å™¨)ï¼ŒæŠ•ç¥¨å™¨ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡åº”æœ‰çš„è§’è‰²ï¼Œè¿›è€ŒæŠ•å‡ºèµæˆã€åå¯¹æˆ–è€…å¼ƒæƒç¥¨ã€‚</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110111011018.png" srcset="/img/loading.gif" lazyload alt="image-20220110111011018"></p>
<p>AccesDecisionVoter å’Œ AccessDecisionManager éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</p>
<h4 id="ConfigAttribute"><a href="#ConfigAttribute" class="headerlink" title="ConfigAttribute"></a>ConfigAttribute</h4><blockquote>
<p>ConfigAttributeï¼Œç”¨æ¥ä¿å­˜æˆæƒæ—¶çš„è§’è‰²ä¿¡æ¯</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110111037603.png" srcset="/img/loading.gif" lazyload alt="image-20220110111037603"></p>
<p>åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ª<br>èµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</p>
<h1 id="ç¬¬äºŒç« -è®¤è¯åŸç†"><a href="#ç¬¬äºŒç« -è®¤è¯åŸç†" class="headerlink" title="ç¬¬äºŒç«  è®¤è¯åŸç†"></a>ç¬¬äºŒç«  è®¤è¯åŸç†</h1><ul>
<li>ç¯å¢ƒæ­å»º</li>
<li>è‡ªåŠ¨é…ç½®ç»†èŠ‚</li>
</ul>
<h2 id="2-1-ç¯å¢ƒæ­å»º"><a href="#2-1-ç¯å¢ƒæ­å»º" class="headerlink" title="2.1 ç¯å¢ƒæ­å»º"></a>2.1 ç¯å¢ƒæ­å»º</h2><ul>
<li>spring boot </li>
<li>spring security<ul>
<li>è®¤è¯: åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç³»ç»Ÿåˆæ³•ç”¨æˆ·è¿‡ç¨‹</li>
<li>æˆæƒ: åˆ¤æ–­ç³»ç»Ÿå†…ç”¨æˆ·å¯ä»¥è®¿é—®æˆ–å…·æœ‰è®¿é—®é‚£äº›èµ„æºæƒé™è¿‡ç¨‹</li>
</ul>
</li>
</ul>
<h3 id="2-1-1-åˆ›å»ºé¡¹ç›®"><a href="#2-1-1-åˆ›å»ºé¡¹ç›®" class="headerlink" title="2.1.1 åˆ›å»ºé¡¹ç›®"></a>2.1.1 åˆ›å»ºé¡¹ç›®</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 1.åˆ›å»º springboot åº”ç”¨</span><br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113408799.png" srcset="/img/loading.gif" lazyload alt="image-20220110113408799"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 2.åˆ›å»º controller</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello security&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello security&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113534290.png" srcset="/img/loading.gif" lazyload alt="image-20220110113534290"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 3.å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•</span><br><span class="hljs-bullet">-</span> http://localhost:8080/hello<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113757100.png" srcset="/img/loading.gif" lazyload alt="image-20220110113757100"></p>
<h3 id="2-1-2-æ•´åˆ-Spring-Security"><a href="#2-1-2-æ•´åˆ-Spring-Security" class="headerlink" title="2.1.2 æ•´åˆ Spring Security"></a>2.1.2 æ•´åˆ Spring Security</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 1.å¼•å…¥spring securityç›¸å…³ä¾èµ–</span><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--å¼•å…¥spring securityä¾èµ–--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 2.å†æ¬¡å¯åŠ¨é¡¹ç›®</span><br><span class="hljs-bullet">-</span> 1.å¯åŠ¨å®Œæˆåæ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªå¯†ç <br><span class="hljs-bullet">-</span> 2.è®¿é—® hello å‘ç°ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110114044889.png" srcset="/img/loading.gif" lazyload alt="image-20220110114044889"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110114109713.png" srcset="/img/loading.gif" lazyload alt="image-20220110114109713"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 3.ç™»å½•ç³»ç»Ÿ</span><br><span class="hljs-bullet">-</span> é»˜è®¤ç”¨æˆ·åä¸º: user<br><span class="hljs-bullet">-</span> é»˜è®¤å¯†ç ä¸º:  æ§åˆ¶å°æ‰“å°çš„ uuid<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110114258671.png" srcset="/img/loading.gif" lazyload alt="image-20220110114258671"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110114227714.png" srcset="/img/loading.gif" lazyload alt="image-20220110114227714"></p>
<p><strong>è¿™å°±æ˜¯ Spring Security çš„å¼ºå¤§ä¹‹å¤„ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œæ‰€æœ‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨ä¿æŠ¤èµ·æ¥ï¼</strong></p>
<p>æ€è€ƒğŸ¤”?</p>
<ul>
<li><p>ä¸ºä»€ä¹ˆå¼•å…¥ Spring Security ä¹‹å<code>æ²¡æœ‰ä»»ä½•é…ç½®æ‰€æœ‰è¯·æ±‚å°±è¦è®¤è¯</code>å‘¢?</p>
</li>
<li><p>åœ¨é¡¹ç›®ä¸­æ˜æ˜æ²¡æœ‰ç™»å½•ç•Œé¢ï¼Œ<code>ç™»å½•ç•Œé¢</code>æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
</li>
<li><p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>user</code> å’Œ <code>æ§åˆ¶å°å¯†ç </code> èƒ½ç™»é™†ï¼Œç™»å½•æ—¶éªŒè¯æ•°æ®æºå­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
</li>
</ul>
<h3 id="2-1-3-å®ç°åŸç†"><a href="#2-1-3-å®ç°åŸç†" class="headerlink" title="2.1.3 å®ç°åŸç†"></a>2.1.3 å®ç°åŸç†</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture</a></p>
<p>è™½ç„¶å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œå°±å¯ä»¥è®© Spring Security å¯¹åº”ç”¨è¿›è¡Œä¿æŠ¤ã€‚Spring Security åˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ Spring Security ä¸­ <code>è®¤è¯ã€æˆæƒ</code> ç­‰åŠŸèƒ½éƒ½æ˜¯åŸºäº<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">è¿‡æ»¤å™¨</a>å®Œæˆçš„ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110120349053.png" srcset="/img/loading.gif" lazyload alt="image-20220110120349053"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110115946010.png" srcset="/img/loading.gif" lazyload alt="image-20220110115946010"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤è¿‡æ»¤å™¨å¹¶ä¸æ˜¯ç›´æ¥æ”¾åœ¨ Web é¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<br>FlterChainProxy æ¥ç»Ÿä¸€ç®¡ç†ã€‚Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾é€šè¿‡ FilterChainProxy åµŒå…¥åˆ° Webé¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ã€‚FilterChainProxy  ä½œä¸ºä¸€ä¸ªé¡¶å±‚çš„ç®¡ç†è€…ï¼Œå°†ç»Ÿä¸€ç®¡ç† Security Filterã€‚FilterChainProxy æœ¬èº«æ˜¯é€šè¿‡ Spring æ¡†æ¶æä¾›çš„ DelegatingFilterProxy æ•´åˆåˆ°åŸç”Ÿçš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p>
<h4 id="Security-Filters"><a href="#Security-Filters" class="headerlink" title="Security Filters"></a>Security Filters</h4><p>é‚£ä¹ˆåœ¨ Spring Security ä¸­ç»™æˆ‘ä»¬æä¾›é‚£äº›è¿‡æ»¤å™¨? é»˜è®¤æƒ…å†µä¸‹é‚£äº›è¿‡æ»¤å™¨ä¼šè¢«åŠ è½½å‘¢ï¼Ÿ</p>
<table>
<thead>
<tr>
<th>è¿‡æ»¤å™¨</th>
<th>è¿‡æ»¤å™¨ä½œç”¨</th>
<th>é»˜è®¤æ˜¯å¦åŠ è½½</th>
</tr>
</thead>
<tbody><tr>
<td>ChannelProcessingFilter</td>
<td>è¿‡æ»¤è¯·æ±‚åè®® HTTP ã€HTTPS</td>
<td>NO</td>
</tr>
<tr>
<td><code>WebAsyncManagerIntegrationFilter</code></td>
<td>å°† WebAsyncManger ä¸ SpringSecurity ä¸Šä¸‹æ–‡è¿›è¡Œé›†æˆ</td>
<td>YES</td>
</tr>
<tr>
<td><code>SecurityContextPersistenceFilter</code></td>
<td>åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰,å°†å®‰å…¨ä¿¡æ¯åŠ è½½åˆ° SecurityContextHolder ä¸­</td>
<td>YES</td>
</tr>
<tr>
<td><code>HeaderWriterFilter</code></td>
<td>å¤„ç†å¤´ä¿¡æ¯åŠ å…¥å“åº”ä¸­</td>
<td>YES</td>
</tr>
<tr>
<td>CorsFilter</td>
<td>å¤„ç†è·¨åŸŸé—®é¢˜</td>
<td>NO</td>
</tr>
<tr>
<td><code>CsrfFilter</code></td>
<td>å¤„ç† CSRF æ”»å‡»</td>
<td>YES</td>
</tr>
<tr>
<td><code>LogoutFilter</code></td>
<td>å¤„ç†æ³¨é”€ç™»å½•</td>
<td>YES</td>
</tr>
<tr>
<td>OAuth2AuthorizationRequestRedirectFilter</td>
<td>å¤„ç† OAuth2 è®¤è¯é‡å®šå‘</td>
<td>NO</td>
</tr>
<tr>
<td>Saml2WebSsoAuthenticationRequestFilter</td>
<td>å¤„ç† SAML è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td>X509AuthenticationFilter</td>
<td>å¤„ç† X509 è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td>AbstractPreAuthenticatedProcessingFilter</td>
<td>å¤„ç†é¢„è®¤è¯é—®é¢˜</td>
<td>NO</td>
</tr>
<tr>
<td>CasAuthenticationFilter</td>
<td>å¤„ç† CAS å•ç‚¹ç™»å½•</td>
<td>NO</td>
</tr>
<tr>
<td>OAuth2LoginAuthenticationFilter</td>
<td>å¤„ç† OAuth2 è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td>Saml2WebSsoAuthenticationFilter</td>
<td>å¤„ç† SAML è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td><code>UsernamePasswordAuthenticationFilter</code></td>
<td>å¤„ç†è¡¨å•ç™»å½•</td>
<td>YES</td>
</tr>
<tr>
<td>OpenIDAuthenticationFilter</td>
<td>å¤„ç† OpenID è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td><code>DefaultLoginPageGeneratingFilter</code></td>
<td>é…ç½®é»˜è®¤ç™»å½•é¡µé¢</td>
<td>YES</td>
</tr>
<tr>
<td><code>DefaultLogoutPageGeneratingFilter</code></td>
<td>é…ç½®é»˜è®¤æ³¨é”€é¡µé¢</td>
<td>YES</td>
</tr>
<tr>
<td>ConcurrentSessionFilter</td>
<td>å¤„ç† Session æœ‰æ•ˆæœŸ</td>
<td>NO</td>
</tr>
<tr>
<td>DigestAuthenticationFilter</td>
<td>å¤„ç† HTTP æ‘˜è¦è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td>BearerTokenAuthenticationFilter</td>
<td>å¤„ç† OAuth2 è®¤è¯çš„ Access Token</td>
<td>NO</td>
</tr>
<tr>
<td><code>BasicAuthenticationFilter</code></td>
<td>å¤„ç† HttpBasic ç™»å½•</td>
<td>YES</td>
</tr>
<tr>
<td><code>RequestCacheAwareFilter</code></td>
<td>å¤„ç†è¯·æ±‚ç¼“å­˜</td>
<td>YES</td>
</tr>
<tr>
<td><code>SecurityContextHolder&lt;br /&gt;AwareRequestFilter</code></td>
<td>åŒ…è£…åŸå§‹è¯·æ±‚</td>
<td>YES</td>
</tr>
<tr>
<td>JaasApiIntegrationFilter</td>
<td>å¤„ç† JAAS è®¤è¯</td>
<td>NO</td>
</tr>
<tr>
<td>RememberMeAuthenticationFilter</td>
<td>å¤„ç† RememberMe ç™»å½•</td>
<td>NO</td>
</tr>
<tr>
<td><code>AnonymousAuthenticationFilter</code></td>
<td>é…ç½®åŒ¿åè®¤è¯</td>
<td>YES</td>
</tr>
<tr>
<td>OAuth2AuthorizationCodeGrantFilter</td>
<td>å¤„ç†OAuth2è®¤è¯ä¸­æˆæƒç </td>
<td>NO</td>
</tr>
<tr>
<td><code>SessionManagementFilter</code></td>
<td>å¤„ç† session å¹¶å‘é—®é¢˜</td>
<td>YES</td>
</tr>
<tr>
<td><code>ExceptionTranslationFilter</code></td>
<td>å¤„ç†è®¤è¯&#x2F;æˆæƒä¸­çš„å¼‚å¸¸</td>
<td>YES</td>
</tr>
<tr>
<td><code>FilterSecurityInterceptor</code></td>
<td>å¤„ç†æˆæƒç›¸å…³</td>
<td>YES</td>
</tr>
<tr>
<td>SwitchUserFilter</td>
<td>å¤„ç†è´¦æˆ·åˆ‡æ¢</td>
<td>NO</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹å‡ºï¼ŒSpring Security æä¾›äº† 30 å¤šä¸ªè¿‡æ»¤å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹Spring Boot åœ¨å¯¹ Spring Security è¿›å…¥è‡ªåŠ¨åŒ–é…ç½®æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º <strong>SpringSecurityFilerChain</strong> çš„è¿‡æ»¤å™¨ï¼Œå¹¶æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨å°†è´Ÿè´£æ‰€æœ‰çš„å®‰å…¨ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€æˆæƒã€é‡å®šå‘åˆ°ç™»å½•é¡µé¢ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒWebSecurityConfigurationçš„æºç :</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111211538604.png" srcset="/img/loading.gif" lazyload alt="image-20220111211538604"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111211436764.png" srcset="/img/loading.gif" lazyload alt="image-20220111211436764"></p>
<h4 id="SpringBootWebSecurityConfiguration"><a href="#SpringBootWebSecurityConfiguration" class="headerlink" title="SpringBootWebSecurityConfiguration"></a>SpringBootWebSecurityConfiguration</h4><p>è¿™ä¸ªç±»æ˜¯ spring boot è‡ªåŠ¨é…ç½®ç±»ï¼Œé€šè¿‡è¿™ä¸ªæºç å¾—çŸ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæƒé™æ§åˆ¶:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnDefaultWebSecurity</span><br><span class="hljs-meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringBootWebSecurityConfiguration</span> &#123;<br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span><br>	SecurityFilterChain <span class="hljs-title function_">defaultSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <br>    <span class="hljs-keyword">throws</span> Exception &#123;<br>			http.authorizeRequests().anyRequest()<br>      .authenticated().and().formLogin().and().httpBasic();<br>		<span class="hljs-keyword">return</span> http.build();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220112095052138.png" srcset="/img/loading.gif" lazyload alt="image-20220112095052138"></p>
<p><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼•å…¥ Spring Security ä¸­æ²¡æœ‰ä»»ä½•é…ç½®æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¼šè¢«æ‹¦æˆªçš„åŸå› ï¼</strong></p>
<p>é€šè¿‡ä¸Šé¢å¯¹è‡ªåŠ¨é…ç½®åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºé»˜è®¤ç”Ÿæ•ˆæ¡ä»¶ä¸º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultWebSecurityCondition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AllNestedConditions</span> &#123;<br><br>	DefaultWebSecurityCondition() &#123;<br>		<span class="hljs-built_in">super</span>(ConfigurationPhase.REGISTER_BEAN);<br>	&#125;<br><br>	<span class="hljs-meta">@ConditionalOnClass(&#123; SecurityFilterChain.class, HttpSecurity.class &#125;)</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Classes</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-meta">@ConditionalOnMissingBean(&#123; WebSecurityConfigurerAdapter.class, SecurityFilterChain.class &#125;)</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Beans</span> &#123;<br><br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¡ä»¶ä¸€ classpathä¸­å­˜åœ¨ SecurityFilterChain.class, HttpSecurity.class</li>
<li>æ¡ä»¶äºŒ æ²¡æœ‰è‡ªå®šä¹‰ WebSecurityConfigurerAdapter.class, SecurityFilterChain.class</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„ã€‚WebSecurityConfigurerAdapter è¿™ä¸ªç±»æå…¶é‡è¦ï¼ŒSpring Security æ ¸å¿ƒé…ç½®éƒ½åœ¨è¿™ä¸ªç±»ä¸­:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112095638356.png" srcset="/img/loading.gif" lazyload alt="image-20220112095638356"></p>
<p>å¦‚æœè¦å¯¹ Spring Security è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œå°±è¦è‡ªå®šä¹‰è¿™ä¸ªç±»å®ä¾‹ï¼Œé€šè¿‡è¦†ç›–ç±»ä¸­æ–¹æ³•è¾¾åˆ°ä¿®æ”¹é»˜è®¤é…ç½®çš„ç›®çš„ã€‚</p>
<h3 id="2-1-4-ç™»å½•ç•Œé¢è½¬å‘æµç¨‹åˆ†æ"><a href="#2-1-4-ç™»å½•ç•Œé¢è½¬å‘æµç¨‹åˆ†æ" class="headerlink" title="2.1.4 ç™»å½•ç•Œé¢è½¬å‘æµç¨‹åˆ†æ"></a>2.1.4 ç™»å½•ç•Œé¢è½¬å‘æµç¨‹åˆ†æ</h3><p><img src="/2022/01/26/SpringSecurity/image-20220111100643506.png" srcset="/img/loading.gif" lazyload alt="image-20220111100643506"></p>
<ol>
<li>è¯·æ±‚ &#x2F;hello æ¥å£ï¼Œåœ¨å¼•å…¥ spring security ä¹‹åä¼šå…ˆç»è¿‡ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨</li>
<li>åœ¨è¯·æ±‚åˆ°è¾¾<strong>FilterSecurityInterceptor</strong>æ—¶ï¼Œå‘ç°è¯·æ±‚å¹¶æœªè®¤è¯ã€‚è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¹¶æŠ›å‡º <strong>AccessDeniedException</strong> å¼‚å¸¸ã€‚</li>
<li>æŠ›å‡º <strong>AccessDeniedException</strong> çš„å¼‚å¸¸ä¼šè¢« <strong>ExceptionTranslationFilter</strong> æ•è·ï¼Œè¿™ä¸ª Filter ä¸­ä¼šè°ƒç”¨ <strong>LoginUrlAuthenticationEntryPoint</strong>#<strong>commence</strong> æ–¹æ³•ç»™å®¢æˆ·ç«¯è¿”å› 302ï¼Œè¦æ±‚å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘åˆ° &#x2F;login é¡µé¢ã€‚</li>
<li>å®¢æˆ·ç«¯å‘é€ &#x2F;login è¯·æ±‚ã€‚</li>
<li>&#x2F;login è¯·æ±‚ä¼šå†æ¬¡è¢«æ‹¦æˆªå™¨ä¸­ <strong>DefaultLoginPageGeneratingFilter</strong> æ‹¦æˆªåˆ°ï¼Œå¹¶åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›ç”Ÿæˆç™»å½•é¡µé¢ã€‚</li>
</ol>
<p><strong>å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Security é»˜è®¤è¿‡æ»¤å™¨ä¸­ç”Ÿæˆäº†ç™»å½•é¡µé¢ï¼Œå¹¶è¿”å›ï¼</strong></p>
<h3 id="2-1-5-è®¤è¯æµç¨‹æºç åˆ†æ"><a href="#2-1-5-è®¤è¯æµç¨‹æºç åˆ†æ" class="headerlink" title="2.1.5 è®¤è¯æµç¨‹æºç åˆ†æ"></a>2.1.5 è®¤è¯æµç¨‹æºç åˆ†æ</h3><p>åœ¨åˆ†æç›¸å…³æºç ä¹‹å‰, æˆ‘ä»¬çš„å…ˆè®¤è¯†ä¸‹ä¸ä¹‹ç›¸å…³çš„åŸºæœ¬ç»„ä»¶: AuthenticationManagerã€ProviderManagerã€AuthenticationProvider</p>
<blockquote>
<p>AuthenticationManager</p>
</blockquote>
<p>ä»åç§°ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒAuthenticationManager æ˜¯ ä¸€ä¸ªè®¤è¯ç®¡ç†å™¨ï¼Œå®ƒå®šä¹‰äº†Spring Security è¿‡æ»¤å™¨è¦å¦‚ä½•æ‰§è¡Œè®¤è¯æ“ä½œã€‚AuthenticationManager åœ¨è®¤è¯æˆåŠŸåï¼Œä¼šè¿”å› ä¸€ä¸ªAuthenticationå¯¹è±¡ï¼Œè¿™ä¸ªAuthentication å¯¹è±¡ä¼šè¢«è®¾ç½®åˆ°SecurityContextEfolder ä¸­ã€‚å¦‚æœå¼€å‘è€…ä¸æƒ³ç”¨Spring Securityæä¾›çš„ ä¸€å¥—è®¤è¯æœºåˆ¶ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥è‡ªå®šä¹‰è®¤è¯æµç¨‹ï¼Œè®¤è¯æˆåŠŸåï¼Œæ‰‹åŠ¨å°†Authenticationå­˜å…¥SecurityContextHolder ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123;<br><br>	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä» AuthenticationManagerçš„æºç ä¸­å¯ä»¥çœ‹åˆ°:</p>
<ul>
<li>AuthenticationManager å¯¹ä¼ å…¥çš„ Authentication å¯¹è±¡è¿›è¡Œèº«ä»½è®¤è¯ï¼Œæ­¤æ—¶ä¼ å…¥çš„ Authentication å‚æ•°åªæœ‰ç”¨æˆ·å&#x2F;å¯†ç ç­‰ç®€å•çš„å±æ€§ï¼Œå¦‚æœè®¤è¯æˆåŠŸï¼Œè¿”å›çš„Authentication çš„å±æ€§ä¼šå¾—åˆ°å®Œå…¨å¡«å……ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ‰€å…·å¤‡çš„è§’è‰²ä¿¡æ¯.</li>
<li>AuthenticationManageræ˜¯ä¸€ä¸ªæ¥å£,å®ƒæœ‰ç€è¯¸å¤šçš„å®ç°ç±», å¼€å‘è€…ä¹Ÿå¯ä»¥è‡ªå®šä¹‰AuthenticationManager çš„å®ç°ç±»ï¼Œä¸è¿‡åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„æ˜¯ProviderManagerã€‚åœ¨ SpringSecurityæ¡†æ¶ä¸­ï¼Œé»˜è®¤ä¹Ÿæ˜¯ä½¿ç”¨Provide Managerã€‚</li>
</ul>
<blockquote>
<p>ProviderManager</p>
</blockquote>
<p><strong>ProviderManager</strong> æ˜¯<strong>AuthenticationManager</strong> çš„ ä¸€ä¸ªé‡è¦å®ç°ç±»ã€‚åœ¨å¼€å§‹å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ä¸€å¹…å›¾æ¥äº†è§£ä¸€ä¸‹<strong>ProviderManager</strong>ã€<strong>AuthenticationProvider</strong> ä¹‹é—´çš„å…³ç³»</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230716151856457.png" srcset="/img/loading.gif" lazyload alt="image-20230716151856457"></p>
<ul>
<li>åœ¨Spring Security ä¸­ï¼Œç”±äºç³»ç»Ÿå¯èƒ½åŒæ—¶æ”¯ç‰¹å¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¾‹å¦‚åŒæ—¶æ”¯æŒç”¨æˆ·åã€å¯†ç è®¤è¯ã€RememberMe è®¤è¯ã€æ‰‹æœºå·ç åŠ¨æ€è®¤è¯ç­‰ï¼Œè€Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”äº†ä¸åŒçš„ <strong>AuthenticationProvider</strong>ï¼Œæ‰€ä»¥ ä¸€ä¸ªå®Œæ•´çš„è®¤è¯æµç¨‹å¯èƒ½ç”±å¤šä¸ª<strong>AuthenticationProvider</strong> æ¥æä¾›ã€‚</li>
<li>å¤šä¸ª<strong>AuthenticationProvider</strong>å°†ç»„æˆ ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°†ç”±<strong>ProviderManager</strong>ä»£ç†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨<strong>ProviderManager</strong> ä¸­å­˜åœ¨ä¸€ä¸ª<strong>AuthenticationProvider</strong> åˆ—è¡¨ï¼Œåœ¨<strong>ProviderManager</strong> ä¸­éå†åˆ—è¡¨ä¸­çš„æ¯ ä¸€ä¸ª<strong>AuthenticationProvider</strong> å»æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œæœ€ç»ˆå¾—åˆ°è®¤è¯ç»“æœã€‚</li>
<li><strong>ProviderManager</strong> æœ¬èº«ä¹Ÿå¯ä»¥å†é…ç½®ä¸€ä¸ª <strong>AuthenticationManager</strong> ä½œä¸º parentï¼Œè¿™æ ·å½“<strong>ProviderManager</strong> è®¤è¯å¤±è´¥ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ°parent ä¸­å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ç†è®ºä¸Šæ¥è¯´:  <strong>ProviderManager</strong> çš„ parent å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„ <strong>AuthenticationManager</strong>ï¼Œä½†æ˜¯é€šå¸¸éƒ½æ˜¯ç”± <strong>ProviderManager</strong> æ¥æ‰®æ¼”parent çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯<strong>ProviderManager</strong> æ˜¯<strong>ProviderManager</strong> çš„parent ã€‚</li>
<li><strong>ProviderManager</strong> æœ¬èº«ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ª<strong>ProviderManager</strong> å…±ç”¨åŒ ä¸€ä¸ªparent ï¼Œå½“å­˜åœ¨å¤š ä¸ªè¿‡æ»¤å™¨é“¾çš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚å½“å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾æ—¶ï¼Œä¸åŒçš„è·¯å¾„å¯èƒ½å¯¹åº”ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œ ä½†æ˜¯ä¸åŒè·¯å¾„å¯èƒ½åˆä¼šåŒæ—¶å­˜åœ¨ ä¸€äº›å…±æœ‰çš„è®¤è¯æ–¹å¼,è¿™äº›å…±æœ‰çš„è®¤è¯æ–¹å¼å¯ä»¥åœ¨parent ä¸­ç»Ÿ ä¸€ å¤„ç†</li>
</ul>
<p>æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç»˜å‡ºæ–°çš„<strong>ProviderManager</strong> å’Œ<strong>AuthenticationProvider</strong> å…³ç³»å›¾: </p>
<p><img src="/2022/01/26/SpringSecurity/image-20230716152418188.png" srcset="/img/loading.gif" lazyload alt="image-20230716152418188"></p>
<p>æˆ‘ä»¬é‡ç‚¹çœ‹ ä¸€ä¸‹<strong>ProviderManager</strong> ä¸­çš„<strong>authenticate</strong> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>		Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Authentication</span>&gt; toTest = authentication.getClass();<br>		<span class="hljs-type">AuthenticationException</span> <span class="hljs-variable">lastException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">AuthenticationException</span> <span class="hljs-variable">parentException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">Authentication</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">Authentication</span> <span class="hljs-variable">parentResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">currentPosition</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.providers.size();<br>		<span class="hljs-keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;<br>			<span class="hljs-keyword">if</span> (!provider.supports(toTest)) &#123;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(LogMessage.format(<span class="hljs-string">&quot;Authenticating request with %s (%d/%d)&quot;</span>,<br>						provider.getClass().getSimpleName(), ++currentPosition, size));<br>			&#125;<br>			<span class="hljs-keyword">try</span> &#123;<br>				result = provider.authenticate(authentication);<br>				<span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>					copyDetails(authentication, result);<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (AccountStatusException | InternalAuthenticationServiceException ex) &#123;<br>				prepareException(ex, authentication);<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (AuthenticationException ex) &#123;<br>				lastException = ex;<br>			&#125;<br>		&#125;<br>  <br>		<span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.parent != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				parentResult = <span class="hljs-built_in">this</span>.parent.authenticate(authentication);<br>				result = parentResult;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (ProviderNotFoundException ex) &#123;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (AuthenticationException ex) &#123;<br>				parentException = ex;<br>				lastException = ex;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eraseCredentialsAfterAuthentication &amp;&amp; (result <span class="hljs-keyword">instanceof</span> CredentialsContainer)) &#123;<br>				((CredentialsContainer) result).eraseCredentials();<br>			&#125;<br>			<span class="hljs-keyword">if</span> (parentResult == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-built_in">this</span>.eventPublisher.publishAuthenticationSuccess(result);<br>			&#125;<br><br>			<span class="hljs-keyword">return</span> result;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (lastException == <span class="hljs-literal">null</span>) &#123;<br>			lastException = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderNotFoundException</span>(<span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;ProviderManager.providerNotFound&quot;</span>,<br>					<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; toTest.getName() &#125;, <span class="hljs-string">&quot;No AuthenticationProvider found for &#123;0&#125;&quot;</span>));<br>		&#125;<br>		<span class="hljs-keyword">if</span> (parentException == <span class="hljs-literal">null</span>) &#123;<br>			prepareException(lastException, authentication);<br>		&#125;<br>		<span class="hljs-keyword">throw</span> lastException;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ®µæºç çš„é€»è¾‘è¿˜æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹:</p>
<ol>
<li>é¦–å…ˆè·å–<strong>authentication</strong>å¯¹è±¡çš„ç±»å‹ ã€‚</li>
<li>åˆ†åˆ«å®šä¹‰å½“å‰è®¤è¯è¿‡ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ã€parent ä¸­è®¤è¯æ—¶æŠ›å‡ºçš„å¼‚å¸¸ã€å½“å‰è®¤è¯ç»“æœä»¥åŠparent ä¸­è®¤è¯ç»“æœå¯¹åº”çš„å˜é‡ã€‚</li>
<li><strong>getProviders</strong> æ–¹æ³•ç”¨æ¥è·å–å½“å‰<strong>ProviderManager</strong> æ‰€ä»£ç†çš„æ‰€æœ‰<strong>AuthenticationProvider</strong> å¯¹è±¡ï¼Œéå†è¿™äº›<strong>AuthenticationProvider</strong> å¯¹è±¡è¿›è¡Œèº«ä»½è®¤è¯ã€‚</li>
<li>åˆ¤æ–­å½“å‰<strong>AuthenticationProvider</strong> æ˜¯å¦æ”¯æŒå½“å‰<strong>Authentication</strong>å¯¹è±¡ï¼Œè¦æ˜¯ä¸æ”¯æŒï¼Œåˆ™ç»§ç»­å¤„ç†åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª<strong>AuthenticationProvider</strong> å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨ <strong>provider.authenticate</strong> æ–¹æ³•è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¦‚æœè®¤è¯æˆåŠŸï¼Œè¿”å›è®¤è¯åçš„ <strong>Authentication</strong> å¯¹è±¡ï¼ŒåŒæ—¶è°ƒç”¨<strong>copyDetails</strong> æ–¹æ³•ç»™ <strong>Authentication</strong> å¯¹è±¡çš„<strong>details</strong> å±æ€§èµ‹å€¼ã€‚ç”±äºå¯èƒ½æ˜¯å¤šä¸ª<strong>AuthenticationProvider</strong> æ‰§è¡Œè®¤è¯æ“ä½œï¼Œæ‰€ä»¥å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™é€šè¿‡<strong>lastException</strong> å˜é‡æ¥è®°å½•ã€‚</li>
<li>åœ¨forå¾ªç¯æ‰§è¡Œå®Œæˆåï¼Œå¦‚æœresult è¿˜æ˜¯æ²¡æœ‰å€¼ï¼Œè¯´æ˜æ‰€æœ‰çš„<strong>AuthenticationProvider</strong> éƒ½è®¤è¯å¤±è´¥ï¼Œæ­¤æ—¶å¦‚æœparent ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨parentçš„<strong>authenticate</strong>æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚</li>
<li>å¦‚æœparentExceptionä¸ºnullï¼Œå‘å¸ƒè®¤è¯å¤±è´¥äº‹ä»¶(å¦‚æœparentException ä¸ä¸ºnll, åˆ™è¯´æ˜è®¤è¯å¤±è´¥ äº‹ä»¶å·±ç»å‘å¸ƒè¿‡ äº†)ã€‚</li>
<li>æœ€åæŠ›å‡ºlastException å¼‚å¸¸ã€‚</li>
</ol>
<blockquote>
<p>AuthenticationProvider</p>
</blockquote>
<p>ä¹‹å‰ä»‹ç»äº†Spring Securityæ”¯æŒå¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”ä¸åŒçš„èº«ä»½ç±»å‹ï¼Œ<strong>AuthenticationProvider å°±æ˜¯é’ˆå¯¹ä¸åŒçš„èº«ä»½ç±»å‹æ‰§è¡Œå…·ä½“çš„èº«ä»½è®¤è¯ã€‚</strong>ä¾‹å¦‚ï¼Œå¸¸è§çš„ <strong>DaoAuthenticationProvider</strong> ç”¨æ¥æ”¯æŒç”¨æˆ·å&#x2F;å¯†ç ç™»å½•è®¤è¯ï¼Œ<strong>RememberMeAuthenticationProvider</strong> ç”¨æ¥æ”¯æŒ â€œ è®°ä½æˆ‘â€ çš„è®¤è¯.</p>
<p>å…¶æºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationProvider</span> &#123;<br><br>	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>(1) authenticate æ–¹æ³•ç”¨æ¥æ‰§è¡Œå…·ä½“çš„èº«ä»½è®¤è¯ã€‚</p>
<p>(2) supports æ–¹æ³•ç”¨æ¥åˆ¤æ–­å½“å‰AuthenticationProvider æ˜¯å¦æ”¯æŒå¯¹åº”çš„èº«ä»½ç±»å‹</p>
<blockquote>
<p>AuthenticationProviderä¸»è¦å®ç°ç±»</p>
</blockquote>
<img src="/2022/01/26/SpringSecurity/image-20230712144937006.png" srcset="/img/loading.gif" lazyload alt="image-20230712144937006" style="zoom:67%;">

<p>ç”±äºè®¤è¯é»˜è®¤æ˜¯ä½¿ç”¨çš„<strong>DaoAuthenticationProvider</strong>, æˆ‘å…ˆè®²å…¶çˆ¶ç±»<strong>AbstractUserDetailsAuthenticationProvider</strong></p>
<p><strong>DaoAuthenticationProvider</strong>æ²¡å®ç°è®¤è¯ä¸»æ–¹æ³•,è¿˜æ˜¯ç”¨çš„çˆ¶ç±»å®ç°çš„è®¤è¯æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>	Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication,<br>			() -&gt; <span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span>,<br>					<span class="hljs-string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span>));<br>	<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> determineUsername(authentication);<br>	<span class="hljs-type">boolean</span> <span class="hljs-variable">cacheWasUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>	<span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userCache.getUserFromCache(username);<br>	<span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>		cacheWasUsed = <span class="hljs-literal">false</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (UsernameNotFoundException ex) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Failed to find user &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.hideUserNotFoundExceptions) &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages<br>					.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="hljs-string">&quot;Bad credentials&quot;</span>));<br>		&#125;<br>		Assert.notNull(user, <span class="hljs-string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-built_in">this</span>.preAuthenticationChecks.check(user);<br>		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (AuthenticationException ex) &#123;<br>		<span class="hljs-keyword">if</span> (!cacheWasUsed) &#123;<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-comment">// There was a problem, so try again after checking</span><br>		<span class="hljs-comment">// we&#x27;re using latest data (i.e. not from the cache)</span><br>		cacheWasUsed = <span class="hljs-literal">false</span>;<br>		user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);<br>		<span class="hljs-built_in">this</span>.preAuthenticationChecks.check(user);<br>		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);<br>	&#125;<br>	<span class="hljs-built_in">this</span>.postAuthenticationChecks.check(user);<br>	<span class="hljs-keyword">if</span> (!cacheWasUsed) &#123;<br>		<span class="hljs-built_in">this</span>.userCache.putUserInCache(user);<br>	&#125;<br>	<span class="hljs-type">Object</span> <span class="hljs-variable">principalToReturn</span> <span class="hljs-operator">=</span> user;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.forcePrincipalAsString) &#123;<br>		principalToReturn = user.getUsername();<br>	&#125;<br>	<span class="hljs-keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¯¦ç»†è®²è§£ä¸‹è®¤è¯çš„é€»è¾‘:</p>
<ol>
<li><p>ä¸€å¼€å§‹å…ˆå£°æ˜ä¸€ä¸ªç”¨æˆ·ç¼“å­˜å¯¹è±¡<strong>userCache</strong>å¹¶çœ‹ä¸‹å‘½ä¸­ç¼“å­˜æ²¡ï¼Œé»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰å¯ç”¨ç¼“å­˜å¯¹è±¡ ã€‚</p>
</li>
<li><p><strong>hideUserNotFoundExceptions</strong>è¡¨ç¤ºæ˜¯å¦éšè—ç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥çš„å¼‚å¸¸ï¼Œé»˜è®¤ä¸ºtrueã€‚ä¸º äº†ç¡®ä¿ç³»ç»Ÿå®‰å…¨ï¼Œç”¨æˆ·åœ¨ç™»å½•å¤±è´¥æ—¶åªä¼šç»™å‡ºä¸€ä¸ªæ¨¡ç³Šæç¤ºï¼Œä¾‹å¦‚â€œç”¨æˆ·åæˆ–å¯†ç è¾“å…¥é”™è¯¯â€ã€‚ åœ¨Spring Security å†…éƒ¨ï¼Œå¦‚æœç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™ä¼šæŠ›å‡º<strong>UsernameNotFoundException</strong> å¼‚å¸¸ï¼Œ ä½†æ˜¯è¯¥å¼‚å¸¸ä¼šè¢«è‡ªåŠ¨éšè—ï¼Œè½¬è€Œé€šè¿‡ ä¸€ä¸ª<strong>BadCredentialsException</strong> å¼‚å¸¸æ¥ä»£æ›¿å®ƒ ï¼Œè¿™æ ·ï¼Œå¼€å‘è€…åœ¨å¤„ç†ç™»å½•å¤±è´¥å¼‚å¸¸æ—¶ ï¼Œæ— è®ºæ˜¯ç”¨æˆ·åè¾“å…¥é”™è¯¯è¿˜æ˜¯å¯†ç è¾“å…¥é”™è¯¯ ï¼Œ æ”¶åˆ°çš„æ€»æ˜¯<strong>BadCredentialsException</strong>ï¼Œ è¿™æ ·åšçš„ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥é¿å…æ–°æ‰‹ç¨‹åºå‘˜å°†ç”¨æˆ·åè¾“å…¥é”™è¯¯å’Œå¯†ç è¾“å…¥é”™è¯¯ä¸¤ä¸ªå¼‚å¸¸åˆ†å¼€æç¤ºã€‚</p>
</li>
<li><p><strong>forcePrincipalAsString</strong>è¡¨ç¤ºæ˜¯å¦å¼ºåˆ¶å°†<strong>Principal</strong> å¯¹è±¡å½“æˆå­—ç¬¦ä¸²æ¥å¤„ç†ï¼Œé»˜è®¤æ˜¯falseã€‚ <strong>Authentication</strong>ä¸­çš„<strong>principal</strong>å±æ€§ç±»å‹æ˜¯ä¸€ä¸ª<strong>Object</strong>ï¼Œæ­£å¸¸æ¥è¯´ï¼Œé€šè¿‡<strong>principal</strong>å±æ€§å¯ä»¥è·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·å¯¹è±¡(å³UserDetails)ï¼Œ<strong>ä½†æ˜¯å¦‚æœforcePrincipalAsString è®¾ç½®ä¸ºtrueï¼Œåˆ™ Authentication ä¸­çš„principal å±æ€§è¿”å›å°±æ˜¯å½“å‰ç™»å½•ç”¨æˆ·åï¼Œè€Œä¸æ˜¯ç”¨æˆ·å¯¹è±¡ã€‚</strong></p>
</li>
<li><p><strong>preAuthenticationChecks</strong> å¯¹è±¡åˆ™æ˜¯ç”¨äºåšç”¨æˆ·çŠ¶æ€æ£€æŸ¥ï¼Œåœ¨ç”¨æˆ·è®¤è¯è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ£€éªŒç”¨æˆ·çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Œä¾‹å¦‚è´¦æˆ·æ˜¯å¦è¢«é”å®šã€è´¦æˆ·æ˜¯å¦å¯ç”¨ã€è´¦æˆ·æ˜¯å¦è¿‡æœŸç­‰ã€‚</p>
</li>
<li><p><strong>postAuthenticationChecks</strong> å¯¹è±¡ä¸»è¦è´Ÿè´£åœ¨å¯†ç æ ¡éªŒæˆåŠŸå ï¼Œ æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ </p>
</li>
<li><p><strong>additionalAuthenticationChecks</strong>æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯<strong>æ ¡éªŒå¯†ç </strong>ï¼Œå…·ä½“çš„å®ç°åœ¨<strong>DaoAuthenticationProvider</strong>ä¸­</p>
<p>æ€»çš„æ¥è¯´: <strong>AbstractUserDetailsAuthenticationProvider</strong>çš„<strong>authenticate</strong> æ–¹æ³•å°±æ˜¯æ ¸å¿ƒçš„æ ¡éªŒæ–¹æ³•äº†ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä»ç™»å½•æ•°æ®ä¸­è·å–ç”¨æˆ·åï¼Œ ç„¶åæ ¹æ®ç”¨æˆ·åå»ç¼“å­˜ä¸­æŸ¥è¯¢ç”¨æˆ·å¯¹è±¡ï¼Œå¦‚æœæŸ¥è¯¢ä¸åˆ°ï¼Œåˆ™æ ¹æ®ç”¨æˆ·åè°ƒç”¨<strong>retrieveUser</strong> æ–¹æ³• ä»æ•°æ®åº“ä¸­åŠ è½½ç”¨æˆ·;å¦‚æœæ²¡æœ‰åŠ è½½åˆ°ç”¨æˆ·ï¼Œåˆ™æ‹‹å‡ºå¼‚å¸¸(ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸ä¼šè¢«éšè—)ã€‚æ‹¿åˆ°ç”¨æˆ·å¯¹è±¡ä¹‹åï¼Œé¦–å…ˆè°ƒç”¨ <strong>preAuthenticationChecks.check</strong> æ–¹æ³•è¿›è¡Œç”¨æˆ·çŠ¶æ€æ£€æŸ¥ï¼Œç„¶åè°ƒç”¨ <strong>additionalAuthenticationChecks</strong> æ–¹æ³•è¿›è¡Œå¯†ç çš„æ ¡éªŒæ“ä½œï¼Œæœ€åè°ƒç”¨ <strong>postAuthenticationChecks.check</strong> æ–¹æ³•æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ.</p>
<p>å½“æ‰€æœ‰æ­¥éª¤éƒ½é¡ºåˆ©å®Œæˆåï¼Œè°ƒç”¨<strong>createSuccessAuthentication</strong> æ–¹æ³•åˆ›å»ºä¸€ä¸ªè®¤è¯åçš„<strong>UsernamePasswordAuthenticationToken</strong> å¯¹è±¡å¹¶è¿”å›ï¼Œè®¤è¯åçš„å¯¹è±¡ä¸­åŒ…å«äº†è®¤è¯ä¸»ä½“ã€å‡­è¯ä»¥åŠè§’è‰²ç­‰ä¿¡æ¯ã€‚</p>
</li>
</ol>
<p>åœ¨å›åˆ°è®¤è¯ä¸»ç±»:<strong>DaoAuthenticationProvider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoAuthenticationProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractUserDetailsAuthenticationProvider</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_NOT_FOUND_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;userNotFoundPassword&quot;</span>;<br><br>	<span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> String userNotFoundEncodedPassword;<br><br>	<span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br><br>	<span class="hljs-keyword">private</span> UserDetailsPasswordService userDetailsPasswordService;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">DaoAuthenticationProvider</span><span class="hljs-params">()</span> &#123;<br>		setPasswordEncoder(PasswordEncoderFactories.createDelegatingPasswordEncoder());<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-meta">@SuppressWarnings(&quot;deprecation&quot;)</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">additionalAuthenticationChecks</span><span class="hljs-params">(UserDetails userDetails,</span><br><span class="hljs-params">			UsernamePasswordAuthenticationToken authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>		<span class="hljs-keyword">if</span> (authentication.getCredentials() == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Failed to authenticate since no credentials provided&quot;</span>);<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages<br>					.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="hljs-string">&quot;Bad credentials&quot;</span>));<br>		&#125;<br>		<span class="hljs-type">String</span> <span class="hljs-variable">presentedPassword</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.passwordEncoder.matches(presentedPassword, userDetails.getPassword())) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Failed to authenticate since password does not match stored value&quot;</span>);<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages<br>					.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="hljs-string">&quot;Bad credentials&quot;</span>));<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>		Assert.notNull(<span class="hljs-built_in">this</span>.userDetailsService, <span class="hljs-string">&quot;A UserDetailsService must be set&quot;</span>);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> UserDetails <span class="hljs-title function_">retrieveUser</span><span class="hljs-params">(String username, UsernamePasswordAuthenticationToken authentication)</span><br>			<span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>		prepareTimingAttackProtection();<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-type">UserDetails</span> <span class="hljs-variable">loadedUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);<br>			<span class="hljs-keyword">if</span> (loadedUser == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalAuthenticationServiceException</span>(<br>						<span class="hljs-string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span>);<br>			&#125;<br>			<span class="hljs-keyword">return</span> loadedUser;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (UsernameNotFoundException ex) &#123;<br>			mitigateAgainstTimingAttack(authentication);<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InternalAuthenticationServiceException ex) &#123;<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalAuthenticationServiceException</span>(ex.getMessage(), ex);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> Authentication <span class="hljs-title function_">createSuccessAuthentication</span><span class="hljs-params">(Object principal, Authentication authentication,</span><br><span class="hljs-params">			UserDetails user)</span> &#123;<br>		<span class="hljs-type">boolean</span> <span class="hljs-variable">upgradeEncoding</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userDetailsPasswordService != <span class="hljs-literal">null</span><br>				&amp;&amp; <span class="hljs-built_in">this</span>.passwordEncoder.upgradeEncoding(user.getPassword());<br>		<span class="hljs-keyword">if</span> (upgradeEncoding) &#123;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">presentedPassword</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();<br>			<span class="hljs-type">String</span> <span class="hljs-variable">newPassword</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.passwordEncoder.encode(presentedPassword);<br>			user = <span class="hljs-built_in">this</span>.userDetailsPasswordService.updatePassword(user, newPassword);<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.createSuccessAuthentication(principal, authentication, user);<br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareTimingAttackProtection</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.userNotFoundEncodedPassword == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.userNotFoundEncodedPassword = <span class="hljs-built_in">this</span>.passwordEncoder.encode(USER_NOT_FOUND_PASSWORD);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mitigateAgainstTimingAttack</span><span class="hljs-params">(UsernamePasswordAuthenticationToken authentication)</span> &#123;<br>		<span class="hljs-keyword">if</span> (authentication.getCredentials() != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">presentedPassword</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();<br>			<span class="hljs-built_in">this</span>.passwordEncoder.matches(presentedPassword, <span class="hljs-built_in">this</span>.userNotFoundEncodedPassword);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPasswordEncoder</span><span class="hljs-params">(PasswordEncoder passwordEncoder)</span> &#123;<br>		Assert.notNull(passwordEncoder, <span class="hljs-string">&quot;passwordEncoder cannot be null&quot;</span>);<br>		<span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;<br>		<span class="hljs-built_in">this</span>.userNotFoundEncodedPassword = <span class="hljs-literal">null</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">protected</span> PasswordEncoder <span class="hljs-title function_">getPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.passwordEncoder;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDetailsService</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> &#123;<br>		<span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;<br>	&#125;<br><br>	<span class="hljs-keyword">protected</span> UserDetailsService <span class="hljs-title function_">getUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.userDetailsService;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDetailsPasswordService</span><span class="hljs-params">(UserDetailsPasswordService userDetailsPasswordService)</span> &#123;<br>		<span class="hljs-built_in">this</span>.userDetailsPasswordService = userDetailsPasswordService;<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¯¦ç»†è®²è§£ä¸‹è¯¥å…·ä½“å®ç°:</p>
<ol>
<li>é¦–å…ˆå®šä¹‰äº†<strong>USER_NOT_FOUND_PASSWORD</strong> å¸¸é‡ï¼Œ<strong>è¿™ä¸ªæ˜¯å½“ç”¨æˆ·æŸ¥æ‰¾å¤±è´¥æ—¶çš„é»˜è®¤å¯†ç :passwordEncoder</strong>; userNotFoundEncodedPasword å˜é‡åˆ™ç”¨æ¥ä¿å­˜é»˜è®¤å¯†ç åŠ å¯†åçš„å€¼</li>
<li>åœ¨<strong>DaoAuthenticationProvider</strong>çš„æ„é€ æ–¹æ³•ä¸­ï¼Œé»˜è®¤å°±ä¼šæŒ‡å®šPasswordEncoder ï¼Œå½“ç„¶å¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡set æ–¹æ³•è‡ªå®šä¹‰PasswordEncoder</li>
<li><strong>additionalAuthenticationChecks</strong> æ–¹æ³•ä¸»è¦è¿›è¡Œå¯†ç æ ¡éªŒï¼Œè¯¥æ–¹æ³•ç¬¬ ä¸€ä¸ªå‚æ•°<strong>userDetails</strong>æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ç”¨æˆ·å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°<strong>authentication</strong> åˆ™æ˜¯ç™»å½•ç”¨æˆ·è¾“å…¥çš„å‚æ•°ã€‚ä» è¿™ä¸¤ä¸ªå‚æ•°ä¸­åˆ†åˆ«æå–å‡ºæ¥ç”¨æˆ·å¯†ç ï¼Œç„¶åè°ƒç”¨<strong>paswordEncoder.matches</strong> æ–¹æ³•è¿›è¡Œå¯†ç æ¯”å¯¹ã€‚</li>
<li><strong>retieveUser</strong> æ–¹æ³•åˆ™æ˜¯è·å–ç”¨æˆ·å¯¹è±¡çš„æ–¹æ³•ï¼Œå…·ä½“åšæ³•å°±æ˜¯è°ƒç”¨ <strong>UserDetailsService#loadUserBvUsername</strong> æ–¹æ³•å»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚</li>
<li><strong>createSuccessAuthentication</strong>æ–¹ æ³•åˆ™æ˜¯åœ¨ç™»å½•æˆåŠŸå ï¼Œ åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ <strong>UsernamePasswordAuthenticationToken</strong> å¯¹è±¡ï¼ŒåŒæ—¶ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œå¯†ç å‡çº§ï¼Œå¦‚æœéœ€è¦è¿›è¡Œå¯†ç å‡çº§ï¼Œ å°±ä¼šåœ¨è¯¥æ–¹æ³•ä¸­è¿›è¡ŒåŠ å¯†æ–¹æ¡ˆå‡çº§ã€‚</li>
</ol>
<p>ç°åœ¨å¤§å®¶å·±ç»ç†Ÿæ‚‰äº†<strong>Authentication</strong>ã€<strong>AuthenticationManager</strong> ã€<strong>AuthenticationProvider</strong> ä»¥åŠ<strong>ProviderManager</strong> çš„å·¥ä½œåŸç†äº†ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯è¿™äº›ç»„ä»¶å¦‚ä½•è·Ÿç™»å½•å…³è”èµ·æ¥?è¿™å°±æ¶‰ åŠä¸€ ä¸ªé‡è¦çš„è¿‡æ»¤å™¨ - AbstractProcessingFilter</p>
<h4 id="AbstractAuthenticationProcessingFilter"><a href="#AbstractAuthenticationProcessingFilter" class="headerlink" title="AbstractAuthenticationProcessingFilter"></a>AbstractAuthenticationProcessingFilter</h4><p>â€‹	ä½œä¸ºSpring Securityè¿‡æ»¤å™¨é“¾ä¸­çš„ä¸€ç¯,<strong>AbstractAuthenticationProcessingFilter</strong>å¯ä»¥ç”¨æ¥å¤„ç†ä»»ä½•æäº¤ç»™å®ƒçš„èº«ä»½è®¤è¯,ä¸‹å›¾æè¿°äº†å·¥ä½œæµç¨‹:</p>
<img src="/2022/01/26/SpringSecurity/image-20230214222306844.png" srcset="/img/loading.gif" lazyload alt="image-20230214222306844" style="zoom:50%;">



<p><strong>AbstractAuthenticationProcessingFilter</strong>ä½œä¸ºä¸€ä¸ªæŠ½è±¡ç±», å¦‚æœä½¿ç”¨ç”¨æˆ·å&#x2F;å¯†ç çš„æ–¹å¼ç™»å½•, é‚£ä¹ˆå®ƒå¯¹åº”çš„æ˜¯å®ç°ç±»æ˜¯<strong>UsernamePasswordAuthenticationFilter</strong>, æ„é€ å‡ºæ¥çš„<strong>Authentication</strong>å¯¹è±¡åˆ™æ˜¯<strong>UsernamePasswordAuthenticationToken</strong>. </p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹è®¤è¯æµç¨‹è¿›è¡Œè¿›ä¸€æ­¥çš„ç»†åŒ–:</p>
<img src="/2022/01/26/SpringSecurity/image-20230214222758742.png" srcset="/img/loading.gif" lazyload alt="image-20230214222758742" style="zoom:50%;">



<p>ç°åœ¨æˆ‘ä»¬å¤§è‡´æ¢³ç†ä¸€ä¸‹è®¤è¯çš„æµç¨‹:</p>
<ol>
<li>å½“è¯·æ±‚è¢«è½¬å‘åˆ°<strong>AbstractAuthenticationProcessingFilter</strong>, å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è®¤è¯å…·ä½“å®ç°ä¸º<strong>requiresAuthentication</strong> </li>
<li>å¦‚æœéœ€è¦è®¤è¯åˆ™è°ƒç”¨<strong>UsernamePasswordAuthenticationFilter</strong>#<strong>attemptAuthentication</strong>: ä»å½“å‰è¯·æ±‚<strong>HttpServletRequest</strong>ä¸­æå–å‡ºç™»å½•ç”¨æˆ·å&#x2F;å¯†ç ,ç„¶åå°è£…æˆä¸€ä¸ª<strong>UsernamePasswordAuthenticationToken</strong>å¯¹è±¡</li>
<li><strong>UsernamePasswordAuthenticationToken</strong>å¯¹è±¡å°†è¢«ä¼ å…¥<strong>ProviderManager</strong>ä¸­è¿›è¡Œå…·ä½“çš„è®¤è¯æ“ä½œ<ol>
<li>å¦‚æœè®¤è¯å¤±è´¥,åˆ™æŠ›å‡ºå¼‚å¸¸è¢«<strong>AbstractAuthenticationProcessingFilter</strong>#<strong>unsuccessfulAuthentication</strong>æ–¹æ³•catchåˆ°:<ul>
<li><strong>SecurityContextHolder</strong>ä¸­ç›¸å…³çš„ä¿¡æ¯å°†è¢«æ¸…é™¤,ç™»å½•å¤±è´¥å›è°ƒä¹Ÿä¼šè¢«è°ƒç”¨</li>
<li><strong>RememberMeServices</strong>#<strong>loginFail</strong></li>
<li>æ‰§è¡Œè®¤è¯å¤±è´¥å¤„ç†<strong>AuthenticationFailureHandler</strong>#<strong>onAuthenticationFailure</strong></li>
</ul>
</li>
<li>å¦‚æœè®¤è¯æˆåŠŸ,åˆ™ä¼šè¿›è¡Œ<ul>
<li>å­˜å‚¨<strong>SecurityContextHolder</strong>ä¸­ç›¸å…³çš„ä¿¡æ¯</li>
<li><strong>Session</strong>å¹¶å‘å¤„ç†</li>
<li>æ‰§è¡Œè®¤è¯æˆåŠŸå¤„ç†<strong>AuthenticationSuccessHandler</strong>#<strong>onAuthenticationSuccess</strong></li>
</ul>
</li>
</ol>
</li>
</ol>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯: <strong>ProviderManager</strong>åœ¨æ‹¿åˆ°<strong>Authentication</strong>çš„æ—¶å€™</p>
<ul>
<li>ä¼šéå†å…¶ä¸‹çš„<strong>AuthenticationProvider</strong><ul>
<li>å†çœ‹æ˜¯å¦æ”¯æŒ#<strong>supports</strong>è¯¥<strong>Authentication</strong>, å¦‚æœæ”¯æŒåˆ™ä¼šè¿›è¡Œè®¤è¯#<strong>authenticate</strong>æ“ä½œ;</li>
<li>å¦‚æœéƒ½ä¸æ”¯æŒåˆ™ä¼šé€’å½’çˆ¶ç±»<strong>ProviderManager</strong>,å†æ¬¡è¿›è¡Œä»¥ä¸Šæ“ä½œ</li>
</ul>
</li>
</ul>
<p>æŸ¥çœ‹æºç å‘ç°: ç¬¬ä¸€ä¸ªæŒæœ‰ä¸€ä¸ª<strong>AnonymousAuthenticationProvider</strong>çš„<strong>ProviderManager</strong>ä¸æ”¯æŒ, æœ€åé€’å½’åˆ°çˆ¶ç±»æŒæœ‰ä¸€ä¸ª<strong>DaoAuthenticationProvider</strong>çš„<strong>ProviderManager</strong>å¼€å§‹è®¤è¯</p>
<h4 id="UserDetailService"><a href="#UserDetailService" class="headerlink" title="UserDetailService"></a>UserDetailService</h4><p>é€šè¿‡åˆšæ‰æºç åˆ†æä¹Ÿèƒ½å¾—çŸ¥ UserDetailService æ˜¯é¡¶å±‚çˆ¶æ¥å£ï¼Œæ¥å£ä¸­ loadUserByUserName æ–¹æ³•æ˜¯ç”¨æ¥åœ¨è®¤è¯æ—¶è¿›è¡Œç”¨æˆ·åè®¤è¯æ–¹æ³•ï¼Œé»˜è®¤å®ç°ä½¿ç”¨æ˜¯å†…å­˜å®ç°ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ•°æ®åº“å®ç°æˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰ UserDetailService å®ç°ï¼Œæœ€ç»ˆè¿”å› UserDetails å®ä¾‹å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>	UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220111110043474.png" srcset="/img/loading.gif" lazyload alt="image-20220111110043474"></p>
<h4 id="UserDetailsServiceAutoConfigutation"><a href="#UserDetailsServiceAutoConfigutation" class="headerlink" title="UserDetailsServiceAutoConfigutation"></a>UserDetailsServiceAutoConfigutation</h4><p>è¿™ä¸ªæºç éå¸¸å¤šï¼Œè¿™é‡Œæ¢³ç†äº†å…³é”®éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnClass(AuthenticationManager.class)</span><br><span class="hljs-meta">@ConditionalOnBean(ObjectPostProcessor.class)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(</span><br><span class="hljs-meta">		value = &#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,</span><br><span class="hljs-meta">				AuthenticationManagerResolver.class &#125;,</span><br><span class="hljs-meta">		type = &#123; &quot;org.springframework.security.oauth2.jwt.JwtDecoder&quot;,</span><br><span class="hljs-meta">				&quot;org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector&quot;,</span><br><span class="hljs-meta">				&quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot; &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailsServiceAutoConfiguration</span> &#123;<br>  <span class="hljs-comment">//....</span><br>  <span class="hljs-meta">@Bean</span><br>	<span class="hljs-meta">@Lazy</span><br>	<span class="hljs-keyword">public</span> InMemoryUserDetailsManager <span class="hljs-title function_">inMemoryUserDetailsManager</span><span class="hljs-params">(SecurityProperties properties,</span><br><span class="hljs-params">			ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder)</span> &#123;<br>		SecurityProperties.<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> properties.getUser();<br>		List&lt;String&gt; roles = user.getRoles();<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(<br>				User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))<br>						.roles(StringUtils.toStringArray(roles)).build());<br>	&#125;<br>  <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ç»“è®º</strong></p>
<ol>
<li>ä»è‡ªåŠ¨é…ç½®æºç ä¸­å¾—çŸ¥å½“ classpath ä¸‹å­˜åœ¨ AuthenticationManager ç±»</li>
<li>å½“å‰é¡¹ç›®ä¸­ï¼Œç³»ç»Ÿæ²¡æœ‰æä¾› AuthenticationManager.classã€ AuthenticationProvider.classã€UserDetailsService.classã€<br>            AuthenticationManagerResolver.classã€å®ä¾‹</li>
</ol>
<p><strong>é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæ»¡è¶³ï¼Œæ­¤æ—¶Spring Securityä¼šæä¾›ä¸€ä¸ª InMemoryUserDetailManager å®ä¾‹</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111111244739.png" srcset="/img/loading.gif" lazyload alt="image-20220111111244739"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;spring.security&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityProperties</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>	<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.user;<br>  &#125;<br>  <span class="hljs-comment">//....</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>		<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user&quot;</span>;<br>		<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>		<span class="hljs-keyword">private</span> List&lt;String&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">passwordGenerated</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>		<span class="hljs-comment">//get set ...</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>è¿™å°±æ˜¯é»˜è®¤ç”Ÿæˆ user ä»¥åŠ uuid å¯†ç è¿‡ç¨‹! å¦å¤–çœ‹æ˜ç™½æºç ä¹‹åï¼Œå°±çŸ¥é“åªè¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®å¯ä»¥å¯¹å†…å­˜ä¸­ç”¨æˆ·å’Œå¯†ç è¿›è¡Œè¦†ç›–ã€‚</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.security.user.name</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.security.user.password</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.security.user.roles</span>=<span class="hljs-string">admin,users</span><br></code></pre></td></tr></table></figure>



<p>æ€»çš„æ¥è¯´:</p>
<ul>
<li>AuthenticationManagerã€ProviderMangerã€ä»¥åŠ AuthenticationProvider å…³ç³»</li>
</ul>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150612023.png" srcset="/img/loading.gif" lazyload alt="image-20220112150612023"></p>
<ul>
<li><p><strong>WebSecurityConfigurerAdapter</strong> æ‰©å±• Spring Security æ‰€æœ‰é»˜è®¤é…ç½®</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150820284.png" srcset="/img/loading.gif" lazyload alt="image-20220112150820284"></p>
</li>
<li><p><strong>UserDetailService</strong> ç”¨æ¥ä¿®æ”¹é»˜è®¤è®¤è¯çš„æ•°æ®æºä¿¡æ¯</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150929998.png" srcset="/img/loading.gif" lazyload alt="image-20220112150929998"></p>
</li>
</ul>
<h1 id="ç¬¬ä¸‰ç« -è‡ªå®šä¹‰è®¤è¯"><a href="#ç¬¬ä¸‰ç« -è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="ç¬¬ä¸‰ç«  è‡ªå®šä¹‰è®¤è¯"></a>ç¬¬ä¸‰ç«  è‡ªå®šä¹‰è®¤è¯</h1><ul>
<li>è®¤è¯é…ç½®</li>
<li>è¡¨å•è®¤è¯</li>
<li>æ³¨é”€ç™»å½•</li>
<li>å‰åç«¯åˆ†ç¦»è®¤è¯</li>
<li>æ·»åŠ éªŒè¯ç </li>
</ul>
<h2 id="3-1-è‡ªå®šä¹‰è®¤è¯"><a href="#3-1-è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="3.1 è‡ªå®šä¹‰è®¤è¯"></a>3.1 è‡ªå®šä¹‰è®¤è¯</h2><h3 id="3-1-1-è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™"><a href="#3-1-1-è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™" class="headerlink" title="3.1.1 è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™"></a>3.1.1 è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™</h3><ul>
<li>&#x2F;index  å…¬å…±èµ„æº</li>
<li>&#x2F;hello â€¦. å—ä¿æŠ¤èµ„æº æƒé™ç®¡ç†</li>
</ul>
<p>åœ¨é¡¹ç›®ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å°±å¯ä»¥å®ç°å¯¹èµ„æºæƒé™è§„åˆ™è®¾å®š:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/index&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and().formLogin();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113050533209-2023951.png" srcset="/img/loading.gif" lazyload alt="image-20220113050533209"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># è¯´æ˜</span><br><span class="hljs-bullet">-</span> permitAll() ä»£è¡¨æ”¾è¡Œè¯¥èµ„æº,è¯¥èµ„æºä¸ºå…¬å…±èµ„æº æ— éœ€è®¤è¯å’Œæˆæƒå¯ä»¥ç›´æ¥è®¿é—®<br><span class="hljs-bullet">-</span> anyRequest().authenticated() ä»£è¡¨æ‰€æœ‰è¯·æ±‚,å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®<br><span class="hljs-bullet">-</span> formLogin() ä»£è¡¨å¼€å¯è¡¨å•è®¤è¯<br><span class="hljs-section">## æ³¨æ„: æ”¾è¡Œèµ„æºf0få¿…é¡»æ”¾åœ¨æ‰€æœ‰è®¤è¯è¯·æ±‚ä¹‹å‰!</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-2-è‡ªå®šä¹‰ç™»å½•ç•Œé¢"><a href="#3-1-2-è‡ªå®šä¹‰ç™»å½•ç•Œé¢" class="headerlink" title="3.1.2 è‡ªå®šä¹‰ç™»å½•ç•Œé¢"></a>3.1.2 è‡ªå®šä¹‰ç™»å½•ç•Œé¢</h3><ul>
<li><p>å¼•å…¥æ¨¡æ¿ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰ç™»å½•é¡µé¢ controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/login.html&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åœ¨ templates ä¸­å®šä¹‰ç™»å½•ç•Œé¢</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ç”¨æˆ·ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span><br>    ç”¨æˆ·å:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;uname&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    å¯†ç :<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;passwd&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ç™»å½•&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong></p>
<ul>
<li>ç™»å½•è¡¨å• method å¿…é¡»ä¸º <code>post</code>ï¼Œaction çš„è¯·æ±‚è·¯å¾„ä¸º <code>/doLogin</code></li>
<li>ç”¨æˆ·åçš„ name å±æ€§ä¸º <code>uname</code></li>
<li>å¯†ç çš„ name å±æ€§ä¸º <code>passwd</code></li>
</ul>
</li>
<li><p>é…ç½® Spring Security é…ç½®ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>         http.authorizeHttpRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>).permitAll()<br>                .mvcMatchers(<span class="hljs-string">&quot;/index&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .loginProcessingUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>)<br>                .usernameParameter(<span class="hljs-string">&quot;uname&quot;</span>)<br>                .passwordParameter(<span class="hljs-string">&quot;passwd&quot;</span>)<br>                .successForwardUrl(<span class="hljs-string">&quot;/index&quot;</span>) 		 <span class="hljs-comment">//forward è·³è½¬           æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</span><br>                <span class="hljs-comment">//.defaultSuccessUrl(&quot;/index&quot;)   //redirect é‡å®šå‘    æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„</span><br>                .failureUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>successForwardUrl ã€defaultSuccessUrl è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å®ç°æˆåŠŸä¹‹åè·³è½¬<ul>
<li>successForwardUrl  é»˜è®¤ä½¿ç”¨ <code>forward </code>è·³è½¬      <code>æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</code></li>
<li>defaultSuccessUrl   é»˜è®¤ä½¿ç”¨ <code>redirect</code> è·³è½¬      <code>æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„,å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3-1-3-è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†"><a href="#3-1-3-è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†" class="headerlink" title="3.1.3 è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†"></a>3.1.3 è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†</h3><p>æœ‰æ—¶å€™é¡µé¢è·³è½¬å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬ï¼Œç‰¹åˆ«æ˜¯åœ¨å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­å°±ä¸éœ€è¦æˆåŠŸä¹‹åè·³è½¬é¡µé¢ã€‚åªéœ€è¦ç»™å‰ç«¯è¿”å›ä¸€ä¸ª JSON é€šçŸ¥ç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ä¸å¦ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>AuthenticationSucccessHandler</code> å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationSuccessHandler</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Called when a user has been successfully authenticated.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> request the request which caused the successful authentication</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> response the response</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> authentication the &lt;tt&gt;Authentication&lt;/tt&gt; object which was created during</span><br><span class="hljs-comment">	 * the authentication process.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">			Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•æˆåŠŸä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°successForwardUrlã€defaultSuccessUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113054514897-2023963.png" srcset="/img/loading.gif" lazyload alt="image-20220113054514897"></p>
<ul>
<li>è‡ªå®šä¹‰ AuthenticationSuccessHandler å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAuthenticationSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationSuccessHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);<br>        result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">200</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>        response.getWriter().println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é…ç½® AuthenticationSuccessHandler</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .formLogin()<br>                <span class="hljs-comment">//....</span><br>                .successHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationSuccessHandler</span>())<br>                .failureUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113062644363-2026405.png" srcset="/img/loading.gif" lazyload alt="image-20220113062644363"></p>
<h3 id="3-1-4-æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯"><a href="#3-1-4-æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯" class="headerlink" title="3.1.4 æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯"></a>3.1.4 æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯</h3><p>ä¸ºäº†èƒ½æ›´ç›´è§‚åœ¨ç™»å½•é¡µé¢çœ‹åˆ°å¼‚å¸¸é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ç™»å½•é¡µé¢ä¸­ç›´æ¥è·å–å¼‚å¸¸ä¿¡æ¯ã€‚Spring Security åœ¨ç™»å½•å¤±è´¥ä¹‹åä¼šå°†å¼‚å¸¸ä¿¡æ¯å­˜å‚¨åˆ° <code>request</code> ã€<code>session</code>ä½œç”¨åŸŸä¸­ key ä¸º <code>SPRING_SECURITY_LAST_EXCEPTION</code> å‘½åå±æ€§ä¸­ï¼Œæºç å¯ä»¥å‚è€ƒ SimpleUrlAuthenticationFailureHandler ï¼š</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113060257662.png" srcset="/img/loading.gif" lazyload alt="image-20220113060257662"></p>
<ul>
<li><p>æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  ....<br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;SPRING_SECURITY_LAST_EXCEPTION&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>              	<span class="hljs-comment">//..</span><br>                .and()<br>                .formLogin()<br>                <span class="hljs-comment">//....</span><br>                <span class="hljs-comment">//.failureUrl(&quot;/login.html&quot;)</span><br>                .failureForwardUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>failureUrlã€failureForwardUrl å…³ç³»ç±»ä¼¼äºä¹‹å‰æåˆ°çš„ successForwardUrl ã€defaultSuccessUrl æ–¹æ³•<ul>
<li>failureUrl å¤±è´¥ä»¥åçš„é‡å®šå‘è·³è½¬</li>
<li>failureForwardUrl å¤±è´¥ä»¥åçš„ forward è·³è½¬ <code>æ³¨æ„:å› æ­¤è·å– request ä¸­å¼‚å¸¸ä¿¡æ¯,è¿™é‡Œåªèƒ½ä½¿ç”¨failureForwardUrl</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3-1-5-è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†"><a href="#3-1-5-è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†" class="headerlink" title="3.1.5 è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†"></a>3.1.5 è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†</h3><p>å’Œè‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†ä¸€æ ·ï¼ŒSpring Security åŒæ ·ä¸ºå‰åç«¯åˆ†ç¦»å¼€å‘æä¾›äº†ç™»å½•å¤±è´¥çš„å¤„ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯  AuthenticationFailureHandlerï¼Œæºç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationFailureHandler</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Called when an authentication attempt fails.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> request the request during which the authentication attempt occurred.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> response the response.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> exception the exception which was thrown to reject the authentication</span><br><span class="hljs-comment">	 * request.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">			AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•å¤±è´¥ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°failureUrlã€failureForwardUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„ã€‚</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113062114741.png" srcset="/img/loading.gif" lazyload alt="image-20220113062114741"></p>
<ul>
<li>è‡ªå®šä¹‰ AuthenticationFailureHandler å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAuthenticationFailureHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationFailureHandler</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•å¤±è´¥: &quot;</span>+exception.getMessage());<br>        result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">500</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>        response.getWriter().println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é…ç½® AuthenticationFailureHandler</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>	              <span class="hljs-comment">//...</span><br>                .and()<br>                .formLogin()<br>               	<span class="hljs-comment">//..</span><br>                .failureHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationFailureHandler</span>())<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113062617937-2026380.png" srcset="/img/loading.gif" lazyload alt="image-20220113062617937"></p>
<h3 id="3-1-6-è‡ªå®šä¹‰æœªæˆæƒå¤„ç†å™¨"><a href="#3-1-6-è‡ªå®šä¹‰æœªæˆæƒå¤„ç†å™¨" class="headerlink" title="3.1.6 è‡ªå®šä¹‰æœªæˆæƒå¤„ç†å™¨"></a>3.1.6 è‡ªå®šä¹‰æœªæˆæƒå¤„ç†å™¨</h3><blockquote>
<p>securityé…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">securityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestAccessDeniedHandler restAccessDeniedHandler;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.csrf().disable();<br>        http.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/hello&quot;</span>).hasRole(<span class="hljs-string">&quot;product&quot;</span>)<br>                .anyRequest().authenticated()<br>                .and().formLogin();<br><br>        http.exceptionHandling()<br>                .accessDeniedHandler(restAccessDeniedHandler);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username -&gt; &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.selectUserByName(username);<br>            <span class="hljs-keyword">if</span> (Objects.isNull(user)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            List&lt;Role&gt; roles = userService.selectRoleByUsername(username);<br>            user.setRoles(roles);<br>            <span class="hljs-keyword">return</span> user;<br>        &#125;;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>å®ç°AccessDeniedHandler</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestAccessDeniedHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;application/json&quot;</span>);<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getWriter();<br>        out.write(<span class="hljs-string">&quot;æ‚¨æœªæˆæƒï¼Œè¯·è”ç³»ç®¡ç†å‘˜&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-1-7-æ³¨é”€ç™»å½•"><a href="#3-1-7-æ³¨é”€ç™»å½•" class="headerlink" title="3.1.7 æ³¨é”€ç™»å½•"></a>3.1.7 æ³¨é”€ç™»å½•</h3><p>Spring Security ä¸­ä¹Ÿæä¾›äº†é»˜è®¤çš„æ³¨é”€ç™»å½•é…ç½®ï¼Œåœ¨å¼€å‘æ—¶ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±éœ€æ±‚å¯¹æ³¨é”€è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚</p>
<ul>
<li><p>å¼€å¯æ³¨é”€ç™»å½•<code>é»˜è®¤å¼€å¯</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .formLogin()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .logout()<br>                .logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>)<br>                .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>                .clearAuthentication(<span class="hljs-literal">true</span>)<br>                .logoutSuccessUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ logout() æ–¹æ³•å¼€å¯æ³¨é”€é…ç½®</li>
<li>logoutUrl æŒ‡å®šé€€å‡ºç™»å½•è¯·æ±‚åœ°å€ï¼Œé»˜è®¤æ˜¯ GET è¯·æ±‚ï¼Œè·¯å¾„ä¸º <code>/logout</code></li>
<li>invalidateHttpSession é€€å‡ºæ—¶æ˜¯å¦æ˜¯ session å¤±æ•ˆï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>clearAuthentication é€€å‡ºæ—¶æ˜¯å¦æ¸…é™¤è®¤è¯ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>logoutSuccessUrl é€€å‡ºç™»å½•æ—¶è·³è½¬åœ°å€</li>
</ul>
</li>
<li><p>é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•è¯·æ±‚</p>
<p>å¦‚æœé¡¹ç›®ä¸­æœ‰éœ€è¦ï¼Œå¼€å‘è€…è¿˜å¯ä»¥é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•çš„è¯·æ±‚ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‡å®šè¯·æ±‚çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>		<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .formLogin()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .logout()<br>                .logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout1&quot;</span>,<span class="hljs-string">&quot;GET&quot;</span>),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout&quot;</span>,<span class="hljs-string">&quot;GET&quot;</span>)<br>                ))<br>                .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>                .clearAuthentication(<span class="hljs-literal">true</span>)<br>                .logoutSuccessUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>å‰åç«¯åˆ†ç¦»æ³¨é”€ç™»å½•é…ç½®</p>
<p>å¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œæ³¨é”€æˆåŠŸä¹‹åå°±ä¸éœ€è¦é¡µé¢è·³è½¬äº†ï¼Œåªéœ€è¦å°†æ³¨é”€æˆåŠŸçš„ä¿¡æ¯è¿”å›å‰ç«¯å³å¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ LogoutSuccessHandler  å®ç°æ¥è¿”å›æ³¨é”€ä¹‹åä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLogoutSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LogoutSuccessHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);<br>        result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">200</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>        response.getWriter().println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>          			<span class="hljs-comment">//....</span><br>                .and()<br>                .formLogin()<br> 								<span class="hljs-comment">//...</span><br>                .and()<br>                .logout()<br>                <span class="hljs-comment">//.logoutUrl(&quot;/logout&quot;)</span><br>                .logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout1&quot;</span>,<span class="hljs-string">&quot;GET&quot;</span>),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout&quot;</span>,<span class="hljs-string">&quot;GET&quot;</span>)<br>                ))<br>                .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>                .clearAuthentication(<span class="hljs-literal">true</span>)<br>                <span class="hljs-comment">//.logoutSuccessUrl(&quot;/login.html&quot;)</span><br>                .logoutSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyLogoutSuccessHandler</span>())<br>                .and()<br>                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113114133687.png" srcset="/img/loading.gif" lazyload alt="image-20220113114133687"></p>
</li>
</ul>
<h3 id="3-1-8-ç™»å½•ç”¨æˆ·æ•°æ®è·å–"><a href="#3-1-8-ç™»å½•ç”¨æˆ·æ•°æ®è·å–" class="headerlink" title="3.1.8 ç™»å½•ç”¨æˆ·æ•°æ®è·å–"></a>3.1.8 ç™»å½•ç”¨æˆ·æ•°æ®è·å–</h3><h4 id="SecurityContextHolder-1"><a href="#SecurityContextHolder-1" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>â€‹	Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚</p>
<p>â€‹	SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ°SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°†SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚</p>
<p>â€‹	å®é™…ä¸Š SecurityContextHolder ä¸­å­˜å‚¨æ˜¯ SecurityContextï¼Œåœ¨ SecurityContext ä¸­å­˜å‚¨æ˜¯ Authenticationã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113115956334.png" srcset="/img/loading.gif" lazyload alt="image-20220113115956334"></p>
<p>è¿™ç§è®¾è®¡æ˜¯å…¸å‹çš„ç­–ç•¥è®¾è®¡æ¨¡å¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolder</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_THREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_THREADLOCAL&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_INHERITABLETHREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_GLOBAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_GLOBAL&quot;</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_PRE_INITIALIZED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_PRE_INITIALIZED&quot;</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SecurityContextHolderStrategy strategy;<br>  <span class="hljs-comment">//....</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeStrategy</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) &#123;<br>			Assert.state(strategy != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;When using &quot;</span> + MODE_PRE_INITIALIZED<br>					+ <span class="hljs-string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (!StringUtils.hasText(strategyName)) &#123;<br>			<span class="hljs-comment">// Set default</span><br>			strategyName = MODE_THREADLOCAL;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalSecurityContextHolderStrategy</span>();<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_GLOBAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalSecurityContextHolderStrategy</span>();<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>    <span class="hljs-comment">//.....</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><code>MODE THREADLOCAL</code>ï¼šè¿™ç§å­˜æ”¾ç­–ç•¥æ˜¯å°† SecurityContext å­˜æ”¾åœ¨ ThreadLocalä¸­ï¼Œå¤§å®¶çŸ¥é“ Threadlocal çš„ç‰¹ç‚¹æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å°±è¦åœ¨å“ªä¸ªçº¿ç¨‹ä¸­è¯»å–ï¼Œè¿™å…¶å®éå¸¸é€‚åˆ web åº”ç”¨ï¼Œå› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚æ— è®ºç»è¿‡å¤šå°‘ Filter åˆ°è¾¾ Servletï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†çš„ã€‚è¿™ä¹Ÿæ˜¯ SecurityContextHolder çš„é»˜è®¤å­˜å‚¨ç­–ç•¥ï¼Œè¿™ç§å­˜å‚¨ç­–ç•¥æ„å‘³ç€å¦‚æœåœ¨å…·ä½“çš„ä¸šåŠ¡å¤„ç†ä»£ç ä¸­ï¼Œå¼€å¯äº†å­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­å»è·å–ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œå°±ä¼šè·å–ä¸åˆ°ã€‚</li>
<li><code>MODE INHERITABLETHREADLOCAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¦‚æœå¸Œæœ›åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½å¤Ÿè·å–åˆ°ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ç§å­˜å‚¨æ¨¡å¼ã€‚</li>
<li><code>MODE GLOBAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼å®é™…ä¸Šæ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªé™æ€å˜é‡ä¸­ï¼Œåœ¨ JavaWebå¼€å‘ä¸­ï¼Œè¿™ç§æ¨¡å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li>
</ol>
<h4 id="SecurityContextHolderStrategy"><a href="#SecurityContextHolderStrategy" class="headerlink" title="SecurityContextHolderStrategy"></a>SecurityContextHolderStrategy</h4><p>é€šè¿‡ SecurityContextHolder å¯ä»¥å¾—çŸ¥ï¼ŒSecurityContextHolderStrategy æ¥å£ç”¨æ¥å®šä¹‰å­˜å‚¨ç­–ç•¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityContextHolderStrategy</span> &#123;<br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span>;<br>	SecurityContext <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span>;<br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(SecurityContext context)</span>;<br>	SecurityContext <span class="hljs-title function_">createEmptyContext</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥å£ä¸­ä¸€å…±å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>clearContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥æ¸…é™¤å­˜å‚¨çš„ SecurityContextå¯¹è±¡ã€‚</li>
<li><code>getContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è·å–å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>setContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>create Empty Context</code>ï¼šè¯¥æ–¹æ³•åˆ™ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ SecurityContext å¯¹è±¡ã€‚</li>
</ul>
<p><img src="/2022/01/26/SpringSecurity/image-20220113125407538-2049649.png" srcset="/img/loading.gif" lazyload alt="image-20220113125407538"></p>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªå®ç°ç±»å¯¹åº”ä¸€ç§ç­–ç•¥çš„å®ç°ã€‚</p>
<h4 id="ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®"><a href="#ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®" class="headerlink" title="ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®"></a>ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder<br>        .getContext().getAuthentication();<br>      <span class="hljs-type">User</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> (User) authentication.getPrincipal();<br>      System.out.println(<span class="hljs-string">&quot;èº«ä»½ :&quot;</span>+principal.getUsername());<br>      System.out.println(<span class="hljs-string">&quot;å‡­è¯ :&quot;</span>+authentication.getCredentials());<br>      System.out.println(<span class="hljs-string">&quot;æƒé™ :&quot;</span>+authentication.getAuthorities());<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello security&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®"><a href="#å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®" class="headerlink" title="å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®"></a>å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder<br>          .getContext().getAuthentication();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> (User) authentication.getPrincipal();<br>        System.out.println(<span class="hljs-string">&quot;èº«ä»½ :&quot;</span>+principal.getUsername());<br>        System.out.println(<span class="hljs-string">&quot;å‡­è¯ :&quot;</span>+authentication.getCredentials());<br>        System.out.println(<span class="hljs-string">&quot;æƒé™ :&quot;</span>+authentication.getAuthorities());<br>      &#125;).start();<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello security&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113124141492.png" srcset="/img/loading.gif" lazyload alt="image-20220113124141492"></p>
<p><strong>å¯ä»¥çœ‹åˆ°é»˜è®¤ç­–ç•¥ï¼Œæ˜¯æ— æ³•åœ¨å­çº¿ç¨‹ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦åœ¨å­çº¿ç¨‹ä¸­è·å–å¿…é¡»ä½¿ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥æ˜¯é€šè¿‡ System.getProperty åŠ è½½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  VM Options å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">-Dspring.security.strategy</span>=<span class="hljs-string">MODE_INHERITABLETHREADLOCAL</span><br></code></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113124639102.png" srcset="/img/loading.gif" lazyload alt="image-20220113124639102"></p>
<h4 id="SecurityContextPersistenceFilterè¯¦è§£"><a href="#SecurityContextPersistenceFilterè¯¦è§£" class="headerlink" title="SecurityContextPersistenceFilterè¯¦è§£"></a>SecurityContextPersistenceFilterè¯¦è§£</h4><p>è¿‡æ»¤å™¨çš„æ ¸å¿ƒæ–¹æ³•å½“ç„¶æ˜¯doFilter,æˆ‘ä»¬å°±ä»doFilteræ–¹æ³•å¼€å§‹ä»‹ç»</p>
<ol>
<li>é¦–å…ˆä»requestä¸­è·å–FILTER_APPLIEDå±æ€§,å¦‚æœè¯¥å±æ€§å€¼ä¸ä¸ºnull,åˆ™ç›´æ¥æ‰§è¡Œchain.doFilteræ–¹æ³•,å½“å‰è¿‡æ»¤å™¨åˆ°æ­¤ä¸ºæ­¢,è¿™ä¸ªåˆ¤æ–­ä¸»è¦æ˜¯ç¡®ä¿è¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡è¯¥è¿‡æ»¤å™¨.å¦‚æœç¡®å®æ˜¯è¯¥requestç¬¬ä¸€æ¬¡ç»è¿‡è¯¥è¿‡æ»¤å™¨,åˆ™ç»™å…¶è®¾ç½®ä¸ŠFILTER_APPLIEDå±æ€§</li>
<li>forceEagerSessionCreationå˜é‡è¡¨ç¤ºæ˜¯å¦è¦åœ¨è¿‡æ»¤å™¨é“¾æ‰§è¡Œä¹‹å‰ç¡®ä¿ä¼šè¯æœ‰æ•ˆ,ç”±äºè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—è´¹èµ„æºçš„æ“ä½œ,å› æ­¤é»˜è®¤ä¸ºfalse</li>
<li>æ„å»ºHttpRequestResponseHolderå¯¹è±¡,å°†HttpServletRequestå’ŒHttpServletResponseéƒ½å­˜å‚¨è¿›å»</li>
<li>è°ƒç”¨repo.loadContextæ–¹æ³•å»åŠ è½½SecurityContext</li>
<li>å°†è¯»å–åˆ°çš„SecurityContextå­˜å…¥SecurityContextHolderä¹‹ä¸­,è¿™æ ·,åœ¨æ¥ä¸‹æ¥çš„å¤„ç†é€»è¾‘ä¸­,å¼€å‘è€…å°±å¯ä»¥ç›´æ¥é€šè¿‡SecurityContextHolderæ¥è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·äº†</li>
<li>å½“è¯·æ±‚å¤„ç†å®Œæ¯•å,åœ¨finallyæ¨¡å—ä¸­,è·å–æœ€æ–°çš„SecurityContextå¯¹è±¡</li>
<li>æœ€å,ä»requestæœ€åç§»é™¤FILTER_APPLIEDå±æ€§</li>
</ol>
<p>æ€»è€Œè¨€ä¹‹,è¯·æ±‚åœ¨åˆ°è¾¾SecurityContextPersistenceFilterè¿‡æ»¤å™¨ä¹‹å,å…ˆä»HttpSessionä¸­è¯»å–SecurityContextå‡ºæ¥,å¹¶å­˜å…¥SecurityContextHolder,å¹¶å­˜å…¥SecurityContextHolderä¹‹ä¸­ä»¥å¤‡åç»­ä½¿ç”¨;å½“è¯·æ±‚ç¦»å¼€SecuirtyContextPersistenceFilterè¿‡æ»¤å™¨çš„æ—¶å€™,è·å–æœ€æ–°çš„SecurityContextå¹¶å­˜å…¥HttpSessionä¸­,åŒæ—¶æ¸…ç©ºSecurityContextHolderä¸­çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯</p>
<h4 id="ä»å½“å‰è¯·æ±‚å¯¹è±¡è·å–ç”¨æˆ·ä¿¡æ¯"><a href="#ä»å½“å‰è¯·æ±‚å¯¹è±¡è·å–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="ä»å½“å‰è¯·æ±‚å¯¹è±¡è·å–ç”¨æˆ·ä¿¡æ¯"></a>ä»å½“å‰è¯·æ±‚å¯¹è±¡è·å–ç”¨æˆ·ä¿¡æ¯</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€æ´—ç¬¬äºŒç§ç™»å½•æ•°æ®è·å–æ–¹æ³•: ä»å½“å‰è¯·æ±‚ä¸­è·å–. è·å–ä»£ç å¦‚ä¸‹:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230212213216653.png" srcset="/img/loading.gif" lazyload alt="image-20230212213216653"></p>
<p>â€‹	å¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨Controllerçš„è¯·æ±‚å‚æ•°ä¸­æ”¾å…¥Authenticationå¯¹è±¡æ¥è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯.é€šè¿‡å‰é¢çš„è®²è§£,å¤§å®¶å·²ç»çŸ¥é“Authenticationæ˜¯Principalçš„å­ç±», æ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨è¯·æ±‚å‚æ•°ä¸­æ”¾å…¥Principalæ¥æ¥æ”¶å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯.<strong>éœ€è¦æ³¨æ„çš„æ˜¯,å³ä½¿å‚æ•°æ˜¯Principal,çœŸæ­£çš„å®ä¾‹ä¾ç„¶æ˜¯Authenticationçš„å®ä¾‹.</strong></p>
<p>â€‹	ç”¨è¿‡Spring MVCçš„éƒ½çŸ¥é“,Controllerä¸­çš„æ–¹æ³•çš„å‚æ•°éƒ½æ˜¯å½“å‰è¯·æ±‚HttpServletRequestå¸¦æ¥çš„.æ¯«æ— ç–‘é—®,å‰é¢çš„Authenticationå’ŒPrincipalå‚æ•°ä¹Ÿéƒ½æ˜¯HttpServletRequestå¸¦æ¥çš„,é‚£ä¹ˆè¿™äº›æ•°æ®åˆ°åº•æ˜¯ä½•æ—¶æ”¾å…¥HttpServletRequestçš„å‘¢? åˆæ˜¯ä»¥ä½•ç§å½¢å¼å­˜åœ¨çš„å‘¢?æˆ‘ä»¬ä¸‹é¢ä¸€èµ·æ¥åˆ†æä¸‹:</p>
<p>åœ¨Servletè§„èŒƒä¸­,æœ€æ—©æœ‰ä¸‰ä¸ªå’Œå®‰å…¨ç®¡ç†ç›¸å…³çš„æ–¹æ³•:</p>
<ol>
<li>getRemoteUseræ–¹æ³•ç”¨æ¥è·å–ç™»å½•ç”¨æˆ·å.</li>
<li>isUserInRoleæ–¹æ³•ç”¨æ¥åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸä¸ªæŒ‡å®šçš„è§’è‰²</li>
<li>getUserPrincipalæ–¹æ³•ç”¨æ¥è·å–å½“å‰è®¤è¯ä¸»ä½“</li>
</ol>
<p>ä»Servlet3.0å¼€å§‹,åœ¨è¿™ä¸‰ä¸ªæ–¹æ³•çš„åŸºç¡€ä¸Š,åˆå¢åŠ äº†ä¸‰ä¸ªå’Œå®‰å…¨ç®¡ç†ç›¸å…³çš„æ–¹æ³•:</p>
<ol>
<li>authenticateæ–¹æ³•æ¥åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦è®¤è¯æˆåŠŸ</li>
<li>loginæ–¹æ³•å¯ä»¥æ‰§è¡Œç™»å½•æ“ä½œ</li>
<li>logoutæ–¹æ³•å¯ä»¥æ‰§è¡Œæ³¨é”€æ“ä½œ</li>
</ol>
<p>ä¸è¿‡HttpServletRequeståªæ˜¯ä¸€ä¸ªæ¥å£,è¿™äº›å®‰å…¨è®¤è¯ç›¸å…³çš„æ–¹æ³•,åœ¨ä¸åŒçš„ç¯å¢ƒä¼šæœ‰ä¸åŒçš„å®ç°:</p>
<ul>
<li>å¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šçš„Webç›¸å…³,ä¸ä½¿ç”¨ä»»ä½•æ¡†æ¶,HttpServletRequestçš„é»˜è®¤å®ç°ç±»æ˜¯Tomcatä¸­çš„RequestFacade,ä»è¿™ä¸ªç±»çš„åç§°å°±å¯ä»¥çœ‹å‡ºæ¥,è¿™ä½¿ç”¨äº†Facadeæ¨¡å¼(å¤–è§‚æ¨¡å¼)çš„ç±», çœŸæ­£æä¾›åº•å±‚æœåŠ¡çš„æ˜¯Tomcatä¸­çš„Requestå¯¹è±¡,åªä¸è¿‡è¿™ä¸ªRequestå¯¹è±¡åœ¨å®ç°Servletè§„èŒƒçš„åŒæ—¶è¿˜å®šä¹‰äº†å¾ˆå¤šTomcatå†…éƒ¨çš„æ–¹æ³•,ä¸ºäº†é¿å…å¼€å‘è€…ç›´æ¥è°ƒç”¨è¿™äº›å†…éƒ¨æ–¹æ³•,è¿™é‡Œä½¿ç”¨äº†å¤–è§‚æ¨¡å¼</li>
<li>å¦‚æœä½¿ç”¨äº†Spring Securityæ¡†æ¶,é‚£ä¹ˆæˆ‘ä»¬åœ¨Controllerå‚æ•°ä¸­æ‹¿åˆ°çš„HttpServletRequestå®ä¾‹å°†æ˜¯Servlet3SecurityContextHolderAwareRequestWrapper,å¾ˆæ˜æ˜¾,è¿™æ˜¯è¢«Spring Securityå°è£…è¿‡çš„è¯·æ±‚,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Servlet3SecurityContextHolderAwareRequestWrapperçš„ç»§æ‰¿å…³ç³»,å¦‚ä¸‹å›¾:</li>
</ul>
<img src="/2022/01/26/SpringSecurity/image-20230212215627835.png" srcset="/img/loading.gif" lazyload alt="image-20230212215627835" style="zoom: 50%;">

<p>Servlet3.0ä¸­æ–°å¢çš„ä¸‰ä¸ªå®‰å…¨ç®¡ç†ç›¸å…³çš„æ–¹æ³•,åˆ™åœ¨Servlet3SecurityContextHolderAwareRequestWrapperç±»ä¸­å®ç°.è·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯ä¸»è¦å’Œå‰é¢ä¸‰ä¸ªæ–¹æ³•æœ‰å…³,å› æ­¤è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ä¸€ä¸‹SecurityContextHolderAwareRequestWrapperç±»ä¸­ç›¸å…³æ–¹æ³•çš„å®ç°:</p>
<ol>
<li>getAuthentication: è¯¥æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç™»å½•å¯¹è±¡Authentication,è·å–æ–¹å¼å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è®²çš„ä»SecurityContextHolderä¸­è·å–.å¦‚æœä¸æ˜¯åŒ¿åå¯¹è±¡å°±è¿”å›,å¦åˆ™å°±è¿”å›null</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220211491.png" srcset="/img/loading.gif" lazyload alt="image-20230212220211491" style="zoom:50%;">

<ol start="2">
<li>getRemoteUser: è¯¥æ–¹æ³•è¿”å›äº†å½“å‰ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·å,å¦‚æœAuthenticationå¯¹è±¡ä¸­å­˜å‚¨çš„Principalæ˜¯å½“å‰ç™»å½•ç”¨æˆ·å¯¹è±¡,åˆ™è¿”å›ç”¨æˆ·å;</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220651187.png" srcset="/img/loading.gif" lazyload alt="image-20230212220651187" style="zoom:50%;">

<ol start="3">
<li>getUserPrincipal: åˆšæ–¹æ³•è¿”å›å½“å‰ç™»å½•ç”¨æˆ·å¯¹è±¡,å…¶å®å°±æ˜¯Authenticationçš„å®ä¾‹</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220803330.png" srcset="/img/loading.gif" lazyload alt="image-20230212220803330" style="zoom:50%;">

<ol start="4">
<li>isGranted: è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªç§æœ‰çš„æ–¹æ³•,ä½œä¸šæ˜¯åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸä¸ªæŒ‡å®šçš„è§’è‰².åˆ¤æ–­é€»è¾‘ä¹Ÿå¾ˆç®€å•,å…ˆå¯¹ä¼ å…¥çš„è§’è‰²è¿›è¡Œé¢„å¤„ç†,æœ‰çš„æƒ…å†µå¯èƒ½éœ€è¦æ·»åŠ ROLE_å‰ç¼€,ç„¶åè°ƒç”¨Authentication#getAuthoritiesæ–¹æ³•,è·å–å½“å‰ç™»å½•ç”¨æˆ·æ‰€å…·å¤‡çš„æ‰€æœ‰è§’è‰²,æœ€åå†å’Œä¼ å…¥è¿›æ¥çš„å‚æ•°è¿›è¡Œæ¯”è¾ƒ</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212221126723.png" srcset="/img/loading.gif" lazyload alt="image-20230212221126723" style="zoom:50%;">

<ol start="5">
<li>isUserInRole: è¯¥æ–¹æ³•è°ƒç”¨isGrantedæ–¹æ³•,è¿›è€Œå®ç°åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸä¸ªæŒ‡å®šè§’è‰²çš„åŠŸèƒ½</li>
</ol>
<p>æˆ‘ä»¬ç”¨HttpServletRequestå°±å¯ä»¥è·å–åˆ°å¾ˆå¤šä¿¡æ¯äº†:</p>
<img src="/2022/01/26/SpringSecurity/image-20230212221335962.png" srcset="/img/loading.gif" lazyload alt="image-20230212221335962" style="zoom:50%;">

<p>â€‹	å‰é¢æˆ‘ä»¬ç›´æ¥è®²Authenticationæˆ–è€…Principalå†™åˆ°Controllerå‚æ•°ä¸­,å®é™…ä¸Šå°±æ˜¯Spring MVCæ¡†æ¶ä»Servlet3SecurityContextHolderAwareRequestWrapperä¸­æå–çš„ç”¨æˆ·ä¿¡æ¯.</p>
<p>â€‹	é‚£ä¹ˆSpringSecurityæ€ä¹ˆè®²é»˜è®¤çš„è¯·æ±‚å¯¹è±¡åŒ…è£…æˆServlet3SecurityContextHolderAwareRequestWrapperçš„å‘¢?å°±æ¶‰åŠåˆ°å¦ä¸€ä¸ªé‡è¦çš„è¿‡æ»¤å™¨:SecurityContextHolderAwareRequestFilter</p>
<h4 id="é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯"><a href="#é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯"></a>é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯</h4><ul>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>é¡µé¢åŠ å…¥å‘½åç©ºé—´</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;https://www.thymeleaf.org&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:sec</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>é¡µé¢ä¸­ä½¿ç”¨</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--è·å–è®¤è¯ç”¨æˆ·å--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">&quot;principal.username&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">&quot;principal.authorities&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">&quot;principal.accountNonExpired&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">&quot;principal.accountNonLocked&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">&quot;principal.credentialsNonExpired&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-1-9-è‡ªå®šä¹‰è®¤è¯æ•°æ®æº"><a href="#3-1-9-è‡ªå®šä¹‰è®¤è¯æ•°æ®æº" class="headerlink" title="3.1.9 è‡ªå®šä¹‰è®¤è¯æ•°æ®æº"></a>3.1.9 è‡ªå®šä¹‰è®¤è¯æ•°æ®æº</h3><h4 id="è®¤è¯æµç¨‹åˆ†æ"><a href="#è®¤è¯æµç¨‹åˆ†æ" class="headerlink" title="è®¤è¯æµç¨‹åˆ†æ"></a>è®¤è¯æµç¨‹åˆ†æ</h4><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060526805.png" srcset="/img/loading.gif" lazyload class title="image-20220118060526805">

<ul>
<li>å‘èµ·è®¤è¯è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦ç”¨æˆ·åã€å¯†ç ï¼Œè¯¥è¯·æ±‚ä¼šè¢«<code>UsernamePasswordAuthenticationFilter</code> æ‹¦æˆª(å‡†ç¡®æ˜¯AbstractProcessingFilter)</li>
<li>åœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸­å°†è¯·æ±‚ä¸­ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…ä¸º<code>Authentication</code>å¯¹è±¡ï¼Œå¹¶äº¤ç»™<code>AuthenticationManager</code> è¿›è¡Œè®¤è¯</li>
<li>è®¤è¯æˆåŠŸï¼Œå°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ° SecurityContextHodler ä»¥åŠè°ƒç”¨è®°ä½æˆ‘ç­‰ï¼Œå¹¶å›è°ƒ <code>AuthenticationSuccessHandler</code> å¤„ç†</li>
<li>è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ SecurityContextHolder ä»¥åŠ è®°ä½æˆ‘ä¸­ä¿¡æ¯ï¼Œå›è°ƒ <code>AuthenticationFailureHandler</code> å¤„ç†</li>
</ul>
<h4 id="ä¸‰è€…å…³ç³»"><a href="#ä¸‰è€…å…³ç³»" class="headerlink" title="ä¸‰è€…å…³ç³»"></a>ä¸‰è€…å…³ç³»</h4><p>ä»ä¸Šé¢åˆ†æä¸­å¾—çŸ¥ï¼ŒAuthenticationManager æ˜¯è®¤è¯çš„æ ¸å¿ƒç±»ï¼Œä½†å®é™…ä¸Šåœ¨åº•å±‚çœŸæ­£è®¤è¯æ—¶è¿˜ç¦»ä¸å¼€ ProviderManager ä»¥åŠ  AuthenticationProvider ã€‚ä»–ä»¬ä¸‰è€…å…³ç³»æ˜¯æ ·çš„å‘¢ï¼Ÿ</p>
<ul>
<li><code>AuthenticationManager</code> æ˜¯ä¸€ä¸ªè®¤è¯ç®¡ç†å™¨ï¼Œå®ƒå®šä¹‰äº† Spring Security è¿‡æ»¤å™¨è¦æ‰§è¡Œè®¤è¯æ“ä½œã€‚</li>
<li><code>ProviderManager</code> AuthenticationManageræ¥å£çš„å®ç°ç±»ã€‚Spring Security è®¤è¯æ—¶é»˜è®¤ä½¿ç”¨å°±æ˜¯ ProviderManagerã€‚</li>
<li><code>AuthenticationProvider</code> å°±æ˜¯é’ˆå¯¹ä¸åŒçš„èº«ä»½ç±»å‹æ‰§è¡Œçš„å…·ä½“çš„èº«ä»½è®¤è¯ã€‚</li>
</ul>
<p><strong>AuthenticationManager ä¸ ProviderManager</strong></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061756972.png" srcset="/img/loading.gif" lazyload class title="image-20220118061756972">

<p>â€‹	ProviderManager æ˜¯ AuthenticationManager çš„å”¯ä¸€å®ç°ï¼Œä¹Ÿæ˜¯ Spring Security é»˜è®¤ä½¿ç”¨å®ç°ã€‚ä»è¿™é‡Œä¸éš¾çœ‹å‡ºé»˜è®¤æƒ…å†µä¸‹AuthenticationManager å°±æ˜¯ä¸€ä¸ªProviderManagerã€‚</p>
<p><strong>ProviderManager ä¸ AuthenticationProvider</strong></p>
<p>æ‘˜è‡ªå®˜æ–¹: <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060824066.png" srcset="/img/loading.gif" lazyload class title="image-20220118060824066">



<p>â€‹	åœ¨ Spring Security ä¸­ï¼Œå…è®¸ç³»ç»ŸåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¾‹å¦‚åŒæ—¶æ”¯æŒç”¨æˆ·å&#x2F;å¯†ç è®¤è¯ã€ReremberMe è®¤è¯ã€æ‰‹æœºå·ç åŠ¨æ€è®¤è¯ç­‰ï¼Œè€Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”äº†ä¸åŒçš„ AuthenticationProviderï¼Œæ‰€ä»¥ä¸€ä¸ªå®Œæ•´çš„è®¤è¯æµç¨‹å¯èƒ½ç”±å¤šä¸ª AuthenticationProvider æ¥æä¾›ã€‚</p>
<p>â€‹	å¤šä¸ª AuthenticationProvider å°†ç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°†ç”± ProviderManager ä»£ç†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ProviderManager ä¸­å­˜åœ¨ä¸€ä¸ª AuthenticationProvider åˆ—è¡¨ï¼Œåœ¨Provider Manager ä¸­éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ª AuthenticationProvider å»æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œæœ€ç»ˆå¾—åˆ°è®¤è¯ç»“æœã€‚</p>
<p>â€‹	ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥å†é…ç½®ä¸€ä¸ª AuthenticationManager ä½œä¸º parentï¼Œè¿™æ ·å½“ProviderManager è®¤è¯å¤±è´¥ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ° parent ä¸­å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ç†è®ºä¸Šæ¥è¯´ï¼ŒProviderManager çš„ parent å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„ AuthenticationManagerï¼Œä½†æ˜¯é€šå¸¸éƒ½æ˜¯ç”±<br>ProviderManager æ¥æ‰®æ¼” parent çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯ ProviderManager æ˜¯ ProviderManager çš„ parentã€‚</p>
<p>â€‹	ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ªProviderManager å…±ç”¨åŒä¸€ä¸ª parentã€‚æœ‰æ—¶ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰å—ä¿æŠ¤èµ„æºçš„é€»è¾‘ç»„ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰ç¬¦åˆè·¯å¾„æ¨¡å¼çš„ç½‘ç»œèµ„æºï¼Œå¦‚&#x2F;api&#x2F;**ï¼‰ï¼Œæ¯ä¸ªç»„å¯ä»¥æœ‰è‡ªå·±çš„ä¸“ç”¨ AuthenticationManagerã€‚é€šå¸¸ï¼Œæ¯ä¸ªç»„éƒ½æ˜¯ä¸€ä¸ªProviderManagerï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªçˆ¶çº§ã€‚ç„¶åï¼Œçˆ¶çº§æ˜¯ä¸€ç§ <code>å…¨å±€</code>èµ„æºï¼Œä½œä¸ºæ‰€æœ‰æä¾›è€…çš„åå¤‡èµ„æºã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç»˜å‡ºæ–°çš„ AuthenticationManagerã€ProvideManager å’Œ AuthentictionProvider å…³ç³»</p>
<p>æ‘˜è‡ªå®˜ç½‘: <a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061343516.png" srcset="/img/loading.gif" lazyload class title="image-20220118061343516">



<p> å¼„æ¸…æ¥šè®¤è¯åŸç†ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“è®¤è¯æ—¶æ•°æ®æºçš„è·å–ã€‚<code>é»˜è®¤æƒ…å†µä¸‹ AuthenticationProvider  æ˜¯ç”± DaoAuthenticationProvider ç±»æ¥å®ç°è®¤è¯çš„ï¼Œåœ¨DaoAuthenticationProvider è®¤è¯æ—¶åˆé€šè¿‡ UserDetailsService å®Œæˆæ•°æ®æºçš„æ ¡éªŒã€‚</code>ä»–ä»¬ä¹‹é—´è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220114163045543.png" srcset="/img/loading.gif" lazyload class title="image-20220114163045543">

<p><strong>æ€»ç»“: AuthenticationManager æ˜¯è®¤è¯ç®¡ç†å™¨ï¼Œåœ¨ Spring Security ä¸­æœ‰å…¨å±€AuthenticationManagerï¼Œä¹Ÿå¯ä»¥æœ‰å±€éƒ¨AuthenticationManagerã€‚å…¨å±€çš„AuthenticationManagerç”¨æ¥å¯¹å…¨å±€è®¤è¯è¿›è¡Œå¤„ç†ï¼Œå±€éƒ¨çš„AuthenticationManagerç”¨æ¥å¯¹æŸäº›ç‰¹æ®Šèµ„æºè®¤è¯å¤„ç†ã€‚å½“ç„¶æ— è®ºæ˜¯å…¨å±€è®¤è¯ç®¡ç†å™¨è¿˜æ˜¯å±€éƒ¨è®¤è¯ç®¡ç†å™¨éƒ½æ˜¯ç”± ProviderManger è¿›è¡Œå®ç°ã€‚ æ¯ä¸€ä¸ªProviderMangerä¸­éƒ½ä»£ç†ä¸€ä¸ªAuthenticationProviderçš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå®ç°ä»£è¡¨ä¸€ç§èº«ä»½è®¤è¯æ–¹å¼ã€‚è®¤è¯æ—¶åº•å±‚æ•°æ®æºéœ€è¦è°ƒç”¨ UserDetailService æ¥å®ç°ã€‚</strong></p>
<h4 id="é…ç½®å…¨å±€-AuthenticationManager"><a href="#é…ç½®å…¨å±€-AuthenticationManager" class="headerlink" title="é…ç½®å…¨å±€ AuthenticationManager"></a>é…ç½®å…¨å±€ AuthenticationManager</h4><p><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<ul>
<li><p>é»˜è®¤çš„å…¨å±€ AuthenticationManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> &#123;<br>    <span class="hljs-comment">//builder..</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>springboot å¯¹ security è¿›è¡Œè‡ªåŠ¨é…ç½®æ—¶è‡ªåŠ¨åœ¨å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªå…¨å±€<strong>AuthenticationManager</strong></li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€<strong>AuthenticationManager</strong> é»˜è®¤æ‰¾å½“å‰é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰ <strong>UserDetailService</strong> å®ä¾‹ è‡ªåŠ¨å°†å½“å‰é¡¹ç›® UserDetailService å®ä¾‹è®¾ç½®ä¸ºæ•°æ®æº</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>       inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;aaa&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>       <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>   &#125;<br>  <br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">//å› ä¸ºä¸Šé¢çš„UserDetailsServiceä¼šè¦†ç›–é»˜è®¤çš„UserDetailsServiceï¼Œæ‰€ä»¥ä¸‹ä¸€æ¡è¯­å¥ä¸ç”¨å†™</span><br>       <span class="hljs-comment">//builder.userDetailsService(userDetailsService());</span><br>   &#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager åœ¨å·¥å‚ä¸­ä½¿ç”¨æ—¶ç›´æ¥åœ¨ä»£ç ä¸­æ³¨å…¥å³å¯</li>
</ol>
</li>
<li><p>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br> <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    inMemoryUserDetailsManager.createUser(User.builder().username(<span class="hljs-string">&quot;gzzear&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;gaozhe&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    auth.userDetailsService(userDetailsService());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>æ€»ç»“</strong></p>
<ol>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° å°±å›å°†å·¥å‚ä¸­è‡ªåŠ¨é…ç½®AuthenticationManagerï¼ˆä¹‹å‰å…¨å±€çš„ï¼‰ è¿›è¡Œè¦†ç›–</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° éœ€è¦é‡æ–°åœ¨å®ç°ä¸­æŒ‡å®šè®¤è¯æ•°æ®æºå¯¹è±¡ UserDetaiService å®ä¾‹</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° è¿™ç§æ–¹å¼åˆ›å»ºAuthenticationManagerå¯¹è±¡å·¥å‚å†…éƒ¨æœ¬åœ°ä¸€ä¸ª AuthenticationManager å¯¹è±¡ ä¸å…è®¸åœ¨å…¶ä»–è‡ªå®šä¹‰ç»„ä»¶ä¸­è¿›è¡Œæ³¨å…¥</li>
</ol>
</li>
<li><p>ç”¨æ¥åœ¨å·¥å‚ä¸­æš´éœ²è‡ªå®šä¹‰AuthenticationManager å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>  <br>    <span class="hljs-comment">//1.è‡ªå®šä¹‰AuthenticationManager  æ¨è  å¹¶æ²¡æœ‰åœ¨å·¥å‚ä¸­æš´éœ²å‡ºæ¥</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;è‡ªå®šä¹‰AuthenticationManager: &quot;</span> + builder);<br>        builder.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-comment">//ä½œç”¨: ç”¨æ¥å°†è‡ªå®šä¹‰AuthenticationManageråœ¨å·¥å‚ä¸­è¿›è¡Œæš´éœ²,å¯ä»¥åœ¨ä»»ä½•ä½ç½®æ³¨å…¥</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="è‡ªå®šä¹‰å†…å­˜æ•°æ®æº"><a href="#è‡ªå®šä¹‰å†…å­˜æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰å†…å­˜æ•°æ®æº"></a>è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span><br>                <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">u1</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">&quot;zhangs&quot;</span>)<br>                .password(<span class="hljs-string">&quot;&#123;noop&#125;111&quot;</span>).roles(<span class="hljs-string">&quot;USER&quot;</span>).build();<br>        inMemoryUserDetailsManager.createUser(u1);<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;  	<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº</h4><ul>
<li><p>è®¾è®¡è¡¨ç»“æ„</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- ç”¨æˆ·è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>`<br>(<br>    `id`                    <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `username`              <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `password`              <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `enabled`               tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `accountNonExpired`     tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `accountNonLocked`      tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `credentialsNonExpired` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><span class="hljs-comment">-- è§’è‰²è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `role`<br>(<br>    `id`      <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `name`    <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `name_zh` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><span class="hljs-comment">-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `user_role`<br>(<br>    `id`  <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `uid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>    KEY   `uid` (`uid`),<br>    KEY   `rid` (`rid`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>
</li>
<li><p>æ’å…¥æµ‹è¯•æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- æ’å…¥ç”¨æˆ·æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;blr&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><span class="hljs-comment">-- æ’å…¥è§’è‰²æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ROLE_product&#x27;</span>, <span class="hljs-string">&#x27;å•†å“ç®¡ç†å‘˜&#x27;</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;ROLE_admin&#x27;</span>, <span class="hljs-string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;ROLE_user&#x27;</span>, <span class="hljs-string">&#x27;ç”¨æˆ·ç®¡ç†å‘˜&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><span class="hljs-comment">-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br><span class="hljs-keyword">COMMIT</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p>é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½® springboot é…ç½®æ–‡ä»¶</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># datasource</span><br><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;useSSL=false</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># mybatis</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:com/baizhi/mapper/*.xml</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.baizhi.entity</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># log</span><br><span class="hljs-attr">logging.level.com.baizhi</span>=<span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º entity</p>
<ul>
<li><p>åˆ›å»º user å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> Boolean enabled;<br>    <span class="hljs-keyword">private</span> Boolean accountNonExpired;<br>    <span class="hljs-keyword">private</span> Boolean accountNonLocked;<br>    <span class="hljs-keyword">private</span> Boolean credentialsNonExpired;<br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        roles.forEach(role-&gt;grantedAuthorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(role.getName())));<br>        <span class="hljs-keyword">return</span> grantedAuthorities;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> accountNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> accountNonLocked;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> credentialsNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> enabled;<br>    &#125;<br>		<span class="hljs-comment">//get/set....</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º role å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String nameZh;<br>  	<span class="hljs-comment">//get set..</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>åˆ›å»º UserDao æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·</span><br>    User <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>;<br>  	<br>  	<span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢è§’è‰²</span><br>  	List&lt;Role&gt; <span class="hljs-title function_">getRolesByUid</span><span class="hljs-params">(Integer uid)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º UserMapper å®ç°</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--æŸ¥è¯¢å•ä¸ª--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loadUserByUsername&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        select id,<br>               username,<br>               password,<br>               enabled,<br>               accountNonExpired,<br>               accountNonLocked,<br>               credentialsNonExpired<br>        from user<br>        where username = #&#123;username&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--æŸ¥è¯¢æŒ‡å®šè¡Œæ•°æ®--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getRolesByUid&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Role&quot;</span>&gt;</span><br>        select r.id,<br>               r.name,<br>               r.name_zh nameZh #ä¸€å®šè¦é‡åï¼Œä¸ç„¶ä¼šä¸ºnull<br>        from role r,<br>             user_role ur<br>        where r.id = ur.rid<br>          and ur.uid = #&#123;uid&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º UserDetailService å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">final</span> UserDao userDao;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetailService</span><span class="hljs-params">(UserDao userDao)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userDao.loadUserByUsername(username);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(user))<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>);<br>        user.setRoles(userDao.getRolesByUid(user.getId()));<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½® authenticationManager ä½¿ç”¨è‡ªå®šä¹‰UserDetailService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDetailsService userDetailsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebSecurityConfigurer</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        builder.userDetailsService(userDetailsService);<br>    &#125;<br>  <br>  	<br>  	<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      <span class="hljs-comment">//web security..</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨æµ‹è¯•å³å¯</p>
</li>
</ul>
<hr>
<h4 id="é…ç½®å¤šæ•°æ®æº"><a href="#é…ç½®å¤šæ•°æ®æº" class="headerlink" title="é…ç½®å¤šæ•°æ®æº"></a>é…ç½®å¤šæ•°æ®æº</h4><p>â€‹	å¤šä¸ªæ•°æ®æºæ˜¯æŒ‡åœ¨åŒ ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ•°æ®æ¥è‡ªä¸åŒçš„è¡¨ï¼Œåœ¨è®¤è¯æ—¶ï¼Œå¦‚æœç¬¬ ä¸€å¼ è¡¨æ²¡æœ‰æŸ¥æ‰¾åˆ°ç”¨æˆ·ï¼Œé‚£å°±å»ç¬¬äºŒå¼ è¡¨ä¸­æŸ¥è¯¢ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p>
<p>â€‹	çœ‹äº†å‰é¢çš„åˆ†æï¼Œè¦å®ç°è¿™ä¸ªéœ€æ±‚å°±å¾ˆå®¹æ˜“äº†ã€‚è®¤è¯è¦ç»è¿‡<strong>AuthenticationProvider</strong>ï¼Œæ¯ ä¸€ ä¸ª<strong>AuthenticationProvider</strong> ä¸­éƒ½é…ç½®äº†ä¸€ä¸ª<strong>UserDetailsService</strong>ï¼Œè€Œä¸åŒçš„<strong>UserDetailsService</strong> åˆ™å¯ä»¥ä»£è¡¨ä¸åŒçš„æ•°æ®æºã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨é…ç½®å¤šä¸ª <strong>AuthenticationProvider</strong>ï¼Œå¹¶ä¸ºä¸åŒçš„<strong>AuthenticationProvider</strong> æä¾›ä¸åŒçš„<strong>UserDetailsService</strong> å³å¯ã€‚</p>
<p>â€‹	ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œé€šè¿‡<strong>InMemoryUserDetailsManager</strong> æ¥æä¾›<strong>UserDetailsService</strong> å®ä¾‹ï¼Œ åœ¨å®é™…å¼€å‘ä¸­ ï¼Œ åªéœ€è¦å°†<strong>UserDetailsService</strong>æ¢æˆè‡ªå®šä¹‰çš„ å³å¯ ï¼Œ å…·ä½“é…ç½®å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> UserDetailService userDetailService;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">inMemoryUserDetailService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(User.builder().username(<span class="hljs-string">&quot;gaozhe&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;gaozhe&quot;</span>).build());<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DaoAuthenticationProvider</span> <span class="hljs-variable">daoAuthenticationProvider1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationProvider</span>();<br>    daoAuthenticationProvider1.setUserDetailsService(userDetailService);<br>    <span class="hljs-type">DaoAuthenticationProvider</span> <span class="hljs-variable">daoAuthenticationProvider2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationProvider</span>();<br>    daoAuthenticationProvider2.setUserDetailsService(inMemoryUserDetailService());<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(daoAuthenticationProvider1, daoAuthenticationProvider2);<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ª<strong>UserDetailsService</strong> å®ä¾‹ï¼Œä¸åŒå®ä¾‹ä¸­å­˜å‚¨äº†ä¸åŒçš„ç”¨æˆ·;ç„¶åé‡å†™ <strong>authenticationManagerBean</strong> æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ª<strong>DaoAuthenticationProvider</strong> å®ä¾‹å¹¶åˆ†åˆ«è®¾ç½®äº†ä¸åŒçš„ <strong>UserDetailsService</strong> :æœ€åæ„å»º <strong>ProviderManager</strong> å®ä¾‹å¹¶ä¼ å…¥ä¸¤ä¸ª <strong>DaoAuthenticationProvider</strong>ã€‚å½“ç³»ç»Ÿè¿›è¡Œèº«ä»½è®¤è¯æ“ä½œæ—¶ï¼Œå°±ä¼šéå†<strong>ProviderManager</strong> ä¸­ä¸åŒçš„ <strong>DaoAuthenticationProvider</strong>ï¼Œè¿›è€Œè°ƒç”¨åˆ°ä¸åŒçš„æ•°æ®æºã€‚</p>
<h3 id="3-1-10-æ·»åŠ è®¤è¯éªŒè¯ç "><a href="#3-1-10-æ·»åŠ è®¤è¯éªŒè¯ç " class="headerlink" title="3.1.10 æ·»åŠ è®¤è¯éªŒè¯ç "></a>3.1.10 æ·»åŠ è®¤è¯éªŒè¯ç </h3><h4 id="é…ç½®éªŒè¯ç "><a href="#é…ç½®éªŒè¯ç " class="headerlink" title="é…ç½®éªŒè¯ç "></a>é…ç½®éªŒè¯ç </h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.penggle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kaptcha<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.code.kaptcha.Producer;<br><span class="hljs-keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;<br><span class="hljs-keyword">import</span> com.google.code.kaptcha.util.Config;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Producer <span class="hljs-title function_">kaptcha</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.width&quot;</span>, <span class="hljs-string">&quot;150&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.height&quot;</span>, <span class="hljs-string">&quot;50&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.string&quot;</span>, <span class="hljs-string">&quot;0123456789&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>);<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>(properties);<br>        <span class="hljs-type">DefaultKaptcha</span> <span class="hljs-variable">defaultKaptcha</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultKaptcha</span>();<br>        defaultKaptcha.setConfig(config);<br>        <span class="hljs-keyword">return</span> defaultKaptcha;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ä¼ ç»Ÿ-web-å¼€å‘"><a href="#ä¼ ç»Ÿ-web-å¼€å‘" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘"></a>ä¼ ç»Ÿ web å¼€å‘</h4><ul>
<li><p>ç”ŸæˆéªŒè¯ç  controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> éªŒè¯ç æ¥å£</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gaozhe</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/2/4 ä¸‹åˆ5:03</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;éªŒè¯ç æ¥å£&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptchaController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> Producer kaptchaProducer;<br><br>    <span class="hljs-meta">@ApiOperation(value = &quot;éªŒè¯ç &quot;)</span><br>  	<span class="hljs-comment">//producesé…ç½®æ•°æ®ç±»å‹åŠç¼–ç </span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;captcha&quot;, method = RequestMethod.GET, produces = &quot;image/jpeg&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">captcha</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-comment">//è®¾ç½®ç¼“å­˜æ—¶é—´</span><br>        response.setDateHeader(<span class="hljs-string">&quot;Expires&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">//è®¾ç½®ä¸ä½¿ç”¨ç¼“å­˜</span><br>        response.setHeader(<span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;no-store, no-cache, must-revalidate&quot;</span>);<br>        <span class="hljs-comment">//è®¾ç½®ç¼“å­˜æ›´æ–°æ—¶é—´é—´éš”</span><br>        response.addHeader(<span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;post-check=0, pre-check=0&quot;</span>);<br>        <span class="hljs-comment">//ä¸è®¾ç½®ç¼“å­˜</span><br>        response.addHeader(<span class="hljs-string">&quot;Pragma&quot;</span>, <span class="hljs-string">&quot;no-cache&quot;</span>);<br>        <span class="hljs-comment">//è®¾ç½®å“åº”ç±»å‹</span><br>        response.setContentType(<span class="hljs-string">&quot;image/jpeg&quot;</span>);<br><br>        <span class="hljs-comment">//--------------------ç”ŸæˆéªŒè¯ç  begin--------------------</span><br>        <span class="hljs-comment">//è·å–éªŒè¯ç æ–‡æœ¬å†…å®¹</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">verifyCode</span> <span class="hljs-operator">=</span> kaptchaProducer.createText();<br>        log.info(<span class="hljs-string">&quot;éªŒè¯ç çš„å†…å®¹æ˜¯ï¼š&#123;&#125;&quot;</span>, verifyCode);<br>        <span class="hljs-comment">//å°†éªŒè¯ç æ”¾å…¥sessionä¸­</span><br>        request.getSession().setAttribute(<span class="hljs-string">&quot;captcha&quot;</span>, verifyCode);<br>        <span class="hljs-comment">//æ ¹æ®éªŒè¯ç æ–‡æœ¬å†…å®¹ç”Ÿæˆå›¾åƒéªŒè¯ç </span><br>        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> kaptchaProducer.createImage(verifyCode);<br>        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            out = response.getOutputStream();<br>            <span class="hljs-comment">//è¾“å‡ºæµè¾“å‡ºå›¾ç‰‡ï¼Œæ ¼å¼ä¸ºjpg</span><br>            ImageIO.write(image, <span class="hljs-string">&quot;jpg&quot;</span>, out);<br>            out.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">&quot;éªŒè¯ç ç”Ÿæˆå‡ºé”™&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (!Objects.isNull(out)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    out.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">&quot;éªŒè¯ç ç”Ÿæˆå‡ºé”™&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//--------------------ç”ŸæˆéªŒè¯ç  end--------------------</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>è‡ªå®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaNotMatchException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthenticationException</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg)</span> &#123;<br>        <span class="hljs-built_in">super</span>(msg);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg, Throwable cause)</span> &#123;<br>        <span class="hljs-built_in">super</span>(msg, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>è‡ªå®šä¹‰filteréªŒè¯éªŒè¯ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KAPTCHA_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;kaptcha&quot;</span>;<span class="hljs-comment">//é»˜è®¤å€¼</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> KAPTCHA_KEY;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getKaptcha</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> kaptcha;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKaptcha</span><span class="hljs-params">(String kaptcha)</span> &#123;<br>        <span class="hljs-built_in">this</span>.kaptcha = kaptcha;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-comment">//1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼</span><br>        <span class="hljs-keyword">if</span> (request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());<br>        &#125;<br>        <span class="hljs-comment">//2.è·å–éªŒè¯ç </span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> request.getParameter(getKaptcha());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKaptcha</span> <span class="hljs-operator">=</span> (String) request.getSession().getAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionKaptcha) &amp;&amp;<br>                kaptcha.equalsIgnoreCase(sessionKaptcha)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.attemptAuthentication(request, response);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">&quot;éªŒè¯ç è¾“å…¥é”™è¯¯!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>æ”¾è¡Œä»¥åŠé…ç½®éªŒè¯ç  filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDetailsService userDetailsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebSecurityConfigurer</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        builder.userDetailsService(userDetailsService);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> KaptchaFilter <span class="hljs-title function_">kaptchaFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">KaptchaFilter</span> <span class="hljs-variable">kaptchaFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaFilter</span>();<br>        <span class="hljs-comment">//æŒ‡å®šæ¥æ”¶éªŒè¯ç è¯·æ±‚å‚æ•°å</span><br>        kaptchaFilter.setKaptcha(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br>        <span class="hljs-comment">//æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span><br>        kaptchaFilter.setAuthenticationManager(authenticationManagerBean());<br>        <span class="hljs-comment">//æŒ‡å®šè®¤è¯æˆåŠŸå’Œå¤±è´¥å¤„ç†</span><br>        kaptchaFilter.setAuthenticationSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationSuccessHandler</span>());<br>        kaptchaFilter.setAuthenticationFailureHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationFailureHandler</span>());<br>        <span class="hljs-comment">//æŒ‡å®šå¤„ç†ç™»å½•</span><br>        kaptchaFilter.setFilterProcessesUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>);<br>        kaptchaFilter.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>        kaptchaFilter.setPasswordParameter(<span class="hljs-string">&quot;passwd&quot;</span>);<br>        <span class="hljs-keyword">return</span> kaptchaFilter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/vc.jpg&quot;</span>).permitAll()<br>                .mvcMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>              	...<br>        http.addFilterAt(kaptchaFilter(), UsernamePasswordAuthenticationFilter.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ç™»å½•é¡µé¢æ·»åŠ éªŒè¯ç </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span><br>    ç”¨æˆ·å:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;uname&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    å¯†ç :<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;passwd&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    éªŒè¯ç : <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;kaptcha&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;/vc.jpg&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ç™»å½•&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="å‰åç«¯åˆ†ç¦»å¼€å‘"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘"></a>å‰åç«¯åˆ†ç¦»å¼€å‘</h4><ul>
<li><p>ç”ŸæˆéªŒè¯ç  controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> Producer producer;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> RedisUtil redisUtil;<br><br><br>  <span class="hljs-meta">@GetMapping(&quot;/captcha&quot;)</span><br>  <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">getVerifyCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//1.ç”ŸæˆéªŒè¯ç </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> producer.createText();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>    <span class="hljs-comment">//å°†éªŒè¯ç æ”¾å…¥redis</span><br>    redisUtil.set(BusinessConstant.CAPTCHA_KEY + key, code, <span class="hljs-number">2</span>,<br>        TimeUnit.MINUTES);<br>    log.info(<span class="hljs-string">&quot;éªŒè¯ç : &#123;&#125;&quot;</span>, code);<br>    <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">bi</span> <span class="hljs-operator">=</span> producer.createImage(code);<br>    <span class="hljs-comment">//2.å†™å…¥å†…å­˜</span><br>    <span class="hljs-type">FastByteArrayOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastByteArrayOutputStream</span>();<br>    ImageIO.write(bi, <span class="hljs-string">&quot;jpg&quot;</span>, fos);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data:image/jpeg;base64,&quot;</span>;<br>    <span class="hljs-comment">//3.ç”Ÿæˆ base64</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">base64Img</span> <span class="hljs-operator">=</span> str + Base64.encodeBase64String(fos.toByteArray());<br>    <span class="hljs-keyword">return</span> Result.succ(<br>        MapUtil.builder()<br>            .put(<span class="hljs-string">&quot;token&quot;</span>, key)<br>            .put(<span class="hljs-string">&quot;captchaImg&quot;</span>, base64Img)<br>            .build()<br>    );<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaNotMatchException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthenticationException</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg)</span> &#123;<br>        <span class="hljs-built_in">super</span>(msg);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg, Throwable cause)</span> &#123;<br>        <span class="hljs-built_in">super</span>(msg, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åœ¨è‡ªå®šä¹‰LoginKaptchaFilterä¸­åŠ å…¥éªŒè¯ç éªŒè¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">//è‡ªå®šä¹‰ filter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginKaptchaFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FORM_KAPTCHA_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;kaptcha&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">kaptchaParameter</span> <span class="hljs-operator">=</span> FORM_KAPTCHA_KEY;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getKaptchaParameter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> kaptchaParameter;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKaptchaParameter</span><span class="hljs-params">(String kaptchaParameter)</span> &#123;<br>        <span class="hljs-built_in">this</span>.kaptchaParameter = kaptchaParameter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-keyword">if</span> (!request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.è·å–è¯·æ±‚æ•°æ®</span><br>            Map&lt;String, String&gt; userInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> userInfo.get(getKaptchaParameter());<span class="hljs-comment">//ç”¨æ¥è·å–æ•°æ®ä¸­éªŒè¯ç </span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> userInfo.get(getUsernameParameter());<span class="hljs-comment">//ç”¨æ¥æ¥æ”¶ç”¨æˆ·å</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> userInfo.get(getPasswordParameter());<span class="hljs-comment">//ç”¨æ¥æ¥æ”¶å¯†ç </span><br>            <span class="hljs-comment">//2.è·å– session ä¸­éªŒè¯ç </span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sessionVerifyCode</span> <span class="hljs-operator">=</span> (String) request.getSession().getAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br>            <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionVerifyCode) &amp;&amp;<br>                    kaptcha.equalsIgnoreCase(sessionVerifyCode)) &#123;<br>                <span class="hljs-comment">//3.è·å–ç”¨æˆ·å å’Œå¯†ç è®¤è¯</span><br>                <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br>                setDetails(request, authRequest);<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">&quot;éªŒè¯ç ä¸åŒ¹é…!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-comment">//è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br><br>    <span class="hljs-comment">//é…ç½®</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LoginKaptchaFilter <span class="hljs-title function_">loginKaptchaFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">LoginKaptchaFilter</span> <span class="hljs-variable">loginKaptchaFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginKaptchaFilter</span>();<br>        <span class="hljs-comment">//1.è®¤è¯ url</span><br>        loginKaptchaFilter.setFilterProcessesUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>);<br>        <span class="hljs-comment">//2.è®¤è¯ æ¥æ”¶å‚æ•°</span><br>        loginKaptchaFilter.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>        loginKaptchaFilter.setPasswordParameter(<span class="hljs-string">&quot;passwd&quot;</span>);<br>        loginKaptchaFilter.setKaptchaParameter(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br>        <span class="hljs-comment">//3.æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span><br>        loginKaptchaFilter.setAuthenticationManager(authenticationManagerBean());<br>        <span class="hljs-comment">//4.æŒ‡å®šæˆåŠŸæ—¶å¤„ç†</span><br>        loginKaptchaFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;<br>            Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>            result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, authentication.getPrincipal());<br>            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>            resp.setStatus(HttpStatus.OK.value());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>            resp.getWriter().println(s);<br>        &#125;);<br>        <span class="hljs-comment">//5.è®¤è¯å¤±è´¥å¤„ç†</span><br>        loginKaptchaFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;<br>            Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>            result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•å¤±è´¥: &quot;</span> + ex.getMessage());<br>            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());<br>            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>            resp.getWriter().println(s);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> loginKaptchaFilter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/vc.jpg&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .exceptionHandling()<br>                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;<br>                    resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());<br>                    resp.getWriter().println(<span class="hljs-string">&quot;å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®!&quot;</span>);<br>                &#125;)<br>                .and()<br>                .logout()<br>                .and()<br>                .csrf().disable();<br><br>        http.addFilterAt(loginKaptchaFilter(), UsernamePasswordAuthenticationFilter.class);<br>    &#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•éªŒè¯</p>
</li>
</ul>
<h1 id="ç¬¬å››ç« -è¿‡æ»¤å™¨é“¾åˆ†æ"><a href="#ç¬¬å››ç« -è¿‡æ»¤å™¨é“¾åˆ†æ" class="headerlink" title="ç¬¬å››ç«  è¿‡æ»¤å™¨é“¾åˆ†æ"></a>ç¬¬å››ç«  è¿‡æ»¤å™¨é“¾åˆ†æ</h1><p>æœ¬ç« ä¸»è¦è®²è§£SpringSecurityçš„åˆå§‹åŒ–æµç¨‹åˆ†æ</p>
<h2 id="4-1-SpringSecurityæ ¸å¿ƒç±»"><a href="#4-1-SpringSecurityæ ¸å¿ƒç±»" class="headerlink" title="4.1 SpringSecurityæ ¸å¿ƒç±»"></a>4.1 SpringSecurityæ ¸å¿ƒç±»</h2><p>è¦æƒ³æ˜ç™½SpringSecurityçš„è¿‡æ»¤å™¨é“¾åˆå§‹åŒ–æ€è·¯, é¦–å…ˆæˆ‘ä»¬å¯ä»¥ä»<strong>WebSecurity</strong>ã€<strong>HttpSecurity</strong>å¼€å§‹ä¸‹æ‰‹, æˆ‘ä»¬å‘ç°è¿™ä¸¤ä¸ªç±»éƒ½å®ç°äº†<strong>SecurityBuilder</strong>ç±», æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸ªç±»:</p>
<h3 id="4-1-1-SecurityBuilderå®‰å…¨å¯¹è±¡æ„å»ºæ¥å£"><a href="#4-1-1-SecurityBuilderå®‰å…¨å¯¹è±¡æ„å»ºæ¥å£" class="headerlink" title="4.1.1 SecurityBuilderå®‰å…¨å¯¹è±¡æ„å»ºæ¥å£"></a>4.1.1 SecurityBuilderå®‰å…¨å¯¹è±¡æ„å»ºæ¥å£</h3><p>â€‹	Spring Securityä¸­æ‰€æœ‰éœ€è¦æ„å»ºçš„å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡<strong>SecuriyBuilder</strong>æ¥å®ç°, é»˜è®¤çš„è¿‡æ»¤å™¨é“¾ã€ä»£ç†è¿‡æ»¤å™¨ã€<strong>AuthenticationManager</strong>ç­‰, éƒ½å¯ä»¥é€šè¿‡<strong>SecurityBuilder</strong>æ¥æ„å»º. <strong>SecurityBuilder</strong>çš„å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215233755090.png" srcset="/img/loading.gif" lazyload alt="image-20230215233755090" style="zoom:50%;">



<p>â€‹	æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹<strong>SecurityBuilder</strong>çš„æºç :</p>
<img src="/2022/01/26/SpringSecurity/image-20230215234327892.png" srcset="/img/loading.gif" lazyload alt="image-20230215234327892" style="zoom:50%;">

<p>â€‹	ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°, <strong>SecurityBuilder</strong>ä¸­åªæœ‰ä¸€ä¸ªbuildæ–¹æ³•, å°±æ˜¯å¯¹è±¡æ„å»ºæ–¹æ³•. buildæ–¹æ³•çš„è¿”å›å€¼, å°±æ˜¯å…·ä½“æ„å»ºçš„å¯¹è±¡æ³›å‹O, ä¹Ÿå°±æ˜¯è¯´ä¸åŒçš„<strong>SecurityBuilder</strong>å°†æ¥ä¼šæ„å»ºå‡ºä¸åŒçš„å¯¹è±¡.</p>
<p>â€‹	<span style="color:red;">æ€»çš„æ¥è¯´: è¿™ä¸ªç±»æ˜¯SpringSecurityåˆ›å»ºå¯¹è±¡çš„åŸºç±».</span></p>
<h4 id="AbstractSecurityBuilder"><a href="#AbstractSecurityBuilder" class="headerlink" title="AbstractSecurityBuilder"></a>AbstractSecurityBuilder</h4><p>æ‰¿æ¥<strong>SecurityBuilder</strong>, åˆšæˆ‘ä»¬æŸ¥çœ‹æºç å‘ç°è¿™ä¸ªç±»åªæ˜¯ä¸€ä¸ªåŸºç±»å¹¶æ²¡æœ‰å¾ˆå¤šæ–¹æ³•, é‚£ä¹ˆåˆ™éœ€è¦å†å®ç°ä¸€ä¸ªç±»æ¥å®Œæˆæ„å»º.<strong>AbstractSecurityBuilder</strong>å®ç°äº†<strong>SecurityBuilder</strong>æ¥å£, å¹¶å¯¹<strong>build</strong>åšäº†å®Œå–„, ç¡®ä¿åª<strong>build</strong>ä¸€æ¬¡. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>AbstractSecurityBuilder</strong>çš„æºç :</p>
<img src="/2022/01/26/SpringSecurity/image-20230216000810983.png" srcset="/img/loading.gif" lazyload alt="image-20230216000810983" style="zoom:50%;">

<p>ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°, åœ¨<strong>AbstractSecurityBuilder</strong>ç±»ä¸­:</p>
<ol>
<li>é¦–å…ˆå£°æ˜äº†<strong>building</strong>å˜é‡, å¯ä»¥ç¡®ä¿å³ä½¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹, é…ç½®ç±»ä¹Ÿåªæ„å»ºä¸€æ¬¡</li>
<li>å¯¹<strong>build</strong>æ–¹æ³•è¿›è¡Œé‡å†™, å¹¶ä¸”è®¾ç½®ä¸º<strong>final</strong>,è¿™æ ·åœ¨<strong>AbstractSecurityBuilder</strong>çš„å­ç±»ä¸­å°†ä¸èƒ½å†æ¬¡é‡å†™<strong>build</strong>æ–¹æ³•. åœ¨buildæ–¹æ³•å†…éƒ¨, é€šè¿‡<strong>building</strong>å˜é‡æ¥æ§åˆ¶é…ç½®ç±»åªæ„å»ºä¸€æ¬¡, <strong>å…·ä½“çš„æ„å»ºå·¥ä½œåˆ™äº¤ç»™doBuild</strong>æ–¹æ³•å»å®Œæˆ</li>
<li><strong>getObject</strong>æ–¹æ³•ç”¨æ¥è¿”å›æ„å»ºçš„å¯¹è±¡</li>
<li><strong>doBuild</strong>æ–¹æ³•åˆ™æ˜¯å…·ä½“çš„æ„å»ºæ–¹æ³•, è¯¥æ–¹æ³•åœ¨<strong>AbstractSecurityBuilder</strong>ä¸­æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•, å…·ä½“çš„å®ç°åœ¨å…¶å­ç±»ä¸­</li>
</ol>
<p>â€‹	<span style="color:red;"><strong>æ€»è€Œè¨€ä¹‹,AbstractSecurityBuilderå®ç°äº†SecurityBuilderæ¥å£å¹¶ç¡®ä¿åœ¨ç›®æ ‡å¯¹è±¡ä¸­åªæ„å»ºä¸€æ¬¡</strong></span></p>
<h4 id="AbstractConfiguredSecurityBuilder"><a href="#AbstractConfiguredSecurityBuilder" class="headerlink" title="AbstractConfiguredSecurityBuilder"></a>AbstractConfiguredSecurityBuilder</h4><p><strong>AbstractConfiguredSecurityBuilder</strong>è¿™ä¸ªç±»ç»§æ‰¿äº†<strong>AbstractSecurityBuilder</strong>, ç»´æŠ¤äº†<strong>SecurityConfiurer</strong>é›†åˆ,æºç å°±ç¨å¾®é•¿ä¸€ç‚¹, æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹.</p>
<p>é¦–å…ˆåœ¨<strong>AbstractConfiguredSecurityBuilder</strong>ä¸­å£°æ˜äº†ä¸€ä¸ªæšä¸¾ç±», ç”¨æ¥æè¿°æ„å»ºè¿‡ç¨‹çš„ä¸åŒçŠ¶æ€:</p>
<img src="/2022/01/26/SpringSecurity/image-20230216095646474.png" srcset="/img/loading.gif" lazyload alt="image-20230216095646474" style="zoom:50%;">

<p>å¯ä»¥çœ‹åˆ°, æ•´ä¸ªæ„å»ºè¿‡ç¨‹ä¸€å…±æœ‰äº”ç§ä¸åŒçš„çŠ¶æ€:</p>
<ul>
<li><strong>UNBUILT</strong>: é…ç½®ç±»æ„å»ºå‰</li>
<li><strong>INITIALIZING</strong>: åˆå§‹åŒ–ä¸­ (åˆå§‹åŒ–å®Œæˆä¹‹å‰æ˜¯è¿™ä¸ªçŠ¶æ€)</li>
<li><strong>CONFIGURING</strong>: é…ç½®ä¸­ (å¼€å§‹æ„å»ºä¹‹å‰æ˜¯è¿™ä¸ªçŠ¶æ€)</li>
<li><strong>BUILDING</strong>: æ„å»ºä¸­</li>
<li><strong>BUILT</strong>: æ„å»ºå®Œæˆ</li>
</ul>
<p>è¿™ä¸ªæšä¸¾ç±»é‡Œé¢è¿˜æä¾›äº†ä¸¤ä¸ªåˆ¤æ–­æ–¹æ³•, <strong>isInitializing</strong>è¡¨ç¤ºæ˜¯å¦æ­£åœ¨åˆå§‹åŒ–ä¸­, <strong>isConfigured</strong>æ–¹æ³•è¡¨ç¤ºæ˜¯å¦å·²å®Œæˆé…ç½®</p>
<p><strong>AbstractConfiguredSecurityBuilder</strong>ä¸­è¿˜å£°æ˜äº†<strong>configurers</strong>å˜é‡, ç”¨æ¥ä¿å­˜æ‰€æœ‰çš„é…ç½®ç±». é’ˆå¯¹<strong>configurers</strong>å˜é‡, æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ·»åŠ é…ç½®ã€ç§»é™¤é…ç½®ç­‰æ“ä½œ, ç›¸å…³æ–¹æ³•å¦‚ä¸‹: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt;<br>		<span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSecurityBuilder</span>&lt;O&gt; &#123;<br>  <br>  	<span class="hljs-comment">//é¦–å…ˆå£°æ˜äº†ä¸€ä¸ªconfigurerså˜é‡, ç”¨æ¥ä¿å­˜æ‰€æœ‰çš„é…ç½®ç±», keyæ˜¯é…ç½®ç±»Classå¯¹è±¡, å€¼æ˜¯ä¸€ä¸ªListé›†åˆä¸­æ”¾ç€é…ç½®ç±»</span><br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LinkedHashMap&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;, List&lt;SecurityConfigurer&lt;O, B&gt;&gt;&gt; configurers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><br>  	<span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;O, B&gt;&gt; C <span class="hljs-title function_">apply</span><span class="hljs-params">(C configurer)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		configurer.addObjectPostProcessor(<span class="hljs-built_in">this</span>.objectPostProcessor);<br>		configurer.setBuilder((B) <span class="hljs-built_in">this</span>);<br>		add(configurer);<br>		<span class="hljs-keyword">return</span> configurer;<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="hljs-title function_">apply</span><span class="hljs-params">(C configurer)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		add(configurer);<br>		<span class="hljs-keyword">return</span> configurer;<br>	&#125;<br>  <br>  <span class="hljs-keyword">private</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(C configurer)</span> &#123;<br>		Assert.notNull(configurer, <span class="hljs-string">&quot;configurer cannot be null&quot;</span>);<br>		Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; clazz = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;) configurer<br>				.getClass();<br>		<span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.configurers) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.buildState.isConfigured()) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot apply &quot;</span> + configurer + <span class="hljs-string">&quot; to already built object&quot;</span>);<br>			&#125;<br>			List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="hljs-literal">null</span>;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.allowConfigurersOfSameType) &#123;<br>				configs = <span class="hljs-built_in">this</span>.configurers.get(clazz);<br>			&#125;<br>			configs = (configs != <span class="hljs-literal">null</span>) ? configs : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>			configs.add(configurer);<br>			<span class="hljs-built_in">this</span>.configurers.put(clazz, configs);<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.buildState.isInitializing()) &#123;<br>				<span class="hljs-built_in">this</span>.configurersAddedInInitializing.add(configurer);<br>			&#125;<br>		&#125;<br>	&#125;<br>  <br>	<span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="hljs-title function_">getConfigurers</span><span class="hljs-params">(Class&lt;C&gt; clazz)</span> &#123;<br>		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="hljs-built_in">this</span>.configurers.get(clazz);<br>		<span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(configs);<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="hljs-title function_">removeConfigurers</span><span class="hljs-params">(Class&lt;C&gt; clazz)</span> &#123;<br>		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="hljs-built_in">this</span>.configurers.remove(clazz);<br>		<span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(configs);<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="hljs-title function_">getConfigurer</span><span class="hljs-params">(Class&lt;C&gt; clazz)</span> &#123;<br>		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="hljs-built_in">this</span>.configurers.get(clazz);<br>		<span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br>		Assert.state(configs.size() == <span class="hljs-number">1</span>,<br>				() -&gt; <span class="hljs-string">&quot;Only one configurer expected for type &quot;</span> + clazz + <span class="hljs-string">&quot;, but got &quot;</span> + configs);<br>		<span class="hljs-keyword">return</span> (C) configs.get(<span class="hljs-number">0</span>);<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="hljs-title function_">removeConfigurer</span><span class="hljs-params">(Class&lt;C&gt; clazz)</span> &#123;<br>		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="hljs-built_in">this</span>.configurers.remove(clazz);<br>		<span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br>		Assert.state(configs.size() == <span class="hljs-number">1</span>,<br>				() -&gt; <span class="hljs-string">&quot;Only one configurer expected for type &quot;</span> + clazz + <span class="hljs-string">&quot;, but got &quot;</span> + configs);<br>		<span class="hljs-keyword">return</span> (C) configs.get(<span class="hljs-number">0</span>);<br>	&#125;<br></code></pre></td></tr></table></figure>



<p>æˆ‘ä»¬æ¥è§£æä¸€ä¸‹è¿™æ®µæºç :</p>
<ol>
<li>é¦–å…ˆå£°æ˜äº†ä¸€ä¸ª<strong>configurers</strong>å˜é‡, ç”¨æ¥ä¿å­˜æ‰€æœ‰çš„é…ç½®ç±», keyæ˜¯é…ç½®ç±»Classå¯¹è±¡, å€¼æ˜¯ä¸€ä¸ªListé›†åˆä¸­æ”¾ç€é…ç½®ç±»</li>
<li><strong>apply</strong>æ–¹æ³•æœ‰ä¸¤ä¸ª,å‚æ•°ç±»å‹å·®ä¸å¤š, ä¸»è¦åŠŸèƒ½åŸºæœ¬ä¸€è‡´, éƒ½æ˜¯å‘<strong>configurers</strong>å˜é‡ä¸­æ·»åŠ é…ç½®ç±», å…·ä½“çš„æ·»åŠ è¿‡ç¨‹åˆ™æ˜¯è°ƒç”¨<strong>add</strong>æ–¹æ³•.</li>
<li><strong>add</strong>æ–¹æ³•ç”¨æ¥å°†æ‰€æœ‰çš„é…ç½®ç±»ä¿å­˜åœ¨<strong>configurers</strong>ä¸­, åœ¨æ·»åŠ çš„è¿‡ç¨‹ä¸­, å¦‚æœ<strong>allowConfigurersOfSameType</strong>å˜é‡ä¸º<strong>true</strong>, åˆ™è¡¨ç¤ºå…è®¸ç›¸åŒç±»å‹çš„é…ç½®å­˜åœ¨, ä¹Ÿå°±æ˜¯Listé›†åˆä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç›¸åŒç±»å‹çš„é…ç½®ç±». é»˜è®¤æƒ…å†µä¸‹, å¦‚æœæ˜¯æ™®é€šé…ç½®ç±», <strong>allowConfigurersOfSameType</strong>æ˜¯<strong>false</strong>, æ‰€ä»¥Listé›†åˆä¸­çš„é…ç½®ç±»å§‹ç»ˆåªæœ‰ä¸€ä¸ªé…ç½®ç±»; å¦‚æœåœ¨<strong>AuthenticationManagerBuilder</strong>ä¸­è®¾ç½®<strong>allowConfigurersOfSameType</strong>ä¸º<strong>true</strong>, æ­¤æ—¶ç›¸åŒç±»å‹çš„é…ç½®ç±»å¯ä»¥æœ‰å¤šä¸ª (åæ–‡ä¼šè¯¦ç»†ä»‹ç»)</li>
<li><strong>getConfigurers(Class<C>)</C></strong> æ–¹æ³•å¯ä»¥ä»<strong>configurers</strong>ä¸­è¿”å›æŸä¸ªé…ç½®ç±»å¯¹åº”çš„æ‰€æœ‰å®ä¾‹</li>
<li><strong>removeConfigurers</strong>æ–¹æ³•å¯ä»¥ä»<strong>configurers</strong>ä¸­ç§»é™¤æŸä¸€ä¸ªé…ç½®ç±»å¯¹åº”çš„æ‰€æœ‰å®ä¾‹, å¹¶è¿”å›è¢«ç§»é™¤æ‰çš„é…ç½®ç±»å®ä¾‹é›†åˆ</li>
</ol>
<p>è¿™äº›å°±æ˜¯<strong>AbstractConfiguredSecurityBuilder</strong>ä¸­å…³äº<strong>configurers</strong>çš„æ‰€æœ‰æ“ä½œ</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯<strong>AbstractConfiguredSecurityBuilder</strong>ä¸­çš„<strong>doBuild</strong>æ–¹æ³•äº†, è¿™æ˜¯æ ¸å¿ƒçš„æ„å»ºæ–¹æ³•, æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ç›¸åº”æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Executes the build using the &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer&#125;&#x27;s that have been applied</span><br><span class="hljs-comment"> * using the following steps:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;ul&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;Invokes &#123;<span class="hljs-doctag">@link</span> #beforeInit()&#125; for any subclass to hook into&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;Invokes &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer#init(SecurityBuilder)&#125; for any</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer&#125; that was applied to this builder.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;Invokes &#123;<span class="hljs-doctag">@link</span> #beforeConfigure()&#125; for any subclass to hook into&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;Invokes &#123;<span class="hljs-doctag">@link</span> #performBuild()&#125; which actually builds the Object&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;/ul&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	<span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.configurers) &#123;<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.INITIALIZING;<br>		beforeInit();<br>		init();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.CONFIGURING;<br>		beforeConfigure();<br>		configure();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.BUILDING;<br>		<span class="hljs-type">O</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> performBuild();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.BUILT;<br>		<span class="hljs-keyword">return</span> result;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoked prior to invoking each &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer#init(SecurityBuilder)&#125;</span><br><span class="hljs-comment"> * method. Subclasses may override this method to hook into the lifecycle without</span><br><span class="hljs-comment"> * using a &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer&#125;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeInit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Invoked prior to invoking each</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer#configure(SecurityBuilder)&#125; method. Subclasses may</span><br><span class="hljs-comment"> * override this method to hook into the lifecycle without using a</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> SecurityConfigurer&#125;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeConfigure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Subclasses must implement this method to build the object that is being returned.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the Object to be buit or null if the implementation allows it</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> O <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();<br>	<span class="hljs-keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;<br>		configurer.init((B) <span class="hljs-built_in">this</span>);<br>	&#125;<br>	<span class="hljs-keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : <span class="hljs-built_in">this</span>.configurersAddedInInitializing) &#123;<br>		configurer.init((B) <span class="hljs-built_in">this</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();<br>	<span class="hljs-keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;<br>		configurer.configure((B) <span class="hljs-built_in">this</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<ol>
<li>åœ¨<strong>doBuild</strong>æ–¹æ³•ä¸­, ä¸€è¾¹æ›´æ–°æ„å»ºçŠ¶æ€, ä¸€è¾¹æ‰§è¡Œæ„å»ºæ–¹æ³•. æ„å»ºæ–¹æ³•ä¸­, <strong>beforeInit</strong>æ˜¯ä¸€ä¸ªç©ºçš„åˆå§‹åŒ–æ–¹æ³•, å¦‚æœéœ€è¦åœ¨åˆå§‹åŒ–ä¹‹å‰åšä¸€äº›å‡†å¤‡å·¥ä½œ, å¯ä»¥é€šè¿‡é‡å†™è¯¥æ–¹æ³•æ¥å®ç°.</li>
<li><strong>init</strong>æ–¹æ³•æ˜¯æ‰€æœ‰é…ç½®ç±»çš„åˆå§‹åŒ–æ–¹æ³•, åœ¨è¯¥æ–¹æ³•ä¸­, éå†æ‰€æœ‰çš„é…ç½®ç±», å¹¶è°ƒç”¨å…¶<strong>init</strong>æ–¹æ³•å®Œæˆåˆå§‹åŒ–æ“ä½œ</li>
<li><strong>beforeConfigure</strong>æ–¹æ³•å¯ä»¥åœ¨<strong>configure</strong>æ–¹æ³•æ‰§è¡Œä¹‹å‰åšä¸€äº›å‡†å¤‡æ“ä½œ. è¯¥æ–¹æ³•é»˜è®¤ä¹Ÿæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•.</li>
<li><strong>configure</strong>æ–¹æ³•ç”¨æ¥å®Œæˆæ‰€æœ‰é…ç½®ç±»çš„é…ç½®, åœ¨<strong>configure</strong>æ–¹æ³•ä¸­, éå†æ‰€æœ‰çš„é…ç½®ç±», åˆ†åˆ«è°ƒç”¨å…¶<strong>configure</strong>æ–¹æ³•æ¥å®Œæˆé…ç½®</li>
<li><strong>performBuild</strong>æ–¹æ³•ç”¨æ¥åšæœ€ç»ˆçš„æ„å»ºæ“ä½œ, å‰é¢çš„å‡†å¤‡å·¥ä½œå®Œæˆä¹‹å, æœ€ååœ¨<strong>performBuild</strong>æ–¹æ³•ä¹‹åå®Œæˆæ„å»º, è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•, å…·ä½“çš„å®ç°åˆ™åœ¨ä¸åŒçš„é…ç½®ç±»ä¸­.</li>
</ol>
<p><span style="color:red;">æ€»è€Œè¨€ä¹‹: <strong>AbstractConfiguredSecurityBuilder</strong>ç»§æ‰¿äº†<strong>AbstractSecurityBuilder</strong>, å¹¶ç»´æŠ¤äº†<strong>SecurityConfigure</strong>é›†åˆ, <strong>å¼•å…¥äº†ä¸åŒçš„æ„å»ºçŠ¶æ€</strong>ä»¥åŠæ ¸å¿ƒæ–¹æ³•<strong>doBuild</strong>æ¥éå†ç»´æŠ¤çš„<strong>SecurityConfigure</strong>é›†åˆæ¥è¿›è¡Œåˆå§‹åŒ–<strong>init</strong>å’Œé…ç½®<strong>configure</strong>æ“ä½œã€æœ€åæ„å»º<strong>performBuilde</strong>. </span></p>
<h3 id="4-1-2-ObjectPostProcessorå¯¹è±¡åç½®å¤„ç†å™¨"><a href="#4-1-2-ObjectPostProcessorå¯¹è±¡åç½®å¤„ç†å™¨" class="headerlink" title="4.1.2 ObjectPostProcessorå¯¹è±¡åç½®å¤„ç†å™¨"></a>4.1.2 ObjectPostProcessorå¯¹è±¡åç½®å¤„ç†å™¨</h3><p><span style="color:red;"><strong>ObjectPostProcessor</strong>æ˜¯Spring Securityä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ç»„ä»¶ä¹‹ä¸€, å®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡åç½®å¤„ç†å™¨, ä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæˆåŠŸå,å¦‚æœè¿˜æœ‰ä¸€äº›é¢å¤–çš„äº‹æƒ…éœ€è¦è¡¥å……,é‚£ä¹ˆå¯ä»¥é€šè¿‡<strong>ObjectPostProcessor</strong>æ¥è¿›è¡Œå¤„ç†.</span>è¿™ä¸ªæ¥å£é»˜è®¤åªæœ‰ä¸€ä¸ªæ–¹æ³•<strong>postProcess</strong>, è¯¥æ–¹æ³•ç”¨æ¥å®Œæˆå¯¹å¯¹è±¡çš„äºŒæ¬¡å¤„ç†,ä»£ç å¦‚ä¸‹:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215224147534.png" srcset="/img/loading.gif" lazyload alt="image-20230215224147534" style="zoom:50%;">

<p><strong>ObjectPostProcessor</strong>æœ‰ä¸¤ä¸ªé»˜è®¤å®ç°:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215230305042.png" srcset="/img/loading.gif" lazyload alt="image-20230215230305042" style="zoom:50%;">

<ul>
<li><strong>AutowireBeanFactoryObjectPostProcessor</strong>:  ç”±äºSpringSecurityä¸­å¤§é‡é‡‡ç”¨äº†Javaé…ç½®, è®¸å¤šè¿‡æ»¤å™¨éƒ½æ˜¯ç›´æ¥newå‡ºæ¥çš„, è¿™äº›ç›´æ¥newå‡ºæ¥çš„å¯¹è±¡å¹¶ä¸ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°Springå®¹å™¨ä¸­.SpringSecurityè¿™æ ·åšçš„æœ¬æ„æ˜¯ä¸ºäº†ç®€åŒ–é…ç½®,ä½†æ˜¯å´å¸¦æ¥äº†å¦å¤–ä¸€ä¸ªé—®é¢˜å°±æ˜¯, å¤§é‡newå‡ºæ¥çš„å¯¹è±¡éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ³¨å†Œåˆ°Springå®¹å™¨ä¸­å». AutowireBeanFactoryObjectPostProcessorå¯¹è±¡æ‰€æ‰¿æ‹…çš„å°±æ˜¯è¿™ä»¶äº‹,ä¸€ä¸ªå¯¹è±¡newå‡ºæ¥ä¹‹å,åªè¦è°ƒç”¨AutowireBeanFactoryObjectPostProcessor#postProcessoræ–¹æ³•å°±å¯ä»¥æˆåŠŸæ³¨å…¥åˆ°Springå®¹å™¨ä¸­, å®ƒçš„å®ç°åŸç†å°±æ˜¯é€šè¿‡è°ƒç”¨Springå®¹å™¨ä¸­çš„AutowireCapableBeanFactoryå¯¹è±¡å°†ä¸€ä¸ªnewå‡ºæ¥çš„å¯¹è±¡æ³¨å…¥åˆ°Springå®¹å™¨ä¸­å».</li>
<li><strong>CompositeObjectPostProcessor</strong>:  è¿™æ˜¯ObjectPostProcessorçš„å¦ä¸€ä¸ªå®ç°, ä¸€ä¸ªå¯¹è±¡å¯ä»¥æœ‰ä¸€ä¸ªåç½®å¤„ç†å™¨,å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰å¤šä¸ªå¯¹è±¡åç½®å¤„ç†å™¨. CompositeObjectPostProcessoræ˜¯ä¸€ä¸ªç»„åˆçš„å¯¹è±¡åç½®å¤„ç†å™¨, å®ƒé‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ªListé›†åˆ, é›†åˆé‡Œé¢å­˜æ”¾äº†æŸä¸ªå¯¹è±¡åç½®å¤„ç†å™¨, å®ƒé‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ªListé›†åˆ, é›†åˆé‡Œé¢å­˜æ”¾äº†æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰åç½®å¤„ç†å™¨, å½“éœ€è¦æ‰§è¡Œå¯¹è±¡çš„åç½®å¤„ç†å™¨æ—¶, ä¼šéå†é›†åˆä¸­çš„æ‰€æœ‰ObjectPostProcessorå®ä¾‹, åˆ†åˆ«è°ƒç”¨å®ä¾‹çš„postProcessæ–¹æ³•è¿›è¡Œå¯¹è±¡åç½®å¤„ç†. <strong>åœ¨SpringSecurityæ¡†æ¶ä¸­, æœ€ç»ˆä½¿ç”¨çš„å¯¹è±¡åç½®å¤„ç†å™¨å…¶å®å°±æ˜¯CompositeObjectPostProcessor, å®ƒé‡Œé¢çš„é›†åˆé»˜è®¤åªæœ‰ä¸€ä¸ªå¯¹è±¡, å°±æ˜¯AutowireBeanFactoryObjectPostProcessor</strong></li>
</ul>
<p>â€‹	åœ¨Spring Securityä¸­, å¼€å‘è€…å¯ä»¥çµæ´»åœ°é…ç½®é¡¹ç›®ä¸­éœ€è¦å“ªäº›Spring Securityè¿‡æ»¤å™¨, ä¸€æ—¦é€‰å®šè¿‡æ»¤å™¨ä¹‹å,<span style="color:red;"> <strong>æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„é…ç½®å™¨, å«åšxxxConfigurer (ä¾‹å¦‚: CorsConfigurerã€CsrfConfigurerã€FormLoginConfigurerç­‰), è¿‡æ»¤å™¨éƒ½æ˜¯åœ¨xxxConfigurerä¸­newå‡ºæ¥çš„, ç„¶ååœ¨postProcessæ–¹æ³•ä¹‹åå¤„ç†ä¸€é, å°±å°†è¿™äº›è¿‡æ»¤å™¨æ³¨å…¥åˆ°Springå®¹å™¨ä¸­äº†.</strong></span></p>
<p>â€‹	è¿™å°±æ˜¯å¯¹è±¡åç½®å¤„ç†å™¨<strong>ObjectPostProcessor</strong>çš„ä½œç”¨</p>
<h4 id="ObjectPostProcessorè‡ªå®šä¹‰ä½¿ç”¨"><a href="#ObjectPostProcessorè‡ªå®šä¹‰ä½¿ç”¨" class="headerlink" title="ObjectPostProcessorè‡ªå®šä¹‰ä½¿ç”¨"></a>ObjectPostProcessorè‡ªå®šä¹‰ä½¿ç”¨</h4><p>å‰é¢ä»‹ç»äº†<strong>ObjectPostProcessor</strong>çš„åŸºæœ¬ä½¿ç”¨. æ‰€æœ‰çš„è¿‡æ»¤å™¨éƒ½ç”±å¯¹åº”çš„é…ç½®ç±»æ¥è´Ÿè´£åˆ›å»º, é…ç½®ç±»åœ¨å°†è¿‡æ»¤å™¨åˆ›å»ºæˆåŠŸä¹‹å, ä¼šè°ƒç”¨çˆ¶ç±»çš„<strong>postProcess</strong>æ–¹æ³•, è¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ°<strong>CompositeObjectPostProcessor</strong>å¯¹è±¡æ‰€ç»´æŠ¤çš„Listé›†åˆä¸­å­˜å‚¨çš„æ‰€æœ‰<strong>ObjectPostProcessor</strong>å¯¹è±¡, å¹¶è°ƒç”¨å…¶<strong>postProcess</strong>æ–¹æ³•å¯¹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†. é»˜è®¤æƒ…å†µä¸‹, <strong>CompositeObjectPostProcessor</strong>å¯¹è±¡ä¸­ç»´æŠ¤çš„Listé›†åˆä¸­åªæœ‰ä¸€ä¸ªå¯¹è±¡é‚£å°±æ˜¯<strong>AutowireBeanFactoryObjectPostProcessor</strong>, è°ƒç”¨<strong>AutowireBeanFactoryObjectPostProcessor</strong>, è°ƒç”¨<strong>AutowireBeanFactroyObjectPostProcessor</strong>çš„<strong>postProcess</strong>æ–¹æ³•å¯ä»¥å°†å¯¹è±¡æ³¨å†Œåˆ°Springå®¹å™¨ä¸­å».</p>
<p>â€‹	å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰<strong>ObjectPostProcessor</strong>å¯¹è±¡, å¹¶æ·»åŠ åˆ°<strong>CompositeObjectPostProcessor</strong>æ‰€ç»´æŠ¤çš„Listé›†åˆä¸­, æ­¤æ—¶, å½“ä¸€ä¸ªè¿‡æ»¤å™¨åœ¨åˆ›å»ºæˆåŠŸä¹‹å, å°±ä¼šè¢«ä¸¤ä¸ªå¯¹è±¡åç½®å¤„ç†å™¨å¤„ç†, ç¬¬ä¸€ä¸ªé»˜è®¤çš„å¯¹è±¡åç½®å¤„ç†å™¨, è´Ÿè´£å°†å¯¹è±¡æ³¨å†Œåˆ°Springå®¹å™¨ä¸­; ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å¯¹è±¡åç½®å¤„ç†å™¨, å¯ä»¥å®Œæˆä¸€ä¸‹ä¸ªæ€§åŒ–é…ç½®</p>
<p>â€‹	è‡ªå®šä¹‰<strong>ObjectPostProcessor</strong>å¯¹è±¡æ¯”è¾ƒå…¸å‹çš„ç”¨æ³•æ˜¯åŠ¨æ€æƒé™é…ç½®, ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£, è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªå¤§å®¶ç†Ÿæ‚‰çš„æ¡ˆä¾‹æ¥å±•ç¤º<strong>ObjectPostProcessor</strong>çš„ç”¨æ³•, åé¢åœ¨é…ç½®åŠ¨æ€æƒé™æ—¶, <strong>ObjectPostProcessor</strong>çš„ä½¿ç”¨æ€è·¯æ˜¯ä¸€è‡´çš„.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(<br>        User.builder().username(<span class="hljs-string">&quot;admin&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;admin123&quot;</span>).build());<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> DefaultSecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>        .anyRequest().authenticated()<br>        .and().formLogin()<br>        .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;UsernamePasswordAuthenticationFilter&gt;() &#123;<br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> &#123;<br>            <span class="hljs-comment">//è‡ªå®šä¹‰ObjectPostProcessor</span><br>            object.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>            object.setPasswordParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>            object.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;<br>              response.getWriter().write(<span class="hljs-string">&quot;login success&quot;</span>);<br>            &#125;);<br>            <span class="hljs-keyword">return</span> object;<br>          &#125;<br>        &#125;)<br>        .and().userDetailsService(userDetailService())<br>        .csrf().disable();<br><br>    <span class="hljs-keyword">return</span> http.build();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="/2022/01/26/SpringSecurity/image-20230718112719806.png" srcset="/img/loading.gif" lazyload alt="image-20230718112719806"></p>
<p>â€‹	åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­, è°ƒç”¨<strong>formLogin</strong>æ–¹æ³•ä¹‹å, å¼€å¯äº†<strong>FormLoginConfigurer</strong>çš„é…ç½®, <strong>FormLoginConfigurer</strong>çš„ä½œç”¨æ˜¯ä¸ºäº†é…ç½®<strong>UsernamePasswordAuthenticationFilter</strong>è¿‡æ»¤å™¨, åœ¨<strong>formLogin</strong>æ–¹æ³•æ‰§è¡Œå®Œæ¯•å, æˆ‘ä»¬è°ƒç”¨<strong>withObjectPostProcessor</strong>æ–¹æ³•å¯¹<strong>UsernamePasswordAuthenticationFilter</strong>è¿‡æ»¤å™¨è¿›è¡ŒäºŒæ¬¡å¤„ç†, ä¿®æ”¹ç™»å½•å‚æ•°çš„key, å°†ç™»å½•ç”¨æˆ·åå‚æ•°çš„keyæ”¹ä¸ºname, å°†ç™»å½•å¯†ç å‚æ•°çš„keyæ”¹ä¸ºpasswd, åŒæ—¶é…ç½®ä¸€ä¸ªç™»å½•æˆåŠŸçš„å¤„ç†å™¨.</p>
<h3 id="4-1-3-SecurityConfigureré…ç½®æ¥å£"><a href="#4-1-3-SecurityConfigureré…ç½®æ¥å£" class="headerlink" title="4.1.3 SecurityConfigureré…ç½®æ¥å£"></a>4.1.3 SecurityConfigureré…ç½®æ¥å£</h3><p>â€‹		æˆ‘ä»¬ä¹‹å‰è®²è¿‡äº†<strong>SecurityBuilder</strong>æ˜¯ç”¨æ¥æ„å»ºå®‰å…¨å¯¹è±¡æ¯”å¦‚:<strong>SecurityFilterChain</strong>ã€<strong>FilterChainProxy</strong>ã€<strong>ProviderManager</strong>,è€Œ<span style="color:red;"><strong>SecurityConfigurer</strong>è¿™ä¸ªç±»æ˜¯ç”¨æ¥é…ç½®å’Œåˆå§‹åŒ–<strong>SecurityBuilder</strong>çš„é…ç½®ç±», è€Œå¾€å¾€ä¸€ä¸ª<strong>SecurityBuilder</strong>ä¼šç»´æŠ¤å¤šä¸ª<strong>SecurityConfigurer</strong>æ¥è¿›è¡Œåˆå§‹åŒ–å’Œé…ç½®(åªéœ€è¦ç»§æ‰¿<strong>AbstractConfiguredSecurityBuilder</strong>).</span><strong>SecurityConfigurer</strong>ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•, ä¸€ä¸ªæ˜¯<strong>init</strong>æ–¹æ³•, ç”¨æ¥å®Œæˆé…ç½®ç±»çš„åˆå§‹åŒ–æ“ä½œ, å¦å¤–ä¸€ä¸ªæ˜¯<strong>configure</strong>æ–¹æ³•, è¿›è¡Œé…ç½®ç±»çš„é…ç½®. åé¢ä»‹ç»çš„<strong>AbstractConfiguredSecurityBuilder</strong>ç±»é‡Œé¢çš„<strong>init</strong>æ–¹æ³•å’Œ<strong>configure</strong>å…¶å®å°±æ˜¯åœ¨éå†æ‰§è¡Œä¸åŒé…ç½®ç±»çš„<strong>init</strong>å’Œ<strong>configure</strong>æ–¹æ³•.</p>
<p>â€‹	<strong>SecurityConfigurer</strong>çš„å®ç°ç±»æ¯”è¾ƒå¤š, è¿™é‡Œä¸»è¦æ¢³ç†ä¸€ä¸‹å¸¸è§çš„<strong>SecurityConfigurer</strong>å®ç°ç±»,æˆ‘ä»¬å¯ä»¥åˆ†åˆ«æ¥çœ‹ä¸‹ä¸€ä¸‹:</p>
<p>â€‹	å…ˆæ¥çœ‹ä¸‹<strong>SecurityConfigurer</strong>æºç , ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Initialize the &#123;<span class="hljs-doctag">@link</span> SecurityBuilder&#125;. Here only shared state should be created</span><br><span class="hljs-comment">	 * and modified, but not properties on the &#123;<span class="hljs-doctag">@link</span> SecurityBuilder&#125; used for building</span><br><span class="hljs-comment">	 * the object. This ensures that the &#123;<span class="hljs-doctag">@link</span> #configure(SecurityBuilder)&#125; method uses</span><br><span class="hljs-comment">	 * the correct shared objects when building. Configurers should be applied here.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> builder</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Configure the &#123;<span class="hljs-doctag">@link</span> SecurityBuilder&#125; by setting the necessary properties on the</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> SecurityBuilder&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> builder</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, <strong>SecurityConfigurer</strong>åªæœ‰ä¸¤ä¸ªæ–¹æ³•: <strong>init</strong>å’Œ<strong>configure</strong>, ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯<strong>SecurityBuilder</strong>å¯¹è±¡, ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å¯¹<strong>SecurityBuilder</strong>è¿›è¡Œåˆå§‹è¯å’Œé…ç½®.</p>
<p>â€‹	<strong>SecurityConfigurer</strong>çš„å­ç±»éå¸¸å¤š, å› ä¸ºæ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰è‡ªå·±å¯¹åº”çš„<strong>xxxConfigurer</strong>, è¿™é‡Œç€é‡ä»‹ç»å‡ ä¸ªå…³é”®çš„å®ç°ç±», å¦‚å›¾æ‰€ç¤º:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230312213646207.png" srcset="/img/loading.gif" lazyload alt="image-20230312213646207"></p>
<p>æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹å®ç°:</p>
<h4 id="SecurityConfigurerAdapter"><a href="#SecurityConfigurerAdapter" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h4><p>â€‹	å®ç°äº†<strong>SecurityConfigurer</strong>æ¥å£, è¿ç”¨äº†é€‚é…å™¨æ¨¡å¼, å®ƒçš„æºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt; &#123;<br>  <br>  <span class="hljs-comment">//1. æä¾›äº†ä¸€ä¸ªSecurityBuilderå¯¹è±¡, ä¸ºæ¯ä¸€ä¸ªé…ç½®ç±»éƒ½æä¾›äº†ä¸€ä¸ªSecurityBuilderå¯¹è±¡, å°†æ¥é€šè¿‡SecurityBuilderæ„å»ºå‡ºå…·ä½“çš„é…ç½®å¯¹è±¡; é€šè¿‡andæ–¹æ³•è¿”å›SecurityBuilderå¯¹è±¡, è¿™æ ·æ–¹ä¾¿ä¸åŒçš„é…ç½®ç±»åœ¨é…ç½®æ—¶, å¯ä»¥è¿›è¡Œé“¾å¼é…ç½®</span><br>  <span class="hljs-keyword">private</span> B securityBuilder;<br><br>  <span class="hljs-comment">//2. å®šä¹‰äº†å†…éƒ¨ç±»CompositeObjectPostProcessor, è¿™æ˜¯ä¸€ä¸ªå¤åˆçš„å¯¹è±¡åç½®å¤„ç†å™¨</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">CompositeObjectPostProcessor</span> <span class="hljs-variable">objectPostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompositeObjectPostProcessor</span>();<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> B <span class="hljs-title function_">and</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> getBuilder();<br>	&#125;<br>  <br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> B <span class="hljs-title function_">getBuilder</span><span class="hljs-params">()</span> &#123;<br>		Assert.state(<span class="hljs-built_in">this</span>.securityBuilder != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;securityBuilder cannot be null&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.securityBuilder;<br>	&#125;<br>  <br>  <span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">postProcess</span><span class="hljs-params">(T object)</span> &#123;<br>		<span class="hljs-keyword">return</span> (T) <span class="hljs-built_in">this</span>.objectPostProcessor.postProcess(object);<br>	&#125;<br>  <br>  <span class="hljs-comment">//3. æä¾›äº†ä¸€ä¸ªaddObjectPostProcessoræ–¹æ³•, é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥åƒå¤åˆçš„å¯¹è±¡åç½®å¤„ç†å™¨ä¸­æ·»åŠ æ–°çš„ObjectPostProcessorå®ä¾‹</span><br>    ç”¨æ­¤æ–¹æ³•åˆ™å¯ä»¥å°†è‡ªå®šä¹‰çš„ObjectPostProcessoræ·»åŠ åˆ°ç»´æŠ¤çš„å¤åˆå¯¹è±¡åç½®å¤„ç†å™¨ä¸­, è¾¾åˆ°è‡ªå®šä¹‰ObjectPostProcessorå¤„ç†é€»è¾‘çš„ç›®çš„<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObjectPostProcessor</span><span class="hljs-params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;<br>		<span class="hljs-built_in">this</span>.objectPostProcessor.addObjectPostProcessor(objectPostProcessor);<br>	&#125;<br>  <br>  	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBuilder</span><span class="hljs-params">(B builder)</span> &#123;<br>		<span class="hljs-built_in">this</span>.securityBuilder = builder;<br>	&#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeObjectPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;Object&gt; &#123;<br><br>		<span class="hljs-keyword">private</span> List&lt;ObjectPostProcessor&lt;?&gt;&gt; postProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span><br>		<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcess</span><span class="hljs-params">(Object object)</span> &#123;<br>			<span class="hljs-keyword">for</span> (ObjectPostProcessor opp : <span class="hljs-built_in">this</span>.postProcessors) &#123;<br>				Class&lt;?&gt; oppClass = opp.getClass();<br>				Class&lt;?&gt; oppType = GenericTypeResolver.resolveTypeArgument(oppClass, ObjectPostProcessor.class);<br>				<span class="hljs-keyword">if</span> (oppType == <span class="hljs-literal">null</span> || oppType.isAssignableFrom(object.getClass())) &#123;<br>					object = opp.postProcess(object);<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">return</span> object;<br>		&#125;<br><br>		<br>		<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addObjectPostProcessor</span><span class="hljs-params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;<br>			<span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.postProcessors.add(objectPostProcessor);<br>			<span class="hljs-built_in">this</span>.postProcessors.sort(AnnotationAwareOrderComparator.INSTANCE);<br>			<span class="hljs-keyword">return</span> result;<br>		&#125;<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><span style="color:red;">æ€»è€Œè¨€ä¹‹: <strong>SecurityConfigureAdapter</strong>ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼å°†<strong>SecurityBuilder</strong>ã€å¤åˆå¯¹è±¡åç½®å¤„ç†å™¨<strong>CompositeObjectPostProcessor</strong>å¼•å…¥, å¹¶å¼•å…¥äº†æ·»åŠ å¯¹è±¡åç½®å¤„ç†å™¨çš„æ–¹æ³•</span></p>
<h4 id="AbstractHttpConfigurer"><a href="#AbstractHttpConfigurer" class="headerlink" title="AbstractHttpConfigurer"></a>AbstractHttpConfigurer</h4><p>â€‹	<strong>AbstractHttpConfigurer</strong>ä¸»è¦æ˜¯ä¸ºäº†ç»™åœ¨<strong>HttpSecurity</strong>ä¸­ä½¿ç”¨çš„é…ç½®ç±»æ·»åŠ ä¸€ä¸ªæ–¹ä¾¿çš„çˆ¶ç±», æå–å‡ºå…±åŒçš„æ“ä½œ.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractHttpConfigurer</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHttpConfigurer</span>&lt;T, B&gt;, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpSecurityBuilder</span>&lt;B&gt;&gt;<br>		<span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, B&gt; &#123;<br>  <br>  <span class="hljs-keyword">public</span> B <span class="hljs-title function_">disable</span><span class="hljs-params">()</span> &#123;<br>		getBuilder().removeConfigurer(getClass());<br>		<span class="hljs-keyword">return</span> getBuilder();<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">withObjectPostProcessor</span><span class="hljs-params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;<br>		addObjectPostProcessor(objectPostProcessor);<br>		<span class="hljs-keyword">return</span> (T) <span class="hljs-built_in">this</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, æå–å‡ºæ¥çš„æ–¹æ³•å…¶å®å°±ä¸¤ä¸ª: ä¸€ä¸ª<strong>disable</strong>è¡¨ç¤ºç¦ç”¨æŸä¸ªé…ç½®(æ¯”å¦‚æˆ‘ä»¬é…ç½®çš„<strong>csrf().disable()</strong>), æœ¬è´¨å°±æ˜¯ä»<strong>AbstractConfiguredSecurityBuilder</strong>çš„<strong>configurers</strong>é›†åˆä¸­ç§»é™¤æŸä¸ªé…ç½®ç±», è¿™æ ·åœ¨å°†æ¥æ„å»ºçš„æ—¶å€™å°±ä¸å­˜åœ¨è¯¥é…ç½®ç±», é‚£ä¹ˆå¯¹åº”çš„åŠŸèƒ½ä¹Ÿå°±ä¸å­˜åœ¨(è¢«ç¦ç”¨); å¦ä¸€ä¸ª<strong>withObjectPostProcessor</strong>è¡¨ç¤ºç»™æŸä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€ä¸ªå¯¹è±¡åç½®å¤„ç†å™¨, ç”±äºè¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯å½“å‰å¯¹è±¡, æ‰€æœ‰è¯¥æ–¹æ³•å¯ä»¥ç”¨æ¥åœ¨é“¾å¼é…ç½®ä¸­.</p>
<p>â€‹	<strong>AbstractHttpConfigurer</strong>çš„å®ç°ç±»æ¯”è¾ƒå¤š, åŸºæœ¬ä¸Šéƒ½ç”¨æ¥é…ç½®å„ç§å„æ ·çš„è¿‡æ»¤å™¨, å¦‚å›¾æ‰€ç¤º:</p>
<img src="/2022/01/26/SpringSecurity/image-20230313214804744.png" srcset="/img/loading.gif" lazyload alt="image-20230313214804744" style="zoom:50%;">





<h4 id="UserDetailsAwareConfigurer"><a href="#UserDetailsAwareConfigurer" class="headerlink" title="UserDetailsAwareConfigurer"></a>UserDetailsAwareConfigurer</h4><p>â€‹	<strong>UserDetailsAwareConfigurer</strong>çš„å­ç±»ä¸»è¦è´Ÿè´£é…ç½®ç”¨æˆ·è®¤è¯ç›¸å…³çš„ç»„ä»¶, å¦‚: <strong>UserDetails</strong>ç­‰, <strong>UserDetailsAwareConfigurer</strong>ä¸­æä¾›äº†è·å–<strong>UserDetailsService</strong>çš„æŠ½è±¡æ–¹æ³•, å…·ä½“å®ç°åˆ™åœ¨å®ƒçš„å­ç±»ä¸­, <strong>UserDetailsAwareConfigurer</strong>çš„å­ç±»å¦‚åŒæ‰€ç¤º:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230312220109915.png" srcset="/img/loading.gif" lazyload alt="image-20230312220109915"></p>
<ul>
<li><strong>AbstractDaoAuthenticationConfigurer</strong>: å®Œæˆå¯¹<strong>DaoAuthenticationProvider</strong>çš„é…ç½®</li>
<li><strong>UserDetailsServiceConfigurer</strong>: å®Œæˆå¯¹<strong>UserDetailsService</strong>çš„é…ç½®</li>
<li><strong>UserDetailsManagerConfigurer</strong>: ä½¿ç”¨<strong>UserDetailsManager</strong>æ„å»ºç”¨æˆ·å¯¹è±¡, å®Œæˆå¯¹<strong>AuthenticationManagerBuilder</strong>çš„å¡«å……</li>
<li><strong>JdbcUserDetailsManagerConfigurer</strong>: é…ç½®<strong>JdbcUserDetailsManager</strong>å¹¶å¡«å……åˆ°<strong>AuthenticationManagerBuilder</strong>ä¸­</li>
<li><strong>InMemoryUserDetailsManagerConfigurer</strong>: é…ç½®<strong>InMemoryUserDetailsManager</strong></li>
<li><strong>DaoAuthenticationConfigurer</strong>: å®Œæˆå¯¹<strong>DaoAuthenticationProvider</strong>çš„é…ç½®</li>
</ul>
<h3 id="4-1-4-SecurityFilterChainè¿‡æ»¤å™¨é“¾"><a href="#4-1-4-SecurityFilterChainè¿‡æ»¤å™¨é“¾" class="headerlink" title="4.1.4 SecurityFilterChainè¿‡æ»¤å™¨é“¾"></a>4.1.4 SecurityFilterChainè¿‡æ»¤å™¨é“¾</h3><p> å…ˆè¯´åˆ°<strong>HttpSecurity</strong>ç±»ä¹‹å‰, ä¸€å®šè¦å…ˆè¯´ä¸‹<strong>HttpSecurity</strong>åˆ›å»ºçš„è¿‡æ»¤å™¨é“¾å¯¹è±¡.ä»åç§°ä¸Šå¯ä»¥çœ‹å‡º, <span style="color:red;"><strong>SecurityFilterChain</strong>å°±æ˜¯Spring Securityä¸­çš„è¿‡æ»¤å™¨é“¾å¯¹è±¡.</span> ä¸‹é¢æ¥çœ‹ä¸€ä¸‹<strong>SecurityFilterChain</strong>çš„æºç :</p>
<img src="/2022/01/26/SpringSecurity/image-20230215232503921.png" srcset="/img/loading.gif" lazyload alt="image-20230215232503921" style="zoom:50%;">

<p>å¯ä»¥çœ‹åˆ°, <strong>SecurityFilterChain</strong>ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•:</p>
<ol>
<li><strong>matches</strong>: è¯¥æ–¹æ³•ç”¨æ¥åˆ¤æ–­requestè¯·æ±‚æ˜¯å¦åº”è¯¥è¢«å½“å‰è¿‡æ»¤å™¨é“¾æ‰€å¤„ç†</li>
<li><strong>getFilters</strong>: è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªListé›†åˆ, é›†åˆä¸­å­˜æ”¾çš„å°±æ˜¯Spring Securityä¸­çš„è¿‡æ»¤å™¨.æ¢è¨€ä¹‹, å¦‚æœmatchesæ–¹æ³•è¿”å›true, é‚£ä¹ˆrequestè¯·æ±‚å°±ä¼šåœ¨getFiltersæ–¹æ³•æ‰€è¿”å›çš„Filteré›†åˆä¸­è¢«å¤„ç†</li>
</ol>
<p>â€‹	 <strong>SecurityFilterChain</strong>åªæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±»å°±æ˜¯<strong>DefaultSecurityFilterChain</strong>, è¿™ä¹Ÿæ˜¯<strong>HttpSecurity</strong>æ„å»ºçš„å¯¹è±¡, å…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªå±æ€§, å¹¶å…·ä½“å®ç°äº†<strong>SecurityFilterChain</strong>ä¸­çš„ä¸¤ä¸ªæ–¹æ³•:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215233159036.png" srcset="/img/loading.gif" lazyload alt="image-20230215233159036" style="zoom:50%;">

<p>â€‹	å¯ä»¥çœ‹åˆ°, åœ¨<strong>DefaultSecurityFilterChain</strong>çš„æ„é€ æ–¹æ³•ä¸­, éœ€è¦ä¼ å…¥ä¸¤ä¸ªå¯¹è±¡, ä¸€ä¸ªæ˜¯è¯·æ±‚åŒ¹é…å™¨<strong>requestMatcher</strong>, å¦ä¸€ä¸ªåˆ™æ˜¯è¿‡æ»¤å™¨é›†åˆæˆ–è€…è¿‡æ»¤å™¨æ•°ç»„filter. è¿™ä¸ªå®ç°ç±»æ¯”è¾ƒç®€å•, è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†</p>
<p>â€‹	<span style="color:red;">æ³¨æ„:  åœ¨ä¸€ä¸ªSpring Securityé¡¹ç›®ä¸­, <strong>SecurityFilterChain</strong>çš„å®ä¾‹å¯èƒ½ä¼šæœ‰å¤šä¸ª.</span></p>
<h3 id="4-1-5-HttpSecurityå†…å¹•"><a href="#4-1-5-HttpSecurityå†…å¹•" class="headerlink" title="4.1.5 HttpSecurityå†…å¹•"></a>4.1.5 HttpSecurityå†…å¹•</h3><p>â€‹	åœ¨äº†è§£äº†HttpSecurityçš„ä¸»è¦ç›¸å…³ç±»å, å¯ä»¥é€šè¿‡æ­¤å›¾çœ‹å‡ºä¸»ä½“æ¶æ„:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230718154226258.png" srcset="/img/loading.gif" lazyload alt="image-20230718154226258"></p>
<p>â€‹	<span style="color:red;"><strong>HttpSecurity</strong>çš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥æ„å»ºä¸€æ¡è¿‡æ»¤å™¨é“¾, å¹¶åæ˜ åˆ°ä»£ç ä¸Š,ä¹Ÿå°±æ˜¯æ„å»ºä¸€ä¸ª<strong>DefaultSecurityFilterChain</strong>å¯¹è±¡. </span>ä¸€ä¸ª<strong>DefaultSecurityChain</strong>å¯¹è±¡åŒ…å«ä¸€ä¸ªè·¯å¾„åŒ¹é…å™¨å’Œå¤šä¸ª<strong>SpringSecurity</strong>è¿‡æ»¤å™¨, <strong>HttpSecurity</strong>ä¸­é€šè¿‡æ”¶é›†å„ç§å„æ ·çš„<strong>xxxConfigurer,</strong> å°†<strong>Spring Security</strong>è¿‡æ»¤å™¨å¯¹åº”çš„é…ç½®ç±»æ”¶é›†èµ·æ¥, å¹¶ä¿å­˜åˆ°çˆ¶ç±»<strong>AbstractConfiguredSecurityBuilder</strong>çš„<strong>configurers</strong>å˜é‡ä¸­, åœ¨åç»­çš„æ„å»ºè¿‡ç¨‹ä¸­, å†å°†è¿™äº›<strong>xxxConfigurer</strong>æ„å»ºä¸ºå…·ä½“çš„<strong>Spring Security</strong>çš„è¿‡æ»¤å™¨,  åŒæ—¶æ·»åŠ åˆ°<strong>HttpSecurity</strong>çš„<strong>filters</strong>å¯¹è±¡ä¸­.</p>
<p>â€‹	å…¶ä¸­<strong>HttpSecurityBuilder</strong>æ¥å£æ˜¯ç”¨æ¥æ„å»º<strong>HttpSecurity</strong>å¯¹è±¡çš„, <strong>HttpSecurityBuilder</strong>çš„å®šä¹‰å¦‚ä¸‹:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215234757406.png" srcset="/img/loading.gif" lazyload alt="image-20230215234757406" style="zoom:50%;">

<p>æˆ‘ä»¬æ¥ç®€å•åˆ†æä¸‹è¿™æ®µæºç :</p>
<ol>
<li><strong>HttpSecurityBuilder</strong>å¯¹è±¡æœ¬èº«åœ¨å®šä¹‰æ—¶å°±æœ‰ä¸€ä¸ªæ³›å‹, è¿™ä¸ªæ³›å‹æ˜¯<strong>HttpSecurityBuilder</strong>çš„å­ç±», ç”±äºé»˜è®¤æƒ…å†µä¸‹<strong>HttpSecurityBuilder</strong>çš„å®ç°ç±»åªæœ‰ä¸€ä¸ª<strong>HttpSecurity</strong>, æ‰€ä»¥å¯ä»¥æš‚ä¸”æŠŠæ¥å£ä¸­çš„Héƒ½å½“æˆ<strong>HttpSecurity</strong>æ¥ç†è§£</li>
<li><strong>HttpSecurityBuilder</strong>ç»§æ‰¿è‡ª<strong>SecurityBuilder</strong>æ¥å£, åŒæ—¶ä¹ŸæŒ‡å®šäº†<strong>SecurityBuilder</strong>ä¸­çš„æ³›å‹ä¸º<strong>DefaultSecurityFilterChain</strong>, ä¹Ÿå°±æ˜¯è¯´,<strong>HttpSecurityBuilder</strong>æœ€ç»ˆæƒ³è¦æ„å»ºçš„å¯¹è±¡æ˜¯<strong>DefaultSecurityFilterChain</strong></li>
<li><strong>getConfigurer</strong>æ–¹æ³•ç”¨æ¥è·å–ä¸€ä¸ªé…ç½®å™¨, æ‰€è°“çš„é…ç½®å™¨å°±æ˜¯<strong>xxxConfigurer</strong></li>
<li><strong>removeConfigurer</strong>æ–¹æ³•ç”¨æ¥ç§»é™¤ä¸€ä¸ªé…ç½®å™¨(ç›¸å½“äºä»Spring Securityè¿‡æ»¤å™¨é“¾ä¸­ç§»é™¤ä¸€ä¸ªè¿‡æ»¤å™¨)</li>
<li><strong>setSharedObject</strong> &#x2F; <strong>getSharedObject</strong>è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨æ¥è®¾ç½®æˆ–è€…è·å–ä¸€ä¸ªå¯ä»¥åœ¨å¤šé…ç½®å™¨ä¹‹é—´å…±äº«çš„å¯¹è±¡</li>
<li><strong>authenticationProvider</strong>æ–¹æ³•å¯ä»¥ç”¨æ¥é…ç½®ä¸€ä¸ªè®¤è¯å™¨<strong>AuthencationProvider</strong></li>
<li><strong>userDetailsService</strong>æ–¹æ³•å¯ä»¥ç”¨æ¥é…ç½®ä¸€ä¸ªæ•°æ®æº<strong>UserDetailsService</strong></li>
<li><strong>addFilterAfter</strong>&#x2F;<strong>addFilterBefore</strong>æ–¹æ³•è¡¨ç¤ºåœ¨æŸä¸ªè¿‡æ»¤å™¨ä¹‹åæˆ–è€…ä¹‹å‰æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨</li>
<li><strong>addFilter</strong>æ–¹æ³•å¯ä»¥æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨, è¿™ä¸ªè¿‡æ»¤å™¨å¿…é¡»æ˜¯Spring Securityæ¡†æ¶æä¾›çš„è¿‡æ»¤å™¨çš„ä¸€ä¸ªå®ä¾‹æˆ–è€…å…¶æ‰©å±•, æ·»åŠ å®Œæˆä¹‹å, ä¼šè‡ªåŠ¨è¿›è¡Œè¿‡æ»¤å™¨çš„æ’åº</li>
</ol>
<p>â€‹	ç”±äº<strong>HttpSecurity</strong>ä¸­å­˜åœ¨å¤§é‡åŠŸèƒ½ç±»ä¼¼çš„æ–¹æ³•, å› æ­¤è¿™é‡ŒæŒ‘é€‰ä¸€ä¸ªä½œä¸ºä¾‹å­æ¥è¯´æ˜<strong>HttpSecurity</strong>çš„é…ç½®åŸç†, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpSecurity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;<br>		<span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt;, HttpSecurityBuilder&lt;HttpSecurity&gt; &#123;<br>  <br>  <span class="hljs-comment">//1. ä»¥formè¡¨å•ç™»å½•é…ç½®ä¸ºä¾‹, åœ¨HttpSecurityä¸­æœ‰ä¸¤ä¸ªé‡è½½æ–¹æ³•å¯ä»¥è¿›è¡Œé…ç½®: ç¬¬ä¸€ä¸ªæ˜¯ä¸€ä¸ªæ— å‚, è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªFormLoginConfigurer&lt;HttpSecurity&gt;å¯¹è±¡</span><br>    å¼€å‘è€…å¯ä»¥åœ¨è¯¥å¯¹è±¡çš„åŸºç¡€ä¸Šç»§ç»­å®Œå–„å¯¹formè¡¨å•çš„é…ç½®, æˆ‘ä»¬åœ¨åç»­ä¸­é…ç½®çš„è¡¨å•ç™»å½•éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥è¿›è¡Œé…ç½®çš„.<br>  <span class="hljs-keyword">public</span> FormLoginConfigurer&lt;HttpSecurity&gt; <span class="hljs-title function_">formLogin</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">return</span> getOrApply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FormLoginConfigurer</span>&lt;&gt;());<br>	&#125;<br>  <br>  <span class="hljs-comment">//ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªæœ‰å‚çš„formLoginæ–¹æ³•, è¯¥æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªFormLoginConfigurerå¯¹è±¡, è¿”å›å€¼åˆ™æ˜¯ä¸€ä¸ªHttpSecurityå¯¹è±¡, ä¹Ÿå°±æ˜¯è¯´å¼€å‘è€…å¯ä»¥æå‰åœ¨å¤–é¢é…ç½®å¥½FormLoginConfigurerå¯¹è±¡, ç„¶åç›´æ¥ä¼ è¿›æ¥è¿›è¡Œé…ç½®å³å¯, è¿”å›å€¼HttpSecurityå¯¹è±¡åˆ™å¯ä»¥åœ¨æ–¹æ³•è¿”å›åç›´æ¥è¿›è¡Œå…¶ä»–è¿‡æ»¤å™¨çš„é…ç½®. </span><br>    æ— è®ºæ˜¯æœ‰å‚æˆ–è€…æ— å‚, æœ€ç»ˆéƒ½ä¼šè°ƒç”¨getOrApplyæ–¹æ³•, è¯¥æ–¹æ³•ä¼šè°ƒç”¨çˆ¶ç±»çš„getConfigureræ–¹æ³•å»æŸ¥çœ‹æ˜¯å¦å·²ç»æœ‰å¯¹åº”çš„é…ç½®ç±»äº†,å¦‚æœæœ‰,åˆ™ç›´æ¥è¿”å›; å¦‚æœæ²¡æœ‰,åˆ™è°ƒç”¨applyæ–¹æ³•æ·»åŠ åˆ°çˆ¶ç±»çš„configurerså˜é‡ä¸­. HttpSecurityä¸­å…¶ä»–è¿‡æ»¤å™¨çš„é…ç½®éƒ½å’Œformè¡¨å•ç™»å½•é…ç½®ç±»ä¼¼, è¿™é‡Œå°±ä¸èµ˜è¿°äº†<br>  <span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">formLogin</span><span class="hljs-params">(Customizer&lt;FormLoginConfigurer&lt;HttpSecurity&gt;&gt; formLoginCustomizer)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		formLoginCustomizer.customize(getOrApply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FormLoginConfigurer</span>&lt;&gt;()));<br>		<span class="hljs-keyword">return</span> HttpSecurity.<span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-comment">//2. æ¯ä¸€å¥—è¿‡æ»¤å™¨é“¾éƒ½ä¼šæœ‰ä¸€ä¸ªAuthenticationManagerå¯¹è±¡æ¥è¿›è¡Œè®¤è¯æ“ä½œ(å¦‚æœè®¤è¯å¤±è´¥,å°±ä¼šè°ƒç”¨AuthenticationManagerçš„parentå†æ¬¡è¿›è¡Œè®¤è¯),ä¸»è¦æ˜¯é€šè¿‡è¿™ä¸ªauthenticationProvideræ–¹æ³•é…ç½®æ‰§è¡Œè®¤è¯çš„authenticationProviderå¯¹è±¡</span><br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">authenticationProvider</span><span class="hljs-params">(AuthenticationProvider authenticationProvider)</span> &#123;<br>		getAuthenticationRegistry().authenticationProvider(authenticationProvider);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-comment">//é€šè¿‡userDetailsServiceæ–¹æ³•é…ç½®UserDetailsService</span><br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		getAuthenticationRegistry().userDetailsService(userDetailsService);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-keyword">private</span> AuthenticationManagerBuilder <span class="hljs-title function_">getAuthenticationRegistry</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> getSharedObject(AuthenticationManagerBuilder.class);<br>	&#125;<br>  <br>  <span class="hljs-comment">//æœ€ååœ¨beforeConfigureræ–¹æ³•ä¸­è§¦å‘AuthenticationManagerå¯¹è±¡çš„æ„å»º.</span><br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeConfigure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		setSharedObject(AuthenticationManager.class, getAuthenticationRegistry().build());<br>	&#125;<br><br>  <span class="hljs-comment">//3. performBuildæ–¹æ³•åˆ™æ˜¯è¿›è¡ŒDefalutSecurityFilterChainå¯¹è±¡çš„æ„å»º, ä¼ å…¥è¯·æ±‚åŒ¹é…å™¨å’Œè¿‡æ»¤å™¨é›†åˆfilters, åœ¨æ„å»ºä¹‹å‰, ä¼šå…ˆæŒ‰ç…§æ—¢å®šçš„é¡ºåºå¯¹filtersè¿›è¡Œæ’åº</span><br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> DefaultSecurityFilterChain <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> &#123;<br>		ExpressionUrlAuthorizationConfigurer&lt;?&gt; expressionConfigurer = getConfigurer(<br>				ExpressionUrlAuthorizationConfigurer.class);<br>		AuthorizeHttpRequestsConfigurer&lt;?&gt; httpConfigurer = getConfigurer(AuthorizeHttpRequestsConfigurer.class);<br>		<span class="hljs-type">boolean</span> <span class="hljs-variable">oneConfigurerPresent</span> <span class="hljs-operator">=</span> expressionConfigurer == <span class="hljs-literal">null</span> ^ httpConfigurer == <span class="hljs-literal">null</span>;<br>		Assert.state((expressionConfigurer == <span class="hljs-literal">null</span> &amp;&amp; httpConfigurer == <span class="hljs-literal">null</span>) || oneConfigurerPresent,<br>				<span class="hljs-string">&quot;authorizeHttpRequests cannot be used in conjunction with authorizeRequests. Please select just one.&quot;</span>);<br>		<span class="hljs-built_in">this</span>.filters.sort(OrderComparator.INSTANCE);<br>		List&lt;Filter&gt; sortedFilters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.filters.size());<br>		<span class="hljs-keyword">for</span> (Filter filter : <span class="hljs-built_in">this</span>.filters) &#123;<br>			sortedFilters.add(((OrderedFilter) filter).filter);<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span>(<span class="hljs-built_in">this</span>.requestMatcher, sortedFilters);<br>	&#125;<br>  <br>  <br>  <span class="hljs-comment">//4. é€šè¿‡addFilterã€addFilterBeforeä¸¤ä¸ªæ–¹æ³•, æˆ‘ä»¬å¯ä»¥åœ¨æŸä¸ªè¿‡æ»¤å™¨ä¹‹åæˆ–è€…ä¹‹å‰æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨</span><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">addFilterBefore</span><span class="hljs-params">(Filter filter, Class&lt;? extends Filter&gt; beforeFilter)</span> &#123;<br>		<span class="hljs-built_in">this</span>.comparator.registerBefore(filter.getClass(), beforeFilter);<br>		<span class="hljs-keyword">return</span> addFilter(filter);<br>	&#125;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">addFilter</span><span class="hljs-params">(Filter filter)</span> &#123;<br>		Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Filter</span>&gt; filterClass = filter.getClass();<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.comparator.isRegistered(filterClass)) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;The Filter class &quot;</span> + filterClass.getName()<br>					+ <span class="hljs-string">&quot; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&quot;</span>);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.filters.add(filter);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-comment">//5.addFilterAtæ–¹æ³•å¯ä»¥åœ¨æŒ‡å®šçš„ä½ç½®æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨. éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨åŒä¸€ä¸ªä½ç½®æ·»åŠ å¤šä¸ªè¿‡æ»¤å™¨ä¸ä¼šè¦†ç›–ç°æœ‰çš„è¿‡æ»¤å™¨</span><br>  <span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">addFilterAt</span><span class="hljs-params">(Filter filter, Class&lt;? extends Filter&gt; atFilter)</span> &#123;<br>		<span class="hljs-built_in">this</span>.comparator.registerAt(filter.getClass(), atFilter);<br>		<span class="hljs-keyword">return</span> addFilter(filter);<br>	&#125;<br>  <br>  <span class="hljs-keyword">private</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;&gt; C <span class="hljs-title function_">getOrApply</span><span class="hljs-params">(C configurer)</span><br>			<span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-type">C</span> <span class="hljs-variable">existingConfig</span> <span class="hljs-operator">=</span> (C) getConfigurer(configurer.getClass());<br>		<span class="hljs-keyword">if</span> (existingConfig != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> existingConfig;<br>		&#125;<br>		<span class="hljs-keyword">return</span> apply(configurer);<br>	&#125;<br></code></pre></td></tr></table></figure>



<p>è¿™å°±æ˜¯HttpSecurityåŸºæœ¬çš„åŠŸèƒ½</p>
<h3 id="4-1-6-WebSecurityå†…å¹•"><a href="#4-1-6-WebSecurityå†…å¹•" class="headerlink" title="4.1.6 WebSecurityå†…å¹•"></a>4.1.6 WebSecurityå†…å¹•</h3><p>â€‹	å†è®²åˆ°<strong>WebSecurity</strong>ç±», ç›¸å¯¹äº<strong>HttpSecurity</strong>,  <strong>WebSecurity</strong>æ˜¯åœ¨ä¸€ä¸ªæ›´å¤§çš„å±‚é¢ä¸Šå»æ„å»ºè¿‡æ»¤å™¨. ä¸€ä¸ª<strong>HttpSecurity</strong>å¯¹è±¡å¯ä»¥æ„å»ºä¸€ä¸ªè¿‡æ»¤å™¨é“¾, ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª<strong>DefaultSecurityFilterChain</strong>å¯¹è±¡,è€Œä¸€ä¸ªé¡¹ç›®ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ª<strong>HttpSecurity</strong>å¯¹è±¡, ä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ„å»ºå¤šä¸ª<strong>DefaultSecurityFilterChain</strong>è¿‡æ»¤å™¨é“¾</p>
<p>â€‹	<span style="color:red;">è€Œ<strong>WebSecurity</strong>è´Ÿè´£å°†<strong>HttpSecurity</strong>æ‰€æ„å»ºçš„<strong>DefaultSecurityFilterChain</strong>å¯¹è±¡(å¯èƒ½æœ‰å¤šä¸ª), ä»¥åŠå…¶ä»–éœ€è¦å¿½ç•¥çš„è¯·æ±‚, å†æ¬¡é‡æ–°æ„å»ºä¸ºä¸€æ¬¡<strong>FilterChainProxy</strong>å¯¹è±¡, åŒæ—¶æ·»åŠ ä¸ŠHTTPé˜²ç«å¢™</span></p>
<p>â€‹	æˆ‘ä»¬æ¥çœ‹ä¸‹<strong>WebSecurity</strong>ä¸­çš„å‡ ä¸ªå…³é”®æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;Filter, WebSecurity&gt;<br>		<span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;Filter&gt;, ApplicationContextAware &#123;<br>  <br>  	<span class="hljs-comment">//1. é¦–å…ˆåœ¨WebSecurityä¸­å£°æ˜äº†ignoredRequestsé›†åˆ, è¿™ä¸ªé›†åˆä¸­ä¿å­˜äº†æ‰€æœ‰è¢«å¿½ç•¥çš„è¯·æ±‚, å› ä¸ºåœ¨å®é™…çš„é¡¹ç›®ä¸­, å¹¶éæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡Spring Securityè¿‡æ»¤å™¨é“¾, æœ‰ä¸€äº›é™æ€èµ„æºå¯èƒ½ä¸éœ€è¦æƒé™è®¤è¯, ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯å³å¯, é‚£ä¹ˆè¿™äº›éœ€è¦å¿½ç•¥çš„è¯·æ±‚å¯ä»¥ç›´æ¥ä¿å­˜åœ¨ignoredRequestså˜é‡ä¸­</span><br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;RequestMatcher&gt; ignoredRequests = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>  	<span class="hljs-comment">//2. æ¥ä¸‹æ¥å£°æ˜äº†ä¸ªsecurityFilterChainBuildersé›†åˆ, è¯¥é›†åˆç”¨æ¥ä¿å­˜æ‰€æœ‰çš„HttpSecurityå¯¹è±¡, æ¯ä¸€ä¸ªHttpSecurityå¯¹è±¡åˆ›å»ºæˆåŠŸä¹‹å, é€šè¿‡addSecurityFilterChainBuilderæ–¹æ³•å°†HttpSecurityå¯¹è±¡æ·»åŠ åˆ°securityFilterChainBuildersä¸­</span><br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;SecurityBuilder&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityFilterChain</span>&gt;&gt; securityFilterChainBuilders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  <br>  	<span class="hljs-comment">//3. httpFirewallæ–¹æ³•å¯ä»¥ç”¨æ¥é…ç½®è¯·æ±‚é˜²ç«å¢™</span><br>  <span class="hljs-keyword">public</span> WebSecurity <span class="hljs-title function_">httpFirewall</span><span class="hljs-params">(HttpFirewall httpFirewall)</span> &#123;<br>		<span class="hljs-built_in">this</span>.httpFirewall = httpFirewall;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> WebSecurity <span class="hljs-title function_">addSecurityFilterChainBuilder</span><span class="hljs-params">(</span><br><span class="hljs-params">			SecurityBuilder&lt;? extends SecurityFilterChain&gt; securityFilterChainBuilder)</span> &#123;<br>		<span class="hljs-built_in">this</span>.securityFilterChainBuilders.add(securityFilterChainBuilder);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <br>  <span class="hljs-comment">//4. æ˜¯å…·ä½“çš„æ„é€ æ–¹æ³•, åœ¨è¯¥æ–¹æ³•ä¸­, é¦–å…ˆç»Ÿè®¡å‡ºè¿‡æ»¤å™¨é“¾çš„æ€»æ•°(è¢«å¿½ç•¥çš„è¯·æ±‚ä¸ªæ•°+é€šè¿‡HttpSecurityåˆ›å»ºå‡ºæ¥çš„è¿‡æ»¤å™¨é“¾ä¸ªæ•°),ç„¶ååˆ›å»ºä¸€ä¸ªé›†åˆsecurityFilterChains, éå†è¢«å¿½ç•¥çš„è¯·æ±‚å¹¶åˆ†åˆ«æ„å»ºæˆDefaultSecurityFilterChainå¯¹è±¡ä¿å­˜åœ¨securityFilterChainsé›†åˆä¸­. éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹äºè¢«å¿½ç•¥çš„è¯·æ±‚,åœ¨æ„å»ºDefaultSecurityFilterChainå¯¹è±¡æ—¶,åªæ˜¯ä¼ äº†è¯·æ±‚åŒ¹é…å™¨, è€Œæ²¡æœ‰ä¼ å…¥å¯¹åº”çš„è¿‡æ»¤å™¨é“¾, è¿™å°±æ„å‘³ç€è¿™äº›è¢«å¿½ç•¥æ‰çš„è¯·æ±‚, å°†æ¥ä¸å¿…ç»è¿‡SpringSecurityè¿‡æ»¤å™¨é“¾; æ¥ä¸‹æ¥å†éå†securityFilterChainBuildersé›†åˆ, è°ƒç”¨æ¯ä¸ªå¯¹è±¡çš„buildæ–¹æ³•å»åˆ›å»ºDefaultFilterChainå¹¶å­˜å…¥securityFilterChainsé›†åˆä¸­, ç„¶åä¼ å…¥securityFilterChainsé›†åˆæ„å»ºFilterChainProxyå¯¹è±¡,æœ€åå†è®¾ç½®HTTPé˜²ç«å¢™. æ‰€æœ‰è®¾ç½®å®Œæˆä¹‹å,æœ€åè¿”å›filterChainProxyå¯¹è±¡</span><br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> Filter <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		Assert.state(!<span class="hljs-built_in">this</span>.securityFilterChainBuilders.isEmpty(),<br>				() -&gt; <span class="hljs-string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span><br>						+ <span class="hljs-string">&quot;Typically this is done by exposing a SecurityFilterChain bean &quot;</span><br>						+ <span class="hljs-string">&quot;or by adding a @Configuration that extends WebSecurityConfigurerAdapter. &quot;</span><br>						+ <span class="hljs-string">&quot;More advanced users can invoke &quot;</span> + WebSecurity.class.getSimpleName()<br>						+ <span class="hljs-string">&quot;.addSecurityFilterChainBuilder directly&quot;</span>);<br>		<span class="hljs-type">int</span> <span class="hljs-variable">chainSize</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.ignoredRequests.size() + <span class="hljs-built_in">this</span>.securityFilterChainBuilders.size();<br>		List&lt;SecurityFilterChain&gt; securityFilterChains = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(chainSize);<br>		<span class="hljs-keyword">for</span> (RequestMatcher ignoredRequest : <span class="hljs-built_in">this</span>.ignoredRequests) &#123;<br>			securityFilterChains.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span>(ignoredRequest));<br>		&#125;<br>		<span class="hljs-keyword">for</span> (SecurityBuilder&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityFilterChain</span>&gt; securityFilterChainBuilder : <span class="hljs-built_in">this</span>.securityFilterChainBuilders) &#123;<br>			securityFilterChains.add(securityFilterChainBuilder.build());<br>		&#125;<br>    <span class="hljs-comment">//ç›´æ¥newå‡ºæ¥çš„FilterChainProxy</span><br>		<span class="hljs-type">FilterChainProxy</span> <span class="hljs-variable">filterChaiFilterChainProxynProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterChainProxy</span>(securityFilterChains);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.httpFirewall != <span class="hljs-literal">null</span>) &#123;<br>			filterChainProxy.setFirewall(<span class="hljs-built_in">this</span>.httpFirewall);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.requestRejectedHandler != <span class="hljs-literal">null</span>) &#123;<br>			filterChainProxy.setRequestRejectedHandler(<span class="hljs-built_in">this</span>.requestRejectedHandler);<br>		&#125;<br>		filterChainProxy.afterPropertiesSet();<br><br>		<span class="hljs-type">Filter</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> filterChainProxy;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.debugEnabled) &#123;<br>			<span class="hljs-built_in">this</span>.logger.warn(<span class="hljs-string">&quot;\n\n&quot;</span> + <span class="hljs-string">&quot;********************************************************************\n&quot;</span><br>					+ <span class="hljs-string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span><br>					+ <span class="hljs-string">&quot;**********    This may include sensitive information.  *************\n&quot;</span><br>					+ <span class="hljs-string">&quot;**********      Do not use in a production system!     *************\n&quot;</span><br>					+ <span class="hljs-string">&quot;********************************************************************\n\n&quot;</span>);<br>			result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DebugFilter</span>(filterChainProxy);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.postBuildAction.run();<br>		<span class="hljs-keyword">return</span> result;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<span style="color:red;"><strong>FilterChainProxy</strong>å°±æ˜¯æˆ‘ä»¬æœ€ç»ˆæ„å»ºå‡ºæ¥çš„ä»£ç†è¿‡æ»¤å™¨é“¾, åé¢å°±å¯ä»¥é€šè¿‡Springæä¾›<strong>Delegating</strong> <strong>FilterProxy</strong>å°†<strong>FilterChainProxy</strong>å¯¹è±¡åµŒå…¥åˆ°<strong>Web Filter</strong>ä¸­(åŸç”Ÿçš„è¿‡æ»¤å™¨é“¾ä¸­), è¿™æ ·æˆ‘ä»¬å®šä¹‰çš„<strong>SecurityFilterChain</strong>(<strong>DefaultSecurityFilterChain</strong>)å°±å¯ä»¥åœ¨SpringåŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­æ‰§è¡Œäº†.</span></p>
<p>æ€»çš„æ¥è¯´: æ„å»º<strong>SpringSecurity</strong>è¿‡æ»¤å™¨é“¾ä¹Ÿå°±æ˜¯<strong>SecurityFilterChain</strong>æœ€ä¸»è¦éœ€è¦äº†è§£çš„ç±»æœ‰:</p>
<ul>
<li><strong>HttpSecurity</strong>: æ„å»º<strong>SpringSecurity</strong>çš„è¿‡æ»¤å™¨é“¾<strong>SecurityFilterChain</strong>(<strong>DefalutSecurityFilterChain</strong>)</li>
<li><strong>WebSecurity</strong>: æ„å»ºæ¯”<strong>HttpSecurity</strong>æ›´é«˜å±‚çº§çš„è¿‡æ»¤å™¨<strong>FilterChainProxy</strong>, ä¸»è¦å°†<strong>HttpSecurity</strong>æ„å»ºçš„<strong>SecurityFilterChain</strong>è¿‡æ»¤å™¨é“¾åµŒå…¥åˆ°SpringåŸç”Ÿçš„Web Filterä¸­.</li>
</ul>
<h2 id="4-2-SpringSecurityçš„è¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•æ‰§è¡Œçš„"><a href="#4-2-SpringSecurityçš„è¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•æ‰§è¡Œçš„" class="headerlink" title="4.2 SpringSecurityçš„è¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•æ‰§è¡Œçš„?"></a>4.2 SpringSecurityçš„è¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•æ‰§è¡Œçš„?</h2><p>â€‹	ä¹‹å‰æˆ‘ä»¬è®²è¿‡äº†<strong>HttpSecurity</strong>ä»¥åŠ<strong>WebSecurity</strong>æ˜¯å¦‚ä½•æ„å»º<strong>SecurityFilterChain</strong>ä»¥åŠå°†<strong>SecurityFilterChain</strong>åµŒå…¥åˆ°SpringåŸç”ŸWebFilterçš„<strong>FilterChainProxy</strong>, æœ¬æ¬¡åˆ™è®²ä¸€ä¸‹è¿™äº›SpringSecurityè¿‡æ»¤å™¨å…·ä½“æ˜¯å¦‚ä½•æ‰§è¡Œçš„?æ‰§è¡Œé¡ºåºæ˜¯å¦‚ä½•?</p>
<p>â€‹	æƒ³è¦äº†è§£è¿™äº›è¿‡æ»¤å™¨å¦‚ä½•æ‰§è¡Œçš„, é‚£å°±è¦å…ˆè¦äº†è§£ä¸‹<strong>FilterChainProxy</strong></p>
<h3 id="4-2-1-FilterChainProxy"><a href="#4-2-1-FilterChainProxy" class="headerlink" title="4.2.1 FilterChainProxy"></a>4.2.1 FilterChainProxy</h3><p>â€‹	<strong>FilterChainProxy</strong> é€šè¿‡ <strong>DelegatingFilterProxy</strong> ä»£ç†è¿‡æ»¤å™¨è¢«é›†æˆåˆ° WebFilter ä¸­ï¼Œ <strong>DelegatingFilterProxy</strong>ä½œä¸º ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç›¸ä¿¡å¾ˆå¤šè¯»è€…å¯èƒ½éƒ½ç”¨è¿‡(ä¾‹å¦‚åœ¨Springä¸­æ•´åˆShiro å°±ä¼šç”¨åˆ°)ï¼Œå®ƒä¸æ‰¿è½½å…·ä½“çš„ä¸šåŠ¡ã€‚</p>
<p>â€‹	æ‰€ä»¥ï¼ŒSpring Security ä¸­çš„è¿‡æ»¤å™¨é“¾çš„æœ€ç»ˆæ‰§è¡Œï¼Œå°±æ˜¯åœ¨<strong>FilterChainProxy</strong> ä¸­ï¼Œå› æ­¤è¿™é‡Œä¹Ÿ æ¥åˆ†æä¸€ ä¸‹<strong>FilterChainProxy</strong>çš„æºç ã€‚</p>
<p>â€‹	<strong>FilterChainProxy</strong>çš„æºç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¸€æ®µä¸€æ®µæ¥çœ‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;SecurityFilterChain&gt; filterChains;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">FilterChainValidator</span> <span class="hljs-variable">filterChainValidator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullFilterChainValidator</span>();<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">HttpFirewall</span> <span class="hljs-variable">firewall</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictHttpFirewall</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">FilterChainProxy</span><span class="hljs-params">(SecurityFilterChain chain)</span> &#123;<br>	<span class="hljs-built_in">this</span>(Arrays.asList(chain));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">FilterChainProxy</span><span class="hljs-params">(List&lt;SecurityFilterChain&gt; filterChains)</span> &#123;<br>	<span class="hljs-built_in">this</span>.filterChains = filterChains;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	é¦–å…ˆå£°æ˜äº†ä¸‰ä¸ªå˜é‡:</p>
<ol>
<li>ç”±äºåœ¨Spring Securityä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œ<strong>filterChains</strong>å°±æ˜¯ç”¨æ¥ä¿å­˜è¿‡æ»¤å™¨é“¾çš„ï¼Œ<strong>æ³¨æ„ä¿å­˜çš„æ˜¯è¿‡æ»¤å™¨é“¾ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„è¿‡æ»¤å™¨ã€‚</strong></li>
<li><strong>filterChainValidator</strong> æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾é…ç½®å®Œæˆåçš„éªŒè¯å™¨ï¼Œé»˜è®¤ä½¿ç”¨ <strong>NullFilterChainValidator</strong> å…¶å®æ²¡æœ‰åšä»»ä½•éªŒè¯ã€‚</li>
<li>åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„é˜²ç«å¢™å¯¹è±¡<strong>FireWall</strong>ã€‚</li>
</ol>
<p>åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥è¿‡æ»¤å™¨é“¾çš„é›†åˆï¼Œå¹¶èµ‹å€¼ç»™<strong>filterChains</strong> å˜é‡ã€‚</p>
<p>ç”±äº<strong>FilterChainProxy</strong>æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå› æ­¤å®ƒçš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯<strong>doFilter</strong> æ–¹æ³•ï¼Œæ¥ ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>doFiter</strong> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span><br>			<span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>		<span class="hljs-type">boolean</span> <span class="hljs-variable">clearContext</span> <span class="hljs-operator">=</span> request.getAttribute(FILTER_APPLIED) == <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">if</span> (!clearContext) &#123;<br>			doFilterInternal(request, response, chain);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">try</span> &#123;<br>			request.setAttribute(FILTER_APPLIED, Boolean.TRUE);<br>			doFilterInternal(request, response, chain);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>			Throwable[] causeChain = <span class="hljs-built_in">this</span>.throwableAnalyzer.determineCauseChain(ex);<br>			<span class="hljs-type">Throwable</span> <span class="hljs-variable">requestRejectedException</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.throwableAnalyzer<br>					.getFirstThrowableOfType(RequestRejectedException.class, causeChain);<br>			<span class="hljs-keyword">if</span> (!(requestRejectedException <span class="hljs-keyword">instanceof</span> RequestRejectedException)) &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-built_in">this</span>.requestRejectedHandler.handle((HttpServletRequest) request, (HttpServletResponse) response,<br>					(RequestRejectedException) requestRejectedException);<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			SecurityContextHolder.clearContext();<br>			request.removeAttribute(FILTER_APPLIED);<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<strong>doFilter</strong> æ–¹æ³•ç›¸å½“äºæ˜¯æ•´ä¸ªSpring Security è¿‡æ»¤å™¨é“¾çš„å…¥å£ï¼Œæˆ‘ä»¬åœ¨å‰é¢ç« èŠ‚ä¸­æ‰€æ¶‰åŠçš„ä¸€äº›å…·ä½“çš„è¿‡æ»¤å™¨å¦‚<strong>SecurityContextPersistenceFilter</strong>ï¼Œéƒ½æ˜¯åœ¨è¯¥<strong>doFilter</strong>æ–¹æ³•ä¹‹åæ‰§è¡Œçš„ã€‚ä½œä¸ºæ•´ä¸ªè¿‡æ»¤å™¨é“¾çš„å…¥å£ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ª<strong>clearContext</strong> å˜é‡ï¼Œå¦‚æœæ˜¯ç¬¬ ä¸€æ¬¡æ‰§è¡Œè¯¥<strong>doFilter</strong> æ–¹æ³•ï¼Œ æ‰§è¡Œå®Œæˆåï¼Œåœ¨finallyä»£ç å—ä¸­éœ€è¦ä»<strong>SecurityContextHolder</strong> é‡Œæ¸…é™¤ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·æ²¡æœ‰æ­£ç¡®é…ç½®<strong>SecurityContextPersistenceFilter</strong> ï¼Œä»è€Œå¯¼è‡´ç™»å½•ç”¨æˆ·ä¿¡æ¯æ²¡æœ‰è¢«æ­£ç¡®æ¸…é™¤ï¼Œè¿›è€Œå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</p>
<p>â€‹	</p>
<p>â€‹	åœ¨<strong>doFilter</strong>æ–¹æ³•ä¸­ï¼Œè¿‡æ»¤å™¨çš„å…·ä½“æ‰§è¡Œåˆ™äº¤ç»™äº†<strong>doFilterInternal</strong> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span><br>			<span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>		<span class="hljs-type">FirewalledRequest</span> <span class="hljs-variable">firewallRequest</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.firewall.getFirewalledRequest((HttpServletRequest) request);<br>		<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">firewallResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.firewall.getFirewalledResponse((HttpServletResponse) response);<br>		List&lt;Filter&gt; filters = getFilters(firewallRequest);<br>		<span class="hljs-keyword">if</span> (filters == <span class="hljs-literal">null</span> || filters.size() == <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(LogMessage.of(() -&gt; <span class="hljs-string">&quot;No security for &quot;</span> + requestLine(firewallRequest)));<br>			&#125;<br>			firewallRequest.reset();<br>			chain.doFilter(firewallRequest, firewallResponse);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>			logger.debug(LogMessage.of(() -&gt; <span class="hljs-string">&quot;Securing &quot;</span> + requestLine(firewallRequest)));<br>		&#125;<br>		<span class="hljs-type">VirtualFilterChain</span> <span class="hljs-variable">virtualFilterChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualFilterChain</span>(firewallRequest, chain, filters);<br>		virtualFilterChain.doFilter(firewallRequest, firewallResponse);<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨<strong>doFilterInternal</strong> æ–¹æ³•ä¸­:</p>
<ol>
<li>é¦–å…ˆä¼šå°†request å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ª<strong>FirewalledRequest</strong> å¯¹è±¡ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹ä¼šè¿›è¡ŒHttpé˜²ç«å¢™å¤„ç† (Httpé˜²ç«å¢™ä¼šåœ¨åé¢è®²è§£, è¿™é‡Œå¯ä»¥ç›´æ¥ç†è§£æˆ<strong>HttpServletRequest</strong>) ï¼Œ åŒæ—¶å°†responseå¯¹è±¡ä¹Ÿè½¬ä¸º <strong>HttpServletResponse</strong>ã€‚</li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ <strong>getFilters</strong> æ–¹æ³•è·å–å½“å‰è¯·æ±‚å¯¹åº”çš„è¿‡æ»¤å™¨é“¾ï¼Œ <strong>getFilters</strong> æ–¹æ³•ä¼šéå†<strong>filterChains</strong> é›†åˆï¼Œè¿›è€Œåˆ¤æ–­å‡ºå½“å‰è¯·æ±‚å’Œå“ªä¸€ä¸ªè¿‡æ»¤å™¨é“¾æ˜¯å¯¹åº”çš„ï¼Œ<ul>
<li>å¦‚æœæ‰¾åˆ°çš„è¿‡æ»¤å™¨é“¾filters ä¸ºnullï¼Œæˆ–è€…filtersä¸­æ²¡æœ‰å…ƒç´ ï¼Œè¯´æ˜å½“å‰è¯·æ±‚å¹¶ä¸éœ€è¦ç»è¿‡SpringSecurity è¿‡æ»¤å™¨é“¾ï¼Œæ­¤æ—¶æ‰§è¡Œ<strong>fwRequest.reset</strong> æ–¹æ³•å¯¹Http é˜²ç«å¢™ä¸­çš„å±æ€§è¿›è¡Œé‡ç½®ï¼Œå†æ‰§è¡Œ <strong>chain.doFilter</strong> æ–¹æ³•ï¼Œå›åˆ°Web Filter ä¸­ï¼ŒSpring Security è¿‡æ»¤å™¨é“¾å°†è¢«è·³è¿‡(å›å¿†ä¸Šä¸€å°ç»“ WebSecurity ä¸­é…ç½®çš„å¿½ç•¥è¯·æ±‚)ã€‚</li>
<li>å¦‚æœfilters é›†åˆä¸­æ˜¯æœ‰å…ƒç´ çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰è¯·æ±‚éœ€è¦ç» è¿‡filters é›†åˆä¸­å…ƒç´ æ‰€æ„æˆçš„è¿‡æ»¤å™¨é“¾ï¼Œé‚£ä¹ˆæ„å»º ä¸€ä¸ªè™šæ‹Ÿçš„è¿‡æ»¤å™¨é“¾å¯¹è±¡<strong>VirtualFilterChain</strong> , å¹¶æ‰§è¡Œå…¶<strong>doFilter</strong> æ–¹æ³•ã€‚</li>
</ul>
</li>
</ol>
<p><span style="color:red;">æ€»è€Œè¨€ä¹‹: <strong>FilterChainProxy</strong>è¿‡æ»¤å™¨çš„ä¸»è¦ç”¨å¤„åœ¨äº<strong>doFilterInternal</strong>æ–¹æ³•é‡Œé¢åˆ¤æ–­å½“å‰çš„requestè¯·æ±‚æ˜¯å¦åŒ¹é…æˆ‘ä»¬é…ç½®çš„è¿‡æ»¤å™¨é“¾, å¦‚æœæ»¡è¶³åˆ™å°†æˆ‘ä»¬å®šä¹‰çš„SpringSecurityè¿‡æ»¤å™¨é“¾æŒ‰é¡ºåºdoFilter</span></p>
<h2 id="4-3-SpringSecurityå…¨å±€é…ç½®æ˜¯æ€ä¹ˆæ³¨å…¥çš„"><a href="#4-3-SpringSecurityå…¨å±€é…ç½®æ˜¯æ€ä¹ˆæ³¨å…¥çš„" class="headerlink" title="4.3 SpringSecurityå…¨å±€é…ç½®æ˜¯æ€ä¹ˆæ³¨å…¥çš„?"></a>4.3 SpringSecurityå…¨å±€é…ç½®æ˜¯æ€ä¹ˆæ³¨å…¥çš„?</h2><p>â€‹		è¿™é‡Œçš„å…¨å±€é…ç½®ä¸»è¦æ˜¯æŒ‡å®šæ˜¯å…¨å±€çš„<strong>AuthenticationManager</strong>ã€<strong>UserDetailsService</strong>, æƒ³å®Œæ•´æ˜ç™½å¦‚ä½•é…ç½®çš„, ä¸å¦¨å…ˆäº†è§£å…¶ç›¸å…³çš„æ„å»ºç±»:</p>
<h3 id="4-3-1-ProviderManagerBuilder"><a href="#4-3-1-ProviderManagerBuilder" class="headerlink" title="4.3.1 ProviderManagerBuilder"></a>4.3.1 ProviderManagerBuilder</h3><p><strong>ProviderManagerBuilder</strong>ç»§æ‰¿è‡ª<strong>SecurityBuilder</strong>æ¥å£, å¹¶åˆ¶å®šäº†æ„å»ºçš„å¯¹è±¡æ˜¯<strong>AuthenticationManager</strong>, ä»£ç å¦‚ä¸‹:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230716212401489.png" srcset="/img/loading.gif" lazyload alt="image-20230716212401489"></p>
<p><span style="color:red;">å¯ä»¥çœ‹åˆ°, <strong>ProviderManagerBuilder</strong>ä¸­å¢åŠ äº†ä¸€ä¸ª<strong>authenticationProvider</strong>æ–¹æ³•, åŒæ—¶é€šè¿‡æ³›å‹æŒ‡å®šäº†æ„å»ºçš„å¯¹è±¡ä¸º<strong>AuthenticationManager</strong></span></p>
<h3 id="4-3-2-AuthenticationManagerBuilder"><a href="#4-3-2-AuthenticationManagerBuilder" class="headerlink" title="4.3.2 AuthenticationManagerBuilder"></a>4.3.2 AuthenticationManagerBuilder</h3><p>â€‹	<span style="color:red;"><strong>AuthenticationManagerBuilder</strong>ç”¨æ¥æ„å»º<strong>AuthenticationManager</strong>å¯¹è±¡</span>, å®ƒç»§æ‰¿è‡ª<strong>AbstractConfiguredSecurityBuilder</strong>, å¹¶ä¸”å®ç°äº†<strong>ProviderManagerBuilder</strong>æ¥å£, æºç æ¯”è¾ƒé•¿, æˆ‘ä»¬æˆªå–éƒ¨åˆ†ä»£ç , ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationManagerBuilder</span><br>		<span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;AuthenticationManager, AuthenticationManagerBuilder&gt;<br>		<span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProviderManagerBuilder</span>&lt;AuthenticationManagerBuilder&gt; &#123;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthenticationManagerBuilder</span><span class="hljs-params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;<br>		<span class="hljs-built_in">super</span>(objectPostProcessor, <span class="hljs-literal">true</span>);<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> AuthenticationManagerBuilder <span class="hljs-title function_">parentAuthenticationManager</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> &#123;<br>		<span class="hljs-keyword">if</span> (authenticationManager <span class="hljs-keyword">instanceof</span> ProviderManager) &#123;<br>			eraseCredentials(((ProviderManager) authenticationManager).isEraseCredentialsAfterAuthentication());<br>		&#125;<br>		<span class="hljs-built_in">this</span>.parentAuthenticationManager = authenticationManager;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> InMemoryUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="hljs-title function_">inMemoryAuthentication</span><span class="hljs-params">()</span><br>			<span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">return</span> apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManagerConfigurer</span>&lt;&gt;());<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> JdbcUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="hljs-title function_">jdbcAuthentication</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">return</span> apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcUserDetailsManagerConfigurer</span>&lt;&gt;());<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UserDetailsService</span>&gt; DaoAuthenticationConfigurer&lt;AuthenticationManagerBuilder, T&gt; <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">(</span><br><span class="hljs-params">			T userDetailsService)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-built_in">this</span>.defaultUserDetailsService = userDetailsService;<br>		<span class="hljs-keyword">return</span> apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationConfigurer</span>&lt;&gt;(userDetailsService));<br>	&#125;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> AuthenticationManagerBuilder <span class="hljs-title function_">authenticationProvider</span><span class="hljs-params">(AuthenticationProvider authenticationProvider)</span> &#123;<br>		<span class="hljs-built_in">this</span>.authenticationProviders.add(authenticationProvider);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> ProviderManager <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">if</span> (!isConfigured()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;</span>);<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br>		<span class="hljs-type">ProviderManager</span> <span class="hljs-variable">providerManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(<span class="hljs-built_in">this</span>.authenticationProviders,<br>				<span class="hljs-built_in">this</span>.parentAuthenticationManager);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eraseCredentials != <span class="hljs-literal">null</span>) &#123;<br>			providerManager.setEraseCredentialsAfterAuthentication(<span class="hljs-built_in">this</span>.eraseCredentials);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eventPublisher != <span class="hljs-literal">null</span>) &#123;<br>			providerManager.setAuthenticationEventPublisher(<span class="hljs-built_in">this</span>.eventPublisher);<br>		&#125;<br>		providerManager = postProcess(providerManager);<br>		<span class="hljs-keyword">return</span> providerManager;<br>	&#125;<br></code></pre></td></tr></table></figure>



<ol>
<li>é¦–å…ˆåœ¨<strong>AuthenticationManagerBuilder</strong>çš„æ„é€ æ–¹æ³•ä¸­, è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•, æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’äº†true, è¡¨ç¤ºå…è®¸ç›¸åŒç±»å‹çš„é…ç½®ç±»åŒæ—¶å­˜åœ¨(ç»“åˆ<strong>AbstractConfiguredSecurityBuilder</strong>çš„æºç æ¥ç†è§£)</li>
<li><strong>parentAuthenticationManager</strong>æ–¹æ³•æ¥ç»™ä¸€ä¸ª<strong>AuthenticationManager</strong>è®¾ç½®<strong>parent</strong></li>
<li><strong>inMemoryAuthentication</strong>æ–¹æ³•æ¥é…ç½®åŸºäºå†…å­˜çš„æ•°æ®æº, è¯¥æ–¹æ³•ä¼šè‡ªåŠ¨åˆ›å»º<strong>InMemoryUserDetailsManagerConfigurer</strong>é…ç½®ç±», å¹¶æœ€ç»ˆå°†è¯¥é…ç½®ç±»æ·»åŠ åˆ°çˆ¶ç±»çš„<strong>configurers</strong>å˜é‡ä¸­.ç”±äºè®¾ç½®äº†å…è®¸ç›¸åŒç±»å‹çš„é…ç½®ç±»åŒæ—¶å­˜åœ¨, å› æ­¤<strong>inMemoryAuthentication</strong>æ–¹æ³•å¯ä»¥åå¤è°ƒç”¨å¤šæ¬¡.</li>
<li><strong>jdbcAuthentication</strong>ä»¥åŠ<strong>userDetailsService</strong>æ–¹æ³•ä¸<strong>inMemoryAuthentication</strong>æ–¹æ³•ç±»ä¼¼, ä¹Ÿå°±æ˜¯ç”¨æ¥é…ç½®æ•°æ®æºçš„, å°±ä¸å†èµ˜è¿°</li>
<li><strong>authenticationProvider</strong>æ–¹æ³•ç”¨æ¥å‘<strong>authenticationProviders</strong>é›†åˆä¸­æ·»åŠ <strong>AuthenticationProvider</strong>å¯¹è±¡, æ ¹æ®ä¹‹å‰çš„è®²è§£, æˆ‘ä»¬å·²ç»çŸ¥é“ä¸€ä¸ª<strong>AuthenticationManager</strong>å®ä¾‹ä¸­åŒ…å«äº†å¤šä¸ª<strong>AuthenticationProvider</strong>å®ä¾‹, é‚£ä¹ˆå¤šä¸ª<strong>AuthenticationProvider</strong>å®ä¾‹å¯ä»¥é€šè¿‡<strong>authenticationProvider</strong>æ–¹æ³•æ¥è¿›è¡Œæ·»åŠ </li>
<li><strong>performBuild</strong>æ–¹æ³•åˆ™æ˜¯æ‰§è¡Œå…·ä½“çš„æ„å»ºæ–¹æ³•, å¸¸ç”¨çš„<strong>AuthenticationManager</strong>å®ä¾‹å°±æ˜¯<strong>ProviderManager</strong>, æ‰€ä»¥è¿™é‡Œåˆ›å»º<strong>ProviderManager</strong>å¯¹è±¡, å¹¶ä¸”é…ç½®<strong>authenticationProviders</strong>å’Œ<strong>parentAuthenticationManager</strong>å¯¹è±¡, <strong>ProviderManager</strong>å¯¹è±¡åˆ›å»ºæˆåŠŸä¹‹å,å†å»å¯¹è±¡åç½®å¤„ç†å™¨ä¸­å¤„ç†ä¸€éå†è¿”å›</li>
</ol>
<p>è¿™å°±æ˜¯<strong>AuthenticationManagerBuilder</strong>çš„å¤§è‡´é€»è¾‘, æˆ‘ä»¬éœ€è¦é‡ç‚¹æŒæ¡<strong>authenticationProvider</strong>ã€<strong>parentAuthenticationManager</strong>æ–¹æ³•</p>
<h3 id="4-3-3-GlobalAuthenticationConfigurerAdapter"><a href="#4-3-3-GlobalAuthenticationConfigurerAdapter" class="headerlink" title="4.3.3 GlobalAuthenticationConfigurerAdapter"></a>4.3.3 GlobalAuthenticationConfigurerAdapter</h3><p>â€‹	<span style="color:red;"><strong>GlobalAuthenticationConfigurerAdapter</strong> ä¸»è¦æ˜¯ç”¨äºé…ç½®å…¨å±€<strong>AuthenticationManagerBuilder</strong>, åœ¨<strong>AuthenticationConfigureration</strong>ç±»ä¼šè‡ªåŠ¨ä½¿ç”¨<strong>GlobalAuthenticationConfigurerAdapter</strong>æä¾›çš„<strong>Bean</strong>æ¥é…ç½®å…¨å±€çš„<strong>AuthenticationManagerBuilder</strong></span></p>
<p>â€‹	åœ¨ä¹‹å‰ä»‹ç»è¿‡<strong>ProviderManager</strong>æ—¶æ›¾ç»æåˆ°è¿‡, é»˜è®¤æƒ…å†µä¸‹<strong>ProviderManager</strong>æœ‰ä¸€ä¸ªparent, è¿™ä¸ªparentå°±æ˜¯é€šè¿‡è¿™é‡Œçš„å…¨å±€<strong>AuthenticationManagerBuilder</strong>æ¥æ„å»ºçš„.</p>
<p>â€‹	<strong>GlobalAuthenticationConfigurerAdapter</strong>æœ‰å››ä¸ªä¸åŒçš„å­ç±», å¦‚å›¾æ‰€ç¤º:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230313215553853.png" srcset="/img/loading.gif" lazyload alt="image-20230313215553853"></p>
<ul>
<li><strong>InitializeAuthenticationProviderBeanManagerConfigurer</strong>: åˆå§‹åŒ–å…¨å±€çš„<strong>AuthenticationProvider</strong>å¯¹è±¡</li>
<li><strong>InitializeAuthenticationProviderManagerConfigurer</strong>: é…ç½®å…¨å±€çš„<strong>AuthenticationProvider</strong>å¯¹è±¡, é…ç½®çš„è¿‡ç¨‹å°±æ˜¯ä»Springå®¹å™¨ä¸­æ‰¾<strong>AuthenticationProvider</strong>å¹¶æ·»åŠ åˆ°å…¨å±€çš„<strong>AuthenticationManagerBuilder</strong>å¯¹è±¡çš„<strong>authenticationProvider</strong>ä¸­</li>
<li><strong>InitializeUserDetailsBeanManagerConfigurer</strong>: åˆå§‹åŒ–å…¨å±€çš„<strong>UserDetailsService</strong>å¯¹è±¡</li>
<li><strong>IntializeUserDetailsManagerConfigurer</strong>: é…ç½®å…¨å±€çš„<strong>UserDetailsService</strong>å¯¹è±¡,é…ç½®è¿‡ç¨‹å°±æ˜¯ä»Springå®¹å™¨ä¸­æŸ¥æ‰¾<strong>UserDetailsService</strong>,å°è£…ä¸ºä¸€ä¸ª<strong>DaoAuthenticationProvider</strong> å¹¶æ·»åŠ åˆ°å…¨å±€çš„<strong>AuthenticatioonManagerBuilder</strong>å¯¹è±¡çš„<strong>authenticationProvider</strong>ä¸­</li>
<li><strong>EnableGlobalAuthenticationAutowiredConfigurer</strong>: ä»Springå®¹å™¨ä¸­åŠ è½½è¢«@<strong>EnableGlobalAuthentication</strong>æ³¨è§£æ ‡è®°çš„Bean</li>
</ul>
<h3 id="4-3-4-AuthenticationConfiguration"><a href="#4-3-4-AuthenticationConfiguration" class="headerlink" title="4.3.4 AuthenticationConfiguration"></a>4.3.4 AuthenticationConfiguration</h3><p>â€‹	åœ¨SpringSecurityè‡ªåŠ¨åŒ–é…ç½®ç±»ä¸­å¯¼å…¥çš„å¦å¤–ä¸€ä¸ªé…ç½®ç±»æ˜¯<strong>AuthenticationConfiguration</strong>,<span style="color:red;"> è¯¥ç±»çš„åŠŸèƒ½ä¸»è¦æ˜¯åšå…¨å±€çš„é…ç½®, åŒæ—¶æä¾›ä¸€ä¸ªæ–¹æ³•æ¥ä¸€ä¸ªå…¨å±€çš„<strong>AuthenticationManager</strong>å®ä¾‹. </span>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹<strong>AuthenticationConfiguration</strong>ç±»å®šä¹‰:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@Import(ObjectPostProcessorConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationConfiguration</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, <strong>AuthenticationConfiguration</strong>ç±»çš„å®šä¹‰ä¸­, å¯¼å…¥äº†<strong>ObjectPostProcessorConfiguration</strong>é…ç½®, è€Œ<strong>ObjectPostProcessorConfiguration</strong>é…ç½®åˆ™æä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„å¯¹è±¡åç½®å¤„ç†å™¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectPostProcessorConfiguration</span> &#123;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br>	<span class="hljs-keyword">public</span> ObjectPostProcessor&lt;Object&gt; <span class="hljs-title function_">objectPostProcessor</span><span class="hljs-params">(AutowireCapableBeanFactory beanFactory)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutowireBeanFactoryObjectPostProcessor</span>(beanFactory);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, <strong>ObjectPostProcessorConfiguration</strong>ç±»ä¸»è¦æä¾›äº†ä¸€ä¸ª<strong>ObjectPostProcessor</strong>å®ä¾‹, å…·ä½“çš„å®ç°ç±»æ˜¯<strong>AutowireBeanFactoryObjetPostProcessor</strong>, æ ¹æ®å‰é¢çš„ä»‹ç», è¯¥å®ç°ç±»ä¸»è¦ç”¨æ¥å°†ä¸€ä¸ªå¯¹è±¡æ³¨å†Œåˆ°Springå®¹å™¨ä¸­, æˆ‘ä»¬åœ¨å…¶ä»–é…ç½®ç±»ä¸­æ‰€è§åˆ°çš„<strong>ObjectPostProcessor</strong>å®ä¾‹å…¶å®éƒ½æ˜¯è¿™é‡Œæä¾›çš„</p>
<p>â€‹	è¿™æ˜¯<strong>AuthenticationConfiguration</strong>ç±»çš„å®šä¹‰éƒ¨åˆ†, <strong>AuthenticationConfiguration</strong>ç±»ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤š, æˆ‘ä»¬æŒ‘é€‰å‡ºå…³é”®çš„éƒ¨åˆ†åˆ†æä¸€ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java">	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> AuthenticationManagerBuilder <span class="hljs-title function_">authenticationManagerBuilder</span><span class="hljs-params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-type">LazyPasswordEncoder</span> <span class="hljs-variable">defaultPasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyPasswordEncoder</span>(context);<br>		<span class="hljs-type">AuthenticationEventPublisher</span> <span class="hljs-variable">authenticationEventPublisher</span> <span class="hljs-operator">=</span> getAuthenticationEventPublisher(context);<br>		<span class="hljs-type">DefaultPasswordEncoderAuthenticationManagerBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPasswordEncoderAuthenticationManagerBuilder</span>(<br>				objectPostProcessor, defaultPasswordEncoder);<br>		<span class="hljs-keyword">if</span> (authenticationEventPublisher != <span class="hljs-literal">null</span>) &#123;<br>			result.authenticationEventPublisher(authenticationEventPublisher);<br>		&#125;<br>		<span class="hljs-keyword">return</span> result;<br>	&#125;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GlobalAuthenticationConfigurerAdapter <span class="hljs-title function_">enableGlobalAuthenticationAutowiredConfigurer</span><span class="hljs-params">(</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnableGlobalAuthenticationAutowiredConfigurer</span>(context);<br>	&#125;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InitializeUserDetailsBeanManagerConfigurer <span class="hljs-title function_">initializeUserDetailsBeanManagerConfigurer</span><span class="hljs-params">(</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeUserDetailsBeanManagerConfigurer</span>(context);<br>	&#125;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InitializeAuthenticationProviderBeanManagerConfigurer <span class="hljs-title function_">initializeAuthenticationProviderBeanManagerConfigurer</span><span class="hljs-params">(</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeAuthenticationProviderBeanManagerConfigurer</span>(context);<br>	&#125;<br><br><span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">getAuthenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationManagerInitialized) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authenticationManager;<br>		&#125;<br>		<span class="hljs-type">AuthenticationManagerBuilder</span> <span class="hljs-variable">authBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationContext.getBean(AuthenticationManagerBuilder.class);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.buildingAuthenticationManager.getAndSet(<span class="hljs-literal">true</span>)) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationManagerDelegator</span>(authBuilder);<br>		&#125;<br>		<span class="hljs-keyword">for</span> (GlobalAuthenticationConfigurerAdapter config : <span class="hljs-built_in">this</span>.globalAuthConfigurers) &#123;<br>			authBuilder.apply(config);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.authenticationManager = authBuilder.build();<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationManager == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.authenticationManager = getAuthenticationManagerBean();<br>		&#125;<br>		<span class="hljs-built_in">this</span>.authenticationManagerInitialized = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authenticationManager;<br>	&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<strong>AuthenticationManagerBuilder</strong>å®ä¾‹, ç›®çš„æ˜¯ä¸ºäº†æ„å»ºå…¨å±€çš„<strong>AuthenticationManager</strong>å¯¹è±¡, è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šä»Springå®¹å™¨ä¸­æŸ¥æ‰¾<strong>AuthenticationEventPublisher</strong>å®ä¾‹è®¾ç½®ç»™<strong>AuthenticationManagerBuilder</strong>å¯¹è±¡</p>
</li>
<li><p>æ¥ä¸‹æ¥æ„å»ºäº†ä¸‰ä¸ªBean, è¿™ä¸‰ä¸ªBeançš„ä½œç”¨åœ¨ä¹‹å‰ä»‹ç»è¿‡äº†.</p>
</li>
<li><p><strong>getAuthenticationManager</strong>æ–¹æ³•åˆ™ç”¨æ¥æ„å»ºå…·ä½“çš„<strong>AuthenticationManager</strong>å¯¹è±¡, åœ¨è¯¥æ–¹æ³•å†…éƒ¨, ä¼šé¦–å…ˆåˆ¤æ–­<strong>AuthenticationManager</strong>å¯¹è±¡æ˜¯å¦å·²ç»åˆå§‹åŒ–, å¦‚æœå·²ç»åˆå§‹åŒ–, åˆ™ç›´æ¥è¿”å›<strong>AuthenticationManager</strong>å¯¹è±¡, å¦åˆ™å°±å…ˆä»Springå®¹å™¨ä¸­è·å–åˆ°<strong>AuthenticationManagerDelegator</strong>å¯¹è±¡, è¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢åœ¨åˆå§‹åŒ–<strong>AuthenticationManager</strong>æ—¶è¿›è¡Œæ— é™é€’å½’. æ‹¿åˆ°<strong>authBuilder</strong>å¯¹è±¡ä¹‹å, æ¥ä¸‹æ¥éå†<strong>globalAuthConfigurers</strong>é…ç½®ç±»é›†åˆ(ä¹Ÿå°±æ˜¯ç¬¬äºŒç‚¹æ‰€è¯´çš„ä¸‰ä¸ªé…ç½®ç±»), å°†é…ç½®ç±»åˆ†åˆ«æ·»åŠ åˆ°<strong>authBuilder</strong>å¯¹è±¡ä¸­, ç„¶åè¿›è¡Œæ„å»º, æœ€ç»ˆå°†æ„å»ºç»“æœè¿”å›.</p>
<p>è¿™æ˜¯å…¨å±€<strong>AuthenticationManager</strong>çš„æ„å»ºè¿‡ç¨‹.</p>
<p>æ•´ä½“æ¥è¯´, <strong>AuthenticationConfiguration</strong>çš„ä½œç”¨ä¸»è¦ä½“ç°åœ¨ä¸¤æ–¹é¢:</p>
<ul>
<li>ç¬¬ä¸€å°±æ˜¯å¯¼å…¥äº†<strong>ObjectPostProcessorConfiguration</strong>é…ç½®ç±»;</li>
<li>ç¬¬äºŒåˆ™æ˜¯æä¾›äº†ä¸€ä¸ªå…¨å±€çš„<strong>AuthenticationManager</strong>å¯¹è±¡.å¦‚æœå¼€å‘è€…åœ¨è‡ªå®šä¹‰é…ç½®ç±»ä¸­é‡å†™äº†<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•, è¿™é‡Œçš„å…¨å±€</strong>AuthenticationManager</strong>å¯¹è±¡å°†ä¸ä¼šç”Ÿæ•ˆ, è€Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹, å¼€å‘è€…éƒ½ä¼šé‡å†™**configure(AuthenticationManagerBuilder)**æ–¹æ³•</li>
</ul>
</li>
</ol>
<p>â€‹		</p>
<h3 id="4-3-5-å…¨å±€é…ç½®åˆå§‹åŒ–åˆ†æ"><a href="#4-3-5-å…¨å±€é…ç½®åˆå§‹åŒ–åˆ†æ" class="headerlink" title="4.3.5 å…¨å±€é…ç½®åˆå§‹åŒ–åˆ†æ"></a>4.3.5 å…¨å±€é…ç½®åˆå§‹åŒ–åˆ†æ</h3><p>æœ‰äº†å‰ç¼€çš„æ„é€ å™¨å’Œæ„é€ å™¨çš„çŸ¥è¯†, æˆ‘ä»¬å°±å¯ä»¥æ¥åˆ†æä¸‹SpringSecurityçš„å…¨å±€<strong>AuthenticationManager</strong>æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„(<strong>SecurityFilterChainç‰ˆæœ¬</strong>):</p>
<p>æˆ‘ä»¬çŸ¥é“è‡ªå®šä¹‰<strong>SecurityFilterChain</strong>çš„æ–¹å¼ä¼šåˆ›å»º<strong>HttpSecurity</strong>, åˆ›å»ºé€»è¾‘åœ¨<strong>HttpSecurityConfiguration</strong>#<strong>httpSecurity</strong>, æˆ‘ä»¬çœ‹ä¸‹å…·ä½“é€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpSecurityConfiguration</span> &#123;<br>  <br>  <span class="hljs-meta">@Bean(HTTPSECURITY_BEAN_NAME)</span><br>	<span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br>	HttpSecurity <span class="hljs-title function_">httpSecurity</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		WebSecurityConfigurerAdapter.<span class="hljs-type">LazyPasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>.LazyPasswordEncoder(<br>				<span class="hljs-built_in">this</span>.context);<br>		<span class="hljs-type">AuthenticationManagerBuilder</span> <span class="hljs-variable">authenticationBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>.DefaultPasswordEncoderAuthenticationManagerBuilder(<br>				<span class="hljs-built_in">this</span>.objectPostProcessor, passwordEncoder);<br>    <span class="hljs-comment">//å°†åˆ›å»ºçš„å…¨å±€AuthenticationManagerè®¾ç½®åˆ°authenticationBuilderçš„parentAuthenticationManager</span><br>		authenticationBuilder.parentAuthenticationManager(authenticationManager());<br>		authenticationBuilder.authenticationEventPublisher(getAuthenticationEventPublisher());<br>    <span class="hljs-comment">//å°†AuthenticationBuilderè®¾ç½®åˆ°shareObjects</span><br>		<span class="hljs-type">HttpSecurity</span> <span class="hljs-variable">http</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSecurity</span>(<span class="hljs-built_in">this</span>.objectPostProcessor, authenticationBuilder, createSharedObjects());<br>		<span class="hljs-comment">// @formatter:off</span><br>		http<br>			.csrf(withDefaults())<br>			.addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAsyncManagerIntegrationFilter</span>())<br>			.exceptionHandling(withDefaults())<br>			.headers(withDefaults())<br>			.sessionManagement(withDefaults())<br>			.securityContext(withDefaults())<br>			.requestCache(withDefaults())<br>			.anonymous(withDefaults())<br>			.servletApi(withDefaults())<br>			.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLoginPageConfigurer</span>&lt;&gt;());<br>		http.logout(withDefaults());<br>		<span class="hljs-comment">// @formatter:on</span><br>		applyDefaultConfigurers(http);<br>		<span class="hljs-keyword">return</span> http;<br>	&#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="å…¨å±€AuthentionManageråˆå§‹åŒ–åˆ†æ"><a href="#å…¨å±€AuthentionManageråˆå§‹åŒ–åˆ†æ" class="headerlink" title="å…¨å±€AuthentionManageråˆå§‹åŒ–åˆ†æ"></a>å…¨å±€AuthentionManageråˆå§‹åŒ–åˆ†æ</h4><p>æˆ‘ä»¬å…ˆåˆ†æä¸‹<strong>HttpSecurity</strong>ä¸­çš„è¿™æ®µä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AuthenticationManagerBuilder</span> <span class="hljs-variable">authenticationBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>.DefaultPasswordEncoderAuthenticationManagerBuilder(<br>				<span class="hljs-built_in">this</span>.objectPostProcessor, passwordEncoder);<br>		authenticationBuilder.parentAuthenticationManager(authenticationManager());<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„é€»è¾‘ä¸»è¦æ˜¯:</p>
<ol>
<li>å…ˆæ„å»ºä¸€ä¸ª<strong>AuthenticationManagerBuilder</strong>, ä»å‰ç½®çŸ¥è¯†æˆ‘ä»¬çŸ¥é“è¿™ä¸ª<strong>AuthenticationManagerBuilder</strong>ç»§æ‰¿äº†<strong>AbstractConfiguredSecurityBuilder</strong>é‡Œé¢ç»´æŠ¤äº†ä¸€å †çš„<strong>configures</strong>, æ˜¯ç”¨æ¥æ„å»º<strong>AuthenticationManager</strong>. </li>
<li><span style="color:red;">ç„¶åè°ƒç”¨<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>æ„å»ºä¸€ä¸ª<strong>å…¨å±€AuthenticationManager</strong></span>,ç„¶åè®¾ç½®åˆ°<strong>AuthenticationManagerBuilder</strong>ä¸­, æˆ‘ä»¬å†æ¥å¤ä¹ ä¸‹<strong>AuthenticationConfiguration</strong>è¿™ä¸ªæ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">getAuthenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  	<span class="hljs-comment">//è¿™é‡Œå¦‚æœä¿è¯è¿™ä¸ªæ–¹æ³•åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡AuthenticationManager</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationManagerInitialized) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authenticationManager;<br>		&#125;<br>  	<span class="hljs-comment">//ä»Springä¸­è·å–AuthenticationManagerBuilder</span><br>		<span class="hljs-type">AuthenticationManagerBuilder</span> <span class="hljs-variable">authBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationContext.getBean(AuthenticationManagerBuilder.class);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.buildingAuthenticationManager.getAndSet(<span class="hljs-literal">true</span>)) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationManagerDelegator</span>(authBuilder);<br>		&#125;<br>  	<span class="hljs-comment">//ä»GlobalAuthenticationConfigurerAdapteræ·»åŠ è¿›é…ç½®</span><br>		<span class="hljs-keyword">for</span> (GlobalAuthenticationConfigurerAdapter config : <span class="hljs-built_in">this</span>.globalAuthConfigurers) &#123;<br>			authBuilder.apply(config);<br>		&#125;<br>  	<span class="hljs-comment">//åœ¨æ‰§è¡ŒAuthenticationManagerBuilder#buildæ–¹æ³•æ„å»ºå…¨å±€çš„AuthenticationManager</span><br>		<span class="hljs-built_in">this</span>.authenticationManager = authBuilder.build();<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationManager == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.authenticationManager = getAuthenticationManagerBean();<br>		&#125;<br>		<span class="hljs-built_in">this</span>.authenticationManagerInitialized = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authenticationManager;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ä¼šä»Springå®¹å™¨ä¸­è·å–<strong>AuthenticationManagerBuilder</strong>, è¿™ä¸ª<strong>AuthenticationManagerBuilder</strong>æ˜¯ä»<strong>AuthenticationConfiguration</strong>ä¸­æ³¨å…¥çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@Import(ObjectPostProcessorConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationConfiguration</span> &#123;<br>  <br>  <span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> AuthenticationManagerBuilder <span class="hljs-title function_">authenticationManagerBuilder</span><span class="hljs-params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-type">LazyPasswordEncoder</span> <span class="hljs-variable">defaultPasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyPasswordEncoder</span>(context);<br>		<span class="hljs-type">AuthenticationEventPublisher</span> <span class="hljs-variable">authenticationEventPublisher</span> <span class="hljs-operator">=</span> getAuthenticationEventPublisher(context);<br>		<span class="hljs-type">DefaultPasswordEncoderAuthenticationManagerBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPasswordEncoderAuthenticationManagerBuilder</span>(<br>				objectPostProcessor, defaultPasswordEncoder);<br>		<span class="hljs-keyword">if</span> (authenticationEventPublisher != <span class="hljs-literal">null</span>) &#123;<br>			result.authenticationEventPublisher(authenticationEventPublisher);<br>		&#125;<br>		<span class="hljs-keyword">return</span> result;<br>	&#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åå°†é»˜è®¤çš„<strong>GlobalAuthenticationConfigurerAdapter</strong>æ·»åŠ è¿›è¿™ä¸ª<strong>AuthenticationManagerBuilder</strong>ä¸­çš„<strong>configures</strong>, è¿™ä¸ª<strong>GlobalAuthenticationConfigurerAdapter</strong>æ˜¯æˆ‘ä»¬ä¹‹å‰è®²è¿‡çš„å¹¶é…ç½®åˆ°<strong>AuthenticationConfiguration</strong>é‡Œçš„å…¨å±€é…ç½®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@Import(ObjectPostProcessorConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationConfiguration</span> &#123;<br>  <br>  <span class="hljs-comment">//é…ç½®å…¨å±€çš„UserDetailsService(æˆ‘ä»¬è‡ªå®šä¹‰çš„UserDetailsServiceä¼šä»è¿™ä¸ªconfigureåŠ è½½)</span><br>  <span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InitializeUserDetailsBeanManagerConfigurer <span class="hljs-title function_">initializeUserDetailsBeanManagerConfigurer</span><span class="hljs-params">(</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeUserDetailsBeanManagerConfigurer</span>(context);<br>	&#125;<br>  <br>  <span class="hljs-comment">//é…ç½®å…¨å±€çš„AuthenticationProvider</span><br>  <span class="hljs-meta">@Bean</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InitializeAuthenticationProviderBeanManagerConfigurer <span class="hljs-title function_">initializeAuthenticationProviderBeanManagerConfigurer</span><span class="hljs-params">(</span><br><span class="hljs-params">			ApplicationContext context)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeAuthenticationProviderBeanManagerConfigurer</span>(context);<br>	&#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>å†å›åˆ°<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>, å°†æˆ‘ä»¬çš„å…¨å±€é…ç½®æ·»åŠ è¿›<strong>AuthenticationManagerBuilder</strong>ä¸­çš„<strong>configures</strong>å, å°±ä¼šå»æ‰§è¡Œ<strong>build</strong>æ–¹æ³•å»åˆå§‹åŒ–è¿˜æœ‰é…ç½®äº†, æœ€åæ„å»ºå‡ºå…¨å±€çš„<strong>AuthenticationManager</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬è¯¦ç»†è¯´ä¸‹<strong>InitializeAuthenticationProviderBeanManagerConfigurer</strong>è¿™ä¸ªé…ç½®æ˜¯å¦‚ä½•åˆå§‹åŒ–å’Œé…ç½®å‡ºå…¨å±€çš„<strong>AuthenticationManager</strong>çš„, å½“æ‰§è¡Œåˆ°<strong>AuthenticationConfiguration#getAuthenticationManager</strong>çš„<strong>authBuilder.build()<strong>å°±ä¼šå¼€å§‹æ„å»ºå…¨å±€çš„</strong>AuthenticationManager</strong>, æˆ‘ä»¬çœ‹ä¸‹åœ¨åˆå§‹åŒ–å’Œé…ç½®é€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		auth.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeAuthenticationProviderManagerConfigurer</span>());<br>	&#125;<br><br>	<span class="hljs-keyword">class</span> <span class="hljs-title class_">InitializeAuthenticationProviderManagerConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GlobalAuthenticationConfigurerAdapter</span> &#123;<br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> &#123;<br>			<span class="hljs-keyword">if</span> (auth.isConfigured()) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-type">AuthenticationProvider</span> <span class="hljs-variable">authenticationProvider</span> <span class="hljs-operator">=</span> getBeanOrNull(AuthenticationProvider.class);<br>			<span class="hljs-keyword">if</span> (authenticationProvider == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			auth.authenticationProvider(authenticationProvider);<br>		&#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><strong>init</strong>æ–¹æ³•å°±æ˜¯å°†<strong>InitializeAuthenticationProviderManagerConfigurer</strong>é…ç½®åˆæ·»åŠ åˆ°äº†<strong>AuthenticationManagerBuilder</strong>ä¸­</p>
</li>
<li><p>è€Œ<strong>configure</strong>æ–¹æ³•åˆ™æ˜¯:</p>
<ul>
<li><p>å…ˆåˆ¤æ–­è¯¥<strong>AuthenticationManagerBuilder</strong>æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡é…ç½®, ä¿è¯åªä¼šé…ç½®ä¸€æ¬¡</p>
</li>
<li><p>åœ¨ä»Springä¸­è·å–å…¨å±€çš„<strong>AuthenticationProvider</strong>, å¦‚æœæˆ‘ä»¬æœ‰è‡ªå®šä¹‰<strong>AuthenticationProvider</strong>å°±ä¼šæ·»åŠ åˆ°<strong>AuthenticationManagerBuilder</strong>ä¸­çš„<strong>authenticationProviders</strong></p>
</li>
</ul>
</li>
</ul>
<p>ç®€å•æ¥è¯´, ä¸»è¦çœ‹æ²¡æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>AuthenticationProvider</strong>æœ‰å°±æ”¾åˆ°å…¨å±€<strong>AuthenticationManagerBuilder</strong>çš„<strong>authenticationProvider</strong>ä¸­, è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±æ³¨å…¥ä¸€ä¸ª<strong>AuthenticationProvider</strong></p>
<h4 id="å…¨å±€UserDetailsServiceåˆå§‹åŒ–åˆ†æ"><a href="#å…¨å±€UserDetailsServiceåˆå§‹åŒ–åˆ†æ" class="headerlink" title="å…¨å±€UserDetailsServiceåˆå§‹åŒ–åˆ†æ"></a>å…¨å±€UserDetailsServiceåˆå§‹åŒ–åˆ†æ</h4><p>å…¨å±€<strong>UserDetailsService</strong>æ˜¯ç”±æ·»åŠ åˆ°<strong>AuthenticationManagerBuilder</strong>ä¸­çš„<strong>configures</strong>çš„<strong>InitializeUserDetailsBeanManagerConfigurer</strong>æ¥è¿›è¡Œåˆå§‹åŒ–é…ç½®çš„, æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹å…·ä½“é€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Order(InitializeUserDetailsBeanManagerConfigurer.DEFAULT_ORDER)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">InitializeUserDetailsBeanManagerConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GlobalAuthenticationConfigurerAdapter</span> &#123;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		auth.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InitializeUserDetailsManagerConfigurer</span>());<br>	&#125;<br><br>	<span class="hljs-keyword">class</span> <span class="hljs-title class_">InitializeUserDetailsManagerConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GlobalAuthenticationConfigurerAdapter</span> &#123;<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>			<span class="hljs-keyword">if</span> (auth.isConfigured()) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-type">UserDetailsService</span> <span class="hljs-variable">userDetailsService</span> <span class="hljs-operator">=</span> getBeanOrNull(UserDetailsService.class);<br>			<span class="hljs-keyword">if</span> (userDetailsService == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-type">PasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> getBeanOrNull(PasswordEncoder.class);<br>			<span class="hljs-type">UserDetailsPasswordService</span> <span class="hljs-variable">passwordManager</span> <span class="hljs-operator">=</span> getBeanOrNull(UserDetailsPasswordService.class);<br>			<span class="hljs-type">DaoAuthenticationProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationProvider</span>();<br>			provider.setUserDetailsService(userDetailsService);<br>			<span class="hljs-keyword">if</span> (passwordEncoder != <span class="hljs-literal">null</span>) &#123;<br>				provider.setPasswordEncoder(passwordEncoder);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (passwordManager != <span class="hljs-literal">null</span>) &#123;<br>				provider.setUserDetailsPasswordService(passwordManager);<br>			&#125;<br>			provider.afterPropertiesSet();<br>			auth.authenticationProvider(provider);<br>		&#125;<br><br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * <span class="hljs-doctag">@return</span> a bean of the requested class if there&#x27;s just a single registered</span><br><span class="hljs-comment">		 * component, null otherwise.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">getBeanOrNull</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>			String[] beanNames = InitializeUserDetailsBeanManagerConfigurer.<span class="hljs-built_in">this</span>.context.getBeanNamesForType(type);<br>			<span class="hljs-keyword">if</span> (beanNames.length != <span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>			&#125;<br>			<span class="hljs-keyword">return</span> InitializeUserDetailsBeanManagerConfigurer.<span class="hljs-built_in">this</span>.context.getBean(beanNames[<span class="hljs-number">0</span>], type);<br>		&#125;<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>init</strong>æ–¹æ³•çš„è®¾è®¡å’Œ<strong>InitializeAuthenticationProviderManagerConfigurer</strong>æ˜¯ä¸€æ ·çš„</li>
<li><strong>configure</strong>çš„ä¸»è¦é€»è¾‘ä¸º:<ul>
<li>å…ˆåˆ¤æ–­è¯¥<strong>AuthenticationManagerBuilder</strong>æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡é…ç½®, ä¿è¯åªä¼šé…ç½®ä¸€æ¬¡</li>
<li>ä»Springå»æ‹¿æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>UserDetailsService</strong>ã€<strong>PasswordEncoder</strong>, å¦‚æœæœ‰åˆ™å°è£…ä¸ºä¸€ä¸ª<strong>DaoAuthenticationProvider</strong>å¯¹è±¡å†æ·»åŠ åˆ°<strong>AuthenticationManagerBuilder</strong>ä¸­çš„<strong>authenticationProviders</strong>ä¸­.</li>
</ul>
</li>
</ul>
<p>è¿™å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>UserDetailsService</strong>ã€<strong>PasswordEncoder</strong>æ˜¯å¦‚ä½•è¢«æ·»åŠ åˆ°å…¨å±€çš„<strong>AuthenticationManager</strong>çš„</p>
<p>â€‹	çœ‹å®Œäº†<strong>InitializeAuthenticationProviderManagerConfigurer#configure</strong>æ·»åŠ è‡ªå®šä¹‰<strong>AuthenticationProvider</strong>ä»¥åŠ<strong>InitializeUserDetailsBeanManagerConfigurer#configure</strong>æ·»åŠ è‡ªå®šä¹‰<strong>userDetailsService</strong>, æˆ‘ä»¬å†æ¥çœ‹ä¸‹<strong>AuthenticationManagerBuilder</strong>æ„å»ºè¿‡ç¨‹#<strong>performBuild</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> ProviderManager <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	<span class="hljs-keyword">if</span> (!isConfigured()) &#123;<br>		<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br>	<span class="hljs-type">ProviderManager</span> <span class="hljs-variable">providerManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(<span class="hljs-built_in">this</span>.authenticationProviders,<br>			<span class="hljs-built_in">this</span>.parentAuthenticationManager);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eraseCredentials != <span class="hljs-literal">null</span>) &#123;<br>		providerManager.setEraseCredentialsAfterAuthentication(<span class="hljs-built_in">this</span>.eraseCredentials);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eventPublisher != <span class="hljs-literal">null</span>) &#123;<br>		providerManager.setAuthenticationEventPublisher(<span class="hljs-built_in">this</span>.eventPublisher);<br>	&#125;<br>	providerManager = postProcess(providerManager);<br>	<span class="hljs-keyword">return</span> providerManager;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å…ˆåˆ¤æ–­è¯¥<strong>AuthenticationManagerBuilder</strong>æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ„å»º, ä¿è¯åªä¼šæ„å»ºä¸€æ¬¡</li>
<li>ç›´æ¥å°è£…ä¸€ä¸ª<strong>ProviderManager</strong>ç„¶åè°ƒç”¨<strong>postProcess</strong>æ¥æ³¨å…¥å®¹å™¨</li>
</ul>
<p>è¿™æ ·æ³¨å…¥å…¨å±€<strong>AuthenticationManager</strong>è¿‡ç¨‹ä¹Ÿå°±æ˜¯<strong>AuthenticationManager#getAuthenticationManager</strong>å°±ç»“æŸ.</p>
<p>â€‹	 æˆ‘ä»¬å†å›åˆ°<strong>HttpSecurityConfiguration#httpSecurity</strong>æ–¹æ³•ä¸­æ¥, å†å›å¿†ä¸‹ä¹‹å‰çš„æ“ä½œ: </p>
<ol>
<li><strong>new</strong>äº†ä¸€ä¸ª<strong>AuthenticationManagerBuilder</strong>,</li>
<li>è°ƒç”¨<strong>AuthenticationConfiguration#getAuthenticationManager</strong>æ–¹æ³•ç›´æ¥æ„å»ºäº†ä¸€ä¸ª<strong>å…¨å±€çš„AuthenticationManager</strong>, å¹¶æŠŠè¿™ä¸ª<strong>å…¨å±€AuthenticationManager</strong>è®¾ç½®ä¸ºäº†æˆ‘ä»¬<strong>new</strong>å‡ºçš„<strong>AuthenticationManagerBuilder</strong>çš„<strong>parentAuthenticationManager</strong>,</li>
<li><strong>new HttpSecurity()</strong>: å¹¶å°†è¿™ä¸ª<strong>AuthenticationManagerBuilder</strong>è®¾ç½®åˆ°<strong>shareObjects</strong></li>
</ol>
<p>â€‹	åé¢å°±æ˜¯æ·»åŠ ä¸€äº›é»˜è®¤é…ç½®åˆ°<strong>HttpSecurity</strong>, åˆ°æ­¤<strong>HttpSecurityConfiguration#httpSecurity</strong>å°±ç»“æŸäº†.å†å›åˆ°æˆ‘ä»¬è‡ªå®šä¹‰<strong>SecurityFilterChain</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>   http.authorizeHttpRequests()<br>       .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>       .anyRequest().authenticated()<br>       .and().formLogin()<br>       .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;UsernamePasswordAuthenticationFilter&gt;() &#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> &#123;<br>           <span class="hljs-comment">//è‡ªå®šä¹‰ObjectPostProcessor</span><br>           object.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>           object.setPasswordParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>           object.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;<br>             response.getWriter().write(<span class="hljs-string">&quot;login success&quot;</span>);<br>           &#125;);<br>           <span class="hljs-keyword">return</span> object;<br>         &#125;<br>       &#125;)<br>       .and().userDetailsService(userDetailService())<br>       .csrf().disable();<br><br>   <span class="hljs-keyword">return</span> http.build();<br> &#125;<br></code></pre></td></tr></table></figure>

<p>é…ç½®é€»è¾‘å¾ˆç®€å•, åŸºæœ¬éƒ½æ˜¯å¾€<strong>HttpSecurity</strong>çš„<strong>configures</strong>è¿›è¡Œé…ç½®, ç„¶å<strong>build</strong>æ„å»º<strong>SecurityFilterChain</strong>, æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹è¿™ä¸ª<strong>build</strong>ä¸­çš„<strong>doBuild</strong>æ–¹æ³•: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	<span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.configurers) &#123;<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.INITIALIZING;<br>		beforeInit();<br>		init();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.CONFIGURING;<br>		beforeConfigure();<br>		configure();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.BUILDING;<br>		<span class="hljs-type">O</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> performBuild();<br>		<span class="hljs-built_in">this</span>.buildState = BuildState.BUILT;<br>		<span class="hljs-keyword">return</span> result;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯åˆå§‹åŒ–å’Œé…ç½®å„ç§ä¹‹å‰<strong>HttpSecurityConfiguration#httpSecurity</strong>æ·»åŠ æˆ–è€…æˆ‘ä»¬è‡ªå®šä¹‰æ·»åŠ çš„<strong>xxxConfigurer</strong> .</p>
<p>è¿™é‡Œæˆ‘ä»¬æä¸‹åœ¨<strong>HttpSecurityConfiguration#httpSecurity</strong>æ·»åŠ äº†<strong>AnonymousConfigurer</strong>, æˆ‘ä»¬çœ‹ä¸‹<strong>init</strong>ã€<strong>configure</strong>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(H http)</span> &#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationProvider == <span class="hljs-literal">null</span>) &#123;<br>		<span class="hljs-built_in">this</span>.authenticationProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousAuthenticationProvider</span>(getKey());<br>	&#125;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationFilter == <span class="hljs-literal">null</span>) &#123;<br>		<span class="hljs-built_in">this</span>.authenticationFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousAuthenticationFilter</span>(getKey(), <span class="hljs-built_in">this</span>.principal, <span class="hljs-built_in">this</span>.authorities);<br>	&#125;<br>	<span class="hljs-built_in">this</span>.authenticationProvider = postProcess(<span class="hljs-built_in">this</span>.authenticationProvider);<br>	http.authenticationProvider(<span class="hljs-built_in">this</span>.authenticationProvider);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(H http)</span> &#123;<br>	<span class="hljs-built_in">this</span>.authenticationFilter.afterPropertiesSet();<br>	http.addFilter(<span class="hljs-built_in">this</span>.authenticationFilter);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>init</strong>æ–¹æ³•ä¼šå°†åˆå§‹åŒ–ä¸€ä¸ª<strong>AnonymousAuthenticationProvider</strong>å¹¶æ·»åŠ ç»™æˆ‘ä»¬ä¹‹å‰è®¾ç½®åˆ°<strong>shareObjects</strong>çš„<strong>AuthenticationProviderBuilder</strong>ä¸­çš„<strong>authenticationProviders</strong>ä¸­</li>
<li><strong>configure</strong>æ–¹æ³•åˆ™æ˜¯å°†è¿‡æ»¤å™¨æ·»åŠ åˆ°<strong>HttpSecurity</strong>çš„<strong>filters</strong></li>
</ul>
<p><span style="color:red;">è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆé»˜è®¤<strong>HttpSecurity</strong>ä¸­çš„<strong>authenticationManager</strong>æœ‰ä¸ª<strong>AnonymousAuthenticationProvider</strong></span></p>
<h4 id="è‡ªå®šä¹‰AuthenticationManagerè¦†ç›–å…¨å±€AuthenticationManager"><a href="#è‡ªå®šä¹‰AuthenticationManagerè¦†ç›–å…¨å±€AuthenticationManager" class="headerlink" title="è‡ªå®šä¹‰AuthenticationManagerè¦†ç›–å…¨å±€AuthenticationManager"></a>è‡ªå®šä¹‰AuthenticationManagerè¦†ç›–å…¨å±€AuthenticationManager</h4><blockquote>
<p>HttpSecurityä¸­AuthenticationManagerBuilderæ„å»ºæ—¶æœº</p>
</blockquote>
<p>æˆ‘ä»¬æ ¹æ®æµç¨‹çŸ¥é“: ä¹‹å‰å·²ç»åˆå§‹åŒ–äº†å…¨å±€çš„<strong>AuthenticationManager</strong>å¹¶ä½œä¸º<strong>parent</strong>è®¾ç½®åˆ°<strong>HttpSecurity</strong>ä¸­çš„<strong>authenticationManagerBuilder</strong>ä¸­, å¹¶æŠŠè¿™ä¸ª<strong>authenticationManagerBuilder</strong>æ”¾åˆ°äº†<strong>HttpSecurity</strong>ä¸­çš„<strong>shareObjects</strong>ä¸­.</p>
<p>ä½†ä¸€ç›´æ²¡ç»™è¿™ä¸ª<strong>HttpSecurity</strong>çš„<strong>authenticationManager</strong>æ„å»º, é‚£å…¶å®è¿™ä¸ªæ„å»ºæ˜¯åœ¨<strong>HttpSecurity#build#doBuild#beforeConfigure</strong>ä¸­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpSecurity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;<br>		<span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt;, HttpSecurityBuilder&lt;HttpSecurity&gt; &#123;<br>  <br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeConfigure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationManager != <span class="hljs-literal">null</span>) &#123;<br>			setSharedObject(AuthenticationManager.class, <span class="hljs-built_in">this</span>.authenticationManager);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			setSharedObject(AuthenticationManager.class, getAuthenticationRegistry().build());<br>		&#125;<br>	&#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>è¿™ä¸ªæ–¹æ³•å¤§ä½“é€»è¾‘æ˜¯å¦‚æœæœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>AuthenticationManager</strong>, å°±ç›´æ¥ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¥è¦†ç›–å…¨å±€çš„,å¹¶è®¾ç½®åˆ°<strong>shareObjects</strong>é‡Œé¢</li>
<li>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„å°±ç”¨æˆ‘ä»¬åœ¨<strong>HttpSecurityConfiguration#httpSecurity</strong>æ„å»ºçš„<strong>AuthenticationManagerBuilder</strong>, æ„å»ºå‡º<strong>AuthenticationManager</strong>,å¹¶è®¾ç½®åˆ°<strong>shareObjects</strong>é‡Œé¢</li>
</ul>
<blockquote>
<p>è‡ªå®šä¹‰AuthenticationManager</p>
</blockquote>
<p><strong>HttpSecurity</strong>å·²ç»æä¾›ç»™äº†æ–¹æ³•æ¥è¦†ç›–å…¨å±€çš„<strong>AuthenticationManager</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> &#123;<br>		Assert.notNull(authenticationManager, <span class="hljs-string">&quot;authenticationManager cannot be null&quot;</span>);<br>		<span class="hljs-built_in">this</span>.authenticationManager = authenticationManager;<br>		<span class="hljs-keyword">return</span> HttpSecurity.<span class="hljs-built_in">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

















<h2 id="4-4-è¿‡æ»¤å™¨é“¾åˆå§‹åŒ–åˆ†æ"><a href="#4-4-è¿‡æ»¤å™¨é“¾åˆå§‹åŒ–åˆ†æ" class="headerlink" title="4.4 è¿‡æ»¤å™¨é“¾åˆå§‹åŒ–åˆ†æ"></a>4.4 è¿‡æ»¤å™¨é“¾åˆå§‹åŒ–åˆ†æ</h2><p>åœ¨ä»‹ç»SpringSecurityè¿‡æ»¤å™¨é“¾ä¹Ÿå°±æ˜¯<strong>FilterChainProxy</strong>æ˜¯å¦‚ä½•åˆå§‹åŒ–ä¹‹å‰, æˆ‘ä»¬åº”è¯¥å…ˆè¦äº†è§£ä¸‹<strong>WebSecurityConfigurer</strong>ã€<strong>WebSecurityConfigurerAdapter</strong></p>
<h3 id="4-4-1-WebSecurityConfigurer"><a href="#4-4-1-WebSecurityConfigurer" class="headerlink" title="4.4.1 WebSecurityConfigurer"></a>4.4.1 WebSecurityConfigurer</h3><p>â€‹	<strong>WebSecurityConfigurer</strong>æ˜¯ä¸€ä¸ªç©ºæ¥å£, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è‡ªå®šä¹‰<strong>WebSecurity</strong>. <strong>WebSecurityConfigurer</strong> åªæœ‰ä¸€ä¸ªå®ç°ç±»å°±æ˜¯<strong>WebSecurityConfigurerAdpter</strong>, åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹, å¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿<strong>WebSecurityConfigurerAdapter</strong>æ¥å®ç°<strong>WebSecurity</strong>çš„è‡ªå®šä¹‰é…ç½®</p>
<h3 id="4-4-2-WebSecurityConfigurerAdapter"><a href="#4-4-2-WebSecurityConfigurerAdapter" class="headerlink" title="4.4.2 WebSecurityConfigurerAdapter"></a>4.4.2 WebSecurityConfigurerAdapter</h3><p>â€‹	<strong>WebSecurityConfigurerAdapter</strong>æ˜¯ä¸€ä¸ªå¯ä»¥æ–¹ä¾¿åˆ›å»º<strong>WebSecurityConfigurer</strong>å®ä¾‹çš„åŸºç±», å¼€å‘è€…å¯ä»¥é€šè¿‡è¦†ç›–<strong>WebSecurityConfigurerAdapter</strong>ä¸­çš„æ–¹æ³•å®Œæˆå¯¹<strong>HttpSecurity</strong>å’Œ<strong>WebSecurity</strong>çš„å®šåˆ¶. åé¢éƒ½æ˜¯é€šè¿‡è‡ªå®šä¹‰<strong>WebSecurityConfigurerAdapter</strong>æ¥å®ç°çš„</p>
<p>â€‹	åœ¨<strong>WebSecurityConfigurerAdapter</strong>ä¸­å£°æ˜äº†ä¸¤ä¸ª<strong>AuthenticationManagerBuilder</strong>å¯¹è±¡ç”¨æ¥æ„å»º<strong>AuthenticationManager</strong>: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> AuthenticationManagerBuilder authenticationBuilder;<br><span class="hljs-keyword">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBuilder;<br></code></pre></td></tr></table></figure>

<p>â€‹	å…¶ä¸­, <strong>localConfigureAuthenticationBuilder</strong>å¯¹è±¡è´Ÿè´£æ„å»ºå…¨å±€çš„<strong>AuthenticationManager</strong>, è€Œ<strong>authenticationBuilder</strong>åˆ™è´Ÿè´£æ„å»ºå±€éƒ¨çš„<strong>AuthenticationManager</strong>. å±€éƒ¨çš„<strong>AuthenticationManager</strong>æ˜¯å’Œæ¯ä¸€ä¸ª<strong>HttpSecurity</strong>å¯¹è±¡ç»‘å®šçš„, è€Œå…¨å±€çš„<strong>AuthenticationManager</strong>å¯¹è±¡åˆ™æ˜¯æ‰€æœ‰å±€éƒ¨<strong>AuthenticationManager</strong>çš„<strong>parent</strong>. </p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯:  </p>
<ul>
<li><strong>localConfigurerAuthenticationBuilder</strong>å¹¶éæ€»æ˜¯æœ‰ç”¨çš„, åœ¨å¼€å‘è€…æ²¡æœ‰é‡å†™<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•çš„æƒ…å†µä¸‹, å…¨å±€çš„</strong>AuthenticationManager</strong>å¯¹è±¡æ˜¯ç”±<strong>AuthenticationConfiguration</strong>ç±»ä¸­çš„<strong>getAuthenticationManager</strong>æ–¹æ³•æä¾›çš„</li>
<li>å¦‚æœç”¨æˆ·é‡å†™äº†<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•, åˆ™å…¨å±€çš„</strong>AuthenticationManager</strong>å°±ç”±<strong>localConfigureAuthenticationBuilder</strong>è´Ÿè´£æ„å»º.</li>
</ul>
<p>â€‹	<strong>WebSecurityConfigurerAdapter</strong>ç±»çš„åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java">	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1. åœ¨initæ–¹æ³•ä¸­, é¦–å…ˆè°ƒç”¨getHttpæ–¹æ³•è·å–ä¸€ä¸ªHttpSecurityå®ä¾‹, å¹¶å°†è·å–åˆ°å®ä¾‹æ·»åŠ åˆ°WebSecurityå¯¹è±¡ä¸­, å†ç”±WebSecurityå¯¹è±¡è¿›è¡Œæ„å»º</span><br>		<span class="hljs-type">HttpSecurity</span> <span class="hljs-variable">http</span> <span class="hljs-operator">=</span> getHttp();<br>		web.addSecurityFilterChainBuilder(http).postBuildAction(() -&gt; &#123;<br>			<span class="hljs-type">FilterSecurityInterceptor</span> <span class="hljs-variable">securityInterceptor</span> <span class="hljs-operator">=</span> http.getSharedObject(FilterSecurityInterceptor.class);<br>			web.securityInterceptor(securityInterceptor);<br>		&#125;);<br>	&#125;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> HttpSecurity <span class="hljs-title function_">getHttp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>   <span class="hljs-comment">//2. åœ¨getHttpæ–¹æ³•ä¸­, å¦‚æœHttpå¯¹è±¡å·²ç»åˆå§‹åŒ–, åˆ™ç›´æ¥è¿”å›, å¦åˆ™è¿›è¡Œåˆå§‹åŒ–æ“ä½œ. åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­, ç»™localConfigureAuthenticationBldrè®¾ç½®äº‹ä»¶å‘å¸ƒå™¨, å¹¶è°ƒç”¨authenticationManageræ–¹æ³•è·å–å…¨å±€çš„AuthenticationManagerå¯¹è±¡</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.http != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.http;<br>		&#125;<br>		<span class="hljs-type">AuthenticationEventPublisher</span> <span class="hljs-variable">eventPublisher</span> <span class="hljs-operator">=</span> getAuthenticationEventPublisher();<br>		<span class="hljs-built_in">this</span>.localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher);<br>  <br>   <span class="hljs-comment">//3. åœ¨authenticationManageræ–¹æ³•ä¸­, å¦‚æœå…¨å±€çš„AuthenticationManagerå¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–,åˆ™å…ˆè°ƒç”¨configureæ–¹æ³•, è¯¥æ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•, å°±æ˜¯å°†disableLocalConfigure AuthenticationBldrå˜é‡ç”±falseå˜ä¸ºtrue, æ¥ä¸‹æ¥å°±ä¼šè¿›å…¥åˆ°authenticationManageræ–¹æ³•çš„ifåˆ†æ”¯ä¸­,é€šè¿‡è°ƒç”¨authenticationConfiguration.getAuthenticationManager()æ–¹æ³•è·å–å…¨å±€çš„AuthenticationManagerå¯¹è±¡å¹¶è¿”å›.å¦‚æœå¼€å‘è€…è‡ªå·±é‡å†™äº†configure(AuthenticationManager Builder)æ–¹æ³•, åˆ™disableLocalConfigureAuthenticationBldrå˜é‡å°±ä¸€ç›´æ˜¯false, æ²¡æœ‰æœºä¼šå˜ä¸ºtrue, è¿™æ ·å°±ä¼šè¿›å…¥åˆ°elseåˆ†æ”¯ä¸­, é€šè¿‡localConfigureAuthenticationBldrå˜é‡æ¥æ„å»ºauthenticationManagerå¯¹è±¡</span><br>		<span class="hljs-type">AuthenticationManager</span> <span class="hljs-variable">authenticationManager</span> <span class="hljs-operator">=</span> authenticationManager();<br>  <br>   <span class="hljs-comment">//4. å†æ¬¡å›åˆ°getHttpæ–¹æ³•ä¸­, è·å–åˆ°å…¨å±€çš„authenticationManagerå¯¹è±¡ä¹‹å, è®¾ç½®ç»™authenticationBuilder, ç„¶ååˆ›å»ºä¸€ä¸ªHttpSecurityå®ä¾‹å‡ºæ¥, å¹¶ä¸ºå…¶é…ç½®ä¸Šé»˜è®¤çš„è¿‡æ»¤å™¨. é»˜è®¤çš„é…ç½®å®Œæˆå, è°ƒç”¨configure(HttpSecurity)æ–¹æ³•è¿›è¡Œæ‰©å±•é…ç½®, WebSecurityConfigurerAdapterä¸­å¯¹configure(HttpSecurity)æ–¹æ³•æä¾›äº†é»˜è®¤çš„å®ç°, å¼€å‘è€…ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è¯¥æ–¹æ³•</span><br>		<span class="hljs-built_in">this</span>.authenticationBuilder.parentAuthenticationManager(authenticationManager);<br>		Map&lt;Class&lt;?&gt;, Object&gt; sharedObjects = createSharedObjects();<br>  	<span class="hljs-comment">//å°†this.authenticationBuilderè®¾ç½®åˆ°this.sharedObjects</span><br>		<span class="hljs-built_in">this</span>.http = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSecurity</span>(<span class="hljs-built_in">this</span>.objectPostProcessor, <span class="hljs-built_in">this</span>.authenticationBuilder, sharedObjects);<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.disableDefaults) &#123;<br>      <span class="hljs-comment">//è¿™é‡Œæ˜¯åœ¨å¾€HttpSecurityçš„configurersé›†åˆæ·»åŠ å„ç§xxxConfigurer</span><br>			http.csrf();<br>			http.addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAsyncManagerIntegrationFilter</span>());<br>			http.exceptionHandling();<br>			http.headers();<br>			http.sessionManagement();<br>			http.securityContext();<br>			http.requestCache();<br>			http.anonymous();<br>			http.servletApi();<br>			http.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLoginPageConfigurer</span>&lt;&gt;());<br>			http.logout();<br>      <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.context.getClassLoader();<br>			List&lt;AbstractHttpConfigurer&gt; defaultHttpConfigurers = SpringFactoriesLoader<br>					.loadFactories(AbstractHttpConfigurer.class, classLoader);<br>			<span class="hljs-keyword">for</span> (AbstractHttpConfigurer configurer : defaultHttpConfigurers) &#123;<br>				<span class="hljs-built_in">this</span>.http.apply(configurer);<br>			&#125;<br>		&#125;<br>		configure(<span class="hljs-built_in">this</span>.http);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.http;<br>	&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-built_in">this</span>.disableLocalConfigureAuthenticationBldr = <span class="hljs-literal">true</span>;<br>	&#125;<br><br><span class="hljs-keyword">protected</span> AuthenticationManager <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.authenticationManagerInitialized) &#123;<br>			configure(<span class="hljs-built_in">this</span>.localConfigureAuthenticationBldr);<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.disableLocalConfigureAuthenticationBldr) &#123;<br>				<span class="hljs-built_in">this</span>.authenticationManager = <span class="hljs-built_in">this</span>.authenticationConfiguration.getAuthenticationManager();<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-built_in">this</span>.authenticationManager = <span class="hljs-built_in">this</span>.localConfigureAuthenticationBldr.build();<br>			&#125;<br>			<span class="hljs-built_in">this</span>.authenticationManagerInitialized = <span class="hljs-literal">true</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authenticationManager;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™å°±æ˜¯<strong>WebSecurityConfigurerAdapter</strong>çš„åˆå§‹åŒ–æ–¹æ³•, å…¶å®å°±æ˜¯åˆ›å»ºå¹¶é…ç½®ä¸€ä¸ª<strong>HttpSecurity</strong>å®ä¾‹, ä¹‹åæ·»åŠ åˆ°<strong>WebSecurity</strong>ä¸­</p>
<p>â€‹	<strong>WebSecurityConfigurerAdapter</strong>ä¸­çš„<strong>configure</strong>æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•, å¯ä»¥ç”¨æ¥é…ç½®<strong>WebSecurity</strong>, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	</p>
<p>â€‹	ä¸€èˆ¬æ¥è¯´, å¦‚æœæˆ‘ä»¬æœ‰ä¸€äº›é™æ€èµ„æºä¸éœ€è¦ç»è¿‡SpringSecurityè¿‡æ»¤å™¨, å°±å¯ä»¥é€šè¿‡é‡å†™è¯¥æ–¹æ³•æ¥å®ç°.</p>
<p>â€‹	è‡³æ­¤, åœ¨SpringSecurityåˆå§‹åŒ–è¿‡ç¨‹ä¸­, å‡ ä¸ªé‡è¦çš„ç»„ä»¶éƒ½ä»‹ç»å®Œäº†, ä½†æ˜¯å‡ºç°äº†ä¸€ä¸ªé—®é¢˜: <strong>WebSecurityConfigurerAdapter</strong>è¿™ä¸ªç±»çš„<strong>initã€configure</strong>æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„? åº”è¯¥ä½œä¸ºé‚£ä¸ªç±»çš„é…ç½®ç±»æ¥åˆå§‹åŒ–å’Œé…ç½®? åé¢<strong>WebSecurityConfiguration</strong>çš„ä»‹ç»ä¼šæç„¶å¤§æ‚Ÿ</p>
<h3 id="4-4-3-åˆå§‹åŒ–åˆ†æ"><a href="#4-4-3-åˆå§‹åŒ–åˆ†æ" class="headerlink" title="4.4.3 åˆå§‹åŒ–åˆ†æ"></a>4.4.3 åˆå§‹åŒ–åˆ†æ</h3><p>â€‹	åœ¨SpringBootä¸­ä½¿ç”¨SpringSecurity, åˆå§‹åŒ–å°±ä»SpringSecurityçš„è‡ªåŠ¨åŒ–é…ç½®ç±»å¼€å§‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AutoConfiguration</span><br><span class="hljs-meta">@ConditionalOnClass(DefaultAuthenticationEventPublisher.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(SecurityProperties.class)</span><br><span class="hljs-meta">@Import(&#123; SpringBootWebSecurityConfiguration.class, SecurityDataConfiguration.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityAutoConfiguration</span> &#123;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-meta">@ConditionalOnMissingBean(AuthenticationEventPublisher.class)</span><br>	<span class="hljs-keyword">public</span> DefaultAuthenticationEventPublisher <span class="hljs-title function_">authenticationEventPublisher</span><span class="hljs-params">(ApplicationEventPublisher publisher)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAuthenticationEventPublisher</span>(publisher);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, åœ¨è‡ªåŠ¨åŒ–é…ç½®ç±»<strong>SecurityAutoConfiguration</strong>ä¸­, æœ€é‡è¦çš„å°±æ˜¯å¯¼å…¥äº†ä¸‰ä¸ªé…ç½®ç±», å¹¶ä¸”å®šä¹‰äº†é»˜è®¤çš„äº‹ä»¶å‘å¸ƒå™¨</p>
<p>â€‹	å¯¼å…¥çš„ä¸‰ä¸ªé…ç½®ç±»ä¸­, <strong>SpringBootWebSecurityConfiguration</strong>çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨å¼€å‘è€…æ²¡æœ‰æä¾›<strong>WebSecurityConfigurerAdapter</strong>å®ä¾‹çš„æƒ…å†µä¸‹, ç”±å…¶è´Ÿè´£æä¾›ä¸€ä¸ªé»˜è®¤çš„<strong>SecuriyFilterChain</strong>å®ä¾‹, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br>	<span class="hljs-meta">@ConditionalOnDefaultWebSecurity</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityFilterChainConfiguration</span> &#123;<br><br>		<span class="hljs-meta">@Bean</span><br>		<span class="hljs-meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span><br>		SecurityFilterChain <span class="hljs-title function_">defaultSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>			http.authorizeRequests().anyRequest().authenticated();<br>			http.formLogin();<br>			http.httpBasic();<br>			<span class="hljs-keyword">return</span> http.build();<br>		&#125;<br><br>	&#125;<br></code></pre></td></tr></table></figure>



<p>å¦ä¸€ä¸ªå¯¼å…¥çš„é…ç½®ç±»<strong>SecurityDataConfiguration</strong>ä¸»è¦æä¾›äº†ä¸€ä¸ª<strong>SecurityEvaluationContextExtension</strong>å®ä¾‹, ä»¥ä¾¿é€šè¿‡SpELä¸ºç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æä¾›æ•°æ®æŸ¥è¯¢:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnClass(SecurityEvaluationContextExtension.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityDataConfiguration</span> &#123;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-meta">@ConditionalOnMissingBean</span><br>	<span class="hljs-keyword">public</span> SecurityEvaluationContextExtension <span class="hljs-title function_">securityEvaluationContextExtension</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityEvaluationContextExtension</span>();<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><span style="color:red;">æœ€åä¸€ä¸ªå¯¼å…¥çš„é…ç½®ç±»<strong>WebSecurityEnablerConfiguration</strong>åˆ™æ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹:</span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(name = BeanIds.SPRING_SECURITY_FILTER_CHAIN)</span><br><span class="hljs-meta">@ConditionalOnClass(EnableWebSecurity.class)</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityEnablerConfiguration</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<strong>WebSecurityEnablerConfiguration</strong>é…ç½®ç±»ä¸­æ·»åŠ äº†@<strong>EnableWebSecurity</strong>æ³¨è§£, è€Œè¯¥æ³¨è§£çš„å®šä¹‰, å¼•å…¥äº†å…³é”®çš„é…ç½®ç±»<strong>WebSecurityConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123; WebSecurityConfiguration.class, SpringWebMvcImportSelector.class, OAuth2ImportSelector.class,</span><br><span class="hljs-meta">		HttpSecurityConfiguration.class &#125;)</span><br><span class="hljs-meta">@EnableGlobalAuthentication</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableWebSecurity &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Controls debugging support for Spring Security. Default is false.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> if true, enables debug support with Spring Security</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°, @<strong>EnableWebSecurity</strong>æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£, é¦–å…ˆå¯¼å…¥äº†ä¸‰ä¸ªé…ç½®ç±»:</p>
<ul>
<li><strong>WebSecurityConfiguration</strong>: ç”¨æ¥é…ç½®<strong>WebSecurity</strong></li>
<li><strong>SpringWebMvcImportSelector</strong>: åˆ¤æ–­å½“å‰ç¯å¢ƒæ˜¯å¦å­˜åœ¨Spring MVC , å¦‚æœå­˜åœ¨,åˆ™å¼•å…¥ç›¸å…³é…ç½®</li>
<li><strong>OAuth2ImportSelector</strong>: åˆ¤æ–­å½“å‰ç¯å¢ƒæ˜¯å¦å­˜åœ¨OAuth2, å¦‚æœå­˜åœ¨, åˆ™å¼•å…¥ç›¸å…³é…ç½®</li>
<li><strong>HttpSecurityConfiguration</strong>: ç”¨æ¥é…ç½®<strong>HttpSecurity</strong></li>
</ul>
<p>â€‹	å¦å¤–è¿˜æœ‰ä¸€ä¸ª@<strong>EnableGlobalAuthentication</strong>æ³¨è§£, ç”¨æ¥å¼€å¯å…¨å±€é…ç½®, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(AuthenticationConfiguration.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableGlobalAuthentication &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>â€‹	å¯ä»¥çœ‹åˆ°, @<strong>EnableGlobalAuthentication</strong>æ³¨è§£çš„ä¸»è¦åŠŸèƒ½æ˜¯å¯¼å…¥äº†é…ç½®ç±»<strong>AuthenticationConfiguration</strong></p>
<p>â€‹	ä»ä¸Šé¢çš„æºç ,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, <strong>SpringSecurity</strong>çš„è‡ªåŠ¨åŒ–é…ç½®ç±»ä¸»è¦å¯¼å…¥äº†ä¸¤ä¸ªç±»: <strong>WebSecurityConfiguration</strong>å’Œ<strong>AuthenticationConfiguration</strong>. æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æä¸‹<strong>WebSecurityConfiguration</strong></p>
<h5 id="WebSecurityConfiguration"><a href="#WebSecurityConfiguration" class="headerlink" title="WebSecurityConfiguration"></a>WebSecurityConfiguration</h5><p>â€‹	<strong>WebSecurityConfiguration</strong>é…ç½®ç±»çš„åŠŸèƒ½, ä¸»è¦å°±æ˜¯ä¸ºäº†æ„å»º<strong>SpringSecurity</strong>è¿‡æ»¤å™¨é“¾ä»£ç†å¯¹è±¡<strong>FilterChainProxy</strong>. æ ¹æ®å‰é¢çš„åˆ†æ, <strong>FilterChainProxy</strong>æ˜¯ç”±<strong>WebSecurity</strong>æ¥æ„å»ºçš„, æ‰€ä»¥åœ¨<strong>WebSecurityConfiguration</strong>ä¸­ä¼šé¦–å…ˆæ„å»º<strong>WebSecurity</strong>å¯¹è±¡,åœ¨åˆ©ç”¨<strong>WebSecurity</strong>å¯¹è±¡æ„å»ºå‡º<strong>FilterChainProxy</strong></p>
<p>â€‹	æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>WebSecurityConfiguration</strong>ä¸­å®šä¹‰çš„å±æ€§:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportAware</span>, BeanClassLoaderAware &#123;<br> <br>  <span class="hljs-keyword">private</span> WebSecurity webSecurity;<br><br>	<span class="hljs-keyword">private</span> Boolean debugEnabled;<br><br>	<span class="hljs-keyword">private</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers;<br><br>	<span class="hljs-keyword">private</span> ClassLoader beanClassLoader;<br><br>	<span class="hljs-meta">@Autowired(required = false)</span><br>	<span class="hljs-keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectObjectPostProcessor;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><strong>WebSecurityConfiguration</strong>ç±»å®ç°äº†<strong>ImportAware</strong>æ¥å£. <strong>ImportAware</strong>æ¥å£ä¸€èˆ¬æ˜¯å’Œ@<strong>Import</strong>æ³¨è§£ä¸€èµ·ä½¿ç”¨çš„, å®ç°äº†<strong>ImportAware</strong>æ¥å£çš„é…ç½®ç±»å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡<strong>setImportMetadata</strong>æ–¹æ³•è·å–åˆ°å¯¼å…¥ç±»ä¸­çš„æ•°æ®é…ç½®. æ¢å¥è¯è¯´, <strong>WebSecurityConfiguration</strong>å®ç°äº†<strong>ImportAware</strong>æ¥å£, ä½¿ç”¨@<strong>Import</strong>æ³¨è§£åœ¨@<strong>EnableWebSecurity</strong>ä¸Šå¯¼å…¥<strong>WebSecurityConfiguration</strong>ä¹‹å, åœ¨<strong>WebSecurityConfiguration</strong>çš„<strong>setImportMetadata</strong>æ–¹æ³•ä¸­å¯ä»¥æ–¹ä¾¿çš„è·å–åˆ°@<strong>EnableWebSecurity</strong>æ³¨è§£ä¸­çš„å±æ€§å€¼, è¿™é‡Œä¸»è¦æ˜¯debugçš„å±æ€§. å¦ä¸€æ–¹é¢, <strong>WebSecurityConfiguration</strong>ç±»é€šè¿‡å®ç°<strong>BeanClassLoaderAware</strong>æ¥å£å¯ä»¥æ–¹ä¾¿åœ°å›å»åˆ°ClassLoaderå¯¹è±¡</li>
<li><strong>webSecurity</strong>å¯¹è±¡æ˜¯<strong>WebSecurityConfiguration</strong>ä¸­éœ€è¦æ„å»ºçš„<strong>WebSecurity</strong>å¯¹è±¡</li>
<li><strong>webSecurityConfigurers</strong>é›†åˆä¸­ä¿å­˜äº†æ‰€æœ‰çš„é…ç½®ç±», ä¹Ÿå°±æ˜¯<strong>WebSecurityConfigurerAdapter</strong>å¯¹è±¡, ä¸€ä¸ª<strong>WebSecurityConfigurerAdapter</strong>å¯¹è±¡å¯ä»¥åˆ›å»ºä¸€ä¸ª<strong>HttpSecurity</strong>, è¿›è€Œæ„å»ºä¸€æ¡è¿‡æ»¤å™¨é“¾, å¤šä¸ª<strong>WebSecurityConfigurerAdapter</strong>å¯¹è±¡å°±å¯ä»¥æ„å»ºå‡ºå¤šæ¡è¿‡æ»¤å™¨é“¾</li>
<li><strong>beanClassLoader</strong>æ˜¯ä¸€ä¸ªClassLoader</li>
<li><strong>objectObjectPostProcessor</strong>æ˜¯ä¸€ä¸ªå¯¹è±¡åç½®å¤„ç†å™¨, æ³¨æ„è¿™ä¸ªå¯¹è±¡æ˜¯ç›´æ¥ä»Springå®¹å™¨ä¸­æ³¨å…¥çš„.</li>
</ol>
<blockquote>
<p>setFilterChainProxySecurityConfigurer: æ„å»ºWebSecurity</p>
</blockquote>
<p>â€‹	è¿™æ˜¯<strong>WebSecurityConfiguration</strong>ç±»ä¸­å®šä¹‰çš„å±æ€§. æ¥ä¸‹æ¥, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>setFilterChainProxySecurityConfigurer</strong>æ–¹æ³•, è¯¥æ–¹æ³•ä¸»è¦ç”¨æ¥æ„å»ºä¸€ä¸ª<strong>WebSecurity</strong>å¯¹è±¡, å¹¶ä¸”åŠ è½½æ‰€æœ‰çš„é…ç½®ç±»å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@Autowired(required = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFilterChainProxySecurityConfigurer</span><span class="hljs-params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span><br><span class="hljs-params">		ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	<span class="hljs-built_in">this</span>.webSecurity = objectPostProcessor.postProcess(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurity</span>(objectPostProcessor));<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.debugEnabled != <span class="hljs-literal">null</span>) &#123;<br>		<span class="hljs-built_in">this</span>.webSecurity.debug(<span class="hljs-built_in">this</span>.debugEnabled);<br>	&#125;<br>   <span class="hljs-comment">//è·å–Springä¸­çš„æ‰€æœ‰WebSecurityAdapter</span><br>	List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutowiredWebSecurityConfigurersIgnoreParents</span>(<br>			beanFactory).getWebSecurityConfigurers();<br>	webSecurityConfigurers.sort(AnnotationAwareOrderComparator.INSTANCE);<br>	<span class="hljs-type">Integer</span> <span class="hljs-variable">previousOrder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>	<span class="hljs-type">Object</span> <span class="hljs-variable">previousConfig</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>	<span class="hljs-keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; config : webSecurityConfigurers) &#123;<br>		<span class="hljs-type">Integer</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> AnnotationAwareOrderComparator.lookupOrder(config);<br>		<span class="hljs-keyword">if</span> (previousOrder != <span class="hljs-literal">null</span> &amp;&amp; previousOrder.equals(order)) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;@Order on WebSecurityConfigurers must be unique. Order of &quot;</span> + order<br>					+ <span class="hljs-string">&quot; was already used on &quot;</span> + previousConfig + <span class="hljs-string">&quot;, so it cannot be used on &quot;</span> + config + <span class="hljs-string">&quot; too.&quot;</span>);<br>		&#125;<br>		previousOrder = order;<br>		previousConfig = config;<br>	&#125;<br>   <span class="hljs-comment">//å°†Springä¸­çš„æ‰€æœ‰WebSecurityAdapteræ·»åŠ åˆ°webSecurityçš„configuresä¸­</span><br>	<span class="hljs-keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; webSecurityConfigurer : webSecurityConfigurers) &#123;<br>		<span class="hljs-built_in">this</span>.webSecurity.apply(webSecurityConfigurer);<br>	&#125;<br>	<span class="hljs-built_in">this</span>.webSecurityConfigurers = webSecurityConfigurers;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<strong>setFilterChainProxySecurityConfigurer</strong>æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°: </p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°<strong>objectPostProcessor</strong>æ˜¯ä¸€ä¸ªå¯¹è±¡åç½®å¤„ç†å™¨, ç”±äºè¯¥æ–¹æ³•æœ‰ä¸€ä¸ª**@Autowired<strong>æ³¨è§£, ä¼šè‡ªåŠ¨æŸ¥æ‰¾éœ€è¦æ³¨å…¥çš„å‚æ•°, æ‰€ä»¥</strong>objectPostProcessor<strong>å‚æ•°ä¼šè‡ªåŠ¨æ³¨å…¥è¿›æ¥. éœ€è¦æ³¨æ„çš„æ˜¯, <strong>@Autowired</strong>æ³¨è§£çš„</strong>required**å±æ€§ä¸ºfalse, æ‰€ä»¥åœ¨æ–¹æ³•å‚æ•°æ³¨å…¥çš„æ—¶å€™, æœ‰å°±æ³¨å…¥, æ²¡æœ‰å°±å¿½ç•¥.</li>
<li><strong>required</strong>å±æ€§è®¾ç½®ä¸ºfalseä¸»è¦æ˜¯é’ˆå¯¹ç¬¬äºŒä¸ªå‚æ•°<strong>webSecurityConfigurers</strong>, å› ä¸ºè¯¥å‚æ•°çš„å€¼æ˜¯é€šè¿‡è°ƒç”¨<strong>autowiredWebSecurityConfigurersIgnorePatterns</strong>å¯¹è±¡ä¹Ÿæ˜¯åœ¨å½“å‰ç±»ä¸­æ³¨å…¥åˆ°Springå®¹å™¨çš„, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„<strong>getWebSecurityConfigurers</strong>æ–¹æ³•:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; <span class="hljs-title function_">getWebSecurityConfigurers</span><span class="hljs-params">()</span> &#123;<br>		List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		Map&lt;String, WebSecurityConfigurer&gt; beansOfType = <span class="hljs-built_in">this</span>.beanFactory.getBeansOfType(WebSecurityConfigurer.class);<br>		<span class="hljs-keyword">for</span> (Entry&lt;String, WebSecurityConfigurer&gt; entry : beansOfType.entrySet()) &#123;<br>			webSecurityConfigurers.add(entry.getValue());<br>		&#125;<br>		<span class="hljs-keyword">return</span> webSecurityConfigurers;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, åœ¨<strong>getWebSecurityConfigurers</strong>æ–¹æ³•ä¸­ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨<strong>beanFactory.getBeansOfType</strong>æ–¹æ³•æ¥è·å–Springå®¹å™¨ä¸­æ‰€æœ‰çš„<strong>WebSecurityConfigurer</strong>å®ä¾‹, <span style="color:red;">ä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•å¯ä»¥è·å–å¼€å‘è€…è‡ªå®šä¹‰çš„å„ç§å„æ ·ç»§æ‰¿è‡ª<strong>WebSecurityConfigurerAdapter</strong>çš„é…ç½®ç±». </span>å¦‚æœå¼€å‘è€…æ²¡æœ‰è‡ªå®šä¹‰ä»»ä½•é…ç½®ç±», é‚£ä¹ˆè¿™é‡Œè·å–åˆ°çš„å°±æ˜¯å‰é¢æ‰€è®²çš„<strong>SpringBootWebSecurityConfiguration</strong>ç±»ä¸­æä¾›çš„é»˜è®¤é…ç½®ç±». å°†è·å–åˆ°çš„æ‰€æœ‰é…ç½®ç±»å®ä¾‹æ”¾åˆ°<strong>webSecurityConfigurers</strong>é›†åˆä¸­å¹¶è¿”å›.</p>
<p>â€‹	è¿”å›<strong>setFilterChainProxySecurityConfigurer</strong>æ–¹æ³•ä¸­, ç°åœ¨æˆ‘ä»¬å·²ç»æ˜ç™½äº†ç¬¬äºŒä¸ªå‚æ•°<strong>webSecurityConfigurers</strong>çš„å«ä¹‰äº†. åœ¨è¯¥æ–¹æ³•ä¸­:</p>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<strong>WebSecurity</strong>å®ä¾‹, åˆ›å»ºå‡ºæ¥ä¹‹åå»å¯¹è±¡åç½®å¤„ç†å™¨ä¸­èµ°ä¸€åœˆ, è¿™æ ·å°±å°†<strong>webSecurity</strong>å¯¹è±¡æ³¨å†Œåˆ°Springå®¹å™¨ä¸­å»äº†. </li>
<li>æ¥ä¸‹æ¥, æ ¹æ®æ¯ä¸€ä¸ªé…ç½®ç±»çš„@<strong>Order</strong>æ³¨è§£å¯¹<strong>webSecurityConfigurers</strong>é›†åˆä¸­çš„æ‰€æœ‰é…ç½®ç±»è¿›è¡Œæ’åº, å› ä¸ºä¸€ä¸ªé…ç½®ç±»å¯¹åº”ä¸€æ¡è¿‡æ»¤å™¨é“¾, å½“è¯·æ±‚åˆ°æ¥å, éœ€è¦å…ˆå’Œå“ªä¸ªè¿‡æ»¤å™¨è¿›è¡ŒåŒ¹é…,è¿™é‡Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªä¼˜å…ˆçº§é—®é¢˜, æ‰€ä»¥å¦‚æœå¼€å‘è€…è‡ªå®šä¹‰äº†å¤šä¸ªé…ç½®ç±», åˆ™éœ€è¦é€šè¿‡@<strong>Order</strong>æ³¨è§£æ ‡è®°å¤šä¸ªé…ç½®ç±»çš„ä¼˜å…ˆçº§.</li>
<li>æ’åºå®Œæˆå, è¿›å…¥åˆ°forå¾ªç¯ä¸­, æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¼˜å…ˆçº§ç›¸ç­‰çš„é…ç½®ç±», å¦‚æœå­˜åœ¨,åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸. æœ€åå†å»éå†æ‰€æœ‰çš„é…ç½®ç±», è°ƒç”¨<strong>webSecurity.apply</strong>æ–¹æ³•å°†å…¶æ·»åŠ åˆ°<strong>webSecurity</strong>çˆ¶ç±»ä¸­çš„<strong>configurers</strong>é›†åˆä¸­(å°†æ¥éå†è¯¥é›†åˆå¹¶åˆ†åˆ«è°ƒç”¨é…ç½®ç±»çš„<strong>init</strong>å’Œ<strong>configure</strong>æ–¹æ³•å®Œæˆé…ç½®ç±»çš„åˆå§‹åŒ–æ“ä½œ)</li>
</ol>
<p>â€‹	<span style="color:red;">è¿™æ˜¯<strong>setFilterChainProxySecurityConfigurer</strong>æ–¹æ³•çš„æ‰§è¡Œé€»è¾‘, è¯¥æ–¹æ³•ä¸»è¦ç”¨æ¥åˆå§‹åŒ–<strong>WebSecurity</strong>å¯¹è±¡, åŒæ—¶æ”¶é›†åˆ°æ‰€æœ‰çš„ç”¨æ¥æ„å»º<strong>FailterChainProxy</strong>çš„è‡ªå®šä¹‰é…ç½®ç±», ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>WebSecurityConfigurerAdapter</strong>åŠ å…¥åˆ°<strong>WebSecurity</strong>çš„<strong>configures</strong>é›†åˆä¸­(åé¢<strong>WebSecurity</strong>æ‰§è¡Œ<strong>build</strong>æ–¹æ³•æ—¶ä¼šåˆå§‹åŒ–ä»¥åŠé…ç½®)</span></p>
<blockquote>
<p>springSecurityFilterChain: æ„å»ºFilterChainProxy</p>
</blockquote>
<p>â€‹	æœ‰äº†<strong>WebSecurity</strong>å¯¹è±¡å’Œé…ç½®ç±», æ¥ä¸‹æ¥å°±å¯ä»¥æ„å»ºè¿‡æ»¤å™¨<strong>FilterChainProxy</strong>äº†. æˆ‘ä»¬æ¥çœ‹ä¸‹<strong>springSecurityFilterChain</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME)</span><br><span class="hljs-keyword">public</span> Filter <span class="hljs-title function_">springSecurityFilterChain</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	<span class="hljs-type">boolean</span> <span class="hljs-variable">hasConfigurers</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.webSecurityConfigurers != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.webSecurityConfigurers.isEmpty();<br>	<span class="hljs-type">boolean</span> <span class="hljs-variable">hasFilterChain</span> <span class="hljs-operator">=</span> !<span class="hljs-built_in">this</span>.securityFilterChains.isEmpty();<br>	Assert.state(!(hasConfigurers &amp;&amp; hasFilterChain),<br>			<span class="hljs-string">&quot;Found WebSecurityConfigurerAdapter as well as SecurityFilterChain. Please select just one.&quot;</span>);<br>	<span class="hljs-keyword">if</span> (!hasConfigurers &amp;&amp; !hasFilterChain) &#123;<br>		<span class="hljs-type">WebSecurityConfigurerAdapter</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.objectObjectPostProcessor<br>				.postProcess(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>() &#123;<br>				&#125;);<br>		<span class="hljs-built_in">this</span>.webSecurity.apply(adapter);<br>	&#125;<br>	<span class="hljs-keyword">for</span> (SecurityFilterChain securityFilterChain : <span class="hljs-built_in">this</span>.securityFilterChains) &#123;<br>		<span class="hljs-built_in">this</span>.webSecurity.addSecurityFilterChainBuilder(() -&gt; securityFilterChain);<br>		<span class="hljs-keyword">for</span> (Filter filter : securityFilterChain.getFilters()) &#123;<br>			<span class="hljs-keyword">if</span> (filter <span class="hljs-keyword">instanceof</span> FilterSecurityInterceptor) &#123;<br>				<span class="hljs-built_in">this</span>.webSecurity.securityInterceptor((FilterSecurityInterceptor) filter);<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span> (WebSecurityCustomizer customizer : <span class="hljs-built_in">this</span>.webSecurityCustomizers) &#123;<br>		customizer.customize(<span class="hljs-built_in">this</span>.webSecurity);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.webSecurity.build();<br>&#125;<br></code></pre></td></tr></table></figure>



<p>â€‹	è¿™é‡Œé¦–å…ˆåˆ¤æ–­<strong>webSecurityConfigurers</strong>é›†åˆä¸­æ˜¯å¦å­˜åœ¨é…ç½®ç±», å¦‚æœä¸å­˜åœ¨, åˆ™ç«‹é©¬åˆ›å»ºä¸€ä¸ªåŒ¿åçš„<strong>WebSecurityConfigurerAdapter</strong>å¯¹è±¡å¹¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­, å¦åˆ™å°±ç›´æ¥è°ƒç”¨<strong>WebSecurity</strong>çš„<strong>build</strong>æ–¹æ³•è¿›è¡Œæ„å»º.</p>
<p>â€‹	æ ¹æ®ä¹‹å‰çš„ä»‹ç», äº†è§£äº†<strong>WebSecurity</strong>å¯¹è±¡çš„<strong>build</strong>æ–¹æ³•æ‰§è¡Œå, é¦–å…ˆä¼šå¯¹æ‰€æœ‰çš„é…ç½®ç±»å³<strong>WebSecurityConfigurerAdapter</strong>å®ä¾‹è¿›è¡Œæ„å»º, åœ¨<strong>WebSecurityConfigurerAdapter</strong>çš„<strong>init</strong>æ–¹æ³•ä¸­, åˆä¼šå®Œæˆ<strong>HttpSecurity</strong>çš„æ„å»º, è€Œ<strong>HttpSecurity</strong>çš„æ„å»ºè¿‡ç¨‹ä¸­, åˆ™ä¼šå®Œæˆå±€éƒ¨çš„<strong>AuthenticationManager</strong>å¯¹è±¡ä»¥åŠæ¯ä¸€ä¸ªå…·ä½“çš„è¿‡æ»¤å™¨çš„æ„å»º</p>
<p>â€‹	<span style="color:red;">ç®€å•æ¥è¯´, è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è®©æˆ‘ä»¬ä¹‹å‰çš„æ–¹æ³•<strong>setFilterChainProxySecurityConfigurer</strong>åˆå§‹åŒ–çš„<strong>WebSecurity</strong>æ¥æ‰§è¡Œ<strong>build</strong>æ–¹æ³•æ„å»ºä¸€æ¡<strong>FilterChainProxy</strong></span></p>
<p>â€‹	è¿™å°±æ˜¯æ•´ä¸ªè¿‡æ»¤å™¨é“¾çš„æ„å»ºè¿‡ç¨‹.</p>
<p>â€‹	</p>
<h2 id="4-5-å¦‚ä½•è‡ªå®šä¹‰SecurityFilterChainè¿‡æ»¤å™¨é“¾"><a href="#4-5-å¦‚ä½•è‡ªå®šä¹‰SecurityFilterChainè¿‡æ»¤å™¨é“¾" class="headerlink" title="4.5 å¦‚ä½•è‡ªå®šä¹‰SecurityFilterChainè¿‡æ»¤å™¨é“¾?"></a>4.5 å¦‚ä½•è‡ªå®šä¹‰SecurityFilterChainè¿‡æ»¤å™¨é“¾?</h2><h3 id="4-5-1-SpringSecurityé…ç½®åŸç†"><a href="#4-5-1-SpringSecurityé…ç½®åŸç†" class="headerlink" title="4.5.1 SpringSecurityé…ç½®åŸç†"></a>4.5.1 SpringSecurityé…ç½®åŸç†</h3><p>ä¹‹å‰çš„ç« èŠ‚é‡Œé¢æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†SpringSecurityé…ç½®åŸç†, ä¸ºäº†èƒ½æ›´å¥½ç†è§£æœ¬æ¬¡å…ˆå›å¿†ä¸‹:</p>
<p>ä¸ºä»€ä¹ˆSpringSecurityåœ¨æˆ‘ä»¬å¯¼å…¥ä¾èµ–åå°±ç›´æ¥æœ‰äº†é»˜è®¤çš„è¡¨å•è®¤è¯åŠŸèƒ½, è¿™æ˜¯å› ä¸ºSpringSecurityå¸®æˆ‘ä»¬å¯¼å…¥ä¸€ä¸ªé…ç½®ç±»<strong>SpringBootWebSecurityConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringBootWebSecurityConfiguration</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The default configuration for web security. It relies on Spring Security&#x27;s</span><br><span class="hljs-comment">	 * content-negotiation strategy to determine what sort of authentication to use. If</span><br><span class="hljs-comment">	 * the user specifies their own &#123;<span class="hljs-doctag">@code</span> WebSecurityConfigurerAdapter&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> SecurityFilterChain&#125; bean, this will back-off completely and the users</span><br><span class="hljs-comment">	 * should specify all the bits that they want to configure as part of the custom</span><br><span class="hljs-comment">	 * security configuration.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br>	<span class="hljs-meta">@ConditionalOnDefaultWebSecurity</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityFilterChainConfiguration</span> &#123;<br><br>		<span class="hljs-meta">@Bean</span><br>		<span class="hljs-meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span><br>		SecurityFilterChain <span class="hljs-title function_">defaultSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>			http.authorizeRequests().anyRequest().authenticated();<br>			http.formLogin();<br>			http.httpBasic();<br>			<span class="hljs-keyword">return</span> http.build();<br>		&#125;<br><br>	&#125;<br><br></code></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è®¤è¯é…ç½®, æˆ‘ä»¬è¿›å…¥æ³¨è§£<strong>ConditionalOnDefaultWebSecurity</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultWebSecurityCondition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AllNestedConditions</span> &#123;<br><br>	<span class="hljs-meta">@ConditionalOnClass(&#123; SecurityFilterChain.class, HttpSecurity.class &#125;)</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Classes</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-meta">@ConditionalOnMissingBean(&#123;</span><br><span class="hljs-meta">			org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter.class,</span><br><span class="hljs-meta">			SecurityFilterChain.class &#125;)</span><br>	<span class="hljs-meta">@SuppressWarnings(&quot;deprecation&quot;)</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Beans</span> &#123;<br><br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>æˆ‘ä»¬å‘ç°è¦æƒ³è¦†ç›–è¿™ä¸ªé»˜è®¤é…ç½®:</p>
<ul>
<li>åªéœ€è¦é‡å†™ä¸€ä¸ª<strong>WebSecurityConfigurerAdapter</strong>ç„¶åç”¨é‡Œé¢çš„<strong>configure(HttpSecurity http)<strong>æ–¹æ³•æ„å»ºä¸€ä¸ª</strong>SecurityFilterChain</strong></li>
<li>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥æ„å»ºä¸€ä¸ª<strong>SecurityFilterChain</strong></li>
</ul>
<h3 id="4-5-2-è‡ªå®šä¹‰SecurityFilterChain"><a href="#4-5-2-è‡ªå®šä¹‰SecurityFilterChain" class="headerlink" title="4.5.2 è‡ªå®šä¹‰SecurityFilterChain"></a>4.5.2 è‡ªå®šä¹‰SecurityFilterChain</h3><p>åœ¨å®šä¹‰ä¹‹å‰æˆ‘ä»¬å‘ç°åœ¨é«˜ç‰ˆæœ¬çš„<strong>SpringSecurity</strong>ä¸­, ç»§æ‰¿<strong>WebSecurityConfigurerAdapter</strong>è¿™æ ·çš„æ–¹å¼å·²ç»è¿‡æ—¶äº†, è™½ç„¶ä»ç„¶å¯ä»¥ä½¿ç”¨ä½†æ˜¯ä½œè€…å·²ç»ä¸æ¨èäº†.<strong>è‡ªå®šä¹‰SecurityFilterChainçš„æ–¹å¼æ˜¯ä½œè€…æ¨èçš„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(<br>        User.builder().username(<span class="hljs-string">&quot;admin&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;admin123&quot;</span>).build());<br>  &#125;<br><br>  <span class="hljs-comment">//è¯¦æƒ…å¯çœ‹WebSecurityConfiguration#setFilterChainsã€springSecurityFilterChain</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> DefaultSecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>        .anyRequest().authenticated()<br>        .and().formLogin()<br>        .successHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomSuccessHandler</span>())<br>        .and().userDetailsService(userDetailService())<br>        .csrf().disable();<br>    <span class="hljs-keyword">return</span> http.build();<br>  &#125;<br>  <br>  <span class="hljs-comment">//è¯¦æƒ…å¯çœ‹WebSecurityConfiguration#springSecurityFilterChain</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> WebSecurityCustomizer <span class="hljs-title function_">webSecurityCustomizer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> web -&gt; &#123;<br>      web.ignoring().antMatchers(<span class="hljs-string">&quot;resource/**&quot;</span>);<br>    &#125;;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-6-æˆ‘ä»¬è‡ªå®šä¹‰çš„SecurityFilterChainæ˜¯å¦‚ä½•åˆå§‹åŒ–çš„"><a href="#4-6-æˆ‘ä»¬è‡ªå®šä¹‰çš„SecurityFilterChainæ˜¯å¦‚ä½•åˆå§‹åŒ–çš„" class="headerlink" title="4.6 æˆ‘ä»¬è‡ªå®šä¹‰çš„SecurityFilterChainæ˜¯å¦‚ä½•åˆå§‹åŒ–çš„?"></a>4.6 æˆ‘ä»¬è‡ªå®šä¹‰çš„SecurityFilterChainæ˜¯å¦‚ä½•åˆå§‹åŒ–çš„?</h2><p>å¦‚æœæˆ‘ä»¬åƒä¸Šä¸€èŠ‚ä¸€æ ·è‡ªå®šä¹‰äº†ä¸€ä¸ª<strong>SecurityFilterChain</strong>, ä½†æ˜¯é—®é¢˜æ¥äº†,æˆ‘ä»¬é…ç½®çš„<strong>SecurityFilterChain</strong>æ˜¯ä»€ä¹ˆå¦‚ä½•åˆå§‹åŒ–çš„?</p>
<p>æ ¹æ®ä¸Šé¢çš„è®²è§£è¿‡ä½¿ç”¨<strong>WebSecurityConfigurerAdapter</strong>åˆå§‹åŒ–æµç¨‹åŸºæœ¬ä¸€æ ·, ä½†æ˜¯è¿˜æ˜¯æœ‰äº›å·®åˆ«çš„, æœ¬æ¬¡å°±å†è®²è§£ä¸€ä¸‹:</p>
<ol>
<li>é¦–å…ˆå’Œç»§æ‰¿<strong>WebSecurityConfigurerAdapter</strong>ä¸ä¸€æ ·, æˆ‘ä»¬æ˜¯é€šè¿‡**@Bean<strong>æ³¨å…¥çš„</strong>SecurityFilterChain<strong>ä¸­éœ€è¦ç”¨çš„</strong>HttpSecurity**</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å°±è¦æ˜ç¡®<strong>HttpSecurity</strong>æ˜¯åœ¨å“ªå„¿æ³¨å…¥è¿›å»çš„? åœ¨çœ‹è¿‡åˆå§‹åŒ–åˆ†æå°èŠ‚å, å‘ç°æ˜¯åœ¨<strong>HttpSecurityConfiguration</strong>é‡Œé¢</p>
<blockquote>
<p>HttpSecurityConfiguration</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpSecurityConfiguration</span> &#123;<br><br>	<span class="hljs-comment">//åŠ äº†@Scope(&quot;prototype&quot;)è¡¨ç¤ºæ˜¯å¯ä»¥æœ‰å¤šä¾‹, ä¸ä¼šç›´æ¥æ³¨å…¥åˆ°Spring, è¢«ç”¨åˆ°ç›´æ¥åˆ›å»º</span><br>	<span class="hljs-meta">@Bean(HTTPSECURITY_BEAN_NAME)</span><br>	<span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br>	HttpSecurity <span class="hljs-title function_">httpSecurity</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		WebSecurityConfigurerAdapter.<span class="hljs-type">LazyPasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>.LazyPasswordEncoder(<br>				<span class="hljs-built_in">this</span>.context);<br>		<span class="hljs-type">AuthenticationManagerBuilder</span> <span class="hljs-variable">authenticationBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>.DefaultPasswordEncoderAuthenticationManagerBuilder(<br>				<span class="hljs-built_in">this</span>.objectPostProcessor, passwordEncoder);<br>		authenticationBuilder.parentAuthenticationManager(authenticationManager());<br>		authenticationBuilder.authenticationEventPublisher(getAuthenticationEventPublisher());<br>		<span class="hljs-type">HttpSecurity</span> <span class="hljs-variable">http</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSecurity</span>(<span class="hljs-built_in">this</span>.objectPostProcessor, authenticationBuilder, createSharedObjects());<br>		<span class="hljs-comment">// @formatter:off</span><br>		http<br>			.csrf(withDefaults())<br>			.addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAsyncManagerIntegrationFilter</span>())<br>			.exceptionHandling(withDefaults())<br>			.headers(withDefaults())<br>			.sessionManagement(withDefaults())<br>			.securityContext(withDefaults())<br>			.requestCache(withDefaults())<br>			.anonymous(withDefaults())<br>			.servletApi(withDefaults())<br>			.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLoginPageConfigurer</span>&lt;&gt;());<br>		http.logout(withDefaults());<br>		<span class="hljs-comment">// @formatter:on</span><br>		applyDefaultConfigurers(http);<br>		<span class="hljs-keyword">return</span> http;<br>	&#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤ä½¿ç”¨<strong>HttpSecurity</strong></p>
<ol start="2">
<li>ç„¶ååœ¨æ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„æ„å»ºé€»è¾‘:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>        .anyRequest().authenticated()<br>        .and().formLogin()<br>        .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;UsernamePasswordAuthenticationFilter&gt;() &#123;<br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> &#123;<br>            <span class="hljs-comment">//è‡ªå®šä¹‰ObjectPostProcessor</span><br>            object.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>            object.setPasswordParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>            object.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;<br>              response.getWriter().write(<span class="hljs-string">&quot;login success&quot;</span>);<br>            &#125;);<br>            <span class="hljs-keyword">return</span> object;<br>          &#125;<br>        &#125;)<br>        .and().userDetailsService(userDetailService())<br>        .csrf().disable();<br><br>    <span class="hljs-keyword">return</span> http.build();<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>å’Œç”¨<strong>WebSecurityConfigurerAdapter</strong>ä¸€æ ·ç„¶åæ‰§è¡Œ<strong>HttpSecurity</strong>çš„<strong>build</strong>æ–¹æ³•å°±æ˜¯ä¼šå¯¹å…¶çš„æ‰€æœ‰é…ç½®<strong>configurers</strong>è¿›è¡Œåˆå§‹åŒ–ä»¥åŠé…ç½®æ“ä½œ, ä»¥åŠæœ€ç»ˆ<strong>DefaultSecurityFilterChain</strong>çš„æ„å»º#<strong>performBuild</strong>, æœ€åæ„å»º<strong>FilterChainProxy</strong></p>
<h2 id="4-7-SpringSecurityé‚£ä¹ˆå¤šè¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•åŠ è½½è¿›æ¥çš„"><a href="#4-7-SpringSecurityé‚£ä¹ˆå¤šè¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•åŠ è½½è¿›æ¥çš„" class="headerlink" title="4.7 SpringSecurityé‚£ä¹ˆå¤šè¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•åŠ è½½è¿›æ¥çš„?"></a>4.7 SpringSecurityé‚£ä¹ˆå¤šè¿‡æ»¤å™¨é“¾æ˜¯å¦‚ä½•åŠ è½½è¿›æ¥çš„?</h2><p>æ¯ä¸ªSpringSecurityè¿‡æ»¤å™¨éƒ½å¯¹åº”çš„æœ‰<strong>xxxConfigurer</strong>é…ç½®ç±», ä¼šç»™SpringSecurityçš„å®‰å…¨ç±»æ¯”å¦‚<strong>HttpSecurity</strong>è¿›è¡Œé…ç½®å’Œåˆå§‹åŒ–, å°¤å…¶æ˜¯åœ¨<strong>configure</strong>é…ç½®é‡Œä¼šç»™<strong>HttpSecurity</strong>æ·»åŠ è¿›è¿‡æ»¤å™¨é›†åˆfilters.</p>
<p>è¿™é‡Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­:<strong>HttpSecurity</strong>#<strong>formLogin</strong>, ä¼šæ·»åŠ ä¸€ä¸ª<strong>FormLoginConfigurer</strong>åœ¨<strong>HttpSecurity</strong>#<strong>build</strong>è°ƒç”¨ä¹‹åå°±ä¼šè°ƒç”¨<strong>FormLoginConfigurer</strong>#<strong>init</strong>ã€<strong>configurer</strong>æ–¹æ³•, åœ¨<strong>configurer</strong>ä¸­å°±ä¼šæ·»åŠ è¿‡æ»¤å™¨å¹¶ä¸”è°ƒç”¨ **this.objectPostProcessor.postProcess(object)**æ¥å°†è¿‡æ»¤å™¨æ³¨å…¥åˆ°Springå®¹å™¨</p>
<h2 id="4-8-å¦‚ä½•è®¾ç½®é™æ€èµ„æºè¿‡æ»¤"><a href="#4-8-å¦‚ä½•è®¾ç½®é™æ€èµ„æºè¿‡æ»¤" class="headerlink" title="4.8 å¦‚ä½•è®¾ç½®é™æ€èµ„æºè¿‡æ»¤?"></a>4.8 å¦‚ä½•è®¾ç½®é™æ€èµ„æºè¿‡æ»¤?</h2><p>åœ¨ä¸€ä¸ªå®é™…é¡¹ç›®ä¸­, å¹¶éæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡SpringSecurityè¿‡æ»¤å™¨, æœ‰ä¸€äº›ç‰¹æ®Šçš„è¯·æ±‚, ä¾‹å¦‚é™æ€èµ„æºç­‰, ä¸€èˆ¬æ¥è¯´å¹¶ä¸éœ€è¦ç»è¿‡SpringSecurityè¿‡æ»¤å™¨é“¾, ç”¨æˆ·å¦‚æœè®¿é—®è¿™äº›é™æ€èµ„æº, ç›´æ¥è¿”å›å¯¹äºçš„èµ„æºå³å¯.</p>
<p>â€‹	å›é¡¾ä¹‹å‰å…³äº<strong>WebSecurity</strong>çš„è®²è§£, æåˆ°äº†å®ƒé‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ª<strong>ignoredRequests</strong>å˜é‡, è¯¥å˜é‡è®°å½•çš„å°±æ˜¯æ‰€æœ‰éœ€è¦è¢«å¿½ç•¥çš„è¯·æ±‚, è¿™äº›è¢«å¿½ç•¥çš„è¯·æ±‚å°†ä¸å†ç»è¿‡<strong>SpringSecurity</strong>è¿‡æ»¤å™¨. </p>
<img src="/2022/01/26/SpringSecurity/image-20230323174059920.png" srcset="/img/loading.gif" lazyload alt="image-20230323174059920" style="zoom:50%;">

<p>â€‹	ç°åœ¨è¿™äº›é™æ€èµ„æºçš„è®¿é—®ä¸éœ€è¦ç»è¿‡SpringSecurityè¿‡æ»¤å™¨, å…·ä½“é…ç½®æ–¹æ¡ˆå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    users.createUser(User.withUsername(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> users;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    web.ignoring().antMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>, <span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>, <span class="hljs-string">&quot;/images/**&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>        .anyRequest().authenticated()<br>        .and()<br>        .formLogin()<br>        .and()<br>        .csrf().disable();<br>  &#125;<br>&#125;<br><br><br><span class="hljs-comment">//æ–°ç‰ˆæ–¹å¼</span><br><span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> WebSecurityCustomizer <span class="hljs-title function_">webSecurityCustomizer</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSecurityCustomizer</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">customize</span><span class="hljs-params">(WebSecurity web)</span> &#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/resource/**&quot;</span>);<br>      &#125;<br>    &#125;;<br>  &#125;<br><br></code></pre></td></tr></table></figure>

<p>â€‹	é‡å†™<strong>configure(WebSecurity)<strong>æ–¹æ³•, å¹¶é…ç½®éœ€è¦å¿½ç•¥çš„è¯·æ±‚,è¿™äº›éœ€è¦å¿½ç•¥çš„åœ°å€, æœ€ç»ˆéƒ½ä¼šè¢«æ·»åŠ åˆ°</strong>ignoredRequests</strong>é›†åˆä¸­, å¹¶æœ€ç»ˆä»¥è¿‡æ»¤å™¨é“¾çš„å½¢å¼å‘ˆç°å‡ºæ¥. æ¢å¥è¯è¯´, ä¸Šé¢çš„é…ç½®ä¸­ä¸€å…±åŒ…å«äº†äº”ä¸ªè¿‡æ»¤å™¨é“¾: <strong>configure(WebSecurity)<strong>æ–¹æ³•ä¸­é…ç½®çš„å››ä¸ªä»¥åŠ</strong>HttpSecurity</strong>ä¸­é…ç½®çš„ä¸€ä¸ª(å³:&#x2F;**).</p>
<h2 id="4-9-å¦‚ä½•é…ç½®å¤šç”¨æˆ·è®¤è¯"><a href="#4-9-å¦‚ä½•é…ç½®å¤šç”¨æˆ·è®¤è¯" class="headerlink" title="4.9 å¦‚ä½•é…ç½®å¤šç”¨æˆ·è®¤è¯"></a>4.9 å¦‚ä½•é…ç½®å¤šç”¨æˆ·è®¤è¯</h2><p>â€‹	åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­, æˆ‘ä»¬å®šä¹‰ç”¨æˆ·ä¸»è¦æ˜¯ä¸¤ç§æ–¹å¼:</p>
<ol>
<li>é‡å†™**configure(AuthenticationManagerBuilder)**æ–¹æ³•çš„æ–¹å¼</li>
<li>ç¬¬äºŒç§æ–¹å¼æ˜¯å®šä¹‰å¤šä¸ªæ•°æ®æº, æˆ‘ä»¬ç›´æ¥å‘Springå®¹å™¨ä¸­æ³¨å…¥äº†<strong>UserDetailsService</strong>å¯¹è±¡</li>
</ol>
<p>â€‹	é‚£ä¹ˆè¿™ä¸¤ç§ç”¨æˆ·å®šä¹‰æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«?</p>
<p>â€‹	æ ¹æ®å‰é¢çš„æºç åˆ†æå¯çŸ¥: åœ¨SpringSecurityä¹‹åå­˜åœ¨ä¸¤ç§ç±»å‹çš„<strong>AuthenticationManager</strong>, ä¸€ç§æ˜¯å…¨å±€çš„<strong>AuthenticationManager</strong>, å¦ä¸€ç§æ˜¯å±€éƒ¨çš„<strong>AuthenticationManager</strong>. å±€éƒ¨çš„<strong>AuthenticationManager</strong>ç”±<strong>HttpSecurity</strong>è¿›è¡Œé…ç½®, è€Œå…¨å±€çš„<strong>AuthenticationManager</strong>å¯ä»¥ä¸ç”¨é…ç½®, ç³»ç»Ÿä¼šé»˜è®¤æä¾›ä¸€ä¸ªå…¨å±€çš„<strong>AuthenticationManager</strong>å¯¹è±¡, ä¹Ÿå¯ä»¥é€šè¿‡é‡å†™**configure(AuthenticationManagerBuilder)**æ–¹æ³•è¿›è¡Œå…¨å±€é…ç½®</p>
<p>â€‹	å½“è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯æ—¶, é¦–å…ˆä¼šé€šè¿‡å±€éƒ¨çš„<strong>AuthenticationManager</strong>å¯¹è±¡è¿›è¡ŒéªŒè¯, å¦‚æœéªŒè¯å¤±è´¥, åˆ™ä¼šè°ƒç”¨å…¶parentä¹Ÿå°±æ˜¯å…¨å±€çš„<strong>AuthenticationManager</strong>å†æ¬¡è¿›è¡ŒéªŒè¯.</p>
<p>â€‹	æ‰€ä»¥å¼€å‘è€…åœ¨å®šä¹‰ç”¨æˆ·æ—¶, ä¹Ÿåˆ†ä¸ºä¸¤ç§æƒ…å†µ, ä¸€ç§æ˜¯é’ˆå¯¹å±€éƒ¨<strong>AuthenticationManager</strong>å®šä¹‰çš„ç”¨æˆ·, å¦ä¸€ç§åˆ™æ˜¯é’ˆå¯¹å…¨å±€<strong>AuthenticationManager</strong>å®šä¹‰çš„ç”¨æˆ·.</p>
<p>â€‹	ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿, æ¥ä¸‹æ¥çš„æ¡ˆä¾‹æˆ‘ä»¬å°†é‡‡å–<strong>InMemoryUserDetailsManager</strong>æ¥æ„å»ºç”¨æˆ·å¯¹è±¡.</p>
<p>â€‹	å…ˆæ¥çœ‹é’ˆå¯¹å±€éƒ¨<strong>AuthenticationManager</strong>å®šä¹‰çš„ç”¨æˆ·:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>   <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>   user.createUser(User.withUsername(<span class="hljs-string">&quot;javaboy&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).build());<br>   http.authorizeHttpRequests()<br>       .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>       .anyRequest().authenticated()<br>       .and().formLogin()<br>       .and().userDetailsService(user)<br>       .csrf().disable();<br> &#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­, æˆ‘ä»¬åŸºäºå†…å­˜æ¥ç®¡ç†ç”¨æˆ·, å¹¶å‘userä¸­æ·»åŠ äº†ä¸ªç”¨æˆ·, å°†é…ç½®å¥½çš„userså¯¹è±¡æ·»åŠ åˆ°HttpSecurityä¸­, ä¹Ÿå°±æ˜¯é…ç½®åˆ°å±€éƒ¨çš„AuthenticationManagerä¸­.</p>
<p>â€‹	é…ç½®å®Œæˆå, å¯åŠ¨é¡¹ç›®. é¡¹ç›®å¯åŠ¨æˆåŠŸå, æˆ‘ä»¬å°±å¯ä»¥javaboy&#x2F;123æ¥ç™»å½•ç³»ç»Ÿäº†.</p>
<p>â€‹	å€¼å¾—æ³¨æ„çš„æ˜¯, å½“æˆ‘ä»¬å¯åŠ¨é¡¹ç›®æ—¶, åœ¨IDEAæ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Using</span> <span class="hljs-keyword">generated</span> <span class="hljs-keyword">security</span> <span class="hljs-keyword">password</span>: <span class="hljs-number">683311</span>a8<span class="hljs-number">-7</span>a53<span class="hljs-number">-453</span>b-b07c-aa9a665365be<br></code></pre></td></tr></table></figure>

<p>â€‹	ç³»ç»Ÿè‡ªåŠ¨æä¾›çš„ç”¨æˆ·å¯¹è±¡å®é™…ä¸Šå°±æ˜¯å¾€Springå®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ª<strong>InMemoryUserDetailsManager</strong>å¯¹è±¡. è€Œåœ¨å‰é¢çš„ä»£ç ä¸­, æˆ‘ä»¬æ²¡æœ‰é‡å†™<strong>configure(AuthenticationManagerBuilder)</strong> æ–¹æ³•, è¿™æ„å‘³ç€å…¨å±€çš„<strong>AuthenticationManager</strong>æ˜¯é€šè¿‡<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆçš„, åœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­, ä¼šä»Springå®¹å™¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„<strong>UserDetailsService</strong>å®ä¾‹è¿›è¡Œé…ç½®(å…·ä½“é…ç½®åœ¨<strong>InitializeUserDetailsManagerConfigurer</strong>ç±»ä¸­)æ‰€ä»¥ç³»ç»Ÿè‡ªåŠ¨æä¾›çš„ç”¨æˆ·å®é™…ä¸Šç›¸å½“äºæ˜¯å…¨å±€<strong>AuthenticationManager</strong>å¯¹åº”çš„ç”¨æˆ·.</p>
<p>â€‹	ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹, å½“æˆ‘ä»¬æ‰§è¡Œç™»å½•å, SpringSecurityé¦–å…ˆä¼šè°ƒç”¨å±€éƒ¨<strong>AuthenticationManager</strong>å»è¿›è¡Œç™»å½•éªŒè¯, å¦‚æœç™»å½•çš„ç”¨æˆ·å&#x2F;å¯†ç æ˜¯javaboy&#x2F;123, é‚£ä¹ˆå°±ç›´æ¥ç™»å½•æˆåŠŸ, å¦åˆ™ç™»å½•å¤±è´¥. å½“ç™»å½•å¤±è´¥å, ä¼šç»§ç»­è°ƒç”¨å±€éƒ¨<strong>AuthenticationManager</strong>çš„parentç»§ç»­è¿›è¡Œæ ¡éªŒ, æ­¤æ—¶å¦‚æœç™»å½•çš„ç”¨æˆ·å&#x2F;å¯†ç æ˜¯user&#x2F;683311a8-7a53-453b-b07c-aa9a665365be, åˆ™ç™»å½•æˆåŠŸ, å¦åˆ™ç™»å½•å¤±è´¥</p>
<p>â€‹	è¿™æ˜¯é’ˆå¯¹å±€éƒ¨<strong>AuthenticationManager</strong>å®šä¹‰çš„ç”¨æˆ·, æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å®šä¹‰çš„ç”¨æˆ·é…ç½®ç»™å…¨å±€çš„<strong>AuthenticationManager</strong>, ç”±äºé»˜è®¤çš„å…¨å±€<strong>AuthenticationManager</strong>åœ¨é…ç½®æ—¶ä¼šä»Springå®¹å™¨ä¸­æŸ¥æ‰¾<strong>UserDetailsService</strong>å®ä¾‹, æ‰€ä»¥æˆ‘ä»¬å¦‚æœé’ˆå¯¹å…¨å±€<strong>AuthenticationManager</strong>é…ç½®ç”¨æˆ·, åªéœ€è¦å¾€Springå®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ª<strong>UserDetailsService</strong>å®ä¾‹å³å¯, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>  inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;javaboy&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>  <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  http.authorizeHttpRequests()<br>      .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>      .anyRequest().authenticated()<br>      .and().formLogin()<br>      .and().userDetailsService(userDetailsService())<br>      .csrf().disable();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	é…ç½®å®Œæˆå, å½“æˆ‘ä»¬å¯åŠ¨é¡¹ç›®æ—¶, å…¨å±€çš„<strong>AuthenticationManager</strong>åœ¨é…ç½®æ—¶ä¼šå»Springå®¹å™¨ä¸­æŸ¥æ‰¾<strong>UserDetailsService</strong>å®ä¾‹, æ‰¾åˆ°çš„å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„<strong>UserDetailsService</strong>å®ä¾‹. </p>
<p>â€‹	å½“ç„¶, å¼€å‘è€…ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨SpringSecurityæä¾›çš„é»˜è®¤çš„å…¨å±€<strong>AuthenticationManager</strong>å¯¹è±¡, è€Œæ˜¯é€šè¿‡é‡å†™<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•æ¥è‡ªå®šä¹‰å…¨å±€</strong>AuthenticationManager</strong>å¯¹è±¡:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    auth.inMemoryAuthentication().withUser(<span class="hljs-string">&quot;javaboy&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>        .anyRequest().authenticated()<br>        .and().formLogin()<br>        .and()<br>        .csrf().disable();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	æ ¹æ®<strong>WebSecurityConfigurerAdapter</strong>çš„æºç åˆ†æå¯çŸ¥, ä¸€æ—¦æˆ‘ä»¬é‡å†™äº†<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•, åˆ™å…¨å±€çš„</strong>AuthenticationManager</strong>å¯¹è±¡å°†ä¸å†é€šè¿‡<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>æ–¹æ³•æ¥æ„å»º, è€Œæ˜¯é€šè¿‡<strong>WebSecurityConfigurerAdapter</strong>ä¸­çš„<strong>localConfigureAuthenticationBldr</strong>å˜é‡æ¥æ„å»º, è¯¥å˜é‡ä¹Ÿæ˜¯æˆ‘ä»¬é‡å†™çš„**configure(AuthenticationManagerBuilder)**æ–¹æ³•çš„å‚æ•°.</p>
<p>â€‹	é…ç½®å®Œæˆå, å½“æˆ‘ä»¬å¯åŠ¨é¡¹ç›®å, å…¨å±€çš„<strong>AuthenticationManager</strong>åœ¨æ„å»ºæ—¶ä¼šç›´æ¥ä½¿ç”¨**configure(AuthenticationManagerBuilder)**æ–¹æ³•çš„authå˜é‡å»æ„å»º, ä½¿ç”¨çš„ç”¨æˆ·ä¹Ÿæ˜¯æˆ‘ä»¬é…ç½®ç»™authå˜é‡çš„ç”¨æˆ·,ä½¿ç”¨çš„ç”¨æˆ·ä¹Ÿæ˜¯æˆ‘ä»¬é…ç½®ç»™authå˜é‡çš„ç”¨æˆ·.</p>
<p>â€‹	éœ€è¦æ³¨æ„çš„æ˜¯, ä¸€æ—¦é‡å†™äº†<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•, é‚£ä¹ˆå…¨å±€</strong>AuthenticationManager</strong>å¯¹è±¡ä¸­ä½¿ç”¨çš„ç”¨æˆ·. å°†ä»¥<strong>configure(AuthenticationManagerBuilder)<strong>æ–¹æ³•ä¸­å®šä¹‰çš„ç”¨æˆ·ä¸ºå‡†. æ­¤æ—¶, å¦‚æœæˆ‘ä»¬è¿˜å‘Springå®¹å™¨ä¸­æ³¨å…¥äº†å¦å¤–ä¸€ä¸ª</strong>userDetailsService</strong>å®ä¾‹, é‚£ä¹ˆè¯¥å®ä¾‹ä¸­å®šä¹‰çš„ç”¨æˆ·å°†ä¸ä¼šç”Ÿæ•ˆ(å› ä¸º<strong>AuthenticationConfiguration#getAuthenticationManager</strong>æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨)</p>
<blockquote>
<p>è‡ªå®šä¹‰å¤šç”¨æˆ·</p>
</blockquote>
<p>æˆ‘ä»¬çŸ¥é“è®¤è¯çš„è¿‡ç¨‹æ˜¯å¦‚æœéå†<strong>AuthenticationManager</strong>çš„æ‰€æœ‰<strong>authenticationProvider</strong>, å¦‚æœéƒ½æ²¡æœ‰è®¤è¯åˆ™éå†çˆ¶ç±»çš„<strong>ParentManager</strong>çš„<strong>authenticationProvider</strong>, åªè¦æœ‰ä¸€ä¸ª<strong>authenticationProvider</strong>è®¤è¯æˆåŠŸåˆ™æˆåŠŸ,è‡ªå®šä¹‰å¤šç”¨æˆ·è®¤è¯åˆ™åªéœ€è¦å¢åŠ <strong>authenticationProvider</strong>å°±å¯ä»¥äº†, ä¸‹é¢ä¸¾ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br><br>	<span class="hljs-comment">//è¦†ç›–å…¨å±€çš„AuthenticationManager</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DaoAuthenticationProvider</span> <span class="hljs-variable">daoAuthenticationProvider1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationProvider</span>();<br>    daoAuthenticationProvider1.setUserDetailsService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(<br>        User.builder().username(<span class="hljs-string">&quot;admin2&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;admin123&quot;</span>).build()));<br>    <span class="hljs-type">ProviderManager</span> <span class="hljs-variable">providerManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(daoAuthenticationProvider1);<br><br>    <span class="hljs-type">DaoAuthenticationProvider</span> <span class="hljs-variable">daoAuthenticationProvider2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoAuthenticationProvider</span>();<br>    daoAuthenticationProvider2.setUserDetailsService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(<br>        User.builder().username(<span class="hljs-string">&quot;admin1&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;admin123&quot;</span>).build()));<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(Arrays.asList(daoAuthenticationProvider2), providerManager);<br>  &#125;<br>  <br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.authorizeHttpRequests()<br>        .anyRequest().authenticated()<br>        .and().formLogin()<br>        .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;UsernamePasswordAuthenticationFilter&gt;() &#123;<br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> &#123;<br>            <span class="hljs-comment">//è‡ªå®šä¹‰ObjectPostProcessor</span><br>            object.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<br>            object.setPasswordParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>            object.setAuthenticationFailureHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomFailHandler</span>());<br>            object.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;<br>              response.getWriter().write(<span class="hljs-string">&quot;login success&quot;</span>);<br>            &#125;);<br>            <span class="hljs-keyword">return</span> object;<br>          &#125;<br>        &#125;)<br>        .and().exceptionHandling().accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomAccessDeniedHandler</span>())<br>        .and().authenticationManager(authenticationManager())<br>        .csrf().disable();<br><br>    <span class="hljs-keyword">return</span> http.build();<br>  &#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>









<h2 id="4-10-å¦‚ä½•é…ç½®å¤šä¸ªè¿‡æ»¤å™¨é“¾"><a href="#4-10-å¦‚ä½•é…ç½®å¤šä¸ªè¿‡æ»¤å™¨é“¾" class="headerlink" title="4.10 å¦‚ä½•é…ç½®å¤šä¸ªè¿‡æ»¤å™¨é“¾"></a>4.10 å¦‚ä½•é…ç½®å¤šä¸ªè¿‡æ»¤å™¨é“¾</h2><p>â€‹	åœ¨SpringSecurityä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾, ä¸€ä¸ª<strong>WebSecurityConfigurerAdapter</strong>çš„å®ä¾‹å°±å¯ä»¥é…ç½®ä¸€æ¡è¿‡æ»¤å™¨é“¾.</p>
<p>â€‹	æˆ‘ä»¬æ¥çœ‹å¦‚ä¸‹ä¸€ä¸ªæ¡ˆä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    users.createUser(User.withUsername(<span class="hljs-string">&quot;javaboy&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> users;<br>  &#125;<br><br>  <span class="hljs-meta">@Order(1)</span><br>  <span class="hljs-meta">@Configuration</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig01</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>      users.createUser(User.withUsername(<span class="hljs-string">&quot;bar&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>      http.antMatcher(<span class="hljs-string">&quot;/bar/**&quot;</span>)<br>          .authorizeHttpRequests()<br>          .anyRequest().authenticated()<br>          .and()<br>          .formLogin()<br>          .loginProcessingUrl(<span class="hljs-string">&quot;/bar/login&quot;</span>)<br>          .successForwardUrl(<span class="hljs-string">&quot;/bar/login&quot;</span>)<br>          .successHandler((req, resp, auth) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(auth);<br>            resp.getWriter().write(s);<br>          &#125;)<br>          .permitAll()<br>          .and()<br>          .csrf().disable()<br>          .userDetailsService(users);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Order(2)</span><br>  <span class="hljs-meta">@Configuration</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig02</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      auth.inMemoryAuthentication().withUser(<span class="hljs-string">&quot;javagirl&quot;</span>)<br>          .password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>)<br>          .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>      users.createUser(User.withUsername(<span class="hljs-string">&quot;foo&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>      http.antMatcher(<span class="hljs-string">&quot;/foo/**&quot;</span>)<br>          .authorizeHttpRequests()<br>          .anyRequest().authenticated()<br>          .and()<br>          .formLogin()<br>          .loginProcessingUrl(<span class="hljs-string">&quot;/foo/login&quot;</span>)<br>          .successForwardUrl(<span class="hljs-string">&quot;/foo/login&quot;</span>)<br>          .successHandler((req, resp, auth) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(auth);<br>            resp.getWriter().write(s);<br>          &#125;)<br>          .permitAll()<br>          .and()<br>          .csrf().disable()<br>          .userDetailsService(users);<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨<strong>SecurityConfig</strong>ä¸­åˆ†åˆ«å®šä¹‰ä¸¤ä¸ªé™æ€å†…éƒ¨ç±»<strong>SecurityConfig01</strong>å’Œ<strong>SecurityConfig02</strong>, ä¸¤ä¸ªé…ç½®ç±»éƒ½ç»§æ‰¿è‡ª<strong>WebSecurityConfigurerAdapter</strong>, åˆ†åˆ«é…ç½®ä¸€æ¡è¿‡æ»¤å™¨é“¾</p>
<p>â€‹	å…ˆæ¥çœ‹Security01. åœ¨Security01ä¸­, æˆ‘ä»¬è®¾ç½®è¿‡æ»¤å™¨é“¾çš„æ‹¦æˆªè§„åˆ™æ˜¯&#x2F;bar&#x2F;*, å³å¦‚æœè¯·æ±‚è·¯å¾„æ˜¯&#x2F;bar&#x2F;<strong>æ ¼å¼çš„, åˆ™è¿›å…¥åˆ°Security01çš„è¿‡æ»¤å™¨é“¾è¿™è¿›è¡Œå¤„ç†. åŒæ—¶æˆ‘ä»¬é…ç½®äº†å±€éƒ¨</strong>AuthenticationManager<strong>å¯¹åº”çš„ç”¨æˆ·æ˜¯&#x2F;bar&#x2F;123, ç”±äºæ²¡æœ‰é‡å†™configure(AuthenticationManagerBuilder)æ–¹æ³•, æ‰€ä»¥æ³¨å†Œåˆ°Springå®¹å™¨ä¸­çš„UserDetailsServiceå°†ä½œä¸ºå±€éƒ¨</strong>AuthenticationManager**çš„parentå¯¹åº”çš„ç”¨æˆ·. æ¢å¥è¯è¯´, å¦‚æœç™»å½•çš„è·¯å¾„æ˜¯&#x2F;bar&#x2F;login, é‚£ä¹ˆå¼€å‘è€…å¯ä»¥ä½¿ç”¨bar&#x2F;123å’Œjavaboy&#x2F;123ä¸¤ä¸ªç”¨æˆ·è¿›è¡Œç™»å½•.</p>
<img src="/2022/01/26/SpringSecurity/image-20230323165755959.png" srcset="/img/loading.gif" lazyload alt="image-20230323165755959" style="zoom:50%;">



<p>â€‹	å†æ¥çœ‹SecurityConfig02. åœ¨Security02ä¸­, æˆ‘ä»¬è®¾ç½®è¿‡æ»¤å™¨é“¾çš„æ‹¦æˆªè§„åˆ™æ˜¯&#x2F;foo&#x2F;**, å³å¦‚æœè¯·æ±‚è·¯å¾„æ˜¯&#x2F;foo&#x2F;**æ ¼å¼çš„, åˆ™è¿›å…¥åˆ°Security02çš„è¿‡æ»¤å™¨é“¾ä¸­è¿›è¡Œå¤„ç†, åŒæ—¶æˆ‘ä»¬é…ç½®äº†å±€éƒ¨<strong>AuthenticationManager</strong>å¯¹åº”çš„ç”¨æˆ·æ˜¯foo&#x2F;123, ç”±äºé‡å†™äº†configure(AuthenticationManagerBuilder)æ–¹æ³•, åœ¨è¯¥æ–¹æ³•ä¸­å®šä¹‰äº†å±€éƒ¨AuthenticationManagerçš„parentå¯¹åº”çš„ç”¨æˆ·, æ­¤æ—¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­çš„UserDetailsServiceå®ä¾‹å¯¹äº&#x2F;foo&#x2F;**è¿‡æ»¤å™¨é“¾ä¸å†ç”Ÿæ•ˆ,. æ¢å¥è¯è¯´, å¦‚æœç™»å½•è·¯å¾„æ˜¯&#x2F;foo&#x2F;login, å¼€å‘è€…å¯ä»¥ä½¿ç”¨foo&#x2F;123å’Œjavagirl&#x2F;123ä¸¤ä¸ªç”¨æˆ·è¿›è¡Œç™»å½•, è€Œä¸å¯ä»¥ä½¿ç”¨javaboy&#x2F;123è¿›è¡Œç™»å½•. ç™»å½•æ•ˆæœå¦‚ä¸‹:</p>
<img src="/2022/01/26/SpringSecurity/image-20230323172948891.png" srcset="/img/loading.gif" lazyload alt="image-20230323172948891" style="zoom:50%;">

<p>â€‹	éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœé…ç½®äº†å¤šä¸ªè¿‡æ»¤å™¨é“¾, éœ€è¦ä½¿ç”¨**@Order**æ³¨è§£æ¥æ ‡è®°ä¸åŒé…ç½®çš„ä¼˜å…ˆçº§(å³ä¸åŒè¿‡æ»¤å™¨é“¾çš„ä¼˜å…ˆçº§), æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½. å½“è¯·æ±‚åˆ°æ¥æ—¶, ä¼š æŒ‰ç…§è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ä»é«˜åˆ°ä½, ä¾æ¬¡è¿›è¡ŒåŒ¹é….</p>
<h1 id="ç¬¬äº”ç« -å¯†ç åŠ å¯†"><a href="#ç¬¬äº”ç« -å¯†ç åŠ å¯†" class="headerlink" title="ç¬¬äº”ç«  å¯†ç åŠ å¯†"></a>ç¬¬äº”ç«  å¯†ç åŠ å¯†</h1><ul>
<li>å¯†ç ä¸ºä»€ä¹ˆè¦åŠ å¯†</li>
<li>å¸¸è§åŠ å¯†çš„è§£å†³æ–¹æ¡ˆ</li>
<li>PasswordEncoder è¯¦è§£</li>
<li>ä¼˜é›…ä½¿ç”¨åŠ å¯†</li>
</ul>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="åŠ å¯†æ„ä¹‰"><a href="#åŠ å¯†æ„ä¹‰" class="headerlink" title="åŠ å¯†æ„ä¹‰"></a>åŠ å¯†æ„ä¹‰</h3><p>â€‹	2011 å¹´12æœˆ21 æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å«600ä¸‡ä¸ª CSDN ç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”Ÿå CSDN åœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºäº†å£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“ç³»2009 å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„æ¼ï¼Œå·²ç»å‘è­¦æ–¹æŠ¥<br>æ¡ˆï¼Œååˆåœ¨å®˜ç½‘å‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äº CSDN æŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„æ¼å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚ç”±äºæœ‰äº†è¿™ä¹ˆå¤šå‰è½¦ä¹‹é‰´ï¼Œæˆ‘ä»¬ç°åœ¨åšç³»ç»Ÿæ—¶ï¼Œå¯†ç éƒ½è¦åŠ å¯†å¤„ç†ã€‚</p>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œå‡¡æ˜¯æ¶‰åŠå¯†ç çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨æ˜æ–‡å­˜å‚¨ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™è‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥æé«˜çš„å®‰å…¨é£é™©ã€‚åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¯†ç ä¸ä»…éœ€è¦åŠ å¯†ï¼Œè¿˜éœ€è¦åŠ <code>ç›</code>ï¼Œæœ€å¤§ç¨‹åº¦åœ°ä¿è¯å¯†ç å®‰å…¨ã€‚</p>
<h3 id="å¸¸è§æ–¹æ¡ˆ"><a href="#å¸¸è§æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§æ–¹æ¡ˆ"></a>å¸¸è§æ–¹æ¡ˆ</h3><h4 id="Hash-ç®—æ³•"><a href="#Hash-ç®—æ³•" class="headerlink" title="Hash ç®—æ³•"></a>Hash ç®—æ³•</h4><p>â€‹	æœ€æ—©æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼ SHA-256 ã€SHA-512 ã€MD5ç­‰è¿™æ ·çš„å•å‘ Hash ç®—æ³•ã€‚ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œä¿å­˜åœ¨æ•°æ®åº“ä¸­ä¸å†æ˜¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œè€Œæ˜¯ç»è¿‡ SHA-256 åŠ å¯†è®¡ç®—çš„ä¸€ä¸ªå­—è¡Œä¸²ï¼Œå½“ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç ç”¨ SHA-256 è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆä¹‹åï¼Œå†å’Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œè¿›è€Œç¡®å®šç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœç³»ç»Ÿé­é‡æ”»å‡»ï¼Œæœ€å¤šä¹Ÿåªæ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†æ–‡è¢«æ³„æ¼ã€‚</p>
<p>â€‹	è¿™æ ·å°±ç»å¯¹å®‰å…¨äº†å—ï¼Ÿç”±äºå½©è™¹è¡¨è¿™ç§æ”»å‡»æ–¹å¼çš„å­˜åœ¨ä»¥åŠéšç€è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•ï¼Œæ¯ç§’æ‰§è¡Œæ•°åäº¿æ¬¡ HASHè®¡ç®—å·±ç»å˜å¾—è½»è½»æ¾æ¾ï¼Œè¿™æ„å‘³ç€å³ä½¿ç»™å¯†ç åŠ å¯†åŠ ç›ä¹Ÿä¸å†å®‰å…¨ã€‚</p>
<p>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin">å½©è™¹è¡¨</a></p>
<h4 id="å•å‘è‡ªé€‚åº”å‡½æ•°"><a href="#å•å‘è‡ªé€‚åº”å‡½æ•°" class="headerlink" title="å•å‘è‡ªé€‚åº”å‡½æ•°"></a>å•å‘è‡ªé€‚åº”å‡½æ•°<Adaptive one-way functions></Adaptive></h4><p>åœ¨Spring Security ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯ç”¨ä¸€ç§è‡ªé€‚åº”å•å‘å‡½æ•° (Adaptive One-way Functions)æ¥å¤„ç†å¯†ç é—®é¢˜ï¼Œè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åœ¨è¿›è¡Œå¯†ç åŒ¹é…æ—¶ï¼Œä¼šæœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼ˆä¾‹å¦‚CPUã€å†…å­˜ç­‰ï¼‰ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ¶æ„ç”¨æˆ·æ”»å‡»ç³»ç»Ÿçš„éš¾åº¦ã€‚åœ¨Spring Securiy ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ bcryptã€PBKDF2ã€sCrypt ä»¥åŠ argon2 æ¥ä½“éªŒè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åŠ å¯†ã€‚ç”±äºè‡ªé€‚åº”å•å‘å‡½æ•°æœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼Œå› æ­¤æ¯ä¸ªç™»å½•è®¤è¯è¯·æ±‚éƒ½ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä½†æ˜¯ Spring Secuity ä¸ä¼šé‡‡å–ä»»ä½•æªæ–½æ¥æé«˜å¯†ç éªŒè¯é€Ÿåº¦ï¼Œå› ä¸ºå®ƒæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
<p>å‚è€ƒ 1: <a target="_blank" rel="noopener" href="https://byronhe.gitbooks.io/libsodium/content/password_hashing/">https://byronhe.gitbooks.io/libsodium/content/password_hashing/</a></p>
<p>å‚è€ƒ 2: <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md">https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md</a></p>
<ul>
<li><p>BCryptPasswordEncoder</p>
<p>BCryptPasswordEncoder ä½¿ç”¨ bcrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œä¸ºäº†æé«˜å¯†ç çš„å®‰å…¨æ€§ï¼Œbcryptç®—æ³•æ•…æ„é™ä½è¿è¡Œé€Ÿåº¦ï¼Œä»¥å¢å¼ºå¯†ç ç ´è§£çš„éš¾åº¦ã€‚åŒæ—¶ BCryptP asswordEncoder â€œä¸ºè‡ªå·±å¸¦ç›â€å¼€å‘è€…ä¸éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªâ€œç›â€ å­—æ®µï¼Œä½¿ç”¨ BCryptPasswordEncoder åŠ å¯†åçš„å­—ç¬¦ä¸²å°±å·²ç»â€œå¸¦ç›â€äº†ï¼Œå³ä½¿ç›¸åŒçš„æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„åŠ å¯†å­—ç¬¦ä¸²éƒ½ä¸ç›¸åŒã€‚</p>
</li>
<li><p>Argon2PasswordEncoder</p>
<p>Argon2PasswordEncoder ä½¿ç”¨ Argon2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼ŒArgon2 æ›¾åœ¨ Password Hashing Competition ç«èµ›ä¸­è·èƒœã€‚ä¸ºäº†è§£å†³åœ¨å®šåˆ¶ç¡¬ä»¶ä¸Šå¯†ç å®¹æ˜“è¢«ç ´è§£çš„é—®é¢˜ï¼ŒArgon2ä¹Ÿæ˜¯æ•…æ„é™ä½è¿ç®—é€Ÿåº¦ï¼ŒåŒæ—¶éœ€è¦å¤§é‡å†…å­˜ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
</li>
<li><p>Pbkdf2PasswordEncoder</p>
<p>Pbkdf2PasswordEncoder ä½¿ç”¨ PBKDF2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢å‡ ç§ç±»ä¼¼ï¼ŒPBKDF2</p>
<p>ç®—æ³•ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œå½“éœ€è¦ FIPS (Federal Information Processing Standard,ç¾å›½è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ï¼‰è®¤è¯æ—¶ï¼ŒPBKDF2 ç®—æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
</li>
<li><p>SCryptPasswordEncoder</p>
<p>SCryptPasswordEncoder ä½¿ç”¨scrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢çš„å‡ ç§ç±»ä¼¼ï¼Œserypt ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œè€Œä¸”éœ€è¦å¤§é‡å†…å­˜ã€‚</p>
</li>
</ul>
<h2 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h2><p>é€šè¿‡å¯¹è®¤è¯æµç¨‹æºç åˆ†æå¾—çŸ¥ï¼Œå®é™…å¯†ç æ¯”è¾ƒæ˜¯ç”±PasswordEncoderå®Œæˆçš„ï¼Œå› æ­¤åªéœ€è¦ä½¿ç”¨PasswordEncoder ä¸åŒå®ç°å°±å¯ä»¥å®ç°ä¸åŒæ–¹å¼åŠ å¯†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>	String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span>;<br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span>;<br>	<span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<p>é»˜è®¤æä¾›åŠ å¯†ç®—æ³•å¦‚ä¸‹:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220127162622771.png" srcset="/img/loading.gif" lazyload alt="image-20220127162622771"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220127162759461.png" srcset="/img/loading.gif" lazyload alt="image-20220127162759461"></p>
<h2 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a>DelegatingPasswordEncoder</h2><p>æ ¹æ®ä¸Šé¢ PasswordEncoderçš„ä»‹ç»ï¼Œå¯èƒ½ä¼šä»¥ä¸º Spring security ä¸­é»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆåº”è¯¥æ˜¯å››ç§è‡ªé€‚åº”å•å‘åŠ å¯†å‡½æ•°ä¸­çš„ä¸€ç§ï¼Œå…¶å®ä¸ç„¶ï¼Œåœ¨ spring Security 5.0ä¹‹åï¼Œé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå…¶å®æ˜¯ DelegatingPasswordEncoderã€‚ä»åå­—ä¸Šæ¥çœ‹ï¼ŒDelegatingPaswordEncoder æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œå¹¶éä¸€ç§å…¨æ–°çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼ŒDeleggtinePasswordEncoder ä¸»è¦ç”¨æ¥ä»£ç†ä¸Šé¢ä»‹ç»çš„ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚ä¸ºä»€ä¹ˆé‡‡DelegatingPasswordEncoder è€Œä¸æ˜¯æŸä¸€ä¸ªå…·ä½“åŠ å¯†æ–¹å¼ä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå‘¢ï¼Ÿä¸»è¦è€ƒè™‘äº†å¦‚ä¸‹ä¸¤æ–¹é¢çš„å› ç´ ï¼š</p>
<ul>
<li><p>å…¼å®¹æ€§ï¼šä½¿ç”¨ DelegatingPasswrordEncoder å¯ä»¥å¸®åŠ©è®¸å¤šä½¿ç”¨æ—§å¯†ç åŠ å¯†æ–¹å¼çš„ç³»ç»Ÿé¡ºåˆ©è¿ç§»åˆ° Spring security ä¸­ï¼Œå®ƒå…è®¸åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šç§ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚</p>
</li>
<li><p>ä¾¿æ·æ€§ï¼šå¯†ç å­˜å‚¨çš„æœ€ä½³æ–¹æ¡ˆä¸å¯èƒ½ä¸€ç›´ä¸å˜ï¼Œå¦‚æœä½¿ç”¨ DelegatingPasswordEncoderä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼Œå½“éœ€è¦ä¿®æ”¹åŠ å¯†æ–¹æ¡ˆæ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¾ˆå°ä¸€éƒ¨åˆ†ä»£ç å°±å¯ä»¥å®ç°ã€‚</p>
</li>
</ul>
<h4 id="DelegatingPasswordEncoderæºç "><a href="#DelegatingPasswordEncoderæºç " class="headerlink" title="DelegatingPasswordEncoderæºç "></a>DelegatingPasswordEncoderæºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelegatingPasswordEncoder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>  ....<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<h4 id="PasswordEncoderFactoriesæºç "><a href="#PasswordEncoderFactoriesæºç " class="headerlink" title="PasswordEncoderFactoriesæºç "></a>PasswordEncoderFactoriesæºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PasswordEncoder <span class="hljs-title function_">createDelegatingPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">String</span> <span class="hljs-variable">encodingId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bcrypt&quot;</span>;<br>		Map&lt;String, PasswordEncoder&gt; encoders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>		encoders.put(encodingId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>());<br>		encoders.put(<span class="hljs-string">&quot;ldap&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.LdapShaPasswordEncoder());<br>		encoders.put(<span class="hljs-string">&quot;MD4&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.Md4PasswordEncoder());<br>		encoders.put(<span class="hljs-string">&quot;MD5&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">&quot;MD5&quot;</span>));<br>		encoders.put(<span class="hljs-string">&quot;noop&quot;</span>, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());<br>		encoders.put(<span class="hljs-string">&quot;pbkdf2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pbkdf2PasswordEncoder</span>());<br>		encoders.put(<span class="hljs-string">&quot;scrypt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SCryptPasswordEncoder</span>());<br>		encoders.put(<span class="hljs-string">&quot;SHA-1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">&quot;SHA-1&quot;</span>));<br>		encoders.put(<span class="hljs-string">&quot;SHA-256&quot;</span>,<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">&quot;SHA-256&quot;</span>));<br>		encoders.put(<span class="hljs-string">&quot;sha256&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.StandardPasswordEncoder());<br>		encoders.put(<span class="hljs-string">&quot;argon2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Argon2PasswordEncoder</span>());<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);<br>	&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•ä½¿ç”¨-PasswordEncoder"><a href="#å¦‚ä½•ä½¿ç”¨-PasswordEncoder" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ PasswordEncoder"></a>å¦‚ä½•ä½¿ç”¨ PasswordEncoder</h2><ul>
<li>æŸ¥çœ‹WebSecurityConfigurerAdapterç±»ä¸­æºç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyPasswordEncoder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>		<span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br>		<span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;<br>		LazyPasswordEncoder(ApplicationContext applicationContext) &#123;<br>			<span class="hljs-built_in">this</span>.applicationContext = applicationContext;<br>		&#125;<br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span> &#123;<br>			<span class="hljs-keyword">return</span> getPasswordEncoder().encode(rawPassword);<br>		&#125;<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span> &#123;<br>			<span class="hljs-keyword">return</span> getPasswordEncoder().matches(rawPassword, encodedPassword);<br>		&#125;<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> &#123;<br>			<span class="hljs-keyword">return</span> getPasswordEncoder().upgradeEncoding(encodedPassword);<br>		&#125;<br><br>		<span class="hljs-keyword">private</span> PasswordEncoder <span class="hljs-title function_">getPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.passwordEncoder != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.passwordEncoder;<br>			&#125;<br>			<span class="hljs-type">PasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> getBeanOrNull(PasswordEncoder.class);<br>			<span class="hljs-keyword">if</span> (passwordEncoder == <span class="hljs-literal">null</span>) &#123;<br>				passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();<br>			&#125;<br>			<span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;<br>			<span class="hljs-keyword">return</span> passwordEncoder;<br>		&#125;<br><br>		<span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">getBeanOrNull</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.applicationContext.getBean(type);<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>			<span class="hljs-keyword">return</span> getPasswordEncoder().toString();<br>		&#125;<br><br>	&#125;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¦‚æœåœ¨å·¥å‚ä¸­æŒ‡å®šäº†PasswordEncoderï¼Œå°±ä¼šä½¿ç”¨æŒ‡å®šPasswordEncoderï¼Œå¦åˆ™å°±ä¼šä½¿ç”¨é»˜è®¤DelegatingPasswordEncoderã€‚</p>
<h2 id="å¯†ç åŠ å¯†å®æˆ˜"><a href="#å¯†ç åŠ å¯†å®æˆ˜" class="headerlink" title="å¯†ç åŠ å¯†å®æˆ˜"></a>å¯†ç åŠ å¯†å®æˆ˜</h2><ul>
<li>æµ‹è¯•ç”Ÿæˆçš„å¯†ç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">//1.BCryptPasswordEncoder</span><br>  <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">bCryptPasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>  System.out.println(bCryptPasswordEncoder.encode(<span class="hljs-string">&quot;123&quot;</span>));<br><br>  <span class="hljs-comment">//2.Pbkdf2PasswordEncoder</span><br>  <span class="hljs-type">Pbkdf2PasswordEncoder</span> <span class="hljs-variable">pbkdf2PasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pbkdf2PasswordEncoder</span>();<br>  System.out.println(pbkdf2PasswordEncoder.encode(<span class="hljs-string">&quot;123&quot;</span>));<br><br>  <span class="hljs-comment">//3.SCryptPasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–</span><br>  <span class="hljs-type">SCryptPasswordEncoder</span> <span class="hljs-variable">sCryptPasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SCryptPasswordEncoder</span>();<br>  System.out.println(sCryptPasswordEncoder.encode(<span class="hljs-string">&quot;123&quot;</span>));<br><br>  <span class="hljs-comment">//4.Argon2PasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–</span><br>  <span class="hljs-type">Argon2PasswordEncoder</span> <span class="hljs-variable">argon2PasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Argon2PasswordEncoder</span>();<br>  System.out.println(argon2PasswordEncoder.encode(<span class="hljs-string">&quot;123&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨å›ºå®šå¯†ç åŠ å¯†æ–¹æ¡ˆ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">BcryptPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>     &#125;<br>  	 <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-string">&quot;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="hljs-string">&quot;xxx&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨çµæ´»å¯†ç åŠ å¯†æ–¹æ¡ˆ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>  	 <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-string">&quot;&#123;bcrypt&#125;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="hljs-string">&quot;xxx&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å¯†ç è‡ªåŠ¨å‡çº§"><a href="#å¯†ç è‡ªåŠ¨å‡çº§" class="headerlink" title="å¯†ç è‡ªåŠ¨å‡çº§"></a>å¯†ç è‡ªåŠ¨å‡çº§</h2><p>æ¨èä½¿ç”¨DelegatingPasswordEncoder çš„å¦å¤–ä¸€ä¸ªå¥½å¤„å°±æ˜¯è‡ªåŠ¨è¿›è¡Œå¯†ç åŠ å¯†æ–¹æ¡ˆçš„å‡çº§ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨æ•´åˆä¸€äº›è€çš„ç³»ç»Ÿæ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<ul>
<li>å‡†å¤‡åº“è¡¨</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- ç”¨æˆ·è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>`<br>(<br>    `id`                    <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `username`              <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `password`              <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `enabled`               tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `accountNonExpired`     tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `accountNonLocked`      tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `credentialsNonExpired` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><span class="hljs-comment">-- è§’è‰²è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `role`<br>(<br>    `id`      <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `name`    <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `name_zh` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><span class="hljs-comment">-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `user_role`<br>(<br>    `id`  <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `uid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>    KEY   `uid` (`uid`),<br>    KEY   `rid` (`rid`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ’å…¥æ•°æ®</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- æ’å…¥ç”¨æˆ·æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;blr&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><span class="hljs-comment">-- æ’å…¥è§’è‰²æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ROLE_product&#x27;</span>, <span class="hljs-string">&#x27;å•†å“ç®¡ç†å‘˜&#x27;</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;ROLE_admin&#x27;</span>, <span class="hljs-string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;ROLE_user&#x27;</span>, <span class="hljs-string">&#x27;ç”¨æˆ·ç®¡ç†å‘˜&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><span class="hljs-comment">-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®</span><br><span class="hljs-keyword">BEGIN</span>;<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role`<br>  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br><span class="hljs-keyword">COMMIT</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ•´åˆ mybatis</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=false</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:/mapper/*.xml</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.baizhi.entity</span><br><span class="hljs-attr">logging.level.com.baizhi.dao</span>=<span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure>

<ul>
<li>ç¼–å†™å®ä½“ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> Boolean enabled;<br>    <span class="hljs-keyword">private</span> Boolean accountNonExpired;<br>    <span class="hljs-keyword">private</span> Boolean accountNonLocked;<br>    <span class="hljs-keyword">private</span> Boolean credentialsNonExpired;<br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Role role : roles) &#123;<br>            authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(role.getName()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> authorities;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> accountNonExpired;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccountNonExpired</span><span class="hljs-params">(Boolean accountNonExpired)</span> &#123;<br>        <span class="hljs-built_in">this</span>.accountNonExpired = accountNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> accountNonLocked;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccountNonLocked</span><span class="hljs-params">(Boolean accountNonLocked)</span> &#123;<br>        <span class="hljs-built_in">this</span>.accountNonLocked = accountNonLocked;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> credentialsNonExpired;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCredentialsNonExpired</span><span class="hljs-params">(Boolean credentialsNonExpired)</span> &#123;<br>        <span class="hljs-built_in">this</span>.credentialsNonExpired = credentialsNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> enabled;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEnabled</span><span class="hljs-params">(Boolean enabled)</span> &#123;<br>        <span class="hljs-built_in">this</span>.enabled = enabled;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRoles</span><span class="hljs-params">(List&lt;Role&gt; roles)</span> &#123;<br>        <span class="hljs-built_in">this</span>.roles = roles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String nameZh;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNameZh</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> nameZh;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNameZh</span><span class="hljs-params">(String nameZh)</span> &#123;<br>        <span class="hljs-built_in">this</span>.nameZh = nameZh;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»ºdao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    List&lt;Role&gt; <span class="hljs-title function_">getRolesByUid</span><span class="hljs-params">(Integer uid)</span>;<br>    User <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>;<br>  	Integer <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username,<span class="hljs-meta">@Param(&quot;password&quot;)</span> String password)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ç¼–å†™ mapper</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loadUserByUsername&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        select id,<br>               username,<br>               password,<br>               enabled,<br>               accountNonExpired,<br>               accountNonLocked,<br>               credentialsNonExpired<br>        from `user`<br>        where username = #&#123;username&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getRolesByUid&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Role&quot;</span>&gt;</span><br>        select r.id,<br>               r.name,<br>               r.name_zh nameZh<br>        from `role` r,<br>             `user_role` ur<br>        where r.id = ur.rid<br>          and ur.uid = #&#123;uid&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>  <br>  	<span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updatePassword&quot;</span>&gt;</span><br>      update `user` set password=#&#123;password&#125;<br>      where username=#&#123;username&#125;<br>  	<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>ç¼–å†™service å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span>,UserDetailsPasswordService &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDao userDao;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetailService</span><span class="hljs-params">(UserDao userDao)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userDao.loadUserByUsername(username);<br>        <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(user)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç”¨æˆ·ä¸å­˜åœ¨!&quot;</span>);<br>        &#125;<br>        user.setRoles(userDao.getRolesByUid(user.getId()));<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>  <br>  	 <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UserDetails user, String newPassword)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userDao.updatePassword(user.getUsername(), newPassword);<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span>) &#123;<br>            ((User) user).setPassword(newPassword);<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>é…ç½®securityconfig</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MyUserDetailService myUserDetailService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(MyUserDetailService myUserDetailService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.myUserDetailService = myUserDetailService;<br>    &#125;<br>      <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//æŸ¥è¯¢æ•°æ®åº“</span><br>        auth.userDetailsService(myUserDetailService);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨é¡¹ç›®æµ‹è¯•</li>
</ul>
<h1 id="ç¬¬å…­ç« -Jwt-SpringSecurityå®æˆ˜"><a href="#ç¬¬å…­ç« -Jwt-SpringSecurityå®æˆ˜" class="headerlink" title="ç¬¬å…­ç«  Jwt + SpringSecurityå®æˆ˜"></a>ç¬¬å…­ç«  Jwt + SpringSecurityå®æˆ˜</h1><h3 id="å…¨å±€å¼‚å¸¸å¤„ç†å™¨"><a href="#å…¨å±€å¼‚å¸¸å¤„ç†å™¨" class="headerlink" title="å…¨å±€å¼‚å¸¸å¤„ç†å™¨"></a>å…¨å±€å¼‚å¸¸å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å…¨å±€å¼‚å¸¸å¤„ç†</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br><br>  <span class="hljs-meta">@ResponseStatus(HttpStatus.FORBIDDEN)</span><br>  <span class="hljs-meta">@ExceptionHandler(value = AccessDeniedException.class)</span><br>  <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handler</span><span class="hljs-params">(AccessDeniedException e)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;securityæƒé™ä¸è¶³ï¼š----------------&#123;&#125;&quot;</span>, e.getMessage());<br>    <span class="hljs-keyword">return</span> Result<br>        .fail(<span class="hljs-string">&quot;æƒé™ä¸è¶³&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span><br>  <span class="hljs-meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span><br>  <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handler</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;å®ä½“æ ¡éªŒå¼‚å¸¸ï¼š----------------&#123;&#125;&quot;</span>, e.getMessage());<br>    <span class="hljs-type">BindingResult</span> <span class="hljs-variable">bindingResult</span> <span class="hljs-operator">=</span> e.getBindingResult();<br>    <span class="hljs-type">ObjectError</span> <span class="hljs-variable">objectError</span> <span class="hljs-operator">=</span> bindingResult.getAllErrors().stream().findFirst().get();<br>    <span class="hljs-keyword">return</span> Result.fail(objectError.getDefaultMessage());<br>  &#125;<br><br>  <span class="hljs-meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span><br>  <span class="hljs-meta">@ExceptionHandler(value = IllegalArgumentException.class)</span><br>  <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handler</span><span class="hljs-params">(IllegalArgumentException e)</span> &#123;<br>    log.error(<span class="hljs-string">&quot;Assertå¼‚å¸¸ï¼š----------------&#123;&#125;&quot;</span>, e.getMessage());<br>    <span class="hljs-keyword">return</span> Result.fail(e.getMessage());<br>  &#125;<br><br>  <span class="hljs-meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span><br>  <span class="hljs-meta">@ExceptionHandler(value = RuntimeException.class)</span><br>  <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handler</span><span class="hljs-params">(RuntimeException e)</span> &#123;<br>    log.error(<span class="hljs-string">&quot;è¿è¡Œæ—¶å¼‚å¸¸ï¼š----------------&#123;&#125;&quot;</span>, e);<br>    <span class="hljs-keyword">return</span> Result.fail(e.getMessage());<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h3 id="MD5åŠ å¯†"><a href="#MD5åŠ å¯†" class="headerlink" title="MD5åŠ å¯†"></a>MD5åŠ å¯†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> MD5åŠ å¯†å·¥å…·ç±»</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gaozhe</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/2/6 ä¸‹åˆ8:51</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MD5</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String strSrc)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">char</span> hexChars[] = &#123;<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>,<br>                    <span class="hljs-string">&#x27;9&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>&#125;;<br>            <span class="hljs-type">byte</span>[] bytes = strSrc.getBytes();<br>            <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>            md.update(bytes);<br>            bytes = md.digest();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> bytes.length;<br>            <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[j * <span class="hljs-number">2</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bytes.length; i++) &#123;<br>                <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> bytes[i];<br>                chars[k++] = hexChars[b &gt;&gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">0xf</span>];<br>                chars[k++] = hexChars[b &amp; <span class="hljs-number">0xf</span>];<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(chars);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;MD5åŠ å¯†å‡ºé”™ï¼ï¼+&quot;</span> + e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>







<h3 id="DefaultPasswordEncoder"><a href="#DefaultPasswordEncoder" class="headerlink" title="DefaultPasswordEncoder"></a>DefaultPasswordEncoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> é»˜è®¤å¯†ç ç¼–ç å™¨</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gaozhe</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/2/6 ä¸‹åˆ8:40</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultPasswordEncoder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>(-<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultPasswordEncoder</span><span class="hljs-params">(<span class="hljs-type">int</span> strength)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é‡‡ç”¨MD5åŠ å¯†</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> rawPassword åŸç”Ÿå¯†ç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> md5ç¼–ç </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> MD5.encrypt(rawPassword.toString());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿›è¡Œå¯†ç å¯¹æ¯”</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> rawPassword     åŸç”Ÿå¯†ç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> encodedPassword åŠ å¯†åçš„å¯†ç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> encodedPassword.equals(MD5.encrypt(rawPassword.toString()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>securityé…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> DefaultPasswordEncoder <span class="hljs-title function_">defaultPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPasswordEncoder</span>();<br>  &#125;<br></code></pre></td></tr></table></figure>





<h3 id="Tokenå·¥å…·ç±»"><a href="#Tokenå·¥å…·ç±»" class="headerlink" title="Tokenå·¥å…·ç±»"></a>Tokenå·¥å…·ç±»</h3><blockquote>
<p>ä¾èµ–</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--å¼•å…¥jwt--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--å¼•å…¥fastjson--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.58<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>å·¥å…·ç±»</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.auth0.jwt.JWT;<br><span class="hljs-keyword">import</span> com.auth0.jwt.JWTCreator;<br><span class="hljs-keyword">import</span> com.auth0.jwt.JWTVerifier;<br><span class="hljs-keyword">import</span> com.auth0.jwt.algorithms.Algorithm;<br><span class="hljs-keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> å°è£…Tokenå·¥å…·ç±»</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gaozhe</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/1/31 ä¸Šåˆ10:13</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;jwt&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtils</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLAIN_KEY_USERNAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sub&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLAIN_KEY_CREATED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;created&quot;</span>;<br><br><br>  <span class="hljs-keyword">private</span> String sign;<br><br>  <span class="hljs-keyword">private</span> Integer expiration;<br><br>  <span class="hljs-keyword">private</span> String header;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æ ¹æ®è´Ÿè½½è¿”å›tokenå¯¹è±¡</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> map payload</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> token</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(Map&lt;String, Object&gt; map)</span> &#123;<br>    JWTCreator.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> JWT.create();<br>    builder.withExpiresAt(generateExpirationDate());<br>    map.forEach((k, v) -&gt; &#123;<br>      builder.withClaim(k, JSON.toJSONString(v));<br>    &#125;);<br>    <span class="hljs-keyword">return</span> builder.sign(Algorithm.HMAC512(sign));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * ç”Ÿæˆè¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Tokenè¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">generateExpirationDate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">1000</span> * expiration + System.currentTimeMillis());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * è·å–è´Ÿè½½è§£ç å™¨</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> è´Ÿè½½è§£ç å™¨</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> DecodedJWT <span class="hljs-title function_">getDecode</span><span class="hljs-params">(String token)</span> &#123;<br>    <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(Algorithm.HMAC512(sign)).build();<br>    <span class="hljs-keyword">return</span> verifier.verify(token);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * è·å–è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getExpiredDateFromToken</span><span class="hljs-params">(String token)</span> &#123;<br>    <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> getDecode(token);<br>    <span class="hljs-keyword">return</span> decode.getExpiresAt();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * è·å–payload</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> è´Ÿè½½</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPayloadFromToken</span><span class="hljs-params">(String token)</span> &#123;<br>    <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> getDecode(token);<br>    <span class="hljs-keyword">return</span> decode.getPayload();<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * tokenæ˜¯å¦è¿‡æœŸ</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTokenExpired</span><span class="hljs-params">(String token)</span> &#123;<br>    <span class="hljs-type">Date</span> <span class="hljs-variable">expires</span> <span class="hljs-operator">=</span> getExpiredDateFromToken(token);<br>    <span class="hljs-keyword">return</span> expires.before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * è·å–ç”¨æˆ·å</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> è·å–ç”¨æˆ·å</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsernameFromToken</span><span class="hljs-params">(String token)</span> &#123;<br>    String username;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> getDecode(token);<br>      username = decode.getSubject();<br>      <span class="hljs-keyword">if</span> (Objects.isNull(username)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      username = username.substring(<span class="hljs-number">1</span>, username.length() - <span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      username = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> username;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * åˆ¤æ–­tokenæ˜¯å¦è¿‡æœŸ</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token       tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> userDetails userDetails</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateToken</span><span class="hljs-params">(String token, UserDetails userDetails)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getUsernameFromToken(token);<br>    <span class="hljs-keyword">return</span> StringUtils.equalsIgnoreCase(username, userDetails.getUsername()) &amp;&amp; !isTokenExpired(<br>        token);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æ ¹æ®userä¿¡æ¯è¿”å›token</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> userDetails userDetails</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> token</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(UserDetails userDetails)</span> &#123;<br>    Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);<br>    claims.put(CLAIN_KEY_USERNAME, userDetails.getUsername());<br>    claims.put(CLAIN_KEY_CREATED, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-keyword">return</span> generateToken(claims);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æ ¹æ®usernameç”Ÿæˆtoken</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> username ç”¨æˆ·å</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> token</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username)</span> &#123;<br>    Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);<br>    claims.put(CLAIN_KEY_USERNAME, username);<br>    claims.put(CLAIN_KEY_CREATED, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-keyword">return</span> generateToken(claims);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * tokenæ˜¯å¦éœ€è¦åˆ·æ–°</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token tokenå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canRefresh</span><span class="hljs-params">(String token)</span> &#123;<br>    <span class="hljs-keyword">return</span> !isTokenExpired(token);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">refreshToken</span><span class="hljs-params">(String token)</span> &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>    map.put(CLAIN_KEY_CREATED, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-keyword">return</span> generateToken(map);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>jwté…ç½®</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jwt:</span><br>  <span class="hljs-comment"># åŠ å¯†ç§˜é’¥</span><br>  <span class="hljs-attr">sign:</span> <span class="hljs-string">f4e2e52034348f86b67cde581c0f9eb5</span><br>  <span class="hljs-comment"># tokenæœ‰æ•ˆæ—¶é•¿ï¼Œ7å¤©ï¼Œå•ä½ç§’</span><br>  <span class="hljs-attr">expiration:</span> <span class="hljs-number">604800</span><br>  <span class="hljs-attr">header:</span> <span class="hljs-string">Authorization</span><br></code></pre></td></tr></table></figure>







<h3 id="å…¬å…±è¿”å›ç±»"><a href="#å…¬å…±è¿”å›ç±»" class="headerlink" title="å…¬å…±è¿”å›ç±»"></a>å…¬å…±è¿”å›ç±»</h3><blockquote>
<p>ResultCodeEnum</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç»Ÿä¸€è¿”å›ç»“æœçŠ¶æ€ä¿¡æ¯ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResultCodeEnum</span> &#123;<br><br>    SUCCESS(<span class="hljs-number">200</span>,<span class="hljs-string">&quot;æˆåŠŸ&quot;</span>),<br>    FAIL(<span class="hljs-number">201</span>, <span class="hljs-string">&quot;å¤±è´¥&quot;</span>),<br>    PARAM_ERROR( <span class="hljs-number">202</span>, <span class="hljs-string">&quot;å‚æ•°ä¸æ­£ç¡®&quot;</span>),<br>    SERVICE_ERROR(<span class="hljs-number">203</span>, <span class="hljs-string">&quot;æœåŠ¡å¼‚å¸¸&quot;</span>),<br>    DATA_ERROR(<span class="hljs-number">204</span>, <span class="hljs-string">&quot;æ•°æ®å¼‚å¸¸&quot;</span>),<br>    DATA_UPDATE_ERROR(<span class="hljs-number">205</span>, <span class="hljs-string">&quot;æ•°æ®ç‰ˆæœ¬å¼‚å¸¸&quot;</span>),<br><br>    LOGIN_AUTH(<span class="hljs-number">208</span>, <span class="hljs-string">&quot;æœªç™»é™†&quot;</span>),<br>    PERMISSION(<span class="hljs-number">209</span>, <span class="hljs-string">&quot;æ²¡æœ‰æƒé™&quot;</span>),<br><br>    CODE_ERROR(<span class="hljs-number">210</span>, <span class="hljs-string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>),<br><span class="hljs-comment">//    LOGIN_MOBLE_ERROR(211, &quot;è´¦å·ä¸æ­£ç¡®&quot;),</span><br>    LOGIN_DISABLED_ERROR(<span class="hljs-number">212</span>, <span class="hljs-string">&quot;æ”¹ç”¨æˆ·å·²è¢«ç¦ç”¨&quot;</span>),<br>    REGISTER_MOBLE_ERROR(<span class="hljs-number">213</span>, <span class="hljs-string">&quot;æ‰‹æœºå·å·²è¢«ä½¿ç”¨&quot;</span>),<br>    LOGIN_AURH(<span class="hljs-number">214</span>, <span class="hljs-string">&quot;éœ€è¦ç™»å½•&quot;</span>),<br>    LOGIN_ACL(<span class="hljs-number">215</span>, <span class="hljs-string">&quot;æ²¡æœ‰æƒé™&quot;</span>),<br><br>    URL_ENCODE_ERROR( <span class="hljs-number">216</span>, <span class="hljs-string">&quot;URLç¼–ç å¤±è´¥&quot;</span>),<br>    ILLEGAL_CALLBACK_REQUEST_ERROR( <span class="hljs-number">217</span>, <span class="hljs-string">&quot;éæ³•å›è°ƒè¯·æ±‚&quot;</span>),<br>    FETCH_ACCESSTOKEN_FAILD( <span class="hljs-number">218</span>, <span class="hljs-string">&quot;è·å–accessTokenå¤±è´¥&quot;</span>),<br>    FETCH_USERINFO_ERROR( <span class="hljs-number">219</span>, <span class="hljs-string">&quot;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&quot;</span>),<br>    <span class="hljs-comment">//LOGIN_ERROR( 23005, &quot;ç™»å½•å¤±è´¥&quot;),</span><br><br>    PAY_RUN(<span class="hljs-number">220</span>, <span class="hljs-string">&quot;æ”¯ä»˜ä¸­&quot;</span>),<br>    CANCEL_ORDER_FAIL(<span class="hljs-number">225</span>, <span class="hljs-string">&quot;å–æ¶ˆè®¢å•å¤±è´¥&quot;</span>),<br>    CANCEL_ORDER_NO(<span class="hljs-number">225</span>, <span class="hljs-string">&quot;ä¸èƒ½å–æ¶ˆé¢„çº¦&quot;</span>),<br><br>    HOSCODE_EXIST(<span class="hljs-number">230</span>, <span class="hljs-string">&quot;åŒ»é™¢ç¼–å·å·²ç»å­˜åœ¨&quot;</span>),<br>    NUMBER_NO(<span class="hljs-number">240</span>, <span class="hljs-string">&quot;å¯é¢„çº¦å·ä¸è¶³&quot;</span>),<br>    TIME_NO(<span class="hljs-number">250</span>, <span class="hljs-string">&quot;å½“å‰æ—¶é—´ä¸å¯ä»¥é¢„çº¦&quot;</span>),<br><br>    SIGN_ERROR(<span class="hljs-number">300</span>, <span class="hljs-string">&quot;ç­¾åé”™è¯¯&quot;</span>),<br>    HOSPITAL_OPEN(<span class="hljs-number">310</span>, <span class="hljs-string">&quot;åŒ»é™¢æœªå¼€é€šï¼Œæš‚æ—¶ä¸èƒ½è®¿é—®&quot;</span>),<br>    HOSPITAL_LOCK(<span class="hljs-number">320</span>, <span class="hljs-string">&quot;åŒ»é™¢è¢«é”å®šï¼Œæš‚æ—¶ä¸èƒ½è®¿é—®&quot;</span>),<br>    ;<br><br>    <span class="hljs-keyword">private</span> Integer code;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ResultCodeEnum</span><span class="hljs-params">(Integer code, String message)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.message = message;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>Result.java:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å…¨å±€ç»Ÿä¸€è¿”å›ç»“æœç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(value = &quot;å…¨å±€ç»Ÿä¸€è¿”å›ç»“æœ&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;è¿”å›ç &quot;)</span><br>    <span class="hljs-keyword">private</span> Integer code;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;è¿”å›æ¶ˆæ¯&quot;)</span><br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;è¿”å›æ•°æ®&quot;)</span><br>    <span class="hljs-keyword">private</span> T data;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Result</span><span class="hljs-params">()</span>&#123;&#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">build</span><span class="hljs-params">(T data)</span> &#123;<br>        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;T&gt;();<br>        <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>)<br>            result.setData(data);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">build</span><span class="hljs-params">(T body, ResultCodeEnum resultCodeEnum)</span> &#123;<br>        Result&lt;T&gt; result = build(body);<br>        result.setCode(resultCodeEnum.getCode());<br>        result.setMessage(resultCodeEnum.getMessage());<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">build</span><span class="hljs-params">(Integer code, String message)</span> &#123;<br>        Result&lt;T&gt; result = build(<span class="hljs-literal">null</span>);<br>        result.setCode(code);<br>        result.setMessage(message);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">ok</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-literal">null</span>);<br>    &#125;		`<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ“ä½œæˆåŠŸ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">ok</span><span class="hljs-params">(T data)</span>&#123;<br>        Result&lt;T&gt; result = build(data);<br>        <span class="hljs-keyword">return</span> build(data, ResultCodeEnum.SUCCESS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ“ä½œå¤±è´¥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(T data)</span>&#123;<br>        Result&lt;T&gt; result = build(data);<br>        <span class="hljs-keyword">return</span> build(data, ResultCodeEnum.FAIL);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Result&lt;T&gt; <span class="hljs-title function_">message</span><span class="hljs-params">(String msg)</span>&#123;<br>        <span class="hljs-built_in">this</span>.setMessage(msg);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Result&lt;T&gt; <span class="hljs-title function_">code</span><span class="hljs-params">(Integer code)</span>&#123;<br>        <span class="hljs-built_in">this</span>.setCode(code);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.getCode().intValue() == ResultCodeEnum.SUCCESS.getCode().intValue()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>





<h3 id="ç™»å‡ºå¤„ç†å™¨"><a href="#ç™»å‡ºå¤„ç†å™¨" class="headerlink" title="ç™»å‡ºå¤„ç†å™¨"></a>ç™»å‡ºå¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtLogoutSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LogoutSuccessHandler</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> JwtUtils jwtUtils;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">      Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><br>    <span class="hljs-keyword">if</span> (authentication != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityContextLogoutHandler</span>().logout(request, response, authentication);<br>    &#125;<br><br>    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><br>    response.setHeader(jwtUtils.getHeader(), <span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Result.ok(<span class="hljs-string">&quot;&quot;</span>);<br><br>    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));<br><br>    outputStream.flush();<br>    outputStream.close();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>é…ç½®security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">.logout().logoutSuccessHandler(jwtLogoutSuccessHandler)<br></code></pre></td></tr></table></figure>









<h3 id="AuthenticationFailureHandler-è®¤è¯å¤±è´¥å¤„ç†å™¨"><a href="#AuthenticationFailureHandler-è®¤è¯å¤±è´¥å¤„ç†å™¨" class="headerlink" title="AuthenticationFailureHandler: è®¤è¯å¤±è´¥å¤„ç†å™¨"></a>AuthenticationFailureHandler: è®¤è¯å¤±è´¥å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.gz.demo.model.Result;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> è®¤è¯å¤±è´¥å¤„ç†å™¨</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/19 23:02</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFailureHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationFailureHandler</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">      AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Result.fail(exception.getMessage());<br><br>    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));<br><br>    outputStream.flush();<br>    outputStream.close();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="AuthenticationSuccessHandler-è®¤è¯æˆåŠŸå¤„ç†å™¨"><a href="#AuthenticationSuccessHandler-è®¤è¯æˆåŠŸå¤„ç†å™¨" class="headerlink" title="AuthenticationSuccessHandler: è®¤è¯æˆåŠŸå¤„ç†å™¨"></a>AuthenticationSuccessHandler: è®¤è¯æˆåŠŸå¤„ç†å™¨</h3><p>è®¤è¯æˆåŠŸåéœ€è¦å°†tokenè¿”å›,æˆ–è®¾ç½®åˆ°header</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.gz.demo.model.Result;<br><span class="hljs-keyword">import</span> com.gz.demo.utils.JwtUtils;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> è®¤è¯æˆåŠŸå¤„ç†å™¨</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/19 23:17</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationSuccessHandler</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> JwtUtils jwtUtils;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">      Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><br>    <span class="hljs-comment">// ç”Ÿæˆjwtï¼Œå¹¶æ”¾ç½®åˆ°è¯·æ±‚å¤´ä¸­</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> jwtUtils.generateToken(authentication.getName());<br>    response.setHeader(jwtUtils.getHeader(), jwt);<br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Result.ok(<span class="hljs-string">&quot;&quot;</span>);<br>    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));<br>    outputStream.flush();<br>    outputStream.close();<br>  &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>securityé…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>LoginSuccessHandler loginSuccessHandler;<br><br><span class="hljs-meta">@Autowired</span><br>LoginFailureHandler loginFailureHandler;<br><br>...# configureä»£ç ï¼š<br>  <br>  <br>  http.cors().and().csrf().disable()    <br>  .formLogin()      <br>  .failureHandler(loginFailureHandler)      <br>  .successHandler(loginSuccessHandler)<br></code></pre></td></tr></table></figure>









<h3 id="éªŒè¯ç å¼‚å¸¸"><a href="#éªŒè¯ç å¼‚å¸¸" class="headerlink" title="éªŒè¯ç å¼‚å¸¸"></a>éªŒè¯ç å¼‚å¸¸</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> éªŒè¯ç å¼‚å¸¸</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/19 23:04</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptchaException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthenticationException</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CaptchaException</span><span class="hljs-params">(String msg)</span> &#123;<br>    <span class="hljs-built_in">super</span>(msg);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>









<h3 id="éªŒè¯ç è¿‡æ»¤å™¨"><a href="#éªŒè¯ç è¿‡æ»¤å™¨" class="headerlink" title="éªŒè¯ç è¿‡æ»¤å™¨"></a>éªŒè¯ç è¿‡æ»¤å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringUtils;<br><span class="hljs-keyword">import</span> com.gz.demo.config.security.handler.LoginFailureHandler;<br><span class="hljs-keyword">import</span> com.gz.demo.constant.BusinessConstant;<br><span class="hljs-keyword">import</span> com.gz.demo.exception.CaptchaException;<br><span class="hljs-keyword">import</span> com.gz.demo.utils.RedisUtil;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptchaFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  RedisUtil redisUtil;<br><br>  <span class="hljs-meta">@Resource</span><br>  LoginFailureHandler loginFailureHandler;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest httpServletRequest,</span><br><span class="hljs-params">      HttpServletResponse httpServletResponse, FilterChain filterChain)</span><br>      <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> httpServletRequest.getRequestURI();<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/login&quot;</span>.equals(url) &amp;&amp; httpServletRequest.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ ¡éªŒéªŒè¯ç </span><br>        validate(httpServletRequest);<br>      &#125; <span class="hljs-keyword">catch</span> (CaptchaException e) &#123;<br>        <span class="hljs-comment">// äº¤ç»™è®¤è¯å¤±è´¥å¤„ç†å™¨</span><br>        loginFailureHandler.onAuthenticationFailure(httpServletRequest, httpServletResponse, e);<br>      &#125;<br>    &#125;<br><br>    filterChain.doFilter(httpServletRequest, httpServletResponse);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¡éªŒéªŒè¯ç é€»è¾‘</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(HttpServletRequest httpServletRequest)</span> &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> httpServletRequest.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> httpServletRequest.getParameter(<span class="hljs-string">&quot;token&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(code) || StringUtils.isBlank(key)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptchaException</span>(<span class="hljs-string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!code.equals(redisUtil.get(BusinessConstant.CAPTCHA_KEY + key))) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptchaException</span>(<span class="hljs-string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸€æ¬¡æ€§ä½¿ç”¨</span><br>    redisUtil.deleteKey(BusinessConstant.CAPTCHA_KEY + key);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>securityé…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> CaptchaFilter captchaFilter;<br><br>http...<br>.and().addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class);<br></code></pre></td></tr></table></figure>





<h3 id="SecurityUser-è®¤è¯æˆæƒå®ä½“ç±»"><a href="#SecurityUser-è®¤è¯æˆæƒå®ä½“ç±»" class="headerlink" title="SecurityUser: è®¤è¯æˆæƒå®ä½“ç±»"></a>SecurityUser: è®¤è¯æˆæƒå®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.util.Assert;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> è®¤è¯æˆæƒå®ä½“ç±»</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/19 20:10</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Long userId;<br><br>  <span class="hljs-keyword">private</span> String password;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; authorities;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> accountNonExpired;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> accountNonLocked;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> credentialsNonExpired;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> enabled;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityUser</span><span class="hljs-params">(Long userId, String username, String password,</span><br><span class="hljs-params">      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;<br>    <span class="hljs-built_in">this</span>(userId, username, password, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, authorities);<br>  &#125;<br><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityUser</span><span class="hljs-params">(Long userId, String username, String password, <span class="hljs-type">boolean</span> enabled,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> accountNonExpired,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> credentialsNonExpired, <span class="hljs-type">boolean</span> accountNonLocked,</span><br><span class="hljs-params">      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;<br>    Assert.isTrue(username != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">&quot;&quot;</span>.equals(username) &amp;&amp; password != <span class="hljs-literal">null</span>,<br>        <span class="hljs-string">&quot;Cannot pass null or empty values to constructor&quot;</span>);<br>    <span class="hljs-built_in">this</span>.userId = userId;<br>    <span class="hljs-built_in">this</span>.username = username;<br>    <span class="hljs-built_in">this</span>.password = password;<br>    <span class="hljs-built_in">this</span>.enabled = enabled;<br>    <span class="hljs-built_in">this</span>.accountNonExpired = accountNonExpired;<br>    <span class="hljs-built_in">this</span>.credentialsNonExpired = credentialsNonExpired;<br>    <span class="hljs-built_in">this</span>.accountNonLocked = accountNonLocked;<br>    <span class="hljs-built_in">this</span>.authorities = authorities;<br>  &#125;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authorities;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.password;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.username;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.accountNonExpired;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.accountNonLocked;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.credentialsNonExpired;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.enabled;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h3 id="å®ç°UserDetailServiceè‡ªå®šä¹‰æ•°æ®æº"><a href="#å®ç°UserDetailServiceè‡ªå®šä¹‰æ•°æ®æº" class="headerlink" title="å®ç°UserDetailServiceè‡ªå®šä¹‰æ•°æ®æº"></a>å®ç°UserDetailServiceè‡ªå®šä¹‰æ•°æ®æº</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> SysUserService sysUserService;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·</span><br>    <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> sysUserService.loadUserByUserName(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityUser</span>(sysUser.getId(), sysUser.getUsername(),<br>        sysUser.getPassword(), sysUserService.getAuthorityInfo(sysUser.getId()));<br>  &#125;<br>&#125;<br><br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysUserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;SysUserMapper, SysUser&gt; <span class="hljs-keyword">implements</span><br>    <span class="hljs-title class_">SysUserService</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> SysUserMapper sysUserMapper;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SysUser <span class="hljs-title function_">loadUserByUserName</span><span class="hljs-params">(String username)</span> &#123;<br>    <span class="hljs-keyword">return</span> lambdaQuery().eq(SysUser::getUsername, username).eq(SysUser::getStatus, <span class="hljs-number">1</span>).one();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthority</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">//æ ¹æ®userIdè·å–å¯¹åº”çš„è§’è‰²ä¿¡æ¯</span><br>    List&lt;SysRole&gt; roles = sysUserMapper.findRolesByUserId(userId);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">roleCodes</span> <span class="hljs-operator">=</span> roles.stream().map(role -&gt; <span class="hljs-string">&quot;ROLE_&quot;</span> + role.getCode())<br>        .collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>    <span class="hljs-comment">//æ ¹æ®è§’è‰²idè·å–å¯¹åº”çš„èœå•ä¿¡æ¯</span><br>    List&lt;Long&gt; roleIds = roles.stream().map(SysRole::getId).collect(Collectors.toList());<br>    List&lt;SysMenu&gt; menus = sysUserMapper.findMenusByRoleIds(roleIds);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">permissions</span> <span class="hljs-operator">=</span> menus.stream().map(SysMenu::getPerms).collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>    <span class="hljs-keyword">return</span> roleCodes.concat(permissions);<br>  &#125;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorityInfo(Long userId) &#123;<br>    <span class="hljs-comment">//ROLE_admin,sys:user:save,sys:user:list.....</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">authorities</span> <span class="hljs-operator">=</span> getAuthority(userId);<br>     <span class="hljs-comment">// é€šè¿‡å†…ç½®çš„å·¥å…·ç±»ï¼ŒæŠŠæƒé™å­—ç¬¦ä¸²å°è£…æˆGrantedAuthorityåˆ—è¡¨</span><br>    <span class="hljs-keyword">return</span> AuthorityUtils.commaSeparatedStringToAuthorityList(authorities);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SysUser <span class="hljs-title function_">getUserByName</span><span class="hljs-params">(String usernameFromToken)</span> &#123;<br>    <span class="hljs-keyword">return</span> lambdaQuery().eq(SysUser::getUsername, usernameFromToken).eq(SysUser::getStatus, <span class="hljs-number">1</span>)<br>        .one();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>é…ç½®security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> UserDetailServiceImpl userDetailService;<br><br><br><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    auth.userDetailsService(userDetailService);<br>  &#125;<br></code></pre></td></tr></table></figure>





<h3 id="BasicAuthenticationFilter-éªŒè¯jwt-header"><a href="#BasicAuthenticationFilter-éªŒè¯jwt-header" class="headerlink" title="BasicAuthenticationFilter: éªŒè¯jwt header"></a>BasicAuthenticationFilter: éªŒè¯jwt header</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasicAuthenticationFilter</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> JwtUtils jwtUtils;<br><br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> SysUserService sysUserService;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JwtAuthenticationFilter</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> &#123;<br>    <span class="hljs-built_in">super</span>(authenticationManager);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">      FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> request.getHeader(jwtUtils.getHeader());<br>    <span class="hljs-keyword">if</span> (StrUtil.isBlankOrUndefined(jwt)) &#123;<br>      chain.doFilter(request, response);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">usernameFromToken</span> <span class="hljs-operator">=</span> jwtUtils.getUsernameFromToken(jwt);<br><br>    <span class="hljs-keyword">if</span> (usernameFromToken == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtException</span>(<span class="hljs-string">&quot;token å¼‚å¸¸&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (jwtUtils.isTokenExpired(jwt)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtException</span>(<span class="hljs-string">&quot;tokenå·²è¿‡æœŸ&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–ç”¨æˆ·çš„æƒé™ç­‰ä¿¡æ¯</span><br>    <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> sysUserService.loadUserByUserName(usernameFromToken);<br>    <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">token</span><br>        <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(usernameFromToken, <span class="hljs-literal">null</span>,<br>        sysUserService.getAuthorityInfo(sysUser.getId()));<br><br>    SecurityContextHolder.getContext().setAuthentication(token);<br><br>    chain.doFilter(request, response);<br>  &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>





<h3 id="AuthenticationEntryPoint-jwtè®¤è¯å¤±è´¥å¤„ç†å™¨"><a href="#AuthenticationEntryPoint-jwtè®¤è¯å¤±è´¥å¤„ç†å™¨" class="headerlink" title="AuthenticationEntryPoint: jwtè®¤è¯å¤±è´¥å¤„ç†å™¨"></a>AuthenticationEntryPoint: jwtè®¤è¯å¤±è´¥å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationEntryPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationEntryPoint</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">      AuthenticationException authException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><br>    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);<br>    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Result.fail(<span class="hljs-string">&quot;è¯·å…ˆç™»å½•&quot;</span>);<br><br>    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));<br><br>    outputStream.flush();<br>    outputStream.close();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>é…ç½®security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>JWTAuthenticationFilter <span class="hljs-title function_">jwtAuthenticationFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;   <br>  <span class="hljs-type">JWTAuthenticationFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JWTAuthenticationFilter</span>(authenticationManager());   <br>  <span class="hljs-keyword">return</span> filter;<br>&#125;<br><br> .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)<br><br> .and().addFilter(jwtAuthenticationFilter()).addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class) <span class="hljs-comment">// ç™»å½•éªŒè¯ç æ ¡éªŒè¿‡æ»¤å™¨</span><br></code></pre></td></tr></table></figure>





<h3 id="AccessDeniedHandler-æ— æƒé™å¤„ç†å™¨"><a href="#AccessDeniedHandler-æ— æƒé™å¤„ç†å™¨" class="headerlink" title="AccessDeniedHandler: æ— æƒé™å¤„ç†å™¨"></a>AccessDeniedHandler: æ— æƒé™å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAccessDeniedHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><br>    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>    response.setStatus(HttpServletResponse.SC_FORBIDDEN);<br><br>    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Result.fail(accessDeniedException.getMessage());<br><br>    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));<br><br>    outputStream.flush();<br>    outputStream.close();<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>é…ç½®security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">.and()<br>				.exceptionHandling()<br>				.authenticationEntryPoint(jwtAuthenticationEntryPoint)<br>				.accessDeniedHandler(jwtAccessDeniedHandler)<br></code></pre></td></tr></table></figure>





<h3 id="Securityé…ç½®"><a href="#Securityé…ç½®" class="headerlink" title="Securityé…ç½®"></a>Securityé…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.markerhub.security.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>	<span class="hljs-meta">@Autowired</span><br>	LoginFailureHandler loginFailureHandler;<br><br>	<span class="hljs-meta">@Autowired</span><br>	LoginSuccessHandler loginSuccessHandler;<br><br>	<span class="hljs-meta">@Autowired</span><br>	CaptchaFilter captchaFilter;<br><br>	<span class="hljs-meta">@Autowired</span><br>	JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;<br><br>	<span class="hljs-meta">@Autowired</span><br>	JwtAccessDeniedHandler jwtAccessDeniedHandler;<br><br>	<span class="hljs-meta">@Autowired</span><br>	UserDetailServiceImpl userDetailService;<br><br>	<span class="hljs-meta">@Autowired</span><br>	JwtLogoutSuccessHandler jwtLogoutSuccessHandler;<br><br>	<span class="hljs-meta">@Bean</span><br>	JwtAuthenticationFilter <span class="hljs-title function_">jwtAuthenticationFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-type">JwtAuthenticationFilter</span> <span class="hljs-variable">jwtAuthenticationFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationFilter</span>(authenticationManager());<br>		<span class="hljs-keyword">return</span> jwtAuthenticationFilter;<br>	&#125;<br><br>	<span class="hljs-meta">@Bean</span><br>	BCryptPasswordEncoder <span class="hljs-title function_">bCryptPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] URL_WHITELIST = &#123;<br><br>			<span class="hljs-string">&quot;/login&quot;</span>,<br>			<span class="hljs-string">&quot;/logout&quot;</span>,<br>			<span class="hljs-string">&quot;/captcha&quot;</span>,<br>			<span class="hljs-string">&quot;/favicon.ico&quot;</span>,<br><br>	&#125;;<br><br><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>		http.cors().and().csrf().disable()<br><br>				<span class="hljs-comment">// ç™»å½•é…ç½®</span><br>				.formLogin()<br>				.successHandler(loginSuccessHandler)<br>				.failureHandler(loginFailureHandler)<br><br>				.and()<br>				.logout()<br>				.logoutSuccessHandler(jwtLogoutSuccessHandler)<br><br>				<span class="hljs-comment">// ç¦ç”¨session</span><br>				.and()<br>				.sessionManagement()<br>				.sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br><br>				<span class="hljs-comment">// é…ç½®æ‹¦æˆªè§„åˆ™</span><br>				.and()<br>				.authorizeRequests()<br>				.antMatchers(URL_WHITELIST).permitAll()<br>				.anyRequest().authenticated()<br><br>				<span class="hljs-comment">// å¼‚å¸¸å¤„ç†å™¨</span><br>				.and()<br>				.exceptionHandling()<br>				.authenticationEntryPoint(jwtAuthenticationEntryPoint)<br>				.accessDeniedHandler(jwtAccessDeniedHandler)<br><br>				<span class="hljs-comment">// é…ç½®è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨</span><br>				.and()<br>				.addFilter(jwtAuthenticationFilter())<br>				.addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class)<br><br>		;<br><br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		auth.userDetailsService(userDetailService);<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h3 id="Swagger2é…ç½®"><a href="#Swagger2é…ç½®" class="headerlink" title="Swagger2é…ç½®"></a>Swagger2é…ç½®</h3><blockquote>
<p>swaggeré…ç½®ç±»</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Swagger2é…ç½®ç±»</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> zhoubin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Swagger2Config</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">createRestApi</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                .select()<br>                <span class="hljs-comment">//ä¸ºå½“å‰åŒ…ä¸‹çš„controllerç”Ÿæˆapiæ–‡æ¡£</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.gz.yeb.controller&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build()<br>                <span class="hljs-comment">//æ·»åŠ ç™»å½•è®¤è¯</span><br>                .securitySchemes(securitySchemes())<br>                .securityContexts(securityContexts());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;äº‘EåŠæ¥å£æ–‡æ¡£&quot;</span>)<br>                .description(<span class="hljs-string">&quot;äº‘EåŠæ¥å£æ–‡æ¡£&quot;</span>)<br>                .contact(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(<span class="hljs-string">&quot;gaozhe&quot;</span>, <span class="hljs-string">&quot;http:localhost:8081/doc.html&quot;</span>, <span class="hljs-string">&quot;373795878@qq.com&quot;</span>))<br>                .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;SecurityScheme&gt; <span class="hljs-title function_">securitySchemes</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚å¤´ä¿¡æ¯</span><br>        List&lt;SecurityScheme&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">ApiKey</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiKey</span>(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Header&quot;</span>);<br>        result.add(apiKey);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;SecurityContext&gt; <span class="hljs-title function_">securityContexts</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//è®¾ç½®éœ€è¦ç™»å½•è®¤è¯çš„è·¯å¾„</span><br>        List&lt;SecurityContext&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        result.add(getContextByPath(<span class="hljs-string">&quot;/hello/.*&quot;</span>));<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> SecurityContext <span class="hljs-title function_">getContextByPath</span><span class="hljs-params">(String pathRegex)</span> &#123;<br>        <span class="hljs-keyword">return</span> SecurityContext.builder()<br>                .securityReferences(defaultAuth())<br>                .forPaths(PathSelectors.regex(pathRegex))<br>                .build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;SecurityReference&gt; <span class="hljs-title function_">defaultAuth</span><span class="hljs-params">()</span> &#123;<br>        List&lt;SecurityReference&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">AuthorizationScope</span> <span class="hljs-variable">authorizationScope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>(<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;accessEverything&quot;</span>);<br>        AuthorizationScope[] authorizationScopes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>[<span class="hljs-number">1</span>];<br>        authorizationScopes[<span class="hljs-number">0</span>] = authorizationScope;<br>        result.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityReference</span>(<span class="hljs-string">&quot;Authorization&quot;</span>, authorizationScopes));<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>securityé…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">//æ”¾è¡Œé™æ€èµ„æº</span><br>       web.ignoring().antMatchers(<br>               <span class="hljs-string">&quot;/login&quot;</span>,<br>               <span class="hljs-string">&quot;/logout&quot;</span>,<br>               <span class="hljs-string">&quot;/css/**&quot;</span>,<br>               <span class="hljs-string">&quot;/js/**&quot;</span>,<br>               <span class="hljs-string">&quot;/index.html&quot;</span>,<br>               <span class="hljs-string">&quot;/favicon.ico&quot;</span>,<br>               <span class="hljs-string">&quot;/doc.html&quot;</span>,<br>               <span class="hljs-string">&quot;/webjars/**&quot;</span>,<br>               <span class="hljs-string">&quot;/swagger-resources/**&quot;</span>,<br>               <span class="hljs-string">&quot;/v2/api-docs/**&quot;</span><br>       );<br>   &#125;<br></code></pre></td></tr></table></figure>





<h1 id="ç¬¬ä¸ƒç« -RememberMe"><a href="#ç¬¬ä¸ƒç« -RememberMe" class="headerlink" title="ç¬¬ä¸ƒç«  RememberMe"></a>ç¬¬ä¸ƒç«  RememberMe</h1><ul>
<li>ç®€ä»‹</li>
<li>åŸºæœ¬ä½¿ç”¨</li>
<li>åŸç†åˆ†æ</li>
<li>æŒä¹…åŒ–ä»¤ç‰Œ</li>
</ul>
<h2 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>RememberMe è¿™ä¸ªåŠŸèƒ½éå¸¸å¸¸è§ï¼Œä¸‹å›¾å°±æ˜¯QQ é‚®ç®±ç™»å½•æ—¶çš„â€œè®°ä½æˆ‘â€ é€‰é¡¹ã€‚æåˆ° RememberMeï¼Œä¸€äº›åˆå­¦è€…å¾€å¾€ä¼šæœ‰ä¸€äº›è¯¯è§£ï¼Œè®¤ä¸º RememberMe åŠŸèƒ½å°±æ˜¯æŠŠç”¨æˆ·å&#x2F;å¯†ç ç”¨ Cookie ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡ç™»å½•æ—¶ä¸ç”¨å†æ¬¡è¾“å…¥ç”¨æˆ·å&#x2F;å¯†ç ã€‚è¿™ä¸ªç†è§£æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ RememberMe æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯çš„è¡Œä¸ºã€‚ä¼ ç»Ÿçš„ç™»å½•æ–¹å¼åŸºäº Sessionä¼šè¯ï¼Œä¸€æ—¦ç”¨æˆ·çš„ä¼šè¯è¶…æ—¶è¿‡æœŸï¼Œå°±è¦å†æ¬¡ç™»å½•ï¼Œè¿™æ ·å¤ªè¿‡äºçƒ¦çã€‚å¦‚æœèƒ½æœ‰ä¸€ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·ä¼šè¯è¿‡æœŸä¹‹åï¼Œè¿˜èƒ½ç»§ç»­ä¿æŒè®¤è¯çŠ¶æ€ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼ŒRememberMe å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€éœ€æ±‚è€Œç”Ÿçš„ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308185102746.png" srcset="/img/loading.gif" lazyload alt="image-20220308185102746"></p>
<p>å…·ä½“çš„å®ç°æ€è·¯å°±æ˜¯é€šè¿‡ Cookie æ¥è®°å½•å½“å‰ç”¨æˆ·èº«ä»½ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œä¼šé€šè¿‡ä¸€å®šç®—æ³•ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´æˆ³ç­‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆåï¼Œé€šè¿‡å“åº”å¤´å¸¦å›å‰ç«¯å­˜å‚¨åœ¨cookieä¸­ï¼Œå½“æµè§ˆå™¨ä¼šè¯è¿‡æœŸä¹‹åï¼Œå¦‚æœå†æ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œä¼šè‡ªåŠ¨å°† Cookie ä¸­çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯¹ Cookieä¸­çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒåˆ†æï¼Œè¿›è€Œç¡®å®šå‡ºç”¨æˆ·çš„èº«ä»½ï¼ŒCookieä¸­æ‰€ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œä¾‹å¦‚ä¸‰å¤©ã€ä¸€å‘¨ç­‰ã€‚</p>
<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><h3 id="å¼€å§‹è®°ä½æˆ‘"><a href="#å¼€å§‹è®°ä½æˆ‘" class="headerlink" title="å¼€å§‹è®°ä½æˆ‘"></a>å¼€å§‹è®°ä½æˆ‘</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                <span class="hljs-comment">//...</span><br>                .and()<br>                .rememberMe() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span><br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="ä½¿ç”¨è®°ä½æˆ‘"><a href="#ä½¿ç”¨è®°ä½æˆ‘" class="headerlink" title="ä½¿ç”¨è®°ä½æˆ‘"></a>ä½¿ç”¨è®°ä½æˆ‘</h3><p>å¯ä»¥çœ‹åˆ°ä¸€æ—¦æ‰“å¼€äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œç™»å½•é¡µé¢ä¸­ä¼šå¤šå‡ºä¸€ä¸ª RememberMe é€‰é¡¹ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308190409305.png" srcset="/img/loading.gif" lazyload alt="image-20220308190409305"></p>
<h3 id="æµ‹è¯•è®°ä½æˆ‘"><a href="#æµ‹è¯•è®°ä½æˆ‘" class="headerlink" title="æµ‹è¯•è®°ä½æˆ‘"></a>æµ‹è¯•è®°ä½æˆ‘</h3><p>ç™»å½•æ—¶å‹¾é€‰ RememberMe é€‰é¡¹ï¼Œç„¶åé‡å¯æœåŠ¡ç«¯ä¹‹åï¼Œåœ¨æµ‹è¯•æ¥å£æ˜¯å¦èƒ½å…ç™»å½•è®¿é—®ã€‚</p>
<h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="RememberMeAuthenticationFilter"><a href="#RememberMeAuthenticationFilter" class="headerlink" title="RememberMeAuthenticationFilter"></a>RememberMeAuthenticationFilter</h3><p><img src="/2022/01/26/SpringSecurity/image-20220317194843649.png" srcset="/img/loading.gif" lazyload alt="image-20220317194843649"></p>
<p>ä»ä¸Šå›¾ä¸­ï¼Œå½“åœ¨SecurityConfigé…ç½®ä¸­å¼€å¯äº†â€è®°ä½æˆ‘â€åŠŸèƒ½ä¹‹å,åœ¨è¿›è¡Œè®¤è¯æ—¶å¦‚æœå‹¾é€‰äº†â€è®°ä½æˆ‘â€é€‰é¡¹ï¼Œæ­¤æ—¶æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåˆ†ææ•´ä¸ªç™»å½•è¿‡ç¨‹ã€‚é¦–å…ˆå½“æˆ‘ä»¬ç™»å½•æ—¶ï¼Œåœ¨ç™»å½•è¯·æ±‚ä¸­å¤šäº†ä¸€ä¸ª RememberMe çš„å‚æ•°ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308191736005.png" srcset="/img/loading.gif" lazyload alt="image-20220308191736005"></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨åº”è¯¥å¼€å¯ RememberMeåŠŸèƒ½çš„ã€‚å¦‚æœè‡ªå®šä¹‰ç™»å½•é¡µé¢å¼€å¯ RememberMe åŠŸèƒ½åº”è¯¥å¤šåŠ å…¥ä¸€ä¸ªä¸€æ ·çš„è¯·æ±‚å‚æ•°å°±å¯ä»¥å•¦ã€‚è¯¥è¯·æ±‚ä¼šè¢« <code>RememberMeAuthenticationFilter</code>è¿›è¡Œæ‹¦æˆªç„¶åè‡ªåŠ¨ç™»å½•å…·ä½“å‚è§æºç :</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220317195930708.png" srcset="/img/loading.gif" lazyload alt="image-20220317195930708"></p>
<ul>
<li><p>(1ï¼‰è¯·æ±‚åˆ°è¾¾è¿‡æ»¤å™¨ä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­ SecurityContextHolder ä¸­æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼çš„è¯è¡¨ç¤ºç”¨æˆ·å°šæœªç™»å½•ï¼Œæ­¤æ—¶è°ƒç”¨ autoLogin æ–¹æ³•è¿›è¡Œè‡ªåŠ¨ç™»å½•ã€‚</p>
</li>
<li><p>(2ï¼‰å½“è‡ªåŠ¨ç™»å½•æˆåŠŸåè¿”å›çš„rememberMeAuth ä¸ä¸ºnull æ—¶ï¼Œè¡¨ç¤ºè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ­¤æ—¶è°ƒç”¨ authenticate æ–¹æ³•å¯¹ key è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸”å°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ç™»å½•æˆåŠŸå›è°ƒï¼Œå¹¶å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç™»å½•æˆåŠŸçš„å›è°ƒå¹¶ä¸åŒ…å« RememberMeServices ä¸­çš„ loginSuccess æ–¹æ³•ã€‚</p>
</li>
<li><p>(3ï¼‰å¦‚æœè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œåˆ™è°ƒç”¨ remenberMeServices.loginFailæ–¹æ³•å¤„ç†ç™»å½•å¤±è´¥å›è°ƒã€‚onUnsuccessfulAuthentication å’Œ onSuccessfulAuthentication éƒ½æ˜¯è¯¥è¿‡æ»¤å™¨ä¸­å®šä¹‰çš„ç©ºæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å®ç°è¿™å°±æ˜¯ RememberMeAuthenticationFilter è¿‡æ»¤å™¨æ‰€åšçš„äº‹æƒ…ï¼ŒæˆåŠŸå°† RememberMeServicesçš„æœåŠ¡é›†æˆè¿›æ¥ã€‚</p>
</li>
</ul>
<h3 id="RememberMeServices"><a href="#RememberMeServices" class="headerlink" title="RememberMeServices"></a>RememberMeServices</h3><p>è¿™é‡Œä¸€å…±å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>autoLogin æ–¹æ³•å¯ä»¥ä»è¯·æ±‚ä¸­æå–å‡ºéœ€è¦çš„å‚æ•°ï¼Œå®Œæˆè‡ªåŠ¨ç™»å½•åŠŸèƒ½ã€‚</li>
<li>loginFail æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•å¤±è´¥çš„å›è°ƒã€‚</li>
<li>loginSuccess æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•æˆåŠŸçš„å›è°ƒã€‚</li>
</ol>
<p><img src="/2022/01/26/SpringSecurity/image-20220317200522015.png" srcset="/img/loading.gif" lazyload alt="image-20220317200522015"></p>
<h3 id="TokenBasedRememberMeServices"><a href="#TokenBasedRememberMeServices" class="headerlink" title="TokenBasedRememberMeServices"></a>TokenBasedRememberMeServices</h3><p>åœ¨å¼€å¯è®°ä½æˆ‘åå¦‚æœæ²¡æœ‰åŠ å…¥é¢å¤–é…ç½®é»˜è®¤å®ç°å°±æ˜¯ç”±TokenBasedRememberMeServicesè¿›è¡Œçš„å®ç°ã€‚æŸ¥çœ‹è¿™ä¸ªç±»æºç ä¸­ processAutoLoginCookie æ–¹æ³•å®ç°:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220317201055784.png" srcset="/img/loading.gif" lazyload alt="image-20220317201055784"></p>
<p>processAutoLoginCookie æ–¹æ³•ä¸»è¦ç”¨æ¥éªŒè¯ Cookie ä¸­çš„ä»¤ç‰Œä¿¡æ¯æ˜¯å¦åˆæ³•ï¼š</p>
<ol>
<li><p>é¦–å…ˆåˆ¤æ–­ cookieTokens é•¿åº¦æ˜¯å¦ä¸º3ï¼Œä¸ä¸ºäº†è¯´æ˜æ ¼å¼ä¸å¯¹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li><p>ä»cookieTokens æ•°ç»„ä¸­æå–å‡ºç¬¬ 1é¡¹ï¼Œä¹Ÿå°±æ˜¯è¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå·±ç»è¿‡æœŸï¼Œåˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li><p>æ ¹æ®ç”¨æˆ·å ï¼ˆcookieTokens æ•°ç»„çš„ç¬¬2é¡¹ï¼‰æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·å¯¹è±¡ã€‚</p>
</li>
<li><p>è°ƒç”¨ makeTokenSignature æ–¹æ³•ç”Ÿæˆä¸€ä¸ªç­¾åï¼Œç­¾åçš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆå°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ã€ç”¨æˆ·å¯†ç ä»¥åŠ key ç»„æˆä¸€ä¸ªå®‡ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œï¼šâ€éš”å¼€ï¼Œç„¶åé€šè¿‡ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯¥å®‡ç¬¦ä¸²è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å°†åŠ å¯†ç»“æœè½¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚</p>
</li>
<li><p>åˆ¤æ–­ç¬¬4 æ­¥ç”Ÿæˆçš„ç­¾åå’Œé€šè¿‡ Cookie ä¼ æ¥çš„ç­¾åæ˜¯å¦ç›¸ç­‰ï¼ˆå³ cookieTokens æ•°ç»„<br>çš„ç¬¬2é¡¹ï¼‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºä»¤ç‰Œåˆæ³•ï¼Œåˆ™ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œå¦åˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
</ol>
<p><img src="/2022/01/26/SpringSecurity/image-20220318142054096.png" srcset="/img/loading.gif" lazyload alt="image-20220318142054096"></p>
<ol>
<li><p>åœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œé¦–å…ˆè·å–ç”¨æˆ·ç»å’Œå¯†ç ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·å¯†ç åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåä»successfulAuthenticationå¯¹è±¡ä¸­æ“¦é™¤ï¼Œåˆ™ä»æ•°æ®åº“ä¸­é‡æ–°åŠ è½½å‡ºç”¨æˆ·å¯†ç ã€‚</p>
</li>
<li><p>è®¡ç®—å‡ºä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸæ˜¯ä¸¤å‘¨ã€‚</p>
</li>
<li><p>æ ¹æ®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€ç”¨æˆ·åä»¥åŠç”¨æˆ·å¯†ç ï¼Œè®¡ç®—å‡ºä¸€ä¸ªç­¾åã€‚</p>
</li>
<li><p>è°ƒç”¨ setCookie æ–¹æ³•è®¾ç½® Cookieï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¸€å…±åŒ…å«ä¸‰é¡¹ã€‚ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ä»¥åŠç­¾åï¼Œåœ¨setCookie æ–¹æ³•ä¸­ä¼šå°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œ Base64ç¼–ç åå“åº”ç»™å‰ç«¯ã€‚</p>
</li>
</ol>
<blockquote>
<p>ä»€ä¹ˆæ—¶å€™ç”ŸæˆrememberMe Cookie</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20230121004712057.png" srcset="/img/loading.gif" lazyload alt="image-20230121004712057"></p>
<p>åœ¨ç™»å½•éªŒè¯æ˜¯å¦‚æœé€šè¿‡åˆ™ä¼šè®¾ç½®SecurityContext, å¹¶è®¾ç½®Cookie</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å½“ç”¨æˆ·é€šè¿‡ç”¨æˆ·å&#x2F;å¯†ç çš„å½¢å¼ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç ä»¥åŠä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´è®¡ç®—å‡ºä¸€ä¸ªç­¾åï¼Œè¿™ä¸ªç­¾åä½¿ç”¨ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ç”Ÿæˆï¼Œæ˜¯ä¸å¯é€†çš„ã€‚ç„¶åå†å°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ä»¥åŠç­¾åæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œ:â€ éš”å¼€ï¼Œå¯¹æ‹¼æ¥å¥½çš„å­—ç¬¦ä¸²è¿›è¡ŒBase64 ç¼–ç ï¼Œç„¶åå°†ç¼–ç åçš„ç»“æœè¿”å›åˆ°å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°çš„ä»¤ç‰Œã€‚å½“ä¼šè¯è¿‡æœŸä¹‹åï¼Œè®¿é—®ç³»ç»Ÿèµ„æºæ—¶ä¼šè‡ªåŠ¨æºå¸¦ä¸ŠCookieä¸­çš„ä»¤ç‰Œï¼ŒæœåŠ¡ç«¯æ‹¿åˆ° Cookieä¸­çš„ä»¤ç‰Œåï¼Œå…ˆè¿›è¡Œ Bae64è§£ç ï¼Œè§£ç ååˆ†åˆ«æå–å‡ºä»¤ç‰Œä¸­çš„ä¸‰é¡¹æ•°æ®ï¼šæ¥ç€æ ¹æ®ä»¤ç‰Œä¸­çš„æ•°æ®åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™æ ¹æ®ä»¤ç‰Œä¸­çš„ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼šæ¥ç€å†è®¡ç®—å‡ºä¸€ä¸ªç­¾åå’Œä»¤ç‰Œä¸­çš„ç­¾åè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºä¼šç‰Œæ˜¯åˆæ³•ä»¤ç‰Œï¼Œè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œå¦åˆ™è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308192413735.png" srcset="/img/loading.gif" lazyload alt="image-20220308192413735"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220319124115432.png" srcset="/img/loading.gif" lazyload alt="image-20220319124115432"></p>
<h2 id="å†…å­˜ä»¤ç‰Œ"><a href="#å†…å­˜ä»¤ç‰Œ" class="headerlink" title="å†…å­˜ä»¤ç‰Œ"></a>å†…å­˜ä»¤ç‰Œ</h2><h3 id="PersistentTokenBasedRememberMeServices"><a href="#PersistentTokenBasedRememberMeServices" class="headerlink" title="PersistentTokenBasedRememberMeServices"></a>PersistentTokenBasedRememberMeServices</h3><p><img src="/2022/01/26/SpringSecurity/image-20220319104657210.png" srcset="/img/loading.gif" lazyload alt="image-20220319104657210"></p>
<ol>
<li>ä¸åŒäº TokonBasedRemornberMeServices ä¸­çš„ processAutologinCookie æ–¹æ³•ï¼Œè¿™é‡ŒcookieTokens æ•°ç»„çš„é•¿åº¦ä¸º2ï¼Œç¬¬ä¸€é¡¹æ˜¯seriesï¼Œç¬¬äºŒé¡¹æ˜¯ tokenã€‚</li>
<li>ä»cookieTokensæ•°ç»„ä¸­åˆ†åˆ°æå–å‡º series å’Œ tokenï¼ ç„¶åæ ¹æ® series å»å†…å­˜ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ª PersistentRememberMeTokenå¯¹è±¡ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„å¯¹è±¡ä¸ºnullï¼Œè¡¨ç¤ºå†…å­˜ä¸­å¹¶æ²¡æœ‰serieså¯¹åº”çš„å€¼ï¼Œæœ¬æ¬¡è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„ token å’Œä» cookieTokens ä¸­è§£æå‡ºæ¥çš„tokenä¸ç›¸åŒï¼Œè¯´æ˜è‡ªåŠ¨ç™»å½•ä¼šç‰Œå·²ç»æ³„æ¼ï¼ˆæ¶æ„ç”¨æˆ·åˆ©ç”¨ä»¤ç‰Œç™»å½•åï¼Œå†…å­˜ä¸­çš„tokenå˜äº†)ï¼Œæ­¤æ—¶ç§»é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è‡ªåŠ¨ç™»å½•è®°å½•å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>æ ¹æ®æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ç»“æœåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç”Ÿæˆä¸€ä¸ªæ–°çš„ PersistentRememberMeToken å¯¹è±¡ï¼Œç”¨æˆ·åå’Œseries ä¸å˜ï¼Œtoken é‡æ–°<br>ç”Ÿæˆï¼Œdate ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´ã€‚newToken ç”Ÿæˆåï¼Œæ ¹æ® series å»ä¿®æ”¹å†…å­˜ä¸­çš„ token å’Œ date(å³æ¯æ¬¡è‡ªåŠ¨ç™»å½•åéƒ½ä¼šäº§ç”Ÿæ–°çš„ token å’Œ dateï¼‰</li>
<li>è°ƒç”¨ addCookie æ–¹æ³•æ·»åŠ  Cookieï¼Œ åœ¨addCookie æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢æ‰€è¯´çš„<br>setCookie æ–¹æ³•ï¼Œä½†æ˜¯è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ•°ç»„å‚æ•°ä¸­åªæœ‰ä¸¤é¡¹ï¼šseries å’Œ tokenï¼ˆå³è¿”å›åˆ°å‰ç«¯çš„ä»¤ç‰Œæ˜¯é€šè¿‡å¯¹ series å’Œ token è¿›è¡Œ Base64 ç¼–ç å¾—åˆ°çš„ï¼‰</li>
<li>æœ€åå°†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡å¹¶è¿”å›ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°"><a href="#ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°" class="headerlink" title="ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°"></a>ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123; <br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span><br>                .rememberMeServices(rememberMeServices())<br>                .and()<br>                .csrf().disable();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RememberMeServices <span class="hljs-title function_">rememberMeServices</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersistentTokenBasedRememberMeServices</span>(<br>          	   <span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-comment">//å‚æ•° 1: è‡ªå®šä¹‰ä¸€ä¸ªç”Ÿæˆä»¤ç‰Œ key é»˜è®¤ UUID  </span><br>               userDetailsService(), <span class="hljs-comment">//å‚æ•° 2:è®¤è¯æ•°æ®æº  </span><br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryTokenRepositoryImpl</span>());<span class="hljs-comment">//å‚æ•° 3:ä»¤ç‰Œå­˜å‚¨æ–¹å¼</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="æŒä¹…åŒ–ä»¤ç‰Œ"><a href="#æŒä¹…åŒ–ä»¤ç‰Œ" class="headerlink" title="æŒä¹…åŒ–ä»¤ç‰Œ"></a>æŒä¹…åŒ–ä»¤ç‰Œ</h2><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="é…ç½®æ•°æ®æº"><a href="#é…ç½®æ•°æ®æº" class="headerlink" title="é…ç½®æ•°æ®æº"></a>é…ç½®æ•°æ®æº</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.thymeleaf.cache</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mapper/*.xml</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.entity</span><br></code></pre></td></tr></table></figure>

<h3 id="é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ"><a href="#é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ" class="headerlink" title="é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ"></a>é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DataSource dataSource;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PersistentTokenRepository <span class="hljs-title function_">persistentTokenRepository</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">JdbcTokenRepositoryImpl</span> <span class="hljs-variable">jdbcTokenRepository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTokenRepositoryImpl</span>();<br>        jdbcTokenRepository.setCreateTableOnStartup(<span class="hljs-literal">false</span>);<span class="hljs-comment">//åªéœ€è¦æ²¡æœ‰è¡¨æ—¶è®¾ç½®ä¸º true</span><br>        jdbcTokenRepository.setDataSource(dataSource);<br>        <span class="hljs-keyword">return</span> jdbcTokenRepository;<br>    &#125;<br>  	<span class="hljs-comment">//..</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        http.authorizeRequests()<br>                .mvcMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>								 <span class="hljs-comment">//...</span><br>                .logout()<br>                .and()<br>                .rememberMe() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span><br>                .tokenRepository(persistentTokenRepository())<br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“"><a href="#å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“" class="headerlink" title="å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“"></a>å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“</h3><p><strong><code>æ³¨æ„:å¯åŠ¨é¡¹ç›®ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè¡¨,ç”¨æ¥ä¿å­˜è®°ä½æˆ‘çš„ token ä¿¡æ¯ </code></strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220224142025628.png" srcset="/img/loading.gif" lazyload alt="image-20220224142025628"></p>
<h3 id="å†æ¬¡æµ‹è¯•è®°ä½æˆ‘"><a href="#å†æ¬¡æµ‹è¯•è®°ä½æˆ‘" class="headerlink" title="å†æ¬¡æµ‹è¯•è®°ä½æˆ‘"></a>å†æ¬¡æµ‹è¯•è®°ä½æˆ‘</h3><p>åœ¨æµ‹è¯•å‘ç°å³ä½¿æœåŠ¡å™¨é‡æ–°å¯åŠ¨ï¼Œä¾ç„¶å¯ä»¥è‡ªåŠ¨ç™»å½•ã€‚</p>
<h2 id="è‡ªå®šä¹‰è®°ä½æˆ‘"><a href="#è‡ªå®šä¹‰è®°ä½æˆ‘" class="headerlink" title="è‡ªå®šä¹‰è®°ä½æˆ‘"></a>è‡ªå®šä¹‰è®°ä½æˆ‘</h2><h3 id="æŸ¥çœ‹è®°ä½æˆ‘æºç "><a href="#æŸ¥çœ‹è®°ä½æˆ‘æºç " class="headerlink" title="æŸ¥çœ‹è®°ä½æˆ‘æºç "></a>æŸ¥çœ‹è®°ä½æˆ‘æºç </h3><p>AbstractUserDetailsAuthenticationProviderç±»ä¸­authenticateæ–¹æ³•åœ¨æœ€åè®¤è¯æˆåŠŸä¹‹åå®ç°äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œä½†æ˜¯æŸ¥çœ‹æºç å¾—çŸ¥å¦‚æœå¼€å¯è®°ä½æˆ‘,å¿…é¡»è¿›è¡Œç›¸å…³çš„è®¾ç½® </p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184455083.png" srcset="/img/loading.gif" lazyload alt="image-20200814184455083"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184605516.png" srcset="/img/loading.gif" lazyload alt="image-20200814184605516"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184651238.png" srcset="/img/loading.gif" lazyload alt="image-20200814184651238"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814185157418.png" srcset="/img/loading.gif" lazyload alt="image-20200814185157418"></p>
<h3 id="ä¼ ç»Ÿ-web-å¼€å‘è®°ä½æˆ‘å®ç°"><a href="#ä¼ ç»Ÿ-web-å¼€å‘è®°ä½æˆ‘å®ç°" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°"></a>ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°</h3><p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¿…é¡»åœ¨è®¤è¯è¯·æ±‚ä¸­åŠ å…¥å‚æ•°remember-meå€¼ä¸ºâ€true,on,yes,1â€å…¶ä¸­ä»»æ„ä¸€ä¸ªæ‰å¯ä»¥å®Œæˆè®°ä½æˆ‘åŠŸèƒ½,è¿™ä¸ªæ—¶å€™ä¿®æ”¹è®¤è¯ç•Œé¢:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ç”¨æˆ·ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span><br>    ç”¨æˆ·å:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;uname&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    å¯†ç :<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;passwd&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>  	è®°ä½æˆ‘: <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;remember-me&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;on|yes|true|1&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ç™»å½•&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>é…ç½®ä¸­å¼€å¯è®°ä½æˆ‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>		<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .....<br>                .and()<br>                .rememberMe() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘</span><br>                <span class="hljs-comment">//.alwaysRemember(true) æ€»æ˜¯è®°ä½æˆ‘</span><br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°"></a>å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°</h3><h4 id="è‡ªå®šä¹‰è®¤è¯ç±»-LoginFilter"><a href="#è‡ªå®šä¹‰è®¤è¯ç±»-LoginFilter" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter"></a>è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è®¤è¯ Filter</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        System.out.println(<span class="hljs-string">&quot;========================================&quot;</span>);<br>        <span class="hljs-comment">//1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼è¯·æ±‚</span><br>        <span class="hljs-keyword">if</span> (!request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());<br>        &#125;<br>        <span class="hljs-comment">//2.åˆ¤æ–­æ˜¯å¦æ˜¯ json æ ¼å¼è¯·æ±‚ç±»å‹</span><br>        <span class="hljs-keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123;<br>            <span class="hljs-comment">//3.ä» json æ•°æ®ä¸­è·å–ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ &#123;&quot;uname&quot;:&quot;xxx&quot;,&quot;password&quot;:&quot;xxx&quot;,&quot;remember-me&quot;:true&#125;</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                Map&lt;String, String&gt; userInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> userInfo.get(getUsernameParameter());<br>                <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> userInfo.get(getPasswordParameter());<br>                <span class="hljs-type">String</span> <span class="hljs-variable">rememberValue</span> <span class="hljs-operator">=</span> userInfo.get(AbstractRememberMeServices.DEFAULT_PARAMETER);<br>                <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(rememberValue)) &#123;<br>                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);<br>                &#125;<br>                System.out.println(<span class="hljs-string">&quot;ç”¨æˆ·å: &quot;</span> + username + <span class="hljs-string">&quot; å¯†ç : &quot;</span> + password + <span class="hljs-string">&quot; æ˜¯å¦è®°ä½æˆ‘: &quot;</span> + rememberValue);<br>                <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br>                setDetails(request, authRequest);<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.attemptAuthentication(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="è‡ªå®šä¹‰-RememberMeService"><a href="#è‡ªå®šä¹‰-RememberMeService" class="headerlink" title="è‡ªå®šä¹‰ RememberMeService"></a>è‡ªå®šä¹‰ RememberMeService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰è®°ä½æˆ‘ services å®ç°ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPersistentTokenBasedRememberMeServices</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PersistentTokenBasedRememberMeServices</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyPersistentTokenBasedRememberMeServices</span><span class="hljs-params">(String key, UserDetailsService userDetailsService, PersistentTokenRepository tokenRepository)</span> &#123;<br>        <span class="hljs-built_in">super</span>(key, userDetailsService, tokenRepository);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è·å– remember-me æ–¹å¼</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">rememberMeRequested</span><span class="hljs-params">(HttpServletRequest request, String parameter)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">paramValue</span> <span class="hljs-operator">=</span> request.getAttribute(parameter).toString();<br>        <span class="hljs-keyword">if</span> (paramValue != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (paramValue.equalsIgnoreCase(<span class="hljs-string">&quot;true&quot;</span>) || paramValue.equalsIgnoreCase(<span class="hljs-string">&quot;on&quot;</span>)<br>                    || paramValue.equalsIgnoreCase(<span class="hljs-string">&quot;yes&quot;</span>) || paramValue.equals(<span class="hljs-string">&quot;1&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="é…ç½®è®°ä½æˆ‘"><a href="#é…ç½®è®°ä½æˆ‘" class="headerlink" title="é…ç½®è®°ä½æˆ‘"></a>é…ç½®è®°ä½æˆ‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//.....</span><br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br><br>    <span class="hljs-comment">//è‡ªå®šä¹‰ filter äº¤ç»™å·¥å‚ç®¡ç†</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LoginFilter <span class="hljs-title function_">loginFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">LoginFilter</span> <span class="hljs-variable">loginFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginFilter</span>();<br>        loginFilter.setFilterProcessesUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>);<span class="hljs-comment">//æŒ‡å®šè®¤è¯ url</span><br>        loginFilter.setUsernameParameter(<span class="hljs-string">&quot;uname&quot;</span>);<span class="hljs-comment">//æŒ‡å®šæ¥æ”¶json ç”¨æˆ·å key</span><br>        loginFilter.setPasswordParameter(<span class="hljs-string">&quot;passwd&quot;</span>);<span class="hljs-comment">//æŒ‡å®šæ¥æ”¶ json å¯†ç  key</span><br>        loginFilter.setAuthenticationManager(authenticationManagerBean());<br>        loginFilter.setRememberMeServices(rememberMeServices()); <span class="hljs-comment">//è®¾ç½®è®¤è¯æˆåŠŸæ—¶ä½¿ç”¨è‡ªå®šä¹‰rememberMeService</span><br>        <span class="hljs-comment">//è®¤è¯æˆåŠŸå¤„ç†</span><br>        loginFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;<br>            Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>            result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, authentication.getPrincipal());<br>            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>            resp.setStatus(HttpStatus.OK.value());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>            resp.getWriter().println(s);<br>        &#125;);<br>        <span class="hljs-comment">//è®¤è¯å¤±è´¥å¤„ç†</span><br>        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;<br>            Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>            result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç™»å½•å¤±è´¥: &quot;</span> + ex.getMessage());<br>            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());<br>            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>            resp.getWriter().println(s);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> loginFilter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                .anyRequest().authenticated()<span class="hljs-comment">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯</span><br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½  cookie è¿›è¡Œå®ç°  1.è®¤è¯æˆåŠŸä¿å­˜è®°ä½æˆ‘ cookie åˆ°å®¢æˆ·ç«¯   2.åªæœ‰ cookie å†™å…¥å®¢æˆ·ç«¯æˆåŠŸæ‰èƒ½å®ç°è‡ªåŠ¨ç™»å½•åŠŸèƒ½</span><br>                .rememberMeServices(rememberMeServices())  <span class="hljs-comment">//è®¾ç½®è‡ªåŠ¨ç™»å½•ä½¿ç”¨å“ªä¸ª rememberMeServices</span><br>                .and()<br>                .exceptionHandling()<br>                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;<br>                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);<br>                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());<br>                    resp.getWriter().println(<span class="hljs-string">&quot;è¯·è®¤è¯ä¹‹åå†å»å¤„ç†!&quot;</span>);<br>                &#125;)<br>                .and()<br>                .logout()<br>                .logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout&quot;</span>, HttpMethod.DELETE.name()),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout&quot;</span>, HttpMethod.GET.name())<br>                ))<br>                .logoutSuccessHandler((req, resp, auth) -&gt; &#123;<br>                    Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>                    result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);<br>                    result.put(<span class="hljs-string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, auth.getPrincipal());<br>                    resp.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                    resp.setStatus(HttpStatus.OK.value());<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>                    resp.getWriter().println(s);<br>                &#125;)<br>                .and()<br>                .csrf().disable();<br><br><br>        <span class="hljs-comment">// at: ç”¨æ¥æŸä¸ª filter æ›¿æ¢è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter</span><br>        <span class="hljs-comment">// before: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter ä¹‹å‰</span><br>        <span class="hljs-comment">// after: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­é‚£ä¸ª filter ä¹‹å</span><br>        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);<br>    &#125;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RememberMeServices <span class="hljs-title function_">rememberMeServices</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPersistentTokenBasedRememberMeServices</span>(UUID.randomUUID().toString(), userDetailsService(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryTokenRepositoryImpl</span>());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h1 id="ç¬¬å…«ç« -ä¼šè¯ç®¡ç†"><a href="#ç¬¬å…«ç« -ä¼šè¯ç®¡ç†" class="headerlink" title="ç¬¬å…«ç«  ä¼šè¯ç®¡ç†"></a>ç¬¬å…«ç«  ä¼šè¯ç®¡ç†</h1><ul>
<li>ç®€ä»‹</li>
<li>ä¼šè¯å¹¶å‘ç®¡ç†</li>
<li>ä¼šè¯å…±äº«å®æˆ˜</li>
</ul>
<h2 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å½“æµè§ˆå™¨è°ƒç”¨ç™»å½•æ¥å£ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šå’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªä¼šè¯ (Session) æµè§ˆå™¨åœ¨æ¯æ¬¡å‘é€è¯·æ±‚æ—¶éƒ½ä¼šæºå¸¦ä¸€ä¸ª Sessionldï¼ŒæœåŠ¡ç«¯åˆ™æ ¹æ®è¿™ä¸ª Sessionld æ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½ã€‚å½“æµè§ˆå™¨å…³é—­åï¼ŒæœåŠ¡ç«¯çš„ Session å¹¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ¨æœåŠ¡ç«¯è°ƒç”¨ Sessioné”€æ¯æ–¹æ³•ï¼Œæˆ–è€…ç­‰ Session è¿‡æœŸæ—¶é—´åˆ°äº†è‡ªåŠ¨é”€æ¯ã€‚åœ¨Spring Security ä¸­ï¼Œä¸HttpSessionç›¸å…³çš„åŠŸèƒ½ç”± <strong>SessionManagementFilter</strong> å’Œ<strong>SessionAuthenticationStrateey</strong> æ¥å£æ¥å¤„ç†ï¼Œ<strong>SessionManagomentFilter</strong> è¿‡æ»¤å™¨å°† Session ç›¸å…³æ“ä½œå§”æ‰˜ç»™ <strong>SessionAuthenticationStrateey</strong> æ¥å£å»å®Œæˆã€‚</p>
<h2 id="ä¼šè¯å¹¶å‘ç®¡ç†"><a href="#ä¼šè¯å¹¶å‘ç®¡ç†" class="headerlink" title="ä¼šè¯å¹¶å‘ç®¡ç†"></a>ä¼šè¯å¹¶å‘ç®¡ç†</h2><h3 id="ç®€ä»‹-3"><a href="#ç®€ä»‹-3" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>ä¼šè¯å¹¶å‘ç®¡ç†å°±æ˜¯æŒ‡åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åˆ›å»ºå¤šå°‘ä¸ªä¼šè¯ï¼Œå¦‚æœä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ªä¼šè¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šè¿›è¡Œç™»å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šç™»å½•å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä¸è¿‡å¼€å‘è€…å¯ä»¥åœ¨ Spring Security ä¸­å¯¹æ­¤è¿›è¡Œé…ç½®</p>
<h3 id="å¼€å¯ä¼šè¯ç®¡ç†"><a href="#å¼€å¯ä¼šè¯ç®¡ç†" class="headerlink" title="å¼€å¯ä¼šè¯ç®¡ç†"></a>å¼€å¯ä¼šè¯ç®¡ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>  	<span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span><br>                .maximumSessions(<span class="hljs-number">1</span>);  <span class="hljs-comment">//è®¾ç½®ä¼šè¯å¹¶å‘æ•°ä¸º 1</span><br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> HttpSessionEventPublisher <span class="hljs-title function_">httpSessionEventPublisher</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSessionEventPublisher</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><strong>sessionManagement</strong>() ç”¨æ¥å¼€å¯ä¼šè¯ç®¡ç†ã€<strong>maximumSessions</strong> æŒ‡å®šä¼šè¯çš„å¹¶å‘æ•°ä¸º 1ã€‚</li>
<li>HttpSessionEventPublisher æä¾›ä¸€ä¸€ä¸ªHtp SessionEvenePubishor-å®ä¾‹ã€‚Spring Securityä¸­é€šè¿‡ä¸€ä¸ª Map é›†åˆæ¥é›†æŠ¤å½“å‰çš„ Http Session è®°å½•ï¼Œè¿›è€Œå®ç°ä¼šè¯çš„å¹¶å‘ç®¡ç†ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œå°±å‘é›†åˆä¸­æ·»åŠ ä¸€æ¡Http Session è®°å½•ï¼›å½“ä¼šè¯é”€æ¯æ—¶ï¼Œå°±ä»é›†åˆä¸­ç§»é™¤ä¸€æ¡ Httpsession è®°å½•ã€‚HtpSesionEvenPublisher å®ç°äº† Fttp SessionListener æ¥å£ï¼Œå¯ä»¥ç›‘å¬åˆ° HtpSession çš„åˆ›å»ºå’Œé”€æ¯€äº‹ä»¶ï¼Œå¹¶å°† Fltp Session çš„åˆ›å»º&#x2F;é”€æ¯äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œè¿™æ ·ï¼Œå½“æœ‰ HttpSession é”€æ¯€æ—¶ï¼ŒSpring Security å°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥äº‹ä»¶äº†ã€‚</li>
</ol>
<h3 id="æµ‹è¯•ä¼šè¯ç®¡ç†"><a href="#æµ‹è¯•ä¼šè¯ç®¡ç†" class="headerlink" title="æµ‹è¯•ä¼šè¯ç®¡ç†"></a>æµ‹è¯•ä¼šè¯ç®¡ç†</h3><p>é…ç½®å®Œæˆåï¼Œå¯åŠ¨é¡¹ç›®ã€‚è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæµè§ˆå™¨ï¼Œå¦‚æœä½¿ç”¨äº† Chrome æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ Chrome æµè§ˆå™¨ä¸­çš„å¤šç”¨æˆ·æ–¹å¼ï¼ˆç›¸å½“äºä¸¤ä¸ªæµè§ˆå™¨ï¼‰å…ˆåœ¨ç¬¬ä¸€ä¸ªæµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://localhost:8080ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥">http://localhost:8080ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥</a> <a href="http://localhost:8080ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ">http://localhost:8080ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ</a><br>å®Œæˆç™»å½•æ“ä½œï¼›å½“ç¬¬äºŒä¸ªæµè§ˆå™¨ç™»å½•æˆåŠŸåï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ã€‚ç»“æœå‡ºç°ä¸‹å›¾ï¼š<img src="/2022/01/26/SpringSecurity/image-20220308195448860.png" srcset="/img/loading.gif" lazyload alt="image-20220308195448860"></p>
<h2 id="ä¼šè¯å¤±æ•ˆå¤„ç†"><a href="#ä¼šè¯å¤±æ•ˆå¤„ç†" class="headerlink" title="ä¼šè¯å¤±æ•ˆå¤„ç†"></a>ä¼šè¯å¤±æ•ˆå¤„ç†</h2><h3 id="ä¼ ç»Ÿ-web-å¼€å‘å¤„ç†"><a href="#ä¼ ç»Ÿ-web-å¼€å‘å¤„ç†" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘å¤„ç†"></a>ä¼ ç»Ÿ web å¼€å‘å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  http.authorizeRequests()<br>    .anyRequest().authenticated()<br>    .and()<br>    ....<br>    .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span><br>    .maximumSessions(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span><br>    .expiredUrl(<span class="hljs-string">&quot;/login&quot;</span>);<span class="hljs-comment">//ä¼šè¯è¿‡æœŸå¤„ç†</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†"></a>å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  http.authorizeRequests()<br>    .anyRequest().authenticated()<br>    .....<br>    .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span><br>    .maximumSessions(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span><br>    <span class="hljs-comment">//.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span><br>    .expiredSessionStrategy(event -&gt; &#123;<br>      <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> event.getResponse();<br>      response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>      Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">500</span>);<br>      result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>      response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>      response.getWriter().println(s);<br>      response.flushBuffer();<br>    &#125;);<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ç¦æ­¢å†æ¬¡ç™»å½•"><a href="#ç¦æ­¢å†æ¬¡ç™»å½•" class="headerlink" title="ç¦æ­¢å†æ¬¡ç™»å½•"></a>ç¦æ­¢å†æ¬¡ç™»å½•</h2><p>é»˜è®¤çš„æ•ˆæœæ˜¯ä¸€ç§è¢« â€œæŒ¤ä¸‹çº¿â€çš„æ•ˆæœï¼Œåé¢ç™»å½•çš„ç”¨æˆ·ä¼šæŠŠå‰é¢ç™»å½•çš„ç”¨æˆ· â€œæŒ¤ä¸‹çº¿â€ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç¦æ­¢åæ¥è€…ç™»å½•ï¼Œå³ä¸€æ—¦å½“å‰ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåæ¥è€…æ— æ³•å†æ¬¡ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ç™»å½•ï¼Œç›´åˆ°å½“å‰ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ç™»å½•ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  http.authorizeRequests()<br>    .anyRequest().authenticated()<br>    .and()<br>    ....<br>    .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span><br>    .maximumSessions(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span><br>    <span class="hljs-comment">//.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span><br>    .expiredSessionStrategy(event -&gt; &#123;<br>      <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> event.getResponse();<br>      response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>      Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">500</span>);<br>      result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>      response.getWriter().println(s);<br>      response.flushBuffer();<br>    &#125;)<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span><br>    .maxSessionsPreventsLogin(<span class="hljs-literal">true</span>);<span class="hljs-comment">//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ä¼šè¯å…±äº«"><a href="#ä¼šè¯å…±äº«" class="headerlink" title="ä¼šè¯å…±äº«"></a>ä¼šè¯å…±äº«</h2><p>å‰é¢æ‰€è®²çš„ä¼šè¯ç®¡ç†éƒ½æ˜¯å•æœºä¸Šçš„ä¼šè¯ç®¡ç†ï¼Œå¦‚æœå½“å‰æ˜¯é›†ç¾¤ç¯å¢ƒï¼Œå‰é¢æ‰€è®²çš„ä¼šè¯ç®¡<br>ç†æ–¹æ¡ˆå°±ä¼šå¤±æ•ˆã€‚æ­¤æ—¶å¯ä»¥åˆ©ç”¨ spring-session ç»“åˆ redis å®ç° session å…±äº«ã€‚</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><h6 id="å¼•å…¥ä¾èµ–-1"><a href="#å¼•å…¥ä¾èµ–-1" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h6 id="ç¼–å†™é…ç½®"><a href="#ç¼–å†™é…ç½®" class="headerlink" title="ç¼–å†™é…ç½®"></a>ç¼–å†™é…ç½®</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.redis.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-attr">spring.redis.port</span>=<span class="hljs-string">6379</span><br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®Security"><a href="#é…ç½®Security" class="headerlink" title="é…ç½®Security"></a>é…ç½®Security</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.blr.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;<br><span class="hljs-keyword">import</span> org.springframework.session.FindByIndexNameSessionRepository;<br><span class="hljs-keyword">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FindByIndexNameSessionRepository sessionRepository;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(FindByIndexNameSessionRepository sessionRepository)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sessionRepository = sessionRepository;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        ....<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span><br>                .maximumSessions(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯*/</span><br>                .expiredUrl(<span class="hljs-string">&quot;/login&quot;</span>)<span class="hljs-comment">//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span><br>                .expiredSessionStrategy(event -&gt; &#123;<br>                    <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> event.getResponse();<br>                    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                    Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                    result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">500</span>);<br>                    result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>                    response.getWriter().println(s);<br>                    response.flushBuffer();<br>                &#125;).sessionRegistry(sessionRegistry());<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span><br>        <span class="hljs-comment">//.maxSessionsPreventsLogin(true);//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•*/</span><br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> SpringSessionBackedSessionRegistry <span class="hljs-title function_">sessionRegistry</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringSessionBackedSessionRegistry</span>(sessionRepository);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="åŸç†åˆ†æ-1"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>â€‹	æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸Šé¢çš„æ•ˆæœæ˜¯æ€ä¹ˆå®ç°çš„. è¿™é‡Œæ¶‰åŠäº†æ¯”è¾ƒå¤šçš„ç±», æˆ‘ä»¬é€ä¸ªæ¥çœ‹ä¸€ä¸‹:</p>
<h3 id="SessionInformation"><a href="#SessionInformation" class="headerlink" title="SessionInformation"></a>SessionInformation</h3><p>â€‹	<strong>SessionInformation</strong>ä¸»è¦ç”¨ä½œSpringSecurityæ¡†æ¶å†…çš„ä¼šè¯è®°å½•, ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionInformation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>	<span class="hljs-keyword">private</span> Date lastRequest;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sessionId;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">expired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå®šä¹‰äº†å››ä¸ªå±æ€§:</p>
<ol>
<li>lastRequest: æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´</li>
<li>principal: ä¼šè¯å¯¹åº”çš„ä¸»ä½“(å¯¹è±¡)</li>
<li>sessionId: ä¼šè¯Id</li>
<li>expired: ä¼šè¯æ˜¯å¦è¿‡æœŸ</li>
<li>refreshLastRequest(): è¯¥æ–¹æ³•ç”¨æ¥æ›´æ–°æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´</li>
</ol>
<h3 id="SessionRegistry"><a href="#SessionRegistry" class="headerlink" title="SessionRegistry"></a>SessionRegistry</h3><p>â€‹	<strong>SessionRegistry</strong>æ˜¯ä¸€ä¸ªæ¥å£, ä¸»è¦ç”¨æ¥ç»´æŠ¤<strong>SessionInformation</strong>å®ä¾‹, è¯¥æ¥å£åªæœ‰ä¸€ä¸ªå®ç°ç±»<strong>SessionRegistryImpl</strong>, æ‰€æœ‰è¿™é‡Œæˆ‘ä»¬å°±ä¸çœ‹æ¥å£äº†, ç›´æ¥æ¥çœ‹å®ç°ç±»<strong>SessionRegistryImpl</strong>, <strong>SessionRegistryImpl</strong>ç±»çš„å®šä¹‰æ¯”è¾ƒé•¿, æˆ‘ä»¬æ¥æ‹†å¼€çœ‹ä¸‹, å…ˆçœ‹ä¸‹å±æ€§çš„å®šä¹‰:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionRegistryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SessionRegistry</span>, ApplicationListener&lt;AbstractSessionEvent&gt; &#123;<br>	<span class="hljs-comment">// &lt;principal:Object,SessionIdSet&gt;</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals;<br><br>	<span class="hljs-comment">// &lt;sessionId:Object,SessionInformation&gt;</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, SessionInformation&gt; sessionIds;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SessionRegistryImpl</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-built_in">this</span>.principals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>		<span class="hljs-built_in">this</span>.sessionIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>	&#125;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SessionRegistryImpl</span><span class="hljs-params">(ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals,</span><br><span class="hljs-params">			Map&lt;String, SessionInformation&gt; sessionIds)</span> &#123;<br>		<span class="hljs-built_in">this</span>.principals = principals;<br>		<span class="hljs-built_in">this</span>.sessionIds = sessionIds;<br>	&#125;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(AbstractSessionEvent event)</span> &#123;<br>		<span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> SessionDestroyedEvent) &#123;<br>			<span class="hljs-type">SessionDestroyedEvent</span> <span class="hljs-variable">sessionDestroyedEvent</span> <span class="hljs-operator">=</span> (SessionDestroyedEvent) event;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> sessionDestroyedEvent.getId();<br>			removeSessionInformation(sessionId);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> SessionIdChangedEvent) &#123;<br>			<span class="hljs-type">SessionIdChangedEvent</span> <span class="hljs-variable">sessionIdChangedEvent</span> <span class="hljs-operator">=</span> (SessionIdChangedEvent) event;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">oldSessionId</span> <span class="hljs-operator">=</span> sessionIdChangedEvent.getOldSessionId();<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sessionIds.containsKey(oldSessionId)) &#123;<br>				<span class="hljs-type">Object</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sessionIds.get(oldSessionId).getPrincipal();<br>				removeSessionInformation(oldSessionId);<br>				registerNewSession(sessionIdChangedEvent.getNewSessionId(), principal);<br>			&#125;<br>		&#125;<br>	&#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<strong>SessionRegistryImpl</strong>å®ç°äº†<strong>SessionRegistry</strong>å’Œ<strong>ApplicationListener</strong>ä¸¤ä¸ªæ¥å£, å®ç°äº†<strong>ApplicationListener</strong>æ¥å£, å¹¶é€šè¿‡é‡å†™å…¶<strong>onApplicationEvent</strong>æ–¹æ³•, å°±å¯ä»¥æ¥æ”¶åˆ°<strong>HttpSession</strong>çš„é”€æ¯äº‹ä»¶, è¿›è€Œç§»é™¤æ‰<strong>HttpSession</strong>çš„è®°å½•.</p>
<p>â€‹	<strong>SessionRegistryImpl</strong>ä¸­ä¸€å…±å®šä¹‰äº†ä¸¤ä¸ªå±æ€§:</p>
<p>â€‹	1. <strong>principals</strong>: è¯¥å˜é‡ç”¨æ¥ä¿æŒå½“å‰ç™»å½•ä¸»ä½“(ç”¨æˆ·)å’Œ<strong>SessionId</strong>ä¹‹é—´çš„å…³ç³», <strong>key</strong>å°±æ˜¯å½“å‰ç™»å½•ä¸»ä½“, <strong>value</strong>åˆ™æ˜¯å½“å‰ç™»å½•ä¸»ä½“æ‰€å¯¹åº”çš„ä¼šè¯idçš„é›†åˆ.</p>
<p>â€‹	2. <strong>sessionIds</strong>: è¯¥å˜é‡æ˜¯ç”¨æ¥ä¿å­˜<strong>sessionId</strong>å’Œ<strong>SessionInformation</strong>ä¹‹é—´çš„æ˜ å°„å…³ç³», <strong>key</strong>æ˜¯<strong>sessionId</strong>, <strong>value</strong>åˆ™æ˜¯<strong>SessionInformation</strong>.</p>
<p>â€‹	<span style="color:red;">ç”±äº<strong>principals</strong>é›†åˆä¸­é‡‡ç”¨å½“å‰ç™»å½•ç”¨æˆ·å¯¹è±¡åškey, å°†å¯¹è±¡ä½œä¸ºé›†åˆä¸­çš„key, éœ€è¦é‡å†™å…¶<strong>equals</strong>æ–¹æ³•å’Œ<strong>hashCode</strong>æ–¹æ³•. å¦åˆ™ä¼šè¯å¹¶å‘ç®¡ç†ä¼šå¤±æ•ˆ.</span></p>
<p>â€‹	ç»§ç»­æ¥çœ‹<strong>SessionRegistryImpl</strong>ä¸­çš„å…¶ä»–æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getAllPrincipals</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.principals.keySet());<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;SessionInformation&gt; <span class="hljs-title function_">getAllSessions</span><span class="hljs-params">(Object principal, <span class="hljs-type">boolean</span> includeExpiredSessions)</span> &#123;<br>	Set&lt;String&gt; sessionsUsedByPrincipal = <span class="hljs-built_in">this</span>.principals.get(principal);<br>	<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal == <span class="hljs-literal">null</span>) &#123;<br>		<span class="hljs-keyword">return</span> Collections.emptyList();<br>	&#125;<br>	List&lt;SessionInformation&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(sessionsUsedByPrincipal.size());<br>	<span class="hljs-keyword">for</span> (String sessionId : sessionsUsedByPrincipal) &#123;<br>		<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">sessionInformation</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>		<span class="hljs-keyword">if</span> (sessionInformation == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (includeExpiredSessions || !sessionInformation.isExpired()) &#123;<br>			list.add(sessionInformation);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> list;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SessionInformation <span class="hljs-title function_">getSessionInformation</span><span class="hljs-params">(String sessionId)</span> &#123;<br>	Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sessionIds.get(sessionId);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshLastRequest</span><span class="hljs-params">(String sessionId)</span> &#123;<br>	Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>	<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>	<span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span>) &#123;<br>		info.refreshLastRequest();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><strong>getAllPrincipals</strong>: è¯¥æ–¹æ³•è¿”å›æ‰€æœ‰çš„ç™»å½•ç”¨æˆ·å¯¹è±¡.</li>
<li><strong>getAllSessions</strong>: è¯¥æ–¹æ³•è¿”å›æŸä¸€ä¸ªç”¨æˆ·æ‰€å¯¹åº”çš„æ‰€æœ‰<strong>SessionInfomation</strong>. æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç”¨æˆ·å¯¹è±¡, ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åŒ…å«å·²ç»è¿‡æœŸçš„Session. å…·ä½“çš„æ“ä½œå°±æ˜¯ä»<strong>principals</strong>å˜é‡ä¸­è·å–è¯¥ç”¨æˆ·å¯¹åº”çš„æ‰€æœ‰<strong>sessionId</strong>, ç„¶åè°ƒç”¨<strong>getSessionInfomation</strong>æ–¹æ³•ä»<strong>sessionIds</strong>å˜é‡ä¸­è·å–æ¯ä¸€ä¸ª<strong>sessionId</strong>å¯¹åº”çš„<strong>SessionInformation</strong>, æœ€ç»ˆå°†è·å–åˆ°çš„<strong>SessionInformation</strong>å­˜å…¥é›†åˆä¸­è¿”å›.</li>
<li><strong>getSessionInformation</strong>: è¯¥æ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®<strong>sessionId</strong>ä»<strong>sessionIds</strong>é›†åˆä¸­è·å–åˆ°å¯¹åº”çš„<strong>SessionInformation</strong></li>
<li><strong>refreshLastRequest</strong>: æ ¹æ®ä¼ å…¥çš„<strong>sessionId</strong>æ‰¾åˆ°å¯¹åº”çš„<strong>SessionInformation</strong>, å¹¶è°ƒç”¨å…¶<strong>refreshLastRequest</strong>æ–¹æ³•å¹¶åˆ·æ–°æœ€åä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´</li>
</ol>
<p>â€‹	å†æ¥çœ‹ä¸‹ä¼šè¯çš„ä¿å­˜æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNewSession</span><span class="hljs-params">(String sessionId, Object principal)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		Assert.notNull(principal, <span class="hljs-string">&quot;Principal required as per interface contract&quot;</span>);<br>		<span class="hljs-keyword">if</span> (getSessionInformation(sessionId) != <span class="hljs-literal">null</span>) &#123;<br>			removeSessionInformation(sessionId);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Registering session %s, for principal %s&quot;</span>, sessionId, principal));<br>		&#125;<br>		<span class="hljs-built_in">this</span>.sessionIds.put(sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionInformation</span>(principal, sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));<br>		<span class="hljs-built_in">this</span>.principals.compute(principal, (key, sessionsUsedByPrincipal) -&gt; &#123;<br>			<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal == <span class="hljs-literal">null</span>) &#123;<br>				sessionsUsedByPrincipal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArraySet</span>&lt;&gt;();<br>			&#125;<br>			sessionsUsedByPrincipal.add(sessionId);<br>			<span class="hljs-built_in">this</span>.logger.trace(LogMessage.format(<span class="hljs-string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, principal, sessionsUsedByPrincipal));<br>			<span class="hljs-keyword">return</span> sessionsUsedByPrincipal;<br>		&#125;);<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å½“ç”¨æˆ·ç™»å½•æˆåŠŸå, ä¼šæ‰§è¡Œä¼šè¯ä¿å­˜æ“ä½œ, ä¼ å…¥å½“å‰è¯·æ±‚çš„<strong>sessionId</strong>å’Œå½“å‰ç™»å½•ä¸»ä½“<strong>principal</strong>å¯¹è±¡. å¦‚æœ<strong>sessionId</strong>å·²ç»å­˜åœ¨, åˆ™å…ˆå°†å…¶ç§»é™¤, ç„¶åå…ˆå¾€<strong>sessionIds</strong>ä¸­ä¿å­˜, <strong>key</strong>æ˜¯<strong>sessionId</strong>, <strong>value</strong>åˆ™æ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„<strong>SessionInformation</strong>å¯¹è±¡.</p>
<p>â€‹	åœ¨å‘<strong>principals</strong>é›†åˆä¸­ä¿å­˜æ—¶ä½¿ç”¨äº†<strong>compute</strong>æ–¹æ³•, ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å½“å‰ç™»å½•ä¸»ä½“, ç¬¬äºŒä¸ªå‚æ•°åˆ™è¿›è¡Œäº†è®¡ç®—. å¦‚æœå½“å‰ç™»å½•ä¸»ä½“åœ¨<strong>principals</strong>ä¸­å·²ç»æœ‰å¯¹åº”çš„value, åˆ™åœ¨valueçš„åŸºç¡€ä¸Šç»§ç»­æ·»åŠ ä¸€ä¸ª<strong>sessionId</strong>. å¦‚æœå½“å‰ç™»å½•ä¸»ä½“åœ¨<strong>principals</strong>ä¸­æ²¡æœ‰å¯¹åº”çš„<strong>value</strong>, åˆ™æ–°å»ºä¸€ä¸ª<strong>sessionUsedByPrincipal</strong>å¯¹è±¡, ç„¶åå†å°†<strong>sessiomId</strong>æ·»åŠ è¿›å».</p>
<p>â€‹	æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¼šè¯ç§»é™¤æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSessionInformation</span><span class="hljs-params">(String sessionId)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>		<span class="hljs-keyword">if</span> (info == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Removing session &quot;</span> + sessionId + <span class="hljs-string">&quot; from set of registered sessions&quot;</span>);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.sessionIds.remove(sessionId);<br>		<span class="hljs-built_in">this</span>.principals.computeIfPresent(info.getPrincipal(), (key, sessionsUsedByPrincipal) -&gt; &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<br>					LogMessage.format(<span class="hljs-string">&quot;Removing session %s from principal&#x27;s set of registered sessions&quot;</span>, sessionId));<br>			sessionsUsedByPrincipal.remove(sessionId);<br>			<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal.isEmpty()) &#123;<br>				<span class="hljs-comment">// No need to keep object in principals Map anymore</span><br>				<span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Removing principal %s from registry&quot;</span>, info.getPrincipal()));<br>				sessionsUsedByPrincipal = <span class="hljs-literal">null</span>;<br>			&#125;<br>			<span class="hljs-built_in">this</span>.logger.trace(<br>					LogMessage.format(<span class="hljs-string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, info.getPrincipal(), sessionsUsedByPrincipal));<br>			<span class="hljs-keyword">return</span> sessionsUsedByPrincipal;<br>		&#125;);<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ç§»é™¤ä¹Ÿæ˜¯ä¸¤æ–¹é¢çš„å·¥ä½œ, ä¸€æ–¹é¢å°±æ˜¯ä»sessionIdså˜é‡ä¸­ç§»é™¤, è¿™ä¸ªç›´æ¥è°ƒç”¨removeæ–¹æ³•å³å¯;å¦ä¸€æ–¹é¢å°±æ˜¯ä»principalså˜é‡ä¸­ç§»é™¤, principalsä¸­keyæ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ·å¯¹è±¡, valueæ˜¯ä¸€ä¸ªé›†åˆ, é‡Œé¢ä¿å­˜ç€å½“å‰ç”¨æˆ·å¯¹åº”çš„æ‰€æœ‰sessionId, è¿™é‡Œä¸»è¦æ˜¯ç§»é™¤vakueä¸­å¯¹åº”çš„sessionId</p>
<h3 id="SessionAuthenticationStrategy"><a href="#SessionAuthenticationStrategy" class="headerlink" title="SessionAuthenticationStrategy"></a>SessionAuthenticationStrategy</h3><p>â€‹	<strong>SessionAuthenticationStrategy</strong>æ˜¯ä¸€ä¸ªæ¥å£, ä¸»è¦åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸå, å¯¹<strong>HttpSession</strong>è¿›è¡Œå¤„ç†. å®ƒé‡Œé¢åªæœ‰ä¸€ä¸ª<strong>onAuthentication</strong>æ–¹æ³•, ç”¨æ¥å¤„ç†å’Œ<strong>HttpSession</strong>ç›¸å…³çš„äº‹æƒ…:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SessionAuthenticationStrategy</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Performs Http session-related functionality when a new authentication occurs.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> SessionAuthenticationException if it is decided that the authentication is</span><br><span class="hljs-comment">	 * not allowed for the session. This will typically be because the user has too many</span><br><span class="hljs-comment">	 * sessions open at once.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span><br>			<span class="hljs-keyword">throws</span> SessionAuthenticationException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	<strong>SessionAuthenticationStrategy</strong>æœ‰å¦‚ä¸‹ä¸€äº›å®ç°ç±»:</p>
<ul>
<li><strong>CsrfAuthenticationStrategy</strong>: <strong>CsrfAuthenticationStrategy</strong>å’Œ<strong>CSRF</strong>æ”»å‡»æœ‰å…³, è¯¥ç±»ä¸»è¦è´Ÿè´£åœ¨èº«ä»½éªŒè¯ååˆ é™¤æ—§çš„<strong>CsrfToken</strong>å¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„<strong>CsrfToken</strong></li>
<li><strong>ConcurrentSessionControlAuthenticationStrategy</strong>: è¯¥ç±»ä¸»è¦ç”¨æ¥å¤„ç†Sessionå¹¶å‘é—®é¢˜.</li>
<li><strong>RegisterSessionAuthenticationStrategy</strong>: è¯¥ç±»ç”¨æ¥åœ¨è®¤è¯æˆåŠŸåå°†<strong>HttpSession</strong>ä¿¡æ¯è®°å½•åˆ°<strong>SessionRegistry</strong>ä¸­ </li>
<li><strong>CompositeSessionAuthenticationStrategy</strong>: è¿™æ˜¯ä¸€ä¸ªå¤åˆç­–ç•¥, å®ƒé‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ªé›†åˆ, é›†åˆä¸­ä¿å­˜äº†å¤šä¸ªä¸åŒçš„<strong>SessionAuthenticationStrategy</strong>å¯¹è±¡, ç›¸å½“äºè¯¥ç±»ä»£ç†äº†å¤šä¸ª<strong>SessionAuthenticationStrategy</strong>å¯¹è±¡, å¤§éƒ¨åˆ†æƒ…å†µä¸‹, åœ¨SpringSecurityæ¡†æ¶ä¸­ç›´æ¥ä½¿ç”¨çš„ä¹Ÿæ˜¯è¯¥ç±»çš„å®ä¾‹.</li>
<li><strong>NullAuthenticatedSessionStrategy</strong>: è¿™æ˜¯ä¸€ä¸ªç©ºçš„å®ç°, æ²¡åšä»»ä½•å¤„ç†</li>
<li><strong>AbstractSessionFixationProtectionStrategy</strong>: é€šè¿‡ä¿®æ”¹sessionIdæ¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»</li>
<li><strong>ChangeSessionIdAuthenticationStrategy</strong>: é€šè¿‡ä¿®æ”¹sessionIdæ¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡».</li>
<li><strong>SessionFixationProtectionStrategy</strong>: é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯æ¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»</li>
</ul>
<h3 id="ConcurrentSessionControlAuthenticationStrategy"><a href="#ConcurrentSessionControlAuthenticationStrategy" class="headerlink" title="ConcurrentSessionControlAuthenticationStrategy"></a>ConcurrentSessionControlAuthenticationStrategy</h3><p>â€‹	åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­, èµ·ä¸»è¦ä½œç”¨çš„æ˜¯<strong>ConcurrentSessionControlAuthenticationStrategy</strong>, å› æ­¤è¿™é‡Œå…ˆå¯¹è¯¥ç±»è¿›è¡Œé‡ç‚¹åˆ†æ, å…ˆæ¥çœ‹å®ƒé‡Œé¢çš„<strong>onAuthentication</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request,</span><br><span class="hljs-params">		HttpServletResponse response)</span> &#123;<br>	<span class="hljs-type">int</span> <span class="hljs-variable">allowedSessions</span> <span class="hljs-operator">=</span> getMaximumSessionsForThisUser(authentication);<br>	<span class="hljs-keyword">if</span> (allowedSessions == -<span class="hljs-number">1</span>) &#123;<br>		<span class="hljs-comment">// We permit unlimited logins</span><br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	List&lt;SessionInformation&gt; sessions = <span class="hljs-built_in">this</span>.sessionRegistry.getAllSessions(authentication.getPrincipal(), <span class="hljs-literal">false</span>);<br>	<span class="hljs-type">int</span> <span class="hljs-variable">sessionCount</span> <span class="hljs-operator">=</span> sessions.size();<br>	<span class="hljs-keyword">if</span> (sessionCount &lt; allowedSessions) &#123;<br>		<span class="hljs-comment">// They haven&#x27;t got too many login sessions running at present</span><br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sessionCount == allowedSessions) &#123;<br>		<span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>		<span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-comment">// Only permit it though if this request is associated with one of the</span><br>			<span class="hljs-comment">// already registered sessions</span><br>			<span class="hljs-keyword">for</span> (SessionInformation si : sessions) &#123;<br>				<span class="hljs-keyword">if</span> (si.getSessionId().equals(session.getId())) &#123;<br>					<span class="hljs-keyword">return</span>;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// If the session is null, a new one will be created by the parent class,</span><br>		<span class="hljs-comment">// exceeding the allowed number</span><br>	&#125;<br>	allowableSessionsExceeded(sessions, allowedSessions, <span class="hljs-built_in">this</span>.sessionRegistry);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨è¯¥æ–¹æ³•ä¸­, é¦–å…ˆä»<strong>sessionRegistry</strong>ä¸­è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æœªå¤±æ•ˆçš„<strong>SessionInformation</strong>å®ä¾‹, ç„¶åè·å–åˆ°å½“å‰é¡¹ç›®å…è®¸çš„æœ€å¤§sessionæ•°. å¦‚æœè·å–çš„<strong>SessionInformation</strong>å®ä¾‹æ•°å°äºå½“å‰é¡¹ç›®å…è®¸çš„æœ€å¤§<strong>session</strong>æ•°, è¯´æ˜å½“å‰ç™»å½•æ²¡é—®é¢˜, ç›´æ¥returnå³å¯. å¦‚æœå…è®¸çš„æœ€å¤§sessionæ•°é‡ä¸º-1, åˆ™è¡¨ç¤ºåº”ç”¨å¹¶ä¸é™åˆ¶ç™»å½•å¹¶å‘æ•°, å½“å‰ç™»å½•ä¹Ÿæ²¡æœ‰é—®é¢˜, ç›´æ¥è¿”å›å³å¯. å¦‚æœè·å–åˆ°<strong>SessionInformation</strong>å®ä¾‹ç­‰äºå½“å‰é¡¹ç›®å…è®¸çš„æœ€å¤§<strong>session</strong>æ•°, åˆ™å»åˆ¤æ–­å½“å‰ç™»å½•çš„<strong>sessionId</strong>æ˜¯å¦å­˜åœ¨äºè·å–åˆ°çš„<strong>SessionInformation</strong>å®ä¾‹ä¸­, å¦‚æœå­˜åœ¨, è¯´æ˜ç™»å½•ä¹Ÿæ²¡æœ‰é—®é¢˜, ç›´æ¥è¿”å›å³å¯.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">allowableSessionsExceeded</span><span class="hljs-params">(List&lt;SessionInformation&gt; sessions, <span class="hljs-type">int</span> allowableSessions,</span><br><span class="hljs-params">			SessionRegistry registry)</span> <span class="hljs-keyword">throws</span> SessionAuthenticationException &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.exceptionIfMaximumExceeded || (sessions == <span class="hljs-literal">null</span>)) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionAuthenticationException</span>(<br>					<span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;</span>,<br>							<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; allowableSessions &#125;, <span class="hljs-string">&quot;Maximum sessions of &#123;0&#125; for this principal exceeded&quot;</span>));<br>		&#125;<br>		<span class="hljs-comment">// Determine least recently used sessions, and mark them for invalidation</span><br>		sessions.sort(Comparator.comparing(SessionInformation::getLastRequest));<br>		<span class="hljs-type">int</span> <span class="hljs-variable">maximumSessionsExceededBy</span> <span class="hljs-operator">=</span> sessions.size() - allowableSessions + <span class="hljs-number">1</span>;<br>		List&lt;SessionInformation&gt; sessionsToBeExpired = sessions.subList(<span class="hljs-number">0</span>, maximumSessionsExceededBy);<br>		<span class="hljs-keyword">for</span> (SessionInformation session : sessionsToBeExpired) &#123;<br>			session.expireNow();<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¦‚æœ<strong>exceptionIfMaximumExceeded</strong>å±æ€§ä¸ºtrue, åˆ™ç›´æ¥æŠ›å‡ºä¸€æ¬¡, è¯¥å±æ€§çš„å€¼ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨<strong>SecurityConfig</strong>ä¸­é€šè¿‡<strong>maxSessionsPreventsLogin</strong>æ–¹æ³•é…ç½®çš„å€¼, å³ç¦æ­¢åæ¥è€…ç™»å½•, æŠ›å‡ºå¼‚å¸¸ä¹‹å, æœ¬æ¬¡ç™»å½•å¤±è´¥. å¦åˆ™è¯´æ˜ä¸ç¦æ­¢åæ¥è€…ç™»å½•, æ­¤æ—¶å¯¹æŸ¥è¯¢å‡ºæ¥çš„å½“å‰ç”¨æˆ·æ‰€æœ‰ç™»å½•ä¼šè¯æŒ‰ç…§æœ€åä¸€æ¬¡è¯·æ±‚æ—¶é—´è¿›è¡Œæ’åº, ç„¶åè®¡ç®—å‡ºéœ€è¦è¿‡æœŸçš„<strong>session</strong>æ•°é‡, ä»<strong>sessions</strong>é›†åˆä¸­å–å‡ºæ¥è¿›è¡Œéå†, ä¾æ¬¡è°ƒç”¨å…¶<strong>expireNow</strong>æ–¹æ³•ä½¿ä¹‹è¿‡æœŸ.</p>
<p>â€‹	è¿™å°±æ˜¯<strong>ConcurrentSessionControlAuthenticationStrategy</strong>ç±»çš„å®ç°é€»è¾‘.</p>
<h3 id="RegisterSessionAuthnticationStrategy"><a href="#RegisterSessionAuthnticationStrategy" class="headerlink" title="RegisterSessionAuthnticationStrategy"></a>RegisterSessionAuthnticationStrategy</h3><p>â€‹	åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­, é»˜è®¤ä¹Ÿç”¨åˆ°äº†<strong>RegisterSessionAuthenticationStrategy</strong>, è¯¥ç±»çš„ä½œç”¨ä¸»è¦æ˜¯å‘<strong>SessionRegistry</strong>ä¸­è®°å½•<strong>HttpSession</strong>ä¿¡æ¯, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>onAuthentication</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request,</span><br><span class="hljs-params">		HttpServletResponse response)</span> &#123;<br>	<span class="hljs-built_in">this</span>.sessionRegistry.registerNewSession(request.getSession().getId(), authentication.getPrincipal());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°,è¿™é‡Œçš„<strong>onAuthentication</strong>æ–¹æ³•éå¸¸ç®€å•, å°±æ˜¯è°ƒç”¨<strong>registerNewSession</strong>æ–¹æ³•å‘<strong>sessionRegistry</strong>ä¸­æ·»åŠ ä¸€æ¡ç™»å½•ä¼šè¯ä¿¡æ¯</p>
<p>â€‹	</p>
<h3 id="CompositeSessionAuthenticationStrategy"><a href="#CompositeSessionAuthenticationStrategy" class="headerlink" title="CompositeSessionAuthenticationStrategy"></a>CompositeSessionAuthenticationStrategy</h3><p>â€‹	<strong>CompositeSessionAuthenticationStrategy</strong>ç±»ç›¸å¯¹äºä¸€ä¸ªä»£ç†ç±», é»˜è®¤ä½¿ç”¨çš„å…¶å®å°±æ˜¯è¯¥ç±»çš„å®ä¾‹, æˆ‘ä»¬æ¥çœ‹ä¸€è¯¥ç±»çš„<strong>onAuthentication</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request,</span><br><span class="hljs-params">		HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> SessionAuthenticationException &#123;<br>	<span class="hljs-type">int</span> <span class="hljs-variable">currentPosition</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.delegateStrategies.size();<br>	<span class="hljs-keyword">for</span> (SessionAuthenticationStrategy delegate : <span class="hljs-built_in">this</span>.delegateStrategies) &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.trace(LogMessage.format(<span class="hljs-string">&quot;Preparing session with %s (%d/%d)&quot;</span>,<br>					delegate.getClass().getSimpleName(), ++currentPosition, size));<br>		&#125;<br>		delegate.onAuthentication(authentication, request, response);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°,è¿™é‡Œå°±æ˜¯éå†å®ƒæ‰€ç»´æŠ¤çš„<strong>SessionAuthenticationStrategy</strong>é›†åˆ, ç„¶ååˆ†åˆ«è°ƒç”¨å…¶<strong>onAuthentication</strong>æ–¹æ³•.</p>
<p>â€‹	åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­, ä¸»è¦æ¶‰åŠåˆ°è¿™äº›SessionAuthenticationStrategyå®ä¾‹, è¿˜æœ‰å…¶ä»–ä¸€äº›SessionAuthenticationStrategyå®ä¾‹, æˆ‘ä»¬æ¥ä¸‹æ¥çš„å°èŠ‚ä¸­è¯¦ç»†ä»‹ç», è¿™é‡Œä¸å†è¯´æ˜</p>
<h3 id="SessionManagementFilter"><a href="#SessionManagementFilter" class="headerlink" title="SessionManagementFilter"></a>SessionManagementFilter</h3><p>â€‹	å’Œä¼šè¯å¹¶å‘ç®¡ç†ç›¸å…³çš„è¿‡æ»¤å™¨ä¸»è¦æœ‰ä¸¤ä¸ª, å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ª<strong>SessionManagementFilter</strong>.</p>
<p>â€‹	<strong>SessionManagementFilter</strong>ä¸»è¦ç”¨æ¥å¤„ç†<strong>RememberMe</strong>ç™»å½•æ—¶çš„ä¼šè¯ç®¡ç†: å³å¦‚æœç”¨æˆ·ä½¿ç”¨äº†<strong>RememberMe</strong>çš„æ–¹å¼è¿›è¡Œè®¤è¯, åˆ™è®¤è¯æˆåŠŸåéœ€è¦è¿›è¡Œä¼šè¯ç®¡ç†, ç›¸å…³çš„ç®¡ç†æ“ä½œé€šè¿‡<strong>SessionManagementFilter</strong>è¿‡æ»¤å™¨è§¦å‘. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯¥è¿‡æ»¤å™¨çš„<strong>doFilter</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>		<span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>	<span class="hljs-keyword">if</span> (request.getAttribute(FILTER_APPLIED) != <span class="hljs-literal">null</span>) &#123;<br>		chain.doFilter(request, response);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	request.setAttribute(FILTER_APPLIED, Boolean.TRUE);<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.securityContextRepository.containsContext(request)) &#123;<br>		<span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();<br>		<span class="hljs-keyword">if</span> (authentication != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.trustResolver.isAnonymous(authentication)) &#123;<br>			<span class="hljs-comment">// The user has been authenticated during the current request, so call the</span><br>			<span class="hljs-comment">// session strategy</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-built_in">this</span>.sessionAuthenticationStrategy.onAuthentication(authentication, request, response);<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (SessionAuthenticationException ex) &#123;<br>				<span class="hljs-comment">// The session strategy can reject the authentication</span><br>				<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;SessionAuthenticationStrategy rejected the authentication object&quot;</span>, ex);<br>				SecurityContextHolder.clearContext();<br>				<span class="hljs-built_in">this</span>.failureHandler.onAuthenticationFailure(request, response, ex);<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-comment">// Eagerly save the security context to make it available for any possible</span><br>			<span class="hljs-comment">// re-entrant requests which may occur before the current request</span><br>			<span class="hljs-comment">// completes. SEC-1396.</span><br>			<span class="hljs-built_in">this</span>.securityContextRepository.saveContext(SecurityContextHolder.getContext(), request, response);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// No security context or authentication present. Check for a session</span><br>			<span class="hljs-comment">// timeout</span><br>			<span class="hljs-keyword">if</span> (request.getRequestedSessionId() != <span class="hljs-literal">null</span> &amp;&amp; !request.isRequestedSessionIdValid()) &#123;<br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) &#123;<br>					<span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Request requested invalid session id %s&quot;</span>,<br>							request.getRequestedSessionId()));<br>				&#125;<br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.invalidSessionStrategy != <span class="hljs-literal">null</span>) &#123;<br>					<span class="hljs-built_in">this</span>.invalidSessionStrategy.onInvalidSessionDetected(request, response);<br>					<span class="hljs-keyword">return</span>;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>	chain.doFilter(request, response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨è¯¥è¿‡æ»¤å™¨ä¸­, é€šè¿‡<strong>containsContext</strong>æ–¹æ³•å»åˆ¤æ–­å½“å‰ä¼šè¯ä¸­æ˜¯å¦å­˜åœ¨<strong>SPRING_SECURITY_CONTEXT</strong>å˜é‡. å¦‚æœæ˜¯æ­£å¸¸çš„è®¤è¯æµç¨‹, åˆ™<strong>SPRING_SECURITY_CONTEXT</strong>å˜é‡æ˜¯å­˜åœ¨äºå½“å‰ä¼šè¯ä¸­çš„. é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¸å­˜åœ¨å‘¢? æœ‰ä¸¤ç§æƒ…å†µ:</p>
<ol>
<li>ç”¨æˆ·ä½¿ç”¨äº†<strong>RememberMe</strong>æ–¹æ³•è¿›è¡Œè®¤è¯</li>
<li>ç”¨æˆ·åŒ¿åè®¿é—®äº†æŸä¸ªæ¥å£.</li>
</ol>
<p>â€‹	å¯¹äºç¬¬ä¸€ç§æƒ…å†µ, <strong>SecurityContextHolder</strong>ä¸­è·å–åˆ°çš„å½“å‰ç”¨æˆ·å®ä¾‹æ˜¯<strong>RememberMeAuthenticationToken</strong>; å¯¹äºç¬¬äºŒç§æƒ…å†µ, <strong>SecurityContextHolder</strong>ä¸­è·å–åˆ°çš„å½“å‰ç”¨æˆ·å®ä¾‹æ˜¯<strong>AnonymousAuthenticationToken</strong>. æ‰€ä»¥, æ¥ä¸‹æ¥å°±æ˜¯å¯¹è¿™ä¸¤ç§æƒ…å†µè¿›è¡ŒåŒºåˆ†, å¦‚æœæ˜¯ç¬¬ä¸€ç§æƒ…å†µ, åˆ™è°ƒç”¨<strong>SessionAuthenticationStrategy</strong>ä¸­çš„<strong>onAuthentication</strong>æ–¹æ³•è¿›è¡Œä¼šè¯ç®¡ç†; å¦‚æœæ˜¯ç¬¬äºŒç§æƒ…å†µ, åˆ™è¿›è¡Œä¼šè¯å¤±æ•ˆå¤„ç†.</p>
<h3 id="ConcurrentSessionFilter"><a href="#ConcurrentSessionFilter" class="headerlink" title="ConcurrentSessionFilter"></a>ConcurrentSessionFilter</h3><p>â€‹	<strong>concurrentSessionFilter</strong>è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªå¤„ç†ä¼šè¯å¹¶å‘ç®¡ç†çš„è¿‡æ»¤å™¨, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„<strong>doFilter</strong>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>			<span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>		<span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>		<span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sessionRegistry.getSessionInformation(session.getId());<br>			<span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">if</span> (info.isExpired()) &#123;<br>					<span class="hljs-comment">// Expired - abort processing</span><br>					<span class="hljs-built_in">this</span>.logger.debug(LogMessage<br>							.of(() -&gt; <span class="hljs-string">&quot;Requested session ID &quot;</span> + request.getRequestedSessionId() + <span class="hljs-string">&quot; has expired.&quot;</span>));<br>					doLogout(request, response);<br>					<span class="hljs-built_in">this</span>.sessionInformationExpiredStrategy<br>							.onExpiredSessionDetected(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionInformationExpiredEvent</span>(info, request, response));<br>					<span class="hljs-keyword">return</span>;<br>				&#125;<br>				<span class="hljs-comment">// Non-expired - update last request date/time</span><br>				<span class="hljs-built_in">this</span>.sessionRegistry.refreshLastRequest(info.getSessionId());<br>			&#125;<br>		&#125;<br>		chain.doFilter(request, response);<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ä»<strong>doFilter</strong>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°, å½“è¯·æ±‚é€šè¿‡æ—¶, é¦–å…ˆå…ˆè·å–å½“å‰ä¼šè¯, å¦‚æœå½“å‰ä¼šè¯ä¸ä¸ºnull, åˆ™è¿›è€Œè·å–å½“å‰ä¼šè¯æ‰€å¯¹åº”çš„<strong>SessionInformation</strong>å®ä¾‹; å¦‚æœ<strong>SessionInformation</strong>å®ä¾‹å·²ç»è¿‡æœŸ, åˆ™è°ƒç”¨<strong>doLogout</strong>æ–¹æ³•æ‰§è¡Œæ³¨é”€æ“ä½œ, åŒæ—¶è°ƒç”¨ä¼šè¯è¿‡æœŸçš„å›è°ƒ; å¦‚æœ<strong>SessionInformation</strong>å®ä¾‹æ²¡æœ‰è¿‡æœŸ, åˆ™åˆ·æ–°å½“å‰ä¼šè¯çš„æœ€åä¸€æ¬¡è¯·æ±‚æ—¶é—´.</p>
<h3 id="sessionçš„åˆ›å»ºæ—¶æœŸ"><a href="#sessionçš„åˆ›å»ºæ—¶æœŸ" class="headerlink" title="sessionçš„åˆ›å»ºæ—¶æœŸ"></a>sessionçš„åˆ›å»ºæ—¶æœŸ</h3><p>â€‹	åœ¨è®²è§£é…ç½®ç±»ä¹‹å‰, éœ€è¦å…ˆäº†è§£ä¸€ä¸‹SpringSecurityä¸­Sessionçš„åˆ›å»ºæ—¶æœºé—®é¢˜. åœ¨SpringSecurityä¸­, HttpSessionçš„åˆ›å»ºç­–ç•¥ä¸€å…±åˆ†ä¸ºå››ç§:</p>
<ol>
<li><strong>ALWAYS</strong>: å¦‚æœHttpSessionä¸å­˜åœ¨, å°±åˆ›å»º</li>
<li><strong>NEVER</strong>: ä»ä¸åˆ›å»ºHttpSession, ä½†æ˜¯å¦‚æœHttpSessionå·²ç»å­˜åœ¨äº†, åˆ™ä¼šä½¿ç”¨å®ƒ</li>
<li><strong>IF_REQUIRED</strong>: å½“æœ‰éœ€è¦æ—¶, ä¼šåˆ›å»ºHttpSession, é»˜è®¤å³æ­¤.</li>
<li><strong>STATELESS</strong>: ä»ä¸åˆ›å»º<strong>HttpSession</strong>, ä»ä¸ä½¿ç”¨<strong>HttpSession</strong></li>
</ol>
<p>â€‹	éœ€è¦æ³¨æ„çš„æ˜¯, è¿™å››ç§ç­–ç•¥ä»…ä»…æ˜¯æŒ‡<strong>SpringSecurity</strong>ä¸­<strong>HttpSession</strong>çš„åˆ›å»ºç­–ç•¥, è€Œå¹¶éæ•´ä¸ªåº”ç”¨ç¨‹åºä¸­<strong>HttpSession</strong>çš„åˆ›å»ºç­–ç•¥. å‰ä¸‰ç§ç­–ç•¥éƒ½å¾ˆå¥½ç†è§£.å…³äºç¬¬å››ç§, æœ‰å¯èƒ½ä¼šæœ‰ç–‘æƒ‘, å¦‚æœå®Œå…¨ä¸ä½¿ç”¨<strong>HttpSession</strong>é‚£ä¹ˆ<strong>SpringSecurity</strong>è¿˜èƒ½å‘æŒ¥ä½œç”¨å—?å½“ç„¶å¯ä»¥, å¦‚æœç³»ç»Ÿä½¿ç”¨äº†æ— çŠ¶æ€è®¤è¯æ–¹å¼, å°±å¯ä»¥ä½¿ç”¨<strong>STATELESS</strong>ç­–ç•¥, è¿™å°±æ„å‘³ç€æœåŠ¡ç«¯ä¸ä¼šåˆ›å»º<strong>HttpSession</strong>, å®¢æˆ·ç«¯çš„æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦æºå¸¦è®¤è¯ä¿¡æ¯, åŒæ—¶, ä¸€äº›å’Œ<strong>HttpSession</strong>ç›¸å…³çš„è¿‡æ»¤å™¨ä¹Ÿå°†å¤±æ•ˆ, å¦‚<strong>SessionManagementFilter</strong>ã€<strong>ConcurrentSessionFilter</strong>ç­‰.</p>
<p>â€‹	ä¸€èˆ¬æ¥è¯´, æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„<strong>IF_REQUIRED</strong>å³å¯, å¦‚æœè¯»è€…éœ€è¦é…ç½®, å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>			http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>  &#125;<br></code></pre></td></tr></table></figure>





<h3 id="AbstractAuthenticationFilterConfigurer"><a href="#AbstractAuthenticationFilterConfigurer" class="headerlink" title="AbstractAuthenticationFilterConfigurer"></a>AbstractAuthenticationFilterConfigurer</h3><p>â€‹	çœ‹å®Œå‰é¢çš„åˆ†æ, è¯»è€…å¯èƒ½è¿˜æ˜¯æœ‰ç–‘æƒ‘, ç™»å½•æˆåŠŸå, <strong>Session</strong>å¹¶å‘ç®¡ç†åˆ°åº•æ˜¯åœ¨å“ªé‡Œè§¦å‘çš„? è™½ç„¶ç»è¿‡å‰é¢çš„åˆ†æ, å¤§å®¶çŸ¥é“äº†ä¸¤ä¸ªè¿‡æ»¤å™¨çš„å­˜åœ¨: <strong>SessionManagementFilter</strong>å’Œ<strong>ConcurrentSessionFilter</strong>, ä½†æ˜¯å‰è€…åœ¨ç”¨æˆ·ä½¿ç”¨<strong>RemmberMe</strong>è®¤è¯æ—¶, æ‰ä¼šè§¦å‘<strong>Session</strong>å¹¶å‘ç®¡ç†, åè€…åˆ™æ ¹æœ¬ä¸ä¼šè§¦å‘Sessionå¹¶å‘ç®¡ç†, é‚£ä¹ˆç”¨æˆ·ç™»å½•æˆåŠŸå, åˆ°åº•æ˜¯åœ¨å“ªé‡Œè§¦å‘Sessionå¹¶å‘ç®¡ç†çš„å‘¢?</p>
<p>â€‹	è¿™é‡Œæˆ‘ä»¬å¯ä»¥å›åˆ°ç™»å½•è¿‡æ»¤å™¨<strong>AbstractAuthenticationProcessingFilter</strong>çš„<strong>doFilter</strong>æ–¹æ³•ä¸­å»çœ‹ä¸€ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>			<span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>		<span class="hljs-keyword">if</span> (!requiresAuthentication(request, response)) &#123;<br>			chain.doFilter(request, response);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticationResult</span> <span class="hljs-operator">=</span> attemptAuthentication(request, response);<br>			<span class="hljs-keyword">if</span> (authenticationResult == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-comment">// return immediately as subclass has indicated that it hasn&#x27;t completed</span><br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-built_in">this</span>.sessionStrategy.onAuthentication(authenticationResult, request, response);<br>			<span class="hljs-comment">// Authentication success</span><br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.continueChainBeforeSuccessfulAuthentication) &#123;<br>				chain.doFilter(request, response);<br>			&#125;<br>			successfulAuthentication(request, response, chain, authenticationResult);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InternalAuthenticationServiceException failed) &#123;<br>			<span class="hljs-built_in">this</span>.logger.error(<span class="hljs-string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span>, failed);<br>			unsuccessfulAuthentication(request, response, failed);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (AuthenticationException ex) &#123;<br>			<span class="hljs-comment">// Authentication failed</span><br>			unsuccessfulAuthentication(request, response, ex);<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, åœ¨è°ƒç”¨<strong>attemptAuthentication</strong>æ–¹æ³•è¿›è¡Œç™»å½•è®¤è¯ä¹‹å, æ¥ä¸‹æ¥å°±è°ƒç”¨äº†<strong>sessionStrategy.onAuthentication</strong>æ–¹æ³•è§¦å‘<strong>Session</strong>å¹¶å‘ç®¡ç†.</p>
<p>â€‹	è¿™é‡Œçš„<strong>sessionStrategy</strong>å¯¹è±¡åˆ™æ˜¯åœ¨<strong>AbstractAuthenticationFilterConfigurer</strong>ç±»çš„<strong>configure</strong>æ–¹æ³•è¿›è¡Œé…ç½®çš„, å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAuthenticationFilterConfigurer</span>&lt;B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpSecurityBuilder</span>&lt;B&gt;, T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationFilterConfigurer</span>&lt;B, T, F&gt;, F <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span>&gt;<br>		<span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHttpConfigurer</span>&lt;T, B&gt; &#123;<br>  <br>  <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(B http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">SessionAuthenticationStrategy</span> <span class="hljs-variable">sessionAuthenticationStrategy</span> <span class="hljs-operator">=</span> http<br>				.getSharedObject(SessionAuthenticationStrategy.class);<br>		<span class="hljs-keyword">if</span> (sessionAuthenticationStrategy != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.authFilter.setSessionAuthenticationStrategy(sessionAuthenticationStrategy);<br>		&#125;<br>    .....<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥çœ‹åˆ°, è¿™é‡Œä»<strong>HttpSecurity</strong>çš„å…±äº«å¯¹è±¡ä¸­è·å–åˆ°<strong>SessionAuthenticationStrategy</strong>å®ä¾‹( åœ¨<strong>SessionManagementConfigurer</strong>#<strong>init</strong>æ–¹æ³•ä¸­å­˜å…¥<strong>HttpSecurity</strong>å…±äº«å¯¹è±¡), å¹¶è®¾ç½®åˆ°<strong>authFilter</strong>è¿‡æ»¤å™¨ä¸­.</p>
<p>â€‹	</p>
<p>â€‹	æˆ‘ä»¬å†æ¥æ¢³ç†ä¸€ä¸‹:</p>
<p>â€‹	ç”¨æˆ·é€šè¿‡ç”¨æˆ·å&#x2F;å¯†ç å‘èµ·ä¸€ä¸ªè®¤è¯è¯·æ±‚, å½“è®¤è¯æˆåŠŸå, åœ¨<strong>AbstractAuthenticationProcessingFilter</strong>#<strong>doFilter</strong>æ–¹æ³•ä¸­è§¦å‘äº†<strong>Session</strong>å¹¶å‘ç®¡ç†.é»˜è®¤çš„<strong>sessionStrategy</strong>æ˜¯<strong>CompositeSessionAuthenticationStrategy</strong>, å®ƒä¸€å…±ä»£ç†äº†ä¸‰ä¸ª<strong>SessionAuthenticationStrategy</strong>, åˆ†åˆ«æ˜¯<strong>ConcurrentSessionControlAuthenticationStrategy</strong>ã€<strong>ChangeSessionIdAuthenticationStrategy</strong>ã€<strong>RegisterSessionAuthenticationStrategy</strong>. å½“å‰è¯·æ±‚åœ¨è¿™ä¸‰ä¸ª<strong>SessionAuthenticationStrategy</strong>è¿™åˆ†åˆ«èµ°ä¸€åœˆ, ç¬¬ä¸€ä¸ªç”¨æ¥åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·çš„<strong>Session</strong>æ•°é‡æ˜¯å¦å·²ç»è¶…è¿‡äº†é™åˆ¶, å¦‚æœè¶…å‡ºäº†é™åˆ¶å°±æ ¹æ®é…ç½®å¥½çš„çš„è§„åˆ™è¿›è¡Œå¤„ç†, ç¬¬äºŒä¸ªç”¨æ¥ä¿®æ”¹<strong>sessionId</strong>(é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»); ç¬¬ä¸‰ä¸ªç”¨æ¥å°†å½“å‰<strong>Session</strong>æ³¨å†Œåˆ°<strong>SessionRegistry</strong>ä¸­. ä½¿ç”¨ç”¨æˆ·å&#x2F;å¯†ç çš„æ–¹å¼å®Œæˆè®¤è¯, å°†ä¸ä¼šæ¶‰åŠåˆ°<strong>ConcurrentSessionFilter</strong>å’Œ<strong>SessionManagementFilter</strong>ä¸¤ä¸ªè¿‡æ»¤å™¨. å¦‚æœç”¨æˆ·ä½¿ç”¨äº†<strong>RememberMe</strong>çš„æ–¹å¼è¿›è¡Œèº«ä»½è®¤è¯, åˆ™ä¼šé€šè¿‡<strong>SessionManagementFilter</strong>#<strong>doFilter</strong>æ–¹æ³•è§¦å‘<strong>Session</strong>å¹¶å‘ç®¡ç†. å½“ç”¨æˆ·è®¤è¯æˆåŠŸå, ä»¥åçš„æ¯ä¸€æ¬¡è¯·æ±‚éƒ½ä¼šç»è¿‡<strong>ConcurrentSessionFilter</strong>, åœ¨è¯¥è¿‡æ»¤å™¨ä¸­, åˆ¤æ–­å½“å‰ä¼šè¯æ˜¯å¦å·²ç»è¿‡æœŸ, å¦‚æœè¿‡æœŸåˆ™ä¼šæ‰§è¡Œæ³¨é”€ç™»å½•æµç¨‹; å¦‚æœæ²¡æœ‰è¿‡æœŸ, åˆ™æ›´æ–°æœ€è¿‘ä¸€æ¬¡è¯·æ±‚æ—¶é—´.</p>
<h1 id="ç¬¬ä¹ç« -CSRF-æ¼æ´ä¿æŠ¤"><a href="#ç¬¬ä¹ç« -CSRF-æ¼æ´ä¿æŠ¤" class="headerlink" title="ç¬¬ä¹ç«  CSRF æ¼æ´ä¿æŠ¤"></a>ç¬¬ä¹ç«  CSRF æ¼æ´ä¿æŠ¤</h1><ul>
<li><p>CSRF ç®€ä»‹</p>
</li>
<li><p>CSRF é˜²å¾¡&amp;åŸºæœ¬é…ç½®</p>
</li>
<li><p>å®æˆ˜</p>
</li>
</ul>
<h3 id="ç®€ä»‹-4"><a href="#ç®€ä»‹-4" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>CSRF (Cross-Site Request Forgery è·¨ç«™è¯·æ±‚ä¼ªé€ )ï¼Œä¹Ÿå¯ç§°ä¸ºä¸€é”®å¼æ”»å‡» (one-click-attackï¼‰ï¼Œé€šå¸¸ç¼©å†™ä¸º <code>CSRF</code> æˆ–è€… <code>XSRF</code>ã€‚</p>
<p><code>CSRF</code> æ”»å‡»æ˜¯ä¸€ç§æŒŸæŒç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„æµè§ˆå™¨ä¸Šå‘é€æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹æ³•ã€‚ç›¸å¯¹äºXSSåˆ©ç”¨ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼ŒCSRFåˆ™æ˜¯åˆ©ç”¨ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»ã€‚ç®€å•æ¥è¯´ï¼ŒCSRFæ˜¯è‡´å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå»è®¿é—®ä¸€ä¸ªç”¨æˆ·æ›¾ç»è®¤è¯è¿‡çš„ç½‘ç«™å¹¶æ‰§è¡Œæ¶æ„è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€é‚®ä»¶ã€å‘æ¶ˆæ¯ã€ç”šè‡³è´¢äº§æ“ä½œ (å¦‚è½¬è´¦å’Œè´­ä¹°å•†å“ï¼‰ã€‚ç”±äºå®¢æˆ·ç«¯(æµè§ˆå™¨)å·²ç»åœ¨è¯¥ç½‘ç«™ä¸Šè®¤è¯è¿‡ï¼Œæ‰€ä»¥è¯¥ç½‘ç«™ä¼šè®¤ä¸ºæ˜¯çœŸæ­£ç”¨æˆ·åœ¨æ“ä½œè€Œæ‰§è¡Œè¯·æ±‚ï¼ˆå®é™…ä¸Šè¿™ä¸ªå¹¶éç”¨æˆ·çš„æœ¬æ„ï¼‰ã€‚</p>
<p><strong>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</strong></p>
<p>å‡è®¾ blr ç°åœ¨ç™»å½•äº†æŸé“¶è¡Œçš„ç½‘ç«™å‡†å¤‡å®Œæˆä¸€é¡¹è½¬è´¦æ“ä½œï¼Œè½¬è´¦çš„é“¾æ¥å¦‚ä¸‹ï¼š</p>
<p><strong>https: &#x2F;&#x2F;bank .xxx .com&#x2F;withdraw?account&#x3D;blr&amp;amount&#x3D;1000&amp;for&#x3D;zhangsan</strong></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªé“¾æ¥æ˜¯æƒ³ä» blr è¿™ä¸ªè´¦æˆ·ä¸‹è½¬è´¦ 1000 å…ƒåˆ° zhangsan è´¦æˆ·ä¸‹ï¼Œå‡è®¾blr æ²¡æœ‰æ³¨é”€ç™»å½•è¯¥é“¶è¡Œçš„ç½‘ç«™ï¼Œå°±åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ–°çš„é€‰é¡¹å¡ä¸­æ‰“å¼€äº†ä¸€ä¸ªå±é™©ç½‘ç«™ï¼Œè¿™ä¸ªå±é™©ç½‘ç«™ä¸­æœ‰ä¸€å¹…å›¾ç‰‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><strong><img src="/https :/bank.xxx.com/withdraw" srcset="/img/loading.gif" lazyload></strong></p>
<p>ä¸€æ—¦ç”¨æˆ·æ‰“å¼€äº†è¿™ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªå›¾ç‰‡é“¾æ¥ä¸­çš„è¯·æ±‚å°±ä¼šè‡ªåŠ¨å‘é€å‡ºå»ã€‚ç”±äºæ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å¹¶ä¸”ç”¨æˆ·å°šæœªæ³¨é”€ç™»å½•ï¼Œæ‰€ä»¥è¯¥è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Šå¯¹åº”çš„æœ‰æ•ˆçš„ Cookie ä¿¡æ¯ï¼Œè¿›è€Œå®Œæˆä¸€æ¬¡è½¬è´¦æ“ä½œã€‚è¿™å°±æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ã€‚</p>
<h3 id="CSRFæ”»å‡»æ¼”ç¤º"><a href="#CSRFæ”»å‡»æ¼”ç¤º" class="headerlink" title="CSRFæ”»å‡»æ¼”ç¤º"></a>CSRFæ”»å‡»æ¼”ç¤º</h3><h4 id="åˆ›å»ºé“¶è¡Œåº”ç”¨"><a href="#åˆ›å»ºé“¶è¡Œåº”ç”¨" class="headerlink" title="åˆ›å»ºé“¶è¡Œåº”ç”¨"></a>åˆ›å»ºé“¶è¡Œåº”ç”¨</h4><ul>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests().anyRequest().authenticated()<br>                .and().formLogin().and().csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º controller å¹¶å¯åŠ¨å¯åŠ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/withdraw&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">withdraw</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="åˆ›å»ºæ¶æ„åº”ç”¨"><a href="#åˆ›å»ºæ¶æ„åº”ç”¨" class="headerlink" title="åˆ›å»ºæ¶æ„åº”ç”¨"></a>åˆ›å»ºæ¶æ„åº”ç”¨</h4><ul>
<li><p>åˆ›å»ºç®€å• springboot åº”ç”¨</p>
</li>
<li><p>ä¿®æ”¹é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>å‡†å¤‡æ”»å‡»é¡µé¢</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://127.0.0.1:8080/withdraw&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;blr&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;money&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ç‚¹æˆ‘&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="CSRF-é˜²å¾¡"><a href="#CSRF-é˜²å¾¡" class="headerlink" title="CSRF é˜²å¾¡"></a>CSRF é˜²å¾¡</h3><p><strong>CSRF</strong>æ”»å‡»çš„æ ¹æºåœ¨äºæµè§ˆå™¨é»˜è®¤çš„èº«ä»½éªŒè¯æœºåˆ¶(è‡ªåŠ¨æºå¸¦å½“å‰ç½‘ç«™çš„Cookieä¿¡æ¯)ï¼Œè¿™ç§æœºåˆ¶è™½ç„¶å¯ä»¥ä¿è¯è¯·æ±‚æ˜¯æ¥è‡ªç”¨æˆ·çš„æŸä¸ªæµè§ˆå™¨ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿è¿™è¯·æ±‚æ˜¯ç”¨æˆ·æˆæƒå‘é€ã€‚æ”»å‡»è€…å’Œç”¨æˆ·å‘é€çš„è¯·æ±‚ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æœ‰åŠæ³•å»ç›´æ¥æ‹’ç»è¿™é‡Œçš„æŸä¸€ä¸ªè¯·æ±‚ã€‚å¦‚æœèƒ½åœ¨åˆæ³•æ¸…æ±‚ä¸­é¢å¤–æºå¸¦ä¸€ä¸ªæ”»å‡»è€…æ— æ³•è·å–çš„å‚æ•°ï¼Œå°±å¯ä»¥æˆåŠŸåŒºåˆ†å‡ºä¸¤ç§ä¸åŒçš„è¯·æ±‚ï¼Œè¿›è€Œç›´æ¥æ‹’ç»æ‰æ¶æ„è¯·æ±‚ã€‚åœ¨ SpringSecurity ä¸­å°±æä¾›äº†è¿™ç§æœºåˆ¶æ¥é˜²å¾¡ CSRF æ”»å‡»ï¼Œè¿™ç§æœºåˆ¶æˆ‘ä»¬ç§°ä¹‹ä¸º<code>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</code>ã€‚</p>
<h4 id="ä»¤ç‰ŒåŒæ­¥æ¨¡å¼"><a href="#ä»¤ç‰ŒåŒæ­¥æ¨¡å¼" class="headerlink" title="ä»¤ç‰ŒåŒæ­¥æ¨¡å¼"></a>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</h4><p>è¿™æ˜¯ç›®å‰ä¸»æµçš„ CSRF æ”»å‡»é˜²å¾¡æ–¹æ¡ˆã€‚å…·ä½“çš„æ“ä½œæ–¹å¼å°±æ˜¯åœ¨æ¯ä¸€ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œé™¤äº†é»˜è®¤è‡ªåŠ¨æºå¸¦çš„ Cookie å‚æ•°ä¹‹å¤–ï¼Œå†æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€éšæœºç”Ÿæˆçš„å®‡ç¬¦ä¸²ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º CSRF ä»¤ç‰Œã€‚è¿™ä¸ª CSRF ä»¤ç‰Œç”±æœåŠ¡ç«¯ç”Ÿæˆï¼Œç”Ÿæˆååœ¨ HtpSession ä¸­ä¿å­˜ä¸€ä»½ã€‚å½“å‰ç«¯è¯·æ±‚åˆ°è¾¾åï¼Œå°†è¯·æ±‚æºå¸¦çš„ CSRF ä»¤ç‰Œä¿¡æ¯å’ŒæœåŠ¡ç«¯ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸¤è€…ä¸ç›¸ç­‰ï¼Œåˆ™æ‹’ç»æ‰è¯¥ HITTP è¯·æ±‚ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„:</strong> è€ƒè™‘åˆ°ä¼šæœ‰ä¸€äº›å¤–éƒ¨ç«™ç‚¹é“¾æ¥åˆ°æˆ‘ä»¬çš„ç½‘ç«™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ±‚è¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ ·å¯¹å­HEADã€OPTIONSã€TRACE ç­‰æ–¹æ³•å°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ CSRF ä»¤ç‰Œäº†ï¼Œå¼ºè¡Œä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»¤ç‰Œæ³„éœ²ï¼</p>
</blockquote>
<h4 id="å¼€å¯-CSRF-é˜²å¾¡"><a href="#å¼€å¯-CSRF-é˜²å¾¡" class="headerlink" title="å¼€å¯ CSRF é˜²å¾¡"></a>å¼€å¯ CSRF é˜²å¾¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.<br>          ...<br>          formLogin()<br>          .and()<br>          .csrf(); <span class="hljs-comment">//å¼€å¯ csrf</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="æŸ¥çœ‹ç™»å½•é¡µé¢æºç "><a href="#æŸ¥çœ‹ç™»å½•é¡µé¢æºç " class="headerlink" title="æŸ¥çœ‹ç™»å½•é¡µé¢æºç "></a>æŸ¥çœ‹ç™»å½•é¡µé¢æºç </h4><p><img src="/2022/01/26/SpringSecurity/image-20220418191456109.png" srcset="/img/loading.gif" lazyload alt="image-20220418191456109"></p>
<h3 id="ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF"><a href="#ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF" class="headerlink" title="ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF"></a>ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF</h3><p>å¼€å¯CSRFé˜²å¾¡åä¼šè‡ªåŠ¨åœ¨æäº¤çš„è¡¨å•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¦‚æœä¸èƒ½è‡ªåŠ¨åŠ å…¥ï¼Œéœ€è¦åœ¨å¼€å¯ä¹‹åæ‰‹åŠ¨åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶éšç€è¯·æ±‚æäº¤ã€‚è·å–æœåŠ¡ç«¯ä»¤ç‰Œæ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">th:name</span>=<span class="hljs-string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;_csrf.token&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="å¼€å‘æµ‹è¯•-controller"><a href="#å¼€å‘æµ‹è¯•-controller" class="headerlink" title="å¼€å‘æµ‹è¯• controller"></a>å¼€å‘æµ‹è¯• controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@PostMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello success&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello success&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/index.html&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="åˆ›å»º-html"><a href="#åˆ›å»º-html" class="headerlink" title="åˆ›å»º html"></a>åˆ›å»º html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>æµ‹è¯• CSRF é˜²å¾¡<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/hello&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hello&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="æµ‹è¯•æŸ¥çœ‹index-htmlæºç "><a href="#æµ‹è¯•æŸ¥çœ‹index-htmlæºç " class="headerlink" title="æµ‹è¯•æŸ¥çœ‹index.htmlæºç "></a>æµ‹è¯•æŸ¥çœ‹index.htmlæºç </h4><p><img src="/2022/01/26/SpringSecurity/image-20220418193519717.png" srcset="/img/loading.gif" lazyload alt="image-20220418193519717"></p>
<h3 id="å‰åç«¯åˆ†ç¦»ä½¿ç”¨-CSRF"><a href="#å‰åç«¯åˆ†ç¦»ä½¿ç”¨-CSRF" class="headerlink" title="å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF"></a>å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF</h3><p>å‰åç«¯åˆ†ç¦»å¼€å‘æ—¶ï¼Œåªéœ€è¦å°†ç”Ÿæˆ csrf æ”¾å…¥åˆ°cookie ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚æ—¶è·å– cookie ä¸­ä»¤ç‰Œä¿¡æ¯è¿›è¡Œæäº¤å³å¯ã€‚</p>
<h4 id="ä¿®æ”¹-CSRF-å­˜å…¥-Cookie"><a href="#ä¿®æ”¹-CSRF-å­˜å…¥-Cookie" class="headerlink" title="ä¿®æ”¹ CSRF å­˜å…¥ Cookie"></a>ä¿®æ”¹ CSRF å­˜å…¥ Cookie</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests().anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .csrf()<br>                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹-cookie"><a href="#è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹-cookie" class="headerlink" title="è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie"></a>è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie</h4><p><img src="/2022/01/26/SpringSecurity/image-20220418194059737.png" srcset="/img/loading.gif" lazyload alt="image-20220418194059737"></p>
<h4 id="å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯"><a href="#å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯" class="headerlink" title="å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯"></a>å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯</h4><ul>
<li>è¯·æ±‚å‚æ•°ä¸­æºå¸¦ä»¤ç‰Œ</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">key:</span> <span class="hljs-string">_csrf</span>  <br><span class="hljs-string">value:&quot;xxx&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>è¯·æ±‚å¤´ä¸­æºå¸¦ä»¤ç‰Œ</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">X-XSRF-TOKEN:value<br></code></pre></td></tr></table></figure>













<h1 id="ç¬¬åç« -è·¨åŸŸ"><a href="#ç¬¬åç« -è·¨åŸŸ" class="headerlink" title="ç¬¬åç«  è·¨åŸŸ"></a>ç¬¬åç«  è·¨åŸŸ</h1><ul>
<li>Spring å¤„ç†æ–¹æ¡ˆã€‚</li>
<li>Spring Security å¤„ç†æ–¹æ¡ˆã€‚</li>
</ul>
<h2 id="ç®€ä»‹-5"><a href="#ç®€ä»‹-5" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è·¨åŸŸé—®é¢˜æ˜¯å®é™…åº”ç”¨å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œåœ¨ Spring æ¡†æ¶ä¸­å¯¹äºè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆæœ‰å¥½å‡ ç§ï¼Œå¼• äº† Spring Security ä¹‹åï¼Œè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆåˆå¢åŠ äº†ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-CORS"><a href="#ä»€ä¹ˆæ˜¯-CORS" class="headerlink" title="ä»€ä¹ˆæ˜¯ CORS"></a>ä»€ä¹ˆæ˜¯ CORS</h2><p>CORS (Cross-Origin Resource Sharing ï¼‰æ˜¯ç”± W3Cåˆ¶å®šçš„ä¸€ç§è·¨åŸŸèµ„æºå…±äº«æŠ€æœ¯æ ‡å‡†ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³å‰ç«¯çš„è·¨åŸŸè¯·æ±‚ã€‚åœ¨JavaEE å¼€å‘ä¸­ï¼Œæœ€å¸¸è§çš„å‰ç«¯è·¨åŸŸè¯·æ±‚è§£å†³æ–¹æ¡ˆæ˜¯æ—©æœŸçš„JSONPï¼Œä½†æ˜¯ JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼Œè€Œ CORS åˆ™æ”¯ç‰¹å¤šç§ HTTTPè¯·æ±‚æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚</p>
<p>CORS ä¸­æ–°å¢äº†ä¸€ç»„HTTP è¯·æ±‚å¤´å­—æ®µï¼Œé€šè¿‡è¿™äº›å­—æ®µï¼ŒæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨ï¼Œé‚£äº›ç½‘ç«™é€šè¿‡æµè§ˆå™¨æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚åŒæ—¶è§„å®šï¼Œå¯¹é‚£äº›å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨æ•°æ®çš„HTTPè¯·æ±‚æ–¹æ³• ï¼ˆå¦‚GETä»¥å¤–çš„HTTP è¯·æ±‚ç­‰)ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚(prenightstï¼‰ï¼Œé¢„æ£€è¯·æ±‚çš„ç›®çš„æ˜¯æŸ¥çœ‹æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒå³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯å…è®¸ï¼Œæ‰å‘é€å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆå¦‚ Cookiesã€HTTP è®¤è¯ä¿¡æ¯ç­‰ï¼‰ã€‚</p>
<blockquote>
<p> CORS: åŒæº&#x2F;åŒåŸŸ &#x3D; åè®®+ä¸»æœº+ç«¯å£</p>
</blockquote>
<h3 id="ç®€å•è¯·æ±‚"><a href="#ç®€å•è¯·æ±‚" class="headerlink" title="ç®€å•è¯·æ±‚"></a>ç®€å•è¯·æ±‚</h3><p>GET è¯·æ±‚ä¸ºä¾‹ï¼Œå¦‚æœéœ€è¦å‘èµ·ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œåˆ™è¯·æ±‚å¤´å¦‚ä¸‹ï¼š</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:8080<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://localhost:8081<br>Referer:http://localhost:8081/index.html<br></code></pre></td></tr></table></figure>

<p>å¦‚æœæœåŠ¡ç«¯æ”¯æŒè¯¥è·¨åŸŸè¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›çš„å“åº”å¤´ä¸­å°†åŒ…å«å¦‚ä¸‹å­—æ®µï¼š</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">Access-Control-Allow-Origin:http://localhost: 8081<br></code></pre></td></tr></table></figure>

<p>Access-Control-Allow-Origin å­—æ®µç”¨æ¥å‘Šè¯‰æµè§ˆå™¨å¯ä»¥è®¿é—®è¯¥èµ„æºçš„åŸŸï¼Œå½“æµè§ˆå™¨æ”¶åˆ°è¿™æ ·çš„å“åº”å¤´ä¿¡æ¯ä¹‹åï¼Œæå–å‡º Access-Control-Allow-Origin å­—æ®µä¸­çš„å€¼ï¼Œ å‘ç°è¯¥å€¼åŒ…å«å½“å‰é¡µé¢æ‰€åœ¨çš„åŸŸï¼Œå°±çŸ¥é“è¿™ä¸ªè·¨åŸŸæ˜¯è¢«å…è®¸çš„ï¼Œå› æ­¤å°±ä¸å†å¯¹å‰ç«¯çš„è·¨åŸŸè¯·æ±‚è¿›è¡Œé™åˆ¶ã€‚è¿™å±äºç®€å•è¯·æ±‚ï¼Œå³ä¸éœ€è¦è¿›è¡Œé¢„æ£€è¯·æ±‚çš„è·¨åŸŸã€‚</p>
<h3 id="éç®€å•è¯·æ±‚"><a href="#éç®€å•è¯·æ±‚" class="headerlink" title="éç®€å•è¯·æ±‚"></a>éç®€å•è¯·æ±‚</h3><p>å¯¹äºä¸€äº›éç®€å•è¯·æ±‚ï¼Œä¼šé¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">OPTIONS</span> <span class="hljs-string">/put</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:8080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br>Access-Control-Request-Method:PUT<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://localhost: 8081<br>Referer:http://localhost:8081/index.html<br></code></pre></td></tr></table></figure>

<p>è¯·æ±‚æ–¹æ³•æ˜¯ OPTIONSï¼Œè¯·æ±‚å¤´Origin å°±å‘Šè¯‰æœåŠ¡ç«¯å½“å‰é¡µé¢æ‰€åœ¨åŸŸï¼Œè¯·æ±‚å¤´ Access-Control-Request-Methods å‘Šè¯‰æœåŠ¡å™¨ç«¯å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚æ‰€ä½¿ç”¨çš„ä¸‡æ³•ã€‚æœåŠ¡ç«¯å¯¹æ­¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…è®¸å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¼šç»™å‡ºå¦‚ä¸‹å“åº”ï¼š</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span><br>Access-Control-Allow-Origin:http://localhost: 8081<br><span class="hljs-attribute">Access-Control-Request-Methods</span><span class="hljs-punctuation">: </span>PUT<br><span class="hljs-attribute">Access-Control-Max-Age</span><span class="hljs-punctuation">: </span>3600<br></code></pre></td></tr></table></figure>

<p>Access-Control-Allow-Metbods å­—æ®µè¡¨ç¤ºå…è®¸çš„è·¨åŸŸæ–¹æ³•ï¼šAccess-Control-Max-Age å­—æ®µè¡¨ç¤ºé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œåœ¨æœ‰æ•ˆæœŸå†…å¦‚æœå‘èµ·è¯¥è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¸ç”¨å†æ¬¡å‘èµ·é¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç»“æœ¿åï¼Œæ¥ä¸‹æ¥å°±ä¼šå‘èµ·ä¸€ä¸ªçœŸæ­£çš„è·¨åŸŸè¯·æ±‚ï¼Œè·¨åŸŸè¯·æ±‚å’Œå‰é¢çš„ç®€å•è¯·æ±‚è·¨åŸŸæ­¥éª¤ç±»ä¼¼ã€‚</p>
<h2 id="Spring-è·¨åŸŸè§£å†³æ–¹æ¡ˆ"><a href="#Spring-è·¨åŸŸè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ"></a>Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h2><h3 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="@CrossOrigin"></a>@CrossOrigin</h3><p>Spring ä¸­ç¬¬ä¸€ç§å¤„ç†è·¨åŸŸçš„æ–¹å¼æ˜¯é€šè¿‡@CrossOrigin æ³¨è§£æ¥æ ‡è®°æ”¯æŒè·¨åŸŸï¼Œè¯¥æ³¨è§£å¯ä»¥æ·»åŠ åœ¨æ–¹æ³•ä¸Šï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ Controller ä¸Šã€‚å½“æ·»åŠ åœ¨ Controller ä¸Šæ—¶ï¼Œè¡¨ç¤º Controller ä¸­çš„æ‰€</p>
<p>æœ‰æ¥å£éƒ½æ”¯æŒè·¨åŸŸï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> Class HelloController&#123;<br>	<span class="hljs-meta">@CrossOrigin</span> (origins =<span class="hljs-string">&quot;http://localhost:8081&quot;</span>)<br>	<span class="hljs-meta">@PostMapping</span> (<span class="hljs-string">&quot;/post&quot;</span>)<br>	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">post</span> <span class="hljs-params">()</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello post&quot;</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>@CrossOrigin æ³¨è§£å„å±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>alowCredentialsï¼šæµè§ˆå™¨æ˜¯å¦åº”å½“å‘é€å‡­è¯ä¿¡æ¯ï¼Œå¦‚ Cookieã€‚</p>
</li>
<li><p>allowedHeadersï¼š è¯·æ±‚è¢«å…è®¸çš„è¯·æ±‚å¤´å­—æ®µï¼Œ<code>*</code>è¡¨ç¤ºæ‰€æœ‰å­—æ®µã€‚</p>
</li>
<li><p>exposedHeadersï¼šå“ªäº›å“åº”å¤´å¯ä»¥ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p>
<p><code>æ³¨æ„ï¼Œè¿™é‡Œåªå¯ä»¥ä¸€ä¸€åˆ—ä¸¾ï¼Œé€šé…ç¬¦ * åœ¨è¿™é‡Œæ˜¯æ— æ•ˆçš„ã€‚</code></p>
</li>
<li><p>maxAgeï¼šé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸå†…ä¸å¿…å†æ¬¡å‘é€é¢„æ£€è¯·æ±‚ï¼Œé»˜è®¤æ˜¯<code>1800 </code>ç§’ã€‚</p>
</li>
<li><p>methodsï¼šå…è®¸çš„è¯·æ±‚æ–¹æ³•ï¼Œ<code>*</code> è¡¨ç¤ºå…è®¸æ‰€æœ‰æ–¹æ³•ã€‚</p>
</li>
<li><p>originsï¼šå…è®¸çš„åŸŸï¼Œ<code>*</code>è¡¨ç¤ºå…è®¸æ‰€æœ‰åŸŸã€‚</p>
</li>
</ul>
<h3 id="addCrosMapping"><a href="#addCrosMapping" class="headerlink" title="addCrosMapping"></a>addCrosMapping</h3><p>@CrossOrigin æ³¨è§£éœ€è¦æ·»åŠ åœ¨ä¸åŒçš„ Controller ä¸Šã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ç§å…¨å±€é…ç½®æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡é‡å†™ WebMvcConfigurerComposite#addCorsMappingsæ–¹æ³•æ¥å®ç°ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Configuration<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span>&#123;<br>  Override<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span> <span class="hljs-params">(CorsRegistry registry)</span>&#123;<br>    registry.addMapping(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">//å¤„ç†çš„è¯·æ±‚åœ°å€</span><br>    .allowedMethods (<span class="hljs-string">&quot;*&quot;</span>)<br>    â€¢allowedorigins(<span class="hljs-string">&quot;*&quot;</span>)<br>    .allowedHeaders (<span class="hljs-string">&quot;*&quot;</span>)<br>    .allowCredentials (<span class="hljs-literal">false</span>)<br>    â€¢exposedHeaders (<span class="hljs-string">&quot;&quot;</span>)<br>    .maxAge (<span class="hljs-number">3600</span>) ;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="CrosFilter"><a href="#CrosFilter" class="headerlink" title="CrosFilter"></a>CrosFilter</h3><p>Cosr Filter æ˜¯Spring Web ä¸­æä¾›çš„ä¸€ä¸ªå¤„ç†è·¨åŸŸçš„è¿‡æ»¤å™¨ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡è¯¥è¿‡è¯¥è¿‡æ»¤å™¨å¤„ç†è·¨åŸŸã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    FilterRegistrationBean&lt;CorsFilter&gt; <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>        FilterRegistrationBean&lt;CorsFilter&gt; registrationBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>&lt;&gt;();<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">corsConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setMaxAge(<span class="hljs-number">3600L</span>);<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, corsConfiguration);<br>        registrationBean.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source));<br>        registrationBean.setOrder(-<span class="hljs-number">1</span>);<span class="hljs-comment">//filter 0 1</span><br>        <span class="hljs-keyword">return</span> registrationBean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Spring-Security-è·¨åŸŸè§£å†³æ–¹æ¡ˆ"><a href="#Spring-Security-è·¨åŸŸè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ"></a>Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h2><h3 id="åŸç†åˆ†æ-2"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>å½“æˆ‘ä»¬ä¸ºé¡¹ç›®æ·»åŠ äº† Spring Security ä¾èµ–ä¹‹åï¼Œå‘ç°ä¸Šé¢ä¸‰ç§è·¨åŸŸæ–¹å¼æœ‰çš„å¤±æ•ˆäº†ï¼Œæœ‰<br>åˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>
<p>é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸï¼Œç»Ÿç»Ÿå¤±æ•ˆäº†ï¼Œé€š<br>CorsFilter é…ç½®çš„è·¨åŸŸï¼Œæœ‰æ²¡æœ‰å¤±æ•ˆåˆ™è¦çœ‹è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº Sp<br>Security è¿‡æ»¤å™¨ï¼Œå³å…ˆäº Spring Security è¿‡æ»¤å™¨æ‰§è¡Œï¼Œåˆ™ CorsFiter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†ä¾ç„¶æœ‰æ•ˆï¼›å¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§ä½äº Spring Security è¿‡æ»¤å™¨ï¼Œåˆ™ CorsFilter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†å°±ä¼šå¤±æ•ˆã€‚</p>
<p>ä¸ºäº†ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç®€ç•¥äº†è§£ä¸€ä¸‹ Filterã€DispatchserServlet ä»¥åŠInterceptor æ‰§è¡Œé¡ºåºã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220521074711128.png" srcset="/img/loading.gif" lazyload alt="image-20220521074711128"></p>
<p>ç†æ¸…æ¥šäº†æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬å†æ¥çœ‹è·¨åŸŸè¯·æ±‚è¿‡ç¨‹ã€‚ç”±äºéç®€å•è¯·æ±‚éƒ½è¦é¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚<br>requestï¼‰ï¼Œè€Œé¢„æ£€è¯·æ±‚å¹¶ä¸ä¼šæºå¸¦è®¤è¯ä¿¡æ¯ï¼Œæ‰€ä»¥é¢„æ£€è¯·æ±‚å°±æœ‰è¢« Spring Security æ‹¦æˆªçš„å¯èƒ½ã€‚å› æ­¤é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸå°±ä¼šå¤±æ•ˆã€‚å¦‚æœä½¿ç”¨ CorsFilter é…ç½®çš„è·¨åŸŸï¼Œåªè¦è¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº SpringSecurity è¿‡æ»¤å™¨å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚åä¹‹åŒæ ·ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>Spring Security ä¸­ä¹Ÿæä¾›äº†æ›´ä¸“ä¸šçš„æ–¹å¼æ¥è§£å†³é¢„æ£€è¯·æ±‚æ‰€é¢ä¸´çš„é—®é¢˜ã€‚å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>		<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests().anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .cors() <span class="hljs-comment">//è·¨åŸŸå¤„ç†æ–¹æ¡ˆ</span><br>                .configurationSource(configurationSource())<br>                .and()<br>                .csrf().disable();<br>    &#125;<br><br>    CorsConfigurationSource <span class="hljs-title function_">configurationSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">corsConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));<br>        corsConfiguration.setMaxAge(<span class="hljs-number">3600L</span>);<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, corsConfiguration);<br>        <span class="hljs-keyword">return</span> source;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>











<h1 id="ç¬¬åä¸€ç« -å¼‚å¸¸å¤„ç†"><a href="#ç¬¬åä¸€ç« -å¼‚å¸¸å¤„ç†" class="headerlink" title="ç¬¬åä¸€ç«  å¼‚å¸¸å¤„ç†"></a>ç¬¬åä¸€ç«  å¼‚å¸¸å¤„ç†</h1><ul>
<li>Spring Security å¼‚å¸¸ä½“ç³»</li>
<li>è‡ªå®šä¹‰å¼‚å¸¸é…ç½®</li>
</ul>
<h3 id="å¼‚å¸¸ä½“ç³»"><a href="#å¼‚å¸¸ä½“ç³»" class="headerlink" title="å¼‚å¸¸ä½“ç³»"></a>å¼‚å¸¸ä½“ç³»</h3><p>Spring Security ä¸­å¼‚å¸¸ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»:</p>
<ul>
<li>AuthenticationException:  è®¤è¯å¼‚å¸¸</li>
<li>AccessDeniedException:    æˆæƒå¼‚å¸¸</li>
</ul>
<img src="/2022/01/26/SpringSecurity/image-20230402223226568.png" srcset="/img/loading.gif" lazyload alt="image-20230402223226568" style="zoom:67%;">

<p>å…¶ä¸­è®¤è¯æ‰€æ¶‰åŠå¼‚å¸¸ç±»å‹æ¯”è¾ƒå¤šï¼Œé»˜è®¤æä¾›çš„å¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220430213210778.png" srcset="/img/loading.gif" lazyload alt="image-20220430213210778"></p>
<p>ç›¸æ¯”äºè®¤è¯å¼‚å¸¸ï¼Œæƒé™å¼‚å¸¸ç±»å°±è¦å°‘äº†å¾ˆå¤šï¼Œé»˜è®¤æä¾›çš„æƒé™å¼‚å¸¸å¦‚ä¸‹ï¼š</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230402223444247-0446086.png" srcset="/img/loading.gif" lazyload alt="image-20230402223444247"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220430213344621.png" srcset="/img/loading.gif" lazyload alt="image-20220430213344621"></p>
<p>åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœé»˜è®¤æä¾›å¼‚å¸¸æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦æ ¹æ®å®é™…éœ€è¦æ¥è‡ªå®šä¹‰å¼‚å¸¸ç±»ã€‚</p>
<h3 id="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®"><a href="#è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®" class="headerlink" title="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®"></a>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests().anyRequest()<br>                .authenticated()<br>          			<span class="hljs-comment">//.....</span><br>                .and()<br>                .exceptionHandling()<span class="hljs-comment">//å¼‚å¸¸å¤„ç†</span><br>                .authenticationEntryPoint((request, response, e) -&gt; &#123;<br>                  response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                  response.setStatus(HttpStatus.UNAUTHORIZED.value());<br>                  response.getWriter().write(<span class="hljs-string">&quot;å°šæœªè®¤è¯ï¼Œè¯·è¿›è¡Œè®¤è¯æ“ä½œï¼&quot;</span>);<br>                &#125;)<br>                .accessDeniedHandler((request, response, e) -&gt; &#123;<br>                  response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                  response.setStatus(HttpStatus.FORBIDDEN.value());<br>                  response.getWriter().write(<span class="hljs-string">&quot;æ— æƒè®¿é—®!&quot;</span>);<br>                &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>











<h1 id="ç¬¬åäºŒç« -æˆæƒ"><a href="#ç¬¬åäºŒç« -æˆæƒ" class="headerlink" title="ç¬¬åäºŒç«  æˆæƒ"></a>ç¬¬åäºŒç«  æˆæƒ</h1><ul>
<li>ä»€ä¹ˆæ˜¯æƒé™ç®¡ç†</li>
<li>æƒé™ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ</li>
<li>Spring Security æƒé™ç®¡ç†ç­–ç•¥</li>
<li>åŸºäº URL åœ°å€çš„æƒé™ç®¡ç†</li>
<li>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†</li>
<li>å®æˆ˜</li>
</ul>
<h3 id="æƒé™ç®¡ç†"><a href="#æƒé™ç®¡ç†" class="headerlink" title="æƒé™ç®¡ç†"></a>æƒé™ç®¡ç†</h3><h4 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h4><p>**<code>èº«ä»½è®¤è¯</code>**ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚Spring Security ä¸­æ”¯æŒå¤šç§ä¸åŒæ–¹å¼çš„è®¤è¯ï¼Œä½†æ˜¯æ— è®ºå¼€å‘è€…ä½¿ç”¨é‚£ç§æ–¹å¼è®¤è¯ï¼Œéƒ½ä¸ä¼šå½±å“æˆæƒåŠŸèƒ½ä½¿ç”¨ã€‚å› ä¸º Spring Security å¾ˆå¥½åšåˆ°äº†è®¤è¯å’Œæˆæƒè§£è€¦ã€‚</p>
<h4 id="æˆæƒ"><a href="#æˆæƒ" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h4><p>**<code>æˆæƒ</code>**ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ç®€å•çš„ç†è§£æˆæƒå°±æ˜¯æ ¹æ®ç³»ç»Ÿæå‰è®¾ç½®å¥½çš„è§„åˆ™ï¼Œç»™ç”¨æˆ·åˆ†é…å¯ä»¥è®¿é—®æŸä¸€ä¸ªèµ„æºçš„æƒé™ï¼Œç”¨æˆ·æ ¹æ®è‡ªå·±æ‰€å…·æœ‰æƒé™ï¼Œå»æ‰§è¡Œç›¸åº”æ“ä½œã€‚</p>
<h3 id="æˆæƒæ ¸å¿ƒæ¦‚å¿µ"><a href="#æˆæƒæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æˆæƒæ ¸å¿ƒæ¦‚å¿µ"></a>æˆæƒæ ¸å¿ƒæ¦‚å¿µ</h3><p>åœ¨å‰é¢å­¦ä¹ è®¤è¯è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥è®¤è¯æˆåŠŸä¹‹åä¼šå°†å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Authentication å¯¹è±¡ä¸­ï¼ŒAuthentication å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª getAuthorities() æ–¹æ³•ï¼Œç”¨æ¥è¿”å›å½“å‰ç™»å½•ç”¨æˆ·å…·å¤‡çš„æƒé™ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç”¨æˆ·å…·æœ‰æƒé™ä¿¡æ¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º Collection&lt;? extends GrantedAuthority&gt;ï¼Œå½“éœ€è¦è¿›è¡Œæƒé™åˆ¤æ–­æ—¶ï¼Œå°±å›æ ¹æ®é›†åˆè¿”å›æƒé™ä¿¡æ¯è°ƒç”¨ç›¸åº”æ–¹æ³•è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220523110143445.png" srcset="/img/loading.gif" lazyload alt="image-20220523110143445"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé’ˆå¯¹äºè¿™ä¸ªè¿”å›å€¼ GrantedAuthority åº”è¯¥å¦‚ä½•ç†è§£å‘¢? æ˜¯è§’è‰²è¿˜æ˜¯æƒé™?</p>
<p>æˆ‘ä»¬é’ˆå¯¹äºæˆæƒå¯ä»¥æ˜¯<code>åŸºäºè§’è‰²æƒé™ç®¡ç†</code>å’Œ<code>åŸºäºèµ„æºæƒé™ç®¡ç†</code> ï¼Œä»è®¾è®¡å±‚é¢ä¸Šæ¥è¯´ï¼Œè§’è‰²å’Œæƒé™æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼šæƒé™æ˜¯ä¸€äº›å…·ä½“æ“ä½œï¼Œè§’è‰²åˆ™æ˜¯æŸäº›æƒé™é›†åˆã€‚å¦‚ï¼šREAD_BOOK å’Œ ROLE_ADMIN æ˜¯å®Œå…¨ä¸åŒçš„ã€‚å› æ­¤è‡³äºè¿”å›å€¼æ˜¯ä»€ä¹ˆå–å†³äºä½ çš„ä¸šåŠ¡è®¾è®¡æƒ…å†µï¼š</p>
<ul>
<li><p>åŸºäºè§’è‰²æƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>è§’è‰²</code> </p>
</li>
<li><p>åŸºäºèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>æƒé™</code> </p>
</li>
<li><p>åŸºäºè§’è‰²å’Œèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> è¿”å›ç»Ÿç§°ä¸ºç”¨æˆ·çš„<code>æƒé™</code></p>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆå¯ä»¥ç»Ÿç§°ä¸ºæƒé™ï¼Œå› ä¸ºä»ä»£ç å±‚é¢è§’è‰²å’Œæƒé™æ²¡æœ‰å¤ªå¤§ä¸åŒéƒ½æ˜¯æƒé™ï¼Œç‰¹åˆ«æ˜¯åœ¨ Spring Security ä¸­ï¼Œè§’è‰²å’Œæƒé™å¤„ç†æ–¹å¼åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€åŒºåˆ« SpringSecurity åœ¨å¾ˆå¤šæ—¶å€™ä¼šè‡ªåŠ¨ç»™è§’è‰²æ·»åŠ ä¸€ä¸ª<code>ROLE_</code>å‰ç¼€ï¼Œè€Œæƒé™åˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ ã€‚</p>
<h3 id="æƒé™ç®¡ç†ç­–ç•¥"><a href="#æƒé™ç®¡ç†ç­–ç•¥" class="headerlink" title="æƒé™ç®¡ç†ç­–ç•¥"></a>æƒé™ç®¡ç†ç­–ç•¥</h3><p>Spring Security ä¸­æä¾›çš„æƒé™ç®¡ç†ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ç±»å‹:</p>
<ul>
<li><p>åŸºäºè¿‡æ»¤å™¨(URL)çš„æƒé™ç®¡ç† (FilterSecurityInterceptor)</p>
<ul>
<li>åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥æ‹¦æˆª HTTP è¯·æ±‚ï¼Œæ‹¦æˆªä¸‹æ¥ä¹‹åï¼Œæ ¹æ® HTTP è¯·æ±‚åœ°å€è¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
</ul>
</li>
<li><p>åŸºäº AOP (æ–¹æ³•)çš„æƒé™ç®¡ç†   (MethodSecurityInterceptor)</p>
<ul>
<li>åŸºäº AOP æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ–¹æ³•çº§åˆ«çš„æƒé™é—®é¢˜ã€‚å½“éœ€è¦è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œé€šè¿‡ AOP å°†æ“ä½œæ‹¦æˆªä¸‹æ¥ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸å…³çš„æƒé™ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åŸºäº-URL-æƒé™ç®¡ç†"><a href="#åŸºäº-URL-æƒé™ç®¡ç†" class="headerlink" title="åŸºäº URL æƒé™ç®¡ç†"></a>åŸºäº URL æƒé™ç®¡ç†</h3><ul>
<li>å¼€å‘ controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/admin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">admin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;admin ok&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">user</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user ok&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getInfo&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;info ok&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é…ç½®æˆæƒ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.blr.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-comment">//åˆ›å»ºå†…å­˜æ•°æ®æº</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;ADMIN&quot;</span>).build());<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;win7&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;USER&quot;</span>).build());<br>        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;READ_BOOK&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeHttpRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/admin/**&quot;</span>).hasRole(<span class="hljs-string">&quot;ADMIN&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="hljs-string">&quot;USER&quot;</span>, <span class="hljs-string">&quot;ADMIN&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/getInfo&quot;</span>).hasRole(<span class="hljs-string">&quot;READ_BOOK&quot;</span>)<br>                .anyRequest().authenticated()<br>                .and().formLogin()<br>                .and().csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®æµ‹è¯•</p>
<h4 id="æƒé™è¡¨è¾¾å¼"><a href="#æƒé™è¡¨è¾¾å¼" class="headerlink" title="æƒé™è¡¨è¾¾å¼"></a>æƒé™è¡¨è¾¾å¼</h4><p><img src="/2022/01/26/SpringSecurity/image-20220523153200373.png" srcset="/img/loading.gif" lazyload alt="image-20220523153200373"></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>hasAuthority(String authority)</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™</td>
</tr>
<tr>
<td>hasAnyAuthority(Stringâ€¦ authorities)</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™ä¸­ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td>hasRole(String role)</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²</td>
</tr>
<tr>
<td>hasAnyRole(Stringâ€¦ roles);</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²ä¸­ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td>permitAll();</td>
<td>æ”¾è¡Œæ‰€æœ‰è¯·æ±‚&#x2F;è°ƒç”¨</td>
</tr>
<tr>
<td>denyAll();</td>
<td>æ‹’ç»æ‰€æœ‰è¯·æ±‚&#x2F;è°ƒç”¨</td>
</tr>
<tr>
<td>isAnonymous();</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªåŒ¿åç”¨æˆ·</td>
</tr>
<tr>
<td>isAuthenticated();</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è®¤è¯æˆåŠŸ</td>
</tr>
<tr>
<td>isRememberMe();</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•</td>
</tr>
<tr>
<td>isFullyAuthenticated();</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦æ—¢ä¸æ˜¯åŒ¿åç”¨æˆ·åˆä¸æ˜¯é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•çš„</td>
</tr>
<tr>
<td>hasPermission(Object targetId, Object permission);</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</td>
</tr>
<tr>
<td>hasPermission(Object targetId, String targetType, Object permission);</td>
<td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</td>
</tr>
</tbody></table>
<h3 id="åŸºäº-æ–¹æ³•-æƒé™ç®¡ç†"><a href="#åŸºäº-æ–¹æ³•-æƒé™ç®¡ç†" class="headerlink" title="åŸºäº æ–¹æ³• æƒé™ç®¡ç†"></a>åŸºäº æ–¹æ³• æƒé™ç®¡ç†</h3><p>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯é€šè¿‡ A0P æ¥å®ç°çš„ï¼ŒSpring Security ä¸­é€šè¿‡ MethodSecurityInterceptor æ¥æä¾›ç›¸å…³çš„å®ç°ã€‚ä¸åŒåœ¨äº FilterSecurityInterceptor åªæ˜¯åœ¨è¯·æ±‚ä¹‹å‰è¿›è¡Œå‰ç½®å¤„ç†ï¼ŒMethodSecurityInterceptor é™¤äº†å‰ç½®å¤„ç†ä¹‹å¤–è¿˜å¯ä»¥è¿›è¡Œåç½®å¤„ç†ã€‚å‰ç½®å¤„ç†å°±æ˜¯åœ¨è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å…·å¤‡ç›¸åº”çš„æƒé™ï¼Œåç½®å¤„ç†åˆ™æ˜¯å¯¹æ–¹æ³•çš„æ‰§è¡Œç»“æœè¿›è¡ŒäºŒæ¬¡è¿‡æ»¤ã€‚å‰ç½®å¤„ç†å’Œåç½®å¤„ç†åˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„å®ç°ç±»ã€‚</p>
<h4 id="EnableGlobalMethodSecurity"><a href="#EnableGlobalMethodSecurity" class="headerlink" title="@EnableGlobalMethodSecurity"></a>@EnableGlobalMethodSecurity</h4><p>EnableGlobalMethodSecurity è¯¥æ³¨è§£æ˜¯ç”¨æ¥å¼€å¯æƒé™æ³¨è§£ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>perPostEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„å››ä¸ªæƒé™æ³¨è§£ï¼Œ@PostAuthorizeã€@PostFilterã€@PreAuthorize ä»¥åŠ@PreFilterã€‚</li>
<li><strong>securedEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„ @Secured æ³¨è§£æ”¯æŒï¼Œè¯¥æ³¨è§£ä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</li>
<li><strong>jsr250Enabled</strong>: å¼€å¯ JSR-250 æä¾›çš„æ³¨è§£ï¼Œä¸»è¦æ˜¯@DenyAllã€@PermitAllã€@RolesAll åŒæ ·è¿™äº›æ³¨è§£ä¹Ÿä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># ä»¥ä¸Šæ³¨è§£å«ä¹‰å¦‚ä¸‹:</span><br><span class="hljs-bullet">-</span> @PostAuthorizeï¼š åœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åè¿›è¡Œæƒé™æ ¡éªŒã€‚<br><span class="hljs-bullet">-</span> @PostFiterï¼š åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åå¯¹æ–¹æ³•çš„è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚<br><span class="hljs-bullet">-</span> @PreAuthorizeï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰è¿›è¡Œæƒé™æ ¡éªŒã€‚<br><span class="hljs-bullet">-</span> @PreFiterï¼šåœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œè¿‡æ»¤ã€‚<br><span class="hljs-bullet">-</span> @Securedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å„ç›¸åº”çš„è§’è‰²ã€‚<br><span class="hljs-bullet">-</span> @DenyAllï¼šæ‹’ç»æ‰€æœ‰è®¿é—®ã€‚<br><span class="hljs-bullet">-</span> @PermitAllï¼šå…è®¸æ‰€æœ‰è®¿é—®ã€‚<br><span class="hljs-bullet">-</span> @RolesAllowedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å¤‡ç›¸åº”çš„è§’è‰²ã€‚<br></code></pre></td></tr></table></figure>

<p>è¿™äº›åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ç›¸å…³çš„æ³¨è§£ï¼Œä¸€èˆ¬æ¥è¯´åªè¦è®¾ç½® <strong><code>prePostEnabled=true</code></strong> å°±å¤Ÿç”¨äº†ã€‚</p>
<h4 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h4><ul>
<li>å¼€å¯æ³¨è§£ä½¿ç”¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨æ³¨è§£</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeMethodController</span> &#123;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) and authentication.name==&#x27;root&#x27;&quot;)</span><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;authentication.name==#name&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/name&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello:&quot;</span> + name;<br>    &#125;<br><br>    <span class="hljs-meta">@PreFilter(value = &quot;filterObject.id%2!=0&quot;,filterTarget = &quot;users&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/users&quot;)</span>  <span class="hljs-comment">//filterTarget å¿…é¡»æ˜¯ æ•°ç»„  é›†åˆ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;User&gt; users)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;users = &quot;</span> + users);<br>    &#125;<br><br>    <span class="hljs-meta">@PostAuthorize(&quot;returnObject.id==1&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/userId&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">&quot;blr&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PostFilter(&quot;filterObject.id%2==0&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/lists&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAll</span><span class="hljs-params">()</span> &#123;<br>        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            users.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(i, <span class="hljs-string">&quot;blr:&quot;</span> + i));<br>        &#125;<br>        <span class="hljs-keyword">return</span> users;<br>    &#125;<br><br>    <span class="hljs-meta">@Secured(&#123;&quot;ROLE_USER&quot;&#125;)</span> <span class="hljs-comment">//åªèƒ½åˆ¤æ–­è§’è‰²</span><br>    <span class="hljs-meta">@GetMapping(&quot;/secured&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">99</span>, <span class="hljs-string">&quot;secured&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Secured(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="hljs-comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªå³å¯</span><br>    <span class="hljs-meta">@GetMapping(&quot;/username&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUsername2</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">99</span>, username);<br>    &#125;<br><br>    <span class="hljs-meta">@PermitAll</span><br>    <span class="hljs-meta">@GetMapping(&quot;/permitAll&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">permitAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;PermitAll&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@DenyAll</span><br>    <span class="hljs-meta">@GetMapping(&quot;/denyAll&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">denyAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;DenyAll&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RolesAllowed(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="hljs-comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªè§’è‰²å³å¯</span><br>    <span class="hljs-meta">@GetMapping(&quot;/rolesAllowed&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">rolesAllowed</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;RolesAllowed&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="åŸç†åˆ†æ-3"><a href="#åŸç†åˆ†æ-3" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="ä¸¤ç§å¤„ç†å™¨"><a href="#ä¸¤ç§å¤„ç†å™¨" class="headerlink" title="ä¸¤ç§å¤„ç†å™¨"></a>ä¸¤ç§å¤„ç†å™¨</h3><p>â€‹	å‰é¢æˆ‘ä»¬è®²äº†,SpringSecurityä¸­æä¾›çš„æƒé™ç®¡ç†åŠŸèƒ½ä¸»è¦æœ‰ä¸¤ç§ç±»å‹: 1.åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†(FilterSecurityInterceptor)ã€2.åŸºäºAOPçš„æƒé™ç®¡ç†(MethodSecurityInterceptor)</p>
<p>â€‹	æ— è®ºæ˜¯å“ªç§,éƒ½æ¶‰åŠåˆ°ä¸€ä¸ªå‰ç½®å¤„ç†å™¨å’Œåç½®å¤„ç†å™¨. ä¸‹å›¾åˆ†åˆ«è¡¨ç¤ºåŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†å’ŒåŸºäºAOPçš„æƒé™ç®¡ç†ä¸­çš„å‰ç½®å¤„ç†å™¨å’Œåç½®å¤„ç†å™¨.</p>
<img src="/2022/01/26/SpringSecurity/image-20230409212440889.png" srcset="/img/loading.gif" lazyload alt="image-20230409212440889" style="zoom:50%;">



<img src="/2022/01/26/SpringSecurity/image-20230409213647550.png" srcset="/img/loading.gif" lazyload alt="image-20230409213647550" style="zoom:50%;">



<p>â€‹	åœ¨åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†ä¸­, è¯·æ±‚é¦–å…ˆä¼šåˆ°è¾¾è¿‡æ»¤å™¨<strong>FilterSecurityInteceptor</strong>, åœ¨å…¶æ‰§è¡Œè¿‡ç¨‹ä¸­, é¦–å…ˆä¼šç”±å‰ç½®å¤„ç†å™¨å»åˆ¤æ–­å½“å‰è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸åº”çš„æƒé™, å¦‚æœå…·å¤‡, åˆ™è¯·æ±‚ç»§ç»­å¾€ä¸‹èµ°, åˆ°è¾¾ç›®æ ‡æ–¹æ³•å¹¶æ‰§è¡Œå®Œæ¯•. åœ¨å“åº”æ—¶, åˆä¼šç»è¿‡<strong>FilterSecurityInteceptor</strong>è¿‡æ»¤å™¨, æ­¤æ—¶ç”±åç½®å¤„ç†å™¨å»å®Œæˆå…¶ä»–æ”¶å°¾å·¥ä½œ. åœ¨åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†, å®é™…ä¸Šå°±æ˜¯æ‹¦æˆªè¯·æ±‚URLåœ°å€, è¿™ç§æƒé™ç®¡ç†æ–¹å¼ç²’åº¦æ¯”è¾ƒç²—, è€Œä¸”è¿‡æ»¤å™¨ä¸­æ‹¿åˆ°çš„æ˜¯å“åº”çš„<strong>HttpServletResponse</strong>å¯¹è±¡, å¯¹å…¶æ‰€è¿”å›çš„æ•°æ®åšäºŒæ¬¡å¤„ç†å¹¶ä¸æ–¹ä¾¿.</p>
<p>â€‹	åœ¨åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸­, ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ä¼šè¢«<strong>MethodSecurityInterceptor</strong>æ‹¦æˆªä¸‹æ¥, å®ç°åŸç†å½“ç„¶å°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„AOPæœºåˆ¶, å½“ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨è¢«<strong>MethodSecurityInterceptor</strong>æ‹¦æˆªä¸‹ä¹‹å, åœ¨å…¶invokeæ–¹æ³•ä¸­é¦–å…ˆä¼šç”±å‰ç½®å¤„ç†å™¨å»åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡è°ƒç”¨ç›®æ ‡æ–¹æ³•æ‰€éœ€è¦çš„æƒé™, å¦‚æœå…·å¤‡, åˆ™ç»§ç»­æ‰§è¡Œç›®æ ‡æ–¹æ³•. å½“ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæ¯•å¹¶ç»™å‡ºè¿”å›ç»“æœä¹‹å, åœ¨<strong>MethodSecurityInterceptor#invoke</strong>æ–¹æ³•ä¸­, ç”±åç½®å¤„ç†å™¨å†å»å¯¹ç›®æ ‡æ–¹æ³•çš„è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤æˆ–è€…é‰´æƒ, ç„¶ååœ¨invokeæ–¹æ³•ä¸­å°†å¤„ç†åçš„ç»“æœè¿”å›</p>
<p>â€‹	å¯ä»¥çœ‹åˆ°, æ— è®ºæ˜¯åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†è¿˜æ˜¯åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç† ,å‰ç½®å¤„ç†å™¨éƒ½æ˜¯é‡ä¸­ä¹‹é‡, ä¸¤è€…éƒ½ä¼šç”¨åˆ°. è€Œåç½®å¤„ç†å™¨åˆ™åªæ˜¯åœ¨åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸­ä¼šç”¨åˆ°.</p>
<h4 id="å‰ç½®å¤„ç†å™¨"><a href="#å‰ç½®å¤„ç†å™¨" class="headerlink" title="å‰ç½®å¤„ç†å™¨"></a>å‰ç½®å¤„ç†å™¨</h4><p>â€‹	è¦ç†è§£å‰ç½®å¤„ç†å™¨, é¦–å…ˆéœ€è¦äº†è§£æŠ•ç¥¨å™¨.</p>
<blockquote>
<p>æŠ•ç¥¨å™¨</p>
</blockquote>
<p>â€‹	æŠ•ç¥¨å™¨æ˜¯SpringSecurityæƒé™ç®¡ç†åŠŸèƒ½ä¸­çš„ä¸€ä¸ªç»„ä»¶, é¡¾åæ€ä¹‰, æŠ•ç¥¨å™¨çš„ä½œç”¨å°±æ˜¯é’ˆå¯¹æ˜¯å¦å…è®¸æŸä¸ªæ“ä½œè¿›è¡ŒæŠ•ç¥¨. å½“è¯·æ±‚çš„URLåœ°å€è¢«æ‹¦æˆªä¸‹æ¥ä¹‹å, æˆ–è€…å½“è¢«è°ƒç”¨çš„æ–¹æ³•è¢«AOPæ‹¦æˆªä¸‹æ¥ä¹‹å, éƒ½ä¼šè°ƒç”¨æŠ•ç¥¨å™¨å¯¹å½“å‰æ“ä½œè¿›è¡ŒæŠ•ç¥¨, ä»¥ä¾¿å†³å®šæ˜¯å¦å…è®¸å½“å‰æ“ä½œ</p>
<p>â€‹	åœ¨Spring Securityä¸­, æŠ•ç¥¨å™¨ç”±AccessDecisionVoteræ¥å®šä¹‰, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccessDecisionVoter</span>&lt;S&gt; &#123;<br><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ACCESS_GRANTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> <span class="hljs-variable">ACCESS_ABSTAIN</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> <span class="hljs-variable">ACCESS_DENIED</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(ConfigAttribute attribute)</span>;<br><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span>;<br><br>	<span class="hljs-type">int</span> <span class="hljs-title function_">vote</span><span class="hljs-params">(Authentication authentication, S object,</span><br><span class="hljs-params">			Collection&lt;ConfigAttribute&gt; attributes)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>è¿™ä¸ªæ¥å£é¦–å…ˆå®šä¹‰äº†ä¸‰ä¸ªå¸¸é‡: <strong>ACCESS_GRANTED</strong>è¡¨ç¤ºæŠ•ç¥¨é€šè¿‡ã€<strong>ACESS_ABSTAIN</strong>è¡¨ç¤ºå¼ƒæƒã€<strong>ACCESS_DENIED</strong>è¡¨ç¤ºæ‹’ç»</li>
<li><strong>supports(ConfigAttribute)<strong>æ–¹æ³•: ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒå¤„ç†</strong>ConfigAttribute</strong>å¯¹è±¡</li>
<li>**supports(Class)**æ–¹æ³•: ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒå¤„ç†å—ä¿æŠ¤çš„å®‰å…¨å¯¹è±¡.</li>
<li><strong>vote</strong>æ–¹æ³•: åˆ™æ˜¯å…·ä½“çš„æŠ•ç¥¨æ–¹æ³•, æ ¹æ®ç”¨æˆ·æ‰€å…·å¤‡çš„æƒé™ä»¥åŠå½“å‰è¯·æ±‚éœ€è¦çš„æƒé™è¿›è¡ŒæŠ•ç¥¨. <strong>vote</strong>æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°: ç¬¬ä¸€ä¸ªå‚æ•°<strong>authentication</strong>è¿™å¯ä»¥æå–å‡ºæ¥å½“å‰ç”¨æˆ·æ‰€å…·å¤‡çš„æƒé™. ç¬¬äºŒä¸ªå‚æ•°objectè¡¨ç¤ºå—ä¿æŠ¤çš„å®‰å…¨å¯¹è±¡, å¦‚æœå—ä¿æŠ¤çš„æ˜¯URLåœ°å€, åˆ™objectå°±æ˜¯ä¸€ä¸ª<strong>MethodInvocation</strong>å¯¹è±¡. ç¬¬ä¸‰ä¸ªå‚æ•°<strong>attributes</strong>è¡¨ç¤ºè®¿é—®å—ä¿æŠ¤å¯¹è±¡æ‰€éœ€è¦çš„æƒé™. <strong>vote</strong>æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯å‰é¢æ‰€å®šä¹‰çš„ä¸‰ä¸ªå¸¸é‡ä¹‹ä¸€.</li>
</ul>
<p>â€‹	SpringSecurityä¸­ä¸º<strong>AccessDecisionVoter</strong>æä¾›äº†è¯¸å¤šä¸åŒçš„å®ç°ç±», å¦‚å›¾æ‰€ç¤º, æ˜¯<strong>AccessDecisionVoter</strong>çš„æ‰€æœ‰ç»§æ‰¿ç±»:</p>
<img src="/2022/01/26/SpringSecurity/image-20230409220927740.png" srcset="/img/loading.gif" lazyload alt="image-20230409220927740" style="zoom:50%;">

<ul>
<li><strong>RoleVoter</strong>: <strong>RoleVoter</strong>æ˜¯æ ¹æ®ç™»å½•ä¸»ä½“çš„è§’è‰²è¿›è¡ŒæŠ•ç¥¨, å³åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡å—ä¿æŠ¤å¯¹è±¡æ‰€éœ€è¦çš„è§’è‰². éœ€è¦æ³¨æ„çš„æ˜¯, é»˜è®¤æƒ…å†µä¸‹è§’è‰²éœ€è¦ä»¥â€œROLE_â€å¼€å§‹, å¦åˆ™supportsæ–¹æ³•ç›´æ¥è¿”å›false, ä¸è¿›è¡Œåç»­çš„æŠ•ç¥¨æ“ä½œ.</li>
<li><strong>RoleHierarchyVoter</strong>: <strong>RoleHierarchyVoter</strong>ç»§æ‰¿è‡ª<strong>RoleVoter</strong>, æŠ•ç¥¨çš„é€»è¾‘å’Œ<strong>RoleVoter</strong>ä¸€è‡´, ä¸åŒçš„æ˜¯<strong>RoleHierarchyVoter</strong>æ”¯æŒè§’è‰²çš„åŸºç¡€, å®ƒæ˜¯é€šè¿‡<strong>RoleHierarchyImpl</strong>å¯¹è±¡å¯¹ç”¨æˆ·æ‰€å…·å¤‡çš„è§’è‰²è¿›è¡Œè§£æ, è·å–ç”¨æˆ·çœŸæ­£â€œå¯è§¦è¾¾â€çš„è§’è‰²; è€Œ<strong>RoleVoter</strong>åˆ™æ˜¯ç›´æ¥è°ƒç”¨**authentication.getAuthorities()**æ–¹æ³•è¿›è¡Œè·å–ç”¨æˆ·çš„è§’è‰².</li>
<li><strong>WebExpressionVoter</strong>: åŸºäºURLåœ°å€è¿›è¡Œæƒé™æ§åˆ¶æ—¶çš„æŠ•ç¥¨å™¨(æ”¯æŒSpEL)</li>
<li><strong>Jsr250Voter</strong>: å¤„ç†JSR-250æƒé™æ³¨è§£çš„æŠ•ç¥¨å™¨, å¦‚@PermitAllã€@DenyAllç­‰.</li>
<li><strong>AuthenticatedVoter</strong>: <strong>AuthenticatedVoter</strong>ç”¨æ¥åˆ¤æ–­å½“å‰ç”¨æˆ·çš„è®¤è¯å½¢å¼, å®ƒæœ‰ä¸‰ç§å–å€¼: <strong>IS_AUTHENTICATED_FULLY</strong>ã€<strong>IS_AUTHENTICATED_REMEMBERED</strong> ä»¥åŠ<strong>IS_AUTHENTICATED_ANONYMOUSLY</strong>. å…¶ä¸­: <strong>IS_AUTHENTICATED_FULLY</strong>è¦æ±‚å½“å‰ç”¨æˆ·æ—¢ä¸æ˜¯åŒ¿åç”¨æˆ·ä¹Ÿä¸æ˜¯é€šè¿‡<strong>RememberMe</strong>è¿›è¡Œè®¤è¯; <strong>IS_AUTHENTICATED_ANONYMOUSLY</strong>åˆ™å…è®¸å½“å‰ç”¨æˆ·é€šè¿‡<strong>RememberMe</strong>è®¤è¯, ä¹Ÿå…è®¸å½“å‰ç”¨æˆ·æ˜¯åŒ¿åç”¨æˆ·.</li>
<li><strong>AbstractAclVoter</strong>: åŸºäºACLè¿›è¡Œæƒé™æ§åˆ¶æ—¶çš„æŠ•ç¥¨å™¨. è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±», æ²¡æœ‰ç»‘å®šåˆ°å…·ä½“çš„ACLç³»ç»Ÿ</li>
<li><strong>PreInvocationAuthorizationAdviceVoter</strong>: å¤„ç†**@PreFilter<strong>å’Œ</strong>@PreAuthorize**æ³¨è§£çš„æŠ•ç¥¨å™¨.</li>
</ul>
<p>â€‹	è¿™å°±æ˜¯SpringSecurityä¸­æä¾›çš„æ‰€æœ‰æŠ•ç¥¨å™¨, åœ¨å…·ä½“ä½¿ç”¨ä¸­, å¯ä»¥å•ç‹¬ä½¿ç”¨ä¸€ä¸ª, ä¹Ÿå¯ä»¥å¤šä¸ªä¸€èµ·ä½¿ç”¨. å¦‚æœä¸Šé¢è¿™äº›æŠ•ç¥¨å™¨éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚, å¼€å‘è€…ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æŠ•ç¥¨å™¨, éœ€è¦æ³¨æ„çš„æ˜¯, æŠ•ç¥¨ç»“æœå¹¶éæœ€ç»ˆç»“æœ(é€šè¿‡æˆ–æ‹’ç»), æœ€ç»ˆç»“æœè¿˜è¦çœ‹å†³ç­–å™¨(<strong>AccessDecisionManager</strong>)</p>
<blockquote>
<p>å†³ç­–å™¨</p>
</blockquote>
<p>â€‹	å†³ç­–å™¨ç”±<strong>AccessDecisionManager</strong>è´Ÿè´£, <strong>AccessDecisionManager</strong>ä¼šåŒæ—¶ç®¡ç†å¤šä¸ªæŠ•ç¥¨å™¨, ç”±<strong>AccessDecisionManager</strong>è°ƒç”¨æŠ•ç¥¨å™¨è¿›è¡ŒæŠ•ç¥¨, ç„¶åæ ¹æ®æŠ•ç¥¨ç»“æœåšå‡ºç›¸åº”çš„å†³ç­–, æ‰€ä»¥æˆ‘ä»¬å°†<strong>AccessDecisionManager</strong>ä¹Ÿç§°ä¸ºæ˜¯ä¸€ä¸ªå†³ç­–ç®¡ç†å™¨. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccessDecisionManager</span> &#123;<br><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">decide</span><span class="hljs-params">(Authentication authentication, Object object,</span><br><span class="hljs-params">			Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="hljs-keyword">throws</span> AccessDeniedException,<br>			InsufficientAuthenticationException;<br><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(ConfigAttribute attribute)</span>;<br><br>	<br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™é‡Œä¸€å…±æœ‰ä¸‰ä¸ªæ–¹æ³•:</p>
<ul>
<li><strong>decide</strong>æ–¹æ³•: æ˜¯æ ¸å¿ƒçš„å†³ç­–æ–¹æ³•, åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆ¤æ–­æ˜¯å¦å…è®¸å½“å‰URLæˆ–è€…æ–¹æ³•çš„è°ƒç”¨, å¦‚æœä¸å…è®¸, åˆ™ä¼šæŠ›å‡º<strong>AccessDeniedException</strong>å¼‚å¸¸</li>
<li><strong>supports(ConfigAttribute)<strong>æ–¹æ³•: ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒå¤„ç†</strong>ConfigAttribute</strong>å¯¹è±¡</li>
<li>**supports(Class)**æ–¹æ³•: ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒå½“å‰å®‰å…¨å¯¹è±¡.</li>
</ul>
<p>â€‹	æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®˜æ–¹æä¾›çš„ç±»å›¾:</p>
<img src="/2022/01/26/SpringSecurity/image-20230409224527191.png" srcset="/img/loading.gif" lazyload alt="image-20230409224527191" style="zoom:50%;">

<p>â€‹	ä»å›¾ä¸­å¯ä»¥çœ‹å‡º, <strong>AccessDecisionManager</strong>æœ‰ä¸€ä¸ªå®ç°ç±»<strong>AbstractAccessDecisonManager</strong>, ä¸€ä¸ª<strong>AbstractAccessDecisionManger</strong>å¯¹åº”å¤šä¸ªæŠ•ç¥¨å™¨. å¤šä¸ªæŠ•ç¥¨å™¨é’ˆå¯¹åŒä¸ªè¯·æ±‚å¯èƒ½æ˜¯ä¼šç»™å‡ºä¸åŒçš„ç»“æœ, é‚£ä¹ˆå¬è°çš„å‘¢? è¿™å°±è¦çœ‹å†³ç­–å™¨äº†.</p>
<ul>
<li><strong>AffirmativeBased</strong>: ä¸€ç¥¨é€šè¿‡æœºåˆ¶, å³åªè¦æœ‰ä¸€ä¸ªæŠ•ç¥¨å™¨é€šè¿‡å°±å¯ä»¥è®¿é—®(é»˜è®¤å¦‚æ­¤)</li>
<li><strong>UnanimousBased</strong>: ä¸€ç¥¨å¦å†³æœºåˆ¶, å³åªè¦æœ‰ä¸€ä¸ªæŠ•ç¥¨å™¨åå¯¹å°±ä¸å¯ä»¥è®¿é—®</li>
<li><strong>ConsensusBased</strong>: å°‘æ•°æœä»å¤šæ•°æœºåˆ¶. å¦‚æœæ˜¯å¹³å±€å¹¶ä¸”è‡³å°‘æœ‰ä¸€å¼ èµåŒç¥¨, åˆ™æ ¹æ®<strong>allowIfEqualGrantedDeniedDecisions</strong>å‚æ•°çš„å–å€¼æ¥å†³å®š, å¦‚æœè¯¥å‚æ•°å–å€¼ä¸ºtrue, åˆ™å¯ä»¥è®¿é—®, å¦åˆ™ä¸å¯ä»¥è®¿é—®.</li>
</ul>
<p>â€‹	è¿™æ˜¯SpringSecurityä¸­æä¾›çš„ä¸‰ä¸ªå†³ç­–å™¨, å¦‚æœè¿™ä¸‰ä¸ªå†³ç­–å™¨æ— æ³•æ»¡è¶³éœ€æ±‚, å¼€å‘è€…ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»ç»§æ‰¿è‡ª<strong>AbstractAccessDecisionManager</strong>å®ç°è‡ªå·±çš„å†³ç­–å™¨.</p>
<p>â€‹	è¿™å°±æ˜¯å‰ç½®å¤„ç†å™¨çš„å¤§è‡´é€»è¾‘, æ— è®ºæ˜¯åŸºäºURLåœ°å€çš„æƒé™ç®¡ç†, è¿˜æ˜¯åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†, éƒ½æ˜¯åœ¨å‰ç½®å¤„ç†å™¨ä¸­é€šè¿‡<strong>AccessDecisionManager</strong>è°ƒç”¨<strong>AccessDecisionVoter</strong>è¿›è¡ŒæŠ•ç¥¨, è¿›è€Œåšå‡ºç›¸åº”çš„ç­–ç•¥</p>
<h2 id="å®æˆ˜-1"><a href="#å®æˆ˜-1" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ URL æ‹¦æˆªè§„åˆ™å’Œè¯·æ±‚ URL æ‰€éœ€è¦çš„æƒé™éƒ½æ˜¯é€šè¿‡ä»£ç æ¥é…ç½®çš„ï¼Œè¿™æ ·å°±æ¯”è¾ƒæ­»æ¿ï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è®¿é—®æŸä¸€ä¸ª URL æ‰€éœ€è¦çš„æƒé™ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚</p>
<p>åŠ¨æ€ç®¡ç†æƒé™è§„åˆ™å°±æ˜¯æˆ‘ä»¬å°† URL æ‹¦æˆªè§„åˆ™å’Œè®¿é—® URI æ‰€éœ€è¦çš„æƒé™éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè¿™æ ·ï¼Œåœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå°±å¯ä»¥å¯¹æƒé™è¿›è¡Œè°ƒæ•´ã€‚</p>
<p><code>ç”¨æˆ·&lt;--ä¸­é—´è¡¨--&gt; è§’è‰² &lt;--ä¸­é—´è¡¨--&gt; èœå•</code></p>
<h3 id="åº“è¡¨è®¾è®¡"><a href="#åº“è¡¨è®¾è®¡" class="headerlink" title="åº“è¡¨è®¾è®¡"></a>åº“è¡¨è®¾è®¡</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for menu</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `menu`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `menu` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `<span class="hljs-keyword">pattern</span>` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of menu</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;/admin/**&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;/user/**&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;/guest/**&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for menu_role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `menu_role`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `menu_role` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `mid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `mid` (`mid`),<br>  KEY `rid` (`rid`),<br>  <span class="hljs-keyword">CONSTRAINT</span> `menu_role_ibfk_1` <span class="hljs-keyword">FOREIGN</span> KEY (`mid`) <span class="hljs-keyword">REFERENCES</span> `menu` (`id`),<br>  <span class="hljs-keyword">CONSTRAINT</span> `menu_role_ibfk_2` <span class="hljs-keyword">FOREIGN</span> KEY (`rid`) <span class="hljs-keyword">REFERENCES</span> `role` (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of menu_role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `role`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `role` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `nameZh` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ROLE_ADMIN&#x27;</span>, <span class="hljs-string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;ROLE_USER&#x27;</span>, <span class="hljs-string">&#x27;æ™®é€šç”¨æˆ·&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;ROLE_GUEST&#x27;</span>, <span class="hljs-string">&#x27;æ¸¸å®¢&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `enabled` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `locked` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;blr&#x27;</span>, <span class="hljs-string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for user_role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `user_role`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `user_role` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `uid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `uid` (`uid`),<br>  KEY `rid` (`rid`),<br>  <span class="hljs-keyword">CONSTRAINT</span> `user_role_ibfk_1` <span class="hljs-keyword">FOREIGN</span> KEY (`uid`) <span class="hljs-keyword">REFERENCES</span> `<span class="hljs-keyword">user</span>` (`id`),<br>  <span class="hljs-keyword">CONSTRAINT</span> `user_role_ibfk_2` <span class="hljs-keyword">FOREIGN</span> KEY (`rid`) <span class="hljs-keyword">REFERENCES</span> `role` (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of user_role</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<h3 id="åˆ›å»º-springboot-åº”ç”¨"><a href="#åˆ›å»º-springboot-åº”ç”¨" class="headerlink" title="åˆ›å»º springboot åº”ç”¨"></a>åˆ›å»º springboot åº”ç”¨</h3><ul>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®é…ç½®æ–‡ä»¶</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">server.port</span>=<span class="hljs-string">8080</span><br><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:com/blr/mapper/*.xml</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.blr.entity</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºå®ä½“ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> locked;<br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        <span class="hljs-keyword">return</span> roles.stream().map(r -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(r.getName())).collect(Collectors.toList());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> !locked;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> enabled;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> enabled)</span> &#123;<br>        <span class="hljs-built_in">this</span>.enabled = enabled;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLocked</span><span class="hljs-params">(<span class="hljs-type">boolean</span> locked)</span> &#123;<br>        <span class="hljs-built_in">this</span>.locked = locked;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRoles</span><span class="hljs-params">(List&lt;Role&gt; roles)</span> &#123;<br>        <span class="hljs-built_in">this</span>.roles = roles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Role&gt; <span class="hljs-title function_">getRoles</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> roles;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String nameZh;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNameZh</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> nameZh;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNameZh</span><span class="hljs-params">(String nameZh)</span> &#123;<br>        <span class="hljs-built_in">this</span>.nameZh = nameZh;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Menu</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String pattern;<br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles;<br><br>    <span class="hljs-keyword">public</span> List&lt;Role&gt; <span class="hljs-title function_">getRoles</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> roles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRoles</span><span class="hljs-params">(List&lt;Role&gt; roles)</span> &#123;<br>        <span class="hljs-built_in">this</span>.roles = roles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPattern</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> pattern;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPattern</span><span class="hljs-params">(String pattern)</span> &#123;<br>        <span class="hljs-built_in">this</span>.pattern = pattern;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º mapper æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br>    List&lt;Role&gt; <span class="hljs-title function_">getUserRoleByUid</span><span class="hljs-params">(Integer uid)</span>;<br>    User <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MenuMapper</span> &#123;<br>    List&lt;Menu&gt; <span class="hljs-title function_">getAllMenu</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º mapper æ–‡ä»¶</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.blr.mapper.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loadUserByUsername&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.blr.entity.User&quot;</span>&gt;</span><br>        select *<br>        from user<br>        where username = #&#123;username&#125;;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getUserRoleByUid&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.blr.entity.Role&quot;</span>&gt;</span><br>        select r.*<br>        from role r,<br>             user_role ur<br>        where ur.uid = #&#123;uid&#125;<br>          and ur.rid = r.id<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.blr.mapper.MenuMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;MenuResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.blr.entity.Menu&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;pattern&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;pattern&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;roles&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;com.blr.entity.Role&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;rid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;rname&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;name&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;rnameZh&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;nameZh&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getAllMenu&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;MenuResultMap&quot;</span>&gt;</span><br>        select m.*, r.id as rid, r.name as rname, r.nameZh as rnameZh<br>        from menu m<br>                 left join menu_role mr on m.`id` = mr.`mid`<br>                 left join role r on r.`id` = mr.`rid`<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º service æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserMapper userMapper)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userMapper = userMapper;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.loadUserByUsername(username);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>);<br>        &#125;<br>        user.setRoles(userMapper.getUserRoleByUid(user.getId()));<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MenuMapper menuMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MenuService</span><span class="hljs-params">(MenuMapper menuMapper)</span> &#123;<br>        <span class="hljs-built_in">this</span>.menuMapper = menuMapper;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Menu&gt; <span class="hljs-title function_">getAllMenu</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> menuMapper.getAllMenu();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºæµ‹è¯• controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/admin/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">admin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello admin&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">user</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello user&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/guest/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">guest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello guest&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º CustomSecurityMetadataSource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomSecurityMetadataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FilterInvocationSecurityMetadataSource</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MenuService menuService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomSecurityMetadataSource</span><span class="hljs-params">(MenuService menuService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.menuService = menuService;<br>    &#125;<br><br>    <span class="hljs-type">AntPathMatcher</span> <span class="hljs-variable">antPathMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="hljs-title function_">getAttributes</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestURI</span> <span class="hljs-operator">=</span> ((FilterInvocation) object).getRequest().getRequestURI();<br>        List&lt;Menu&gt; allMenu = menuService.getAllMenu();<br>        <span class="hljs-keyword">for</span> (Menu menu : allMenu) &#123;<br>            <span class="hljs-keyword">if</span> (antPathMatcher.match(menu.getPattern(), requestURI)) &#123;<br>                String[] roles = menu.getRoles().stream().map(r -&gt; r.getName()).toArray(String[]::<span class="hljs-keyword">new</span>);<br>                <span class="hljs-keyword">return</span> SecurityConfig.createList(roles);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="hljs-title function_">getAllConfigAttributes</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>        <span class="hljs-keyword">return</span> FilterInvocation.class.isAssignableFrom(clazz);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>é…ç½® Security é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CustomSecurityMetadataSource customSecurityMetadataSource;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(CustomSecurityMetadataSource customSecurityMetadataSource, UserService userService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.customSecurityMetadataSource = customSecurityMetadataSource;<br>        <span class="hljs-built_in">this</span>.userService = userService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userService);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> http.getSharedObject(ApplicationContext.class);<br>        http.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlAuthorizationConfigurer</span>&lt;&gt;(applicationContext))<br>                .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FilterSecurityInterceptor</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> &#123;<br>                        object.setSecurityMetadataSource(customSecurityMetadataSource);<br>                        <span class="hljs-comment">//æ˜¯å¦æ‹’ç»å…¬å…±èµ„æº</span><br>                        object.setRejectPublicInvocations(<span class="hljs-literal">false</span>);<br>                        <span class="hljs-keyword">return</span> object;<br>                    &#125;<br>                &#125;);<br>        http.formLogin()<br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨å…¥å£ç±»è¿›è¡Œæµ‹è¯•</p>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AE%A4%E8%AF%81%E9%89%B4%E6%9D%83/" class="category-chain-item">è®¤è¯é‰´æƒ</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/SpringSecurity/" class="print-no-link">#SpringSecurity</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringSecurity</div>
      <div>http://example.com/2022/01/26/SpringSecurity/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>gaozhe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´1æœˆ26æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/06/16/MySQL45%E8%AE%B2/" title="MySql45è®²">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MySql45è®²</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
