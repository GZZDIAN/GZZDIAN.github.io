<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="false" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>SpringSecurity | gzzear&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="SpringSecurity 实战第一章 大体框架 权限管理 SpringSecurity 简介 整体架构  权限管理基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。 权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity">
<meta property="og:url" content="http://example.com/2022/01/26/SpringSecurity/index.html">
<meta property="og:site_name" content="gzzear&#39;s blog">
<meta property="og:description" content="SpringSecurity 实战第一章 大体框架 权限管理 SpringSecurity 简介 整体架构  权限管理基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。 权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110112541559.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110104531129.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110103518334.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110104815645.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110110946267.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110111011018.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110111037603.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113408799.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113534290.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110113757100.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114044889.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114109713.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114258671.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110114227714.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110120349053.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110115946010.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111211538604.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111211436764.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112095052138.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112095638356.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111100643506.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230716151856457.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230716152418188.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230712144937006.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230214222306844.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230214222758742.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111110043474.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220111111244739.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150612023.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150820284.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220112150929998.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113050533209-2023951.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113054514897-2023963.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062644363-2026405.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113060257662.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062114741.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113062617937-2026380.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113114133687.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113115956334.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113125407538-2049649.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113124141492.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220113124639102.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212213216653.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212215627835.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220211491.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220651187.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212220803330.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212221126723.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230212221335962.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060526805.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061756972.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060824066.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061343516.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220114163045543.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215224147534.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215230305042.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215232503921.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215233159036.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215233755090.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215234327892.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230215234757406.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230216000810983.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230216095646474.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230216105112662.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230312213646207.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230312220109915.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230313214804744.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230313215553853.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230322160333317.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323165755959.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323172948891.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230323174059920.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220127162622771.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220127162759461.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308185102746.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308190409305.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317194843649.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308191736005.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317195930708.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317200522015.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220317201055784.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220318142054096.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230121004712057.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308192413735.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220319124115432.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220319104657210.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220224142025628.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184455083.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184605516.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814184651238.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20200814185157418.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220308195448860.png">
<meta property="og:image" content="http://example.com/https%20:/bank.xxx.com/withdraw">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418191456109.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418193519717.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220418194059737.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220521074711128.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230402223226568.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220430213210778.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230402223444247-0446086.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220430213344621.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220523110143445.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220523153200373.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409212440889.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409213647550.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409220927740.png">
<meta property="og:image" content="http://example.com/2022/01/26/SpringSecurity/image-20230409224527191.png">
<meta property="article:published_time" content="2022-01-26T03:53:15.000Z">
<meta property="article:modified_time" content="2023-07-16T09:28:23.882Z">
<meta property="article:author" content="gaozhe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/01/26/SpringSecurity/image-20220110112541559.png">
  
    <link rel="alternate" href="/atom.xml" title="gzzear's blog" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>gzzear's blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">高喆 </div>
      <div class="dot"></div>
      <div class="subtitle">私人博客记录学习文档 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://store.steampowered.com" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      



    
      

    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Archives</h3>
      
      
        <a class="archive-link" href="/archives/2023/07 ">
          July 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/06 ">
          June 2022 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/01 ">
          January 2022 
          <div class="archive-count">1 </div>
        </a>
      
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <li>
            <a href="/2023/07/02/Mysql%E9%AB%98%E7%BA%A7/">Mysql高级</a>
          </li>
        
          <li>
            <a href="/2022/06/16/MySQL45%E8%AE%B2/">MySql45讲</a>
          </li>
        
          <li>
            <a href="/2022/01/26/SpringSecurity/">SpringSecurity</a>
          </li>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-SpringSecurity" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        SpringSecurity
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2022-01-26T03:53:15.000Z" itemprop="datePublished">2022-01-26</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            50k words 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="SpringSecurity-实战"><a href="#SpringSecurity-实战" class="headerlink" title="SpringSecurity 实战"></a>SpringSecurity 实战</h1><h1 id="第一章-大体框架"><a href="#第一章-大体框架" class="headerlink" title="第一章 大体框架"></a>第一章 大体框架</h1><ul>
<li>权限管理</li>
<li>SpringSecurity 简介</li>
<li>整体架构</li>
</ul>
<h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2><p>基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现<code>对用户访问系统的控制</code>，按照<code>安全规则</code>或者<code>安全策略</code>控制用户<code>可以访问而且只能访问自己被授权的资源</code>。</p>
<p>权限管理包括用户<strong>身份认证</strong>和<strong>授权</strong>两部分，简称<strong>认证授权</strong>。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。</p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>**<code>身份认证</code>**，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用<a target="_blank" rel="noopener" href="http://baike.baidu.com/view/5628.htm">指纹</a>等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。</p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>**<code>授权</code>**，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>和其他领域不同，在 Java 企业级开发中，安全管理框架非常少，目前比较常见的就是：</p>
<ul>
<li>Shiro<ul>
<li>Shiro 本身是一个老牌的安全管理框架，有着众多的优点，例如轻量、简单、易于集成、可以在JavaSE环境中使用等。不过，在微服务时代，Shiro 就显得力不从心了，在微服务面前和扩展方面，无法充分展示自己的优势。</li>
</ul>
</li>
<li>开发者自定义<ul>
<li>也有很多公司选择自定义权限，即自己开发权限管理。但是一个系统的安全，不仅仅是登录和权限控制这么简单，我们还要考虑种各样可能存在的网络政击以及防彻策略，从这个角度来说，开发者白己实现安全管理也并非是一件容易的事情，只有大公司才有足够的人力物力去支持这件事情。</li>
</ul>
</li>
<li>Spring Security<ul>
<li>Spring Security,作为spring 家族的一员，在和 Spring 家族的其他成员如 Spring Boot Spring Clond等进行整合时，具有其他框架无可比拟的优势，同时对 OAuth2 有着良好的支持，再加上Spring Cloud对 Spring Security的不断加持（如推出 Spring Cloud Security )，让 Spring Securiy 不知不觉中成为微服务项目的首选安全管理方案。</li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="官方定义"><a href="#官方定义" class="headerlink" title="官方定义"></a>官方定义</h3><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li>
</ul>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
<p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
<p>Spring Security是一个功能强大、可高度定制的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实标准。</p>
<p>Spring Security是一个面向Java应用程序提供身份验证和安全性的框架。与所有Spring项目一样，Spring Security的真正威力在于它可以轻松地扩展以满足定制需求。</p>
<ul>
<li>总结</li>
</ul>
<blockquote>
<p>Spring Security是一个功能强大、可高度定制的<code>身份验证</code>和<code>访问控制</code>的框架。或者说用来实现系统中权限管理的框架。</p>
</blockquote>
<h3 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h3><p>Spring Security 最早叫 Acegi Security， 这个名称并不是说它和 Spring 就没有关系，它依然是为Spring 框架提供安全支持的。Acegi Security 基于 Spring，可以帮助我们为项目建立丰富的角色与权限管理系统。Acegi security 虽然好用，但是最为人诟病的则是它臃肿烦琐的配置这一问题最终也遗传给了 Spring Security。</p>
<p>​	Acegi Security 最终被并入 Spring Security 项目中，并于 2008 年4月发布了改名后的第一个版本 Spring Security 2.0.0，到目前为止，Spring Security 的最新版本己经到了 5.6.1。和 Shiro 相比，Spring Security重量级并且配置烦琐，直至今天，依然有人以此为理由而拒绝了解 Spring Security。其实，自从 Spring Boot 推出后，就彻底颠覆了传统了 JavaEE 开发，自动化配置让许多事情变得非常容易，包括 Spring Security 的配置。在一个 Spring Boot 项目中，我们甚至只需要引入一个依赖，不需要任何额外配置，项目的所有接口就会被自动保护起来了。在 Spring Cloud中，很多涉及安全管理的问题，也是一个 Spring Security 依赖两行配置就能搞定，在和 Spring 家族的产品一起使用时，Spring Security 的优势就非常明显了。</p>
<p>​	因此，在微服务时代，我们不需要纠结要不要学习 Spring Security，我们要考虑的是如何快速掌握Spring Security， 并且能够使用 Spring Security 实现我们微服务的安全管理。</p>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>在<Spring security>的架构设计中，**<code>认证</code><strong><Authentication>和</Authentication></strong><code>授权</code>** <Authorization>是分开的，无论使用什么样的认证方式。都不会影响授权，这是两个独立的存在，这种独立带来的好处之一，就是可以非常方便地整合一些外部的解决方案。</Authorization></Spring></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110112541559.png" alt="image-20220110112541559"></p>
<h3 id="认证-1"><a href="#认证-1" class="headerlink" title="认证"></a>认证</h3><h4 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h4><p>在Spring Security中认证是由<code>AuthenticationManager</code>接口来负责的，接口定义为：</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110104531129.png" alt="image-20220110104531129"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationManager</span> &#123; </span><br><span class="line">	Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> </span><br><span class="line">  														<span class="keyword">throws</span> AuthenticationException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>返回 Authentication 表示认证成功</li>
<li>返回 AuthenticationException 异常，表示认证失败。</li>
</ul>
<p>AuthenticationManager 主要实现类为 ProviderManager，在 ProviderManager 中管理了众多 AuthenticationProvider 实例。在一次完整的认证流程中，Spring Security 允许存在多个 AuthenticationProvider ，用来实现多种认证方式，这些 AuthenticationProvider 都是由 ProviderManager 进行统一管理的。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110103518334.png" alt="image-20220110103518334"></p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>认证以及认证成功的信息主要是由 Authentication 的实现类进行保存的，其接口定义为：</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110104815645.png" alt="image-20220110104815645"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Authentication</span> <span class="keyword">extends</span> <span class="title class_">Principal</span>, Serializable &#123;</span><br><span class="line">	Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line">	Object <span class="title function_">getCredentials</span><span class="params">()</span>;</span><br><span class="line">	Object <span class="title function_">getDetails</span><span class="params">()</span>;</span><br><span class="line">	Object <span class="title function_">getPrincipal</span><span class="params">()</span>;</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>getAuthorities 	 获取用户权限信息</li>
<li>getCredentials 	获取用户凭证信息，一般指密码</li>
<li>getDetails 			 获取用户详细信息</li>
<li>getPrincipal 		 获取用户身份信息，用户名、用户对象等</li>
<li>isAuthenticated   用户是否认证成功</li>
</ul>
<h4 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>SecurityContextHolder 用来获取登录之后用户信息。Spring Security 会将登录用户数据保存在 Session 中。但是，为了使用方便,Spring Security在此基础上还做了一些改进，其中最主要的一个变化就是线程绑定。当用户登录成功后,Spring Security 会将登录成功的用户信息保存到 SecurityContextHolder 中。SecurityContextHolder 中的数据保存默认是通过ThreadLocal 来实现的，使用 ThreadLocal 创建的变量只能被当前线程访问，不能被其他线程访问和修改，也就是用户数据和请求线程绑定在一起。当登录请求处理完毕后，Spring Security 会将 SecurityContextHolder 中的数据拿出来保存到 Session 中，同时将 SecurityContexHolder 中的数据清空。以后每当有请求到来时，Spring Security 就会先从 Session 中取出用户登录数据，保存到 SecurityContextHolder 中，方便在该请求的后续处理过程中使用，同时在请求结束时将 SecurityContextHolder 中的数据拿出来保存到 Session 中，然后将 Security SecurityContextHolder 中的数据清空。这一策略非常方便用户在 Controller、Service 层以及任何代码中获取当前登录用户数据。</p>
<h3 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h3><p>当完成认证后，接下来就是授权了。在 Spring Security 的授权体系中，有两个关键接口，</p>
<h4 id="AccessDecisionManager"><a href="#AccessDecisionManager" class="headerlink" title="AccessDecisionManager"></a>AccessDecisionManager</h4><blockquote>
<p> AccessDecisionManager (访问决策管理器)，用来决定此次访问是否被允许。</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110110946267.png" alt="image-20220110110946267"></p>
<h4 id="AccessDecisionVoter"><a href="#AccessDecisionVoter" class="headerlink" title="AccessDecisionVoter"></a>AccessDecisionVoter</h4><blockquote>
<p>AccessDecisionVoter (访问决定投票器)，投票器会检查用户是否具备应有的角色，进而投出赞成、反对或者弃权票。</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110111011018.png" alt="image-20220110111011018"></p>
<p>AccesDecisionVoter 和 AccessDecisionManager 都有众多的实现类，在 AccessDecisionManager 中会换个遍历 AccessDecisionVoter，进而决定是否允许用户访问，因而 AaccesDecisionVoter 和 AccessDecisionManager 两者的关系类似于 AuthenticationProvider 和 ProviderManager 的关系。</p>
<h4 id="ConfigAttribute"><a href="#ConfigAttribute" class="headerlink" title="ConfigAttribute"></a>ConfigAttribute</h4><blockquote>
<p>ConfigAttribute，用来保存授权时的角色信息</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20220110111037603.png" alt="image-20220110111037603"></p>
<p>在 Spring Security 中，用户请求一个资源(通常是一个接口或者一个 Java 方法)需要的角色会被封装成一个 ConfigAttribute 对象，在 ConfigAttribute 中只有一个 getAttribute方法，该方法返回一个 String 字符串，就是角色的名称。一般来说，角色名称都带有一个 <code>ROLE_</code> 前缀，投票器 AccessDecisionVoter 所做的事情，其实就是比较用户所具各的角色和请求某个<br>资源所需的 ConfigAtuibute 之间的关系。</p>
<h1 id="第二章-认证原理"><a href="#第二章-认证原理" class="headerlink" title="第二章 认证原理"></a>第二章 认证原理</h1><ul>
<li>环境搭建</li>
<li>自动配置细节</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ul>
<li>spring boot </li>
<li>spring security<ul>
<li>认证: 判断用户是否是系统合法用户过程</li>
<li>授权: 判断系统内用户可以访问或具有访问那些资源权限过程</li>
</ul>
</li>
</ul>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.创建 springboot 应用</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113408799.png" alt="image-20220110113408799"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 2.创建 controller</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello security&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113534290.png" alt="image-20220110113534290"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 3.启动项目进行测试</span></span><br><span class="line"><span class="bullet">-</span> http://localhost:8080/hello</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110113757100.png" alt="image-20220110113757100"></p>
<h3 id="整合-Spring-Security"><a href="#整合-Spring-Security" class="headerlink" title="整合 Spring Security"></a>整合 Spring Security</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.引入spring security相关依赖</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入spring security依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 2.再次启动项目</span></span><br><span class="line"><span class="bullet">-</span> 1.启动完成后控制台生成一个密码</span><br><span class="line"><span class="bullet">-</span> 2.访问 hello 发现直接跳转到登录页面</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110114044889.png" alt="image-20220110114044889"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110114109713.png" alt="image-20220110114109713"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 3.登录系统</span></span><br><span class="line"><span class="bullet">-</span> 默认用户名为: user</span><br><span class="line"><span class="bullet">-</span> 默认密码为:  控制台打印的 uuid</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220110114258671.png" alt="image-20220110114258671"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110114227714.png" alt="image-20220110114227714"></p>
<p><strong>这就是 Spring Security 的强大之处，只需要引入一个依赖，所有的接口就会自动保护起来！</strong></p>
<p>思考🤔?</p>
<ul>
<li><p>为什么引入 Spring Security 之后<code>没有任何配置所有请求就要认证</code>呢?</p>
</li>
<li><p>在项目中明明没有登录界面，<code>登录界面</code>怎么来的呢？</p>
</li>
<li><p>为什么使用 <code>user</code> 和 <code>控制台密码</code> 能登陆，登录时验证数据源存在哪里呢？</p>
</li>
</ul>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture</a></p>
<p>虽然开发者只需要引入一个依赖，就可以让 Spring Security 对应用进行保护。Spring Security 又是如何做到的呢？</p>
<p>在 Spring Security 中 <code>认证、授权</code> 等功能都是基于<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">过滤器</a>完成的。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110120349053.png" alt="image-20220110120349053"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220110115946010.png" alt="image-20220110115946010"></p>
<p>需要注意的是，默认过滤器并不是直接放在 Web 项目的原生过滤器链中，而是通过一个<br>FlterChainProxy 来统一管理。Spring Security 中的过滤器链通过 FilterChainProxy 嵌入到 Web项目的原生过滤器链中。FilterChainProxy  作为一个顶层的管理者，将统一管理 Security Filter。FilterChainProxy 本身是通过 Spring 框架提供的 DelegatingFilterProxy 整合到原生的过滤器链中。</p>
<h4 id="Security-Filters"><a href="#Security-Filters" class="headerlink" title="Security Filters"></a>Security Filters</h4><p>那么在 Spring Security 中给我们提供那些过滤器? 默认情况下那些过滤器会被加载呢？</p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>过滤器作用</th>
<th>默认是否加载</th>
</tr>
</thead>
<tbody><tr>
<td>ChannelProcessingFilter</td>
<td>过滤请求协议 HTTP 、HTTPS</td>
<td>NO</td>
</tr>
<tr>
<td><code>WebAsyncManagerIntegrationFilter</code></td>
<td>将 WebAsyncManger 与 SpringSecurity 上下文进行集成</td>
<td>YES</td>
</tr>
<tr>
<td><code>SecurityContextPersistenceFilter</code></td>
<td>在处理请求之前,将安全信息加载到 SecurityContextHolder 中</td>
<td>YES</td>
</tr>
<tr>
<td><code>HeaderWriterFilter</code></td>
<td>处理头信息加入响应中</td>
<td>YES</td>
</tr>
<tr>
<td>CorsFilter</td>
<td>处理跨域问题</td>
<td>NO</td>
</tr>
<tr>
<td><code>CsrfFilter</code></td>
<td>处理 CSRF 攻击</td>
<td>YES</td>
</tr>
<tr>
<td><code>LogoutFilter</code></td>
<td>处理注销登录</td>
<td>YES</td>
</tr>
<tr>
<td>OAuth2AuthorizationRequestRedirectFilter</td>
<td>处理 OAuth2 认证重定向</td>
<td>NO</td>
</tr>
<tr>
<td>Saml2WebSsoAuthenticationRequestFilter</td>
<td>处理 SAML 认证</td>
<td>NO</td>
</tr>
<tr>
<td>X509AuthenticationFilter</td>
<td>处理 X509 认证</td>
<td>NO</td>
</tr>
<tr>
<td>AbstractPreAuthenticatedProcessingFilter</td>
<td>处理预认证问题</td>
<td>NO</td>
</tr>
<tr>
<td>CasAuthenticationFilter</td>
<td>处理 CAS 单点登录</td>
<td>NO</td>
</tr>
<tr>
<td>OAuth2LoginAuthenticationFilter</td>
<td>处理 OAuth2 认证</td>
<td>NO</td>
</tr>
<tr>
<td>Saml2WebSsoAuthenticationFilter</td>
<td>处理 SAML 认证</td>
<td>NO</td>
</tr>
<tr>
<td><code>UsernamePasswordAuthenticationFilter</code></td>
<td>处理表单登录</td>
<td>YES</td>
</tr>
<tr>
<td>OpenIDAuthenticationFilter</td>
<td>处理 OpenID 认证</td>
<td>NO</td>
</tr>
<tr>
<td><code>DefaultLoginPageGeneratingFilter</code></td>
<td>配置默认登录页面</td>
<td>YES</td>
</tr>
<tr>
<td><code>DefaultLogoutPageGeneratingFilter</code></td>
<td>配置默认注销页面</td>
<td>YES</td>
</tr>
<tr>
<td>ConcurrentSessionFilter</td>
<td>处理 Session 有效期</td>
<td>NO</td>
</tr>
<tr>
<td>DigestAuthenticationFilter</td>
<td>处理 HTTP 摘要认证</td>
<td>NO</td>
</tr>
<tr>
<td>BearerTokenAuthenticationFilter</td>
<td>处理 OAuth2 认证的 Access Token</td>
<td>NO</td>
</tr>
<tr>
<td><code>BasicAuthenticationFilter</code></td>
<td>处理 HttpBasic 登录</td>
<td>YES</td>
</tr>
<tr>
<td><code>RequestCacheAwareFilter</code></td>
<td>处理请求缓存</td>
<td>YES</td>
</tr>
<tr>
<td><code>SecurityContextHolder&lt;br /&gt;AwareRequestFilter</code></td>
<td>包装原始请求</td>
<td>YES</td>
</tr>
<tr>
<td>JaasApiIntegrationFilter</td>
<td>处理 JAAS 认证</td>
<td>NO</td>
</tr>
<tr>
<td>RememberMeAuthenticationFilter</td>
<td>处理 RememberMe 登录</td>
<td>NO</td>
</tr>
<tr>
<td><code>AnonymousAuthenticationFilter</code></td>
<td>配置匿名认证</td>
<td>YES</td>
</tr>
<tr>
<td>OAuth2AuthorizationCodeGrantFilter</td>
<td>处理OAuth2认证中授权码</td>
<td>NO</td>
</tr>
<tr>
<td><code>SessionManagementFilter</code></td>
<td>处理 session 并发问题</td>
<td>YES</td>
</tr>
<tr>
<td><code>ExceptionTranslationFilter</code></td>
<td>处理认证&#x2F;授权中的异常</td>
<td>YES</td>
</tr>
<tr>
<td><code>FilterSecurityInterceptor</code></td>
<td>处理授权相关</td>
<td>YES</td>
</tr>
<tr>
<td>SwitchUserFilter</td>
<td>处理账户切换</td>
<td>NO</td>
</tr>
</tbody></table>
<p>可以看出，Spring Security 提供了 30 多个过滤器。默认情况下Spring Boot 在对 Spring Security 进入自动化配置时，会创建一个名为 <strong>SpringSecurityFilerChain</strong> 的过滤器，并注入到 Spring 容器中，这个过滤器将负责所有的安全管理，包括用户认证、授权、重定向到登录页面等。具体可以参考WebSecurityConfiguration的源码:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111211538604.png" alt="image-20220111211538604"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111211436764.png" alt="image-20220111211436764"></p>
<h4 id="SpringBootWebSecurityConfiguration"><a href="#SpringBootWebSecurityConfiguration" class="headerlink" title="SpringBootWebSecurityConfiguration"></a>SpringBootWebSecurityConfiguration</h4><p>这个类是 spring boot 自动配置类，通过这个源码得知，默认情况下对所有请求进行权限控制:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">	SecurityFilterChain <span class="title function_">defaultSecurityFilterChain</span><span class="params">(HttpSecurity http)</span> </span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			http.authorizeRequests().anyRequest()</span><br><span class="line">      .authenticated().and().formLogin().and().httpBasic();</span><br><span class="line">		<span class="keyword">return</span> http.build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220112095052138.png" alt="image-20220112095052138"></p>
<p><strong>这就是为什么在引入 Spring Security 中没有任何配置情况下，请求会被拦截的原因！</strong></p>
<p>通过上面对自动配置分析，我们也能看出默认生效条件为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultWebSecurityCondition</span> <span class="keyword">extends</span> <span class="title class_">AllNestedConditions</span> &#123;</span><br><span class="line"></span><br><span class="line">	DefaultWebSecurityCondition() &#123;</span><br><span class="line">		<span class="built_in">super</span>(ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ConditionalOnClass(&#123; SecurityFilterChain.class, HttpSecurity.class &#125;)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Classes</span> &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(&#123; WebSecurityConfigurerAdapter.class, SecurityFilterChain.class &#125;)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Beans</span> &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>条件一 classpath中存在 SecurityFilterChain.class, HttpSecurity.class</li>
<li>条件二 没有自定义 WebSecurityConfigurerAdapter.class, SecurityFilterChain.class</li>
</ul>
<p>默认情况下，条件都是满足的。WebSecurityConfigurerAdapter 这个类极其重要，Spring Security 核心配置都在这个类中:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112095638356.png" alt="image-20220112095638356"></p>
<p>如果要对 Spring Security 进行自定义配置，就要自定义这个类实例，通过覆盖类中方法达到修改默认配置的目的。</p>
<h3 id="登录界面转发流程分析"><a href="#登录界面转发流程分析" class="headerlink" title="登录界面转发流程分析"></a>登录界面转发流程分析</h3><p><img src="/2022/01/26/SpringSecurity/image-20220111100643506.png" alt="image-20220111100643506"></p>
<ol>
<li>请求 &#x2F;hello 接口，在引入 spring security 之后会先经过一系列的过滤器</li>
<li>在请求到达<strong>FilterSecurityInterceptor</strong>时，发现请求并未认证。请求拦截下来，并抛出 <strong>AccessDeniedException</strong> 异常。</li>
<li>抛出 <strong>AccessDeniedException</strong> 的异常会被 <strong>ExceptionTranslationFilter</strong> 捕获，这个 Filter 中会调用 <strong>LoginUrlAuthenticationEntryPoint</strong>#<strong>commence</strong> 方法给客户端返回 302，要求客户端进行重定向到 &#x2F;login 页面。</li>
<li>客户端发送 &#x2F;login 请求。</li>
<li>&#x2F;login 请求会再次被拦截器中 <strong>DefaultLoginPageGeneratingFilter</strong> 拦截到，并在拦截器中返回生成登录页面。</li>
</ol>
<p><strong>就是通过这种方式，Spring Security 默认过滤器中生成了登录页面，并返回！</strong></p>
<h3 id="认证流程源码分析"><a href="#认证流程源码分析" class="headerlink" title="认证流程源码分析"></a>认证流程源码分析</h3><p>在分析相关源码之前, 我们的先认识下与之相关的基本组件: AuthenticationManager、ProviderManager、AuthenticationProvider</p>
<blockquote>
<p>AuthenticationManager</p>
</blockquote>
<p>从名称上可以看出，AuthenticationManager 是 一个认证管理器，它定义了Spring Security 过滤器要如何执行认证操作。AuthenticationManager 在认证成功后，会返回 一个Authentication对象，这个Authentication 对象会被设置到SecurityContextEfolder 中。如果开发者不想用Spring Security提供的 一套认证机制，那么也可以自定义认证流程，认证成功后，手动将Authentication存入SecurityContextHolder 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationManager</span> &#123;</span><br><span class="line"></span><br><span class="line">	Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 AuthenticationManager的源码中可以看到:</p>
<ul>
<li>AuthenticationManager 对传入的 Authentication 对象进行身份认证，此时传入的 Authentication 参数只有用户名&#x2F;密码等简单的属性，如果认证成功，返回的Authentication 的属性会得到完全填充，包括用户所具备的角色信息.</li>
<li>AuthenticationManager是一个接口,它有着诸多的实现类, 开发者也可以自定义AuthenticationManager 的实现类，不过在实际应用中，我们使用最多的是ProviderManager。在 SpringSecurity框架中，默认也是使用Provide Manager。</li>
</ul>
<blockquote>
<p>ProviderManager</p>
</blockquote>
<p><strong>ProviderManager</strong> 是<strong>AuthenticationManager</strong> 的 一个重要实现类。在开始学习之前，我们先通过一幅图来了解一下<strong>ProviderManager</strong>、<strong>AuthenticationProvider</strong> 之间的关系</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230716151856457.png" alt="image-20230716151856457"></p>
<ul>
<li>在Spring Security 中，由于系统可能同时支特多种不同的认证方式，例如同时支持用户名、密码认证、RememberMe 认证、手机号码动态认证等，而不同的认证方式对应了不同的 <strong>AuthenticationProvider</strong>，所以 一个完整的认证流程可能由多个<strong>AuthenticationProvider</strong> 来提供。</li>
<li>多个<strong>AuthenticationProvider</strong>将组成 一个列表，这个列表将由<strong>ProviderManager</strong>代理。换句话说，在<strong>ProviderManager</strong> 中存在一个<strong>AuthenticationProvider</strong> 列表，在<strong>ProviderManager</strong> 中遍历列表中的每 一个<strong>AuthenticationProvider</strong> 去执行身份认证，最终得到认证结果。</li>
<li><strong>ProviderManager</strong> 本身也可以再配置一个 <strong>AuthenticationManager</strong> 作为 parent，这样当<strong>ProviderManager</strong> 认证失败之后，就可以进入到parent 中再次进行认证。理论上来说:  <strong>ProviderManager</strong> 的 parent 可以是任意类型的 <strong>AuthenticationManager</strong>，但是通常都是由 <strong>ProviderManager</strong> 来扮演parent 的角色，也就是<strong>ProviderManager</strong> 是<strong>ProviderManager</strong> 的parent 。</li>
<li><strong>ProviderManager</strong> 本身也可以有多个，多个<strong>ProviderManager</strong> 共用同 一个parent ，当存在多 个过滤器链的时候非常有用。当存在多个过滤器链时，不同的路径可能对应不同的认证方式， 但是不同路径可能又会同时存在 一些共有的认证方式,这些共有的认证方式可以在parent 中统 一 处理</li>
</ul>
<p>根据上面的介绍，我们绘出新的<strong>ProviderManager</strong> 和<strong>AuthenticationProvider</strong> 关系图: </p>
<p><img src="/2022/01/26/SpringSecurity/image-20230716152418188.png" alt="image-20230716152418188"></p>
<p>我们重点看 一下<strong>ProviderManager</strong> 中的<strong>authenticate</strong> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> <span class="title class_">Authentication</span>&gt; toTest = authentication.getClass();</span><br><span class="line">		<span class="type">AuthenticationException</span> <span class="variable">lastException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">AuthenticationException</span> <span class="variable">parentException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">parentResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">int</span> <span class="variable">currentPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="built_in">this</span>.providers.size();</span><br><span class="line">		<span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(LogMessage.format(<span class="string">&quot;Authenticating request with %s (%d/%d)&quot;</span>,</span><br><span class="line">						provider.getClass().getSimpleName(), ++currentPosition, size));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				result = provider.authenticate(authentication);</span><br><span class="line">				<span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">					copyDetails(authentication, result);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (AccountStatusException | InternalAuthenticationServiceException ex) &#123;</span><br><span class="line">				prepareException(ex, authentication);</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">				lastException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">  </span><br><span class="line">		<span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				parentResult = <span class="built_in">this</span>.parent.authenticate(authentication);</span><br><span class="line">				result = parentResult;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (ProviderNotFoundException ex) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">				parentException = ex;</span><br><span class="line">				lastException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.eraseCredentialsAfterAuthentication &amp;&amp; (result <span class="keyword">instanceof</span> CredentialsContainer)) &#123;</span><br><span class="line">				((CredentialsContainer) result).eraseCredentials();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (parentResult == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="built_in">this</span>.eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (lastException == <span class="literal">null</span>) &#123;</span><br><span class="line">			lastException = <span class="keyword">new</span> <span class="title class_">ProviderNotFoundException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;ProviderManager.providerNotFound&quot;</span>,</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; toTest.getName() &#125;, <span class="string">&quot;No AuthenticationProvider found for &#123;0&#125;&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (parentException == <span class="literal">null</span>) &#123;</span><br><span class="line">			prepareException(lastException, authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> lastException;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这段源码的逻辑还是非常清晰的，我们分析一下:</p>
<ol>
<li>首先获取<strong>authentication</strong>对象的类型 。</li>
<li>分别定义当前认证过程抛出的异常、parent 中认证时抛出的异常、当前认证结果以及parent 中认证结果对应的变量。</li>
<li><strong>getProviders</strong> 方法用来获取当前<strong>ProviderManager</strong> 所代理的所有<strong>AuthenticationProvider</strong> 对象，遍历这些<strong>AuthenticationProvider</strong> 对象进行身份认证。</li>
<li>判断当前<strong>AuthenticationProvider</strong> 是否支持当前<strong>Authentication</strong>对象，要是不支持，则继续处理列表中的下一个<strong>AuthenticationProvider</strong> 对象。</li>
<li>调用 <strong>provider.authenticate</strong> 方法进行身份认证，如果认证成功，返回认证后的 <strong>Authentication</strong> 对象，同时调用<strong>copyDetails</strong> 方法给 <strong>Authentication</strong> 对象的<strong>details</strong> 属性赋值。由于可能是多个<strong>AuthenticationProvider</strong> 执行认证操作，所以如果抛出异常，则通过<strong>lastException</strong> 变量来记录。</li>
<li>在for循环执行完成后，如果result 还是没有值，说明所有的<strong>AuthenticationProvider</strong> 都认证失败，此时如果parent 不为空，则调用parent的<strong>authenticate</strong>方法进行认证。</li>
<li>如果parentException为null，发布认证失败事件(如果parentException 不为nll, 则说明认证失败 事件己经发布过 了)。</li>
<li>最后抛出lastException 异常。</li>
</ol>
<blockquote>
<p>AuthenticationProvider</p>
</blockquote>
<p>之前介绍了Spring Security支持多种不同的认证方式，不同的认证方式对应不同的身份类型，<strong>AuthenticationProvider 就是针对不同的身份类型执行具体的身份认证。</strong>例如，常见的 <strong>DaoAuthenticationProvider</strong> 用来支持用户名&#x2F;密码登录认证，<strong>RememberMeAuthenticationProvider</strong> 用来支持 “ 记住我” 的认证.</p>
<p>其源码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">	Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; authentication)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(1) authenticate 方法用来执行具体的身份认证。</p>
<p>(2) supports 方法用来判断当前AuthenticationProvider 是否支持对应的身份类型</p>
<blockquote>
<p>AuthenticationProvider主要实现类</p>
</blockquote>
<img src="/2022/01/26/SpringSecurity/image-20230712144937006.png" alt="image-20230712144937006" style="zoom:67%;">

<p>由于认证默认是使用的<strong>DaoAuthenticationProvider</strong>, 我先讲其父类<strong>AbstractUserDetailsAuthenticationProvider</strong></p>
<p><strong>DaoAuthenticationProvider</strong>没实现认证主方法,还是用的父类实现的认证方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">	Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication,</span><br><span class="line">			() -&gt; <span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span>,</span><br><span class="line">					<span class="string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span>));</span><br><span class="line">	<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> determineUsername(authentication);</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">cacheWasUsed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.userCache.getUserFromCache(username);</span><br><span class="line">	<span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">		cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (UsernameNotFoundException ex) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Failed to find user &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">this</span>.hideUserNotFoundExceptions) &#123;</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages</span><br><span class="line">					.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		Assert.notNull(user, <span class="string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// There was a problem, so try again after checking</span></span><br><span class="line">		<span class="comment">// we&#x27;re using latest data (i.e. not from the cache)</span></span><br><span class="line">		cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line">		user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">		<span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.postAuthenticationChecks.check(user);</span><br><span class="line">	<span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">		<span class="built_in">this</span>.userCache.putUserInCache(user);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">Object</span> <span class="variable">principalToReturn</span> <span class="operator">=</span> user;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.forcePrincipalAsString) &#123;</span><br><span class="line">		principalToReturn = user.getUsername();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们详细讲解下认证的逻辑:</p>
<ol>
<li><p>一开始先声明一个用户缓存对象<strong>userCache</strong>并看下命中缓存没，默认情况下没有启用缓存对象 。</p>
</li>
<li><p><strong>hideUserNotFoundExceptions</strong>表示是否隐藏用户名查找失败的异常，默认为true。为 了确保系统安全，用户在登录失败时只会给出一个模糊提示，例如“用户名或密码输入错误”。 在Spring Security 内部，如果用户名查找失败，则会抛出<strong>UsernameNotFoundException</strong> 异常， 但是该异常会被自动隐藏，转而通过 一个<strong>BadCredentialsException</strong> 异常来代替它 ，这样，开发者在处理登录失败异常时 ，无论是用户名输入错误还是密码输入错误 ， 收到的总是<strong>BadCredentialsException</strong>， 这样做的一个好处是可以避免新手程序员将用户名输入错误和密码输入错误两个异常分开提示。</p>
</li>
<li><p><strong>forcePrincipalAsString</strong>表示是否强制将<strong>Principal</strong> 对象当成字符串来处理，默认是false。 <strong>Authentication</strong>中的<strong>principal</strong>属性类型是一个<strong>Object</strong>，正常来说，通过<strong>principal</strong>属性可以获取到当前登录用户对象(即UserDetails)，<strong>但是如果forcePrincipalAsString 设置为true，则 Authentication 中的principal 属性返回就是当前登录用户名，而不是用户对象。</strong></p>
</li>
<li><p><strong>preAuthenticationChecks</strong> 对象则是用于做用户状态检查，在用户认证过程中，需要检验用户状态是否正常，例如账户是否被锁定、账户是否可用、账户是否过期等。</p>
</li>
<li><p><strong>postAuthenticationChecks</strong> 对象主要负责在密码校验成功后 ， 检查密码是否过期 </p>
</li>
<li><p><strong>additionalAuthenticationChecks</strong>是一个抽象方法，主要就是<strong>校验密码</strong>，具体的实现在<strong>DaoAuthenticationProvider</strong>中</p>
<p>总的来说: <strong>AbstractUserDetailsAuthenticationProvider</strong>的<strong>authenticate</strong> 方法就是核心的校验方法了。在方法中，首先从登录数据中获取用户名， 然后根据用户名去缓存中查询用户对象，如果查询不到，则根据用户名调用<strong>retrieveUser</strong> 方法 从数据库中加载用户;如果没有加载到用户，则拋出异常(用户不存在异常会被隐藏)。拿到用户对象之后，首先调用 <strong>preAuthenticationChecks.check</strong> 方法进行用户状态检查，然后调用 <strong>additionalAuthenticationChecks</strong> 方法进行密码的校验操作，最后调用 <strong>postAuthenticationChecks.check</strong> 方法检查密码是否过期.</p>
<p>当所有步骤都顺利完成后，调用<strong>createSuccessAuthentication</strong> 方法创建一个认证后的<strong>UsernamePasswordAuthenticationToken</strong> 对象并返回，认证后的对象中包含了认证主体、凭证以及角色等信息。</p>
</li>
</ol>
<p>在回到认证主类:<strong>DaoAuthenticationProvider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoAuthenticationProvider</span> <span class="keyword">extends</span> <span class="title class_">AbstractUserDetailsAuthenticationProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_NOT_FOUND_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;userNotFoundPassword&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> String userNotFoundEncodedPassword;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> UserDetailsPasswordService userDetailsPasswordService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DaoAuthenticationProvider</span><span class="params">()</span> &#123;</span><br><span class="line">		setPasswordEncoder(PasswordEncoderFactories.createDelegatingPasswordEncoder());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails,</span></span><br><span class="line"><span class="params">			UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">		<span class="keyword">if</span> (authentication.getCredentials() == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Failed to authenticate since no credentials provided&quot;</span>);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages</span><br><span class="line">					.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.passwordEncoder.matches(presentedPassword, userDetails.getPassword())) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Failed to authenticate since password does not match stored value&quot;</span>);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages</span><br><span class="line">					.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doAfterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">		Assert.notNull(<span class="built_in">this</span>.userDetailsService, <span class="string">&quot;A UserDetailsService must be set&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title function_">retrieveUser</span><span class="params">(String username, UsernamePasswordAuthenticationToken authentication)</span></span><br><span class="line">			<span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">		prepareTimingAttackProtection();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">UserDetails</span> <span class="variable">loadedUser</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">			<span class="keyword">if</span> (loadedUser == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalAuthenticationServiceException</span>(</span><br><span class="line">						<span class="string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> loadedUser;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (UsernameNotFoundException ex) &#123;</span><br><span class="line">			mitigateAgainstTimingAttack(authentication);</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (InternalAuthenticationServiceException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalAuthenticationServiceException</span>(ex.getMessage(), ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Authentication <span class="title function_">createSuccessAuthentication</span><span class="params">(Object principal, Authentication authentication,</span></span><br><span class="line"><span class="params">			UserDetails user)</span> &#123;</span><br><span class="line">		<span class="type">boolean</span> <span class="variable">upgradeEncoding</span> <span class="operator">=</span> <span class="built_in">this</span>.userDetailsPasswordService != <span class="literal">null</span></span><br><span class="line">				&amp;&amp; <span class="built_in">this</span>.passwordEncoder.upgradeEncoding(user.getPassword());</span><br><span class="line">		<span class="keyword">if</span> (upgradeEncoding) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">			<span class="type">String</span> <span class="variable">newPassword</span> <span class="operator">=</span> <span class="built_in">this</span>.passwordEncoder.encode(presentedPassword);</span><br><span class="line">			user = <span class="built_in">this</span>.userDetailsPasswordService.updatePassword(user, newPassword);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>.createSuccessAuthentication(principal, authentication, user);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareTimingAttackProtection</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.userNotFoundEncodedPassword == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.userNotFoundEncodedPassword = <span class="built_in">this</span>.passwordEncoder.encode(USER_NOT_FOUND_PASSWORD);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mitigateAgainstTimingAttack</span><span class="params">(UsernamePasswordAuthenticationToken authentication)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (authentication.getCredentials() != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">			<span class="built_in">this</span>.passwordEncoder.matches(presentedPassword, <span class="built_in">this</span>.userNotFoundEncodedPassword);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPasswordEncoder</span><span class="params">(PasswordEncoder passwordEncoder)</span> &#123;</span><br><span class="line">		Assert.notNull(passwordEncoder, <span class="string">&quot;passwordEncoder cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">		<span class="built_in">this</span>.userNotFoundEncodedPassword = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> PasswordEncoder <span class="title function_">getPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.passwordEncoder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> UserDetailsService <span class="title function_">getUserDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDetailsPasswordService</span><span class="params">(UserDetailsPasswordService userDetailsPasswordService)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.userDetailsPasswordService = userDetailsPasswordService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们详细讲解下该具体实现:</p>
<ol>
<li>首先定义了<strong>USER_NOT_FOUND_PASSWORD</strong> 常量，<strong>这个是当用户查找失败时的默认密码:passwordEncoder</strong>; userNotFoundEncodedPasword 变量则用来保存默认密码加密后的值</li>
<li>在<strong>DaoAuthenticationProvider</strong>的构造方法中，默认就会指定PasswordEncoder ，当然开发者也可以通过set 方法自定义PasswordEncoder</li>
<li><strong>additionalAuthenticationChecks</strong> 方法主要进行密码校验，该方法第 一个参数<strong>userDetails</strong>是从数据库中查询出来的用户对象，第二个参数<strong>authentication</strong> 则是登录用户输入的参数。从 这两个参数中分别提取出来用户密码，然后调用<strong>paswordEncoder.matches</strong> 方法进行密码比对。</li>
<li><strong>retieveUser</strong> 方法则是获取用户对象的方法，具体做法就是调用 <strong>UserDetailsService#loadUserBvUsername</strong> 方法去数据库中查询。</li>
<li><strong>createSuccessAuthentication</strong>方 法则是在登录成功后 ， 创建一个全新的 <strong>UsernamePasswordAuthenticationToken</strong> 对象，同时会判断是否需要进行密码升级，如果需要进行密码升级， 就会在该方法中进行加密方案升级。</li>
</ol>
<p>现在大家己经熟悉了<strong>Authentication</strong>、<strong>AuthenticationManager</strong> 、<strong>AuthenticationProvider</strong> 以及<strong>ProviderManager</strong> 的工作原理了，接下来的问题就是这些组件如何跟登录关联起来?这就涉 及一 个重要的过滤器 - AbstractProcessingFilter</p>
<h4 id="AbstractAuthenticationProcessingFilter"><a href="#AbstractAuthenticationProcessingFilter" class="headerlink" title="AbstractAuthenticationProcessingFilter"></a>AbstractAuthenticationProcessingFilter</h4><p>​	作为Spring Security过滤器链中的一环,<strong>AbstractAuthenticationProcessingFilter</strong>可以用来处理任何提交给它的身份认证,下图描述了工作流程:</p>
<img src="/2022/01/26/SpringSecurity/image-20230214222306844.png" alt="image-20230214222306844" style="zoom:50%;">



<p><strong>AbstractAuthenticationProcessingFilter</strong>作为一个抽象类, 如果使用用户名&#x2F;密码的方式登录, 那么它对应的是实现类是<strong>UsernamePasswordAuthenticationFilter</strong>, 构造出来的<strong>Authentication</strong>对象则是<strong>UsernamePasswordAuthenticationToken</strong>. </p>
<p>因此我们可以对认证流程进行进一步的细化:</p>
<img src="/2022/01/26/SpringSecurity/image-20230214222758742.png" alt="image-20230214222758742" style="zoom:50%;">



<p>现在我们大致梳理一下认证的流程:</p>
<ol>
<li>当请求被转发到<strong>AbstractAuthenticationProcessingFilter</strong>, 先判断是否需要认证具体实现为<strong>requiresAuthentication</strong> </li>
<li>如果需要认证则调用<strong>UsernamePasswordAuthenticationFilter</strong>#<strong>attemptAuthentication</strong>: 从当前请求<strong>HttpServletRequest</strong>中提取出登录用户名&#x2F;密码,然后封装成一个<strong>UsernamePasswordAuthenticationToken</strong>对象</li>
<li><strong>UsernamePasswordAuthenticationToken</strong>对象将被传入<strong>ProviderManager</strong>中进行具体的认证操作<ol>
<li>如果认证失败,则抛出异常被<strong>AbstractAuthenticationProcessingFilter</strong>#<strong>unsuccessfulAuthentication</strong>方法catch到:<ul>
<li><strong>SecurityContextHolder</strong>中相关的信息将被清除,登录失败回调也会被调用</li>
<li><strong>RememberMeServices</strong>#<strong>loginFail</strong></li>
<li>执行认证失败处理<strong>AuthenticationFailureHandler</strong>#<strong>onAuthenticationFailure</strong></li>
</ul>
</li>
<li>如果认证成功,则会进行<ul>
<li>存储<strong>SecurityContextHolder</strong>中相关的信息</li>
<li><strong>Session</strong>并发处理</li>
<li>执行认证成功处理<strong>AuthenticationSuccessHandler</strong>#<strong>onAuthenticationSuccess</strong></li>
</ul>
</li>
</ol>
</li>
</ol>
<p>值得注意的是: <strong>ProviderManager</strong>在拿到<strong>Authentication</strong>的时候</p>
<ul>
<li>会遍历其下的<strong>AuthenticationProvider</strong><ul>
<li>再看是否支持#<strong>supports</strong>该<strong>Authentication</strong>, 如果支持则会进行认证#<strong>authenticate</strong>操作;</li>
<li>如果都不支持则会递归父类<strong>ProviderManager</strong>,再次进行以上操作</li>
</ul>
</li>
</ul>
<p>查看源码发现: 第一个持有一个<strong>AnonymousAuthenticationProvider</strong>的<strong>ProviderManager</strong>不支持, 最后递归到父类持有一个<strong>DaoAuthenticationProvider</strong>的<strong>ProviderManager</strong>开始认证</p>
<h4 id="UserDetailService"><a href="#UserDetailService" class="headerlink" title="UserDetailService"></a>UserDetailService</h4><p>通过刚才源码分析也能得知 UserDetailService 是顶层父接口，接口中 loadUserByUserName 方法是用来在认证时进行用户名认证方法，默认实现使用是内存实现，如果想要修改数据库实现我们只需要自定义 UserDetailService 实现，最终返回 UserDetails 实例即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">	UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220111110043474.png" alt="image-20220111110043474"></p>
<h4 id="UserDetailsServiceAutoConfigutation"><a href="#UserDetailsServiceAutoConfigutation" class="headerlink" title="UserDetailsServiceAutoConfigutation"></a>UserDetailsServiceAutoConfigutation</h4><p>这个源码非常多，这里梳理了关键部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(AuthenticationManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ObjectPostProcessor.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(</span></span><br><span class="line"><span class="meta">		value = &#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,</span></span><br><span class="line"><span class="meta">				AuthenticationManagerResolver.class &#125;,</span></span><br><span class="line"><span class="meta">		type = &#123; &quot;org.springframework.security.oauth2.jwt.JwtDecoder&quot;,</span></span><br><span class="line"><span class="meta">				&quot;org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector&quot;,</span></span><br><span class="line"><span class="meta">				&quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceAutoConfiguration</span> &#123;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Lazy</span></span><br><span class="line">	<span class="keyword">public</span> InMemoryUserDetailsManager <span class="title function_">inMemoryUserDetailsManager</span><span class="params">(SecurityProperties properties,</span></span><br><span class="line"><span class="params">			ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder)</span> &#123;</span><br><span class="line">		SecurityProperties.<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> properties.getUser();</span><br><span class="line">		List&lt;String&gt; roles = user.getRoles();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(</span><br><span class="line">				User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))</span><br><span class="line">						.roles(StringUtils.toStringArray(roles)).build());</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结论</strong></p>
<ol>
<li>从自动配置源码中得知当 classpath 下存在 AuthenticationManager 类</li>
<li>当前项目中，系统没有提供 AuthenticationManager.class、 AuthenticationProvider.class、UserDetailsService.class、<br>            AuthenticationManagerResolver.class、实例</li>
</ol>
<p><strong>默认情况下都会满足，此时Spring Security会提供一个 InMemoryUserDetailManager 实例</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220111111244739.png" alt="image-20220111111244739"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.security&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityProperties</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">	<span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.user;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">		<span class="keyword">private</span> List&lt;String&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">passwordGenerated</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">		<span class="comment">//get set ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这就是默认生成 user 以及 uuid 密码过程! 另外看明白源码之后，就知道只要在配置文件中加入如下配置可以对内存中用户和密码进行覆盖。</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.security.user.name</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.security.user.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.security.user.roles</span>=<span class="string">admin,users</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>AuthenticationManager、ProviderManger、以及 AuthenticationProvider 关系</li>
</ul>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150612023.png" alt="image-20220112150612023"></p>
<ul>
<li><p><strong>WebSecurityConfigurerAdapter</strong> 扩展 Spring Security 所有默认配置</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150820284.png" alt="image-20220112150820284"></p>
</li>
<li><p><strong>UserDetailService</strong> 用来修改默认认证的数据源信息</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220112150929998.png" alt="image-20220112150929998"></p>
</li>
</ul>
<h1 id="第三章-自定义认证"><a href="#第三章-自定义认证" class="headerlink" title="第三章 自定义认证"></a>第三章 自定义认证</h1><ul>
<li>认证配置</li>
<li>表单认证</li>
<li>注销登录</li>
<li>前后端分离认证</li>
<li>添加验证码</li>
</ul>
<h2 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h2><h3 id="自定义资源权限规则"><a href="#自定义资源权限规则" class="headerlink" title="自定义资源权限规则"></a>自定义资源权限规则</h3><ul>
<li>&#x2F;index  公共资源</li>
<li>&#x2F;hello …. 受保护资源 权限管理</li>
</ul>
<p>在项目中添加如下配置就可以实现对资源权限规则设定:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/index&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113050533209-2023951.png" alt="image-20220113050533209"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 说明</span></span><br><span class="line"><span class="bullet">-</span> permitAll() 代表放行该资源,该资源为公共资源 无需认证和授权可以直接访问</span><br><span class="line"><span class="bullet">-</span> anyRequest().authenticated() 代表所有请求,必须认证之后才能访问</span><br><span class="line"><span class="bullet">-</span> formLogin() 代表开启表单认证</span><br><span class="line"><span class="section">## 注意: 放行资源f0f必须放在所有认证请求之前!</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义登录界面"><a href="#自定义登录界面" class="headerlink" title="自定义登录界面"></a>自定义登录界面</h3><ul>
<li><p>引入模板依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--thymeleaf--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义登录页面 controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/login.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 templates 中定义登录界面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>需要注意的是</strong></p>
<ul>
<li>登录表单 method 必须为 <code>post</code>，action 的请求路径为 <code>/doLogin</code></li>
<li>用户名的 name 属性为 <code>uname</code></li>
<li>密码的 name 属性为 <code>passwd</code></li>
</ul>
</li>
<li><p>配置 Spring Security 配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/index&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">                .usernameParameter(<span class="string">&quot;uname&quot;</span>)</span><br><span class="line">                .passwordParameter(<span class="string">&quot;passwd&quot;</span>)</span><br><span class="line">                .successForwardUrl(<span class="string">&quot;/index&quot;</span>) 		 <span class="comment">//forward 跳转           注意:不会跳转到之前请求路径</span></span><br><span class="line">                <span class="comment">//.defaultSuccessUrl(&quot;/index&quot;)   //redirect 重定向    注意:如果之前请求路径,会有优先跳转之前请求路径</span></span><br><span class="line">                .failureUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>successForwardUrl 、defaultSuccessUrl 这两个方法都可以实现成功之后跳转<ul>
<li>successForwardUrl  默认使用 <code>forward </code>跳转      <code>注意:不会跳转到之前请求路径</code></li>
<li>defaultSuccessUrl   默认使用 <code>redirect</code> 跳转      <code>注意:如果之前请求路径,会有优先跳转之前请求路径,可以传入第二个参数进行修改</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="自定义登录成功处理"><a href="#自定义登录成功处理" class="headerlink" title="自定义登录成功处理"></a>自定义登录成功处理</h3><p>有时候页面跳转并不能满足我们，特别是在前后端分离开发中就不需要成功之后跳转页面。只需要给前端返回一个 JSON 通知登录成功还是失败与否。这个时候可以通过自定义 <code>AuthenticationSucccessHandler</code> 实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Called when a user has been successfully authenticated.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request the request which caused the successful authentication</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response the response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> authentication the &lt;tt&gt;Authentication&lt;/tt&gt; object which was created during</span></span><br><span class="line"><span class="comment">	 * the authentication process.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>根据接口的描述信息,也可以得知登录成功会自动回调这个方法，进一步查看它的默认实现，你会发现successForwardUrl、defaultSuccessUrl也是由它的子类实现的</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113054514897-2023963.png" alt="image-20220113054514897"></p>
<ul>
<li>自定义 AuthenticationSuccessHandler 实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 AuthenticationSuccessHandler</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>())</span><br><span class="line">                .failureUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113062644363-2026405.png" alt="image-20220113062644363"></p>
<h3 id="显示登录失败信息"><a href="#显示登录失败信息" class="headerlink" title="显示登录失败信息"></a>显示登录失败信息</h3><p>为了能更直观在登录页面看到异常错误信息，可以在登录页面中直接获取异常信息。Spring Security 在登录失败之后会将异常信息存储到 <code>request</code> 、<code>session</code>作用域中 key 为 <code>SPRING_SECURITY_LAST_EXCEPTION</code> 命名属性中，源码可以参考 SimpleUrlAuthenticationFailureHandler ：</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113060257662.png" alt="image-20220113060257662"></p>
<ul>
<li><p>显示异常信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  ....</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;SPRING_SECURITY_LAST_EXCEPTION&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">              	<span class="comment">//..</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">                <span class="comment">//.failureUrl(&quot;/login.html&quot;)</span></span><br><span class="line">                .failureForwardUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>failureUrl、failureForwardUrl 关系类似于之前提到的 successForwardUrl 、defaultSuccessUrl 方法<ul>
<li>failureUrl 失败以后的重定向跳转</li>
<li>failureForwardUrl 失败以后的 forward 跳转 <code>注意:因此获取 request 中异常信息,这里只能使用failureForwardUrl</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="自定义登录失败处理"><a href="#自定义登录失败处理" class="headerlink" title="自定义登录失败处理"></a>自定义登录失败处理</h3><p>和自定义登录成功处理一样，Spring Security 同样为前后端分离开发提供了登录失败的处理，这个类就是  AuthenticationFailureHandler，源码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Called when an authentication attempt fails.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request the request during which the authentication attempt occurred.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response the response.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> exception the exception which was thrown to reject the authentication</span></span><br><span class="line"><span class="comment">	 * request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>根据接口的描述信息,也可以得知登录失败会自动回调这个方法，进一步查看它的默认实现，你会发现failureUrl、failureForwardUrl也是由它的子类实现的。</strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113062114741.png" alt="image-20220113062114741"></p>
<ul>
<li>自定义 AuthenticationFailureHandler 实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录失败: &quot;</span>+exception.getMessage());</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 AuthenticationFailureHandler</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">	              <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">               	<span class="comment">//..</span></span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113062617937-2026380.png" alt="image-20220113062617937"></p>
<h4 id="自定义未授权处理器"><a href="#自定义未授权处理器" class="headerlink" title="自定义未授权处理器"></a>自定义未授权处理器</h4><blockquote>
<p>security配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">securityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestAccessDeniedHandler restAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/hello&quot;</span>).hasRole(<span class="string">&quot;product&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin();</span><br><span class="line"></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restAccessDeniedHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username -&gt; &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.selectUserByName(username);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Role&gt; roles = userService.selectRoleByUsername(username);</span><br><span class="line">            user.setRoles(roles);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>实现AccessDeniedHandler</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.write(<span class="string">&quot;您未授权，请联系管理员&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="注销登录"><a href="#注销登录" class="headerlink" title="注销登录"></a>注销登录</h3><p>Spring Security 中也提供了默认的注销登录配置，在开发时也可以按照自己需求对注销进行个性化定制。</p>
<ul>
<li><p>开启注销登录<code>默认开启</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 logout() 方法开启注销配置</li>
<li>logoutUrl 指定退出登录请求地址，默认是 GET 请求，路径为 <code>/logout</code></li>
<li>invalidateHttpSession 退出时是否是 session 失效，默认值为 true</li>
<li>clearAuthentication 退出时是否清除认证信息，默认值为 true</li>
<li>logoutSuccessUrl 退出登录时跳转地址</li>
</ul>
</li>
<li><p>配置多个注销登录请求</p>
<p>如果项目中有需要，开发者还可以配置多个注销登录的请求，同时还可以指定请求的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout1&quot;</span>,<span class="string">&quot;GET&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                ))</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>前后端分离注销登录配置</p>
<p>如果是前后端分离开发，注销成功之后就不需要页面跳转了，只需要将注销成功的信息返回前端即可，此时我们可以通过自定义 LogoutSuccessHandler  实现来返回注销之后信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">          			<span class="comment">//....</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line"> 								<span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                <span class="comment">//.logoutUrl(&quot;/logout&quot;)</span></span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout1&quot;</span>,<span class="string">&quot;GET&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                ))</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">//.logoutSuccessUrl(&quot;/login.html&quot;)</span></span><br><span class="line">                .logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//这里先关闭 CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113114133687.png" alt="image-20220113114133687"></p>
</li>
</ul>
<h3 id="登录用户数据获取"><a href="#登录用户数据获取" class="headerlink" title="登录用户数据获取"></a>登录用户数据获取</h3><h4 id="SecurityContextHolder-1"><a href="#SecurityContextHolder-1" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>​	Spring Security 会将登录用户数据保存在 Session 中。但是，为了使用方便,Spring Security在此基础上还做了一些改进，其中最主要的一个变化就是线程绑定。当用户登录成功后,Spring Security 会将登录成功的用户信息保存到 SecurityContextHolder 中。</p>
<p>​	SecurityContextHolder 中的数据保存默认是通过ThreadLocal 来实现的，使用 ThreadLocal 创建的变量只能被当前线程访问，不能被其他线程访问和修改，也就是用户数据和请求线程绑定在一起。当登录请求处理完毕后，Spring Security 会将 SecurityContextHolder 中的数据拿出来保存到 Session 中，同时将 SecurityContexHolder 中的数据清空。以后每当有请求到来时，Spring Security 就会先从 Session 中取出用户登录数据，保存到SecurityContextHolder 中，方便在该请求的后续处理过程中使用，同时在请求结束时将 SecurityContextHolder 中的数据拿出来保存到 Session 中，然后将SecurityContextHolder 中的数据清空。</p>
<p>​	实际上 SecurityContextHolder 中存储是 SecurityContext，在 SecurityContext 中存储是 Authentication。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220113115956334.png" alt="image-20220113115956334"></p>
<p>这种设计是典型的策略设计模式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityContextHolder</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_THREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_THREADLOCAL&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_INHERITABLETHREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_GLOBAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_GLOBAL&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_PRE_INITIALIZED</span> <span class="operator">=</span> <span class="string">&quot;MODE_PRE_INITIALIZED&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SecurityContextHolderStrategy strategy;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initializeStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) &#123;</span><br><span class="line">			Assert.state(strategy != <span class="literal">null</span>, <span class="string">&quot;When using &quot;</span> + MODE_PRE_INITIALIZED</span><br><span class="line">					+ <span class="string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(strategyName)) &#123;</span><br><span class="line">			<span class="comment">// Set default</span></span><br><span class="line">			strategyName = MODE_THREADLOCAL;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">ThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_GLOBAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">GlobalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>MODE THREADLOCAL</code>：这种存放策略是将 SecurityContext 存放在 ThreadLocal中，大家知道 Threadlocal 的特点是在哪个线程中存储就要在哪个线程中读取，这其实非常适合 web 应用，因为在默认情况下，一个请求无论经过多少 Filter 到达 Servlet，都是由一个线程来处理的。这也是 SecurityContextHolder 的默认存储策略，这种存储策略意味着如果在具体的业务处理代码中，开启了子线程，在子线程中去获取登录用户数据，就会获取不到。</li>
<li><code>MODE INHERITABLETHREADLOCAL</code>：这种存储模式适用于多线程环境，如果希望在子线程中也能够获取到登录用户数据，那么可以使用这种存储模式。</li>
<li><code>MODE GLOBAL</code>：这种存储模式实际上是将数据保存在一个静态变量中，在 JavaWeb开发中，这种模式很少使用到。</li>
</ol>
<h4 id="SecurityContextHolderStrategy"><a href="#SecurityContextHolderStrategy" class="headerlink" title="SecurityContextHolderStrategy"></a>SecurityContextHolderStrategy</h4><p>通过 SecurityContextHolder 可以得知，SecurityContextHolderStrategy 接口用来定义存储策略方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityContextHolderStrategy</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">clearContext</span><span class="params">()</span>;</span><br><span class="line">	SecurityContext <span class="title function_">getContext</span><span class="params">()</span>;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(SecurityContext context)</span>;</span><br><span class="line">	SecurityContext <span class="title function_">createEmptyContext</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口中一共定义了四个方法：</p>
<ul>
<li><code>clearContext</code>：该方法用来清除存储的 SecurityContext对象。</li>
<li><code>getContext</code>：该方法用来获取存储的 SecurityContext 对象。</li>
<li><code>setContext</code>：该方法用来设置存储的 SecurityContext 对象。</li>
<li><code>create Empty Context</code>：该方法则用来创建一个空的 SecurityContext 对象。</li>
</ul>
<p><img src="/2022/01/26/SpringSecurity/image-20220113125407538-2049649.png" alt="image-20220113125407538"></p>
<p>从上面可以看出每一个实现类对应一种策略的实现。</p>
<h4 id="代码中获取认证之后用户数据"><a href="#代码中获取认证之后用户数据" class="headerlink" title="代码中获取认证之后用户数据"></a>代码中获取认证之后用户数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder</span><br><span class="line">        .getContext().getAuthentication();</span><br><span class="line">      <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">      System.out.println(<span class="string">&quot;身份 :&quot;</span>+principal.getUsername());</span><br><span class="line">      System.out.println(<span class="string">&quot;凭证 :&quot;</span>+authentication.getCredentials());</span><br><span class="line">      System.out.println(<span class="string">&quot;权限 :&quot;</span>+authentication.getAuthorities());</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多线程情况下获取用户数据"><a href="#多线程情况下获取用户数据" class="headerlink" title="多线程情况下获取用户数据"></a>多线程情况下获取用户数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder</span><br><span class="line">          .getContext().getAuthentication();</span><br><span class="line">        <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">        System.out.println(<span class="string">&quot;身份 :&quot;</span>+principal.getUsername());</span><br><span class="line">        System.out.println(<span class="string">&quot;凭证 :&quot;</span>+authentication.getCredentials());</span><br><span class="line">        System.out.println(<span class="string">&quot;权限 :&quot;</span>+authentication.getAuthorities());</span><br><span class="line">      &#125;).start();</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113124141492.png" alt="image-20220113124141492"></p>
<p><strong>可以看到默认策略，是无法在子线程中获取用户信息，如果需要在子线程中获取必须使用第二种策略，默认策略是通过 System.getProperty 加载的，因此我们可以通过增加 VM Options 参数进行修改。</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Dspring.security.strategy</span>=<span class="string">MODE_INHERITABLETHREADLOCAL</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/SpringSecurity/image-20220113124639102.png" alt="image-20220113124639102"></p>
<h4 id="SecurityContextPersistenceFilter详解"><a href="#SecurityContextPersistenceFilter详解" class="headerlink" title="SecurityContextPersistenceFilter详解"></a>SecurityContextPersistenceFilter详解</h4><p>过滤器的核心方法当然是doFilter,我们就从doFilter方法开始介绍</p>
<ol>
<li>首先从request中获取FILTER_APPLIED属性,如果该属性值不为null,则直接执行chain.doFilter方法,当前过滤器到此为止,这个判断主要是确保请求只执行一次该过滤器.如果确实是该request第一次经过该过滤器,则给其设置上FILTER_APPLIED属性</li>
<li>forceEagerSessionCreation变量表示是否要在过滤器链执行之前确保会话有效,由于这是一个比较耗费资源的操作,因此默认为false</li>
<li>构建HttpRequestResponseHolder对象,将HttpServletRequest和HttpServletResponse都存储进去</li>
<li>调用repo.loadContext方法去加载SecurityContext</li>
<li>将读取到的SecurityContext存入SecurityContextHolder之中,这样,在接下来的处理逻辑中,开发者就可以直接通过SecurityContextHolder来获取当前登录的用户了</li>
<li>当请求处理完毕后,在finally模块中,获取最新的SecurityContext对象</li>
<li>最后,从request最后移除FILTER_APPLIED属性</li>
</ol>
<p>总而言之,请求在到达SecurityContextPersistenceFilter过滤器之后,先从HttpSession中读取SecurityContext出来,并存入SecurityContextHolder,并存入SecurityContextHolder之中以备后续使用;当请求离开SecuirtyContextPersistenceFilter过滤器的时候,获取最新的SecurityContext并存入HttpSession中,同时清空SecurityContextHolder中的登录用户信息</p>
<h4 id="从当前请求对象获取用户信息"><a href="#从当前请求对象获取用户信息" class="headerlink" title="从当前请求对象获取用户信息"></a>从当前请求对象获取用户信息</h4><p>接下来我们来看一洗第二种登录数据获取方法: 从当前请求中获取. 获取代码如下:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230212213216653.png" alt="image-20230212213216653"></p>
<p>​	开发者可以直接在Controller的请求参数中放入Authentication对象来获取登录用户信息.通过前面的讲解,大家已经知道Authentication是Principal的子类, 所以可以直接在请求参数中放入Principal来接收当前登录用户信息.<strong>需要注意的是,即使参数是Principal,真正的实例依然是Authentication的实例.</strong></p>
<p>​	用过Spring MVC的都知道,Controller中的方法的参数都是当前请求HttpServletRequest带来的.毫无疑问,前面的Authentication和Principal参数也都是HttpServletRequest带来的,那么这些数据到底是何时放入HttpServletRequest的呢? 又是以何种形式存在的呢?我们下面一起来分析下:</p>
<p>在Servlet规范中,最早有三个和安全管理相关的方法:</p>
<ol>
<li>getRemoteUser方法用来获取登录用户名.</li>
<li>isUserInRole方法用来判断当前登录用户是否具备某个指定的角色</li>
<li>getUserPrincipal方法用来获取当前认证主体</li>
</ol>
<p>从Servlet3.0开始,在这三个方法的基础上,又增加了三个和安全管理相关的方法:</p>
<ol>
<li>authenticate方法来判断当前请求是否认证成功</li>
<li>login方法可以执行登录操作</li>
<li>logout方法可以执行注销操作</li>
</ol>
<p>不过HttpServletRequest只是一个接口,这些安全认证相关的方法,在不同的环境会有不同的实现:</p>
<ul>
<li>如果是一个普通的Web相关,不使用任何框架,HttpServletRequest的默认实现类是Tomcat中的RequestFacade,从这个类的名称就可以看出来,这使用了Facade模式(外观模式)的类, 真正提供底层服务的是Tomcat中的Request对象,只不过这个Request对象在实现Servlet规范的同时还定义了很多Tomcat内部的方法,为了避免开发者直接调用这些内部方法,这里使用了外观模式</li>
<li>如果使用了Spring Security框架,那么我们在Controller参数中拿到的HttpServletRequest实例将是Servlet3SecurityContextHolderAwareRequestWrapper,很明显,这是被Spring Security封装过的请求,我们来看一下Servlet3SecurityContextHolderAwareRequestWrapper的继承关系,如下图:</li>
</ul>
<img src="/2022/01/26/SpringSecurity/image-20230212215627835.png" alt="image-20230212215627835" style="zoom: 50%;">

<p>Servlet3.0中新增的三个安全管理相关的方法,则在Servlet3SecurityContextHolderAwareRequestWrapper类中实现.获取用户登录信息主要和前面三个方法有关,因此这里我们主要来看一下SecurityContextHolderAwareRequestWrapper类中相关方法的实现:</p>
<ol>
<li>getAuthentication: 该方法用来获取当前登录对象Authentication,获取方式就是我们前面所讲的从SecurityContextHolder中获取.如果不是匿名对象就返回,否则就返回null</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220211491.png" alt="image-20230212220211491" style="zoom:50%;">

<ol start="2">
<li>getRemoteUser: 该方法返回了当前登录用户的用户名,如果Authentication对象中存储的Principal是当前登录用户对象,则返回用户名;</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220651187.png" alt="image-20230212220651187" style="zoom:50%;">

<ol start="3">
<li>getUserPrincipal: 刚方法返回当前登录用户对象,其实就是Authentication的实例</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212220803330.png" alt="image-20230212220803330" style="zoom:50%;">

<ol start="4">
<li>isGranted: 该方法是一个私有的方法,作业是判断当前登录用户是否具备某个指定的角色.判断逻辑也很简单,先对传入的角色进行预处理,有的情况可能需要添加ROLE_前缀,然后调用Authentication#getAuthorities方法,获取当前登录用户所具备的所有角色,最后再和传入进来的参数进行比较</li>
</ol>
<img src="/2022/01/26/SpringSecurity/image-20230212221126723.png" alt="image-20230212221126723" style="zoom:50%;">

<ol start="5">
<li>isUserInRole: 该方法调用isGranted方法,进而实现判断当前用户是否具备某个指定角色的功能</li>
</ol>
<p>我们用HttpServletRequest就可以获取到很多信息了:</p>
<img src="/2022/01/26/SpringSecurity/image-20230212221335962.png" alt="image-20230212221335962" style="zoom:50%;">

<p>​	前面我们直接讲Authentication或者Principal写到Controller参数中,实际上就是Spring MVC框架从Servlet3SecurityContextHolderAwareRequestWrapper中提取的用户信息.</p>
<p>​	那么SpringSecurity怎么讲默认的请求对象包装成Servlet3SecurityContextHolderAwareRequestWrapper的呢?就涉及到另一个重要的过滤器:SecurityContextHolderAwareRequestFilter</p>
<h4 id="页面上获取用户信息"><a href="#页面上获取用户信息" class="headerlink" title="页面上获取用户信息"></a>页面上获取用户信息</h4><ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>页面加入命名空间</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>页面中使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--获取认证用户名--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.username&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.authorities&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.accountNonExpired&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.accountNonLocked&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.credentialsNonExpired&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="自定义认证数据源"><a href="#自定义认证数据源" class="headerlink" title="自定义认证数据源"></a>自定义认证数据源</h3><h4 id="认证流程分析"><a href="#认证流程分析" class="headerlink" title="认证流程分析"></a>认证流程分析</h4><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060526805.png" class title="image-20220118060526805">

<ul>
<li>发起认证请求，请求中携带用户名、密码，该请求会被<code>UsernamePasswordAuthenticationFilter</code> 拦截(准确是AbstractProcessingFilter)</li>
<li>在<code>UsernamePasswordAuthenticationFilter</code>的<code>attemptAuthentication</code>方法中将请求中用户名和密码，封装为<code>Authentication</code>对象，并交给<code>AuthenticationManager</code> 进行认证</li>
<li>认证成功，将认证信息存储到 SecurityContextHodler 以及调用记住我等，并回调 <code>AuthenticationSuccessHandler</code> 处理</li>
<li>认证失败，清除 SecurityContextHolder 以及 记住我中信息，回调 <code>AuthenticationFailureHandler</code> 处理</li>
</ul>
<h4 id="三者关系"><a href="#三者关系" class="headerlink" title="三者关系"></a>三者关系</h4><p>从上面分析中得知，AuthenticationManager 是认证的核心类，但实际上在底层真正认证时还离不开 ProviderManager 以及  AuthenticationProvider 。他们三者关系是样的呢？</p>
<ul>
<li><code>AuthenticationManager</code> 是一个认证管理器，它定义了 Spring Security 过滤器要执行认证操作。</li>
<li><code>ProviderManager</code> AuthenticationManager接口的实现类。Spring Security 认证时默认使用就是 ProviderManager。</li>
<li><code>AuthenticationProvider</code> 就是针对不同的身份类型执行的具体的身份认证。</li>
</ul>
<p><strong>AuthenticationManager 与 ProviderManager</strong></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061756972.png" class title="image-20220118061756972">

<p>​	ProviderManager 是 AuthenticationManager 的唯一实现，也是 Spring Security 默认使用实现。从这里不难看出默认情况下AuthenticationManager 就是一个ProviderManager。</p>
<p><strong>ProviderManager 与 AuthenticationProvider</strong></p>
<p>摘自官方: <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118060824066.png" class title="image-20220118060824066">



<p>​	在 Spring Security 中，允许系统同时支持多种不同的认证方式，例如同时支持用户名&#x2F;密码认证、ReremberMe 认证、手机号码动态认证等，而不同的认证方式对应了不同的 AuthenticationProvider，所以一个完整的认证流程可能由多个 AuthenticationProvider 来提供。</p>
<p>​	多个 AuthenticationProvider 将组成一个列表，这个列表将由 ProviderManager 代理。换句话说，在ProviderManager 中存在一个 AuthenticationProvider 列表，在Provider Manager 中遍历列表中的每一个 AuthenticationProvider 去执行身份认证，最终得到认证结果。</p>
<p>​	ProviderManager 本身也可以再配置一个 AuthenticationManager 作为 parent，这样当ProviderManager 认证失败之后，就可以进入到 parent 中再次进行认证。理论上来说，ProviderManager 的 parent 可以是任意类型的 AuthenticationManager，但是通常都是由<br>ProviderManager 来扮演 parent 的角色，也就是 ProviderManager 是 ProviderManager 的 parent。</p>
<p>​	ProviderManager 本身也可以有多个，多个ProviderManager 共用同一个 parent。有时，一个应用程序有受保护资源的逻辑组（例如，所有符合路径模式的网络资源，如&#x2F;api&#x2F;**），每个组可以有自己的专用 AuthenticationManager。通常，每个组都是一个ProviderManager，它们共享一个父级。然后，父级是一种 <code>全局</code>资源，作为所有提供者的后备资源。</p>
<p>根据上面的介绍，我们绘出新的 AuthenticationManager、ProvideManager 和 AuthentictionProvider 关系</p>
<p>摘自官网: <a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220118061343516.png" class title="image-20220118061343516">



<p> 弄清楚认证原理之后我们来看下具体认证时数据源的获取。<code>默认情况下 AuthenticationProvider  是由 DaoAuthenticationProvider 类来实现认证的，在DaoAuthenticationProvider 认证时又通过 UserDetailsService 完成数据源的校验。</code>他们之间调用关系如下：</p>
<img src="/2022/01/26/SpringSecurity/01/26/SpringSecurity/image-20220114163045543.png" class title="image-20220114163045543">

<p><strong>总结: AuthenticationManager 是认证管理器，在 Spring Security 中有全局AuthenticationManager，也可以有局部AuthenticationManager。全局的AuthenticationManager用来对全局认证进行处理，局部的AuthenticationManager用来对某些特殊资源认证处理。当然无论是全局认证管理器还是局部认证管理器都是由 ProviderManger 进行实现。 每一个ProviderManger中都代理一个AuthenticationProvider的列表，列表中每一个实现代表一种身份认证方式。认证时底层数据源需要调用 UserDetailService 来实现。</strong></p>
<h4 id="配置全局-AuthenticationManager"><a href="#配置全局-AuthenticationManager" class="headerlink" title="配置全局 AuthenticationManager"></a>配置全局 AuthenticationManager</h4><p><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<ul>
<li><p>默认的全局 AuthenticationManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(AuthenticationManagerBuilder builder)</span> &#123;</span><br><span class="line">    <span class="comment">//builder..</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>springboot 对 security 进行自动配置时自动在工厂中创建一个全局AuthenticationManager</li>
</ul>
<p><strong>总结</strong></p>
<ol>
<li>默认自动配置创建全局AuthenticationManager 默认找当前项目中是否存在自定义 UserDetailService 实例 自动将当前项目 UserDetailService 实例设置为数据源</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">       inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;aaa&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">       <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">//因为上面的UserDetailsService会覆盖默认的UserDetailsService，所以下一条语句不用写</span></span><br><span class="line">       <span class="comment">//builder.userDetailsService(userDetailsService());</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>默认自动配置创建全局AuthenticationManager 在工厂中使用时直接在代码中注入即可</li>
</ol>
</li>
<li><p>自定义全局 AuthenticationManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">    inMemoryUserDetailsManager.createUser(User.builder().username(<span class="string">&quot;gzzear&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;gaozhe&quot;</span>).build());</span><br><span class="line">    <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService(userDetailsService());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>总结</strong></p>
<ol>
<li>一旦通过 configure 方法自定义 AuthenticationManager实现 就回将工厂中自动配置AuthenticationManager（之前全局的） 进行覆盖</li>
<li>一旦通过 configure 方法自定义 AuthenticationManager实现 需要重新在实现中指定认证数据源对象 UserDetaiService 实例</li>
<li>一旦通过 configure 方法自定义 AuthenticationManager实现 这种方式创建AuthenticationManager对象工厂内部本地一个 AuthenticationManager 对象 不允许在其他自定义组件中进行注入</li>
</ol>
</li>
<li><p>用来在工厂中暴露自定义AuthenticationManager 实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//1.自定义AuthenticationManager  推荐  并没有在工厂中暴露出来</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;自定义AuthenticationManager: &quot;</span> + builder);</span><br><span class="line">        builder.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//作用: 用来将自定义AuthenticationManager在工厂中进行暴露,可以在任何位置注入</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="自定义内存数据源"><a href="#自定义内存数据源" class="headerlink" title="自定义内存数据源"></a>自定义内存数据源</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span></span><br><span class="line">                <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">u1</span> <span class="operator">=</span> User.withUsername(<span class="string">&quot;zhangs&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;&#123;noop&#125;111&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(u1);</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> </span><br><span class="line">      <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;  	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义数据库数据源"><a href="#自定义数据库数据源" class="headerlink" title="自定义数据库数据源"></a>自定义数据库数据源</h4><ul>
<li><p>设计表结构</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`</span><br><span class="line">(</span><br><span class="line">    `id`                    <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `username`              <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `password`              <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `enabled`               tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonExpired`     tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonLocked`      tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `credentialsNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 角色表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role`</span><br><span class="line">(</span><br><span class="line">    `id`      <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name_zh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 用户角色关系表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role`</span><br><span class="line">(</span><br><span class="line">    `id`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY   `uid` (`uid`),</span><br><span class="line">    KEY   `rid` (`rid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>插入测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入用户数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 插入角色数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_product&#x27;</span>, <span class="string">&#x27;商品管理员&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_admin&#x27;</span>, <span class="string">&#x27;系统管理员&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_user&#x27;</span>, <span class="string">&#x27;用户管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 插入用户角色数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>项目中引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 springboot 配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datasource</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># mybatis</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:com/baizhi/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.baizhi.entity</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># log</span></span><br><span class="line"><span class="attr">logging.level.com.baizhi</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 entity</p>
<ul>
<li><p>创建 user 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>  <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> Boolean credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        roles.forEach(role-&gt;grantedAuthorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName())));</span><br><span class="line">        <span class="keyword">return</span> grantedAuthorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//get/set....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 role 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line">  	<span class="comment">//get set..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>创建 UserDao 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">//根据用户名查询用户</span></span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">//根据用户id查询角色</span></span><br><span class="line">  	List&lt;Role&gt; <span class="title function_">getRolesByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 UserMapper 实现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--查询单个--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        select id,</span><br><span class="line">               username,</span><br><span class="line">               password,</span><br><span class="line">               enabled,</span><br><span class="line">               accountNonExpired,</span><br><span class="line">               accountNonLocked,</span><br><span class="line">               credentialsNonExpired</span><br><span class="line">        from user</span><br><span class="line">        where username = #&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--查询指定行数据--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRolesByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Role&quot;</span>&gt;</span></span><br><span class="line">        select r.id,</span><br><span class="line">               r.name,</span><br><span class="line">               r.name_zh nameZh #一定要重名，不然会为null</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where r.id = ur.rid</span><br><span class="line">          and ur.uid = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 UserDetailService 实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">final</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isEmpty(user))<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        user.setRoles(userDao.getRolesByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 authenticationManager 使用自定义UserDetailService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityConfigurer</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        builder.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	</span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">//web security..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试即可</p>
</li>
</ul>
<hr>
<h4 id="配置多数据源"><a href="#配置多数据源" class="headerlink" title="配置多数据源"></a>配置多数据源</h4><p>​	多个数据源是指在同 一个系统中，用户数据来自不同的表，在认证时，如果第 一张表没有查找到用户，那就去第二张表中查询，依次类推。</p>
<p>​	看了前面的分析，要实现这个需求就很容易了。认证要经过<strong>AuthenticationProvider</strong>，每 一 个<strong>AuthenticationProvider</strong> 中都配置了一个<strong>UserDetailsService</strong>，而不同的<strong>UserDetailsService</strong> 则可以代表不同的数据源。所以我们只需要手动配置多个 <strong>AuthenticationProvider</strong>，并为不同的<strong>AuthenticationProvider</strong> 提供不同的<strong>UserDetailsService</strong> 即可。</p>
<p>​	为了方便起见，这里通过<strong>InMemoryUserDetailsManager</strong> 来提供<strong>UserDetailsService</strong> 实例， 在实际开发中 ， 只需要将<strong>UserDetailsService</strong>换成自定义的 即可 ， 具体配置如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailService userDetailService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">inMemoryUserDetailService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(User.builder().username(<span class="string">&quot;gaozhe&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;gaozhe&quot;</span>).build());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">DaoAuthenticationProvider</span> <span class="variable">daoAuthenticationProvider1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaoAuthenticationProvider</span>();</span><br><span class="line">    daoAuthenticationProvider1.setUserDetailsService(userDetailService);</span><br><span class="line">    <span class="type">DaoAuthenticationProvider</span> <span class="variable">daoAuthenticationProvider2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaoAuthenticationProvider</span>();</span><br><span class="line">    daoAuthenticationProvider2.setUserDetailsService(inMemoryUserDetailService());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(daoAuthenticationProvider1, daoAuthenticationProvider2);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>首先定义了两个<strong>UserDetailsService</strong> 实例，不同实例中存储了不同的用户;然后重写 <strong>authenticationManagerBean</strong> 方法，在该方法中，定义了两个<strong>DaoAuthenticationProvider</strong> 实例并分别设置了不同的 <strong>UserDetailsService</strong> :最后构建 <strong>ProviderManager</strong> 实例并传入两个 <strong>DaoAuthenticationProvider</strong>。当系统进行身份认证操作时，就会遍历<strong>ProviderManager</strong> 中不同的 <strong>DaoAuthenticationProvider</strong>，进而调用到不同的数据源。</p>
<h3 id="添加认证验证码"><a href="#添加认证验证码" class="headerlink" title="添加认证验证码"></a>添加认证验证码</h3><h4 id="配置验证码"><a href="#配置验证码" class="headerlink" title="配置验证码"></a>配置验证码</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.Producer;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Producer <span class="title function_">kaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;150&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.string&quot;</span>, <span class="string">&quot;0123456789&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="传统-web-开发"><a href="#传统-web-开发" class="headerlink" title="传统 web 开发"></a>传统 web 开发</h4><ul>
<li><p>生成验证码 controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 验证码接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gaozhe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/2/4 下午5:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;验证码接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Producer kaptchaProducer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;验证码&quot;)</span></span><br><span class="line">  	<span class="comment">//produces配置数据类型及编码</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;captcha&quot;, method = RequestMethod.GET, produces = &quot;image/jpeg&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captcha</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">//设置缓存时间</span></span><br><span class="line">        response.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//设置不使用缓存</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-store, no-cache, must-revalidate&quot;</span>);</span><br><span class="line">        <span class="comment">//设置缓存更新时间间隔</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;post-check=0, pre-check=0&quot;</span>);</span><br><span class="line">        <span class="comment">//不设置缓存</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">        <span class="comment">//设置响应类型</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//--------------------生成验证码 begin--------------------</span></span><br><span class="line">        <span class="comment">//获取验证码文本内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> kaptchaProducer.createText();</span><br><span class="line">        log.info(<span class="string">&quot;验证码的内容是：&#123;&#125;&quot;</span>, verifyCode);</span><br><span class="line">        <span class="comment">//将验证码放入session中</span></span><br><span class="line">        request.getSession().setAttribute(<span class="string">&quot;captcha&quot;</span>, verifyCode);</span><br><span class="line">        <span class="comment">//根据验证码文本内容生成图像验证码</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> kaptchaProducer.createImage(verifyCode);</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = response.getOutputStream();</span><br><span class="line">            <span class="comment">//输出流输出图片，格式为jpg</span></span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, out);</span><br><span class="line">            out.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;验证码生成出错&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(out)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;验证码生成出错&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//--------------------生成验证码 end--------------------</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义验证码异常类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义filter验证验证码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">&quot;kaptcha&quot;</span>;<span class="comment">//默认值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> KAPTCHA_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptcha</span><span class="params">(String kaptcha)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kaptcha = kaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">//1.判断是否是 post 方式</span></span><br><span class="line">        <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.获取验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> request.getParameter(getKaptcha());</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionKaptcha</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionKaptcha) &amp;&amp;</span><br><span class="line">                kaptcha.equalsIgnoreCase(sessionKaptcha)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;验证码输入错误!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>放行以及配置验证码 filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityConfigurer</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        builder.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KaptchaFilter <span class="title function_">kaptchaFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KaptchaFilter</span> <span class="variable">kaptchaFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KaptchaFilter</span>();</span><br><span class="line">        <span class="comment">//指定接收验证码请求参数名</span></span><br><span class="line">        kaptchaFilter.setKaptcha(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="comment">//指定认证管理器</span></span><br><span class="line">        kaptchaFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">//指定认证成功和失败处理</span></span><br><span class="line">        kaptchaFilter.setAuthenticationSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>());</span><br><span class="line">        kaptchaFilter.setAuthenticationFailureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>());</span><br><span class="line">        <span class="comment">//指定处理登录</span></span><br><span class="line">        kaptchaFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);</span><br><span class="line">        kaptchaFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        kaptchaFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> kaptchaFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/vc.jpg&quot;</span>).permitAll()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">              	...</span><br><span class="line">        http.addFilterAt(kaptchaFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录页面添加验证码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    验证码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;kaptcha&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/vc.jpg&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="前后端分离开发"><a href="#前后端分离开发" class="headerlink" title="前后端分离开发"></a>前后端分离开发</h4><ul>
<li><p>生成验证码 controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> Producer producer;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/captcha&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">getVerifyCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1.生成验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> producer.createText();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="comment">//将验证码放入redis</span></span><br><span class="line">    redisUtil.set(BusinessConstant.CAPTCHA_KEY + key, code, <span class="number">2</span>,</span><br><span class="line">        TimeUnit.MINUTES);</span><br><span class="line">    log.info(<span class="string">&quot;验证码: &#123;&#125;&quot;</span>, code);</span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> producer.createImage(code);</span><br><span class="line">    <span class="comment">//2.写入内存</span></span><br><span class="line">    <span class="type">FastByteArrayOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastByteArrayOutputStream</span>();</span><br><span class="line">    ImageIO.write(bi, <span class="string">&quot;jpg&quot;</span>, fos);</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;data:image/jpeg;base64,&quot;</span>;</span><br><span class="line">    <span class="comment">//3.生成 base64</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">base64Img</span> <span class="operator">=</span> str + Base64.encodeBase64String(fos.toByteArray());</span><br><span class="line">    <span class="keyword">return</span> Result.succ(</span><br><span class="line">        MapUtil.builder()</span><br><span class="line">            .put(<span class="string">&quot;token&quot;</span>, key)</span><br><span class="line">            .put(<span class="string">&quot;captchaImg&quot;</span>, base64Img)</span><br><span class="line">            .build()</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义验证码异常类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在自定义LoginKaptchaFilter中加入验证码验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//自定义 filter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginKaptchaFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORM_KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">&quot;kaptcha&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptchaParameter</span> <span class="operator">=</span> FORM_KAPTCHA_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptchaParameter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kaptchaParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptchaParameter</span><span class="params">(String kaptchaParameter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kaptchaParameter = kaptchaParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.获取请求数据</span></span><br><span class="line">            Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> userInfo.get(getKaptchaParameter());<span class="comment">//用来获取数据中验证码</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());<span class="comment">//用来接收用户名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());<span class="comment">//用来接收密码</span></span><br><span class="line">            <span class="comment">//2.获取 session 中验证码</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sessionVerifyCode</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionVerifyCode) &amp;&amp;</span><br><span class="line">                    kaptcha.equalsIgnoreCase(sessionVerifyCode)) &#123;</span><br><span class="line">                <span class="comment">//3.获取用户名 和密码认证</span></span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;验证码不匹配!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义内存数据源</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginKaptchaFilter <span class="title function_">loginKaptchaFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">LoginKaptchaFilter</span> <span class="variable">loginKaptchaFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginKaptchaFilter</span>();</span><br><span class="line">        <span class="comment">//1.认证 url</span></span><br><span class="line">        loginKaptchaFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);</span><br><span class="line">        <span class="comment">//2.认证 接收参数</span></span><br><span class="line">        loginKaptchaFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        loginKaptchaFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">        loginKaptchaFilter.setKaptchaParameter(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="comment">//3.指定认证管理器</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">//4.指定成功时处理</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">            result.put(<span class="string">&quot;用户信息&quot;</span>, authentication.getPrincipal());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5.认证失败处理</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录失败: &quot;</span> + ex.getMessage());</span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> loginKaptchaFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/vc.jpg&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.getWriter().println(<span class="string">&quot;必须认证之后才能访问!&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line">        http.addFilterAt(loginKaptchaFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试验证</p>
</li>
</ul>
<h1 id="第四章-过滤器链分析"><a href="#第四章-过滤器链分析" class="headerlink" title="第四章 过滤器链分析"></a>第四章 过滤器链分析</h1><p>本章主要讲解SpringSecurity的初始化流程分析</p>
<h2 id="初始化流程分析"><a href="#初始化流程分析" class="headerlink" title="初始化流程分析"></a>初始化流程分析</h2><h3 id="ObjectPostProcessor"><a href="#ObjectPostProcessor" class="headerlink" title="ObjectPostProcessor"></a>ObjectPostProcessor</h3><p><strong>ObjectPostProcessor</strong>是Spring Security中使用频率很高的组件之一, 它是一个对象后置处理器, 也就是当一个对象创建成功后,如果还有一些额外的事情需要补充,那么可以通过<strong>ObjectPostProcessor</strong>来进行处理.这个接口默认只有一个方法<strong>postProcess</strong>, 该方法用来完成对对象的二次处理,代码如下:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215224147534.png" alt="image-20230215224147534" style="zoom:50%;">

<p>ObjectPostProcessor有两个默认实现:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215230305042.png" alt="image-20230215230305042" style="zoom:50%;">

<ul>
<li><strong>AutowireBeanFactoryObjectPostProcessor</strong>:  由于SpringSecurity中大量采用了Java配置, 许多过滤器都是直接new出来的, 这些直接new出来的对象并不会自动注入到Spring容器中.SpringSecurity这样做的本意是为了简化配置,但是却带来了另外一个问题就是, 大量new出来的对象需要我们手动注册到Spring容器中去. AutowireBeanFactoryObjectPostProcessor对象所承担的就是这件事,一个对象new出来之后,只要调用AutowireBeanFactoryObjectPostProcessor#postProcessor方法就可以成功注入到Spring容器中, 它的实现原理就是通过调用Spring容器中的AutowireCapableBeanFactory对象将一个new出来的对象注入到Spring容器中去.</li>
<li><strong>CompositeObjectPostProcessor</strong>:  这是ObjectPostProcessor的另一个实现, 一个对象可以有一个后置处理器,开发者可以自定义多个对象后置处理器. CompositeObjectPostProcessor是一个组合的对象后置处理器, 它里面维护了一个List集合, 集合里面存放了某个对象后置处理器, 它里面维护了一个List集合, 集合里面存放了某个对象的所有后置处理器, 当需要执行对象的后置处理器时, 会遍历集合中的所有ObjectPostProcessor实例, 分别调用实例的postProcess方法进行对象后置处理. <strong>在SpringSecurity框架中, 最终使用的对象后置处理器其实就是CompositeObjectPostProcessor, 它里面的集合默认只有一个对象, 就是AutowireBeanFactoryObjectPostProcessor</strong></li>
</ul>
<p>​	在Spring Security中, 开发者可以灵活地配置项目中需要哪些Spring Security过滤器, 一旦选定过滤器之后, 每一个过滤器都会有一个对应的配置器, 叫做xxxConfigurer (例如: CorsConfigurer、CsrfConfigurer等), 过滤器都是在xxxConfigurer中new出来的, 然后在postProcess方法之后处理一遍, 就将这些过滤器注入到Spring容器中了.</p>
<p>​	这就是对象后置处理器ObjectPostProcessor的作用</p>
<h3 id="SecurityFilterChain"><a href="#SecurityFilterChain" class="headerlink" title="SecurityFilterChain"></a>SecurityFilterChain</h3><p>从名称上可以看出, SecurityFilterChain就是Spring Security中的过滤器链对象. 下面来看一下SecurityFilterChain的源码:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215232503921.png" alt="image-20230215232503921" style="zoom:50%;">

<p>可以看到, SecurityFilterChain中有两个方法:</p>
<ol>
<li>matches: 该方法用来判断request请求是否应该被当前过滤器链所处理</li>
<li>getFilters: 该方法返回一个List集合, 集合中存放的就是Spring Security中的过滤器.换言之, 如果matches方法返回true, 那么request请求就会在getFilters方法所返回的Filter集合中被处理</li>
</ol>
<p>​	 SecurityFilterChain只有一个默认的实现类就是DefaultSecurityFilterChain, 其中定义了两个属性, 并具体实现了SecurityFilterChain中的两个方法:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215233159036.png" alt="image-20230215233159036" style="zoom:50%;">

<p>​	可以看到, 在DefaultSecurityFilterChain的构造方法中, 需要传入两个对象, 一个是请求匹配器requestMatcher, 另一个则是过滤器集合或者过滤器数组filter. 这个实现类比较简单, 这里就不再赘述了</p>
<p>​	<span style="color:red;">注意:  在一个Spring Security项目中, SecurityFilterChain的实例可能会有多个.</span></p>
<h3 id="SecurityBuilder"><a href="#SecurityBuilder" class="headerlink" title="SecurityBuilder"></a>SecurityBuilder</h3><p>​	Spring Security中所有需要构建的对象都可以通过SecuriyBuilder来实现, 默认的过滤器链、代理过滤器、AuthenticationManager等, 都可以通过SecurityBuilder来构建. SecurityBuilder的实现类如下图所示:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215233755090.png" alt="image-20230215233755090" style="zoom:50%;">



<p>​	我们先来看下SecurityBuilder的源码:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215234327892.png" alt="image-20230215234327892" style="zoom:50%;">

<p>​	由上述代码可以看到, SecurityBuilder中只有一个build方法, 就是对象构建方法. build方法的返回值, 就是具体构建的对象泛型O, 也就是说不同的SecurityBuilder将来会构建出不同的对象</p>
<h3 id="HttpSecurityBuilder"><a href="#HttpSecurityBuilder" class="headerlink" title="HttpSecurityBuilder"></a>HttpSecurityBuilder</h3><p>HttpSecurityBuilder是用来构建HttpSecurity对象的, HttpSecurityBuilder的定义如下:</p>
<img src="/2022/01/26/SpringSecurity/image-20230215234757406.png" alt="image-20230215234757406" style="zoom:50%;">

<p>我们来简单分析下这段源码:</p>
<ol>
<li>HttpSecurityBuilder对象本身在定义时就有一个泛型, 这个泛型是HttpSecurityBuilder的子类, 由于默认情况下HttpSecurityBuilder的实现类只有一个HttpSecurity, 所以可以暂且把接口中的H都当成HttpSecurity来理解</li>
<li>HttpSecurityBuilder继承自SecurityBuilder接口, 同时也指定了SecurityBuilder中的泛型为DefaultSecurityFilterChain, 也就是说,HttpSecurityBuilder最终想要构建的对象是DefaultSecurityFilterChain</li>
<li>getConfigurer方法用来获取一个配置器, 所谓的配置器就是xxxConfigurer</li>
<li>removeConfigurer方法用来移除一个配置器(相当于从Spring Security过滤器链中移除一个过滤器)</li>
<li>setSharedObject &#x2F; getSharedObject这两个方法用来设置或者获取一个可以在多配置器之间共享的对象</li>
<li>authenticationProvider方法可以用来配置一个认证器AuthencationProvider</li>
<li>userDetailsService方法可以用来配置一个数据源UserDetailsService</li>
<li>addFilterAfter&#x2F;addFilterBefore方法表示在某个过滤器之后或者之前添加一个自定义的过滤器</li>
<li>addFilter方法可以添加一个过滤器, 这个过滤器必须是Spring Security框架提供的过滤器的一个实例或者其扩展, 添加完成之后, 会自动进行过滤器的排序</li>
</ol>
<h3 id="AbstractSecurityBuilder"><a href="#AbstractSecurityBuilder" class="headerlink" title="AbstractSecurityBuilder"></a>AbstractSecurityBuilder</h3><p>​	AbstractSecurityBuilder实现了SecurityBuilder接口, 并对build做了完善, 确保只build一次. 我们来看一下AbstractSecurityBuilder的源码:</p>
<img src="/2022/01/26/SpringSecurity/image-20230216000810983.png" alt="image-20230216000810983" style="zoom:50%;">

<p>由上述代码可以看到, 在AbstractSecurityBuilder类中:</p>
<ol>
<li>首先声明了building变量, 可以确保即使在多线程环境下, 配置类也只构建一次</li>
<li>对build方法进行重写, 并且设置为final,这样在AbstractSecurityBuilder的子类中将不能再次重写build方法. 在build方法内部, 通过building变量来控制配置类只构建一次, 具体的构建工作则交给doBuild方法去完成</li>
<li>getObject方法用来返回构建的对象</li>
<li>doBuild方法则是具体的构建方法, 该方法在AbstractSecurityBuilder中是一个抽象方法, 具体的实现在其子类中</li>
</ol>
<p>​		总而言之,AbstractSecurityBuilder确保在目标对象中只构建一次</p>
<h3 id="AbstractConfiguredSecurityBuilder"><a href="#AbstractConfiguredSecurityBuilder" class="headerlink" title="AbstractConfiguredSecurityBuilder"></a>AbstractConfiguredSecurityBuilder</h3><p>AbstractConfiguredSecurityBuilder类的源码就稍微长一点, 我们分别来看下.</p>
<p>首先在AbstractConfiguredSecurityBuilder中声明了一个枚举类, 用来描述构建过程的不同状态:</p>
<img src="/2022/01/26/SpringSecurity/image-20230216095646474.png" alt="image-20230216095646474" style="zoom:50%;">

<p>可以看到, 整个构建过程一共有五种不同的状态:</p>
<ul>
<li>UNBUILT: 配置类构建前</li>
<li>INITIALIZING: 初始化中 (初始化完成之前是这个状态)</li>
<li>CONFIGURING: 配置中 (开始构建之前是这个状态)</li>
<li>BUILDING: 构建中</li>
<li>BUILT: 构建完成</li>
</ul>
<p>这个枚举类里面还提供了两个判断方法, isInitializing表示是否正在初始化中, isConfigured方法表示是否已完成配置</p>
<p>AbstractConfiguredSecurityBuilder中还声明了configurers变量, 用来保存所有的配置类. 针对configurers变量, 我们可以进行添加配置、移除配置等操作, 相关方法如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractSecurityBuilder</span>&lt;O&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//首先声明了一个configurers变量, 用来保存所有的配置类, key是配置类Class对象, 值是一个List集合中放着配置类</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">final</span> LinkedHashMap&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;, List&lt;SecurityConfigurer&lt;O, B&gt;&gt;&gt; configurers = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;O, B&gt;&gt; C <span class="title function_">apply</span><span class="params">(C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		configurer.addObjectPostProcessor(<span class="built_in">this</span>.objectPostProcessor);</span><br><span class="line">		configurer.setBuilder((B) <span class="built_in">this</span>);</span><br><span class="line">		add(configurer);</span><br><span class="line">		<span class="keyword">return</span> configurer;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">apply</span><span class="params">(C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		add(configurer);</span><br><span class="line">		<span class="keyword">return</span> configurer;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(C configurer)</span> &#123;</span><br><span class="line">		Assert.notNull(configurer, <span class="string">&quot;configurer cannot be null&quot;</span>);</span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; clazz = (Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;) configurer</span><br><span class="line">				.getClass();</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="built_in">this</span>.configurers) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.buildState.isConfigured()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot apply &quot;</span> + configurer + <span class="string">&quot; to already built object&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.allowConfigurersOfSameType) &#123;</span><br><span class="line">				configs = <span class="built_in">this</span>.configurers.get(clazz);</span><br><span class="line">			&#125;</span><br><span class="line">			configs = (configs != <span class="literal">null</span>) ? configs : <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">			configs.add(configurer);</span><br><span class="line">			<span class="built_in">this</span>.configurers.put(clazz, configs);</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.buildState.isInitializing()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.configurersAddedInInitializing.add(configurer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="title function_">getConfigurers</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="built_in">this</span>.configurers.get(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(configs);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="title function_">removeConfigurers</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="built_in">this</span>.configurers.remove(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(configs);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">getConfigurer</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="built_in">this</span>.configurers.get(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Assert.state(configs.size() == <span class="number">1</span>,</span><br><span class="line">				() -&gt; <span class="string">&quot;Only one configurer expected for type &quot;</span> + clazz + <span class="string">&quot;, but got &quot;</span> + configs);</span><br><span class="line">		<span class="keyword">return</span> (C) configs.get(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">removeConfigurer</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="built_in">this</span>.configurers.remove(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Assert.state(configs.size() == <span class="number">1</span>,</span><br><span class="line">				() -&gt; <span class="string">&quot;Only one configurer expected for type &quot;</span> + clazz + <span class="string">&quot;, but got &quot;</span> + configs);</span><br><span class="line">		<span class="keyword">return</span> (C) configs.get(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>我们来解析一下这段源码:</p>
<ol>
<li>首先声明了一个configurers变量, 用来保存所有的配置类, key是配置类Class对象, 值是一个List集合中放着配置类</li>
<li>apply方法有两个,参数类型差不多, 主要功能基本一致, 都是向configurers变量中添加配置类, 具体的添加过程则是调用add方法.</li>
<li>add方法用来将所有的配置类保存在configurers中, 在添加的过程中, 如果allowConfigurersOfSameType变量为true, 则表示允许相同类型的配置存在, 也就是List集合中可以存在多个相同类型的配置类. 默认情况下, 如果是普通配置类, allowConfigurersOfSameType是false, 所以List集合中的配置类始终只有一个配置类; 如果在AuthenticationManagerBuilder中设置allowConfigurersOfSameType为true, 此时相同类型的配置类可以有多个 (后文会详细介绍)</li>
<li>getConfigurers(Class<C>) 方法可以从configurers中返回某个配置类对应的所有实例</C></li>
<li>removeConfigurers方法可以从configurers中移除某一个配置类对应的所有实例, 并返回被移除掉的配置类实例集合</li>
</ol>
<p>这些就是AbstractConfiguredSecurityBuilder中关于configurers的所有操作</p>
<p>接下来就是AbstractConfiguredSecurityBuilder中的doBuild方法了, 这是核心的构建方法, 我们一起来看一下相应方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Executes the build using the &#123;<span class="doctag">@link</span> SecurityConfigurer&#125;&#x27;s that have been applied</span></span><br><span class="line"><span class="comment"> * using the following steps:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invokes &#123;<span class="doctag">@link</span> #beforeInit()&#125; for any subclass to hook into&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invokes &#123;<span class="doctag">@link</span> SecurityConfigurer#init(SecurityBuilder)&#125; for any</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> SecurityConfigurer&#125; that was applied to this builder.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invokes &#123;<span class="doctag">@link</span> #beforeConfigure()&#125; for any subclass to hook into&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invokes &#123;<span class="doctag">@link</span> #performBuild()&#125; which actually builds the Object&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> O <span class="title function_">doBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="built_in">this</span>.configurers) &#123;</span><br><span class="line">		<span class="built_in">this</span>.buildState = BuildState.INITIALIZING;</span><br><span class="line">		beforeInit();</span><br><span class="line">		init();</span><br><span class="line">		<span class="built_in">this</span>.buildState = BuildState.CONFIGURING;</span><br><span class="line">		beforeConfigure();</span><br><span class="line">		configure();</span><br><span class="line">		<span class="built_in">this</span>.buildState = BuildState.BUILDING;</span><br><span class="line">		<span class="type">O</span> <span class="variable">result</span> <span class="operator">=</span> performBuild();</span><br><span class="line">		<span class="built_in">this</span>.buildState = BuildState.BUILT;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoked prior to invoking each &#123;<span class="doctag">@link</span> SecurityConfigurer#init(SecurityBuilder)&#125;</span></span><br><span class="line"><span class="comment"> * method. Subclasses may override this method to hook into the lifecycle without</span></span><br><span class="line"><span class="comment"> * using a &#123;<span class="doctag">@link</span> SecurityConfigurer&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeInit</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoked prior to invoking each</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> SecurityConfigurer#configure(SecurityBuilder)&#125; method. Subclasses may</span></span><br><span class="line"><span class="comment"> * override this method to hook into the lifecycle without using a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> SecurityConfigurer&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeConfigure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses must implement this method to build the object that is being returned.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the Object to be buit or null if the implementation allows it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> O <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();</span><br><span class="line">	<span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;</span><br><span class="line">		configurer.init((B) <span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : <span class="built_in">this</span>.configurersAddedInInitializing) &#123;</span><br><span class="line">		configurer.init((B) <span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();</span><br><span class="line">	<span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;</span><br><span class="line">		configurer.configure((B) <span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li>在doBuild方法中, 一边更新构建状态, 一边执行构建方法. 构建方法中, beforeInit是一个空的初始化方法, 如果需要在初始化之前做一些准备工作, 可以通过重写该方法来实现.</li>
<li>init方法是所有配置类的初始化方法, 在该方法中, 遍历所有的配置类, 并调用其init方法完成初始化操作</li>
<li>beforeConfigure方法可以在configure方法执行之前做一些准备操作. 该方法默认也是一个空方法.</li>
<li>configure方法用来完成所有配置类的配置, 在configure方法中, 遍历所有的配置类, 分别调用其configure方法来完成配置</li>
<li>performBuild方法用来做最终的构建操作, 前面的准备工作完成之后, 最后在performBuild方法之后完成构建, 这是一个抽象方法, 具体的实现则在不同的配置类中.</li>
</ol>
<h3 id="ProviderManagerBuilder"><a href="#ProviderManagerBuilder" class="headerlink" title="ProviderManagerBuilder"></a>ProviderManagerBuilder</h3><p>ProviderManagerBuilder继承自SecurityBuilder接口, 并制定了构建的对象是AuthenticationManager, 代码如下:<img src="/2022/01/26/SpringSecurity/image-20230216105112662.png" alt="image-20230216105112662" style="zoom:50%;"></p>
<p>可以看到, ProviderManagerBuilder中增加了一个authenticationProvider方法, 同时通过泛型指定了构建的对象为AuthenticationManager</p>
<h3 id="AuthenticationManagerBuilder"><a href="#AuthenticationManagerBuilder" class="headerlink" title="AuthenticationManagerBuilder"></a>AuthenticationManagerBuilder</h3><p>AuthenticationManagerBuilder用来构建AuthenticationManager对象, 它继承自AbstractConfiguredSecurityBuilder, 并且实现了ProviderManagerBuilder接口, 源码比较长, 我们截取部分代码, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationManagerBuilder</span></span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;AuthenticationManager, AuthenticationManagerBuilder&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">ProviderManagerBuilder</span>&lt;AuthenticationManagerBuilder&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">AuthenticationManagerBuilder</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(objectPostProcessor, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">parentAuthenticationManager</span><span class="params">(AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (authenticationManager <span class="keyword">instanceof</span> ProviderManager) &#123;</span><br><span class="line">			eraseCredentials(((ProviderManager) authenticationManager).isEraseCredentialsAfterAuthentication());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.parentAuthenticationManager = authenticationManager;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> InMemoryUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="title function_">inMemoryAuthentication</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManagerConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> JdbcUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="title function_">jdbcAuthentication</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">JdbcUserDetailsManagerConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">UserDetailsService</span>&gt; DaoAuthenticationConfigurer&lt;AuthenticationManagerBuilder, T&gt; <span class="title function_">userDetailsService</span><span class="params">(</span></span><br><span class="line"><span class="params">			T userDetailsService)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="built_in">this</span>.defaultUserDetailsService = userDetailsService;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">DaoAuthenticationConfigurer</span>&lt;&gt;(userDetailsService));</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">authenticationProvider</span><span class="params">(AuthenticationProvider authenticationProvider)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.authenticationProviders.add(authenticationProvider);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ProviderManager <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isConfigured()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ProviderManager</span> <span class="variable">providerManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(<span class="built_in">this</span>.authenticationProviders,</span><br><span class="line">				<span class="built_in">this</span>.parentAuthenticationManager);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.eraseCredentials != <span class="literal">null</span>) &#123;</span><br><span class="line">			providerManager.setEraseCredentialsAfterAuthentication(<span class="built_in">this</span>.eraseCredentials);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">			providerManager.setAuthenticationEventPublisher(<span class="built_in">this</span>.eventPublisher);</span><br><span class="line">		&#125;</span><br><span class="line">		providerManager = postProcess(providerManager);</span><br><span class="line">		<span class="keyword">return</span> providerManager;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li>首先在AuthenticationManagerBuilder的构造方法中, 调用了父类的构造方法, 注意第二个参数传递了true, 表示允许相同类型的配置类同时存在(结合AbstractConfiguredSecurityBuilder的源码来理解)</li>
<li>parentAuthenticationManager方法来给一个AuthenticationManager设置parent</li>
<li>inMemoryAuthentication方法来配置基于内存的数据源, 该方法会自动创建InMemoryUserDetailsManagerConfigurer配置类, 并最终将该配置类添加到父类的configurers变量中.由于设置了允许相同类型的配置类同时存在, 因此inMemoryAuthentication方法可以反复调用多次.</li>
<li>jdbcAuthentication以及userDetailsService方法与inMemoryAuthentication方法类似, 也就是用来配置数据源的, 就不再赘述</li>
<li>authenticationProvider方法用来向authenticationProviders集合中添加Authentication Provider对象, 根据之前的讲解, 我们已经知道一个AuthenticationManager实例中包含了多个AuthenticationProvider实例, 那么多个AuthenticationProvider实例可以通过authenticationProvider方法来进行添加</li>
<li>performBuild方法则是执行具体的构建方法, 常用的AuthenticationManager实例就是ProviderManager, 所以这里创建ProviderManager对象, 并且配置authenticationProviders和parentAuthenticationManager对象, ProviderManager对象创建成功之后,再去对象后置处理器中处理一遍再返回</li>
</ol>
<p>这就是AuthenticationManagerBuilder的大致逻辑</p>
<h3 id="HttpSecurity"><a href="#HttpSecurity" class="headerlink" title="HttpSecurity"></a>HttpSecurity</h3><p>​	<strong>HttpSecurity</strong>的主要作用是用来构建一条过滤器链, 并反映到代码上,也就是构建一个<strong>DefaultSecurityFilterChain</strong>对象. 一个<strong>DefaultSecurityChain</strong>对象包含一个路径匹配器和多个<strong>SpringSecurity</strong>过滤器, <strong>HttpSecurity</strong>中通过收集各种各样的<strong>xxxConfigurer,</strong> 将<strong>Spring Security</strong>过滤器对应的配置类收集起来, 并保存到父类<strong>AbstractConfiguredSecurityBuilder</strong>的<strong>configurers</strong>变量中, 在后续的构建过程中, 再将这些<strong>xxxConfigurer</strong>构建为具体的<strong>Spring Security</strong>的过滤器,  同时添加到<strong>HttpSecurity</strong>的<strong>filters</strong>对象中.</p>
<p>​	由于<strong>HttpSecurity</strong>中存在大量功能类似的方法, 因此这里挑选一个作为例子来说明<strong>HttpSecurity</strong>的配置原理, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HttpSecurity</span> <span class="keyword">extends</span> <span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt;, HttpSecurityBuilder&lt;HttpSecurity&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="number">1.</span> 以form表单登录配置为例, 在HttpSecurity中有两个重载方法可以进行配置: 第一个是一个无参, 该方法的返回值是一个FormLoginConfigurer&lt;HttpSecurity&gt;对象, 开发者可以在该对象的基础上继续完善对form表单的配置, 我们在后续中配置的表单登录都是通过这种方式来进行配置的.</span><br><span class="line">  <span class="keyword">public</span> FormLoginConfigurer&lt;HttpSecurity&gt; <span class="title function_">formLogin</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">FormLoginConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  第二个是一个有参的formLogin方法, 该方法的参数是一个FormLoginConfigurer对象, 返回值则是一个HttpSecurity对象, 也就是说开发者可以提前在外面配置好FormLoginConfigurer对象, 然后直接传进来进行配置即可, 返回值HttpSecurity对象则可以在方法返回后直接进行其他过滤器的配置. 无论是有参或者无参, 最终都会调用getOrApply方法, 该方法会调用父类的getConfigurer方法去查看是否已经有对应的配置类了,如果有,则直接返回; 如果没有,则调用apply方法添加到父类的configurers变量中. HttpSecurity中其他过滤器的配置都和form表单登录配置类似, 这里就不赘述了</span><br><span class="line">  <span class="keyword">public</span> HttpSecurity <span class="title function_">formLogin</span><span class="params">(Customizer&lt;FormLoginConfigurer&lt;HttpSecurity&gt;&gt; formLoginCustomizer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		formLoginCustomizer.customize(getOrApply(<span class="keyword">new</span> <span class="title class_">FormLoginConfigurer</span>&lt;&gt;()));</span><br><span class="line">		<span class="keyword">return</span> HttpSecurity.<span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="number">2.</span> 每一套过滤器链都会有一个AuthenticationManager对象来进行认证操作(如果认证失败,就会调用AuthenticationManager的parent再次进行认证),主要是通过authenticationProvider方法配置执行认证的authenticationProvider对象</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> HttpSecurity <span class="title function_">authenticationProvider</span><span class="params">(AuthenticationProvider authenticationProvider)</span> &#123;</span><br><span class="line">		getAuthenticationRegistry().authenticationProvider(authenticationProvider);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  通过userDetailsService方法配置UserDetailsService</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> HttpSecurity <span class="title function_">userDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		getAuthenticationRegistry().userDetailsService(userDetailsService);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> AuthenticationManagerBuilder <span class="title function_">getAuthenticationRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getSharedObject(AuthenticationManagerBuilder.class);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  最后在beforeConfigurer方法中触发AuthenticationManager对象的构建.</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeConfigure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		setSharedObject(AuthenticationManager.class, getAuthenticationRegistry().build());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="number">3.</span> performBuild方法则是进行DefalutSecurityFilterChain对象的构建, 传入请求匹配器和过滤器集合filters, 在构建之前, 会先按照既定的顺序对filters进行排序</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> DefaultSecurityFilterChain <span class="title function_">performBuild</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.filters.sort(<span class="built_in">this</span>.comparator);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSecurityFilterChain</span>(<span class="built_in">this</span>.requestMatcher, <span class="built_in">this</span>.filters);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="number">4.</span> 通过addFilter、addFilterBefore两个方法, 我们可以在某个过滤器之后或者之前添加一个自定义的过滤器</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> HttpSecurity <span class="title function_">addFilterBefore</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; beforeFilter)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.comparator.registerBefore(filter.getClass(), beforeFilter);</span><br><span class="line">		<span class="keyword">return</span> addFilter(filter);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> HttpSecurity <span class="title function_">addFilter</span><span class="params">(Filter filter)</span> &#123;</span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> <span class="title class_">Filter</span>&gt; filterClass = filter.getClass();</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.comparator.isRegistered(filterClass)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;The Filter class &quot;</span> + filterClass.getName()</span><br><span class="line">					+ <span class="string">&quot; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.filters.add(filter);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line"> <span class="number">6.</span> addFilterAt方法可以在指定的位置添加一个过滤器. 需要注意的是, 在同一个位置添加多个过滤器不会覆盖现有的过滤器</span><br><span class="line">  <span class="keyword">public</span> HttpSecurity <span class="title function_">addFilterAt</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; atFilter)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.comparator.registerAt(filter.getClass(), atFilter);</span><br><span class="line">		<span class="keyword">return</span> addFilter(filter);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;&gt; C <span class="title function_">getOrApply</span><span class="params">(C configurer)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">C</span> <span class="variable">existingConfig</span> <span class="operator">=</span> (C) getConfigurer(configurer.getClass());</span><br><span class="line">		<span class="keyword">if</span> (existingConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> existingConfig;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> apply(configurer);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>这就是HttpSecurity基本的功能</p>
<h3 id="WebSecurity"><a href="#WebSecurity" class="headerlink" title="WebSecurity"></a>WebSecurity</h3><p>​	相对于<strong>HttpSecurity</strong>,  <strong>WebSecurity</strong>是在一个更大的层面上去构建过滤器. 一个<strong>HttpSecurity</strong>对象可以构建一个过滤器链, 也就是说一个<strong>DefaultSecurityFilterChain</strong>对象,而一个项目中可以存在多个<strong>HttpSecurity</strong>对象, 也就是说可以构建多个<strong>DefaultSecurityFilterChain</strong>过滤器链</p>
<p>​	<strong>WebSecurity</strong>负责将<strong>HttpSecurity</strong>所构建的<strong>DefaultSecurityFilterChain</strong>对象(可能有多个), 以及其他需要忽略的请求, 再次重新构建为一次<strong>FilterChainProxy</strong>对象, 同时添加上HTTP防火墙</p>
<p>​	我们来看下<strong>WebSecurity</strong>中的几个关键方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WebSecurity</span> <span class="keyword">extends</span> <span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;Filter, WebSecurity&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">SecurityBuilder</span>&lt;Filter&gt;, ApplicationContextAware &#123;</span><br><span class="line">  </span><br><span class="line">  	<span class="number">1.</span> 首先在WebSecurity中声明了ignoredRequests集合, 这个集合中保存了所有被忽略的请求, 因为在实际的项目中, 并非所有的请求都需要经过Spring Security过滤器链, 有一些静态资源可能不需要权限认证, 直接返回给客户端即可, 那么这些需要忽略的请求可以直接保存在ignoredRequests变量中</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;RequestMatcher&gt; ignoredRequests = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  	<span class="number">2.</span> 接下来声明了个securityFilterChainBuilders集合, 该集合用来保存所有的HttpSecurity对象, 每一个HttpSecurity对象创建成功之后, 通过addSecurityFilterChainBuilder方法将HttpSecurity对象添加到securityFilterChainBuilders中</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SecurityBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityFilterChain</span>&gt;&gt; securityFilterChainBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">  	<span class="number">3.</span> httpFirewall方法可以用来配置请求防火墙</span><br><span class="line">  <span class="keyword">public</span> WebSecurity <span class="title function_">httpFirewall</span><span class="params">(HttpFirewall httpFirewall)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.httpFirewall = httpFirewall;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> WebSecurity <span class="title function_">addSecurityFilterChainBuilder</span><span class="params">(</span></span><br><span class="line"><span class="params">			SecurityBuilder&lt;? extends SecurityFilterChain&gt; securityFilterChainBuilder)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.securityFilterChainBuilders.add(securityFilterChainBuilder);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="number">4.</span> 是具体的构造方法, 在该方法中, 首先统计出过滤器链的总数(被忽略的请求个数+通过HttpSecurity创建出来的过滤器链个数),然后创建一个集合securityFilterChains, 遍历被忽略的请求并分别构建成DefaultSecurityFilterChain对象保存在securityFilterChains集合中. 需要注意的是, 对于被忽略的请求,在构建DefaultSecurityFilterChain对象时,只是传了请求匹配器, 而没有传入对应的过滤器链, 这就意味着这些被忽略掉的请求, 将来不必经过SpringSecurity过滤器链; 接下来再遍历securityFilterChainBuilders集合, 调用每个对象的build方法去创建DefaultFilterChain并存入securityFilterChains集合中, 然后传入securityFilterChains集合构建FilterChainProxy对象,最后再设置HTTP防火墙. 所有设置完成之后,最后返回filterChainProxy对象</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Filter <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		Assert.state(!<span class="built_in">this</span>.securityFilterChainBuilders.isEmpty(),</span><br><span class="line">				() -&gt; <span class="string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span></span><br><span class="line">						+ <span class="string">&quot;Typically this is done by exposing a SecurityFilterChain bean &quot;</span></span><br><span class="line">						+ <span class="string">&quot;or by adding a @Configuration that extends WebSecurityConfigurerAdapter. &quot;</span></span><br><span class="line">						+ <span class="string">&quot;More advanced users can invoke &quot;</span> + WebSecurity.class.getSimpleName()</span><br><span class="line">						+ <span class="string">&quot;.addSecurityFilterChainBuilder directly&quot;</span>);</span><br><span class="line">		<span class="type">int</span> <span class="variable">chainSize</span> <span class="operator">=</span> <span class="built_in">this</span>.ignoredRequests.size() + <span class="built_in">this</span>.securityFilterChainBuilders.size();</span><br><span class="line">		List&lt;SecurityFilterChain&gt; securityFilterChains = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(chainSize);</span><br><span class="line">		<span class="keyword">for</span> (RequestMatcher ignoredRequest : <span class="built_in">this</span>.ignoredRequests) &#123;</span><br><span class="line">			securityFilterChains.add(<span class="keyword">new</span> <span class="title class_">DefaultSecurityFilterChain</span>(ignoredRequest));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (SecurityBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityFilterChain</span>&gt; securityFilterChainBuilder : <span class="built_in">this</span>.securityFilterChainBuilders) &#123;</span><br><span class="line">			securityFilterChains.add(securityFilterChainBuilder.build());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">FilterChainProxy</span> <span class="variable">filterChainProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterChainProxy</span>(securityFilterChains);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.httpFirewall != <span class="literal">null</span>) &#123;</span><br><span class="line">			filterChainProxy.setFirewall(<span class="built_in">this</span>.httpFirewall);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.requestRejectedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">			filterChainProxy.setRequestRejectedHandler(<span class="built_in">this</span>.requestRejectedHandler);</span><br><span class="line">		&#125;</span><br><span class="line">		filterChainProxy.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">		<span class="type">Filter</span> <span class="variable">result</span> <span class="operator">=</span> filterChainProxy;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.debugEnabled) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.warn(<span class="string">&quot;\n\n&quot;</span> + <span class="string">&quot;********************************************************************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********    This may include sensitive information.  *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********      Do not use in a production system!     *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;********************************************************************\n\n&quot;</span>);</span><br><span class="line">			result = <span class="keyword">new</span> <span class="title class_">DebugFilter</span>(filterChainProxy);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.postBuildAction.run();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>​	<strong>FilterChainProxy</strong>就是我们最终构建出来的代理过滤器链, 通过Spring提供<strong>Delegating</strong> <strong>FilterProxy</strong>将<strong>FilterChainProxy</strong>对象嵌入到Web Filter中(原生的过滤器链中)</p>
<h3 id="SecurityConfigurer"><a href="#SecurityConfigurer" class="headerlink" title="SecurityConfigurer"></a>SecurityConfigurer</h3><p>​		<strong>SecurityConfigurer</strong>中有两个核心方法, 一个是<strong>init</strong>方法, 用来完成配置类的初始化操作, 另外一个是<strong>configure</strong>方法, 进行配置类的配置. 之前介绍过的<strong>AbstractConfiguredSecurityBuilder</strong>类, 里面的<strong>init</strong>方法和<strong>configure</strong>其实就是在遍历执行不同配置类的<strong>init</strong>和<strong>configure</strong>方法.</p>
<p>​	<strong>SecurityConfigurer</strong>的实现类比较多, 这里主要梳理一下常见的<strong>SecurityConfigurer</strong>实现类,我们可以分别来看下一下:</p>
<p>​	先来看下<strong>SecurityConfigurer</strong>源码, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Initialize the &#123;<span class="doctag">@link</span> SecurityBuilder&#125;. Here only shared state should be created</span></span><br><span class="line"><span class="comment">	 * and modified, but not properties on the &#123;<span class="doctag">@link</span> SecurityBuilder&#125; used for building</span></span><br><span class="line"><span class="comment">	 * the object. This ensures that the &#123;<span class="doctag">@link</span> #configure(SecurityBuilder)&#125; method uses</span></span><br><span class="line"><span class="comment">	 * the correct shared objects when building. Configurers should be applied here.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">init</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure the &#123;<span class="doctag">@link</span> SecurityBuilder&#125; by setting the necessary properties on the</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> SecurityBuilder&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, <strong>SecurityConfigurer</strong>只有两个方法: <strong>init</strong>和<strong>configure</strong>, 两个方法的参数都是<strong>SecurityBuilder</strong>对象, 也就是说在这两个方法中对<strong>SecurityBuilder</strong>进行初始话和配置.</p>
<p>​	<strong>SecurityConfigurer</strong>的子类非常多, 因为每一个过滤器都有自己对应的<strong>xxxConfigurer</strong>, 这里着重介绍几个关键的实现类, 如图所示:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230312213646207.png" alt="image-20230312213646207"></p>
<p>我们分别来看下实现:</p>
<h4 id="SecurityConfigurerAdapter"><a href="#SecurityConfigurerAdapter" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h4><p>​	实现了SecurityConfigurer接口, 它的源码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt; <span class="keyword">implements</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="number">1.</span> 提供了一个SecurityBuilder对象, 为每一个配置类都提供了一个SecurityBuilder对象, 将来通过SecurityBuilder构建出具体的配置对象; 通过and方法返回SecurityBuilder对象, 这样方便不同的配置类在配置时, 可以进行链式配置</span><br><span class="line">  <span class="keyword">private</span> B securityBuilder;</span><br><span class="line"></span><br><span class="line">  <span class="number">2.</span> 定义了内部类CompositeObjectPostProcessor, 这是一个复合的对象后置处理器</span><br><span class="line">	<span class="keyword">private</span> <span class="type">CompositeObjectPostProcessor</span> <span class="variable">objectPostProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompositeObjectPostProcessor</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> B <span class="title function_">and</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getBuilder();</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> B <span class="title function_">getBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">		Assert.state(<span class="built_in">this</span>.securityBuilder != <span class="literal">null</span>, <span class="string">&quot;securityBuilder cannot be null&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.securityBuilder;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">postProcess</span><span class="params">(T object)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (T) <span class="built_in">this</span>.objectPostProcessor.postProcess(object);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="number">3.</span> 提供了一个addObjectPostProcessor方法, 通过该方法可以像复合的对象后置处理器中添加新的ObjectPostProcessor实例</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObjectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.objectPostProcessor.addObjectPostProcessor(objectPostProcessor);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBuilder</span><span class="params">(B builder)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.securityBuilder = builder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CompositeObjectPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">ObjectPostProcessor</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> List&lt;ObjectPostProcessor&lt;?&gt;&gt; postProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">		<span class="keyword">public</span> Object <span class="title function_">postProcess</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (ObjectPostProcessor opp : <span class="built_in">this</span>.postProcessors) &#123;</span><br><span class="line">				Class&lt;?&gt; oppClass = opp.getClass();</span><br><span class="line">				Class&lt;?&gt; oppType = GenericTypeResolver.resolveTypeArgument(oppClass, ObjectPostProcessor.class);</span><br><span class="line">				<span class="keyword">if</span> (oppType == <span class="literal">null</span> || oppType.isAssignableFrom(object.getClass())) &#123;</span><br><span class="line">					object = opp.postProcess(object);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> object;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addObjectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">			<span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.postProcessors.add(objectPostProcessor);</span><br><span class="line">			<span class="built_in">this</span>.postProcessors.sort(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="UserDetailsAwareConfigurer"><a href="#UserDetailsAwareConfigurer" class="headerlink" title="UserDetailsAwareConfigurer"></a>UserDetailsAwareConfigurer</h4><p>​	<strong>UserDetailsAwareConfigurer</strong>的子类主要负责配置用户认证相关的组件, 如: <strong>UserDetails</strong>等, <strong>UserDetailsAwareConfigurer</strong>中提供了获取<strong>UserDetailsService</strong>的抽象方法, 具体实现则在它的子类中, <strong>UserDetailsAwareConfigurer</strong>的子类如同所示:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230312220109915.png" alt="image-20230312220109915"></p>
<ul>
<li>AbstractDaoAuthenticationConfigurer: 完成对DaoAuthenticationProvider的配置</li>
<li>UserDetailsServiceConfigurer: 完成对UserDetailsService的配置</li>
<li>UserDetailsManagerConfigurer: 使用UserDetailsManager构建用户对象, 完成对AuthenticationManagerBuilder的填充</li>
<li>JdbcUserDetailsManagerConfigurer: 配置JdbcUserDetailsManager并填充到AuthenticationManagerBuilder中</li>
<li>InMemoryUserDetailsManagerConfigurer: 配置InMemoryUserDetailsManager</li>
<li>DaoAuthenticationConfigurer: 完成对DaoAuthenticationProvider的配置</li>
</ul>
<h3 id="AbstractHttpConfigurer"><a href="#AbstractHttpConfigurer" class="headerlink" title="AbstractHttpConfigurer"></a>AbstractHttpConfigurer</h3><p>​	<strong>AbstractHttpConfigurer</strong>主要是为了给在<strong>HttpSecurity</strong>中使用的配置类添加一个方便的父类, 提取出共同的操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHttpConfigurer</span>&lt;T <span class="keyword">extends</span> <span class="title class_">AbstractHttpConfigurer</span>&lt;T, B&gt;, B <span class="keyword">extends</span> <span class="title class_">HttpSecurityBuilder</span>&lt;B&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, B&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> B <span class="title function_">disable</span><span class="params">()</span> &#123;</span><br><span class="line">		getBuilder().removeConfigurer(getClass());</span><br><span class="line">		<span class="keyword">return</span> getBuilder();</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> T <span class="title function_">withObjectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		addObjectPostProcessor(objectPostProcessor);</span><br><span class="line">		<span class="keyword">return</span> (T) <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, 提取出来的方法其实就两个: 一个disable表示禁用某个配置(比如我们配置的.csrf().disable()), 本质就是从构建器的<strong>configurers</strong>集合中移除某个配置类, 这样在将来构建的时候就不存在该配置类, 那么对应的功能也就不存在(被禁用); 另一个<strong>withObjectPostProcessor</strong>表示给某一个对象添加一个对象后置处理器, 由于该方法的返回值是当前对象, 所有该方法可以用来在链式配置中.</p>
<p>​	<strong>AbstractHttpConfigurer</strong>的实现类比较多, 基本上都用来配置各种各样的过滤器, 如图所示:</p>
<img src="/2022/01/26/SpringSecurity/image-20230313214804744.png" alt="image-20230313214804744" style="zoom:50%;">





<h3 id="GlobalAuthenticationConfigurerAdapter"><a href="#GlobalAuthenticationConfigurerAdapter" class="headerlink" title="GlobalAuthenticationConfigurerAdapter"></a>GlobalAuthenticationConfigurerAdapter</h3><p>​	<strong>GlobalAuthenticationConfigurerAdapter</strong> 主要是用于配置全局<strong>AuthenticationManagerBuilder</strong>, 在<strong>AuthenticationConfigureration</strong>类会自动使用<strong>GlobalAuthenticationConfigurerAdapter</strong>提供的Bean来配置全局的<strong>AuthenticationManagerBuilder</strong></p>
<p>​	在之前介绍过<strong>ProviderManager</strong>时曾经提到过, 默认情况下<strong>ProviderManager</strong>有一个parent, 这个parent就是通过这里的全局<strong>AuthenticationManagerBuilder</strong>来构建的.</p>
<p>​	<strong>GlobalAuthenticationConfigurerAdapter</strong>有四个不同的子类, 如图所示:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230313215553853.png" alt="image-20230313215553853"></p>
<ul>
<li><strong>InitializeAuthenticationProviderBeanManagerConfigurer</strong>: 初始化全局的<strong>Authentication</strong> <strong>Provider</strong>对象</li>
<li><strong>InitializeAuthenticationProviderManagerConfigurer</strong>: 配置全局的<strong>AuthenticationProvider</strong>对象, 配置的过程就是从Spring容器中查找<strong>AuthenticationProvider</strong>并设置给全局的<strong>AuthenticationManagerBuilder</strong>对象</li>
<li><strong>InitializeUserDetailsBeanManagerConfigurer</strong>: 初始化全局的<strong>UserDetailsService</strong>对象</li>
<li><strong>IntializeUserDetailsManagerConfigurer</strong>: 配置全局的<strong>UserDetailsService</strong>对象,配置过程就是从Spring容器中查找<strong>UserDetailsService</strong>, 并设置给全局的<strong>AuthenticatioonManagerBuilder</strong>对象</li>
<li><strong>EnableGlobalAuthenticationAutowiredConfigurer</strong>: 从Spring容器中加载被@<strong>EnableGlobalAuthentication</strong>注解标记的Bean</li>
</ul>
<h3 id="WebSecurityConfigurer"><a href="#WebSecurityConfigurer" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h3><p>​	<strong>WebSecurityConfigurer</strong>是一个空接口, 我们可以通过它来自定义<strong>WebSecurity</strong>. <strong>WebSecurityConfigurer</strong> 只有一个实现类就是<strong>WebSecurityConfigurerAdpter</strong>, 在大多数情况下, 开发者可以通过继承<strong>WebSecurityConfigurerAdapter</strong>来实现<strong>WebSecurity</strong>的自定义配置</p>
<h3 id="WebSecurityConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h3><p>​	<strong>WebSecurityConfigurerAdapter</strong>是一个可以方便创建<strong>WebSecurityConfigurer</strong>实例的基类, 开发者可以通过覆盖<strong>WebSecurityConfigurerAdapter</strong>中的方法完成对<strong>HttpSecurity</strong>和<strong>WebSecurity</strong>的定制. 后面都是通过自定义<strong>WebSecurityConfigurerAdapter</strong>来实现的</p>
<p>​	在<strong>WebSecurityConfigurerAdapter</strong>中声明了两个<strong>AuthenticationManagerBuilder</strong>对象用来构建<strong>AuthenticationManager</strong>: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AuthenticationManagerBuilder authenticationBuilder;</span><br><span class="line"><span class="keyword">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBuilder;</span><br></pre></td></tr></table></figure>

<p>​	其中, <strong>localConfigureAuthenticationBuilder</strong>对象负责构建全局的<strong>AuthenticationManager</strong>, 而<strong>authenticationBuilder</strong>则负责构建局部的<strong>AuthenticationManager</strong>, 而<strong>authenticationBuilder</strong>则负责构建局部的<strong>AuthenticationManager</strong>.局部的<strong>AuthenticationManager</strong>是和每一个<strong>HttpSecurity</strong>对象绑定的, 而全局的<strong>AuthenticationManager</strong>对象则是所有局部<strong>AuthenticationManager</strong>的<strong>parent</strong>. 需要注意的是, <strong>localConfigurerAuthenticationBuilder</strong>并非总是有用的, 在开发者没有重写<strong>configure(AuthenticationManagerBuilder)<strong>方法的情况下, 全局的</strong>AuthenticationManager</strong>对象是由<strong>AuthenticationConfiguration</strong>类中的<strong>getAuthenticationManager</strong>方法提供的, 如果用户重写了<strong>configure(AuthenticationManagerBuilder)<strong>方法, 则全局的</strong>AuthenticationManager</strong>就由<strong>localConfigureAuthenticationBuilder</strong>负责构建.</p>
<p>​	<strong>WebSecurityConfigurerAdapter</strong>类的初始化方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="number">1.</span> 在init方法中, 首先调用getHttp方法获取一个HttpSecurity实例, 并将获取到实例添加到WebSecurity对象中, 再由WebSecurity对象进行构建</span><br><span class="line">		<span class="type">HttpSecurity</span> <span class="variable">http</span> <span class="operator">=</span> getHttp();</span><br><span class="line">		web.addSecurityFilterChainBuilder(http).postBuildAction(() -&gt; &#123;</span><br><span class="line">			<span class="type">FilterSecurityInterceptor</span> <span class="variable">securityInterceptor</span> <span class="operator">=</span> http.getSharedObject(FilterSecurityInterceptor.class);</span><br><span class="line">			web.securityInterceptor(securityInterceptor);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HttpSecurity <span class="title function_">getHttp</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="number">2.</span> 在getHttp方法中, 如果Http对象已经初始化, 则直接返回, 否则进行初始化操作. 在初始化的过程中, 给localConfigureAuthenticationBldr设置事件发布器, 并调用authenticationManager方法获取全局的AuthenticationManager对象</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.http != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.http;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AuthenticationEventPublisher</span> <span class="variable">eventPublisher</span> <span class="operator">=</span> getAuthenticationEventPublisher();</span><br><span class="line">		<span class="built_in">this</span>.localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher);</span><br><span class="line">   <span class="number">3.</span> 在authenticationManager方法中, 如果全局的AuthenticationManager对象还没有初始化,则先调用configure方法, 该方法的逻辑很简单, 就是将disableLocalConfigure AuthenticationBldr变量由<span class="literal">false</span>变为<span class="literal">true</span>, 接下来就会进入到authenticationManager方法的<span class="keyword">if</span>分支中,通过调用authenticationConfiguration.getAuthenticationManager()方法获取全局的AuthenticationManager对象并返回.如果开发者自己重写了configure(AuthenticationManager Builder)方法, 则disableLocalConfigureAuthenticationBldr变量就一直是<span class="literal">false</span>, 没有机会变为<span class="literal">true</span>, 这样就会进入到<span class="keyword">else</span>分支中, 通过localConfigureAuthenticationBldr变量来构建authenticationManager对象</span><br><span class="line">		<span class="type">AuthenticationManager</span> <span class="variable">authenticationManager</span> <span class="operator">=</span> authenticationManager();</span><br><span class="line">   <span class="number">4.</span> 再次回到getHttp方法中, 获取到全局的authenticationManager对象之后, 设置给authenticationBuilder, 然后创建一个HttpSecurity实例出来, 并为其配置上默认的过滤器. 默认的配置完成后, 调用configure(HttpSecurity)方法进行扩展配置, WebSecurityConfigurerAdapter中对configure(HttpSecurity)方法提供了默认的实现, 开发者也可以自定义该方法</span><br><span class="line">		<span class="built_in">this</span>.authenticationBuilder.parentAuthenticationManager(authenticationManager);</span><br><span class="line">		Map&lt;Class&lt;?&gt;, Object&gt; sharedObjects = createSharedObjects();</span><br><span class="line">		<span class="built_in">this</span>.http = <span class="keyword">new</span> <span class="title class_">HttpSecurity</span>(<span class="built_in">this</span>.objectPostProcessor, <span class="built_in">this</span>.authenticationBuilder, sharedObjects);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.disableDefaults) &#123;</span><br><span class="line">			http.csrf();</span><br><span class="line">			http.addFilter(<span class="keyword">new</span> <span class="title class_">WebAsyncManagerIntegrationFilter</span>());</span><br><span class="line">			http.exceptionHandling();</span><br><span class="line">			http.headers();</span><br><span class="line">			http.sessionManagement();</span><br><span class="line">			http.securityContext();</span><br><span class="line">			http.requestCache();</span><br><span class="line">			http.anonymous();</span><br><span class="line">			http.servletApi();</span><br><span class="line">			http.apply(<span class="keyword">new</span> <span class="title class_">DefaultLoginPageConfigurer</span>&lt;&gt;());</span><br><span class="line">			http.logout();</span><br><span class="line">      <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getClassLoader();</span><br><span class="line">			List&lt;AbstractHttpConfigurer&gt; defaultHttpConfigurers = SpringFactoriesLoader</span><br><span class="line">					.loadFactories(AbstractHttpConfigurer.class, classLoader);</span><br><span class="line">			<span class="keyword">for</span> (AbstractHttpConfigurer configurer : defaultHttpConfigurers) &#123;</span><br><span class="line">				<span class="built_in">this</span>.http.apply(configurer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		configure(<span class="built_in">this</span>.http);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.http;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="built_in">this</span>.disableLocalConfigureAuthenticationBldr = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.authenticationManagerInitialized) &#123;</span><br><span class="line">			configure(<span class="built_in">this</span>.localConfigureAuthenticationBldr);</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.disableLocalConfigureAuthenticationBldr) &#123;</span><br><span class="line">				<span class="built_in">this</span>.authenticationManager = <span class="built_in">this</span>.authenticationConfiguration.getAuthenticationManager();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="built_in">this</span>.authenticationManager = <span class="built_in">this</span>.localConfigureAuthenticationBldr.build();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.authenticationManagerInitialized = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	这就是WebSecurityConfigurerAdapter的初始化方法, 其实就是创建并配置一个HttpSecurity实例, 之后添加到WebSecurity中</p>
<p>​	WebSecurityConfigurerAdapter中的configure方法是一个空方法, 可以用来配置WebSecurity, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	</p>
<p>​	一般来说, 如果我们有一些静态资源不需要经过SpringSecurity过滤器, 就可以通过重写该方法来实现.</p>
<p>​	至此, 在SpringSecurity初始化过程中, 几个重要的组件都介绍完了.</p>
<h3 id="初始化流程分析-1"><a href="#初始化流程分析-1" class="headerlink" title="初始化流程分析"></a>初始化流程分析</h3><p>​	在SpringBoot中使用SpringSecurity, 初始化就从SpringSecurity的自动化配置类开始:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DefaultAuthenticationEventPublisher.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SecurityProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; SpringBootWebSecurityConfiguration.class, SecurityDataConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(AuthenticationEventPublisher.class)</span></span><br><span class="line">	<span class="keyword">public</span> DefaultAuthenticationEventPublisher <span class="title function_">authenticationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultAuthenticationEventPublisher</span>(publisher);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, 在自动化配置类<strong>SecurityAutoConfiguration</strong>中, 最重要的就是导入了三个配置类, 并且定义了默认的事件发布器</p>
<p>​	导入的三个配置类中, <strong>SpringBootWebSecurityConfiguration</strong>的主要作用是在开发者没有提供<strong>WebSecurityConfigurerAdapter</strong>实例的情况下, 由其负责提供一个默认的<strong>WebSecurityConfigurerAdapter</strong>实例, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line">  <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityFilterChainConfiguration</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	另一个导入的配置类<strong>SecurityDataConfiguration</strong>主要提供了一个<strong>SecurityEvaluationContextExtension</strong>实例, 以便通过SpEL为经过身份验证的用户提供数据查询:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(SecurityEvaluationContextExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityDataConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> SecurityEvaluationContextExtension <span class="title function_">securityEvaluationContextExtension</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecurityEvaluationContextExtension</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	最后一个导入的配置类<strong>WebSecurityEnablerConfiguration</strong>则是我们分析的重点:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = BeanIds.SPRING_SECURITY_FILTER_CHAIN)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(EnableWebSecurity.class)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WebSecurityEnablerConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	<strong>WebSecurityEnablerConfiguration</strong>配置类中添加了@<strong>EnableWebSecurity</strong>注解, 而该注解的定义, 引入了关键的配置类<strong>WebSecurityConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123; WebSecurityConfiguration.class, SpringWebMvcImportSelector.class, OAuth2ImportSelector.class,</span></span><br><span class="line"><span class="meta">		HttpSecurityConfiguration.class &#125;)</span></span><br><span class="line"><span class="meta">@EnableGlobalAuthentication</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableWebSecurity &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Controls debugging support for Spring Security. Default is false.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> if true, enables debug support with Spring Security</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">debug</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到, @<strong>EnableWebSecurity</strong>是一个组合注解, 首先导入了三个配置类:</p>
<ul>
<li><strong>WebSecurityConfiguration</strong>: 用来配置WebSecurity</li>
<li><strong>SpringWebMvcImportSelector</strong>: 判断当前环境是否存在Spring MVC , 如果存在,则引入相关配置</li>
<li><strong>OAuth2ImportSelector</strong>: 判断当前环境是否存在OAuth2, 如果存在, 则引入相关配置</li>
</ul>
<p>​	另外还有一个@<strong>EnableGlobalAuthentication</strong>注解, 用来开启全局配置, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(AuthenticationConfiguration.class)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableGlobalAuthentication &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​	可以看到, @<strong>EnableGlobalAuthentication</strong>注解的主要功能是导入了配置类<strong>AuthenticationConfiguration</strong></p>
<p>​	从上面的源码,我们可以看到, <strong>SpringSecurity</strong>的自动化配置类主要导入了两个类: <strong>WebSecurityConfiguration</strong>和<strong>AuthenticationConfiguration</strong>. 接下来我们就来分析下这两个类.</p>
<h5 id="WebSecurityConfiguration"><a href="#WebSecurityConfiguration" class="headerlink" title="WebSecurityConfiguration"></a>WebSecurityConfiguration</h5><p>​	<strong>WebSecurityConfiguration</strong>配置类的功能, 主要就是为了构建<strong>SpringSecurity</strong>过滤器链代理对象<strong>FilterChainProxy</strong>. 根据前面的分析, <strong>FilterChainProxy</strong>是由<strong>WebSecurity</strong>来构建的, 所以在<strong>WebSecurityConfiguration</strong>中会首先构建<strong>WebSecurity</strong>对象,在利用<strong>WebSecurity</strong>对象构建出<strong>FilterChainProxy</strong></p>
<p>​	我们来看一下<strong>WebSecurityConfiguration</strong>中定义的属性:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span>, BeanClassLoaderAware &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> WebSecurity webSecurity;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Boolean debugEnabled;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectObjectPostProcessor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><strong>WebSecurityConfiguration</strong>类实现了<strong>ImportAware</strong>接口. <strong>ImportAware</strong>接口一般是和@<strong>Import</strong>注解一起使用的, 实现了<strong>ImportAware</strong>接口的配置类可以方便地通过<strong>setImportMetadata</strong>方法获取到导入类中的数据配置. 换句话说, <strong>WebSecurityConfiguration</strong>实现了<strong>ImportAware</strong>接口, 使用@<strong>Import</strong>注解在@<strong>EnableWebSecurity</strong>上导入<strong>WebSecurityConfiguration</strong>之后, 在<strong>WebSecurityConfiguration</strong>的<strong>setImportMetadata</strong>方法中可以方便的获取到@<strong>EnableWebSecurity</strong>注解中的属性值, 这里主要是debug的属性. 另一方面, <strong>WebSecurityConfiguration</strong>类通过实现<strong>BeanClassLoaderAware</strong>接口可以方便地回去到ClassLoader对象</li>
<li><strong>webSecurity</strong>对象是<strong>WebSecurityConfiguration</strong>中需要构建的<strong>WebSecurity</strong>对象</li>
<li><strong>webSecurityConfigurers</strong>集合中保存了所有的配置类, 也就是<strong>WebSecurityConfigurerAdapter</strong>对象, 一个<strong>WebSecurityConfigurerAdapter</strong>对象可以创建一个<strong>HttpSecurity</strong>, 进而构建一条过滤器链, 多个<strong>WebSecurityConfigurerAdapter</strong>对象就可以构建出多条过滤器链</li>
<li><strong>beanClassLoader</strong>是一个ClassLoader</li>
<li><strong>objectObjectPostProcessor</strong>是一个对象后置处理器, 注意这个对象是直接从Spring容器中注入的.</li>
</ol>
<p>​	这是<strong>WebSecurityConfiguration</strong>类中定义的属性. 接下来, 我们来看一下<strong>setFilterChainProxySecurityConfigurer</strong>方法, 该方法主要用来构建一个<strong>WebSecurity</strong>对象, 并且加载所有的配置类对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFilterChainProxySecurityConfigurer</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span></span><br><span class="line"><span class="params">			ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="built_in">this</span>.webSecurity = objectPostProcessor.postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurity</span>(objectPostProcessor));</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.debugEnabled != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.webSecurity.debug(<span class="built_in">this</span>.debugEnabled);</span><br><span class="line">		&#125;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers = <span class="keyword">new</span> <span class="title class_">AutowiredWebSecurityConfigurersIgnoreParents</span>(</span><br><span class="line">				beanFactory).getWebSecurityConfigurers();</span><br><span class="line">		webSecurityConfigurers.sort(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">previousOrder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">previousConfig</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; config : webSecurityConfigurers) &#123;</span><br><span class="line">			<span class="type">Integer</span> <span class="variable">order</span> <span class="operator">=</span> AnnotationAwareOrderComparator.lookupOrder(config);</span><br><span class="line">			<span class="keyword">if</span> (previousOrder != <span class="literal">null</span> &amp;&amp; previousOrder.equals(order)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;@Order on WebSecurityConfigurers must be unique. Order of &quot;</span> + order</span><br><span class="line">						+ <span class="string">&quot; was already used on &quot;</span> + previousConfig + <span class="string">&quot;, so it cannot be used on &quot;</span> + config + <span class="string">&quot; too.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			previousOrder = order;</span><br><span class="line">			previousConfig = config;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; webSecurityConfigurer : webSecurityConfigurers) &#123;</span><br><span class="line">			<span class="built_in">this</span>.webSecurity.apply(webSecurityConfigurer);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.webSecurityConfigurers = webSecurityConfigurers;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	<strong>setFilterChainProxySecurityConfigurer</strong>方法有两个参数, 第一个参数<strong>objectPostProcessor</strong>是一个对象后置处理器, 由于该方法有一个**@Autowired<strong>注解, 会自动查找需要注入的参数, 所以</strong>objectPostProcessor<strong>参数会自动注入进来. 需要注意的是, <strong>@Autowired</strong>注解的</strong>required<strong>属性为false, 所以在方法参数注入的时候, 有就注入, 没有就忽略. required属性设置为false主要是针对第二个参数</strong>webSecurityConfigurers**, 因为该参数的值是通过调用<strong>autowiredWebSecurityConfigurersIgnorePatterns</strong>对象也是在当前类中注入到Spring容器的, 我们来看一下它的<strong>getWebSecurityConfigurers</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; <span class="title function_">getWebSecurityConfigurers</span><span class="params">()</span> &#123;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		Map&lt;String, WebSecurityConfigurer&gt; beansOfType = <span class="built_in">this</span>.beanFactory.getBeansOfType(WebSecurityConfigurer.class);</span><br><span class="line">		<span class="keyword">for</span> (Entry&lt;String, WebSecurityConfigurer&gt; entry : beansOfType.entrySet()) &#123;</span><br><span class="line">			webSecurityConfigurers.add(entry.getValue());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> webSecurityConfigurers;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, 在<strong>getWebSecurityConfigurers</strong>方法中主要是通过调用<strong>beanFactory.getBeansOfType</strong>方法来获取Spring容器中所有的<strong>WebSecurityConfigurer</strong>实例, 也就是开发者自定义的各种各样继承自<strong>WebSecurityConfigurerAdapter</strong>的配置类. 如果开发者没有自定义任何配置类, 那么这里获取到的就是前面所讲的<strong>SpringBootWebSecurityConfiguration</strong>类中提供的默认配置类. 将获取到的所有配置类实例放到<strong>webSecurityConfigurers</strong>集合中并返回.</p>
<p>​	返回<strong>setFilterChainProxySecurityConfigurer</strong>方法中, 现在我们已经明白了第二个参数<strong>webSecurityConfigurers</strong>的含义了. 在该方法中, 首先创建一个<strong>WebSecurity</strong>实例, 创建出来之后去对象后置处理器中走一圈, 这样就将<strong>webSecurity</strong>对象注册到Spring容器中去了. 接下来, 根据每一个配置类的@<strong>Order</strong>注解对<strong>webSecurityConfigurers</strong>集合中的所有配置类进行排序, 因为一个配置类对应一条过滤器链, 当请求到来后, 需要先和哪个过滤器进行匹配,这里必然存在一个优先级问题, 所以如果开发者自定义了多个配置类, 则需要通过@<strong>Order</strong>注解标记多个配置类的优先级. 排序完成后, 进入到for循环中, 检查是否存在优先级相等的配置类, 如果存在,则直接抛出异常. 最后再去遍历所有的配置类, 调用<strong>webSecurity.apply</strong>方法将其添加到<strong>webSecurity</strong>父类中的<strong>configurers</strong>集合中(将来遍历该集合并分别调用配置类的<strong>init</strong>和<strong>configure</strong>方法完成配置类的初始化操作)</p>
<p>​	这是<strong>setFilterChainProxySecurityConfigurer</strong>方法的执行逻辑, 该方法主要用来初始化<strong>WebSecurity</strong>对象, 同时收集到所有的自定义配置类</p>
<p>​	有了<strong>WebSecurity</strong>对象和配置类, 接下来就可以构建过滤器<strong>FilterChainProxy</strong>了. 我们来看下<strong>springSecurityFilterChain</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME)</span></span><br><span class="line"><span class="keyword">public</span> Filter <span class="title function_">springSecurityFilterChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">hasConfigurers</span> <span class="operator">=</span> <span class="built_in">this</span>.webSecurityConfigurers != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.webSecurityConfigurers.isEmpty();</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">hasFilterChain</span> <span class="operator">=</span> !<span class="built_in">this</span>.securityFilterChains.isEmpty();</span><br><span class="line">	Assert.state(!(hasConfigurers &amp;&amp; hasFilterChain),</span><br><span class="line">			<span class="string">&quot;Found WebSecurityConfigurerAdapter as well as SecurityFilterChain. Please select just one.&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!hasConfigurers &amp;&amp; !hasFilterChain) &#123;</span><br><span class="line">		<span class="type">WebSecurityConfigurerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="built_in">this</span>.objectObjectPostProcessor</span><br><span class="line">				.postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurityConfigurerAdapter</span>() &#123;</span><br><span class="line">				&#125;);</span><br><span class="line">		<span class="built_in">this</span>.webSecurity.apply(adapter);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (SecurityFilterChain securityFilterChain : <span class="built_in">this</span>.securityFilterChains) &#123;</span><br><span class="line">		<span class="built_in">this</span>.webSecurity.addSecurityFilterChainBuilder(() -&gt; securityFilterChain);</span><br><span class="line">		<span class="keyword">for</span> (Filter filter : securityFilterChain.getFilters()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (filter <span class="keyword">instanceof</span> FilterSecurityInterceptor) &#123;</span><br><span class="line">				<span class="built_in">this</span>.webSecurity.securityInterceptor((FilterSecurityInterceptor) filter);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (WebSecurityCustomizer customizer : <span class="built_in">this</span>.webSecurityCustomizers) &#123;</span><br><span class="line">		customizer.customize(<span class="built_in">this</span>.webSecurity);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.webSecurity.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​	这里首先判断<strong>webSecurityConfigurers</strong>集合中是否存在配置类, 如果不存在, 则立马创建一个匿名的<strong>WebSecurityConfigurerAdapter</strong>对象并注册到Spring容器中, 否则就直接调用<strong>WebSecurity</strong>的build方法进行构建.</p>
<p>​	根据之前的介绍, 了解了<strong>WebSecurity</strong>对象的build方法执行后, 首先会对所有的配置类即<strong>WebSecurityConfigurerAdapter</strong>实例进行构建, 在<strong>WebSecurityConfigurerAdapter</strong>的init方法中, 又会完成<strong>HttpSecurity</strong>的构建, 而<strong>HttpSecurity</strong>的构建过程中, 则会完成局部的<strong>AuthenticationManager</strong>对象以及每一个具体的过滤器的构建</p>
<p>​	这就是整个过滤器链的构建过程.</p>
<p>​	</p>
<h5 id="AuthenticationConfiguration"><a href="#AuthenticationConfiguration" class="headerlink" title="AuthenticationConfiguration"></a>AuthenticationConfiguration</h5><p>​	在SpringSecurity自动化配置类中导入的另外一个配置类是<strong>AuthenticationConfiguration</strong>, 该类的功能主要是做全局的配置, 同时提供一个全局的<strong>AuthenticationManager</strong>实例. 首先我们来看<strong>AuthenticationConfiguration</strong>类定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Import(ObjectPostProcessorConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationConfiguration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, <strong>AuthenticationConfiguration</strong>类的定义中, 导入了<strong>ObjectPostProcessorConfiguration</strong>配置, 而<strong>ObjectPostProcessorConfiguration</strong>配置则提供了一个基本的对象后置处理器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectPostProcessorConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line">	<span class="keyword">public</span> ObjectPostProcessor&lt;Object&gt; <span class="title function_">objectPostProcessor</span><span class="params">(AutowireCapableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutowireBeanFactoryObjectPostProcessor</span>(beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, <strong>ObjectPostProcessorConfiguration</strong>类主要提供了一个<strong>ObjectPostProcessor</strong>实例, 具体的实现类是<strong>AutowireBeanFactoryObjetPostProcessor</strong>, 根据前面的介绍, 该实现类主要用来将一个对象注册到Spring容器中, 我们在其他配置类中所见到的<strong>ObjectPostProcessor</strong>实例其实都是这里提供的</p>
<p>​	这是<strong>AuthenticationConfiguration</strong>类的定义部分, <strong>AuthenticationConfiguration</strong>类中的方法比较多, 我们挑选出关键的部分分析一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">authenticationManagerBuilder</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span></span><br><span class="line"><span class="params">			ApplicationContext context)</span> &#123;</span><br><span class="line">		<span class="type">LazyPasswordEncoder</span> <span class="variable">defaultPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LazyPasswordEncoder</span>(context);</span><br><span class="line">		<span class="type">AuthenticationEventPublisher</span> <span class="variable">authenticationEventPublisher</span> <span class="operator">=</span> getAuthenticationEventPublisher(context);</span><br><span class="line">		<span class="type">DefaultPasswordEncoderAuthenticationManagerBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultPasswordEncoderAuthenticationManagerBuilder</span>(</span><br><span class="line">				objectPostProcessor, defaultPasswordEncoder);</span><br><span class="line">		<span class="keyword">if</span> (authenticationEventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">			result.authenticationEventPublisher(authenticationEventPublisher);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GlobalAuthenticationConfigurerAdapter <span class="title function_">enableGlobalAuthenticationAutowiredConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">			ApplicationContext context)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EnableGlobalAuthenticationAutowiredConfigurer</span>(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> InitializeUserDetailsBeanManagerConfigurer <span class="title function_">initializeUserDetailsBeanManagerConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">			ApplicationContext context)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InitializeUserDetailsBeanManagerConfigurer</span>(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> InitializeAuthenticationProviderBeanManagerConfigurer <span class="title function_">initializeAuthenticationProviderBeanManagerConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">			ApplicationContext context)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InitializeAuthenticationProviderBeanManagerConfigurer</span>(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">getAuthenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.authenticationManagerInitialized) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AuthenticationManagerBuilder</span> <span class="variable">authBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContext.getBean(AuthenticationManagerBuilder.class);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.buildingAuthenticationManager.getAndSet(<span class="literal">true</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthenticationManagerDelegator</span>(authBuilder);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (GlobalAuthenticationConfigurerAdapter config : <span class="built_in">this</span>.globalAuthConfigurers) &#123;</span><br><span class="line">			authBuilder.apply(config);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.authenticationManager = authBuilder.build();</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.authenticationManager == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.authenticationManager = getAuthenticationManagerBean();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.authenticationManagerInitialized = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><p>首先定义了一个<strong>AuthenticationManagerBuilder</strong>实例, 目的是为了构建全局的<strong>AuthenticationManager</strong>对象, 这个过程中会从Spring容器中查找<strong>AuthenticationEventPublisher</strong>实例设置给<strong>AuthenticationManagerBuilder</strong>对象</p>
</li>
<li><p>接下来构建了三个Bean, 这三个Bean的作用在之前介绍过了.</p>
</li>
<li><p><strong>getAuthenticationManager</strong>方法则用来构建具体的<strong>AuthenticationManager</strong>对象, 在该方法内部, 会首先判断<strong>AuthenticationManager</strong>对象是否已经初始化, 如果已经初始化, 则直接返回<strong>AuthenticationManager</strong>对象, 否则就先从Spring容器中获取到<strong>AuthenticationManagerDelegator</strong>对象, 这个主要是为了防止在初始化<strong>AuthenticationManager</strong>时进行无限递归. 拿到<strong>authBuilder</strong>对象之后, 接下来遍历<strong>globalAuthConfigurers</strong>配置类集合(也就是第二点所说的三个配置类), 将配置类分别添加到<strong>authBuilder</strong>对象中, 然后进行构建, 最终将构建结果返回.</p>
<p>这是全局<strong>AuthenticationManager</strong>的构建过程.</p>
<p>整体来说, <strong>AuthenticationConfiguration</strong>的作用主要体现在两方面: 第一就是导入了<strong>ObjectPostProcessorConfiguration</strong>配置类; 第二则是提供了一个全局的<strong>AuthenticationManager</strong>对象.</p>
<p>如果开发者在自定义配置类中重写了<strong>configure(AuthenticationManagerBuilder)<strong>方法, 这里的全局</strong>AuthenticationManager</strong>对象将不会生效, 而大部分情况下, 开发者都会重写**configure(AuthenticationManagerBuilder)**方法</p>
</li>
</ol>
<p>至此, SpringSecurity初始化就讲解完毕了.</p>
<h5 id="ObjectPostProcessor使用"><a href="#ObjectPostProcessor使用" class="headerlink" title="ObjectPostProcessor使用"></a>ObjectPostProcessor使用</h5><p>​	前面介绍了<strong>ObjectPostProcessor</strong>的基本使用. 所有的过滤器都由对应的配置类来负责创建, 配置类在将过滤器创建成功之后, 会调用父类的<strong>postProcess</strong>方法, 该方法最终会调用到<strong>CompositeObjectPostProcessor</strong>对象所维护的List集合中存储的所有ObjectPostProcessor对象, 并调用其<strong>postProcess</strong>方法对对象进行后置处理. 默认情况下, <strong>CompositeObjectPostProcessor</strong>对象中维护的List集合中只有一个对象那就是<strong>AutowireBeanFactoryObjectPostProcessor</strong>, 调用<strong>AutowireBeanFactoryObjectPostProcessor</strong>, 调用<strong>AutowireBeanFactroyObjectPostProcessor</strong>的<strong>postProcess</strong>方法可以将对象注册到Spring容器中去.</p>
<p>​	开发者可以自定义<strong>ObjectPostProcessor</strong>对象, 并添加到<strong>CompositeObjectPostProcessor</strong>所维护的List集合中, 此时, 当一个过滤器在创建成功之后, 就会被两个对象后置处理器处理, 第一个默认的对象后置处理器, 负责将对象注册到Spring容器中; 第二个是我们自定义的对象后置处理器, 可以完成一下个性化配置</p>
<p>​	自定义<strong>ObjectPostProcessor</strong>对象比较典型的用法是动态权限配置, 为了方便大家理解, 这里先通过一个大家熟悉的案例来展示<strong>ObjectPostProcessor</strong>的用法, 后面在配置动态权限时, <strong>ObjectPostProcessor</strong>的使用思路是一致的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeHttpRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        .and().formLogin()</span><br><span class="line">        .withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;UsernamePasswordAuthenticationFilter&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O object)</span> &#123;</span><br><span class="line">            object.setUsernameParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            object.setPasswordParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            object.setAuthenticationSuccessHandler((req, resp, auth) -&gt; &#123;</span><br><span class="line">              resp.getWriter().write(<span class="string">&quot;login success&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	在这个案例中, 调用<strong>formLogin</strong>方法之后, 开启了<strong>FormLoginConfigurer</strong>的配置, <strong>FormLoginConfigurer</strong>的作用是为了配置<strong>UsernamePasswordAuthenticationFilter</strong>过滤器, 在<strong>formLogin</strong>方法执行完毕后, 我们调用<strong>withObjectPostProcessor</strong>方法对<strong>UsernamePasswordAuthenticationFilter</strong>过滤器进行二次处理, 修改登录参数的key, 将登录用户名参数的key改为name, 将登录密码参数的key改为passwd, 同时配置一个登录成功的处理器.</p>
<img src="/2022/01/26/SpringSecurity/image-20230322160333317.png" alt="image-20230322160333317" style="zoom:50%;">





<h3 id="多种用户定义方式"><a href="#多种用户定义方式" class="headerlink" title="多种用户定义方式"></a>多种用户定义方式</h3><p>​	在之前的章节中, 我们定义用户主要是两种方式:</p>
<pre><code>1. 重写**configure(AuthenticationManagerBuilder)**方法的方式
1. 第二种方式是定义多个数据源, 我们直接向Spring容器中注入了**UserDetailsService**对象
</code></pre>
<p>​	那么这两种用户定义方式有什么区别?</p>
<p>​	根据前面的源码分析可知: 在SpringSecurity之后存在两种类型的<strong>AuthenticationManager</strong>, 一种是全局的<strong>AuthenticationManager</strong>, 另一种是局部的<strong>AuthenticationManager</strong>. 局部的<strong>AuthenticationManager</strong>由<strong>HttpSecurity</strong>进行配置, 而全局的<strong>AuthenticationManager</strong>可以不用配置, 系统会默认提供一个全局的<strong>AuthenticationManager</strong>对象, 也可以通过重写**configure(AuthenticationManagerBuilder)**方法进行全局配置</p>
<p>​	当进行用户身份验证时, 首先会通过局部的<strong>AuthenticationManager</strong>对象进行验证, 如果验证失败, 则会调用其parent也就是全局的<strong>AuthenticationManager</strong>再次进行验证.</p>
<p>​	所以开发者在定义用户时, 也分为两种情况, 一种是针对局部<strong>AuthenticationManager</strong>定义的用户, 另一种则是针对全局<strong>AuthenticationManager</strong>定义的用户.</p>
<p>​	为了演示方便, 接下来的案例我们将采取<strong>InMemoryUserDetailsManager</strong>来构建用户对象.</p>
<p>​	先来看针对局部<strong>AuthenticationManager</strong>定义的用户:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="type">InMemoryUserDetailsManager</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">   user.createUser(User.withUsername(<span class="string">&quot;javaboy&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).build());</span><br><span class="line">   http.authorizeHttpRequests()</span><br><span class="line">       .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">       .anyRequest().authenticated()</span><br><span class="line">       .and().formLogin()</span><br><span class="line">       .and().userDetailsService(user)</span><br><span class="line">       .csrf().disable();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>​	在上面这段代码中, 我们基于内存来管理用户, 并向user中添加了个用户, 将配置好的users对象添加到HttpSecurity中, 也就是配置到局部的AuthenticationManager中.</p>
<p>​	配置完成后, 启动项目. 项目启动成功后, 我们就可以javaboy&#x2F;123来登录系统了.</p>
<p>​	值得注意的是, 当我们启动项目时, 在IDEA控制台输出的日志中可以看到如下内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using generated security password: 683311a8-7a53-453b-b07c-aa9a665365be</span><br></pre></td></tr></table></figure>

<p>​	系统自动提供的用户对象实际上就是往Spring容器中注册了一个<strong>InMemoryUserDetailsManager</strong>对象. 而在前面的代码中, 我们没有重写<strong>configure(AuthenticationManagerBuilder)</strong> 方法, 这意味着全局的<strong>AuthenticationManager</strong>是通过<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>方法自动生成的, 在生成的过程中, 会从Spring容器中查找对应的<strong>UserDetailsService</strong>实例进行配置(具体配置在<strong>InitializeUserDetailsManagerConfigurer</strong>类中)所以系统自动提供的用户实际上相当于是全局<strong>AuthenticationManager</strong>对应的用户.</p>
<p>​	以上面的代码为例, 当我们执行登录后, SpringSecurity首先会调用局部<strong>AuthenticationManager</strong>去进行登录验证, 如果登录的用户名&#x2F;密码是javaboy&#x2F;123, 那么就直接登录成功, 否则登录失败. 当登录失败后, 会继续调用局部<strong>AuthenticationManager</strong>的parent继续进行校验, 此时如果登录的用户名&#x2F;密码是user&#x2F;683311a8-7a53-453b-b07c-aa9a665365be, 则登录成功, 否则登录失败</p>
<p>​	这是针对局部<strong>AuthenticationManager</strong>定义的用户, 我们也可以将定义的用户配置给全局的<strong>AuthenticationManager</strong>, 由于默认的全局<strong>AuthenticationManager</strong>在配置时会从Spring容器中查找<strong>UserDetailsService</strong>实例, 所以我们如果针对全局<strong>AuthenticationManager</strong>配置用户, 只需要往Spring容器中注入一个<strong>UserDetailsService</strong>实例即可, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">    inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;javaboy&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">    <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeHttpRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        .and().formLogin()</span><br><span class="line">        .and().userDetailsService(userDetailsService())</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​	配置完成后, 当我们启动项目时, 全局的<strong>AuthenticationManager</strong>在配置时会去Spring容器中查找<strong>UserDetailsService</strong>实例, 找到的就是我们自定义的<strong>UserDetailsService</strong>实例. </p>
<p>​	当然, 开发者也可以不使用SpringSecurity提供的默认的全局<strong>AuthenticationManager</strong>对象, 而是通过重写<strong>configure(AuthenticationManagerBuilder)<strong>方法来自定义全局</strong>AuthenticationManager</strong>对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.inMemoryAuthentication().withUser(<span class="string">&quot;javaboy&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeHttpRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        .and().formLogin()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	根据<strong>WebSecurityConfigurerAdapter</strong>的源码分析可知, 一旦我们重写了<strong>configure(AuthenticationManagerBuilder)<strong>方法, 则全局的</strong>AuthenticationManager</strong>对象将不再通过<strong>AuthenticationConfiguration</strong>#<strong>getAuthenticationManager</strong>方法来构建, 而是通过<strong>WebSecurityConfigurerAdapter</strong>中的<strong>localConfigureAuthenticationBldr</strong>变量来构建, 该变量也是我们重写的**configure(AuthenticationManagerBuilder)**方法的参数.</p>
<p>​	配置完成后, 当我们启动项目后, 全局的<strong>AuthenticationManager</strong>在构建时会直接使用**configure(AuthenticationManagerBuilder)**方法的auth变量去构建, 使用的用户也是我们配置给auth变量的用户,使用的用户也是我们配置给auth变量的用户.</p>
<p>​	需要注意的是, 一旦重写了<strong>configure(AuthenticationManagerBuilder)<strong>方法, 那么全局</strong>AuthenticationManager</strong>对象中使用的用户. 将以<strong>configure(AuthenticationManagerBuilder)<strong>方法中定义的用户为准. 此时, 如果我们还向Spring容器中注入了另外一个</strong>userDetailsService</strong>实例, 那么该实例中定义的用户将不会生效(因为<strong>AuthenticationConfiguration#getAuthenticationManager</strong>方法没有被调用)</p>
<h3 id="定义多个过滤器链"><a href="#定义多个过滤器链" class="headerlink" title="定义多个过滤器链"></a>定义多个过滤器链</h3><p>​	在SpringSecurity中可以同时存在多个过滤器链, 一个<strong>WebSecurityConfigurerAdapter</strong>的实例就可以配置一条过滤器链.</p>
<p>​	我们来看如下一个案例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">InMemoryUserDetailsManager</span> <span class="variable">users</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">    users.createUser(User.withUsername(<span class="string">&quot;javaboy&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">    <span class="keyword">return</span> users;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Order(1)</span></span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig01</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">InMemoryUserDetailsManager</span> <span class="variable">users</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">      users.createUser(User.withUsername(<span class="string">&quot;bar&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">      http.antMatcher(<span class="string">&quot;/bar/**&quot;</span>)</span><br><span class="line">          .authorizeHttpRequests()</span><br><span class="line">          .anyRequest().authenticated()</span><br><span class="line">          .and()</span><br><span class="line">          .formLogin()</span><br><span class="line">          .loginProcessingUrl(<span class="string">&quot;/bar/login&quot;</span>)</span><br><span class="line">          .successForwardUrl(<span class="string">&quot;/bar/login&quot;</span>)</span><br><span class="line">          .successHandler((req, resp, auth) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(auth);</span><br><span class="line">            resp.getWriter().write(s);</span><br><span class="line">          &#125;)</span><br><span class="line">          .permitAll()</span><br><span class="line">          .and()</span><br><span class="line">          .csrf().disable()</span><br><span class="line">          .userDetailsService(users);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Order(2)</span></span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig02</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      auth.inMemoryAuthentication().withUser(<span class="string">&quot;javagirl&quot;</span>)</span><br><span class="line">          .password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>)</span><br><span class="line">          .roles(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">InMemoryUserDetailsManager</span> <span class="variable">users</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">      users.createUser(User.withUsername(<span class="string">&quot;foo&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">      http.antMatcher(<span class="string">&quot;/foo/**&quot;</span>)</span><br><span class="line">          .authorizeHttpRequests()</span><br><span class="line">          .anyRequest().authenticated()</span><br><span class="line">          .and()</span><br><span class="line">          .formLogin()</span><br><span class="line">          .loginProcessingUrl(<span class="string">&quot;/foo/login&quot;</span>)</span><br><span class="line">          .successForwardUrl(<span class="string">&quot;/foo/login&quot;</span>)</span><br><span class="line">          .successHandler((req, resp, auth) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(auth);</span><br><span class="line">            resp.getWriter().write(s);</span><br><span class="line">          &#125;)</span><br><span class="line">          .permitAll()</span><br><span class="line">          .and()</span><br><span class="line">          .csrf().disable()</span><br><span class="line">          .userDetailsService(users);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​	在<strong>SecurityConfig</strong>中分别定义两个静态内部类<strong>SecurityConfig01</strong>和<strong>SecurityConfig02</strong>, 两个配置类都继承自<strong>WebSecurityConfigurerAdapter</strong>, 分别配置一条过滤器链</p>
<p>​	先来看Security01. 在Security01中, 我们设置过滤器链的拦截规则是&#x2F;bar&#x2F;*, 即如果请求路径是&#x2F;bar&#x2F;<strong>格式的, 则进入到Security01的过滤器链这进行处理. 同时我们配置了局部</strong>AuthenticationManager<strong>对应的用户是&#x2F;bar&#x2F;123, 由于没有重写configure(AuthenticationManagerBuilder)方法, 所以注册到Spring容器中的UserDetailsService将作为局部</strong>AuthenticationManager**的parent对应的用户. 换句话说, 如果登录的路径是&#x2F;bar&#x2F;login, 那么开发者可以使用bar&#x2F;123和javaboy&#x2F;123两个用户进行登录.</p>
<img src="/2022/01/26/SpringSecurity/image-20230323165755959.png" alt="image-20230323165755959" style="zoom:50%;">



<p>​	再来看SecurityConfig02. 在Security02中, 我们设置过滤器链的拦截规则是&#x2F;foo&#x2F;**, 即如果请求路径是&#x2F;foo&#x2F;**格式的, 则进入到Security02的过滤器链中进行处理, 同时我们配置了局部AuthenticationManager对应的用户是foo&#x2F;123, 由于重写了configure(AuthenticationManagerBuilder)方法, 在该方法中定义了局部AuthenticationManager的parent对应的用户, 此时注册到Spring容器中的UserDetailsService实例对于&#x2F;foo&#x2F;**过滤器链不再生效,. 换句话说, 如果登录路径是&#x2F;foo&#x2F;login, 开发者可以使用foo&#x2F;123和javagirl&#x2F;123两个用户进行登录, 而不可以使用javaboy&#x2F;123进行登录. 登录效果如下:</p>
<img src="/2022/01/26/SpringSecurity/image-20230323172948891.png" alt="image-20230323172948891" style="zoom:50%;">

<p>​	需要注意的是, 如果配置了多个过滤器链, 需要使用@Order注解来标记不同配置的优先级(即不同过滤器链的优先级), 数字越大优先级越低. 当请求到来时, 会 按照过滤器的优先级从高到低, 依次进行匹配.</p>
<h3 id="静态资源过滤"><a href="#静态资源过滤" class="headerlink" title="静态资源过滤"></a>静态资源过滤</h3><p>​	在一个实际项目中, 并非所有的请求都需要经过SpringSecurity过滤器, 有一些特殊的请求, 例如静态资源等, 一般来说并不需要经过SpringSecurity过滤器链, 用户如果访问这些静态资源, 直接返回对于的资源即可.</p>
<p>​	回顾之前关于<strong>WebSecurity</strong>的讲解, 提到了它里面维护了一个<strong>ignoredRequests</strong>变量, 该变量记录的就是所有需要被忽略的请求, 这些被忽略的请求将不再经过<strong>SpringSecurity</strong>过滤器. </p>
<img src="/2022/01/26/SpringSecurity/image-20230323174059920.png" alt="image-20230323174059920" style="zoom:50%;">

<p>​	现在这些静态资源的访问不需要经过SpringSecurity过滤器, 具体配置方案如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">InMemoryUserDetailsManager</span> <span class="variable">users</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">    users.createUser(User.withUsername(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">    <span class="keyword">return</span> users;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/login.html&quot;</span>, <span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeHttpRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	重写<strong>configure(WebSecurity)<strong>方法, 并配置需要忽略的请求,这些需要忽略的地址, 最终都会被添加到</strong>ignoredRequests</strong>集合中, 并最终以过滤器链的形式呈现出来. 换句话说, 上面的配置中一共包含了五个过滤器链: <strong>configure(WebSecurity)<strong>方法中配置的四个以及</strong>HttpSecurity</strong>中配置的一个(即:&#x2F;**).</p>
<h1 id="第五章-密码加密"><a href="#第五章-密码加密" class="headerlink" title="第五章 密码加密"></a>第五章 密码加密</h1><ul>
<li>密码为什么要加密</li>
<li>常见加密的解决方案</li>
<li>PasswordEncoder 详解</li>
<li>优雅使用加密</li>
</ul>
<h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><h3 id="加密意义"><a href="#加密意义" class="headerlink" title="加密意义"></a>加密意义</h3><p>​	2011 年12月21 日，有人在网络上公开了一个包含600万个 CSDN 用户资料的数据库，数据全部为明文储存，包含用户名、密码以及注册邮箱。事件发生后 CSDN 在微博、官方网站等渠道发出了声明，解释说此数据库系2009 年备份所用，因不明原因泄漏，已经向警方报<br>案，后又在官网发出了公开道歉信。在接下来的十多天里，金山、网易、京东、当当、新浪等多家公司被卷入到这次事件中。整个事件中最触目惊心的莫过于 CSDN 把用户密码明文存储，由于很多用户是多个网站共用一个密码，因此一个网站密码泄漏就会造成很大的安全隐患。由于有了这么多前车之鉴，我们现在做系统时，密码都要加密处理。</p>
<p>在前面的案例中，凡是涉及密码的地方，我们都采用明文存储，在实际项目中这肯定是不可取的，因为这会带来极高的安全风险。在企业级应用中，密码不仅需要加密，还需要加<code>盐</code>，最大程度地保证密码安全。</p>
<h3 id="常见方案"><a href="#常见方案" class="headerlink" title="常见方案"></a>常见方案</h3><h4 id="Hash-算法"><a href="#Hash-算法" class="headerlink" title="Hash 算法"></a>Hash 算法</h4><p>​	最早我们使用类似 SHA-256 、SHA-512 、MD5等这样的单向 Hash 算法。用户注册成功后，保存在数据库中不再是用户的明文密码，而是经过 SHA-256 加密计算的一个字行串，当用户进行登录时，用户输入的明文密码用 SHA-256 进行加密，加密完成之后，再和存储在数据库中的密码进行比对，进而确定用户登录信息是否有效。如果系统遭遇攻击，最多也只是存储在数据库中的密文被泄漏。</p>
<p>​	这样就绝对安全了吗？由于彩虹表这种攻击方式的存在以及随着计算机硬件的发展，每秒执行数十亿次 HASH计算己经变得轻轻松松，这意味着即使给密码加密加盐也不再安全。</p>
<p>参考: <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin">彩虹表</a></p>
<h4 id="单向自适应函数"><a href="#单向自适应函数" class="headerlink" title="单向自适应函数"></a>单向自适应函数<Adaptive one-way functions></Adaptive></h4><p>在Spring Security 中，我们现在是用一种自适应单向函数 (Adaptive One-way Functions)来处理密码问题，这种自适应单向函数在进行密码匹配时，会有意占用大量系统资源（例如CPU、内存等），这样可以增加恶意用户攻击系统的难度。在Spring Securiy 中，开发者可以通过 bcrypt、PBKDF2、sCrypt 以及 argon2 来体验这种自适应单向函数加密。由于自适应单向函数有意占用大量系统资源，因此每个登录认证请求都会大大降低应用程序的性能，但是 Spring Secuity 不会采取任何措施来提高密码验证速度，因为它正是通过这种方式来增强系统的安全性。</p>
<p>参考 1: <a target="_blank" rel="noopener" href="https://byronhe.gitbooks.io/libsodium/content/password_hashing/">https://byronhe.gitbooks.io/libsodium/content/password_hashing/</a></p>
<p>参考 2: <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md">https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md</a></p>
<ul>
<li><p>BCryptPasswordEncoder</p>
<p>BCryptPasswordEncoder 使用 bcrypt 算法对密码进行加密，为了提高密码的安全性，bcrypt算法故意降低运行速度，以增强密码破解的难度。同时 BCryptP asswordEncoder “为自己带盐”开发者不需要额外维护一个“盐” 字段，使用 BCryptPasswordEncoder 加密后的字符串就已经“带盐”了，即使相同的明文每次生成的加密字符串都不相同。</p>
</li>
<li><p>Argon2PasswordEncoder</p>
<p>Argon2PasswordEncoder 使用 Argon2 算法对密码进行加密，Argon2 曾在 Password Hashing Competition 竞赛中获胜。为了解决在定制硬件上密码容易被破解的问题，Argon2也是故意降低运算速度，同时需要大量内存，以确保系统的安全性。</p>
</li>
<li><p>Pbkdf2PasswordEncoder</p>
<p>Pbkdf2PasswordEncoder 使用 PBKDF2 算法对密码进行加密，和前面几种类似，PBKDF2</p>
<p>算法也是一种故意降低运算速度的算法，当需要 FIPS (Federal Information Processing Standard,美国联邦信息处理标准）认证时，PBKDF2 算法是一个很好的选择。</p>
</li>
<li><p>SCryptPasswordEncoder</p>
<p>SCryptPasswordEncoder 使用scrypt 算法对密码进行加密，和前面的几种类似，serypt 也是一种故意降低运算速度的算法，而且需要大量内存。</p>
</li>
</ul>
<h2 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h2><p>通过对认证流程源码分析得知，实际密码比较是由PasswordEncoder完成的，因此只需要使用PasswordEncoder 不同实现就可以实现不同方式加密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">	String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span>;</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span>;</span><br><span class="line">	<span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>encode 用来进行明文加密的</li>
<li>matches 用来比较密码的方法</li>
<li>upgradeEncoding 用来给密码进行升级的方法</li>
</ul>
<p>默认提供加密算法如下:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220127162622771.png" alt="image-20220127162622771"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220127162759461.png" alt="image-20220127162759461"></p>
<h2 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a>DelegatingPasswordEncoder</h2><p>根据上面 PasswordEncoder的介绍，可能会以为 Spring security 中默认的密码加密方案应该是四种自适应单向加密函数中的一种，其实不然，在 spring Security 5.0之后，默认的密码加密方案其实是 DelegatingPasswordEncoder。从名字上来看，DelegatingPaswordEncoder 是一个代理类，而并非一种全新的密码加密方案，DeleggtinePasswordEncoder 主要用来代理上面介绍的不同的密码加密方案。为什么采DelegatingPasswordEncoder 而不是某一个具体加密方式作为默认的密码加密方案呢？主要考虑了如下两方面的因素：</p>
<ul>
<li><p>兼容性：使用 DelegatingPasswrordEncoder 可以帮助许多使用旧密码加密方式的系统顺利迁移到 Spring security 中，它允许在同一个系统中同时存在多种不同的密码加密方案。</p>
</li>
<li><p>便捷性：密码存储的最佳方案不可能一直不变，如果使用 DelegatingPasswordEncoder作为默认的密码加密方案，当需要修改加密方案时，只需要修改很小一部分代码就可以实现。</p>
</li>
</ul>
<h4 id="DelegatingPasswordEncoder源码"><a href="#DelegatingPasswordEncoder源码" class="headerlink" title="DelegatingPasswordEncoder源码"></a>DelegatingPasswordEncoder源码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingPasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>encode 用来进行明文加密的</li>
<li>matches 用来比较密码的方法</li>
<li>upgradeEncoding 用来给密码进行升级的方法</li>
</ul>
<h4 id="PasswordEncoderFactories源码"><a href="#PasswordEncoderFactories源码" class="headerlink" title="PasswordEncoderFactories源码"></a>PasswordEncoderFactories源码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PasswordEncoder <span class="title function_">createDelegatingPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">encodingId</span> <span class="operator">=</span> <span class="string">&quot;bcrypt&quot;</span>;</span><br><span class="line">		Map&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		encoders.put(encodingId, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;ldap&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.LdapShaPasswordEncoder());</span><br><span class="line">		encoders.put(<span class="string">&quot;MD4&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.Md4PasswordEncoder());</span><br><span class="line">		encoders.put(<span class="string">&quot;MD5&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">		encoders.put(<span class="string">&quot;noop&quot;</span>, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());</span><br><span class="line">		encoders.put(<span class="string">&quot;pbkdf2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Pbkdf2PasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;SHA-1&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-1&quot;</span>));</span><br><span class="line">		encoders.put(<span class="string">&quot;SHA-256&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-256&quot;</span>));</span><br><span class="line">		encoders.put(<span class="string">&quot;sha256&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.StandardPasswordEncoder());</span><br><span class="line">		encoders.put(<span class="string">&quot;argon2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Argon2PasswordEncoder</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何使用-PasswordEncoder"><a href="#如何使用-PasswordEncoder" class="headerlink" title="如何使用 PasswordEncoder"></a>如何使用 PasswordEncoder</h2><ul>
<li>查看WebSecurityConfigurerAdapter类中源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">		<span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">		LazyPasswordEncoder(ApplicationContext applicationContext) &#123;</span><br><span class="line">			<span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> getPasswordEncoder().encode(rawPassword);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> getPasswordEncoder().matches(rawPassword, encodedPassword);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> getPasswordEncoder().upgradeEncoding(encodedPassword);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> PasswordEncoder <span class="title function_">getPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.passwordEncoder != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">this</span>.passwordEncoder;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> getBeanOrNull(PasswordEncoder.class);</span><br><span class="line">			<span class="keyword">if</span> (passwordEncoder == <span class="literal">null</span>) &#123;</span><br><span class="line">				passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">			<span class="keyword">return</span> passwordEncoder;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> &lt;T&gt; T <span class="title function_">getBeanOrNull</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">this</span>.applicationContext.getBean(type);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> getPasswordEncoder().toString();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码分析得知如果在工厂中指定了PasswordEncoder，就会使用指定PasswordEncoder，否则就会使用默认DelegatingPasswordEncoder。</p>
<h2 id="密码加密实战"><a href="#密码加密实战" class="headerlink" title="密码加密实战"></a>密码加密实战</h2><ul>
<li>测试生成的密码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//1.BCryptPasswordEncoder</span></span><br><span class="line">  <span class="type">BCryptPasswordEncoder</span> <span class="variable">bCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">  System.out.println(bCryptPasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2.Pbkdf2PasswordEncoder</span></span><br><span class="line">  <span class="type">Pbkdf2PasswordEncoder</span> <span class="variable">pbkdf2PasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pbkdf2PasswordEncoder</span>();</span><br><span class="line">  System.out.println(pbkdf2PasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3.SCryptPasswordEncoder //需要额外引入依赖</span></span><br><span class="line">  <span class="type">SCryptPasswordEncoder</span> <span class="variable">sCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>();</span><br><span class="line">  System.out.println(sCryptPasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//4.Argon2PasswordEncoder //需要额外引入依赖</span></span><br><span class="line">  <span class="type">Argon2PasswordEncoder</span> <span class="variable">argon2PasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Argon2PasswordEncoder</span>();</span><br><span class="line">  System.out.println(argon2PasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用固定密码加密方案</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="keyword">public</span> PasswordEncoder <span class="title function_">BcryptPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">     &#125;</span><br><span class="line">  	 <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="string">&quot;xxx&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用灵活密码加密方案</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  	 <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;bcrypt&#125;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="string">&quot;xxx&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="密码自动升级"><a href="#密码自动升级" class="headerlink" title="密码自动升级"></a>密码自动升级</h2><p>推荐使用DelegatingPasswordEncoder 的另外一个好处就是自动进行密码加密方案的升级，这个功能在整合一些老的系统时非常有用。</p>
<ul>
<li>准备库表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`</span><br><span class="line">(</span><br><span class="line">    `id`                    <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `username`              <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `password`              <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `enabled`               tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonExpired`     tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonLocked`      tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `credentialsNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 角色表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role`</span><br><span class="line">(</span><br><span class="line">    `id`      <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name_zh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 用户角色关系表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role`</span><br><span class="line">(</span><br><span class="line">    `id`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY   `uid` (`uid`),</span><br><span class="line">    KEY   `rid` (`rid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<ul>
<li>插入数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入用户数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 插入角色数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_product&#x27;</span>, <span class="string">&#x27;商品管理员&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_admin&#x27;</span>, <span class="string">&#x27;系统管理员&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_user&#x27;</span>, <span class="string">&#x27;用户管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 插入用户角色数据</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>整合 mybatis</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.baizhi.entity</span></span><br><span class="line"><span class="attr">logging.level.com.baizhi.dao</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写实体类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> Boolean credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonExpired</span><span class="params">(Boolean accountNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonExpired = accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonLocked</span><span class="params">(Boolean accountNonLocked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonLocked = accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCredentialsNonExpired</span><span class="params">(Boolean credentialsNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.credentialsNonExpired = credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(Boolean enabled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameZh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameZh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameZh</span><span class="params">(String nameZh)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameZh = nameZh;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建dao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    List&lt;Role&gt; <span class="title function_">getRolesByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">  	Integer <span class="title function_">updatePassword</span><span class="params">(<span class="meta">@Param(&quot;username&quot;)</span> String username,<span class="meta">@Param(&quot;password&quot;)</span> String password)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编写 mapper</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        select id,</span><br><span class="line">               username,</span><br><span class="line">               password,</span><br><span class="line">               enabled,</span><br><span class="line">               accountNonExpired,</span><br><span class="line">               accountNonLocked,</span><br><span class="line">               credentialsNonExpired</span><br><span class="line">        from `user`</span><br><span class="line">        where username = #&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRolesByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Role&quot;</span>&gt;</span></span><br><span class="line">        select r.id,</span><br><span class="line">               r.name,</span><br><span class="line">               r.name_zh nameZh</span><br><span class="line">        from `role` r,</span><br><span class="line">             `user_role` ur</span><br><span class="line">        where r.id = ur.rid</span><br><span class="line">          and ur.uid = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updatePassword&quot;</span>&gt;</span></span><br><span class="line">      update `user` set password=#&#123;password&#125;</span><br><span class="line">      where username=#&#123;username&#125;</span><br><span class="line">  	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写service 实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span>,UserDetailsPasswordService &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户不存在!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setRoles(userDao.getRolesByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	 <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">updatePassword</span><span class="params">(UserDetails user, String newPassword)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> userDao.updatePassword(user.getUsername(), newPassword);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">            ((User) user).setPassword(newPassword);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>配置securityconfig</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyUserDetailService myUserDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(MyUserDetailService myUserDetailService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailService = myUserDetailService;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//查询数据库</span></span><br><span class="line">        auth.userDetailsService(myUserDetailService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动项目测试</li>
</ul>
<h1 id="第六章-Jwt-SpringSecurity实战"><a href="#第六章-Jwt-SpringSecurity实战" class="headerlink" title="第六章 Jwt + SpringSecurity实战"></a>第六章 Jwt + SpringSecurity实战</h1><h3 id="全局异常处理器"><a href="#全局异常处理器" class="headerlink" title="全局异常处理器"></a>全局异常处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.FORBIDDEN)</span></span><br><span class="line">  <span class="meta">@ExceptionHandler(value = AccessDeniedException.class)</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">handler</span><span class="params">(AccessDeniedException e)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;security权限不足：----------------&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> Result</span><br><span class="line">        .fail(<span class="string">&quot;权限不足&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">  <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">handler</span><span class="params">(MethodArgumentNotValidException e)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;实体校验异常：----------------&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> e.getBindingResult();</span><br><span class="line">    <span class="type">ObjectError</span> <span class="variable">objectError</span> <span class="operator">=</span> bindingResult.getAllErrors().stream().findFirst().get();</span><br><span class="line">    <span class="keyword">return</span> Result.fail(objectError.getDefaultMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">  <span class="meta">@ExceptionHandler(value = IllegalArgumentException.class)</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">handler</span><span class="params">(IllegalArgumentException e)</span> &#123;</span><br><span class="line">    log.error(<span class="string">&quot;Assert异常：----------------&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> Result.fail(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">  <span class="meta">@ExceptionHandler(value = RuntimeException.class)</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">handler</span><span class="params">(RuntimeException e)</span> &#123;</span><br><span class="line">    log.error(<span class="string">&quot;运行时异常：----------------&#123;&#125;&quot;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> Result.fail(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="MD5加密"><a href="#MD5加密" class="headerlink" title="MD5加密"></a>MD5加密</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> MD5加密工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gaozhe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/2/6 下午8:51</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MD5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encrypt</span><span class="params">(String strSrc)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">char</span> hexChars[] = &#123;<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>&#125;;</span><br><span class="line">            <span class="type">byte</span>[] bytes = strSrc.getBytes();</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">            md.update(bytes);</span><br><span class="line">            bytes = md.digest();</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">            <span class="type">char</span>[] chars = <span class="keyword">new</span> <span class="title class_">char</span>[j * <span class="number">2</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">                <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> bytes[i];</span><br><span class="line">                chars[k++] = hexChars[b &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0xf</span>];</span><br><span class="line">                chars[k++] = hexChars[b &amp; <span class="number">0xf</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;MD5加密出错！！+&quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="DefaultPasswordEncoder"><a href="#DefaultPasswordEncoder" class="headerlink" title="DefaultPasswordEncoder"></a>DefaultPasswordEncoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 默认密码编码器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gaozhe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/2/6 下午8:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultPasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultPasswordEncoder</span><span class="params">(<span class="type">int</span> strength)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采用MD5加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rawPassword 原生密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> md5编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MD5.encrypt(rawPassword.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行密码对比</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rawPassword     原生密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encodedPassword 加密后的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true/false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> encodedPassword.equals(MD5.encrypt(rawPassword.toString()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>security配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> DefaultPasswordEncoder <span class="title function_">defaultPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultPasswordEncoder</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>





<h3 id="Token工具类"><a href="#Token工具类" class="headerlink" title="Token工具类"></a>Token工具类</h3><blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入jwt--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入fastjson--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.58<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTCreator;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTVerifier;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.algorithms.Algorithm;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 封装Token工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gaozhe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/1/31 上午10:13</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;jwt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLAIN_KEY_USERNAME</span> <span class="operator">=</span> <span class="string">&quot;sub&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLAIN_KEY_CREATED</span> <span class="operator">=</span> <span class="string">&quot;created&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String sign;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Integer expiration;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String header;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据负载返回token对象</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> map payload</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">    JWTCreator.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> JWT.create();</span><br><span class="line">    builder.withExpiresAt(generateExpirationDate());</span><br><span class="line">    map.forEach((k, v) -&gt; &#123;</span><br><span class="line">      builder.withClaim(k, JSON.toJSONString(v));</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> builder.sign(Algorithm.HMAC512(sign));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 生成过期时间</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> Token过期时间</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Date <span class="title function_">generateExpirationDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1000</span> * expiration + System.currentTimeMillis());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取负载解码器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 负载解码器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> DecodedJWT <span class="title function_">getDecode</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="type">JWTVerifier</span> <span class="variable">verifier</span> <span class="operator">=</span> JWT.require(Algorithm.HMAC512(sign)).build();</span><br><span class="line">    <span class="keyword">return</span> verifier.verify(token);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取过期时间</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 过期时间</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Date <span class="title function_">getExpiredDateFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="type">DecodedJWT</span> <span class="variable">decode</span> <span class="operator">=</span> getDecode(token);</span><br><span class="line">    <span class="keyword">return</span> decode.getExpiresAt();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取payload</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 负载</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getPayloadFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="type">DecodedJWT</span> <span class="variable">decode</span> <span class="operator">=</span> getDecode(token);</span><br><span class="line">    <span class="keyword">return</span> decode.getPayload();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * token是否过期</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> true/false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTokenExpired</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">expires</span> <span class="operator">=</span> getExpiredDateFromToken(token);</span><br><span class="line">    <span class="keyword">return</span> expires.before(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取用户名</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 获取用户名</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getUsernameFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    String username;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">DecodedJWT</span> <span class="variable">decode</span> <span class="operator">=</span> getDecode(token);</span><br><span class="line">      username = decode.getSubject();</span><br><span class="line">      <span class="keyword">if</span> (Objects.isNull(username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      username = username.substring(<span class="number">1</span>, username.length() - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      username = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> username;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断token是否过期</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token       token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> userDetails userDetails</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> true/false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> getUsernameFromToken(token);</span><br><span class="line">    <span class="keyword">return</span> StringUtils.equalsIgnoreCase(username, userDetails.getUsername()) &amp;&amp; !isTokenExpired(</span><br><span class="line">        token);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据user信息返回token</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> userDetails userDetails</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(UserDetails userDetails)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    claims.put(CLAIN_KEY_USERNAME, userDetails.getUsername());</span><br><span class="line">    claims.put(CLAIN_KEY_CREATED, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">return</span> generateToken(claims);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据username生成token</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    claims.put(CLAIN_KEY_USERNAME, username);</span><br><span class="line">    claims.put(CLAIN_KEY_CREATED, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">return</span> generateToken(claims);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * token是否需要刷新</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> token token对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> true/false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canRefresh</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !isTokenExpired(token);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">refreshToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">    map.put(CLAIN_KEY_CREATED, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">return</span> generateToken(map);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>jwt配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jwt:</span></span><br><span class="line">  <span class="comment"># 加密秘钥</span></span><br><span class="line">  <span class="attr">sign:</span> <span class="string">f4e2e52034348f86b67cde581c0f9eb5</span></span><br><span class="line">  <span class="comment"># token有效时长，7天，单位秒</span></span><br><span class="line">  <span class="attr">expiration:</span> <span class="number">604800</span></span><br><span class="line">  <span class="attr">header:</span> <span class="string">Authorization</span></span><br></pre></td></tr></table></figure>







<h3 id="公共返回类"><a href="#公共返回类" class="headerlink" title="公共返回类"></a>公共返回类</h3><blockquote>
<p>ResultCodeEnum</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一返回结果状态信息类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultCodeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">200</span>,<span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    FAIL(<span class="number">201</span>, <span class="string">&quot;失败&quot;</span>),</span><br><span class="line">    PARAM_ERROR( <span class="number">202</span>, <span class="string">&quot;参数不正确&quot;</span>),</span><br><span class="line">    SERVICE_ERROR(<span class="number">203</span>, <span class="string">&quot;服务异常&quot;</span>),</span><br><span class="line">    DATA_ERROR(<span class="number">204</span>, <span class="string">&quot;数据异常&quot;</span>),</span><br><span class="line">    DATA_UPDATE_ERROR(<span class="number">205</span>, <span class="string">&quot;数据版本异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    LOGIN_AUTH(<span class="number">208</span>, <span class="string">&quot;未登陆&quot;</span>),</span><br><span class="line">    PERMISSION(<span class="number">209</span>, <span class="string">&quot;没有权限&quot;</span>),</span><br><span class="line"></span><br><span class="line">    CODE_ERROR(<span class="number">210</span>, <span class="string">&quot;验证码错误&quot;</span>),</span><br><span class="line"><span class="comment">//    LOGIN_MOBLE_ERROR(211, &quot;账号不正确&quot;),</span></span><br><span class="line">    LOGIN_DISABLED_ERROR(<span class="number">212</span>, <span class="string">&quot;改用户已被禁用&quot;</span>),</span><br><span class="line">    REGISTER_MOBLE_ERROR(<span class="number">213</span>, <span class="string">&quot;手机号已被使用&quot;</span>),</span><br><span class="line">    LOGIN_AURH(<span class="number">214</span>, <span class="string">&quot;需要登录&quot;</span>),</span><br><span class="line">    LOGIN_ACL(<span class="number">215</span>, <span class="string">&quot;没有权限&quot;</span>),</span><br><span class="line"></span><br><span class="line">    URL_ENCODE_ERROR( <span class="number">216</span>, <span class="string">&quot;URL编码失败&quot;</span>),</span><br><span class="line">    ILLEGAL_CALLBACK_REQUEST_ERROR( <span class="number">217</span>, <span class="string">&quot;非法回调请求&quot;</span>),</span><br><span class="line">    FETCH_ACCESSTOKEN_FAILD( <span class="number">218</span>, <span class="string">&quot;获取accessToken失败&quot;</span>),</span><br><span class="line">    FETCH_USERINFO_ERROR( <span class="number">219</span>, <span class="string">&quot;获取用户信息失败&quot;</span>),</span><br><span class="line">    <span class="comment">//LOGIN_ERROR( 23005, &quot;登录失败&quot;),</span></span><br><span class="line"></span><br><span class="line">    PAY_RUN(<span class="number">220</span>, <span class="string">&quot;支付中&quot;</span>),</span><br><span class="line">    CANCEL_ORDER_FAIL(<span class="number">225</span>, <span class="string">&quot;取消订单失败&quot;</span>),</span><br><span class="line">    CANCEL_ORDER_NO(<span class="number">225</span>, <span class="string">&quot;不能取消预约&quot;</span>),</span><br><span class="line"></span><br><span class="line">    HOSCODE_EXIST(<span class="number">230</span>, <span class="string">&quot;医院编号已经存在&quot;</span>),</span><br><span class="line">    NUMBER_NO(<span class="number">240</span>, <span class="string">&quot;可预约号不足&quot;</span>),</span><br><span class="line">    TIME_NO(<span class="number">250</span>, <span class="string">&quot;当前时间不可以预约&quot;</span>),</span><br><span class="line"></span><br><span class="line">    SIGN_ERROR(<span class="number">300</span>, <span class="string">&quot;签名错误&quot;</span>),</span><br><span class="line">    HOSPITAL_OPEN(<span class="number">310</span>, <span class="string">&quot;医院未开通，暂时不能访问&quot;</span>),</span><br><span class="line">    HOSPITAL_LOCK(<span class="number">320</span>, <span class="string">&quot;医院被锁定，暂时不能访问&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ResultCodeEnum</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Result.java:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局统一返回结果类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;全局统一返回结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回消息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回数据&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Result</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">build</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        Result&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;();</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>)</span><br><span class="line">            result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">build</span><span class="params">(T body, ResultCodeEnum resultCodeEnum)</span> &#123;</span><br><span class="line">        Result&lt;T&gt; result = build(body);</span><br><span class="line">        result.setCode(resultCodeEnum.getCode());</span><br><span class="line">        result.setMessage(resultCodeEnum.getMessage());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">build</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">        Result&lt;T&gt; result = build(<span class="literal">null</span>);</span><br><span class="line">        result.setCode(code);</span><br><span class="line">        result.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="title function_">ok</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="literal">null</span>);</span><br><span class="line">    &#125;		`</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="title function_">ok</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        Result&lt;T&gt; result = build(data);</span><br><span class="line">        <span class="keyword">return</span> build(data, ResultCodeEnum.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="title function_">fail</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Result&lt;T&gt; <span class="title function_">fail</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        Result&lt;T&gt; result = build(data);</span><br><span class="line">        <span class="keyword">return</span> build(data, ResultCodeEnum.FAIL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;T&gt; <span class="title function_">message</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.setMessage(msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;T&gt; <span class="title function_">code</span><span class="params">(Integer code)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.setCode(code);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.getCode().intValue() == ResultCodeEnum.SUCCESS.getCode().intValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="登出处理器"><a href="#登出处理器" class="headerlink" title="登出处理器"></a>登出处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">      Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">SecurityContextLogoutHandler</span>().logout(request, response, authentication);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">    response.setHeader(jwtUtils.getHeader(), <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.ok(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>配置security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.logout().logoutSuccessHandler(jwtLogoutSuccessHandler)</span><br></pre></td></tr></table></figure>









<h3 id="AuthenticationFailureHandler-认证失败处理器"><a href="#AuthenticationFailureHandler-认证失败处理器" class="headerlink" title="AuthenticationFailureHandler: 认证失败处理器"></a>AuthenticationFailureHandler: 认证失败处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.model.Result;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 认证失败处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gzzear</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/01/19 23:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">      AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.fail(exception.getMessage());</span><br><span class="line"></span><br><span class="line">    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="AuthenticationSuccessHandler-认证成功处理器"><a href="#AuthenticationSuccessHandler-认证成功处理器" class="headerlink" title="AuthenticationSuccessHandler: 认证成功处理器"></a>AuthenticationSuccessHandler: 认证成功处理器</h3><p>认证成功后需要将token返回,或设置到header</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.model.Result;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 认证成功处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gzzear</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/01/19 23:17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">      Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成jwt，并放置到请求头中</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> jwtUtils.generateToken(authentication.getName());</span><br><span class="line">    response.setHeader(jwtUtils.getHeader(), jwt);</span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.ok(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>security配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">LoginSuccessHandler loginSuccessHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">LoginFailureHandler loginFailureHandler;</span><br><span class="line"></span><br><span class="line">...# configure代码：</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  http.cors().and().csrf().disable()    </span><br><span class="line">  .formLogin()      </span><br><span class="line">  .failureHandler(loginFailureHandler)      </span><br><span class="line">  .successHandler(loginSuccessHandler)</span><br></pre></td></tr></table></figure>









<h3 id="验证码异常"><a href="#验证码异常" class="headerlink" title="验证码异常"></a>验证码异常</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 验证码异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gzzear</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/01/19 23:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">CaptchaException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="验证码过滤器"><a href="#验证码过滤器" class="headerlink" title="验证码过滤器"></a>验证码过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.config.security.handler.LoginFailureHandler;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.constant.BusinessConstant;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.exception.CaptchaException;</span><br><span class="line"><span class="keyword">import</span> com.gz.demo.utils.RedisUtil;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  LoginFailureHandler loginFailureHandler;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest,</span></span><br><span class="line"><span class="params">      HttpServletResponse httpServletResponse, FilterChain filterChain)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> httpServletRequest.getRequestURI();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/login&quot;</span>.equals(url) &amp;&amp; httpServletRequest.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 校验验证码</span></span><br><span class="line">        validate(httpServletRequest);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (CaptchaException e) &#123;</span><br><span class="line">        <span class="comment">// 交给认证失败处理器</span></span><br><span class="line">        loginFailureHandler.onAuthenticationFailure(httpServletRequest, httpServletResponse, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验验证码逻辑</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(HttpServletRequest httpServletRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> httpServletRequest.getParameter(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> httpServletRequest.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(code) || StringUtils.isBlank(key)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CaptchaException</span>(<span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!code.equals(redisUtil.get(BusinessConstant.CAPTCHA_KEY + key))) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CaptchaException</span>(<span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一次性使用</span></span><br><span class="line">    redisUtil.deleteKey(BusinessConstant.CAPTCHA_KEY + key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>security配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> CaptchaFilter captchaFilter;</span><br><span class="line"></span><br><span class="line">http...</span><br><span class="line">.and().addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure>





<h3 id="SecurityUser-认证授权实体类"><a href="#SecurityUser-认证授权实体类" class="headerlink" title="SecurityUser: 认证授权实体类"></a>SecurityUser: 认证授权实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 认证授权实体类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> gzzear</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/01/19 20:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> accountNonExpired;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> accountNonLocked;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> credentialsNonExpired;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SecurityUser</span><span class="params">(Long userId, String username, String password,</span></span><br><span class="line"><span class="params">      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(userId, username, password, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, authorities);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SecurityUser</span><span class="params">(Long userId, String username, String password, <span class="type">boolean</span> enabled,</span></span><br><span class="line"><span class="params">      <span class="type">boolean</span> accountNonExpired,</span></span><br><span class="line"><span class="params">      <span class="type">boolean</span> credentialsNonExpired, <span class="type">boolean</span> accountNonLocked,</span></span><br><span class="line"><span class="params">      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">    Assert.isTrue(username != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(username) &amp;&amp; password != <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;Cannot pass null or empty values to constructor&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    <span class="built_in">this</span>.username = username;</span><br><span class="line">    <span class="built_in">this</span>.password = password;</span><br><span class="line">    <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    <span class="built_in">this</span>.accountNonExpired = accountNonExpired;</span><br><span class="line">    <span class="built_in">this</span>.credentialsNonExpired = credentialsNonExpired;</span><br><span class="line">    <span class="built_in">this</span>.accountNonLocked = accountNonLocked;</span><br><span class="line">    <span class="built_in">this</span>.authorities = authorities;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.authorities;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.username;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.accountNonExpired;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.accountNonLocked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.credentialsNonExpired;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.enabled;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="实现UserDetailService自定义数据源"><a href="#实现UserDetailService自定义数据源" class="headerlink" title="实现UserDetailService自定义数据源"></a>实现UserDetailService自定义数据源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="comment">//根据用户名获取用户</span></span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.loadUserByUserName(username);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecurityUser</span>(sysUser.getId(), sysUser.getUsername(),</span><br><span class="line">        sysUser.getPassword(), sysUserService.getAuthorityInfo(sysUser.getId()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;SysUserMapper, SysUser&gt; <span class="keyword">implements</span></span><br><span class="line">    <span class="title class_">SysUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> SysUserMapper sysUserMapper;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> SysUser <span class="title function_">loadUserByUserName</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(SysUser::getUsername, username).eq(SysUser::getStatus, <span class="number">1</span>).one();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getAuthority</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="comment">//根据userId获取对应的角色信息</span></span><br><span class="line">    List&lt;SysRole&gt; roles = sysUserMapper.findRolesByUserId(userId);</span><br><span class="line">    <span class="type">String</span> <span class="variable">roleCodes</span> <span class="operator">=</span> roles.stream().map(role -&gt; <span class="string">&quot;ROLE_&quot;</span> + role.getCode())</span><br><span class="line">        .collect(Collectors.joining(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">    <span class="comment">//根据角色id获取对应的菜单信息</span></span><br><span class="line">    List&lt;Long&gt; roleIds = roles.stream().map(SysRole::getId).collect(Collectors.toList());</span><br><span class="line">    List&lt;SysMenu&gt; menus = sysUserMapper.findMenusByRoleIds(roleIds);</span><br><span class="line">    <span class="type">String</span> <span class="variable">permissions</span> <span class="operator">=</span> menus.stream().map(SysMenu::getPerms).collect(Collectors.joining(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> roleCodes.concat(permissions);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorityInfo(Long userId) &#123;</span><br><span class="line">    <span class="comment">//ROLE_admin,sys:user:save,sys:user:list.....</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">authorities</span> <span class="operator">=</span> getAuthority(userId);</span><br><span class="line">     <span class="comment">// 通过内置的工具类，把权限字符串封装成GrantedAuthority列表</span></span><br><span class="line">    <span class="keyword">return</span> AuthorityUtils.commaSeparatedStringToAuthorityList(authorities);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> SysUser <span class="title function_">getUserByName</span><span class="params">(String usernameFromToken)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(SysUser::getUsername, usernameFromToken).eq(SysUser::getStatus, <span class="number">1</span>)</span><br><span class="line">        .one();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>配置security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailServiceImpl userDetailService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService(userDetailService);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>





<h3 id="BasicAuthenticationFilter-验证jwt-header"><a href="#BasicAuthenticationFilter-验证jwt-header" class="headerlink" title="BasicAuthenticationFilter: 验证jwt header"></a>BasicAuthenticationFilter: 验证jwt header</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">BasicAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(authenticationManager);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">      FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> request.getHeader(jwtUtils.getHeader());</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlankOrUndefined(jwt)) &#123;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">usernameFromToken</span> <span class="operator">=</span> jwtUtils.getUsernameFromToken(jwt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (usernameFromToken == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JwtException</span>(<span class="string">&quot;token 异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (jwtUtils.isTokenExpired(jwt)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JwtException</span>(<span class="string">&quot;token已过期&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户的权限等信息</span></span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.loadUserByUserName(usernameFromToken);</span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">token</span></span><br><span class="line">        <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(usernameFromToken, <span class="literal">null</span>,</span><br><span class="line">        sysUserService.getAuthorityInfo(sysUser.getId()));</span><br><span class="line"></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(token);</span><br><span class="line"></span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="AuthenticationEntryPoint-jwt认证失败处理器"><a href="#AuthenticationEntryPoint-jwt认证失败处理器" class="headerlink" title="AuthenticationEntryPoint: jwt认证失败处理器"></a>AuthenticationEntryPoint: jwt认证失败处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">      AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.fail(<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<blockquote>
<p>配置security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">JWTAuthenticationFilter <span class="title function_">jwtAuthenticationFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;   </span><br><span class="line">  <span class="type">JWTAuthenticationFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JWTAuthenticationFilter</span>(authenticationManager());   </span><br><span class="line">  <span class="keyword">return</span> filter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)</span><br><span class="line"></span><br><span class="line"> .and().addFilter(jwtAuthenticationFilter()).addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class) <span class="comment">// 登录验证码校验过滤器</span></span><br></pre></td></tr></table></figure>





<h3 id="AccessDeniedHandler-无权限处理器"><a href="#AccessDeniedHandler-无权限处理器" class="headerlink" title="AccessDeniedHandler: 无权限处理器"></a>AccessDeniedHandler: 无权限处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">    response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.fail(accessDeniedException.getMessage());</span><br><span class="line"></span><br><span class="line">    outputStream.write(JSONUtil.toJsonStr(result).getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>配置security</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint(jwtAuthenticationEntryPoint)</span><br><span class="line">				.accessDeniedHandler(jwtAccessDeniedHandler)</span><br></pre></td></tr></table></figure>





<h3 id="Security配置"><a href="#Security配置" class="headerlink" title="Security配置"></a>Security配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.markerhub.security.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	LoginFailureHandler loginFailureHandler;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	LoginSuccessHandler loginSuccessHandler;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CaptchaFilter captchaFilter;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JwtAccessDeniedHandler jwtAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	UserDetailServiceImpl userDetailService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JwtLogoutSuccessHandler jwtLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	JwtAuthenticationFilter <span class="title function_">jwtAuthenticationFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">JwtAuthenticationFilter</span> <span class="variable">jwtAuthenticationFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(authenticationManager());</span><br><span class="line">		<span class="keyword">return</span> jwtAuthenticationFilter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	BCryptPasswordEncoder <span class="title function_">bCryptPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] URL_WHITELIST = &#123;</span><br><span class="line"></span><br><span class="line">			<span class="string">&quot;/login&quot;</span>,</span><br><span class="line">			<span class="string">&quot;/logout&quot;</span>,</span><br><span class="line">			<span class="string">&quot;/captcha&quot;</span>,</span><br><span class="line">			<span class="string">&quot;/favicon.ico&quot;</span>,</span><br><span class="line"></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		http.cors().and().csrf().disable()</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 登录配置</span></span><br><span class="line">				.formLogin()</span><br><span class="line">				.successHandler(loginSuccessHandler)</span><br><span class="line">				.failureHandler(loginFailureHandler)</span><br><span class="line"></span><br><span class="line">				.and()</span><br><span class="line">				.logout()</span><br><span class="line">				.logoutSuccessHandler(jwtLogoutSuccessHandler)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 禁用session</span></span><br><span class="line">				.and()</span><br><span class="line">				.sessionManagement()</span><br><span class="line">				.sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 配置拦截规则</span></span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(URL_WHITELIST).permitAll()</span><br><span class="line">				.anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 异常处理器</span></span><br><span class="line">				.and()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint(jwtAuthenticationEntryPoint)</span><br><span class="line">				.accessDeniedHandler(jwtAccessDeniedHandler)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 配置自定义的过滤器</span></span><br><span class="line">				.and()</span><br><span class="line">				.addFilter(jwtAuthenticationFilter())</span><br><span class="line">				.addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line"></span><br><span class="line">		;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		auth.userDetailsService(userDetailService);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="Swagger2配置"><a href="#Swagger2配置" class="headerlink" title="Swagger2配置"></a>Swagger2配置</h3><blockquote>
<p>swagger配置类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Swagger2配置类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhoubin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swagger2Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">//为当前包下的controller生成api文档</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.gz.yeb.controller&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build()</span><br><span class="line">                <span class="comment">//添加登录认证</span></span><br><span class="line">                .securitySchemes(securitySchemes())</span><br><span class="line">                .securityContexts(securityContexts());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;云E办接口文档&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;云E办接口文档&quot;</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;gaozhe&quot;</span>, <span class="string">&quot;http:localhost:8081/doc.html&quot;</span>, <span class="string">&quot;373795878@qq.com&quot;</span>))</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityScheme&gt; <span class="title function_">securitySchemes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//设置请求头信息</span></span><br><span class="line">        List&lt;SecurityScheme&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ApiKey</span> <span class="variable">apiKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiKey</span>(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Header&quot;</span>);</span><br><span class="line">        result.add(apiKey);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityContext&gt; <span class="title function_">securityContexts</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//设置需要登录认证的路径</span></span><br><span class="line">        List&lt;SecurityContext&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        result.add(getContextByPath(<span class="string">&quot;/hello/.*&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SecurityContext <span class="title function_">getContextByPath</span><span class="params">(String pathRegex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SecurityContext.builder()</span><br><span class="line">                .securityReferences(defaultAuth())</span><br><span class="line">                .forPaths(PathSelectors.regex(pathRegex))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityReference&gt; <span class="title function_">defaultAuth</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;SecurityReference&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">AuthorizationScope</span> <span class="variable">authorizationScope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationScope</span>(<span class="string">&quot;global&quot;</span>, <span class="string">&quot;accessEverything&quot;</span>);</span><br><span class="line">        AuthorizationScope[] authorizationScopes = <span class="keyword">new</span> <span class="title class_">AuthorizationScope</span>[<span class="number">1</span>];</span><br><span class="line">        authorizationScopes[<span class="number">0</span>] = authorizationScope;</span><br><span class="line">        result.add(<span class="keyword">new</span> <span class="title class_">SecurityReference</span>(<span class="string">&quot;Authorization&quot;</span>, authorizationScopes));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<blockquote>
<p>security配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">//放行静态资源</span></span><br><span class="line">       web.ignoring().antMatchers(</span><br><span class="line">               <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/logout&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/css/**&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/js/**&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/index.html&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/favicon.ico&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/doc.html&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/webjars/**&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/swagger-resources/**&quot;</span>,</span><br><span class="line">               <span class="string">&quot;/v2/api-docs/**&quot;</span></span><br><span class="line">       );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<h1 id="第七章-RememberMe"><a href="#第七章-RememberMe" class="headerlink" title="第七章 RememberMe"></a>第七章 RememberMe</h1><ul>
<li>简介</li>
<li>基本使用</li>
<li>原理分析</li>
<li>持久化令牌</li>
</ul>
<h2 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h2><p>RememberMe 这个功能非常常见，下图就是QQ 邮箱登录时的“记住我” 选项。提到 RememberMe，一些初学者往往会有一些误解，认为 RememberMe 功能就是把用户名&#x2F;密码用 Cookie 保存在浏览器中，下次登录时不用再次输入用户名&#x2F;密码。这个理解显然是不对的。我们这里所说的 RememberMe 是一种服务器端的行为。传统的登录方式基于 Session会话，一旦用户的会话超时过期，就要再次登录，这样太过于烦琐。如果能有一种机制，让用户会话过期之后，还能继续保持认证状态，就会方便很多，RememberMe 就是为了解决这一需求而生的。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308185102746.png" alt="image-20220308185102746"></p>
<p>具体的实现思路就是通过 Cookie 来记录当前用户身份。当用户登录成功之后，会通过一定算法，将用户信息、时间戳等进行加密，加密完成后，通过响应头带回前端存储在cookie中，当浏览器会话过期之后，如果再次访问该网站，会自动将 Cookie 中的信息发送给服务器，服务器对 Cookie中的信息进行校验分析，进而确定出用户的身份，Cookie中所保存的用户信息也是有时效的，例如三天、一周等。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="开始记住我"><a href="#开始记住我" class="headerlink" title="开始记住我"></a>开始记住我</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//开启记住我功能</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="使用记住我"><a href="#使用记住我" class="headerlink" title="使用记住我"></a>使用记住我</h3><p>可以看到一旦打开了记住我功能，登录页面中会多出一个 RememberMe 选项。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308190409305.png" alt="image-20220308190409305"></p>
<h3 id="测试记住我"><a href="#测试记住我" class="headerlink" title="测试记住我"></a>测试记住我</h3><p>登录时勾选 RememberMe 选项，然后重启服务端之后，在测试接口是否能免登录访问。</p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><h3 id="RememberMeAuthenticationFilter"><a href="#RememberMeAuthenticationFilter" class="headerlink" title="RememberMeAuthenticationFilter"></a>RememberMeAuthenticationFilter</h3><p><img src="/2022/01/26/SpringSecurity/image-20220317194843649.png" alt="image-20220317194843649"></p>
<p>从上图中，当在SecurityConfig配置中开启了”记住我”功能之后,在进行认证时如果勾选了”记住我”选项，此时打开浏览器控制台，分析整个登录过程。首先当我们登录时，在登录请求中多了一个 RememberMe 的参数。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308191736005.png" alt="image-20220308191736005"></p>
<p>很显然，这个参数就是告诉服务器应该开启 RememberMe功能的。如果自定义登录页面开启 RememberMe 功能应该多加入一个一样的请求参数就可以啦。该请求会被 <code>RememberMeAuthenticationFilter</code>进行拦截然后自动登录具体参见源码:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220317195930708.png" alt="image-20220317195930708"></p>
<ul>
<li><p>(1）请求到达过滤器之后，首先判断 SecurityContextHolder 中是否有值，没值的话表示用户尚未登录，此时调用 autoLogin 方法进行自动登录。</p>
</li>
<li><p>(2）当自动登录成功后返回的rememberMeAuth 不为null 时，表示自动登录成功，此时调用 authenticate 方法对 key 进行校验，并且将登录成功的用户信息保存到 SecurityContextHolder 对象中，然后调用登录成功回调，并发布登录成功事件。需要注意的是，登录成功的回调并不包含 RememberMeServices 中的 loginSuccess 方法。</p>
</li>
<li><p>(3）如果自动登录失败，则调用 remenberMeServices.loginFail方法处理登录失败回调。onUnsuccessfulAuthentication 和 onSuccessfulAuthentication 都是该过滤器中定义的空方法，并没有任何实现这就是 RememberMeAuthenticationFilter 过滤器所做的事情，成功将 RememberMeServices的服务集成进来。</p>
</li>
</ul>
<h3 id="RememberMeServices"><a href="#RememberMeServices" class="headerlink" title="RememberMeServices"></a>RememberMeServices</h3><p>这里一共定义了三个方法：</p>
<ol>
<li>autoLogin 方法可以从请求中提取出需要的参数，完成自动登录功能。</li>
<li>loginFail 方法是自动登录失败的回调。</li>
<li>loginSuccess 方法是自动登录成功的回调。</li>
</ol>
<p><img src="/2022/01/26/SpringSecurity/image-20220317200522015.png" alt="image-20220317200522015"></p>
<h3 id="TokenBasedRememberMeServices"><a href="#TokenBasedRememberMeServices" class="headerlink" title="TokenBasedRememberMeServices"></a>TokenBasedRememberMeServices</h3><p>在开启记住我后如果没有加入额外配置默认实现就是由TokenBasedRememberMeServices进行的实现。查看这个类源码中 processAutoLoginCookie 方法实现:</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220317201055784.png" alt="image-20220317201055784"></p>
<p>processAutoLoginCookie 方法主要用来验证 Cookie 中的令牌信息是否合法：</p>
<ol>
<li><p>首先判断 cookieTokens 长度是否为3，不为了说明格式不对，则直接抛出异常。</p>
</li>
<li><p>从cookieTokens 数组中提取出第 1项，也就是过期时间，判断令牌是否过期，如果己经过期，则拋出异常。</p>
</li>
<li><p>根据用户名 （cookieTokens 数组的第2项）查询出当前用户对象。</p>
</li>
<li><p>调用 makeTokenSignature 方法生成一个签名，签名的生成过程如下：首先将用户名、令牌过期时间、用户密码以及 key 组成一个宇符串，中间用“：”隔开，然后通过 MD5 消息摘要算法对该宇符串进行加密，并将加密结果转为一个字符串返回。</p>
</li>
<li><p>判断第4 步生成的签名和通过 Cookie 传来的签名是否相等（即 cookieTokens 数组<br>的第2项），如果相等，表示令牌合法，则直接返回用户对象，否则拋出异常。</p>
</li>
</ol>
<p><img src="/2022/01/26/SpringSecurity/image-20220318142054096.png" alt="image-20220318142054096"></p>
<ol>
<li><p>在这个回调中，首先获取用户经和密码信息，如果用户密码在用户登录成功后从successfulAuthentication对象中擦除，则从数据库中重新加载出用户密码。</p>
</li>
<li><p>计算出令牌的过期时间，令牌默认有效期是两周。</p>
</li>
<li><p>根据令牌的过期时间、用户名以及用户密码，计算出一个签名。</p>
</li>
<li><p>调用 setCookie 方法设置 Cookie， 第一个参数是一个数组，数组中一共包含三项。用户名、过期时间以及签名，在setCookie 方法中会将数组转为字符串，并进行 Base64编码后响应给前端。</p>
</li>
</ol>
<blockquote>
<p>什么时候生成rememberMe Cookie</p>
</blockquote>
<p><img src="/2022/01/26/SpringSecurity/image-20230121004712057.png" alt="image-20230121004712057"></p>
<p>在登录验证是如果通过则会设置SecurityContext, 并设置Cookie</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>当用户通过用户名&#x2F;密码的形式登录成功后，系统会根据用户的用户名、密码以及令牌的过期时间计算出一个签名，这个签名使用 MD5 消息摘要算法生成，是不可逆的。然后再将用户名、令牌过期时间以及签名拼接成一个字符串，中间用“:” 隔开，对拼接好的字符串进行Base64 编码，然后将编码后的结果返回到前端，也就是我们在浏览器中看到的令牌。当会话过期之后，访问系统资源时会自动携带上Cookie中的令牌，服务端拿到 Cookie中的令牌后，先进行 Bae64解码，解码后分别提取出令牌中的三项数据：接着根据令牌中的数据判断令牌是否已经过期，如果没有过期，则根据令牌中的用户名查询出用户信息：接着再计算出一个签名和令牌中的签名进行对比，如果一致，表示会牌是合法令牌，自动登录成功，否则自动登录失败。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220308192413735.png" alt="image-20220308192413735"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220319124115432.png" alt="image-20220319124115432"></p>
<h2 id="内存令牌"><a href="#内存令牌" class="headerlink" title="内存令牌"></a>内存令牌</h2><h3 id="PersistentTokenBasedRememberMeServices"><a href="#PersistentTokenBasedRememberMeServices" class="headerlink" title="PersistentTokenBasedRememberMeServices"></a>PersistentTokenBasedRememberMeServices</h3><p><img src="/2022/01/26/SpringSecurity/image-20220319104657210.png" alt="image-20220319104657210"></p>
<ol>
<li>不同于 TokonBasedRemornberMeServices 中的 processAutologinCookie 方法，这里cookieTokens 数组的长度为2，第一项是series，第二项是 token。</li>
<li>从cookieTokens数组中分到提取出 series 和 token． 然后根据 series 去内存中查询出一个 PersistentRememberMeToken对象。如果查询出来的对象为null，表示内存中并没有series对应的值，本次自动登录失败。如果查询出来的 token 和从 cookieTokens 中解析出来的token不相同，说明自动登录会牌已经泄漏（恶意用户利用令牌登录后，内存中的token变了)，此时移除当前用户的所有自动登录记录并抛出异常。</li>
<li>根据数据库中查询出来的结果判断令牌是否过期，如果过期就抛出异常。</li>
<li>生成一个新的 PersistentRememberMeToken 对象，用户名和series 不变，token 重新<br>生成，date 也使用当前时间。newToken 生成后，根据 series 去修改内存中的 token 和 date(即每次自动登录后都会产生新的 token 和 date）</li>
<li>调用 addCookie 方法添加 Cookie， 在addCookie 方法中，会调用到我们前面所说的<br>setCookie 方法，但是要注意第一个数组参数中只有两项：series 和 token（即返回到前端的令牌是通过对 series 和 token 进行 Base64 编码得到的）</li>
<li>最后将根据用户名查询用户对象并返回。</li>
</ol>
<h3 id="使用内存中令牌实现"><a href="#使用内存中令牌实现" class="headerlink" title="使用内存中令牌实现"></a>使用内存中令牌实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123; </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//开启记住我功能</span></span><br><span class="line">                .rememberMeServices(rememberMeServices())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RememberMeServices <span class="title function_">rememberMeServices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PersistentTokenBasedRememberMeServices</span>(</span><br><span class="line">          	   <span class="string">&quot;key&quot;</span>,<span class="comment">//参数 1: 自定义一个生成令牌 key 默认 UUID  </span></span><br><span class="line">               userDetailsService(), <span class="comment">//参数 2:认证数据源  </span></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">InMemoryTokenRepositoryImpl</span>());<span class="comment">//参数 3:令牌存储方式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="持久化令牌"><a href="#持久化令牌" class="headerlink" title="持久化令牌"></a>持久化令牌</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.entity</span></span><br></pre></td></tr></table></figure>

<h3 id="配置持久化令牌"><a href="#配置持久化令牌" class="headerlink" title="配置持久化令牌"></a>配置持久化令牌</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">persistentTokenRepository</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        jdbcTokenRepository.setCreateTableOnStartup(<span class="literal">false</span>);<span class="comment">//只需要没有表时设置为 true</span></span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">//..</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">								 <span class="comment">//...</span></span><br><span class="line">                .logout()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//开启记住我功能</span></span><br><span class="line">                .tokenRepository(persistentTokenRepository())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动项目并查看数据库"><a href="#启动项目并查看数据库" class="headerlink" title="启动项目并查看数据库"></a>启动项目并查看数据库</h3><p><strong><code>注意:启动项目会自动创建一个表,用来保存记住我的 token 信息 </code></strong></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220224142025628.png" alt="image-20220224142025628"></p>
<h3 id="再次测试记住我"><a href="#再次测试记住我" class="headerlink" title="再次测试记住我"></a>再次测试记住我</h3><p>在测试发现即使服务器重新启动，依然可以自动登录。</p>
<h2 id="自定义记住我"><a href="#自定义记住我" class="headerlink" title="自定义记住我"></a>自定义记住我</h2><h3 id="查看记住我源码"><a href="#查看记住我源码" class="headerlink" title="查看记住我源码"></a>查看记住我源码</h3><p>AbstractUserDetailsAuthenticationProvider类中authenticate方法在最后认证成功之后实现了记住我功能，但是查看源码得知如果开启记住我,必须进行相关的设置 </p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184455083.png" alt="image-20200814184455083"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184605516.png" alt="image-20200814184605516"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814184651238.png" alt="image-20200814184651238"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20200814185157418.png" alt="image-20200814185157418"></p>
<h3 id="传统-web-开发记住我实现"><a href="#传统-web-开发记住我实现" class="headerlink" title="传统 web 开发记住我实现"></a>传统 web 开发记住我实现</h3><p>通过源码分析得知必须在认证请求中加入参数remember-me值为”true,on,yes,1”其中任意一个才可以完成记住我功能,这个时候修改认证界面:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  	记住我: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span> <span class="attr">value</span>=<span class="string">&quot;on|yes|true|1&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置中开启记住我</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .....</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//开启记住我</span></span><br><span class="line">                <span class="comment">//.alwaysRemember(true) 总是记住我</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前后端分离开发记住我实现"><a href="#前后端分离开发记住我实现" class="headerlink" title="前后端分离开发记住我实现"></a>前后端分离开发记住我实现</h3><h4 id="自定义认证类-LoginFilter"><a href="#自定义认证类-LoginFilter" class="headerlink" title="自定义认证类 LoginFilter"></a>自定义认证类 LoginFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义前后端分离认证 Filter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="comment">//1.判断是否是 post 方式请求</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.判断是否是 json 格式请求类型</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">            <span class="comment">//3.从 json 数据中获取用户输入用户名和密码进行认证 &#123;&quot;uname&quot;:&quot;xxx&quot;,&quot;password&quot;:&quot;xxx&quot;,&quot;remember-me&quot;:true&#125;</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">rememberValue</span> <span class="operator">=</span> userInfo.get(AbstractRememberMeServices.DEFAULT_PARAMETER);</span><br><span class="line">                <span class="keyword">if</span> (!ObjectUtils.isEmpty(rememberValue)) &#123;</span><br><span class="line">                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;用户名: &quot;</span> + username + <span class="string">&quot; 密码: &quot;</span> + password + <span class="string">&quot; 是否记住我: &quot;</span> + rememberValue);</span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义-RememberMeService"><a href="#自定义-RememberMeService" class="headerlink" title="自定义 RememberMeService"></a>自定义 RememberMeService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义记住我 services 实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span> <span class="keyword">extends</span> <span class="title class_">PersistentTokenBasedRememberMeServices</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPersistentTokenBasedRememberMeServices</span><span class="params">(String key, UserDetailsService userDetailsService, PersistentTokenRepository tokenRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(key, userDetailsService, tokenRepository);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义前后端分离获取 remember-me 方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">rememberMeRequested</span><span class="params">(HttpServletRequest request, String parameter)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getAttribute(parameter).toString();</span><br><span class="line">        <span class="keyword">if</span> (paramValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (paramValue.equalsIgnoreCase(<span class="string">&quot;true&quot;</span>) || paramValue.equalsIgnoreCase(<span class="string">&quot;on&quot;</span>)</span><br><span class="line">                    || paramValue.equalsIgnoreCase(<span class="string">&quot;yes&quot;</span>) || paramValue.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置记住我"><a href="#配置记住我" class="headerlink" title="配置记住我"></a>配置记住我</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义 filter 交给工厂管理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        loginFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);<span class="comment">//指定认证 url</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);<span class="comment">//指定接收json 用户名 key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);<span class="comment">//指定接收 json 密码 key</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        loginFilter.setRememberMeServices(rememberMeServices()); <span class="comment">//设置认证成功时使用自定义rememberMeService</span></span><br><span class="line">        <span class="comment">//认证成功处理</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">            result.put(<span class="string">&quot;用户信息&quot;</span>, authentication.getPrincipal());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//认证失败处理</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录失败: &quot;</span> + ex.getMessage());</span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()<span class="comment">//所有请求必须认证</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//开启记住我功能  cookie 进行实现  1.认证成功保存记住我 cookie 到客户端   2.只有 cookie 写入客户端成功才能实现自动登录功能</span></span><br><span class="line">                .rememberMeServices(rememberMeServices())  <span class="comment">//设置自动登录使用哪个 rememberMeServices</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.getWriter().println(<span class="string">&quot;请认证之后再去处理!&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, HttpMethod.DELETE.name()),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, HttpMethod.GET.name())</span><br><span class="line">                ))</span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">                    result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line">                    result.put(<span class="string">&quot;用户信息&quot;</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(s);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// at: 用来某个 filter 替换过滤器链中哪个 filter</span></span><br><span class="line">        <span class="comment">// before: 放在过滤器链中哪个 filter 之前</span></span><br><span class="line">        <span class="comment">// after: 放在过滤器链中那个 filter 之后</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RememberMeServices <span class="title function_">rememberMeServices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span>(UUID.randomUUID().toString(), userDetailsService(), <span class="keyword">new</span> <span class="title class_">InMemoryTokenRepositoryImpl</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第八章-会话管理"><a href="#第八章-会话管理" class="headerlink" title="第八章 会话管理"></a>第八章 会话管理</h1><ul>
<li>简介</li>
<li>会话并发管理</li>
<li>会话共享实战</li>
</ul>
<h2 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h2><p>当浏览器调用登录接口登录成功后，服务端会和浏览器之间建立一个会话 (Session) 浏览器在每次发送请求时都会携带一个 Sessionld，服务端则根据这个 Sessionld 来判断用户身份。当浏览器关闭后，服务端的 Session 并不会自动销毁，需要开发者手动在服务端调用 Session销毁方法，或者等 Session 过期时间到了自动销毁。在Spring Security 中，与HttpSession相关的功能由 <strong>SessionManagementFilter</strong> 和<strong>SessionAuthenticationStrateey</strong> 接口来处理，<strong>SessionManagomentFilter</strong> 过滤器将 Session 相关操作委托给 <strong>SessionAuthenticationStrateey</strong> 接口去完成。</p>
<h2 id="会话并发管理"><a href="#会话并发管理" class="headerlink" title="会话并发管理"></a>会话并发管理</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>会话并发管理就是指在当前系统中，同一个用户可以同时创建多少个会话，如果一个设备对应一个会话，那么也可以简单理解为同一个用户可以同时在多少台设备上进行登录。默认情况下，同一用户在多少台设备上登录并没有限制，不过开发者可以在 Spring Security 中对此进行配置</p>
<h3 id="开启会话管理"><a href="#开启会话管理" class="headerlink" title="开启会话管理"></a>开启会话管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .sessionManagement()  <span class="comment">//开启会话管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>);  <span class="comment">//设置会话并发数为 1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>sessionManagement</strong>() 用来开启会话管理、<strong>maximumSessions</strong> 指定会话的并发数为 1。</li>
<li>HttpSessionEventPublisher 提供一一个Htp SessionEvenePubishor-实例。Spring Security中通过一个 Map 集合来集护当前的 Http Session 记录，进而实现会话的并发管理。当用户登录成功时，就向集合中添加一条Http Session 记录；当会话销毁时，就从集合中移除一条 Httpsession 记录。HtpSesionEvenPublisher 实现了 Fttp SessionListener 接口，可以监听到 HtpSession 的创建和销毀事件，并将 Fltp Session 的创建&#x2F;销毁事件发布出去，这样，当有 HttpSession 销毀时，Spring Security 就可以感知到该事件了。</li>
</ol>
<h3 id="测试会话管理"><a href="#测试会话管理" class="headerlink" title="测试会话管理"></a>测试会话管理</h3><p>配置完成后，启动项目。这次测试我们需要两个浏览器，如果使用了 Chrome 浏览器，可以使用 Chrome 浏览器中的多用户方式（相当于两个浏览器）先在第一个浏览器中输入 <a href="http://localhost:8080，此时会自动跳转到登录页面，完成登录操作，就可以访问到数据了；接下来在第二个浏览器中也输入">http://localhost:8080，此时会自动跳转到登录页面，完成登录操作，就可以访问到数据了；接下来在第二个浏览器中也输入</a> <a href="http://localhost:8080，也需要登录，">http://localhost:8080，也需要登录，</a><br>完成登录操作；当第二个浏览器登录成功后，再回到第一个浏览器，刷新页面。结果出现下图：<img src="/2022/01/26/SpringSecurity/image-20220308195448860.png" alt="image-20220308195448860"></p>
<h2 id="会话失效处理"><a href="#会话失效处理" class="headerlink" title="会话失效处理"></a>会话失效处理</h2><h3 id="传统-web-开发处理"><a href="#传统-web-开发处理" class="headerlink" title="传统 web 开发处理"></a>传统 web 开发处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .and()</span><br><span class="line">    ....</span><br><span class="line">    .sessionManagement()  <span class="comment">//开启会话管理</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//允许同一个用户只允许创建一个会话</span></span><br><span class="line">    .expiredUrl(<span class="string">&quot;/login&quot;</span>);<span class="comment">//会话过期处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前后端分离开发处理"><a href="#前后端分离开发处理" class="headerlink" title="前后端分离开发处理"></a>前后端分离开发处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .....</span><br><span class="line">    .sessionManagement()  <span class="comment">//开启会话管理</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//允许同一个用户只允许创建一个会话</span></span><br><span class="line">    <span class="comment">//.expiredUrl(&quot;/login&quot;)//会话过期处理  传统 web 开发</span></span><br><span class="line">    .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">      <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">      result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;当前会话已经失效,请重新登录!&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      response.getWriter().println(s);</span><br><span class="line">      response.flushBuffer();</span><br><span class="line">    &#125;);<span class="comment">//前后端分离开发处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="禁止再次登录"><a href="#禁止再次登录" class="headerlink" title="禁止再次登录"></a>禁止再次登录</h2><p>默认的效果是一种被 “挤下线”的效果，后面登录的用户会把前面登录的用户 “挤下线”。还有一种是禁止后来者登录，即一旦当前用户登录成功，后来者无法再次使用相同的用户登录，直到当前用户主动注销登录，配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .and()</span><br><span class="line">    ....</span><br><span class="line">    .sessionManagement()  <span class="comment">//开启会话管理</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//允许同一个用户只允许创建一个会话</span></span><br><span class="line">    <span class="comment">//.expiredUrl(&quot;/login&quot;)//会话过期处理  传统 web 开发</span></span><br><span class="line">    .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">      <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">      result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;当前会话已经失效,请重新登录!&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">      response.getWriter().println(s);</span><br><span class="line">      response.flushBuffer();</span><br><span class="line">    &#125;)<span class="comment">//前后端分离开发处理</span></span><br><span class="line">    .maxSessionsPreventsLogin(<span class="literal">true</span>);<span class="comment">//登录之后禁止再次登录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="会话共享"><a href="#会话共享" class="headerlink" title="会话共享"></a>会话共享</h2><p>前面所讲的会话管理都是单机上的会话管理，如果当前是集群环境，前面所讲的会话管<br>理方案就会失效。此时可以利用 spring-session 结合 redis 实现 session 共享。</p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><h6 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="编写配置"><a href="#编写配置" class="headerlink" title="编写配置"></a>编写配置</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>

<h6 id="配置Security"><a href="#配置Security" class="headerlink" title="配置Security"></a>配置Security</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blr.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.FindByIndexNameSessionRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FindByIndexNameSessionRepository sessionRepository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(FindByIndexNameSessionRepository sessionRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionRepository = sessionRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .sessionManagement()  <span class="comment">//开启会话管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)  <span class="comment">//允许同一个用户只允许创建一个会话*/</span></span><br><span class="line">                .expiredUrl(<span class="string">&quot;/login&quot;</span>)<span class="comment">//会话过期处理  传统 web 开发</span></span><br><span class="line">                .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">                    <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">                    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                    result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;当前会话已经失效,请重新登录!&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    response.getWriter().println(s);</span><br><span class="line">                    response.flushBuffer();</span><br><span class="line">                &#125;).sessionRegistry(sessionRegistry());<span class="comment">//前后端分离开发处理</span></span><br><span class="line">        <span class="comment">//.maxSessionsPreventsLogin(true);//登录之后禁止再次登录*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringSessionBackedSessionRegistry <span class="title function_">sessionRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringSessionBackedSessionRegistry</span>(sessionRepository);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="原理分析-1"><a href="#原理分析-1" class="headerlink" title="原理分析"></a>原理分析</h2><p>​	接下来我们来分析上面的效果是怎么实现的. 这里涉及了比较多的类, 我们逐个来看一下:</p>
<h3 id="SessionInformation"><a href="#SessionInformation" class="headerlink" title="SessionInformation"></a>SessionInformation</h3><p>​	<strong>SessionInformation</strong>主要用作SpringSecurity框架内的会话记录, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionInformation</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Date lastRequest;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String sessionId;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">expired</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里定义了四个属性:</p>
<ol>
<li>lastRequest: 最近一次请求的时间</li>
<li>principal: 会话对应的主体(对象)</li>
<li>sessionId: 会话Id</li>
<li>expired: 会话是否过期</li>
<li>refreshLastRequest(): 该方法用来更新最近一次请求的时间</li>
</ol>
<h3 id="SessionRegistry"><a href="#SessionRegistry" class="headerlink" title="SessionRegistry"></a>SessionRegistry</h3><p>​	<strong>SessionRegistry</strong>是一个接口, 主要用来维护<strong>SessionInformation</strong>实例, 该接口只有一个实现类<strong>SessionRegistryImpl</strong>, 所有这里我们就不看接口了, 直接来看实现类<strong>SessionRegistryImpl</strong>, <strong>SessionRegistryImpl</strong>类的定义比较长, 我们来拆开看下, 先看下属性的定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionRegistryImpl</span> <span class="keyword">implements</span> <span class="title class_">SessionRegistry</span>, ApplicationListener&lt;AbstractSessionEvent&gt; &#123;</span><br><span class="line">	<span class="comment">// &lt;principal:Object,SessionIdSet&gt;</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;sessionId:Object,SessionInformation&gt;</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SessionInformation&gt; sessionIds;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SessionRegistryImpl</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.principals = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="built_in">this</span>.sessionIds = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SessionRegistryImpl</span><span class="params">(ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals,</span></span><br><span class="line"><span class="params">			Map&lt;String, SessionInformation&gt; sessionIds)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.principals = principals;</span><br><span class="line">		<span class="built_in">this</span>.sessionIds = sessionIds;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(AbstractSessionEvent event)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (event <span class="keyword">instanceof</span> SessionDestroyedEvent) &#123;</span><br><span class="line">			<span class="type">SessionDestroyedEvent</span> <span class="variable">sessionDestroyedEvent</span> <span class="operator">=</span> (SessionDestroyedEvent) event;</span><br><span class="line">			<span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> sessionDestroyedEvent.getId();</span><br><span class="line">			removeSessionInformation(sessionId);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> SessionIdChangedEvent) &#123;</span><br><span class="line">			<span class="type">SessionIdChangedEvent</span> <span class="variable">sessionIdChangedEvent</span> <span class="operator">=</span> (SessionIdChangedEvent) event;</span><br><span class="line">			<span class="type">String</span> <span class="variable">oldSessionId</span> <span class="operator">=</span> sessionIdChangedEvent.getOldSessionId();</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.sessionIds.containsKey(oldSessionId)) &#123;</span><br><span class="line">				<span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> <span class="built_in">this</span>.sessionIds.get(oldSessionId).getPrincipal();</span><br><span class="line">				removeSessionInformation(oldSessionId);</span><br><span class="line">				registerNewSession(sessionIdChangedEvent.getNewSessionId(), principal);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	<strong>SessionRegistryImpl</strong>实现了<strong>SessionRegistry</strong>和<strong>ApplicationListener</strong>两个接口, 实现了<strong>ApplicationListener</strong>接口, 并通过重写其<strong>onApplicationEvent</strong>方法, 就可以接收到<strong>HttpSession</strong>的销毁事件, 进而移除掉<strong>HttpSession</strong>的记录.</p>
<p>​	<strong>SessionRegistryImpl</strong>中一共定义了两个属性:</p>
<p>​	1. <strong>principals</strong>: 该变量用来保持当前登录主体(用户)和<strong>SessionId</strong>之间的关系, <strong>key</strong>就是当前登录主体, <strong>value</strong>则是当前登录主体所对应的会话id的集合.</p>
<p>​	2. <strong>sessionIds</strong>: 该变量是用来保存<strong>sessionId</strong>和<strong>SessionInformation</strong>之间的映射关系, <strong>key</strong>是<strong>sessionId</strong>, <strong>value</strong>则是<strong>SessionInformation</strong>.</p>
<p>​	<span style="color:red;">由于<strong>principals</strong>集合中采用当前登录用户对象做key, 将对象作为集合中的key, 需要重写其<strong>equals</strong>方法和<strong>hashCode</strong>方法. 否则会话并发管理会失效.</span></p>
<p>​	继续来看<strong>SessionRegistryImpl</strong>中的其他方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">getAllPrincipals</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.principals.keySet());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SessionInformation&gt; <span class="title function_">getAllSessions</span><span class="params">(Object principal, <span class="type">boolean</span> includeExpiredSessions)</span> &#123;</span><br><span class="line">	Set&lt;String&gt; sessionsUsedByPrincipal = <span class="built_in">this</span>.principals.get(principal);</span><br><span class="line">	<span class="keyword">if</span> (sessionsUsedByPrincipal == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;SessionInformation&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(sessionsUsedByPrincipal.size());</span><br><span class="line">	<span class="keyword">for</span> (String sessionId : sessionsUsedByPrincipal) &#123;</span><br><span class="line">		<span class="type">SessionInformation</span> <span class="variable">sessionInformation</span> <span class="operator">=</span> getSessionInformation(sessionId);</span><br><span class="line">		<span class="keyword">if</span> (sessionInformation == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (includeExpiredSessions || !sessionInformation.isExpired()) &#123;</span><br><span class="line">			list.add(sessionInformation);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SessionInformation <span class="title function_">getSessionInformation</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">	Assert.hasText(sessionId, <span class="string">&quot;SessionId required as per interface contract&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.sessionIds.get(sessionId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshLastRequest</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">	Assert.hasText(sessionId, <span class="string">&quot;SessionId required as per interface contract&quot;</span>);</span><br><span class="line">	<span class="type">SessionInformation</span> <span class="variable">info</span> <span class="operator">=</span> getSessionInformation(sessionId);</span><br><span class="line">	<span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">		info.refreshLastRequest();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>getAllPrincipals</strong>: 该方法返回所有的登录用户对象.</li>
<li><strong>getAllSessions</strong>: 该方法返回某一个用户所对应的所有<strong>SessionInfomation</strong>. 方法第一个参数就是用户对象, 第二个参数表示是否包含已经过期的Session. 具体的操作就是从<strong>principals</strong>变量中获取该用户对应的所有<strong>sessionId</strong>, 然后调用<strong>getSessionInfomation</strong>方法从<strong>sessionIds</strong>变量中获取每一个<strong>sessionId</strong>对应的<strong>SessionInformation</strong>, 最终将获取到的<strong>SessionInformation</strong>存入集合中返回.</li>
<li><strong>getSessionInformation</strong>: 该方法主要是根据<strong>sessionId</strong>从<strong>sessionIds</strong>集合中获取到对应的<strong>SessionInformation</strong></li>
<li><strong>refreshLastRequest</strong>: 根据传入的<strong>sessionId</strong>找到对应的<strong>SessionInformation</strong>, 并调用其<strong>refreshLastRequest</strong>方法并刷新最后一次请求的时间</li>
</ol>
<p>​	再来看下会话的保存操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerNewSession</span><span class="params">(String sessionId, Object principal)</span> &#123;</span><br><span class="line">		Assert.hasText(sessionId, <span class="string">&quot;SessionId required as per interface contract&quot;</span>);</span><br><span class="line">		Assert.notNull(principal, <span class="string">&quot;Principal required as per interface contract&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (getSessionInformation(sessionId) != <span class="literal">null</span>) &#123;</span><br><span class="line">			removeSessionInformation(sessionId);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Registering session %s, for principal %s&quot;</span>, sessionId, principal));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.sessionIds.put(sessionId, <span class="keyword">new</span> <span class="title class_">SessionInformation</span>(principal, sessionId, <span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">		<span class="built_in">this</span>.principals.compute(principal, (key, sessionsUsedByPrincipal) -&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (sessionsUsedByPrincipal == <span class="literal">null</span>) &#123;</span><br><span class="line">				sessionsUsedByPrincipal = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br><span class="line">			&#125;</span><br><span class="line">			sessionsUsedByPrincipal.add(sessionId);</span><br><span class="line">			<span class="built_in">this</span>.logger.trace(LogMessage.format(<span class="string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, principal, sessionsUsedByPrincipal));</span><br><span class="line">			<span class="keyword">return</span> sessionsUsedByPrincipal;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	当用户登录成功后, 会执行会话保存操作, 传入当前请求的<strong>sessionId</strong>和当前登录主体<strong>principal</strong>对象. 如果<strong>sessionId</strong>已经存在, 则先将其移除, 然后先往<strong>sessionIds</strong>中保存, <strong>key</strong>是<strong>sessionId</strong>, <strong>value</strong>则是一个新创建的<strong>SessionInformation</strong>对象.</p>
<p>​	在向<strong>principals</strong>集合中保存时使用了<strong>compute</strong>方法, 第一个参数就是当前登录主体, 第二个参数则进行了计算. 如果当前登录主体在<strong>principals</strong>中已经有对应的value, 则在value的基础上继续添加一个<strong>sessionId</strong>. 如果当前登录主体在<strong>principals</strong>中没有对应的<strong>value</strong>, 则新建一个<strong>sessionUsedByPrincipal</strong>对象, 然后再将<strong>sessiomId</strong>添加进去.</p>
<p>​	最后我们来看一下会话移除操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeSessionInformation</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">		Assert.hasText(sessionId, <span class="string">&quot;SessionId required as per interface contract&quot;</span>);</span><br><span class="line">		<span class="type">SessionInformation</span> <span class="variable">info</span> <span class="operator">=</span> getSessionInformation(sessionId);</span><br><span class="line">		<span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Removing session &quot;</span> + sessionId + <span class="string">&quot; from set of registered sessions&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.sessionIds.remove(sessionId);</span><br><span class="line">		<span class="built_in">this</span>.principals.computeIfPresent(info.getPrincipal(), (key, sessionsUsedByPrincipal) -&gt; &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(</span><br><span class="line">					LogMessage.format(<span class="string">&quot;Removing session %s from principal&#x27;s set of registered sessions&quot;</span>, sessionId));</span><br><span class="line">			sessionsUsedByPrincipal.remove(sessionId);</span><br><span class="line">			<span class="keyword">if</span> (sessionsUsedByPrincipal.isEmpty()) &#123;</span><br><span class="line">				<span class="comment">// No need to keep object in principals Map anymore</span></span><br><span class="line">				<span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Removing principal %s from registry&quot;</span>, info.getPrincipal()));</span><br><span class="line">				sessionsUsedByPrincipal = <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.logger.trace(</span><br><span class="line">					LogMessage.format(<span class="string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, info.getPrincipal(), sessionsUsedByPrincipal));</span><br><span class="line">			<span class="keyword">return</span> sessionsUsedByPrincipal;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	移除也是两方面的工作, 一方面就是从sessionIds变量中移除, 这个直接调用remove方法即可;另一方面就是从principals变量中移除, principals中key是当前登录的用户对象, value是一个集合, 里面保存着当前用户对应的所有sessionId, 这里主要是移除vakue中对应的sessionId</p>
<h3 id="SessionAuthenticationStrategy"><a href="#SessionAuthenticationStrategy" class="headerlink" title="SessionAuthenticationStrategy"></a>SessionAuthenticationStrategy</h3><p>​	<strong>SessionAuthenticationStrategy</strong>是一个接口, 主要在用户登录成功后, 对<strong>HttpSession</strong>进行处理. 它里面只有一个<strong>onAuthentication</strong>方法, 用来处理和<strong>HttpSession</strong>相关的事情:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SessionAuthenticationStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Performs Http session-related functionality when a new authentication occurs.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> SessionAuthenticationException if it is decided that the authentication is</span></span><br><span class="line"><span class="comment">	 * not allowed for the session. This will typically be because the user has too many</span></span><br><span class="line"><span class="comment">	 * sessions open at once.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">onAuthentication</span><span class="params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> SessionAuthenticationException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	<strong>SessionAuthenticationStrategy</strong>有如下一些实现类:</p>
<ul>
<li><strong>CsrfAuthenticationStrategy</strong>: <strong>CsrfAuthenticationStrategy</strong>和<strong>CSRF</strong>攻击有关, 该类主要负责在身份验证后删除旧的<strong>CsrfToken</strong>并生成一个新的<strong>CsrfToken</strong></li>
<li><strong>ConcurrentSessionControlAuthenticationStrategy</strong>: 该类主要用来处理Session并发问题.</li>
<li><strong>RegisterSessionAuthenticationStrategy</strong>: 该类用来在认证成功后将<strong>HttpSession</strong>信息记录到<strong>SessionRegistry</strong>中 </li>
<li><strong>CompositeSessionAuthenticationStrategy</strong>: 这是一个复合策略, 它里面维护了一个集合, 集合中保存了多个不同的<strong>SessionAuthenticationStrategy</strong>对象, 相当于该类代理了多个<strong>SessionAuthenticationStrategy</strong>对象, 大部分情况下, 在SpringSecurity框架中直接使用的也是该类的实例.</li>
<li><strong>NullAuthenticatedSessionStrategy</strong>: 这是一个空的实现, 没做任何处理</li>
<li><strong>AbstractSessionFixationProtectionStrategy</strong>: 通过修改sessionId来防止会话固定攻击</li>
<li><strong>ChangeSessionIdAuthenticationStrategy</strong>: 通过修改sessionId来防止会话固定攻击.</li>
<li><strong>SessionFixationProtectionStrategy</strong>: 通过创建一个新的会话来防止会话固定攻击</li>
</ul>
<h3 id="ConcurrentSessionControlAuthenticationStrategy"><a href="#ConcurrentSessionControlAuthenticationStrategy" class="headerlink" title="ConcurrentSessionControlAuthenticationStrategy"></a>ConcurrentSessionControlAuthenticationStrategy</h3><p>​	在前面的案例中, 起主要作用的是<strong>ConcurrentSessionControlAuthenticationStrategy</strong>, 因此这里先对该类进行重点分析, 先来看它里面的<strong>onAuthentication</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthentication</span><span class="params">(Authentication authentication, HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response)</span> &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">allowedSessions</span> <span class="operator">=</span> getMaximumSessionsForThisUser(authentication);</span><br><span class="line">	<span class="keyword">if</span> (allowedSessions == -<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">// We permit unlimited logins</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;SessionInformation&gt; sessions = <span class="built_in">this</span>.sessionRegistry.getAllSessions(authentication.getPrincipal(), <span class="literal">false</span>);</span><br><span class="line">	<span class="type">int</span> <span class="variable">sessionCount</span> <span class="operator">=</span> sessions.size();</span><br><span class="line">	<span class="keyword">if</span> (sessionCount &lt; allowedSessions) &#123;</span><br><span class="line">		<span class="comment">// They haven&#x27;t got too many login sessions running at present</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (sessionCount == allowedSessions) &#123;</span><br><span class="line">		<span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="comment">// Only permit it though if this request is associated with one of the</span></span><br><span class="line">			<span class="comment">// already registered sessions</span></span><br><span class="line">			<span class="keyword">for</span> (SessionInformation si : sessions) &#123;</span><br><span class="line">				<span class="keyword">if</span> (si.getSessionId().equals(session.getId())) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// If the session is null, a new one will be created by the parent class,</span></span><br><span class="line">		<span class="comment">// exceeding the allowed number</span></span><br><span class="line">	&#125;</span><br><span class="line">	allowableSessionsExceeded(sessions, allowedSessions, <span class="built_in">this</span>.sessionRegistry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	在该方法中, 首先从<strong>sessionRegistry</strong>中获取当前用户的所有未失效的<strong>SessionInformation</strong>实例, 然后获取到当前项目允许的最大session数. 如果获取的<strong>SessionInformation</strong>实例数小于当前项目允许的最大<strong>session</strong>数, 说明当前登录没问题, 直接return即可. 如果允许的最大session数量为-1, 则表示应用并不限制登录并发数, 当前登录也没有问题, 直接返回即可. 如果获取到<strong>SessionInformation</strong>实例等于当前项目允许的最大<strong>session</strong>数, 则去判断当前登录的<strong>sessionId</strong>是否存在于获取到的<strong>SessionInformation</strong>实例中, 如果存在, 说明登录也没有问题, 直接返回即可.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">allowableSessionsExceeded</span><span class="params">(List&lt;SessionInformation&gt; sessions, <span class="type">int</span> allowableSessions,</span></span><br><span class="line"><span class="params">			SessionRegistry registry)</span> <span class="keyword">throws</span> SessionAuthenticationException &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.exceptionIfMaximumExceeded || (sessions == <span class="literal">null</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SessionAuthenticationException</span>(</span><br><span class="line">					<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;</span>,</span><br><span class="line">							<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; allowableSessions &#125;, <span class="string">&quot;Maximum sessions of &#123;0&#125; for this principal exceeded&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Determine least recently used sessions, and mark them for invalidation</span></span><br><span class="line">		sessions.sort(Comparator.comparing(SessionInformation::getLastRequest));</span><br><span class="line">		<span class="type">int</span> <span class="variable">maximumSessionsExceededBy</span> <span class="operator">=</span> sessions.size() - allowableSessions + <span class="number">1</span>;</span><br><span class="line">		List&lt;SessionInformation&gt; sessionsToBeExpired = sessions.subList(<span class="number">0</span>, maximumSessionsExceededBy);</span><br><span class="line">		<span class="keyword">for</span> (SessionInformation session : sessionsToBeExpired) &#123;</span><br><span class="line">			session.expireNow();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	如果<strong>exceptionIfMaximumExceeded</strong>属性为true, 则直接抛出一次, 该属性的值也就是我们在<strong>SecurityConfig</strong>中通过<strong>maxSessionsPreventsLogin</strong>方法配置的值, 即禁止后来者登录, 抛出异常之后, 本次登录失败. 否则说明不禁止后来者登录, 此时对查询出来的当前用户所有登录会话按照最后一次请求时间进行排序, 然后计算出需要过期的<strong>session</strong>数量, 从<strong>sessions</strong>集合中取出来进行遍历, 依次调用其<strong>expireNow</strong>方法使之过期.</p>
<p>​	这就是<strong>ConcurrentSessionControlAuthenticationStrategy</strong>类的实现逻辑.</p>
<h3 id="RegisterSessionAuthnticationStrategy"><a href="#RegisterSessionAuthnticationStrategy" class="headerlink" title="RegisterSessionAuthnticationStrategy"></a>RegisterSessionAuthnticationStrategy</h3><p>​	在前面的案例中, 默认也用到了<strong>RegisterSessionAuthenticationStrategy</strong>, 该类的作用主要是向<strong>SessionRegistry</strong>中记录<strong>HttpSession</strong>信息, 我们来看一下<strong>onAuthentication</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthentication</span><span class="params">(Authentication authentication, HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response)</span> &#123;</span><br><span class="line">	<span class="built_in">this</span>.sessionRegistry.registerNewSession(request.getSession().getId(), authentication.getPrincipal());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到,这里的<strong>onAuthentication</strong>方法非常简单, 就是调用<strong>registerNewSession</strong>方法向<strong>sessionRegistry</strong>中添加一条登录会话信息</p>
<p>​	</p>
<h3 id="CompositeSessionAuthenticationStrategy"><a href="#CompositeSessionAuthenticationStrategy" class="headerlink" title="CompositeSessionAuthenticationStrategy"></a>CompositeSessionAuthenticationStrategy</h3><p>​	<strong>CompositeSessionAuthenticationStrategy</strong>类相对于一个代理类, 默认使用的其实就是该类的实例, 我们来看一该类的<strong>onAuthentication</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthentication</span><span class="params">(Authentication authentication, HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response)</span> <span class="keyword">throws</span> SessionAuthenticationException &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">currentPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="built_in">this</span>.delegateStrategies.size();</span><br><span class="line">	<span class="keyword">for</span> (SessionAuthenticationStrategy delegate : <span class="built_in">this</span>.delegateStrategies) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.trace(LogMessage.format(<span class="string">&quot;Preparing session with %s (%d/%d)&quot;</span>,</span><br><span class="line">					delegate.getClass().getSimpleName(), ++currentPosition, size));</span><br><span class="line">		&#125;</span><br><span class="line">		delegate.onAuthentication(authentication, request, response);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到,这里就是遍历它所维护的<strong>SessionAuthenticationStrategy</strong>集合, 然后分别调用其<strong>onAuthentication</strong>方法.</p>
<p>​	在前面的案例中, 主要涉及到这些SessionAuthenticationStrategy实例, 还有其他一些SessionAuthenticationStrategy实例, 我们接下来的小节中详细介绍, 这里不再说明</p>
<h3 id="SessionManagementFilter"><a href="#SessionManagementFilter" class="headerlink" title="SessionManagementFilter"></a>SessionManagementFilter</h3><p>​	和会话并发管理相关的过滤器主要有两个, 先来看第一个<strong>SessionManagementFilter</strong>.</p>
<p>​	<strong>SessionManagementFilter</strong>主要用来处理<strong>RememberMe</strong>登录时的会话管理: 即如果用户使用了<strong>RememberMe</strong>的方式进行认证, 则认证成功后需要进行会话管理, 相关的管理操作通过<strong>SessionManagementFilter</strong>过滤器触发. 我们来看一下该过滤器的<strong>doFilter</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">		<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">	<span class="keyword">if</span> (request.getAttribute(FILTER_APPLIED) != <span class="literal">null</span>) &#123;</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	request.setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">this</span>.securityContextRepository.containsContext(request)) &#123;</span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">		<span class="keyword">if</span> (authentication != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.trustResolver.isAnonymous(authentication)) &#123;</span><br><span class="line">			<span class="comment">// The user has been authenticated during the current request, so call the</span></span><br><span class="line">			<span class="comment">// session strategy</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="built_in">this</span>.sessionAuthenticationStrategy.onAuthentication(authentication, request, response);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (SessionAuthenticationException ex) &#123;</span><br><span class="line">				<span class="comment">// The session strategy can reject the authentication</span></span><br><span class="line">				<span class="built_in">this</span>.logger.debug(<span class="string">&quot;SessionAuthenticationStrategy rejected the authentication object&quot;</span>, ex);</span><br><span class="line">				SecurityContextHolder.clearContext();</span><br><span class="line">				<span class="built_in">this</span>.failureHandler.onAuthenticationFailure(request, response, ex);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Eagerly save the security context to make it available for any possible</span></span><br><span class="line">			<span class="comment">// re-entrant requests which may occur before the current request</span></span><br><span class="line">			<span class="comment">// completes. SEC-1396.</span></span><br><span class="line">			<span class="built_in">this</span>.securityContextRepository.saveContext(SecurityContextHolder.getContext(), request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// No security context or authentication present. Check for a session</span></span><br><span class="line">			<span class="comment">// timeout</span></span><br><span class="line">			<span class="keyword">if</span> (request.getRequestedSessionId() != <span class="literal">null</span> &amp;&amp; !request.isRequestedSessionIdValid()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">					<span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Request requested invalid session id %s&quot;</span>,</span><br><span class="line">							request.getRequestedSessionId()));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">this</span>.invalidSessionStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="built_in">this</span>.invalidSessionStrategy.onInvalidSessionDetected(request, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	在该过滤器中, 通过<strong>containsContext</strong>方法去判断当前会话中是否存在<strong>SPRING_SECURITY_CONTEXT</strong>变量. 如果是正常的认证流程, 则<strong>SPRING_SECURITY_CONTEXT</strong>变量是存在于当前会话中的. 那么什么时候不存在呢? 有两种情况:</p>
<ol>
<li>用户使用了<strong>RememberMe</strong>方法进行认证</li>
<li>用户匿名访问了某个接口.</li>
</ol>
<p>​	对于第一种情况, <strong>SecurityContextHolder</strong>中获取到的当前用户实例是<strong>RememberMeAuthenticationToken</strong>; 对于第二种情况, <strong>SecurityContextHolder</strong>中获取到的当前用户实例是<strong>AnonymousAuthenticationToken</strong>. 所以, 接下来就是对这两种情况进行区分, 如果是第一种情况, 则调用<strong>SessionAuthenticationStrategy</strong>中的<strong>onAuthentication</strong>方法进行会话管理; 如果是第二种情况, 则进行会话失效处理.</p>
<h3 id="ConcurrentSessionFilter"><a href="#ConcurrentSessionFilter" class="headerlink" title="ConcurrentSessionFilter"></a>ConcurrentSessionFilter</h3><p>​	<strong>concurrentSessionFilter</strong>过滤器是一个处理会话并发管理的过滤器, 我们来看一下它的<strong>doFilter</strong>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		<span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">SessionInformation</span> <span class="variable">info</span> <span class="operator">=</span> <span class="built_in">this</span>.sessionRegistry.getSessionInformation(session.getId());</span><br><span class="line">			<span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (info.isExpired()) &#123;</span><br><span class="line">					<span class="comment">// Expired - abort processing</span></span><br><span class="line">					<span class="built_in">this</span>.logger.debug(LogMessage</span><br><span class="line">							.of(() -&gt; <span class="string">&quot;Requested session ID &quot;</span> + request.getRequestedSessionId() + <span class="string">&quot; has expired.&quot;</span>));</span><br><span class="line">					doLogout(request, response);</span><br><span class="line">					<span class="built_in">this</span>.sessionInformationExpiredStrategy</span><br><span class="line">							.onExpiredSessionDetected(<span class="keyword">new</span> <span class="title class_">SessionInformationExpiredEvent</span>(info, request, response));</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Non-expired - update last request date/time</span></span><br><span class="line">				<span class="built_in">this</span>.sessionRegistry.refreshLastRequest(info.getSessionId());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	从<strong>doFilter</strong>方法中可以看到, 当请求通过时, 首先先获取当前会话, 如果当前会话不为null, 则进而获取当前会话所对应的<strong>SessionInformation</strong>实例; 如果<strong>SessionInformation</strong>实例已经过期, 则调用<strong>doLogout</strong>方法执行注销操作, 同时调用会话过期的回调; 如果<strong>SessionInformation</strong>实例没有过期, 则刷新当前会话的最后一次请求时间.</p>
<h3 id="session的创建时期"><a href="#session的创建时期" class="headerlink" title="session的创建时期"></a>session的创建时期</h3><p>​	在讲解配置类之前, 需要先了解一下SpringSecurity中Session的创建时机问题. 在SpringSecurity中, HttpSession的创建策略一共分为四种:</p>
<ol>
<li><strong>ALWAYS</strong>: 如果HttpSession不存在, 就创建</li>
<li><strong>NEVER</strong>: 从不创建HttpSession, 但是如果HttpSession已经存在了, 则会使用它</li>
<li><strong>IF_REQUIRED</strong>: 当有需要时, 会创建HttpSession, 默认即此.</li>
<li><strong>STATELESS</strong>: 从不创建<strong>HttpSession</strong>, 从不使用<strong>HttpSession</strong></li>
</ol>
<p>​	需要注意的是, 这四种策略仅仅是指<strong>SpringSecurity</strong>中<strong>HttpSession</strong>的创建策略, 而并非整个应用程序中<strong>HttpSession</strong>的创建策略. 前三种策略都很好理解.关于第四种, 有可能会有疑惑, 如果完全不使用<strong>HttpSession</strong>那么<strong>SpringSecurity</strong>还能发挥作用吗?当然可以, 如果系统使用了无状态认证方式, 就可以使用<strong>STATELESS</strong>策略, 这就意味着服务端不会创建<strong>HttpSession</strong>, 客户端的每个请求都需要携带认证信息, 同时, 一些和<strong>HttpSession</strong>相关的过滤器也将失效, 如<strong>SessionManagementFilter</strong>、<strong>ConcurrentSessionFilter</strong>等.</p>
<p>​	一般来说, 我们使用默认的<strong>IF_REQUIRED</strong>即可, 如果读者需要配置, 可以通过如下方式进行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>





<h3 id="AbstractAuthenticationFilterConfigurer"><a href="#AbstractAuthenticationFilterConfigurer" class="headerlink" title="AbstractAuthenticationFilterConfigurer"></a>AbstractAuthenticationFilterConfigurer</h3><p>​	看完前面的分析, 读者可能还是有疑惑, 登录成功后, <strong>Session</strong>并发管理到底是在哪里触发的? 虽然经过前面的分析, 大家知道了两个过滤器的存在: <strong>SessionManagementFilter</strong>和<strong>ConcurrentSessionFilter</strong>, 但是前者在用户使用<strong>RemmberMe</strong>认证时, 才会触发<strong>Session</strong>并发管理, 后者则根本不会触发Session并发管理, 那么用户登录成功后, 到底是在哪里触发Session并发管理的呢?</p>
<p>​	这里我们可以回到登录过滤器<strong>AbstractAuthenticationProcessingFilter</strong>的<strong>doFilter</strong>方法中去看一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		<span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</span><br><span class="line">			chain.doFilter(request, response);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">Authentication</span> <span class="variable">authenticationResult</span> <span class="operator">=</span> attemptAuthentication(request, response);</span><br><span class="line">			<span class="keyword">if</span> (authenticationResult == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="comment">// return immediately as subclass has indicated that it hasn&#x27;t completed</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.sessionStrategy.onAuthentication(authenticationResult, request, response);</span><br><span class="line">			<span class="comment">// Authentication success</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.continueChainBeforeSuccessfulAuthentication) &#123;</span><br><span class="line">				chain.doFilter(request, response);</span><br><span class="line">			&#125;</span><br><span class="line">			successfulAuthentication(request, response, chain, authenticationResult);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (InternalAuthenticationServiceException failed) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.error(<span class="string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span>, failed);</span><br><span class="line">			unsuccessfulAuthentication(request, response, failed);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">			<span class="comment">// Authentication failed</span></span><br><span class="line">			unsuccessfulAuthentication(request, response, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, 在调用<strong>attemptAuthentication</strong>方法进行登录认证之后, 接下来就调用了<strong>sessionStrategy.onAuthentication</strong>方法触发<strong>Session</strong>并发管理.</p>
<p>​	这里的<strong>sessionStrategy</strong>对象则是在<strong>AbstractAuthenticationFilterConfigurer</strong>类的<strong>configure</strong>方法进行配置的, 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAuthenticationFilterConfigurer</span>&lt;B <span class="keyword">extends</span> <span class="title class_">HttpSecurityBuilder</span>&lt;B&gt;, T <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticationFilterConfigurer</span>&lt;B, T, F&gt;, F <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticationProcessingFilter</span>&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractHttpConfigurer</span>&lt;T, B&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(B http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SessionAuthenticationStrategy</span> <span class="variable">sessionAuthenticationStrategy</span> <span class="operator">=</span> http</span><br><span class="line">				.getSharedObject(SessionAuthenticationStrategy.class);</span><br><span class="line">		<span class="keyword">if</span> (sessionAuthenticationStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.authFilter.setSessionAuthenticationStrategy(sessionAuthenticationStrategy);</span><br><span class="line">		&#125;</span><br><span class="line">    .....</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​	可以看到, 这里从<strong>HttpSecurity</strong>的共享对象中获取到<strong>SessionAuthenticationStrategy</strong>实例( 在<strong>SessionManagementConfigurer</strong>#<strong>init</strong>方法中存入<strong>HttpSecurity</strong>共享对象), 并设置到<strong>authFilter</strong>过滤器中.</p>
<p>​	</p>
<p>​	我们再来梳理一下:</p>
<p>​	用户通过用户名&#x2F;密码发起一个认证请求, 当认证成功后, 在<strong>AbstractAuthenticationProcessingFilter</strong>#<strong>doFilter</strong>方法中触发了<strong>Session</strong>并发管理.默认的<strong>sessionStrategy</strong>是<strong>CompositeSessionAuthenticationStrategy</strong>, 它一共代理了三个<strong>SessionAuthenticationStrategy</strong>, 分别是<strong>ConcurrentSessionControlAuthenticationStrategy</strong>、<strong>ChangeSessionIdAuthenticationStrategy</strong>、<strong>RegisterSessionAuthenticationStrategy</strong>. 当前请求在这三个<strong>SessionAuthenticationStrategy</strong>这分别走一圈, 第一个用来判断当前登录用户的<strong>Session</strong>数量是否已经超过了限制, 如果超出了限制就根据配置好的的规则进行处理, 第二个用来修改<strong>sessionId</strong>(防止会话固定攻击); 第三个用来将当前<strong>Session</strong>注册到<strong>SessionRegistry</strong>中. 使用用户名&#x2F;密码的方式完成认证, 将不会涉及到<strong>ConcurrentSessionFilter</strong>和<strong>SessionManagementFilter</strong>两个过滤器. 如果用户使用了<strong>RememberMe</strong>的方式进行身份认证, 则会通过<strong>SessionManagementFilter</strong>#<strong>doFilter</strong>方法触发<strong>Session</strong>并发管理. 当用户认证成功后, 以后的每一次请求都会经过<strong>ConcurrentSessionFilter</strong>, 在该过滤器中, 判断当前会话是否已经过期, 如果过期则会执行注销登录流程; 如果没有过期, 则更新最近一次请求时间.</p>
<h1 id="第九章-CSRF-漏洞保护"><a href="#第九章-CSRF-漏洞保护" class="headerlink" title="第九章 CSRF 漏洞保护"></a>第九章 CSRF 漏洞保护</h1><ul>
<li><p>CSRF 简介</p>
</li>
<li><p>CSRF 防御&amp;基本配置</p>
</li>
<li><p>实战</p>
</li>
</ul>
<h3 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h3><p>CSRF (Cross-Site Request Forgery 跨站请求伪造)，也可称为一键式攻击 (one-click-attack），通常缩写为 <code>CSRF</code> 或者 <code>XSRF</code>。</p>
<p><code>CSRF</code> 攻击是一种挟持用户在当前已登录的浏览器上发送恶意请求的攻击方法。相对于XSS利用用户对指定网站的信任，CSRF则是利用网站对用户网页浏览器的信任。简单来说，CSRF是致击者通过一些技术手段欺骗用户的浏览器，去访问一个用户曾经认证过的网站并执行恶意请求，例如发送邮件、发消息、甚至财产操作 (如转账和购买商品）。由于客户端(浏览器)已经在该网站上认证过，所以该网站会认为是真正用户在操作而执行请求（实际上这个并非用户的本意）。</p>
<p><strong>举个简单的例子：</strong></p>
<p>假设 blr 现在登录了某银行的网站准备完成一项转账操作，转账的链接如下：</p>
<p><strong>https: &#x2F;&#x2F;bank .xxx .com&#x2F;withdraw?account&#x3D;blr&amp;amount&#x3D;1000&amp;for&#x3D;zhangsan</strong></p>
<p>可以看到，这个链接是想从 blr 这个账户下转账 1000 元到 zhangsan 账户下，假设blr 没有注销登录该银行的网站，就在同一个浏览器新的选项卡中打开了一个危险网站，这个危险网站中有一幅图片，代码如下：</p>
<p><strong><img src="/https :/bank.xxx.com/withdraw"></strong></p>
<p>一旦用户打开了这个网站，这个图片链接中的请求就会自动发送出去。由于是同一个浏览器并且用户尚未注销登录，所以该请求会自动携带上对应的有效的 Cookie 信息，进而完成一次转账操作。这就是跨站请求伪造。</p>
<h3 id="CSRF攻击演示"><a href="#CSRF攻击演示" class="headerlink" title="CSRF攻击演示"></a>CSRF攻击演示</h3><h4 id="创建银行应用"><a href="#创建银行应用" class="headerlink" title="创建银行应用"></a>创建银行应用</h4><ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                .and().formLogin().and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 controller 并启动启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/withdraw&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">withdraw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行一次转账操作&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;执行一次转账操作&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="创建恶意应用"><a href="#创建恶意应用" class="headerlink" title="创建恶意应用"></a>创建恶意应用</h4><ul>
<li><p>创建简单 springboot 应用</p>
</li>
<li><p>修改配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>准备攻击页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1:8080/withdraw&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;blr&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;money&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;点我&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CSRF-防御"><a href="#CSRF-防御" class="headerlink" title="CSRF 防御"></a>CSRF 防御</h3><p><strong>CSRF</strong>攻击的根源在于浏览器默认的身份验证机制(自动携带当前网站的Cookie信息)，这种机制虽然可以保证请求是来自用户的某个浏览器，但是无法确保这请求是用户授权发送。攻击者和用户发送的请求一模一样，这意味着我们没有办法去直接拒绝这里的某一个请求。如果能在合法清求中额外携带一个攻击者无法获取的参数，就可以成功区分出两种不同的请求，进而直接拒绝掉恶意请求。在 SpringSecurity 中就提供了这种机制来防御 CSRF 攻击，这种机制我们称之为<code>令牌同步模式</code>。</p>
<h4 id="令牌同步模式"><a href="#令牌同步模式" class="headerlink" title="令牌同步模式"></a>令牌同步模式</h4><p>这是目前主流的 CSRF 攻击防御方案。具体的操作方式就是在每一个 HTTP 请求中，除了默认自动携带的 Cookie 参数之外，再提供一个安全的、随机生成的宇符串，我们称之为 CSRF 令牌。这个 CSRF 令牌由服务端生成，生成后在 HtpSession 中保存一份。当前端请求到达后，将请求携带的 CSRF 令牌信息和服务端中保存的令牌进行对比，如果两者不相等，则拒绝掉该 HITTP 请求。</p>
<blockquote>
<p><strong>注意:</strong> 考虑到会有一些外部站点链接到我们的网站，所以我们要求请求是幂等的，这样对子HEAD、OPTIONS、TRACE 等方法就没有必要使用 CSRF 令牌了，强行使用可能会导致令牌泄露！</p>
</blockquote>
<h4 id="开启-CSRF-防御"><a href="#开启-CSRF-防御" class="headerlink" title="开启 CSRF 防御"></a>开启 CSRF 防御</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.</span><br><span class="line">          ...</span><br><span class="line">          formLogin()</span><br><span class="line">          .and()</span><br><span class="line">          .csrf(); <span class="comment">//开启 csrf</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查看登录页面源码"><a href="#查看登录页面源码" class="headerlink" title="查看登录页面源码"></a>查看登录页面源码</h4><p><img src="/2022/01/26/SpringSecurity/image-20220418191456109.png" alt="image-20220418191456109"></p>
<h3 id="传统web开发使用CSRF"><a href="#传统web开发使用CSRF" class="headerlink" title="传统web开发使用CSRF"></a>传统web开发使用CSRF</h3><p>开启CSRF防御后会自动在提交的表单中加入如下代码，如果不能自动加入，需要在开启之后手动加入如下代码，并随着请求提交。获取服务端令牌方式如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">th:name</span>=<span class="string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="开发测试-controller"><a href="#开发测试-controller" class="headerlink" title="开发测试 controller"></a>开发测试 controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-html"><a href="#创建-html" class="headerlink" title="创建 html"></a>创建 html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试 CSRF 防御<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/hello&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hello&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="测试查看index-html源码"><a href="#测试查看index-html源码" class="headerlink" title="测试查看index.html源码"></a>测试查看index.html源码</h4><p><img src="/2022/01/26/SpringSecurity/image-20220418193519717.png" alt="image-20220418193519717"></p>
<h3 id="前后端分离使用-CSRF"><a href="#前后端分离使用-CSRF" class="headerlink" title="前后端分离使用 CSRF"></a>前后端分离使用 CSRF</h3><p>前后端分离开发时，只需要将生成 csrf 放入到cookie 中，并在请求时获取 cookie 中令牌信息进行提交即可。</p>
<h4 id="修改-CSRF-存入-Cookie"><a href="#修改-CSRF-存入-Cookie" class="headerlink" title="修改 CSRF 存入 Cookie"></a>修改 CSRF 存入 Cookie</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="访问登录界面查看-cookie"><a href="#访问登录界面查看-cookie" class="headerlink" title="访问登录界面查看 cookie"></a>访问登录界面查看 cookie</h4><p><img src="/2022/01/26/SpringSecurity/image-20220418194059737.png" alt="image-20220418194059737"></p>
<h4 id="发送请求携带令牌即可"><a href="#发送请求携带令牌即可" class="headerlink" title="发送请求携带令牌即可"></a>发送请求携带令牌即可</h4><ul>
<li>请求参数中携带令牌</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">_csrf</span>  </span><br><span class="line"><span class="string">value:&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>请求头中携带令牌</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-XSRF-TOKEN:value</span><br></pre></td></tr></table></figure>













<h1 id="第十章-跨域"><a href="#第十章-跨域" class="headerlink" title="第十章 跨域"></a>第十章 跨域</h1><ul>
<li>Spring 处理方案。</li>
<li>Spring Security 处理方案。</li>
</ul>
<h2 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h2><p>跨域问题是实际应用开发中一个非常常见的需求，在 Spring 框架中对于跨域问题的处理方案有好几种，引 了 Spring Security 之后，跨域问题的处理方案又增加了。</p>
<h2 id="什么是-CORS"><a href="#什么是-CORS" class="headerlink" title="什么是 CORS"></a>什么是 CORS</h2><p>CORS (Cross-Origin Resource Sharing ）是由 W3C制定的一种跨域资源共享技术标准，其目的就是为了解决前端的跨域请求。在JavaEE 开发中，最常见的前端跨域请求解决方案是早期的JSONP，但是 JSONP 只支持 GET 请求，这是一个很大的缺陷，而 CORS 则支特多种 HTTTP请求方法，也是目前主流的跨域解决方案。</p>
<p>CORS 中新增了一组HTTP 请求头字段，通过这些字段，服务器告诉浏览器，那些网站通过浏览器有权限访问哪些资源。同时规定，对那些可能修改服务器数据的HTTP请求方法 （如GET以外的HTTP 请求等)，浏览器必须首先使用 OPTIONS 方法发起一个预检请求(prenightst），预检请求的目的是查看服务端是否支持即将发起的跨域请求，如果服务端允许，才发送实际的 HTTP 请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（如 Cookies、HTTP 认证信息等）。</p>
<blockquote>
<p> CORS: 同源&#x2F;同域 &#x3D; 协议+主机+端口</p>
</blockquote>
<h3 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h3><p>GET 请求为例，如果需要发起一个跨域请求，则请求头如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://localhost:8081</span><br><span class="line">Referer:http://localhost:8081/index.html</span><br></pre></td></tr></table></figure>

<p>如果服务端支持该跨域请求，那么返回的响应头中将包含如下字段：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin:http://localhost: 8081</span><br></pre></td></tr></table></figure>

<p>Access-Control-Allow-Origin 字段用来告诉浏览器可以访问该资源的域，当浏览器收到这样的响应头信息之后，提取出 Access-Control-Allow-Origin 字段中的值， 发现该值包含当前页面所在的域，就知道这个跨域是被允许的，因此就不再对前端的跨域请求进行限制。这属于简单请求，即不需要进行预检请求的跨域。</p>
<h3 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h3><p>对于一些非简单请求，会首先发送一个预检请求。预检请求类似下面这样：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">OPTIONS</span> <span class="string">/put</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line">Access-Control-Request-Method:PUT</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://localhost: 8081</span><br><span class="line">Referer:http://localhost:8081/index.html</span><br></pre></td></tr></table></figure>

<p>请求方法是 OPTIONS，请求头Origin 就告诉服务端当前页面所在域，请求头 Access-Control-Request-Methods 告诉服务器端即将发起的跨域请求所使用的万法。服务端对此进行判断，如果允许即将发起的跨域请求，则会给出如下响应：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line">Access-Control-Allow-Origin:http://localhost: 8081</span><br><span class="line"><span class="attribute">Access-Control-Request-Methods</span><span class="punctuation">: </span>PUT</span><br><span class="line"><span class="attribute">Access-Control-Max-Age</span><span class="punctuation">: </span>3600</span><br></pre></td></tr></table></figure>

<p>Access-Control-Allow-Metbods 字段表示允许的跨域方法：Access-Control-Max-Age 字段表示预检请求的有效期，单位为秒，在有效期内如果发起该跨域请求，则不用再次发起预检请求。预检请求结朿后，接下来就会发起一个真正的跨域请求，跨域请求和前面的简单请求跨域步骤类似。</p>
<h2 id="Spring-跨域解决方案"><a href="#Spring-跨域解决方案" class="headerlink" title="Spring 跨域解决方案"></a>Spring 跨域解决方案</h2><h3 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="@CrossOrigin"></a>@CrossOrigin</h3><p>Spring 中第一种处理跨域的方式是通过@CrossOrigin 注解来标记支持跨域，该注解可以添加在方法上，也可以添加在 Controller 上。当添加在 Controller 上时，表示 Controller 中的所</p>
<p>有接口都支持跨域，具体配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> Class HelloController&#123;</span><br><span class="line">	<span class="meta">@CrossOrigin</span> (origins =<span class="string">&quot;http://localhost:8081&quot;</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span> (<span class="string">&quot;/post&quot;</span>)</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">post</span> <span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello post&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@CrossOrigin 注解各属性含义如下：</p>
<ul>
<li><p>alowCredentials：浏览器是否应当发送凭证信息，如 Cookie。</p>
</li>
<li><p>allowedHeaders： 请求被允许的请求头字段，<code>*</code>表示所有字段。</p>
</li>
<li><p>exposedHeaders：哪些响应头可以作为响应的一部分暴露出来。</p>
<p><code>注意，这里只可以一一列举，通配符 * 在这里是无效的。</code></p>
</li>
<li><p>maxAge：预检请求的有效期，有效期内不必再次发送预检请求，默认是<code>1800 </code>秒。</p>
</li>
<li><p>methods：允许的请求方法，<code>*</code> 表示允许所有方法。</p>
</li>
<li><p>origins：允许的域，<code>*</code>表示允许所有域。</p>
</li>
</ul>
<h3 id="addCrosMapping"><a href="#addCrosMapping" class="headerlink" title="addCrosMapping"></a>addCrosMapping</h3><p>@CrossOrigin 注解需要添加在不同的 Controller 上。所以还有一种全局配置方法，就是通过重写 WebMvcConfigurerComposite#addCorsMappings方法来实现，具体配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Configuration</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span>&#123;</span><br><span class="line">  Override</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span> <span class="params">(CorsRegistry registry)</span>&#123;</span><br><span class="line">    registry.addMapping(<span class="string">&quot;/**&quot;</span>) <span class="comment">//处理的请求地址</span></span><br><span class="line">    .allowedMethods (<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    •allowedorigins(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    .allowedHeaders (<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    .allowCredentials (<span class="literal">false</span>)</span><br><span class="line">    •exposedHeaders (<span class="string">&quot;&quot;</span>)</span><br><span class="line">    .maxAge (<span class="number">3600</span>) ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CrosFilter"><a href="#CrosFilter" class="headerlink" title="CrosFilter"></a>CrosFilter</h3><p>Cosr Filter 是Spring Web 中提供的一个处理跨域的过滤器，开发者也可以通过该过该过滤器处理跨域。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    FilterRegistrationBean&lt;CorsFilter&gt; <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;CorsFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source));</span><br><span class="line">        registrationBean.setOrder(-<span class="number">1</span>);<span class="comment">//filter 0 1</span></span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Security-跨域解决方案"><a href="#Spring-Security-跨域解决方案" class="headerlink" title="Spring Security 跨域解决方案"></a>Spring Security 跨域解决方案</h2><h3 id="原理分析-2"><a href="#原理分析-2" class="headerlink" title="原理分析"></a>原理分析</h3><p>当我们为项目添加了 Spring Security 依赖之后，发现上面三种跨域方式有的失效了，有<br>则可以继续使用，这是怎么回事？</p>
<p>通过@CrossOrigin 注解或者重写 addCorsMappings 方法配置跨域，统统失效了，通<br>CorsFilter 配置的跨域，有没有失效则要看过滤器的优先级，如果过滤器优先级高于 Sp<br>Security 过滤器，即先于 Spring Security 过滤器执行，则 CorsFiter 所配置的跨域处理依然有效；如果过滤器优先级低于 Spring Security 过滤器，则 CorsFilter 所配置的跨域处理就会失效。</p>
<p>为了理清楚这个问题，我们先简略了解一下 Filter、DispatchserServlet 以及Interceptor 执行顺序。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220521074711128.png" alt="image-20220521074711128"></p>
<p>理清楚了执行顺序，我们再来看跨域请求过程。由于非简单请求都要首先发送一个预检请求<br>request），而预检请求并不会携带认证信息，所以预检请求就有被 Spring Security 拦截的可能。因此通过@CrossOrigin 注解或者重写 addCorsMappings 方法配置跨域就会失效。如果使用 CorsFilter 配置的跨域，只要过滤器优先级高于 SpringSecurity 过滤器就不会有问题。反之同样会出现问题。</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>Spring Security 中也提供了更专业的方式来解决预检请求所面临的问题。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .cors() <span class="comment">//跨域处理方案</span></span><br><span class="line">                .configurationSource(configurationSource())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CorsConfigurationSource <span class="title function_">configurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h1 id="第十一章-异常处理"><a href="#第十一章-异常处理" class="headerlink" title="第十一章 异常处理"></a>第十一章 异常处理</h1><ul>
<li>Spring Security 异常体系</li>
<li>自定义异常配置</li>
</ul>
<h3 id="异常体系"><a href="#异常体系" class="headerlink" title="异常体系"></a>异常体系</h3><p>Spring Security 中异常主要分为两大类:</p>
<ul>
<li>AuthenticationException:  认证异常</li>
<li>AccessDeniedException:    授权异常</li>
</ul>
<img src="/2022/01/26/SpringSecurity/image-20230402223226568.png" alt="image-20230402223226568" style="zoom:67%;">

<p>其中认证所涉及异常类型比较多，默认提供的异常类型如下：</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220430213210778.png" alt="image-20220430213210778"></p>
<p>相比于认证异常，权限异常类就要少了很多，默认提供的权限异常如下：</p>
<p><img src="/2022/01/26/SpringSecurity/image-20230402223444247-0446086.png" alt="image-20230402223444247"></p>
<p><img src="/2022/01/26/SpringSecurity/image-20220430213344621.png" alt="image-20220430213344621"></p>
<p>在实际项目开发中，如果默认提供异常无法满足需求时，就需要根据实际需要来自定义异常类。</p>
<h3 id="自定义异常处理配置"><a href="#自定义异常处理配置" class="headerlink" title="自定义异常处理配置"></a>自定义异常处理配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">          			<span class="comment">//.....</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()<span class="comment">//异常处理</span></span><br><span class="line">                .authenticationEntryPoint((request, response, e) -&gt; &#123;</span><br><span class="line">                  response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                  response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                  response.getWriter().write(<span class="string">&quot;尚未认证，请进行认证操作！&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .accessDeniedHandler((request, response, e) -&gt; &#123;</span><br><span class="line">                  response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                  response.setStatus(HttpStatus.FORBIDDEN.value());</span><br><span class="line">                  response.getWriter().write(<span class="string">&quot;无权访问!&quot;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h1 id="第十二章-授权"><a href="#第十二章-授权" class="headerlink" title="第十二章 授权"></a>第十二章 授权</h1><ul>
<li>什么是权限管理</li>
<li>权限管理核心概念</li>
<li>Spring Security 权限管理策略</li>
<li>基于 URL 地址的权限管理</li>
<li>基于方法的权限管理</li>
<li>实战</li>
</ul>
<h3 id="权限管理-1"><a href="#权限管理-1" class="headerlink" title="权限管理"></a>权限管理</h3><h4 id="认证-2"><a href="#认证-2" class="headerlink" title="认证"></a>认证</h4><p>**<code>身份认证</code>**，就是判断一个用户是否为合法用户的处理过程。Spring Security 中支持多种不同方式的认证，但是无论开发者使用那种方式认证，都不会影响授权功能使用。因为 Spring Security 很好做到了认证和授权解耦。</p>
<h4 id="授权-2"><a href="#授权-2" class="headerlink" title="授权"></a>授权</h4><p>**<code>授权</code>**，即访问控制，控制谁能访问哪些资源。简单的理解授权就是根据系统提前设置好的规则，给用户分配可以访问某一个资源的权限，用户根据自己所具有权限，去执行相应操作。</p>
<h3 id="授权核心概念"><a href="#授权核心概念" class="headerlink" title="授权核心概念"></a>授权核心概念</h3><p>在前面学习认证过程中，我们得知认证成功之后会将当前登录用户信息保存到 Authentication 对象中，Authentication 对象中有一个 getAuthorities() 方法，用来返回当前登录用户具备的权限信息，也就是当前用户具有权限信息。该方法的返回值为 Collection&lt;? extends GrantedAuthority&gt;，当需要进行权限判断时，就回根据集合返回权限信息调用相应方法进行判断。</p>
<p><img src="/2022/01/26/SpringSecurity/image-20220523110143445.png" alt="image-20220523110143445"></p>
<p>那么问题来了，针对于这个返回值 GrantedAuthority 应该如何理解呢? 是角色还是权限?</p>
<p>我们针对于授权可以是<code>基于角色权限管理</code>和<code>基于资源权限管理</code> ，从设计层面上来说，角色和权限是两个完全不同的东西：权限是一些具体操作，角色则是某些权限集合。如：READ_BOOK 和 ROLE_ADMIN 是完全不同的。因此至于返回值是什么取决于你的业务设计情况：</p>
<ul>
<li><p>基于角色权限设计就是: <code>用户&lt;=&gt;角色&lt;=&gt;资源</code> 三者关系 返回就是用户的<code>角色</code> </p>
</li>
<li><p>基于资源权限设计就是: <code>用户&lt;=&gt;权限&lt;=&gt;资源</code> 三者关系 返回就是用户的<code>权限</code> </p>
</li>
<li><p>基于角色和资源权限设计就是: <code>用户&lt;=&gt;角色&lt;=&gt;权限&lt;=&gt;资源</code> 返回统称为用户的<code>权限</code></p>
</li>
</ul>
<p>为什么可以统称为权限，因为从代码层面角色和权限没有太大不同都是权限，特别是在 Spring Security 中，角色和权限处理方式基本上都是一样的。唯一区别 SpringSecurity 在很多时候会自动给角色添加一个<code>ROLE_</code>前缀，而权限则不会自动添加。</p>
<h3 id="权限管理策略"><a href="#权限管理策略" class="headerlink" title="权限管理策略"></a>权限管理策略</h3><p>Spring Security 中提供的权限管理策略主要有两种类型:</p>
<ul>
<li><p>基于过滤器(URL)的权限管理 (FilterSecurityInterceptor)</p>
<ul>
<li>基于过滤器的权限管理主要是用来拦截 HTTP 请求，拦截下来之后，根据 HTTP 请求地址进行权限校验。</li>
</ul>
</li>
<li><p>基于 AOP (方法)的权限管理   (MethodSecurityInterceptor)</p>
<ul>
<li>基于 AOP 权限管理主要是用来处理方法级别的权限问题。当需要调用某一个方法时，通过 AOP 将操作拦截下来，然后判断用户是否具备相关的权限。</li>
</ul>
</li>
</ul>
<h3 id="基于-URL-权限管理"><a href="#基于-URL-权限管理" class="headerlink" title="基于 URL 权限管理"></a>基于 URL 权限管理</h3><ul>
<li>开发 controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;info ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置授权</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blr.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建内存数据源</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;ADMIN&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;win7&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;lisi&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;READ_BOOK&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/getInfo&quot;</span>).hasRole(<span class="string">&quot;READ_BOOK&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目测试</p>
<h4 id="权限表达式"><a href="#权限表达式" class="headerlink" title="权限表达式"></a>权限表达式</h4><p><img src="/2022/01/26/SpringSecurity/image-20220523153200373.png" alt="image-20220523153200373"></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>hasAuthority(String authority)</td>
<td>当前用户是否具备指定权限</td>
</tr>
<tr>
<td>hasAnyAuthority(String… authorities)</td>
<td>当前用户是否具备指定权限中任意一个</td>
</tr>
<tr>
<td>hasRole(String role)</td>
<td>当前用户是否具备指定角色</td>
</tr>
<tr>
<td>hasAnyRole(String… roles);</td>
<td>当前用户是否具备指定角色中任意一个</td>
</tr>
<tr>
<td>permitAll();</td>
<td>放行所有请求&#x2F;调用</td>
</tr>
<tr>
<td>denyAll();</td>
<td>拒绝所有请求&#x2F;调用</td>
</tr>
<tr>
<td>isAnonymous();</td>
<td>当前用户是否是一个匿名用户</td>
</tr>
<tr>
<td>isAuthenticated();</td>
<td>当前用户是否已经认证成功</td>
</tr>
<tr>
<td>isRememberMe();</td>
<td>当前用户是否通过 Remember-Me 自动登录</td>
</tr>
<tr>
<td>isFullyAuthenticated();</td>
<td>当前用户是否既不是匿名用户又不是通过 Remember-Me 自动登录的</td>
</tr>
<tr>
<td>hasPermission(Object targetId, Object permission);</td>
<td>当前用户是否具备指定目标的指定权限信息</td>
</tr>
<tr>
<td>hasPermission(Object targetId, String targetType, Object permission);</td>
<td>当前用户是否具备指定目标的指定权限信息</td>
</tr>
</tbody></table>
<h3 id="基于-方法-权限管理"><a href="#基于-方法-权限管理" class="headerlink" title="基于 方法 权限管理"></a>基于 方法 权限管理</h3><p>基于方法的权限管理主要是通过 A0P 来实现的，Spring Security 中通过 MethodSecurityInterceptor 来提供相关的实现。不同在于 FilterSecurityInterceptor 只是在请求之前进行前置处理，MethodSecurityInterceptor 除了前置处理之外还可以进行后置处理。前置处理就是在请求之前判断是否具备相应的权限，后置处理则是对方法的执行结果进行二次过滤。前置处理和后置处理分别对应了不同的实现类。</p>
<h4 id="EnableGlobalMethodSecurity"><a href="#EnableGlobalMethodSecurity" class="headerlink" title="@EnableGlobalMethodSecurity"></a>@EnableGlobalMethodSecurity</h4><p>EnableGlobalMethodSecurity 该注解是用来开启权限注解，用法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>perPostEnabled</strong>: 开启 Spring Security 提供的四个权限注解，@PostAuthorize、@PostFilter、@PreAuthorize 以及@PreFilter。</li>
<li><strong>securedEnabled</strong>: 开启 Spring Security 提供的 @Secured 注解支持，该注解不支持权限表达式</li>
<li><strong>jsr250Enabled</strong>: 开启 JSR-250 提供的注解，主要是@DenyAll、@PermitAll、@RolesAll 同样这些注解也不支持权限表达式</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 以上注解含义如下:</span></span><br><span class="line"><span class="bullet">-</span> @PostAuthorize： 在目前标方法执行之后进行权限校验。</span><br><span class="line"><span class="bullet">-</span> @PostFiter： 在目标方法执行之后对方法的返回结果进行过滤。</span><br><span class="line"><span class="bullet">-</span> @PreAuthorize：在目标方法执行之前进行权限校验。</span><br><span class="line"><span class="bullet">-</span> @PreFiter：在目前标方法执行之前对方法参数进行过滤。</span><br><span class="line"><span class="bullet">-</span> @Secured：访问目标方法必须具各相应的角色。</span><br><span class="line"><span class="bullet">-</span> @DenyAll：拒绝所有访问。</span><br><span class="line"><span class="bullet">-</span> @PermitAll：允许所有访问。</span><br><span class="line"><span class="bullet">-</span> @RolesAllowed：访问目标方法必须具备相应的角色。</span><br></pre></td></tr></table></figure>

<p>这些基于方法的权限管理相关的注解，一般来说只要设置 <strong><code>prePostEnabled=true</code></strong> 就够用了。</p>
<h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><ul>
<li>开启注解使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeMethodController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) and authentication.name==&#x27;root&#x27;&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;authentication.name==#name&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello:&quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreFilter(value = &quot;filterObject.id%2!=0&quot;,filterTarget = &quot;users&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/users&quot;)</span>  <span class="comment">//filterTarget 必须是 数组  集合</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUsers</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;User&gt; users)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;users = &quot;</span> + users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostAuthorize(&quot;returnObject.id==1&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">&quot;blr&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostFilter(&quot;filterObject.id%2==0&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/lists&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            users.add(<span class="keyword">new</span> <span class="title class_">User</span>(i, <span class="string">&quot;blr:&quot;</span> + i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured(&#123;&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//只能判断角色</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/secured&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, <span class="string">&quot;secured&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//具有其中一个即可</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/username&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUsername2</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PermitAll</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/permitAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">permitAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;PermitAll&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DenyAll</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/denyAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">denyAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DenyAll&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RolesAllowed(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//具有其中一个角色即可</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rolesAllowed&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rolesAllowed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RolesAllowed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="原理分析-3"><a href="#原理分析-3" class="headerlink" title="原理分析"></a>原理分析</h2><h3 id="两种处理器"><a href="#两种处理器" class="headerlink" title="两种处理器"></a>两种处理器</h3><p>​	前面我们讲了,SpringSecurity中提供的权限管理功能主要有两种类型: 1.基于过滤器的权限管理(FilterSecurityInterceptor)、2.基于AOP的权限管理(MethodSecurityInterceptor)</p>
<p>​	无论是哪种,都涉及到一个前置处理器和后置处理器. 下图分别表示基于过滤器的权限管理和基于AOP的权限管理中的前置处理器和后置处理器.</p>
<img src="/2022/01/26/SpringSecurity/image-20230409212440889.png" alt="image-20230409212440889" style="zoom:50%;">



<img src="/2022/01/26/SpringSecurity/image-20230409213647550.png" alt="image-20230409213647550" style="zoom:50%;">



<p>​	在基于过滤器的权限管理中, 请求首先会到达过滤器<strong>FilterSecurityInteceptor</strong>, 在其执行过程中, 首先会由前置处理器去判断当前请求的用户是否具备相应的权限, 如果具备, 则请求继续往下走, 到达目标方法并执行完毕. 在响应时, 又会经过<strong>FilterSecurityInteceptor</strong>过滤器, 此时由后置处理器去完成其他收尾工作. 在基于过滤器的权限管理, 实际上就是拦截请求URL地址, 这种权限管理方式粒度比较粗, 而且过滤器中拿到的是响应的<strong>HttpServletResponse</strong>对象, 对其所返回的数据做二次处理并不方便.</p>
<p>​	在基于方法的权限管理中, 目标方法的调用会被<strong>MethodSecurityInterceptor</strong>拦截下来, 实现原理当然就是大家所熟知的AOP机制, 当目标方法的调用被<strong>MethodSecurityInterceptor</strong>拦截下之后, 在其invoke方法中首先会由前置处理器去判断当前用户是否具备调用目标方法所需要的权限, 如果具备, 则继续执行目标方法. 当目标方法执行完毕并给出返回结果之后, 在<strong>MethodSecurityInterceptor#invoke</strong>方法中, 由后置处理器再去对目标方法的返回结果进行过滤或者鉴权, 然后在invoke方法中将处理后的结果返回</p>
<p>​	可以看到, 无论是基于过滤器的权限管理还是基于方法的权限管理 ,前置处理器都是重中之重, 两者都会用到. 而后置处理器则只是在基于方法的权限管理中会用到.</p>
<h4 id="前置处理器"><a href="#前置处理器" class="headerlink" title="前置处理器"></a>前置处理器</h4><p>​	要理解前置处理器, 首先需要了解投票器.</p>
<blockquote>
<p>投票器</p>
</blockquote>
<p>​	投票器是SpringSecurity权限管理功能中的一个组件, 顾名思义, 投票器的作用就是针对是否允许某个操作进行投票. 当请求的URL地址被拦截下来之后, 或者当被调用的方法被AOP拦截下来之后, 都会调用投票器对当前操作进行投票, 以便决定是否允许当前操作</p>
<p>​	在Spring Security中, 投票器由AccessDecisionVoter来定义, 我们来看一下这个接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccessDecisionVoter</span>&lt;S&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> <span class="variable">ACCESS_GRANTED</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> <span class="variable">ACCESS_ABSTAIN</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> <span class="variable">ACCESS_DENIED</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(ConfigAttribute attribute)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> <span class="title function_">vote</span><span class="params">(Authentication authentication, S object,</span></span><br><span class="line"><span class="params">			Collection&lt;ConfigAttribute&gt; attributes)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这个接口首先定义了三个常量: <strong>ACCESS_GRANTED</strong>表示投票通过、<strong>ACESS_ABSTAIN</strong>表示弃权、<strong>ACCESS_DENIED</strong>表示拒绝</li>
<li><strong>supports(ConfigAttribute)<strong>方法: 用来判断是否支持处理</strong>ConfigAttribute</strong>对象</li>
<li>**supports(Class)**方法: 用来判断是否支持处理受保护的安全对象.</li>
<li><strong>vote</strong>方法: 则是具体的投票方法, 根据用户所具备的权限以及当前请求需要的权限进行投票. <strong>vote</strong>方法有三个参数: 第一个参数<strong>authentication</strong>这可以提取出来当前用户所具备的权限. 第二个参数object表示受保护的安全对象, 如果受保护的是URL地址, 则object就是一个<strong>MethodInvocation</strong>对象. 第三个参数<strong>attributes</strong>表示访问受保护对象所需要的权限. <strong>vote</strong>方法的返回值就是前面所定义的三个常量之一.</li>
</ul>
<p>​	SpringSecurity中为<strong>AccessDecisionVoter</strong>提供了诸多不同的实现类, 如图所示, 是<strong>AccessDecisionVoter</strong>的所有继承类:</p>
<img src="/2022/01/26/SpringSecurity/image-20230409220927740.png" alt="image-20230409220927740" style="zoom:50%;">

<ul>
<li><strong>RoleVoter</strong>: <strong>RoleVoter</strong>是根据登录主体的角色进行投票, 即判断当前用户是否具备受保护对象所需要的角色. 需要注意的是, 默认情况下角色需要以“ROLE_”开始, 否则supports方法直接返回false, 不进行后续的投票操作.</li>
<li><strong>RoleHierarchyVoter</strong>: <strong>RoleHierarchyVoter</strong>继承自<strong>RoleVoter</strong>, 投票的逻辑和<strong>RoleVoter</strong>一致, 不同的是<strong>RoleHierarchyVoter</strong>支持角色的基础, 它是通过<strong>RoleHierarchyImpl</strong>对象对用户所具备的角色进行解析, 获取用户真正“可触达”的角色; 而<strong>RoleVoter</strong>则是直接调用**authentication.getAuthorities()**方法进行获取用户的角色.</li>
<li><strong>WebExpressionVoter</strong>: 基于URL地址进行权限控制时的投票器(支持SpEL)</li>
<li><strong>Jsr250Voter</strong>: 处理JSR-250权限注解的投票器, 如@PermitAll、@DenyAll等.</li>
<li><strong>AuthenticatedVoter</strong>: <strong>AuthenticatedVoter</strong>用来判断当前用户的认证形式, 它有三种取值: <strong>IS_AUTHENTICATED_FULLY</strong>、<strong>IS_AUTHENTICATED_REMEMBERED</strong> 以及<strong>IS_AUTHENTICATED_ANONYMOUSLY</strong>. 其中: <strong>IS_AUTHENTICATED_FULLY</strong>要求当前用户既不是匿名用户也不是通过<strong>RememberMe</strong>进行认证; <strong>IS_AUTHENTICATED_ANONYMOUSLY</strong>则允许当前用户通过<strong>RememberMe</strong>认证, 也允许当前用户是匿名用户.</li>
<li><strong>AbstractAclVoter</strong>: 基于ACL进行权限控制时的投票器. 这是一个抽象类, 没有绑定到具体的ACL系统</li>
<li><strong>PreInvocationAuthorizationAdviceVoter</strong>: 处理**@PreFilter<strong>和</strong>@PreAuthorize**注解的投票器.</li>
</ul>
<p>​	这就是SpringSecurity中提供的所有投票器, 在具体使用中, 可以单独使用一个, 也可以多个一起使用. 如果上面这些投票器都无法满足需求, 开发者也可以自定义投票器, 需要注意的是, 投票结果并非最终结果(通过或拒绝), 最终结果还要看决策器(<strong>AccessDecisionManager</strong>)</p>
<blockquote>
<p>决策器</p>
</blockquote>
<p>​	决策器由<strong>AccessDecisionManager</strong>负责, <strong>AccessDecisionManager</strong>会同时管理多个投票器, 由<strong>AccessDecisionManager</strong>调用投票器进行投票, 然后根据投票结果做出相应的决策, 所以我们将<strong>AccessDecisionManager</strong>也称为是一个决策管理器. 我们来看一下它的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccessDecisionManager</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">decide</span><span class="params">(Authentication authentication, Object object,</span></span><br><span class="line"><span class="params">			Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException,</span><br><span class="line">			InsufficientAuthenticationException;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(ConfigAttribute attribute)</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	这里一共有三个方法:</p>
<ul>
<li><strong>decide</strong>方法: 是核心的决策方法, 在这个方法中判断是否允许当前URL或者方法的调用, 如果不允许, 则会抛出<strong>AccessDeniedException</strong>异常</li>
<li><strong>supports(ConfigAttribute)<strong>方法: 用来判断是否支持处理</strong>ConfigAttribute</strong>对象</li>
<li>**supports(Class)**方法: 用来判断是否支持当前安全对象.</li>
</ul>
<p>​	我们来看一下官方提供的类图:</p>
<img src="/2022/01/26/SpringSecurity/image-20230409224527191.png" alt="image-20230409224527191" style="zoom:50%;">

<p>​	从图中可以看出, <strong>AccessDecisionManager</strong>有一个实现类<strong>AbstractAccessDecisonManager</strong>, 一个<strong>AbstractAccessDecisionManger</strong>对应多个投票器. 多个投票器针对同个请求可能是会给出不同的结果, 那么听谁的呢? 这就要看决策器了.</p>
<ul>
<li><strong>AffirmativeBased</strong>: 一票通过机制, 即只要有一个投票器通过就可以访问(默认如此)</li>
<li><strong>UnanimousBased</strong>: 一票否决机制, 即只要有一个投票器反对就不可以访问</li>
<li><strong>ConsensusBased</strong>: 少数服从多数机制. 如果是平局并且至少有一张赞同票, 则根据<strong>allowIfEqualGrantedDeniedDecisions</strong>参数的取值来决定, 如果该参数取值为true, 则可以访问, 否则不可以访问.</li>
</ul>
<p>​	这是SpringSecurity中提供的三个决策器, 如果这三个决策器无法满足需求, 开发者也可以自定义类继承自<strong>AbstractAccessDecisionManager</strong>实现自己的决策器.</p>
<p>​	这就是前置处理器的大致逻辑, 无论是基于URL地址的权限管理, 还是基于方法的权限管理, 都是在前置处理器中通过<strong>AccessDecisionManager</strong>调用<strong>AccessDecisionVoter</strong>进行投票, 进而做出相应的策略</p>
<h2 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h2><p>在前面的案例中，我们配置的 URL 拦截规则和请求 URL 所需要的权限都是通过代码来配置的，这样就比较死板，如果想要调整访问某一个 URL 所需要的权限，就需要修改代码。</p>
<p>动态管理权限规则就是我们将 URL 拦截规则和访问 URI 所需要的权限都保存在数据库中，这样，在不修改源代码的情况下，只需要修改数据库中的数据，就可以对权限进行调整。</p>
<p><code>用户&lt;--中间表--&gt; 角色 &lt;--中间表--&gt; 菜单</code></p>
<h3 id="库表设计"><a href="#库表设计" class="headerlink" title="库表设计"></a>库表设计</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for menu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `menu` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `<span class="keyword">pattern</span>` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of menu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;/admin/**&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;/user/**&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;/guest/**&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for menu_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `menu_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `menu_role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `mid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `mid` (`mid`),</span><br><span class="line">  KEY `rid` (`rid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `menu_role_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`mid`) <span class="keyword">REFERENCES</span> `menu` (`id`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `menu_role_ibfk_2` <span class="keyword">FOREIGN</span> KEY (`rid`) <span class="keyword">REFERENCES</span> `role` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of menu_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nameZh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>, <span class="string">&#x27;系统管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_USER&#x27;</span>, <span class="string">&#x27;普通用户&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_GUEST&#x27;</span>, <span class="string">&#x27;游客&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `enabled` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `locked` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `uid` (`uid`),</span><br><span class="line">  KEY `rid` (`rid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `user_role_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`uid`) <span class="keyword">REFERENCES</span> `<span class="keyword">user</span>` (`id`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `user_role_ibfk_2` <span class="keyword">FOREIGN</span> KEY (`rid`) <span class="keyword">REFERENCES</span> `role` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="创建-springboot-应用"><a href="#创建-springboot-应用" class="headerlink" title="创建 springboot 应用"></a>创建 springboot 应用</h3><ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:com/blr/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.blr.entity</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> locked;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> roles.stream().map(r -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(r.getName())).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(<span class="type">boolean</span> enabled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocked</span><span class="params">(<span class="type">boolean</span> locked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locked = locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Role&gt; <span class="title function_">getRoles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roles;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameZh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameZh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameZh</span><span class="params">(String nameZh)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameZh = nameZh;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Menu</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String pattern;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Role&gt; <span class="title function_">getRoles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPattern</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPattern</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pattern = pattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 mapper 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;Role&gt; <span class="title function_">getUserRoleByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MenuMapper</span> &#123;</span><br><span class="line">    List&lt;Menu&gt; <span class="title function_">getAllMenu</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 mapper 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.blr.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.blr.entity.User&quot;</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        where username = #&#123;username&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserRoleByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.blr.entity.Role&quot;</span>&gt;</span></span><br><span class="line">        select r.*</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where ur.uid = #&#123;uid&#125;</span><br><span class="line">          and ur.rid = r.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.blr.mapper.MenuMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;MenuResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.blr.entity.Menu&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;pattern&quot;</span> <span class="attr">column</span>=<span class="string">&quot;pattern&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;roles&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.blr.entity.Role&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;rid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rname&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rnameZh&quot;</span> <span class="attr">property</span>=<span class="string">&quot;nameZh&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllMenu&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;MenuResultMap&quot;</span>&gt;</span></span><br><span class="line">        select m.*, r.id as rid, r.name as rname, r.nameZh as rnameZh</span><br><span class="line">        from menu m</span><br><span class="line">                 left join menu_role mr on m.`id` = mr.`mid`</span><br><span class="line">                 left join role r on r.`id` = mr.`rid`</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 service 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setRoles(userMapper.getUserRoleByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MenuService</span><span class="params">(MenuMapper menuMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.menuMapper = menuMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Menu&gt; <span class="title function_">getAllMenu</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> menuMapper.getAllMenu();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建测试 controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/guest/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">guest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello guest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 CustomSecurityMetadataSource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title class_">FilterInvocationSecurityMetadataSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuService menuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomSecurityMetadataSource</span><span class="params">(MenuService menuService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.menuService = menuService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAttributes</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> ((FilterInvocation) object).getRequest().getRequestURI();</span><br><span class="line">        List&lt;Menu&gt; allMenu = menuService.getAllMenu();</span><br><span class="line">        <span class="keyword">for</span> (Menu menu : allMenu) &#123;</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(menu.getPattern(), requestURI)) &#123;</span><br><span class="line">                String[] roles = menu.getRoles().stream().map(r -&gt; r.getName()).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">                <span class="keyword">return</span> SecurityConfig.createList(roles);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAllConfigAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class.isAssignableFrom(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 Security 配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomSecurityMetadataSource customSecurityMetadataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(CustomSecurityMetadataSource customSecurityMetadataSource, UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.customSecurityMetadataSource = customSecurityMetadataSource;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> http.getSharedObject(ApplicationContext.class);</span><br><span class="line">        http.apply(<span class="keyword">new</span> <span class="title class_">UrlAuthorizationConfigurer</span>&lt;&gt;(applicationContext))</span><br><span class="line">                .withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">FilterSecurityInterceptor</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O object)</span> &#123;</span><br><span class="line">                        object.setSecurityMetadataSource(customSecurityMetadataSource);</span><br><span class="line">                        <span class="comment">//是否拒绝公共资源</span></span><br><span class="line">                        object.setRejectPublicInvocations(<span class="literal">false</span>);</span><br><span class="line">                        <span class="keyword">return</span> object;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        http.formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动入口类进行测试</p>
</li>
</ul>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2022/06/16/MySQL45%E8%AE%B2/"
      title="MySql45讲"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        MySql45讲
        
    </p>
  </a>
  <a class="article-nav-btn right  disabled "
     >

    <p class="title-text">
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 高喆<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
