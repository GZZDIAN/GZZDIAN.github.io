

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="gaozhe">
  <meta name="keywords" content="">
  
    <meta name="description" content="常用的工具类一、httpclient这个工具类可以帮助我们来发送http请求  使用jdk自带的URLConnection   工具类  123456789101112131415161718192021222324252627282930313233343536373839404142434445public class HttpsUtils &amp;#123;    &#x2F;*请求url获取返回的内容*&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="常用工具类">
<meta property="og:url" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/index.html">
<meta property="og:site_name" content="gzzear&#39;s blog">
<meta property="og:description" content="常用的工具类一、httpclient这个工具类可以帮助我们来发送http请求  使用jdk自带的URLConnection   工具类  123456789101112131415161718192021222324252627282930313233343536373839404142434445public class HttpsUtils &amp;#123;    &#x2F;*请求url获取返回的内容*&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/432628/1600596624981-c13fdbed-b671-4fbe-8f65-12945c463272.png?x-oss-process=image/resize,w_882,limit_0">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/432628/1600598957232-fbf1b3e2-f298-4a14-b5a7-fd5156285767.png?x-oss-process=image/resize,w_778,limit_0">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/432628/1600598710790-a573c284-cb65-47aa-b75e-8cb4cab9075d.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/432628/1600599017157-2f423acb-316c-4dd4-8c76-d9ffe45c2e85.png?x-oss-process=image/resize,w_796,limit_0">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220720204039917.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230205212522889-5603525.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220814200700588.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220814200942410.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221204160334223.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221205175142353.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/SouthEast.jpeg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013212906266.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213434850.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213509562.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213654484.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213736635.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213930585.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013214055547.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221016144731903.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221016144829546.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208110514058-0468719.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208110756763-0468878.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112043652.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112259603-0469781.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112927527.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112941485.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208130727584.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150100749-0742068.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150130877.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150202811-0742125.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230116165636730-3859398.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220908165105908.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/2022091315452386.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211154930116.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155138470.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155352126-6102035.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155948987.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002.jpg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image004.jpg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160843064.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160907458.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160925901.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6102973.jpg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6102991.jpg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6103023.jpg">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161207770.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161226797.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161257545.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161333075.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161346572.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161359965.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161411074.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211165820478.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211170223041.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230212002758979.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230212003649475.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230214095745301.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20210524160517744.png">
<meta property="og:image" content="http://example.com/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230625000621934.png">
<meta property="article:published_time" content="2022-07-02T06:47:34.000Z">
<meta property="article:modified_time" content="2023-08-03T01:26:06.883Z">
<meta property="article:author" content="gaozhe">
<meta property="article:tag" content="编程技巧">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/432628/1600596624981-c13fdbed-b671-4fbe-8f65-12945c463272.png?x-oss-process=image/resize,w_882,limit_0">
  
  
  
  <title>常用工具类 - gzzear&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="常用工具类"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-02 14:47" pubdate>
          2022年7月2日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          273k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          2278 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">常用工具类</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="常用的工具类"><a href="#常用的工具类" class="headerlink" title="常用的工具类"></a>常用的工具类</h1><h2 id="一、httpclient"><a href="#一、httpclient" class="headerlink" title="一、httpclient"></a>一、httpclient</h2><p>这个工具类可以帮助我们来发送http请求</p>
<ol>
<li>使用jdk自带的URLConnection</li>
</ol>
<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpsUtils</span> &#123;<br><br>    <span class="hljs-comment">/*请求url获取返回的内容*/</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getReturn</span><span class="hljs-params">(HttpURLConnection connection)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-comment">//将返回的输入流转换成字符串</span><br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> connection.getInputStream();<br>            <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(inputStreamReader);)&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">while</span> ((str = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                buffer.append(str);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> buffer.toString();<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//post请求的方法重载</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getReturn</span><span class="hljs-params">(HttpURLConnection connection,String jsr)</span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>            <span class="hljs-type">byte</span>[] bytes = jsr.getBytes();<br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>            outputStream.write(bytes);<br>            outputStream.flush();<br>            outputStream.close();<br><br>            <span class="hljs-comment">//将返回的输入流转换成字符串</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> connection.getInputStream();<br>            <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(inputStreamReader);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">while</span> ((str = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                buffer.append(str);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> buffer.toString();<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            log.error(<span class="hljs-string">&quot;postUrlConnection出错&quot;</span>,e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>使用案例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://xxx-你的请求地址&quot;</span>;<br><span class="hljs-type">URL</span> <span class="hljs-variable">serverUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br><span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) serverUrl.openConnection();<br><span class="hljs-comment">// 设置是否向connection输出，因为这个是post请求，参数要放在</span><br><span class="hljs-comment">// http正文内，因此需要设为true</span><br>conn.setDoOutput(Boolean.TRUE);<br>conn.setDoInput(Boolean.TRUE);<br><span class="hljs-comment">//请求方式是POST</span><br>conn.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br><span class="hljs-comment">// Post 请求不能使用缓存</span><br>conn.setUseCaches(<span class="hljs-literal">false</span>);<br>conn.setRequestProperty(<span class="hljs-string">&quot;Content-type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>);<br><span class="hljs-comment">//必须设置false，否则会自动redirect到重定向后的地址</span><br>conn.setInstanceFollowRedirects(<span class="hljs-literal">false</span>);<br><span class="hljs-comment">//建立连接</span><br>conn.connect();<br><span class="hljs-comment">//设置请求体</span><br>HashMap map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-comment">//key-value的形式设置请求参数</span><br>map.put(<span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> JSONObject.toJSONString(map);<br><span class="hljs-comment">//获取了返回值</span><br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> HttpsUtils.getReturn(conn,s);<br><span class="hljs-comment">//如果返回值是标准的JSON字符串可以像我这样给他进行转换</span><br><span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSONObject.parseObject(result);<br><br></code></pre></td></tr></table></figure>











<ol start="2">
<li>使用HttpClient</li>
</ol>
<blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>封装工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> org.apache.http.client.entity.UrlEncodedFormEntity;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpGet;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpPost;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpRequestBase;<br><span class="hljs-keyword">import</span> org.apache.http.entity.ContentType;<br><span class="hljs-keyword">import</span> org.apache.http.entity.StringEntity;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.HttpClients;<br><span class="hljs-keyword">import</span> org.apache.http.message.BasicNameValuePair;<br><span class="hljs-keyword">import</span> org.apache.http.util.EntityUtils;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 发送http请求工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/07/02 3:31 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpsUtils</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送GET请求</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> url    请求的url路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> params 请求参数</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 响应结果</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sendGet</span><span class="hljs-params">(String url, Map&lt;String, String&gt; params)</span> &#123;<br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      httpClient = HttpClientBuilder.create().build();<br>      httpGet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(url);<br>      <span class="hljs-comment">// 设置参数</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != params &amp;&amp; params.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;BasicNameValuePair&gt; pairList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        params.forEach((x, y) -&gt; pairList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(x, y)));<br>        <span class="hljs-type">UrlEncodedFormEntity</span> <span class="hljs-variable">urlEncodedFormEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlEncodedFormEntity</span>(pairList, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 将参数转成page=1&amp;limit=5格式</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> EntityUtils.toString(urlEncodedFormEntity, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        httpGet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(url + <span class="hljs-string">&quot;?&quot;</span> + param);<br>      &#125;<br>      response = httpClient.execute(httpGet);<br>      result = EntityUtils.toString(response.getEntity());<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>      e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      close(response, httpGet, httpClient);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送POST请求(QueryParams的方式)</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> url    请求路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> params 请求参数</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 响应结果</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sendPostRequest</span><span class="hljs-params">(String url, Map&lt;String, String&gt; params)</span> &#123;<br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">HttpPost</span> <span class="hljs-variable">httpPost</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      httpClient = HttpClientBuilder.create().build();<br>      httpPost = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(url);<br>      <span class="hljs-comment">// 设置参数</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != params &amp;&amp; params.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;BasicNameValuePair&gt; pairList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        params.forEach((x, y) -&gt; pairList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(x, y)));<br>        <span class="hljs-type">UrlEncodedFormEntity</span> <span class="hljs-variable">urlEncodedFormEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlEncodedFormEntity</span>(pairList, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        httpPost.setEntity(urlEncodedFormEntity);<br>      &#125;<br>      response = httpClient.execute(httpPost);<br>      result = EntityUtils.toString(response.getEntity());<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>      e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      close(response, httpPost, httpClient);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送POST请求(json的方式)</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> url  请求路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> params 请求参数</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 响应结果</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doPostJson</span><span class="hljs-params">(String url, Map&lt;String, String&gt; params)</span> &#123;<br>    <span class="hljs-keyword">return</span> doPostJson(url, JSON.toJSONString(params));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送POST请求(json的方式)</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> url  请求路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> json 请求参数</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 响应结果</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doPostJson</span><span class="hljs-params">(String url, String json)</span> &#123;<br>    <span class="hljs-comment">// 创建Httpclient对象</span><br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">HttpPost</span> <span class="hljs-variable">httpPost</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 创建Http Post请求</span><br>      httpPost = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(url);<br>      <span class="hljs-comment">// 创建请求内容</span><br>      <span class="hljs-type">StringEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEntity</span>(json, ContentType.APPLICATION_JSON);<br>      httpPost.setEntity(entity);<br>      <span class="hljs-comment">// 执行http请求</span><br>      response = httpClient.execute(httpPost);<br>      resultString = EntityUtils.toString(response.getEntity(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      close(response, httpPost, httpClient);<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultString;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 关闭流</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> response        response流</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> httpRequestBase httpPost/Get流</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> httpClient      HttpClient流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(CloseableHttpResponse response, HttpRequestBase httpRequestBase,</span><br><span class="hljs-params">      CloseableHttpClient httpClient)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>) &#123;<br>        response.close();<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (httpRequestBase != <span class="hljs-literal">null</span>) &#123;<br>        httpRequestBase.releaseConnection();<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (httpClient != <span class="hljs-literal">null</span>) &#123;<br>        httpClient.close();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>      e.printStackTrace();<br>    &#125;<br>  &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>









<blockquote>
<p>测试案例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> test &#123;<br>        <span class="hljs-comment">// 打开浏览器</span><br>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClientBuilder.create().build();<br>        <span class="hljs-comment">// 输入url地址</span><br>        <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(<span class="hljs-string">&quot;https://www.baidu.com/&quot;</span>);<br>        <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 敲回车，发送请求，获取响应</span><br>            response = httpClient.execute(httpGet);<br>            <span class="hljs-comment">// 获取内容</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> EntityUtils.toString(response.getEntity(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>            System.out.println(result);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>)&#123;<br>                    response.close();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (httpGet != <span class="hljs-literal">null</span>)&#123;<br>                    httpGet.releaseConnection();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (httpClient!= <span class="hljs-literal">null</span>)&#123;<br>                    httpClient.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>发送GET请求</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">sendGet</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        client = HttpClientBuilder.create().build();<br>        <span class="hljs-comment">// 构建参数列表【BasicNameValuePair】</span><br>        List&lt;BasicNameValuePair&gt; pairs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        pairs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(<span class="hljs-string">&quot;page&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>));<br>        pairs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(<span class="hljs-string">&quot;limit&quot;</span>,<span class="hljs-string">&quot;5&quot;</span>));<br>        <span class="hljs-comment">// 设置参数的编码</span><br>        <span class="hljs-type">UrlEncodedFormEntity</span> <span class="hljs-variable">urlEncodedFormEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlEncodedFormEntity</span>(pairs,<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 将参数转成page=1&amp;limit=5格式</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> EntityUtils.toString(urlEncodedFormEntity, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        System.out.println(params);<br>        httpGet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(<span class="hljs-string">&quot;http://localhost:8080/user/queryUserList?&quot;</span>+params);<br>        <span class="hljs-comment">// 发送请求</span><br>        response = client.execute(httpGet);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> EntityUtils.toString(response.getEntity(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        System.out.println(result);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>) &#123;<br>                response.close();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (httpGet != <span class="hljs-literal">null</span>)&#123;<br>                httpGet.releaseConnection();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>)&#123;<br>                client.close();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>发送POST请求</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPost</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">HttpPost</span> <span class="hljs-variable">httpPost</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        httpClient = HttpClientBuilder.create().build();<br>        httpPost = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(<span class="hljs-string">&quot;http://localhost:8080/user/addUser&quot;</span>);<br>        <span class="hljs-comment">// 构建参数列表【BasicNameValuePair】</span><br>        List&lt;BasicNameValuePair&gt; pairs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        pairs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;张三&quot;</span>));<br>        pairs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicNameValuePair</span>(<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>));<br>        <span class="hljs-comment">// 设置参数编码</span><br>        <span class="hljs-type">UrlEncodedFormEntity</span> <span class="hljs-variable">urlEncodedFormEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlEncodedFormEntity</span>(pairs,<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 发送请求之前给httpPost设置参数</span><br>        httpPost.setEntity(urlEncodedFormEntity);<br>        response = httpClient.execute(httpPost);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> EntityUtils.toString(response.getEntity(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        System.out.println(result);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>) &#123;<br>                response.close();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (httpPost != <span class="hljs-literal">null</span>)&#123;<br>                httpPost.releaseConnection();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (httpClient != <span class="hljs-literal">null</span>)&#123;<br>                httpClient.close();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





























<h2 id="二、mybatis-plus代码自动生成器"><a href="#二、mybatis-plus代码自动生成器" class="headerlink" title="二、mybatis-plus代码自动生成器"></a>二、mybatis-plus代码自动生成器</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-comment">&lt;!--velocity 模板引擎，Mybatis Plus 代码生成器需要--&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.velocity<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>velocity-engine-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>生成器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.FastAutoGenerator;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.OutputFile;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.engine.VelocityTemplateEngine;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/27 09:42</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneratorCodeUtil</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://192.168.100.4:3306/zhgd_jky?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zhgd_jky&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Jz!da4-p&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">author</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;gzzear&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateCode</span><span class="hljs-params">()</span> &#123;<br>    FastAutoGenerator.create(url, username, password)<br>        .globalConfig(builder -&gt; &#123;<br>          builder.author(author) <span class="hljs-comment">// 设置作者</span><br>              .fileOverride()<br>              .enableSwagger() <span class="hljs-comment">// 开启 swagger 模式</span><br>              .outputDir(<br>                  <span class="hljs-string">&quot;/Users/gaozhe/code/jianke-zhgd-backend/jianke-modules/jianke-dem/src/main/java&quot;</span>); <span class="hljs-comment">// 指定输出目录</span><br>        &#125;)<br>        .packageConfig(builder -&gt; &#123;<br>          builder.parent(<span class="hljs-string">&quot;com.jianke&quot;</span>) <span class="hljs-comment">// 设置父包名</span><br>              .moduleName(<span class="hljs-string">&quot;dem&quot;</span>) <span class="hljs-comment">// 设置父包模块名</span><br>              .pathInfo(Collections.singletonMap(OutputFile.xml,<br>                  <span class="hljs-string">&quot;/Users/gaozhe/code/jianke-zhgd-backend/jianke-modules/jianke-dem/src/main/resources/mapper&quot;</span>)); <span class="hljs-comment">// 设置mapperXml生成路径</span><br>        &#125;)<br>        .strategyConfig(builder -&gt; &#123;<br>          builder.addInclude(<span class="hljs-string">&quot;dem_point&quot;</span>,<span class="hljs-string">&quot;dem_sensor&quot;</span>,<span class="hljs-string">&quot;dem_sensor_data&quot;</span>) <span class="hljs-comment">// 设置需要生成的表名</span><br>              .addTablePrefix(<span class="hljs-string">&quot;dem_&quot;</span>); <span class="hljs-comment">// 设置过滤表前缀</span><br>        &#125;)<br>        .templateEngine(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityTemplateEngine</span>()) <span class="hljs-comment">// 使用Freemarker引擎模板，默认的是Velocity引擎模板</span><br>        .execute();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">GeneratorCodeUtil</span> <span class="hljs-variable">util</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneratorCodeUtil</span>();<br>    util.generateCode();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>











<h2 id="三、knife4j"><a href="#三、knife4j" class="headerlink" title="三、knife4j"></a>三、knife4j</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--引入Knife4j的官方start包,Swagger2基于Springfox2.10.5项目--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-comment">&lt;!--使用Swagger2--&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>创建knife4j配置类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.ParameterBuilder;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.PathSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.schema.ModelRef;<br><span class="hljs-keyword">import</span> springfox.documentation.service.ApiInfo;<br><span class="hljs-keyword">import</span> springfox.documentation.service.Contact;<br><span class="hljs-keyword">import</span> springfox.documentation.service.Parameter;<br><span class="hljs-keyword">import</span> springfox.documentation.spi.DocumentationType;<br><span class="hljs-keyword">import</span> springfox.documentation.spring.web.plugins.Docket;<br><span class="hljs-keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2WebMvc;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> knife4j配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/05 6:26 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2WebMvc</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Knife4jConfiguration</span> &#123;<br>  <span class="hljs-meta">@Value(&quot;$&#123;swagger.enabled&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> swaggerEnabled;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">dockerBean</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//配置请求头参数</span><br>    <span class="hljs-type">ParameterBuilder</span> <span class="hljs-variable">ticketPar1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterBuilder</span>();<br>    ticketPar1.name(<span class="hljs-string">&quot;Authentication&quot;</span>).description(<span class="hljs-string">&quot;认证凭证&quot;</span>)<br>        .modelRef(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelRef</span>(<span class="hljs-string">&quot;string&quot;</span>)).parameterType(<span class="hljs-string">&quot;header&quot;</span>)<br>        .required(<span class="hljs-literal">false</span>)<br>        .defaultValue(<span class="hljs-string">&quot;&quot;</span>)<br>        .build();<br>    <span class="hljs-type">ParameterBuilder</span> <span class="hljs-variable">ticketPar2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterBuilder</span>();<br>    ticketPar2.name(<span class="hljs-string">&quot;Level&quot;</span>)<br>        .description(<span class="hljs-string">&quot;股份（集团） 1子公司(二级单位) 2分公司（三级单位） 3项目（工地&quot;</span>)<br>        .modelRef(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelRef</span>(<span class="hljs-string">&quot;int&quot;</span>)).parameterType(<span class="hljs-string">&quot;header&quot;</span>)<br>        .required(<span class="hljs-literal">false</span>)<br>        .defaultValue(<span class="hljs-string">&quot;&quot;</span>)<br>        .build();<br><br>    List&lt;Parameter&gt; pars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    pars.add(ticketPar1.build());<br>    pars.add(ticketPar2.build());<br><br>    <span class="hljs-comment">//指定使用Swagger2规范</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>        <span class="hljs-comment">//是否禁用</span><br>        .enable(swaggerEnabled)<br>        .apiInfo(apiInfo())<br>        <span class="hljs-comment">//分组名称</span><br>        .groupName(<span class="hljs-string">&quot;用户服务&quot;</span>)<br>        .select()<br>        <span class="hljs-comment">//这里指定Controller扫描包路径</span><br>        .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.gz.mall.controller&quot;</span>))<br>        .paths(PathSelectors.any())<br>        .build()<br>        <span class="hljs-comment">//这里指定请求头参数</span><br>        .globalOperationParameters(pars);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>        .title(<span class="hljs-string">&quot;xx系统服务restful api&quot;</span>)<br>        .description(<span class="hljs-string">&quot;xx系统接口文档&quot;</span>)<br>        <span class="hljs-comment">//服务条款网址</span><br>        .termsOfServiceUrl(<span class="hljs-string">&quot;http://localhost/&quot;</span>)<br>        .version(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>        .contact(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(<span class="hljs-string">&quot;高喆&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;373795878@qq.com&quot;</span>))<br>        .build();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>扫描包</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableSwagger2WebMvc</span><br><span class="hljs-meta">@ComponentScan(&quot;com.gz&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceVodApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ServiceVodApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><span style="color:red;">访问地址: <a href="http://localhost:xx/doc.html">http://localhost:xx/doc.html</a></span></p>
<blockquote>
<p>常用注解</p>
</blockquote>
<ol>
<li>在Controller上加@Api，用tags指定Controller名称</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/432628/1600596624981-c13fdbed-b671-4fbe-8f65-12945c463272.png?x-oss-process=image/resize,w_882,limit_0" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ol start="2">
<li><p>添加接口描述</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/432628/1600598957232-fbf1b3e2-f298-4a14-b5a7-fd5156285767.png?x-oss-process=image/resize,w_778,limit_0" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</li>
<li><p>隐藏某个Controller，可以使用@Api的hidden属性：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/432628/1600598710790-a573c284-cb65-47aa-b75e-8cb4cab9075d.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/432628/1600599017157-2f423acb-316c-4dd4-8c76-d9ffe45c2e85.png?x-oss-process=image/resize,w_796,limit_0" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ol start="4">
<li><span style="color:red;">传参说明@ApiImplicitParams：</span></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户名和年龄获取用户</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> age</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiImplicitParams(&#123;</span><br><span class="hljs-meta">        @ApiImplicitParam(name = &quot;name&quot;, value = &quot;名字&quot;, dataType = &quot;String&quot;, paramType = &quot;query&quot;, required = true),</span><br><span class="hljs-meta">        @ApiImplicitParam(name = &quot;age&quot;, value = &quot;年龄&quot;, dataType = &quot;Integer&quot;, paramType = &quot;query&quot;, required = true)</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-meta">@GetMapping(&quot;/getUserByNameAndAge&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">getUserByNameAndAge</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String name, <span class="hljs-meta">@RequestParam</span> Integer age)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;name:&#123;&#125;, age:&#123;&#125;&quot;</span>, name, age);<br>    <span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TkUserPojo</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>推荐大家点进@ApiImplicitParam看看，那几个属性很有用：</p>
<ul>
<li>name：参数名称,必须要和参数列表里的参数一致，不然无法解析或者格式不好看</li>
<li>value：对参数的描述</li>
<li>dataType：参数类型，默认String</li>
<li>paramType：告诉前端参数放哪，有header、query、path、body和form</li>
<li>required：告诉前端该参数是否必传</li>
<li>defaultValue：告诉前端如果这个参数不传的话，后端默认值是啥</li>
</ul>
<ol start="5">
<li>DTO封装参数</li>
</ol>
<p>如果是JSON请求，我们只能用DTO接收，此时推荐使用@ApiModel+@ApiModelProperty：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(&quot;用户DTO&quot;)</span><br><span class="hljs-meta">@Table(name = &quot;tk_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TkUserDTO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasePojo</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;id&quot;, dataType = &quot;Long&quot;, required = true)</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY, generator = &quot;SELECT LAST_INSERT_ID()&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;姓名&quot;, dataType = &quot;String&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;年龄&quot;, dataType = &quot;String&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;用户类型&quot;, dataType = &quot;Integer&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Integer userType;<br>  <br>  	<span class="hljs-meta">@Column(name = &quot;create_time&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;创建时间&quot;, dataType = &quot;Integer&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;update_time&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;修改时间&quot;, dataType = &quot;Integer&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@LogicDelete</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;是否删除&quot;, dataType = &quot;Integer&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Boolean deleted;<br><br>&#125;<br></code></pre></td></tr></table></figure>









<h2 id="四、EasyExcel"><a href="#四、EasyExcel" class="headerlink" title="四、EasyExcel"></a>四、EasyExcel</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easyexcel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br> <span class="hljs-comment">&lt;!-- 里面的cglib版本不兼容--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <br></code></pre></td></tr></table></figure>



<blockquote>
<p>读取excel</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"> 		<span class="hljs-comment">//读取文件</span><br>    <span class="hljs-comment">//创建ExcelReaderBuilder实例</span><br>    <span class="hljs-type">ExcelReaderBuilder</span> <span class="hljs-variable">readerBuilder</span> <span class="hljs-operator">=</span> EasyExcel.read();<br>    <span class="hljs-comment">//获取文件对象</span><br>    readerBuilder.file(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/管理员接入审核表格数据.xlsx&quot;</span>);<br>    <span class="hljs-comment">//指定sheet</span><br>    readerBuilder.sheet(<span class="hljs-string">&quot;管理员接入审核表格数据&quot;</span>);<br>    <span class="hljs-comment">//指定关闭输入流</span><br>    readerBuilder.autoCloseStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">//设置Excel文件格式</span><br>    readerBuilder.excelType(ExcelTypeEnum.XLSX);<br>    <span class="hljs-comment">//指定读取转化后的对象类型</span><br>    readerBuilder.head(TowerExcelObject.class);<br>    <span class="hljs-comment">//注册监听器进行数据解析</span><br>    readerBuilder.registerReadListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnalysisEventListener</span>&lt;TowerExcelObject&gt;() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(TowerExcelObject towerExcelObject, AnalysisContext analysisContext)</span> &#123;<br>        <span class="hljs-comment">//读取一行excel的回调</span><br>        System.out.println(towerExcelObject);<br>      &#125;<br><br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext analysisContext)</span> &#123;<br>        <span class="hljs-comment">//读取完毕的回调</span><br>        System.out.println(<span class="hljs-string">&quot;数据读取完毕.......&quot;</span>);<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">//构建读取器</span><br>    <span class="hljs-type">ExcelReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> readerBuilder.build();<br>    <span class="hljs-comment">//读取数据</span><br>    reader.readAll();<br>    <span class="hljs-comment">//读取完毕</span><br>    reader.finish();<br><br><br><br>==========================链式写法============================================================<br>EasyExcel.read(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/管理员接入审核表格数据.xlsx&quot;</span>).head(TowerExcelObject.class)<br>        .sheet().registerReadListener(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnalysisEventListener</span>&lt;TowerExcelObject&gt;() &#123;<br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(TowerExcelObject towerExcelObject, AnalysisContext analysisContext)</span> &#123;<br>            System.out.println(towerExcelObject);<br>          &#125;<br><br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext analysisContext)</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;数据读取完毕.......&quot;</span>);<br>          &#125;<br>        &#125;).doRead();<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TowerExcelObject</span> &#123;<br><br>  <span class="hljs-meta">@ExcelProperty(&quot;供应商&quot;)</span><br>  <span class="hljs-keyword">private</span> String supplierName;<br><br>  <span class="hljs-meta">@ExcelProperty(&quot;项目名称&quot;)</span><br>  <span class="hljs-keyword">private</span> String projectName;<br><br>  <span class="hljs-meta">@ExcelProperty(&quot;设备编号&quot;)</span><br>  <span class="hljs-keyword">private</span> String serialNumber;<br><br>  <span class="hljs-meta">@ExcelProperty(&quot;状态&quot;)</span><br>  <span class="hljs-keyword">private</span> String deviceStatusString;<br><br>  <span class="hljs-meta">@ExcelProperty(&quot;审核结果&quot;)</span><br>  <span class="hljs-keyword">private</span> String approvalStatusString;<br>&#125;<br></code></pre></td></tr></table></figure>











<h2 id="五、解决跨域问题"><a href="#五、解决跨域问题" class="headerlink" title="五、解决跨域问题"></a>五、解决跨域问题</h2><blockquote>
<p>后端解决跨域</p>
</blockquote>
<p>注意:</p>
<p>CorFilter &#x2F; WebMvConfigurer &#x2F; @CrossOrigin 需要 SpringMVC 4.2以上版本才支持，对应springBoot 1.3版本以上<br>上面前两种方式属于全局 CORS 配置，后两种属于局部 CORS配置。如果使用了局部跨域是会覆盖全局跨域的规则，所以可以通过 @CrossOrigin 注解来进行细粒度更高的跨域资源控制。<br>其实无论哪种方案，最终目的都是修改响应头，向响应头中添加浏览器所要求的数据，进而实现跨域</p>
<blockquote>
<p>跨域</p>
</blockquote>
<ol>
<li>使用CORS（跨域资源共享）</li>
</ol>
<p>它使用额外的 HTTP 头来告诉浏览器 让运行在一个 origin (domain) 上的Web应用被准许访问来自不同源服务器上的指定的资源。当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域 HTTP 请求。</p>
<p>当然要支持跨域访问，需要浏览器和后台服务器程序同时支持，如果这两个条件不能同时满足，则还是不能支持跨域访问</p>
<p>ps：要注意跨域访问的限制并不是说浏览器限制发送请求，而是浏览器阻止了请求后数据的加载渲染，因此浏览器跨域拦截流程大致如下：</p>
<p>跨域访问限制的流程</p>
<p>1、 浏览器发送跨域请求</p>
<p>2、 接收response数据</p>
<p>3、 检查响应头</p>
<p>（1）、如果响应头中没有允许跨域访问的配置，则不加载，并报出响应异常</p>
<p>（2）、如果响应头中有允许跨域访问的设置，正常加载数据</p>
<ol start="2">
<li>用于CORS中的Http的首部有如下几个：</li>
</ol>
<p>（1）响应头</p>
<ul>
<li><p>Access-Control-Allow-Origin: 允许跨域访问的域，可以是一个域的列表，也可以是通配符”*”；(从那个地址发起请求)</p>
</li>
<li><p>Access-Control-Allow-Methods: 允许使用的请求方法，以逗号隔开；</p>
</li>
<li><p>Access-Control-Allow-Headers: 允许自定义的头部，以逗号隔开，大小写不敏感；</p>
</li>
<li><p>Access-Control-Expose-Headers: 允许脚本访问的返回头，请求成功后，脚本可以在XMLHttpRequest中访问这些头的信息</p>
</li>
<li><p>Access-Control-Allow-Credentials: 是否允许请求带有验证信息，XMLHttpRequest请求的withCredentials标志设置为true时，认证通过，浏览器才将数据给脚本程序。</p>
</li>
<li><p>Access-Control-Max-Age: 缓存此次请求的秒数。在这个时间范围内，所有同类型的请求都将不再发送预检请求而是直接使用此次返回的头作为判断依据，非常有用，大幅优化请求次数；</p>
</li>
</ul>
<p>（2）请求头</p>
<ul>
<li><p>Origin: 普通的HTTP请求也会带有，在CORS中专门作为Origin信息供后端比对,表明来源域，要与响应头中的Access-Control-Allow-Origin相匹配才能进行跨域访问；</p>
</li>
<li><p>Access-Control-Request-Method: 将要进行跨域访问的请求方法，要与响应头中的Access-Control-Allow-Methods相匹配才能进行跨域访问；</p>
</li>
<li><p>Access-Control-Request-Headers: 自定义的头部，所有用setRequestHeader方法设置的头部都将会以逗号隔开的形式包含在这个头中，要与响应头中的Access-Control-Allow-Headers相匹配才能进行跨域访问</p>
</li>
</ul>
<p>全局配置：</p>
<ol>
<li>CorsFilter</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.CorsFilter;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 解决跨域配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/07/09 2:19 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfig</span> &#123;<br><br>  <span class="hljs-comment">// 当前跨域请求最大有效时长。这里默认1天</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">MAX_AGE</span> <span class="hljs-operator">=</span> <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> CorsFilter <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>    <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">corsConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>    corsConfiguration.addAllowedOrigin(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 1 设置访问源地址</span><br>    corsConfiguration.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 2 设置访问源请求头</span><br>    corsConfiguration.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 3 设置访问源请求方法</span><br>    corsConfiguration.setMaxAge(MAX_AGE);<br>    source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, corsConfiguration); <span class="hljs-comment">// 4 对接口配置跨域设置</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p> 2、实现WebMvcConfigurer里面的addCorsMappings方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">corsFilter1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span><span class="hljs-params">(CorsRegistry registry)</span> &#123;<br>        registry.addMapping(<span class="hljs-string">&quot;/**&quot;</span>)  <span class="hljs-comment">// 匹配所有的路径</span><br>                .allowCredentials(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 设置允许凭证</span><br>                .allowedHeaders(<span class="hljs-string">&quot;*&quot;</span>)   <span class="hljs-comment">// 设置请求头</span><br>                .allowedMethods(<span class="hljs-string">&quot;GET&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>,<span class="hljs-string">&quot;PUT&quot;</span>,<span class="hljs-string">&quot;DELETE&quot;</span>) <span class="hljs-comment">// 设置允许的方式</span><br>                .allowedOriginPatterns(<span class="hljs-string">&quot;*&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>网关：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">xxxxxx:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedHeaders:</span> <span class="hljs-string">&quot;*&quot;</span><br>      <br><br></code></pre></td></tr></table></figure>



<p>局部配置：</p>
<p>1.@CrossOrigin</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/t2&quot;)</span><br><span class="hljs-meta">@CrossOrigin</span><br><span class="hljs-keyword">public</span> Map <span class="hljs-title function_">t2</span><span class="hljs-params">()</span> &#123;<br>    HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setUsername(<span class="hljs-string">&quot;123456&quot;</span>);<br>    user.setPassword(<span class="hljs-string">&quot;程世玉&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;user&quot;</span>,user);<br><br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br><br><span class="hljs-comment">//也可以指定允许通过的ip</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 如果只是想部分接口跨域，且不想使用配置来管理的话，可以使用这种方式</span><br><span class="hljs-comment"> * 添加响应头解决跨域</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/user_2&quot;, method = RequestMethod.POST)</span><br><span class="hljs-meta">@CrossOrigin(origins = &quot;http://172.16.71.27:8080&quot;, maxAge = 3600)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser_2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long id)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">&quot;Booker&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;sdfsdkjf93hu8dvn&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//添加响应头解决跨域</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/user-1&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser_1</span><span class="hljs-params">(HttpServletResponse response )</span> &#123;<br><br>    <span class="hljs-comment">// 允许所有，不安全</span><br>    response.addHeader(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>    response.addHeader(<span class="hljs-string">&quot;Access-Control-Max-Age&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>);<br>    response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;Origin, X-Requested-With, Content-Type, Accept&quot;</span>);<br>    response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="hljs-string">&quot;GET, POST, PUT&quot;</span>);<br>    response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>);<br><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">&quot;Booker&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;sdfsdkjf93hu8dvn&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>









<h2 id="六、时间工具类"><a href="#六、时间工具类" class="headerlink" title="六、时间工具类"></a>六、时间工具类</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"> <span class="hljs-comment">&lt;!-- 日期工具栏依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>封装工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><span class="hljs-keyword">import</span> org.joda.time.DateTimeConstants;<br><span class="hljs-keyword">import</span> org.joda.time.Days;<br><span class="hljs-keyword">import</span> org.joda.time.LocalDate;<br><span class="hljs-keyword">import</span> org.joda.time.LocalTime;<br><span class="hljs-keyword">import</span> org.joda.time.format.DateTimeFormat;<br><span class="hljs-keyword">import</span> org.joda.time.format.DateTimeFormatter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 时间转化工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/07/10 12:18 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JodaTimeUtil</span> &#123;<br><br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PATTERN_STANDARD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PATTERN_DATE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PATTERN_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HH:mm:ss&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * date类型 -&gt; string类型</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">date2Str</span><span class="hljs-params">(Date date)</span> &#123;<br>    <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    <span class="hljs-keyword">return</span> dateTime.toString(PATTERN_STANDARD);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * date类型 -&gt; string类型</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> formatPattern</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">date2Str</span><span class="hljs-params">(Date date, String formatPattern)</span> &#123;<br>    <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    <span class="hljs-keyword">return</span> dateTime.toString(formatPattern);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * string类型 -&gt; date类型</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeStr</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">str2Date</span><span class="hljs-params">(String timeStr)</span> &#123;<br>    <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">dateTimeFormatter</span> <span class="hljs-operator">=</span> DateTimeFormat.forPattern(PATTERN_STANDARD);<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> dateTimeFormatter.parseDateTime(timeStr);<br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> year    年</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> month   月</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> day     日</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> hour    时</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> minute  分</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> seconds 秒</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> yyyy-MM-dd HH:mm:ss</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getAssignedDateTime</span><span class="hljs-params">(Integer year, Integer month, Integer day, Integer hour,</span><br><span class="hljs-params">      Integer minute, Integer seconds)</span> &#123;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(year, month, day, hour, minute, seconds);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_STANDARD);<br>    <span class="hljs-keyword">return</span> date;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定日期</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> year</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> month</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> day</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getAssignedDate</span><span class="hljs-params">(Integer year, Integer month, Integer day)</span> &#123;<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDate</span>(year, month, day);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_DATE);<br>    <span class="hljs-keyword">return</span> date;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> hour</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> minutes</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> seconds</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getAssignedTime</span><span class="hljs-params">(Integer hour, Integer minutes, Integer seconds)</span> &#123;<br>    <span class="hljs-type">LocalTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalTime</span>(hour, minutes, seconds);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_TIME);<br>    <span class="hljs-keyword">return</span> date;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断date日期是否过期(与当前时刻比较)</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeExpired</span><span class="hljs-params">(Date date)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">timeStr</span> <span class="hljs-operator">=</span> date2Str(date);<br>    <span class="hljs-keyword">return</span> isBeforeNow(timeStr);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断date日期是否过期(与当前时刻比较)</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeStr</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeExpired</span><span class="hljs-params">(String timeStr)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(timeStr)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> isBeforeNow(timeStr);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断timeStr是否在当前时刻之前</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeStr</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBeforeNow</span><span class="hljs-params">(String timeStr)</span> &#123;<br>    <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> DateTimeFormat.forPattern(PATTERN_STANDARD);<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> DateTime.parse(timeStr, format);<br>    <span class="hljs-keyword">return</span> dateTime.isBeforeNow();<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 加天数</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> days</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">plusDays</span><span class="hljs-params">(Date date, Integer days)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    days = <span class="hljs-literal">null</span> == days ? <span class="hljs-number">0</span> : days;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.plusDays(days);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 减天数</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> days</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">minusDays</span><span class="hljs-params">(Date date, Integer days)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    days = <span class="hljs-literal">null</span> == days ? <span class="hljs-number">0</span> : days;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.minusDays(days);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 加分钟</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> minutes</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">plusMinutes</span><span class="hljs-params">(Date date, Integer minutes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    minutes = <span class="hljs-literal">null</span> == minutes ? <span class="hljs-number">0</span> : minutes;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.plusMinutes(minutes);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 减分钟</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> minutes</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">minusMinutes</span><span class="hljs-params">(Date date, Integer minutes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    minutes = <span class="hljs-literal">null</span> == minutes ? <span class="hljs-number">0</span> : minutes;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.minusMinutes(minutes);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 加月份</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> months</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">plusMonths</span><span class="hljs-params">(Date date, Integer months)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    months = <span class="hljs-literal">null</span> == months ? <span class="hljs-number">0</span> : months;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.plusMonths(months);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 减月份</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> date</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> months</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">minusMonths</span><span class="hljs-params">(Date date, Integer months)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    months = <span class="hljs-literal">null</span> == months ? <span class="hljs-number">0</span> : months;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>    dateTime = dateTime.minusMonths(months);<br><br>    <span class="hljs-keyword">return</span> dateTime.toDate();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断target是否在开始和结束时间之间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> target</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> startTime</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBetween</span><span class="hljs-params">(Date target, Date startTime, Date endTime)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == target || <span class="hljs-literal">null</span> == startTime || <span class="hljs-literal">null</span> == endTime) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(target);<br>    <span class="hljs-keyword">return</span> dateTime.isAfter(startTime.getTime()) &amp;&amp; dateTime.isBefore(endTime.getTime());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取当前系统时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> yyyy-MM-dd HH:mm:ss</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCurrentDateTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_STANDARD);<br>    <span class="hljs-keyword">return</span> time;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取当前日期</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCurrentDate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_DATE);<br>    <span class="hljs-keyword">return</span> date;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取系统当前时间按照指定格式返回</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCurrentTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> dt.toString(PATTERN_TIME);<br>    <span class="hljs-keyword">return</span> time;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取当前是一周星期几</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getWeek</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dts</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">week</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">switch</span> (dts.getDayOfWeek()) &#123;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.SUNDAY:<br>        week = <span class="hljs-string">&quot;星期日&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">case</span> DateTimeConstants.MONDAY:<br>        week = <span class="hljs-string">&quot;星期一&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">case</span> DateTimeConstants.TUESDAY:<br>        week = <span class="hljs-string">&quot;星期二&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.WEDNESDAY:<br>        week = <span class="hljs-string">&quot;星期三&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.THURSDAY:<br>        week = <span class="hljs-string">&quot;星期四&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.FRIDAY:<br>        week = <span class="hljs-string">&quot;星期五&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.SATURDAY:<br>        week = <span class="hljs-string">&quot;星期六&quot;</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> week;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定时间是一周的星期几</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> year</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> month</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> day</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getWeek</span><span class="hljs-params">(Integer year, Integer month, Integer day)</span> &#123;<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">dts</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDate</span>(year, month, day);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">week</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">switch</span> (dts.getDayOfWeek()) &#123;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.SUNDAY:<br>        week = <span class="hljs-string">&quot;星期日&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.MONDAY:<br>        week = <span class="hljs-string">&quot;星期一&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.TUESDAY:<br>        week = <span class="hljs-string">&quot;星期二&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.WEDNESDAY:<br>        week = <span class="hljs-string">&quot;星期三&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.THURSDAY:<br>        week = <span class="hljs-string">&quot;星期四&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.FRIDAY:<br>        week = <span class="hljs-string">&quot;星期五&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DateTimeConstants.SATURDAY:<br>        week = <span class="hljs-string">&quot;星期六&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> week;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 计算两个时间相差多少天</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> startDate</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> endDate</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">diffDay</span><span class="hljs-params">(Date startDate, Date endDate)</span> &#123;<br>    <span class="hljs-keyword">if</span> (startDate == <span class="hljs-literal">null</span> || endDate == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(startDate);<br>    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dt2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(endDate);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">day</span> <span class="hljs-operator">=</span> Days.daysBetween(dt1, dt2).getDays();<br>    <span class="hljs-keyword">return</span> Math.abs(day);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>









<h2 id="七、统一返回值处理"><a href="#七、统一返回值处理" class="headerlink" title="七、统一返回值处理"></a>七、统一返回值处理</h2><blockquote>
<p>异常枚举类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通用错误枚举（不同类型的错误也可以拆成不同的Enum细分）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> sunting</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExceptionCodeEnum</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通用结果</span><br><span class="hljs-comment">     */</span><br>    ERROR(-<span class="hljs-number">1</span>, <span class="hljs-string">&quot;网络错误&quot;</span>),<br>    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;成功&quot;</span>),<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户登录</span><br><span class="hljs-comment">     */</span><br>    NEED_LOGIN(<span class="hljs-number">900</span>, <span class="hljs-string">&quot;用户未登录&quot;</span>),<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 参数校验</span><br><span class="hljs-comment">     */</span><br>    ERROR_PARAM(<span class="hljs-number">10000</span>, <span class="hljs-string">&quot;参数错误&quot;</span>),<br>    EMPTY_PARAM(<span class="hljs-number">10001</span>, <span class="hljs-string">&quot;参数为空&quot;</span>),<br>    ERROR_PARAM_LENGTH(<span class="hljs-number">10002</span>, <span class="hljs-string">&quot;参数长度错误&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;<br><br>    ExceptionCodeEnum(Integer code, String desc) &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.desc = desc;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Integer, ExceptionCodeEnum&gt; ENUM_CACHE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (ExceptionCodeEnum exceptionCodeEnum : ExceptionCodeEnum.values()) &#123;<br>            ENUM_CACHE.put(exceptionCodeEnum.code, exceptionCodeEnum);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">(Integer code)</span> &#123;<br>        <span class="hljs-keyword">return</span> Optional.ofNullable(ENUM_CACHE.get(code))<br>                .map(ExceptionCodeEnum::getDesc)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;invalid exception code!&quot;</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>自定义异常</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 业务异常</span><br><span class="hljs-comment"> * biz是business的缩写</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> sunting</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> ExceptionCodeEnum</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BizException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ExceptionCodeEnum error;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 构造器，有时我们需要将第三方异常转为自定义异常抛出，但又不想丢失原来的异常信息，此时可以传入cause</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> error</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BizException</span><span class="hljs-params">(ExceptionCodeEnum error, Throwable cause)</span> &#123;<br>        <span class="hljs-built_in">super</span>(cause);<br>        <span class="hljs-built_in">this</span>.error = error;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 构造器，只传入错误枚举</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> error</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BizException</span><span class="hljs-params">(ExceptionCodeEnum error)</span> &#123;<br>        <span class="hljs-built_in">this</span>.error = error;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>封装返回值</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 一般返回实体</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> sunting</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer code;<br>    <span class="hljs-keyword">private</span> String message;<br>    <span class="hljs-keyword">private</span> T data;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Result</span><span class="hljs-params">(Integer code, String message, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.message = message;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Result</span><span class="hljs-params">(Integer code, String message)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.message = message;<br>        <span class="hljs-built_in">this</span>.data = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 带数据成功返回</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(ExceptionCodeEnum.SUCCESS.getCode(), ExceptionCodeEnum.SUCCESS.getDesc(), data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 不带数据成功返回</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> success(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通用错误返回，传入指定的错误枚举</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exceptionCodeEnum</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(ExceptionCodeEnum exceptionCodeEnum)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(exceptionCodeEnum.getCode(), exceptionCodeEnum.getDesc());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通用错误返回，传入指定的错误枚举，但支持覆盖message</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exceptionCodeEnum</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(ExceptionCodeEnum exceptionCodeEnum, String msg)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(exceptionCodeEnum.getCode(), msg);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通用错误返回，只传入message</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String msg)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(ExceptionCodeEnum.ERROR.getCode(), msg);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>定义注解来对返回值处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CosmoController &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>定义注解来忽略对返回值处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> IgnoreCosmoResult &#123;<br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>对返回值处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 返回值统一处理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/07/27 1:52 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonResponseDataAdvice</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(MethodParameter methodParameter,</span><br><span class="hljs-params">      Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> &#123;<br>    <span class="hljs-comment">// 标注了@CosmoController，且类及方法上都没有标注@IgnoreCosmoResult的方法才进行包装</span><br>    <span class="hljs-keyword">return</span> methodParameter.getDeclaringClass().isAnnotationPresent(CosmoController.class)<br>        &amp;&amp; !methodParameter.getDeclaringClass().isAnnotationPresent(IgnoreCosmoResult.class)<br>        &amp;&amp; !methodParameter.getMethod().isAnnotationPresent(IgnoreCosmoResult.class);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">beforeBodyWrite</span><span class="hljs-params">(Object o,</span><br><span class="hljs-params">      MethodParameter methodParameter,</span><br><span class="hljs-params">      MediaType mediaType,</span><br><span class="hljs-params">      Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass,</span><br><span class="hljs-params">      ServerHttpRequest serverHttpRequest,</span><br><span class="hljs-params">      ServerHttpResponse serverHttpResponse)</span> &#123;<br>    <span class="hljs-comment">// 已经包装过的，不再重复包装</span><br>    <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> Result || o <span class="hljs-keyword">instanceof</span> Page) &#123;<br>      <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.success(o);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>分页对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> gaozhe</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> Page</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 分页对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021-03-10</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(&quot;新的分页对象&quot;)</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span>&lt;T&gt; &#123;<br>  <span class="hljs-meta">@ApiModelProperty(&quot;分页条数，默认10条&quot;)</span><br>  <span class="hljs-meta">@JsonProperty(&quot;page_size&quot;)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pageSize;<br><br>  <span class="hljs-meta">@ApiModelProperty(&quot;当前页数, 默认第一页&quot;)</span><br>  <span class="hljs-meta">@JsonProperty(&quot;page&quot;)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> currentPage;<br><br>  <span class="hljs-meta">@ApiModelProperty(value = &quot;总页数&quot;)</span><br>  <span class="hljs-meta">@JsonProperty(&quot;total&quot;)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalPage;<br><br>  <span class="hljs-meta">@ApiModelProperty(value = &quot;总条数&quot;)</span><br>  <span class="hljs-meta">@JsonProperty(&quot;count&quot;)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalRecords;<br><br>  <span class="hljs-meta">@ApiModelProperty(&quot;列表数据&quot;)</span><br>  <span class="hljs-meta">@JsonProperty(&quot;results&quot;)</span><br>  <span class="hljs-keyword">private</span> List&lt;T&gt; items;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Page</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Page</span><span class="hljs-params">(<span class="hljs-type">int</span> pageSize, <span class="hljs-type">int</span> currentPage, <span class="hljs-type">int</span> totalPage, <span class="hljs-type">int</span> totalRecords, List&lt;T&gt; items)</span> &#123;<br>    <span class="hljs-built_in">this</span>.pageSize = pageSize;<br>    <span class="hljs-built_in">this</span>.currentPage = currentPage;<br>    <span class="hljs-built_in">this</span>.totalPage = totalPage;<br>    <span class="hljs-built_in">this</span>.totalRecords = totalRecords;<br>    <span class="hljs-built_in">this</span>.items = items;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Page&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(<span class="hljs-type">int</span> pageSize, <span class="hljs-type">int</span> currentPage, <span class="hljs-type">int</span> totalPage, <span class="hljs-type">int</span> totalRecords,</span><br><span class="hljs-params">      List&lt;T&gt; items)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageSize, currentPage, totalPage, totalRecords, items);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Page&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(<span class="hljs-type">long</span> pageSize, <span class="hljs-type">long</span> currentPage, <span class="hljs-type">long</span> totalPage, <span class="hljs-type">long</span> totalRecords,</span><br><span class="hljs-params">      List&lt;T&gt; items)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;T&gt;((<span class="hljs-type">int</span>) pageSize, (<span class="hljs-type">int</span>) currentPage, (<span class="hljs-type">int</span>) totalPage, (<span class="hljs-type">int</span>) totalRecords,<br>        items);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h2 id="八、处理xml"><a href="#八、处理xml" class="headerlink" title="八、处理xml"></a>八、处理xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">content</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">webSite</span>&gt;</span>http://www.roadjava.com<span class="hljs-tag">&lt;/<span class="hljs-name">webSite</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">owner</span>&gt;</span>zhaodaowen<span class="hljs-tag">&lt;/<span class="hljs-name">owner</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">desc</span>&gt;</span>java视频教程、java项目<span class="hljs-tag">&lt;/<span class="hljs-name">desc</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">detail</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">videos</span> <span class="hljs-attr">desc</span>=<span class="hljs-string">&quot;视频列表&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;300&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xml视频教程&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">chapter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span>1.java操作xml相关技术概览<span class="hljs-tag">&lt;/<span class="hljs-name">chapter</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">chapter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span>2.dom读写xml<span class="hljs-tag">&lt;/<span class="hljs-name">chapter</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;299&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;httpclient视频教程&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">chapter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;14&quot;</span>&gt;</span>14.发送上传文件的post请求<span class="hljs-tag">&lt;/<span class="hljs-name">chapter</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">chapter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;15&quot;</span>&gt;</span>15.为何要绕过https安全认证<span class="hljs-tag">&lt;/<span class="hljs-name">chapter</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">chapter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;16&quot;</span>&gt;</span>16.httpclient连接池和通用工具类封装<span class="hljs-tag">&lt;/<span class="hljs-name">chapter</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">videos</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">projects</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">propject</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>学生成绩管理<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">propject</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">propject</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>坦克大战<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">propject</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">projects</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">detail</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">content</span>&gt;</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>dom</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用来获取id=1的chapter标签的文本</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// DocumentBuilder的工厂类，专门用来生成DocumentBuilder</span><br>        <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">dbf</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>        <span class="hljs-comment">// 用来构造Document</span><br>        <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">documentBuilder</span> <span class="hljs-operator">=</span> dbf.newDocumentBuilder();<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> documentBuilder.parse(<span class="hljs-string">&quot;E:\\tmp\\xml-demo\\src\\test\\resources\\msg.xml&quot;</span>);<br>        <span class="hljs-comment">// Document Node Element Attr Comment Text getElementsByTagName : w3c规范里的</span><br>        <span class="hljs-type">NodeList</span> <span class="hljs-variable">chapterList</span> <span class="hljs-operator">=</span> document.getElementsByTagName(<span class="hljs-string">&quot;chapter&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;共获取到:&quot;</span>+chapterList.getLength());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;i&lt;chapterList.getLength();i++) &#123;<br>            <span class="hljs-type">Element</span> <span class="hljs-variable">chapterEle</span> <span class="hljs-operator">=</span> (Element) chapterList.item(i);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> chapterEle.getAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(id)) &#123;<br>                System.out.println(chapterEle.getFirstChild().getNodeValue());<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 写一个xml</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWrite</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// DocumentBuilder的工厂类，专门用来生成DocumentBuilder</span><br>        <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">dbf</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>        <span class="hljs-comment">// 用来构造Document</span><br>        <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">documentBuilder</span> <span class="hljs-operator">=</span> dbf.newDocumentBuilder();<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> documentBuilder.newDocument();<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        &lt;content&gt;</span><br><span class="hljs-comment">            &lt;webSite&gt;http://www.roadjava.com&lt;/webSite&gt;</span><br><span class="hljs-comment">        &lt;/content&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 创建标签</span><br>        <span class="hljs-type">Element</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> document.createElement(<span class="hljs-string">&quot;content&quot;</span>);<br>        <span class="hljs-type">Element</span> <span class="hljs-variable">webSite</span> <span class="hljs-operator">=</span> document.createElement(<span class="hljs-string">&quot;webSite&quot;</span>);<br>        <span class="hljs-comment">// 设置值</span><br>        webSite.setTextContent(<span class="hljs-string">&quot;http://www.roadjava.com&quot;</span>);<br>        <span class="hljs-comment">// 设置关联层级关系</span><br>        content.appendChild(webSite);<br>        document.appendChild(content);<br><br>        <span class="hljs-comment">// 输出</span><br>        <span class="hljs-type">TransformerFactory</span> <span class="hljs-variable">transformerFactory</span> <span class="hljs-operator">=</span> TransformerFactory.newInstance();<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> transformerFactory.newTransformer();<br><br>        <span class="hljs-comment">// xmlSource:要输出的xml源</span><br>        <span class="hljs-type">DOMSource</span> <span class="hljs-variable">xmlSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMSource</span>(document);<br>        <span class="hljs-comment">// outputTarget:输出到哪里</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;E:\\tmp\\xml-demo\\src\\test\\resources\\msg2.xml&quot;</span>);<br>        <span class="hljs-type">StreamResult</span> <span class="hljs-variable">streamResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamResult</span>(fos);<br>        <span class="hljs-comment">// 设置一些transformer</span><br>        transformer.setOutputProperty(OutputKeys.ENCODING,<span class="hljs-string">&quot;utf-8&quot;</span>);<span class="hljs-comment">// 指定编码</span><br>        transformer.setOutputProperty(OutputKeys.INDENT,<span class="hljs-string">&quot;yes&quot;</span>);<span class="hljs-comment">// 美化输出</span><br>        transformer.transform(xmlSource,streamResult);<br>        fos.close();<br>    &#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>dom4j</p>
</blockquote>
<blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入dom4j依赖,还有一个groupId是dom4j,老版本 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dom4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dom4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>       <span class="hljs-type">SAXReader</span> <span class="hljs-variable">saxReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXReader</span>();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\tmp\\xml-demo\\src\\test\\resources\\msg.xml&quot;</span>;<br>       <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> saxReader.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path));<br>       <span class="hljs-comment">// 有了dom4j的文档对象，</span><br>       <span class="hljs-type">Element</span> <span class="hljs-variable">rootElement</span> <span class="hljs-operator">=</span> document.getRootElement(); <span class="hljs-comment">// 获取根节点</span><br>       System.out.println(rootElement);<br>       <span class="hljs-comment">// 获取节点rootElement所有的子节点</span><br>       Iterator&lt;Element&gt; elementIterator = rootElement.elementIterator();<br>       <span class="hljs-comment">// 获取单个的子节点</span><br>       <span class="hljs-type">Element</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> rootElement.element(<span class="hljs-string">&quot;detail&quot;</span>);<br>       <span class="hljs-type">Element</span> <span class="hljs-variable">videos</span> <span class="hljs-operator">=</span> detail.element(<span class="hljs-string">&quot;videos&quot;</span>);<br>       System.out.println(videos);<br>       <span class="hljs-comment">// 获取videos元素的desc属性值</span><br>       <span class="hljs-type">Attribute</span> <span class="hljs-variable">desc</span> <span class="hljs-operator">=</span> videos.attribute(<span class="hljs-string">&quot;desc&quot;</span>);<br>       System.out.println(desc.getValue());<br>       <span class="hljs-comment">// 也可以结合xpath来使用,比如：jaxen</span><br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    &lt;content&gt;</span><br><span class="hljs-comment">    &lt;webSite&gt;http://www.roadjava.com&lt;/webSite&gt;</span><br><span class="hljs-comment">    &lt;/content&gt;</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWrite</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>       <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> DocumentHelper.createDocument();<br>       <span class="hljs-comment">// 创建元素的时候关联的层级关系就确定了</span><br>       <span class="hljs-type">Element</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> document.addElement(<span class="hljs-string">&quot;content&quot;</span>);<br>       <span class="hljs-type">Element</span> <span class="hljs-variable">webSite</span> <span class="hljs-operator">=</span> content.addElement(<span class="hljs-string">&quot;webSite&quot;</span>);<br>       <span class="hljs-comment">// 设置文本内容</span><br>       webSite.addText(<span class="hljs-string">&quot;http://www.roadjava.com&quot;</span>);<br><br>       <span class="hljs-comment">// 输出</span><br>       <span class="hljs-type">OutputFormat</span> <span class="hljs-variable">outputFormat</span> <span class="hljs-operator">=</span> OutputFormat.createPrettyPrint();<br>       outputFormat.setEncoding(StandardCharsets.UTF_8.name());<br>       <span class="hljs-type">String</span> <span class="hljs-variable">outPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\tmp\\xml-demo\\src\\test\\resources\\msg2.xml&quot;</span>;<br>       <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(outPath);<br>       <span class="hljs-type">XMLWriter</span> <span class="hljs-variable">xmlWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLWriter</span>(fos,outputFormat);<br>       <span class="hljs-comment">// 把document对象的内容写到文件</span><br>       xmlWriter.write(document);<br>       fos.close();<br>   &#125;<br></code></pre></td></tr></table></figure>











<h2 id="九、druid数据源"><a href="#九、druid数据源" class="headerlink" title="九、druid数据源"></a>九、druid数据源</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>基本配置介绍</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://114.132.160.23:3306/ggkt_vod?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;seSSL=true&amp;serverTimezone=GMT%2B8&amp;allowMultiQueries=true</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">gaozhe741234</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>    <span class="hljs-attr">druid:</span><br>      <span class="hljs-comment"># druid配置</span><br>      <span class="hljs-comment"># 初始化时建立物理连接的个数</span><br>      <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>      <span class="hljs-comment"># 连接池包含连接的最大数量</span><br>      <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>      <span class="hljs-comment"># 单位:ms,获取连接时最大等待时间</span><br>      <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-comment"># 连接池包含连接的最小数量</span><br>      <span class="hljs-attr">minIdle:</span> <span class="hljs-number">1</span><br>      <span class="hljs-comment"># 申请连接时是否执行validationQuery的语句检测连接的有效性,影响性能</span><br>      <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-comment"># 归还连接时是否执行validationQuery的语句检测连接的有效性,影响性能</span><br>      <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br><br>      <span class="hljs-comment"># 避免db单方面关闭连接,如mysql:show variables like &#x27;%timeout%&#x27;,</span><br>      <span class="hljs-comment"># 关注interactive_timeout和wait_timeout, 默认8h</span><br>      <span class="hljs-comment"># 可能会出现mysql已经关闭</span><br>      <span class="hljs-comment"># 1.minEvictableIdleTimeMillis &lt; maxEvictableIdleTimeMillis</span><br>      <span class="hljs-comment"># 2.maxEvictableIdleTimeMillis + timeBetweenEvictionRunsMillis &lt; 8h（28800000）</span><br><br>      <span class="hljs-comment"># 单位:ms,连接保持空闲而不被驱逐的最小时间,默认30min.如果连接超过minIdle的数量，则关闭其他线程的时间</span><br>      <span class="hljs-comment"># 连接被destroy线程关闭条件: &gt;minIdle&amp;&amp;空闲时间&gt;1800000</span><br>      <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">1800000</span><br>      <span class="hljs-comment"># 单位:ms,连接保持空闲而不被驱逐的最大时间,默认7h</span><br>      <span class="hljs-comment"># 连接被destroy线程关闭条件: 空闲时间&gt;25200000.不管池子中的连接数是否&gt;minIdle，关闭所有线程的时间</span><br>      <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">25200000</span><br>      <span class="hljs-comment"># 单位:ms,默认1min,作用有两个:</span><br>      <span class="hljs-comment"># 1.Destroy线程运行周期,见minEvictableIdleTimeMillis和maxEvictableIdleTimeMillis</span><br>      <span class="hljs-comment"># 2.testWhileIdle使用,申请连接时，若空闲时间&gt;timeBetweenEvictionRunsMillis,</span><br>      <br>      <span class="hljs-comment">#   每次检测线程是否关闭的时间会去执行validationQuery检测连接是否有效.</span><br>      <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 检测连接是否有效的sql</span><br>      <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">select</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>







<blockquote>
<p>mysql关闭连接问题</p>
</blockquote>
<p>如果我们设置每30s mysql关闭连接</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx">[client]<br>default-character-<span class="hljs-attribute">set</span> = utf8mb4<br><br>[mysqld]<br>character_set_server = utf8mb4<br>collation_server = utf8mb4_bin<br>secure-file-priv= NULL<br>wait_timeout=<span class="hljs-number">30</span><br>interactive_timeout=<span class="hljs-number">30</span><br>symbolic-links=<span class="hljs-number">0</span><br><br>!includedir /etc/mysql/conf.d/                                                            <span class="hljs-number">25</span>,<span class="hljs-number">1</span>          All<br></code></pre></td></tr></table></figure>



<p>我们手动配置druid数据源 timeBetweenEvictionRunsMillis（每隔多少毫秒去检测一次连接是否断开）很大的值</p>
<p>等30s再去访问接口的时候会出现丢包的现象：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220720204039917.png" srcset="/img/loading.gif" lazyload alt="image-20220720204039917"></p>
<p>这是因为mysql30s已经关闭连接了，但是durid数据源没有检测出来，导致请求数据库导致丢包</p>
<p>所以我们在配置druid数据源的时候需要遵循：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx">1.<span class="hljs-attribute">minEvictableIdleTimeMillis</span> &lt; maxEvictableIdleTimeMillis<br><span class="hljs-number">2</span>.maxEvictableIdleTimeMillis + timeBetweenEvictionRunsMillis &lt; <span class="hljs-number">8h</span>（<span class="hljs-number">28800000</span>）<br></code></pre></td></tr></table></figure>







<blockquote>
<p>启动监控：定制sql监控规则</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定制sql监控规则:</span><br><span class="hljs-comment"> * https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> StatFilter <span class="hljs-title function_">statFilter</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">StatFilter</span> <span class="hljs-variable">statFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StatFilter</span>();<br>  <span class="hljs-comment">// 对未参数化的sql进行合并</span><br>  statFilter.setMergeSql(<span class="hljs-literal">true</span>);<br>  <span class="hljs-comment">// 单位:毫秒,慢的阈值</span><br>  statFilter.setSlowSqlMillis(<span class="hljs-number">3000</span>);<br>  <span class="hljs-keyword">return</span> statFilter;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>这个仅仅是配置了监控页面，真正的核心需要配置过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定制sql监控规则:</span><br><span class="hljs-comment"> * https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> StatFilter <span class="hljs-title function_">statFilter</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">StatFilter</span> <span class="hljs-variable">statFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StatFilter</span>();<br>  <span class="hljs-comment">// 对未参数化的sql进行合并</span><br>  statFilter.setMergeSql(<span class="hljs-literal">true</span>);<br>  <span class="hljs-comment">// 单位:毫秒,慢的阈值</span><br>  statFilter.setSlowSqlMillis(<span class="hljs-number">3000</span>);<br>  <span class="hljs-keyword">return</span> statFilter;<br>&#125;<br></code></pre></td></tr></table></figure>







<blockquote>
<p>作用：定制sql防火墙规则</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 配置参考: https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE-wallfilter</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> WallConfig <span class="hljs-title function_">wallConfig</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">WallConfig</span> <span class="hljs-variable">wallConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WallConfig</span>();<br>  wallConfig.setDeleteAllow(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> wallConfig;<br>&#125;<br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> WallFilter <span class="hljs-title function_">wallFilter</span><span class="hljs-params">(WallConfig wallConfig)</span> &#123;<br>  <span class="hljs-type">WallFilter</span> <span class="hljs-variable">wallFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WallFilter</span>();<br>  <span class="hljs-comment">// 避免DruidDataSource无法正确识别数据库的类型</span><br>  wallFilter.setDbType(DbType.mysql);<br>  wallFilter.setConfig(wallConfig);<br>  <span class="hljs-keyword">return</span> wallFilter;<br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>现成配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/review-manage</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">review-manage</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://36.134.190.128:33060/zhgd?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2b8&amp;useSSL=false&amp;allowMultiQueries=true</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">WePassW0rd@123</span><br>    <span class="hljs-attr">druid:</span><br>      <span class="hljs-attr">stat-view-servlet:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span><br>        <span class="hljs-attr">allow:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">,192.168.100.176</span><br>        <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">reset-enable:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">initial-size:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>      <span class="hljs-attr">min-evictable-idle-time-millis:</span> <span class="hljs-number">30000</span><br>      <span class="hljs-attr">max-evictable-idle-time-millis:</span> <span class="hljs-number">300000</span><br>      <span class="hljs-attr">time-between-eviction-runs-millis:</span> <span class="hljs-number">30000</span><br>      <span class="hljs-attr">pool-prepared-statements:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">max-pool-prepared-statement-per-connection-size:</span> <span class="hljs-number">20</span><br>      <span class="hljs-attr">filter:</span><br>        <span class="hljs-attr">wall:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">config:</span><br>            <span class="hljs-attr">multi-statement-allow:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">delete-allow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">stat:</span><br>          <span class="hljs-attr">log-slow-sql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">merge-sql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">slow-sql-millis:</span> <span class="hljs-number">3000</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">slf4j:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 保持长连接</span><br>      <span class="hljs-attr">keep-alive:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 2次keepAlive操作的时间间隔</span><br>      <span class="hljs-attr">keep-alive-between-time-millis:</span> <span class="hljs-number">600000</span><br>      <span class="hljs-comment"># 开启web监控（web应用、url监控）</span><br>      <span class="hljs-attr">web-stat-filter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/*</span><br>      <span class="hljs-attr">aop-patterns:</span> <span class="hljs-string">cn.com.scjky.*</span><br>      <br><span class="hljs-comment"># 配置mybatis-plus</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-comment"># 搜索指定包别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">cn.com.scjky.entity</span><br>  <span class="hljs-comment"># 配置mapper的扫描，找到所有的mapper.xml映射文件</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*Mapper.xml</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-comment">#配置返回数据库(column下划线命名&amp;&amp;返回java实体是驼峰命名)，自动匹配无需as（没开启这个，SQL需要写as： select user_id as userId）</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment">#配置JdbcTypeForNull, oracle数据库必须配置</span><br>    <span class="hljs-attr">jdbc-type-for-null:</span> <span class="hljs-string">&#x27;null&#x27;</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span> <span class="hljs-comment">#开启sql日志</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>配置详解</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">###########################Druid配置##########################</span><br><span class="hljs-comment">#####连接池属性spring.datasource.druid.xxx=</span><br><span class="hljs-comment">#启动连接池，默认开启</span><br><span class="hljs-attr">spring.datasource.druid.enable</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#使用Druid的数据库连接信息,我不建议使用此种 + 配置类，除非你对Druid特别熟悉</span><br><span class="hljs-attr">spring.datasource.druid.driver</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver#指定driver的类名，默认从jdbc url中自动探测</span><br><span class="hljs-attr">spring.datasource.druid.driver-class-name使用这个，不用spring.datasource.druid.driver</span><br><span class="hljs-attr">spring.datasource.druid.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.druid.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/my_springboot?serverTimezone=UTC</span><br><span class="hljs-attr">spring.datasource.druid.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.druid.password</span>=<span class="hljs-string">root</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#获取连接时最大等待时间，单位毫秒</span><br><span class="hljs-attr">spring.datasource.druid.max-wait</span>=<span class="hljs-string">10</span><br><span class="hljs-comment">##最大连接数</span><br><span class="hljs-attr">spring.datasource.druid.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-comment">##最小连接池数量</span><br><span class="hljs-attr">spring.datasource.druid.min-idle</span>=<span class="hljs-string">5</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#打开KeepAlive之后的效果</span><br><span class="hljs-comment">#1&gt;初始化连接池时会填充到minIdle数量。</span><br><span class="hljs-comment">#2&gt;连接池中的minIdle数量以内的连接，空闲时间超过minEvictableIdleTimeMillis，则会执行keepAlive操作。</span><br><span class="hljs-comment">#3&gt;当网络断开等原因产生的由ExceptionSorter检测出来的死连接被清除后，自动补充连接到minIdle数量。</span><br><span class="hljs-comment">#连接池中的minIdle数量以内的连接，空闲时间超过minEvictableIdleTimeMillis，则会执行keepAlive操作</span><br><span class="hljs-comment">#2次keepAlive操作的时间间隔</span><br><span class="hljs-attr">spring.datasource.druid.keep-alive-between-time-millis</span>=<span class="hljs-string">50000</span><br><span class="hljs-comment">#开启keepAlive操作</span><br><span class="hljs-attr">spring.datasource.druid.keep-alive</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">###打开PSCache，并指定每个连接上PSCache的大小。oracle设为true，mysql设为false。分库分表较多推荐设置为false</span><br><span class="hljs-attr">spring.datasource.druid.pool-prepared-statements</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.datasource.druid.max-pool-prepared-statement-per-connection-size</span>=<span class="hljs-string">30</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">####检测，验证</span><br><span class="hljs-comment">##归还连接时会执行validationQuery检测连接是否有效,开启会降低性能,默认为true</span><br><span class="hljs-comment">####如果你的数据库经常断，必须使用此配置，否则系统需要重启（如果数据库异常有短信这类通知，建议关闭）</span><br><span class="hljs-attr">spring.datasource.druid.test-on-return</span>=<span class="hljs-string">false</span><br><span class="hljs-comment">##用来检测连接是否有效的sql 必须是一个查询语句，spring.datasource.druid.test-on-return设置true才能用</span><br><span class="hljs-comment">##mysql、oracle中为 select 1 from dual，不知道为啥mysql，网上推荐SELECT &#x27;x&#x27;</span><br><span class="hljs-attr">spring.datasource.druid.validation-query</span>=<span class="hljs-string">select 1 from dual</span><br><span class="hljs-comment">##申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。</span><br><span class="hljs-attr">spring.datasource.druid.test-while-idle</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">## 当从连接池借用连接时，是否测试该连接,建议测试false</span><br><span class="hljs-attr">spring.datasource.druid.test-on-borrow</span>=<span class="hljs-string">false</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##既作为检测的间隔时间又作为testWhileIdel执行的依据即此值决定是否空闲，因此此值一定要设置合理</span><br><span class="hljs-comment">#即一个空闲线程，最大的生成时间。检测需要关闭的空闲连接</span><br><span class="hljs-attr">spring.datasource.druid.time-between-eviction-runs-millis</span>=<span class="hljs-string">60000</span><br><span class="hljs-comment">##销毁线程时检测当前连接的最后活动时间和当前时间差大于该值时，关闭当前连接即一个连接在池中最小生存的时间</span><br><span class="hljs-attr">spring.datasource.druid.min-evictable-idle-time-millis</span>=<span class="hljs-string">3000</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接变量。eg开启慢sql功能=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500</span><br><span class="hljs-comment">#spring.datasource.druid.connection-properties=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#合并多个DruidDataSource的监控数据</span><br><span class="hljs-comment">#spring.datasource.druid.use-global-data-source-stat=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##允许访问底层连接</span><br><span class="hljs-comment">#spring.datasource.druid.access-to-underlying-connection-allowed=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#活跃连接堆跟踪</span><br><span class="hljs-comment">#spring.datasource.druid.active-connection-stack-trace=List&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#活跃连接列表</span><br><span class="hljs-comment">#spring.datasource.druid.active-connections=Set&lt;DruidPooledConnection&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##启用异步关闭连接</span><br><span class="hljs-comment">#spring.datasource.druid.async-close-connection-enable=true</span><br><span class="hljs-comment">#开启异步初始化</span><br><span class="hljs-comment">#spring.datasource.druid.async-init=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#失败后跳过即用于失败重连，默认为false，true表示向数据库请求连接失败后,就算后端数据库恢复正常也不进行重连</span><br><span class="hljs-comment">#因此一定要配置false</span><br><span class="hljs-attr">spring.datasource.druid.break-after-acquire-failure</span>=<span class="hljs-string">false</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#检查执行sql执行时间</span><br><span class="hljs-attr">spring.datasource.druid.check-execute-time</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启动清除过滤器</span><br><span class="hljs-attr">spring.datasource.druid.clear-filters-enable</span>=<span class="hljs-string">false</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#连接出错尝试几次重新连接</span><br><span class="hljs-attr">spring.datasource.druid.connection-error-retry-attempts</span>=<span class="hljs-string">2</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">####连接初始化语句即写sql语句,连接后会自动执行，用于测试比较好</span><br><span class="hljs-comment">#spring.datasource.druid.connection-init-sqls=Collection&lt;String&gt;</span><br><span class="hljs-comment">#spring.datasource.druid.connection-init-sqls=update t_schedule  set status=0</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#创建定时器的连接池，跟数据库连接有关</span><br><span class="hljs-comment">#spring.datasource.druid.create-scheduler=java.util.concurrent.ScheduledExecutorService</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定db类型,eg:h2、mysq、oracle</span><br><span class="hljs-comment">#spring.datasource.druid.db-type=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定默认值：事务是否自动提交</span><br><span class="hljs-comment">#spring.datasource.druid.default-auto-commit=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接默认的catalog.</span><br><span class="hljs-comment">#spring.datasource.druid.default-catalog=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#是否设置默认连接只读.</span><br><span class="hljs-comment">#spring.datasource.druid.default-read-only=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接的事务的默认隔离级别.</span><br><span class="hljs-comment">#-1 数据库默认隔离级别</span><br><span class="hljs-comment">#1 未提交读</span><br><span class="hljs-comment">#2 读写提交</span><br><span class="hljs-comment">#4 可重复读</span><br><span class="hljs-comment">#8 串行化</span><br><span class="hljs-comment">#spring.datasource.druid.default-transaction-isolation=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定销毁的定时连接池</span><br><span class="hljs-comment">#spring.datasource.druid.destroy-scheduler=java.util.concurrent.ScheduledExecutorService</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##启用DUP关闭日志</span><br><span class="hljs-comment">#spring.datasource.druid.dup-close-log-enable=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#当数据库抛出不可恢复的异常时,抛弃该连接</span><br><span class="hljs-comment">#spring.datasource.druid.exception-sorter=com.alibaba.druid.pool.ExceptionSorter</span><br><span class="hljs-comment">#指定ExceptionSorter类名</span><br><span class="hljs-comment">#spring.datasource.druid.exception-sorter-class-name=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#当创建连接池时,创建失败后是否立即抛异常</span><br><span class="hljs-comment">#spring.datasource.druid.fail-fast=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#DruidStatProperties的aopPatterns字段即指定AOP模式</span><br><span class="hljs-comment">#spring.datasource.druid.aop-patterns=String[]</span><br><span class="hljs-comment">#Spring监控，对内部各接口调用的监控,参考Druid Github Wiki，配置_Druid和Spring关联监控配置</span><br><span class="hljs-comment">#spring.datasource.druid.aop-patterns=com.allen.service.*,com.allen.dao.*,com.allen.controller.*,com.allen.mapper.*</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">###连接池初始化</span><br><span class="hljs-comment">#开启线程初始化异常抛出异常</span><br><span class="hljs-comment">#spring.datasource.druid.init-exception-throw=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false #初始化全局变量</span><br><span class="hljs-comment">#spring.datasource.druid.init-global-variants=true</span><br><span class="hljs-comment">##初始化变量</span><br><span class="hljs-comment">#spring.datasource.druid.init-variants=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##初始化时建立物理连接的个数</span><br><span class="hljs-comment">#spring.datasource.druid.initial-size=10</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#socket连接超时时kil</span><br><span class="hljs-comment">#spring.datasource.druid.kill-when-socket-read-timeout=true</span><br><span class="hljs-comment">#记录丢失</span><br><span class="hljs-comment">#spring.datasource.druid.log-abandoned=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#记录不同的线程</span><br><span class="hljs-comment">#spring.datasource.druid.log-different-thread=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接数据库的超时时间</span><br><span class="hljs-comment">#spring.datasource.druid.login-timeout=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#最大创建任务数</span><br><span class="hljs-comment">#spring.datasource.druid.max-create-task-count=1000</span><br><span class="hljs-comment">##连接保持空闲而不被驱逐的最大时间.默认值1000L * 60L * 60L * 7,com.alibaba.druid.pool.DruidAbstractDataSource.maxEvictableIdleTimeMillis</span><br><span class="hljs-comment">#spring.datasource.druid.max-evictable-idle-time-millis=1000</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#最大打开的prepared-statement数量</span><br><span class="hljs-comment">#spring.datasource.druid.max-open-prepared-statements=1000</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#允许的最大线程等待数</span><br><span class="hljs-comment">#spring.datasource.druid.max-wait-thread-count=10</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接池名称</span><br><span class="hljs-comment">#spring.datasource.druid.name=String</span><br><span class="hljs-comment">#设置获取连接时的重试次数，-1为不重试</span><br><span class="hljs-comment">#spring.datasource.druid.not-full-timeout-retry-count=-1</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#????</span><br><span class="hljs-comment">#spring.datasource.druid.object-name=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#用于控制当OnFatalError发生时最大使用连接数量，用于控制异常发生时并发执行SQL的数量，减轻数据库恢复的压力。</span><br><span class="hljs-comment">#默认值 0</span><br><span class="hljs-comment">#spring.datasource.druid.on-fatal-error-max-active=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#是否是oracle数据库</span><br><span class="hljs-comment">#spring.datasource.druid.oracle=false</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#用于解决数据库密码加密处理方法</span><br><span class="hljs-comment">#public class AllenDbPasswordCallback extends DruidPasswordCallback &#123;</span><br><span class="hljs-comment">#   private static final Logger LOGGER = LoggerFactory.getLogger(DbPasswordCallback.class);</span><br><span class="hljs-comment">#   @Override</span><br><span class="hljs-comment">#  public void setProperties(Properties properties) &#123;</span><br><span class="hljs-comment">#       super.setProperties(properties);</span><br><span class="hljs-comment">#       真实环境,这2个值存数据库</span><br><span class="hljs-comment">#       String password = (String) properties.get(&quot;password&quot;);</span><br><span class="hljs-comment">#       String publickey = (String) properties.get(&quot;publickey&quot;);</span><br><span class="hljs-comment">#  try &#123;</span><br><span class="hljs-comment">#      String dbpassword = ConfigTools.decrypt(publickey, password);</span><br><span class="hljs-comment">#              setPassword(dbpassword.toCharArray());</span><br><span class="hljs-comment">#      &#125; catch (Exception e) &#123;</span><br><span class="hljs-comment">#        LOGGER.error(&quot;Druid ConfigTools.decrypt&quot;, e);</span><br><span class="hljs-comment">#      &#125;</span><br><span class="hljs-comment">#   &#125;</span><br><span class="hljs-comment">#&#125;</span><br><span class="hljs-comment">#spring.datasource.druid.password-callback=javax.security.auth.callback.PasswordCallback</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#物理最大连接数</span><br><span class="hljs-comment">#spring.datasource.druid.phy-max-use-count=1000</span><br><span class="hljs-comment">#物理超时</span><br><span class="hljs-comment">#spring.datasource.druid.phy-timeout-millis=Long</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#???</span><br><span class="hljs-comment">#spring.datasource.druid.pooling-connection-info=List&lt;Map&lt;String,Object&gt;&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定代理过滤器</span><br><span class="hljs-comment">#spring.datasource.druid.proxy-filters=List&lt;Filter&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#查询超时时间</span><br><span class="hljs-comment">#spring.datasource.druid.query-timeout=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定当连接超过废弃超时时间时，是否立刻删除该连接.</span><br><span class="hljs-comment">#spring.datasource.druid.remove-abandoned=true</span><br><span class="hljs-comment">#指定连接应该被废弃的时间.</span><br><span class="hljs-comment">#spring.datasource.druid.remove-abandoned-timeout=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#废弃连接超时指定时间的连接</span><br><span class="hljs-comment">#spring.datasource.druid.remove-abandoned-timeout-millis=Long</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启用重置统计信息</span><br><span class="hljs-comment">#spring.datasource.druid.reset-stat-enable=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#共享预处理语句</span><br><span class="hljs-comment">#spring.datasource.druid.share-prepared-statements=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定2次错误连接的最大时间间隔</span><br><span class="hljs-comment">#spring.datasource.druid.time-between-connect-error-millis=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#统计日志之间的时间</span><br><span class="hljs-comment">#spring.datasource.druid.time-between-log-stats-millis=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##事务查询超时时间</span><br><span class="hljs-comment">#spring.datasource.druid.transaction-query-timeout=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 事务时间阈值</span><br><span class="hljs-comment">#spring.datasource.druid.transaction-threshold-millis=Long</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#使用本地session是stat</span><br><span class="hljs-comment">#spring.datasource.druid.use-local-session-state=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 使用oracle隐式缓存</span><br><span class="hljs-comment">#spring.datasource.druid.use-oracle-implicit-cache=true</span><br><span class="hljs-comment"># 使用非公平锁</span><br><span class="hljs-comment">#spring.datasource.druid.use-unfair-lock=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.pool.DruidAbstractDataSource.userCallback</span><br><span class="hljs-comment">#spring.datasource.druid.user-callback=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定连接的有效检查类</span><br><span class="hljs-comment">#spring.datasource.druid.valid-connection-checker=com.alibaba.druid.pool.ValidConnectionChecker</span><br><span class="hljs-comment">#spring.datasource.druid.valid-connection-checker-class-name=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#单位：秒，检测连接是否有效的超时时间。底层调用jdbc Statement对象的void setQueryTimeout(int seconds)方法</span><br><span class="hljs-comment">#spring.datasource.druid.validation-query-timeout=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">################################filters#############################################</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 配置扩展插件：配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#x27;wall&#x27;用于防火墙</span><br><span class="hljs-attr">spring.datasource.druid.filters</span>=<span class="hljs-string">String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#sql无法统计时，去除wall</span><br><span class="hljs-attr">spring.datasource.druid.filters</span>=<span class="hljs-string">stat,wall,log4j,config</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#允许一次执行多条语句,与spring.datasource.druid.filters的wall值有关</span><br><span class="hljs-attr">wall是com.alibaba.druid.wall.WallFilter的简称，提供sql的检查和过滤等功能</span><br><span class="hljs-comment"># 默认对混合SQL进行拦截，此处为了执行大SQL,可关闭防火墙功能。</span><br><span class="hljs-comment">#如果需要开启wall监控，同时允许multiStatementAllow,就不要在application中配置filter。</span><br><span class="hljs-attr">spring.datasource.druid.filter.wall.config.multi-statement-allow</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">####开启慢sql</span><br><span class="hljs-comment">##合并sql，默认false</span><br><span class="hljs-attr">spring.datasource.druid.filter.stat.merge-sql</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.datasource.druid.filter.stat.log-slow-sql</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">##sql的执行时间超过1500毫秒就是慢sql</span><br><span class="hljs-attr">spring.datasource.druid.filter.stat.slow-sql-millis</span>=<span class="hljs-string">1500</span><br><span class="hljs-comment">####慢sql结束</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span><br><span class="hljs-comment">#spring.datasource.druid.connect-properties=Map&lt;String,String&gt;</span><br><span class="hljs-comment">#eg:开启慢sql的另一种方式</span><br><span class="hljs-attr">spring.datasource.druid.connect-properties.</span>=<span class="hljs-string">druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定过滤器名称</span><br><span class="hljs-comment">#spring.datasource.druid.filter-class-names=List&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启用Enable ConfigFilter</span><br><span class="hljs-comment">#spring.datasource.druid.filter.config.enabled=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启用EncodingConvertFilter</span><br><span class="hljs-comment">#spring.datasource.druid.filter.encoding.enabled=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#???</span><br><span class="hljs-comment">#spring.datasource.druid.sql-stat-map.=Map&lt;String,JdbcSqlStat&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#???</span><br><span class="hljs-comment">#spring.datasource.druid.stat-data.=Map&lt;String,Object&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#????</span><br><span class="hljs-comment">#spring.datasource.druid.stat-data-for-m-bean.=Map&lt;String,Object&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">##################################stat######################################</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启用</span><br><span class="hljs-comment">#spring.datasource.druid.filter.stat.enabled=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定stat的logger实现类</span><br><span class="hljs-comment">#spring.datasource.druid.stat-logger=com.alibaba.druid.pool.DruidDataSourceStatLogger</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定stat的数据库类型</span><br><span class="hljs-comment">#spring.datasource.druid.filter.stat.db-type=mysql</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#启动连接堆跟踪,com.alibaba.druid.filter.stat.StatFilter的connectionStackTraceEnable字段，默认false</span><br><span class="hljs-comment">#spring.datasource.druid.filter.stat.connection-stack-trace-enable=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">###############################stat-view-servlet#######################</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 白名单 ;com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties.StatViewServlet#allow</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.allow=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#黑名单</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.deny=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#开启</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.enabled=true</span><br><span class="hljs-comment">#登录密码</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.login-password=</span><br><span class="hljs-comment">#登录用户名</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.login-username=</span><br><span class="hljs-comment">#启用重置统计信息</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.reset-enable=String</span><br><span class="hljs-comment">##访问路径</span><br><span class="hljs-comment">#spring.datasource.druid.stat-view-servlet.url-pattern=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">###############################web-stat-filter#######################</span><br><span class="hljs-comment">#启用开关</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.enabled=true</span><br><span class="hljs-comment"># #排除URL  com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties.WebStatFilter</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.exclusions= *.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#身份标识 从session中获取spring.datasource.druid.web-stat-filter.principal-session-name=身份标识</span><br><span class="hljs-comment"># 从cookie中获取 例如cookie中存gk=xiaoming 设置属性为gk即可</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.principal-session-name=String</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.principal-cookie-name=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#配置profileEnable能够监控单个url调用的sql列表</span><br><span class="hljs-comment"># com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties.WebStatFilter.profileEnable</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.profile-enable=String true</span><br><span class="hljs-comment">#开关session统计功</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.session-stat-enable=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 默认sessionStatMaxCount是1000个，你也可以按需要进行配置</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.session-stat-max-count=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#statFilter的url模式，支持正则表达式</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.url-pattern=/*</span><br><span class="hljs-comment"># 排除一些不必要的url，比如.js,/jslib/等等</span><br><span class="hljs-comment">#spring.datasource.druid.web-stat-filter.exclusions=*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">###############################防火墙开始filter.wall###############################</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#开启Wall功能</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.enabled=true</span><br><span class="hljs-comment">#Map&lt;String,Object&gt;</span><br><span class="hljs-comment">#spring.datasource.druid.wall-stat-map.=allen=java.lang.String;gk=allen</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#是否允许执行Alter Table语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.alter-table-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#是否允许阻塞</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.block-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#是否允许通过jdbc的call语法调用存储过程</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.call-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.wall.WallConfig.caseConditionConstAllow</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.case-condition-const-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认false 是否允许语句中存在注释，Oracle的用户不用担心，Wall能够识别hints和注释的区别</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.comment-allow=true</span><br><span class="hljs-comment">#默认true 是否允许执行commit操作</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.commit-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 默认值：false   ？?</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.complete-insert-values-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值false。检查查询条件(WHERE/HAVING子句)中是否包含AND永假条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-and-alway-false-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值false：检查查询条件(WHERE/HAVING子句)中是否包含AND永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-and-alway-true-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值false 查询条件中是否允许连续两个常量运算表达式</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-double-const-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值true，检查查询条件(WHERE/HAVING子句)中是否包含LIKE永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-like-true-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值：true。查询条件中是否允许有&quot;&amp;&quot;、&quot;~&quot;、&quot;|&quot;、&quot;^&quot;运算符。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-op-bitwse-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值：false 查询条件中是否允许有XOR条件。XOR不常用，很难判断永真或者永假，缺省不允许。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.condition-op-xor-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值true。拦截常量运算的条件，比如说WHERE FID = 3 - 1，其中&quot;3 - 1&quot;是常量运算表达式。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.const-arithmetic-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值true，是否允许创建表</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.create-table-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值true，是否允许执行DELETE语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.delete-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认true，检查DELETE语句的WHERE子句是否是一个永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.delete-where-alway-true-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false，检查DELETE语句是否无where条件，这是有风险的，但不是SQL注入类型的风险</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.delete-where-none-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#???com.alibaba.druid.wall.WallConfig.denyFunctions</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.deny-functions=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.wall.WallConfig.denyObjects</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.deny-objects=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.wall.WallConfig.denySchemas</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.deny-schemas=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.wall.WallConfig.denyTables</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.deny-tables=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#com.alibaba.druid.wall.WallConfig.denyVariants</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.deny-variants=</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true 是否允许执行mysql的describe语句，缺省打开</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.describe-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#按照dbType分别配置: mysql : META-INF/druid/wall/mysql oracle : META-INF/druid/wall/oracle sqlserver : META-INF/druid/wall/sqlserver</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.dir=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false，特权允许</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.do-privileged-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true 是否允许修改表</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.drop-table-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，检测是否使用了禁用的函数</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.function-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.hint-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#？？？</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.inited=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，是否允许执行INSERT语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.insert-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值3</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.insert-values-check-size=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，是否允许SELECT FROM A INTERSECT SELECT FROM B这样的语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.intersect-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false，是否允许limit 0这样的语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.limit-zero-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，锁表允许</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.lock-table-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，是否允许执行MERGE语句，这个只在Oracle中有用</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.merge-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，是否允许调用Connection.getMetadata方法，这个方法调用会暴露数据库的表信息</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.metadata-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，是否允许SELECT FROM A MINUS SELECT FROM B这样的语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.minus-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false。是否必须参数化，如果为True，则不允许类似WHERE ID = 1这种不参数化的SQL</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.must-parameterized=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false。是否允许非以上基本语句的其他语句，缺省关闭，通过这个选项就能够屏蔽DDL。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.none-base-statement-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，检测是否使用了“禁用对对象”</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.object-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#???</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.permit-functions=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># 允许的schemas集合</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.permit-schemas=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#允许table名集合</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.permit-tables=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#允许变量集合</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.permit-variants=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#只允许读的表</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.read-only-tables=Set&lt;String&gt;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true。是否允许表重命名</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.rename-table-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true。是否允许执行REPLACE语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.replace-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true。是否允许执行roll back操作</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.rollback-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检测是否使用了禁用的Schema</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.schema-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"># ??? true,不允许执行select * from t，但select from (select id, name from t) a。</span><br><span class="hljs-comment"># 这个选项是防御程序通过调用select 获得数据表的结构信息。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-all-column-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检测SELECT EXCEPT</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-except-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检查SELECT语句的HAVING子句是否是一个永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-having-alway-true-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检测SELECT INTERSECT</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-intersect-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,SELECT查询中是否允许INTO字句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-into-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true.SELECT … INTO OUTFILE 是否允许，这个是mysql注入攻击的常见手段，缺省是禁止的</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-into-outfile-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认值-1；配置最大返回行数，如果select语句没有指定最大返回行数，会自动修改selct添加返回限制</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-limit=Integer</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，检测SELECT MINUS</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-minus-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true，检测SELECT union</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-union-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检查SELECT语句的WHERE子句是否是一个永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.select-where-alway-true-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,是否允许执行SELECT语句</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.selelct-allow=true</span><br><span class="hljs-comment">#true.是否允许使用SET语法</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.set-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true.是否允许执行mysql的show语句，缺省打开</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.show-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true.是否允许开启事务</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.start-transaction-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true, 是否进行严格的语法检测，</span><br><span class="hljs-comment"># Druid SQL Parser在某些场景不能覆盖所有的SQL语法，出现解析SQL出错，可以临时把这个选项设置为false，同时把SQL反馈给Druid的开发者。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.strict-syntax-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,检测是否使用了禁用的表</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.table-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#??</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.tenant-column=String</span><br><span class="hljs-comment">#???</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.tenant-table-pattern=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,truncate语句是危险，缺省打开，若需要自行关闭</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.truncate-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,是否允许update语法</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.update-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定UpdateCheck处理器</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.update-check-handler=com.alibaba.druid.wall.WallUpdateCheckHandler</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true.检查UPDATE语句的WHERE子句是否是一个永真条件</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.update-where-alay-true-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#false,检查UPDATE语句是否无where条件，这是有风险的，但不是SQL注入类型的风险</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.update-where-none-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,是否允许执行mysql的use语句，缺省打开</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.use-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true.检测是否使用了“禁用的变量”</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.variant-check=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,是否允许调用Connection/Statement/ResultSet的isWrapFor和unwrap方法，</span><br><span class="hljs-comment"># 这两个方法调用，使得有办法拿到原生驱动的对象，绕过WallFilter的检测直接执行SQL。</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config.wrap-allow=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定Wall的配置类，可以继承WallConfig类，然后指定即可</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.config=com.alibaba.druid.wall.WallConfig</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#指定数据库类型,mysql</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.db-type=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#默认false,对被认为是攻击的SQL进行LOG.error输出</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.log-violation=true</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#provider 白名单 ？？？</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.provider-white-list=Set&lt;String&gt;</span><br><span class="hljs-comment">#？？？</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.tenant-column=String</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#true,对被认为是攻击的SQL抛出SQLException</span><br><span class="hljs-comment">#spring.datasource.druid.filter.wall.throw-exception=true</span><br><span class="hljs-comment">###防火墙结束</span><br><br><br></code></pre></td></tr></table></figure>











<h2 id="十、fastjson"><a href="#十、fastjson" class="headerlink" title="十、fastjson"></a>十、fastjson</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>序列化</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * SerializeFilter定制处理，要求： 输出的json字符串的key是大写的</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsonSerializeFilter</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>    teacher.setName(<span class="hljs-string">&quot;gaozhe&quot;</span>);<br>    teacher.setId(<span class="hljs-number">1L</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * object：teacher对象</span><br><span class="hljs-comment">     * name：属性</span><br><span class="hljs-comment">     * value：name属性对应的值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">NameFilter</span> <span class="hljs-variable">nameFilter</span> <span class="hljs-operator">=</span> (object, name, value) -&gt; name.toUpperCase();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(teacher, nameFilter);<br>    System.out.println(json);<br><br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 测试fastjson的引用探测 $ref:对象中多次引用了同一个对象时，序列号就会出现$ref</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsonREFTest</span><span class="hljs-params">()</span> &#123;<br>    List&lt;Teacher&gt; teachers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>    teacher.setName(<span class="hljs-string">&quot;gaozhe&quot;</span>);<br>    teacher.setId(<span class="hljs-number">1L</span>);<br>    teachers.add(teacher);<br>    teachers.add(teacher);<br>    teachers.add(teacher);<br>    <span class="hljs-comment">//[&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;gaozhe&quot;,&quot;param&quot;:&#123;&#125;&#125;,&#123;&quot;$ref&quot;:&quot;$[0]&quot;&#125;,&#123;&quot;$ref&quot;:&quot;$[0]&quot;&#125;]</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(teachers);<br><br>    <span class="hljs-comment">//禁用引用探测</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json2</span> <span class="hljs-operator">=</span> JSON.toJSONString(teachers, SerializerFeature.DisableCircularReferenceDetect);<br>    System.out.println(json2);<br>  &#125;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsonTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>    teacher.setName(<span class="hljs-string">&quot;gaozhe&quot;</span>);<br>    teacher.setIntro(<span class="hljs-string">&quot;简介&quot;</span>);<br>    teacher.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    teacher.setJoinDate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    teacher.setCareer(<span class="hljs-string">&quot;cameerr&quot;</span>);<br>    <span class="hljs-comment">//实体类属性为null也转化</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(teacher, SerializerFeature.WRITE_MAP_NULL_FEATURES);<br>    <span class="hljs-comment">//美化json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json2</span> <span class="hljs-operator">=</span> JSON.toJSONString(teacher, SerializerFeature.PrettyFormat);<br>    System.out.println(json);<br>  &#125;<br></code></pre></td></tr></table></figure>







<blockquote>
<p>反序列号</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsonToObjectTest</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;createTime:1658328407924,updateTime:null,isDeleted:0,joinDate:1658328407924,level:0,intro:\&quot;简介\&quot;,career:\&quot;cameerr\&quot;,avatar:\&quot;\&quot;,sort:0,name:\&quot;gaozhe\&quot;,param:&#123;&#125;,id:0&#125;\n&quot;</span>;<br>   <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> JSON.parseObject(json, Teacher.class);<br><br>   System.out.println(teacher);<br> &#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>禁止字段序列化、反序列化</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@JSONField(serialize = false, deserialize = false)</span><br><span class="hljs-keyword">private</span> String name;<br></code></pre></td></tr></table></figure>





<h2 id="十一、权限管理"><a href="#十一、权限管理" class="headerlink" title="十一、权限管理"></a>十一、权限管理</h2><h3 id="非RBAC"><a href="#非RBAC" class="headerlink" title="非RBAC"></a>非RBAC</h3><blockquote>
<p>sql：t_user(增加user_type)</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for t_user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `t_user`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_user` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `user_type` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;4&#x27;</span> COMMENT <span class="hljs-string">&#x27;用户类型 1-管理员 2-教师 3-学生 4-游客&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  `deleted` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">3</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of t_user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `t_user` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;bravo1988&#x27;</span>, <span class="hljs-string">&#x27;123456&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2021-02-13 20:01:44&#x27;</span>, <span class="hljs-string">&#x27;2021-02-15 10:29:46&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `t_user` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;bravo&#x27;</span>, <span class="hljs-string">&#x27;123456&#x27;</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;2021-02-14 10:37:25&#x27;</span>, <span class="hljs-string">&#x27;2021-02-14 10:37:25&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>权限注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 登录权限注解</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LoginRequired &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 角色权限注解</span><br><span class="hljs-comment"> * 注意：由于默认权限都是针对用户而言，所以我在PermissionRequired上加了LoginRequired</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@LoginRequired</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PermissionRequired &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 角色，默认游客权限</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    UserType[] userType() <span class="hljs-keyword">default</span> &#123;UserType.VISITOR&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 逻辑关系，比如 ADMIN&amp;&amp;TEACHER 或者 ADMIN||TEACHER</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    Logical <span class="hljs-title function_">logical</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>枚举类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 当前设计不支持一个用户有多个角色，所以AND暂时用不到，而OR的作用更多的是提示当前逻辑是“符合其中一个角色即可”</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Logical</span> &#123;<br>    AND,<br>    OR;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户角色枚举</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UserType</span> &#123;<br>    ADMIN(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;管理员&quot;</span>),<br>    TEACHER(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;教师&quot;</span>),<br>    STUDENT(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;学生&quot;</span>),<br>    VISITOR(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;游客&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer value;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;<br><br>    UserType(Integer value, String desc) &#123;<br>        <span class="hljs-built_in">this</span>.value = value;<br>        <span class="hljs-built_in">this</span>.desc = desc;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否有权限</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userTypes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> typeOfUser</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> logical</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(UserType[] userTypes, Integer typeOfUser, Logical logical)</span> &#123;<br>        Objects.requireNonNull(userTypes);<br>        Objects.requireNonNull(logical);<br><br>        <span class="hljs-comment">// 1.1 要求单个角色权限，且当前用户刚好是这个角色</span><br>        <span class="hljs-keyword">if</span> (userTypes.length == <span class="hljs-number">1</span> &amp;&amp; userTypes[<span class="hljs-number">0</span>].getValue().equals(typeOfUser)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 1.2 要求多个角色权限</span><br>        <span class="hljs-keyword">if</span> (userTypes.length &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// AND：预留，当前设计其实不支持一个用户有多个角色</span><br>            <span class="hljs-keyword">if</span> (Logical.AND.equals(logical)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// OR：只要用户拥有其中一个角色即可</span><br>            <span class="hljs-keyword">if</span> (Logical.OR.equals(logical)) &#123;<br>                <span class="hljs-keyword">for</span> (UserType type : userTypes) &#123;<br>                    <span class="hljs-keyword">if</span> (type.getValue().equals(typeOfUser)) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>ThreadLocalUtil</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ThreadLocalUtil</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ThreadLocal的静态方法withInitial()会返回一个SuppliedThreadLocal对象</span><br><span class="hljs-comment">     * 而SuppliedThreadLocal&lt;T&gt; extends ThreadLocal&lt;T&gt;</span><br><span class="hljs-comment">     * 我们存进去的Map会作为的返回值：</span><br><span class="hljs-comment">     * protected T initialValue() &#123;</span><br><span class="hljs-comment">     *    return supplier.get();</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * 所以也相当于重写了initialValue()</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; THREAD_CONTEXT = ThreadLocal.withInitial(<br>            () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>)<br>    );<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据key获取value</span><br><span class="hljs-comment">     * 比如key为USER_INFO，则返回&quot;&#123;&#x27;name&#x27;:&#x27;bravo&#x27;, &#x27;age&#x27;:18&#125;&quot;</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;</span><br><span class="hljs-comment">     * .........&quot;USER_INFO&quot;:&quot;&#123;&#x27;name&#x27;:&#x27;bravo&#x27;, &#x27;age&#x27;:18&#125;&quot;,</span><br><span class="hljs-comment">     * .........&quot;SCORE&quot;:&quot;&#123;&#x27;Math&#x27;:99, &#x27;English&#x27;: 97&#125;&quot;</span><br><span class="hljs-comment">     * ...&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// getContextMap()表示要先获取THREAD_CONTEXT的value，也就是Map&lt;String, Object&gt;。然后再从Map&lt;String, Object&gt;中根据key获取</span><br>        <span class="hljs-keyword">return</span> THREAD_CONTEXT.get().get(key);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * put操作，原理同上</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>        THREAD_CONTEXT.get().put(key, value);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 清除map里的某个值</span><br><span class="hljs-comment">     * 比如把</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;</span><br><span class="hljs-comment">     * .........&quot;USER_INFO&quot;:&quot;&#123;&#x27;name&#x27;:&#x27;bravo&#x27;, &#x27;age&#x27;:18&#125;&quot;,</span><br><span class="hljs-comment">     * .........&quot;SCORE&quot;:&quot;&#123;&#x27;Math&#x27;:99, &#x27;English&#x27;: 97&#125;&quot;</span><br><span class="hljs-comment">     * ...&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     * 变成</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;</span><br><span class="hljs-comment">     * .........&quot;SCORE&quot;:&quot;&#123;&#x27;Math&#x27;:99, &#x27;English&#x27;: 97&#125;&quot;</span><br><span class="hljs-comment">     * ...&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">remove</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">return</span> THREAD_CONTEXT.get().remove(key);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 清除整个Map&lt;String, Object&gt;</span><br><span class="hljs-comment">     * 比如把</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;</span><br><span class="hljs-comment">     * .........&quot;USER_INFO&quot;:&quot;&#123;&#x27;name&#x27;:&#x27;bravo&#x27;, &#x27;age&#x27;:18&#125;&quot;,</span><br><span class="hljs-comment">     * .........&quot;SCORE&quot;:&quot;&#123;&#x27;Math&#x27;:99, &#x27;English&#x27;: 97&#125;&quot;</span><br><span class="hljs-comment">     * ...&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     * 变成</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>        THREAD_CONTEXT.get().clear();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从ThreadLocalMap中清除当前ThreadLocal存储的内容</span><br><span class="hljs-comment">     * 比如把</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * ...THREAD_CONTEXT: &#123;</span><br><span class="hljs-comment">     * .........&quot;USER_INFO&quot;:&quot;&#123;&#x27;name&#x27;:&#x27;bravo&#x27;, &#x27;age&#x27;:18&#125;&quot;,</span><br><span class="hljs-comment">     * .........&quot;SCORE&quot;:&quot;&#123;&#x27;Math&#x27;:99, &#x27;English&#x27;: 97&#125;&quot;</span><br><span class="hljs-comment">     * ...&#125;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     * 变成</span><br><span class="hljs-comment">     * &#123;</span><br><span class="hljs-comment">     * &#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearAll</span><span class="hljs-params">()</span> &#123;<br>        THREAD_CONTEXT.remove();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>权限拦截器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerInterceptorAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 不拦截跨域请求相关</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;OPTIONS&quot;</span>.equalsIgnoreCase(request.getMethod())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 如果方法上没有加@LoginRequired或@PermissionRequired（上面叠加了@LoginRequired），直接放行</span><br>        <span class="hljs-keyword">if</span> (isLoginFree(handler)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 登录校验</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> handleLogin(request, response);<br>        ThreadLocalUtil.put(WebConstant.USER_INFO, user);<br><br>        <span class="hljs-comment">// 权限校验</span><br>        checkPermission(user, handler);<br><br>        <span class="hljs-comment">// 放行到Controller</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.preHandle(request, response, handler);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 及时移除，避免ThreadLocal内存泄漏</span><br>        ThreadLocalUtil.remove(WebConstant.USER_INFO);<br>        <span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>    <br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 接口是否免登录（支持Controller上添加<span class="hljs-doctag">@LoginRequired</span>）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLoginFree</span><span class="hljs-params">(Object handler)</span> &#123;<br><br>        <span class="hljs-comment">// 判断是否支持免登录</span><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br><br>            <span class="hljs-comment">// 类上是否有@LoginRequired</span><br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br>            <span class="hljs-type">LoginRequired</span> <span class="hljs-variable">ControllerLogin</span> <span class="hljs-operator">=</span> AnnotationUtils.findAnnotation(controllerClazz, LoginRequired.class);<br><br>            <span class="hljs-comment">// 方法上是否有@LoginRequired</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            <span class="hljs-type">LoginRequired</span> <span class="hljs-variable">methodLogin</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(method, LoginRequired.class);<br><br>            <span class="hljs-keyword">return</span> ControllerLogin == <span class="hljs-literal">null</span> &amp;&amp; methodLogin == <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否需要权限认证（支持Controller上添加<span class="hljs-doctag">@PermissionRequired</span>）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPermissionFree</span><span class="hljs-params">(Object handler)</span> &#123;<br>        <span class="hljs-comment">// 判断是否需要权限认证</span><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            <span class="hljs-type">PermissionRequired</span> <span class="hljs-variable">controllerPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(controllerClazz, PermissionRequired.class);<br>            <span class="hljs-type">PermissionRequired</span> <span class="hljs-variable">methodPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(method, PermissionRequired.class);<br>            <span class="hljs-comment">// 没有加@PermissionRequired，不需要权限认证</span><br>            <span class="hljs-keyword">return</span> controllerPermission == <span class="hljs-literal">null</span> &amp;&amp; methodPermission == <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> User <span class="hljs-title function_">handleLogin</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">currentUser</span> <span class="hljs-operator">=</span> (User) session.getAttribute(WebConstant.CURRENT_USER_IN_SESSION);<br>        <span class="hljs-keyword">if</span> (currentUser == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 抛异常，请先登录</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.NEED_LOGIN);<br>        &#125;<br>        <span class="hljs-keyword">return</span> currentUser;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 权限校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkPermission</span><span class="hljs-params">(User user, Object handler)</span> &#123;<br>        <span class="hljs-comment">// 如果方法上没有加@PermissionRequired，直接放行</span><br>        <span class="hljs-keyword">if</span> (isPermissionFree(handler)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br><br>            <span class="hljs-type">PermissionRequired</span> <span class="hljs-variable">controllerPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.findAnnotation(controllerClazz, PermissionRequired.class);<br>            <span class="hljs-type">PermissionRequired</span> <span class="hljs-variable">methodPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(method, PermissionRequired.class);<br>            <span class="hljs-keyword">if</span> (hasPermission(controllerPermission, user.getUserType()) &amp;&amp; hasPermission(methodPermission, user.getUserType())) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 代码走到这，说明权限不匹配</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.PERMISSION_DENY);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(Annotation permissionAnnotation, Integer typeOfUser)</span> &#123;<br>        <span class="hljs-keyword">if</span> (permissionAnnotation == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        UserType[] userTypes = (UserType[]) AnnotationUtils.getValue(permissionAnnotation, <span class="hljs-string">&quot;userType&quot;</span>);<br>        <span class="hljs-type">Logical</span> <span class="hljs-variable">logical</span> <span class="hljs-operator">=</span> (Logical) AnnotationUtils.getValue(permissionAnnotation, <span class="hljs-string">&quot;logical&quot;</span>);<br>        <span class="hljs-comment">// 我把权限判断的逻辑封装到UserType枚举类中复用</span><br>        <span class="hljs-keyword">return</span> UserType.hasPermission(userTypes, typeOfUser, logical);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>







<blockquote>
<p>拦截器配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span><br>&#123;<br>    <span class="hljs-comment">/** 不需要拦截地址 */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] excludeUrls = &#123;&#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span><br>    &#123;<br>        registry.addInterceptor(loginInterceptor())<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>)<br>                <span class="hljs-comment">//.excludePathPatterns(excludeUrls)</span><br>                .order(-<span class="hljs-number">10</span>);<br>    &#125;<br>	<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LoginInterceptor <span class="hljs-title function_">loginInterceptor</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HttpSession session;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/register&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User userInfo)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> userMapper.insert(userInfo);<br>        <span class="hljs-keyword">if</span> (rows &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.success(userInfo);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;插入失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User loginInfo)</span> &#123;<br>        LambdaQueryWrapper&lt;User&gt; lambdaQuery = Wrappers.lambdaQuery();<br>        lambdaQuery.eq(User::getName, loginInfo.getName());<br>        lambdaQuery.eq(User::getPassword, loginInfo.getPassword());<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(lambdaQuery);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;用户名或密码错误&quot;</span>);<br>        &#125;<br><br>        session.setAttribute(WebConstant.CURRENT_USER_IN_SESSION, user);<br>        <span class="hljs-keyword">return</span> Result.success(user);<br>    &#125;<br><br>    <span class="hljs-meta">@LoginRequired</span><br>    <span class="hljs-meta">@GetMapping(&quot;/needLogin&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">needLogin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">&quot;if you see this, you are logged in.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/needNotLogin&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">needNotLogin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">&quot;if you see this, you are logged in.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PermissionRequired(userType = &#123;UserType.ADMIN,UserType.TEACHER&#125;, logical = Logical.OR)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/needPermission&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">needPermission</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">&quot;if you see this, you has the permission.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><blockquote>
<p>SQL</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_permission` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `<span class="hljs-keyword">method</span>` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  `deleted` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>通用常量</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConstant</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前登录的用户信息（Session）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CURRENT_USER_IN_SESSION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;current_user_in_session&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前登录的用户信息（ThreadLocal）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_INFO</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user_info&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前用户拥有的权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_PERMISSIONS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user_permissions&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>权限注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LoginRequired &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@LoginRequired</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RequiresPermission &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>Controller</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-comment">// 由于要查询用户权限，五张表都来了</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleMapper roleMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserRoleMapper userRoleMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RolePermissionMapper rolePermissionMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PermissionMapper permissionMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HttpSession session;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User loginInfo)</span> &#123;<br>        LambdaQueryWrapper&lt;User&gt; lambdaQuery = Wrappers.lambdaQuery();<br>        lambdaQuery.eq(User::getName, loginInfo.getName());<br>        lambdaQuery.eq(User::getPassword, loginInfo.getPassword());<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(lambdaQuery);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;用户名或密码错误&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 1.Session记录登录状态</span><br>        session.setAttribute(WebConstant.CURRENT_USER_IN_SESSION, user);<br>        <span class="hljs-comment">// 2.Session缓存用户拥有的权限</span><br>        session.setAttribute(WebConstant.USER_PERMISSIONS, getUserPermissions(user.getId()));<br><br>        <span class="hljs-keyword">return</span> Result.success(user);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getUserPermissions</span><span class="hljs-params">(Long uid)</span> &#123;<br>        <span class="hljs-comment">// 用户拥有的角色</span><br>        LambdaQueryWrapper&lt;UserRole&gt; userRoleQuery = Wrappers.lambdaQuery();<br>        userRoleQuery.eq(UserRole::getUserId, uid);<br>        List&lt;UserRole&gt; userRoles = userRoleMapper.selectList(userRoleQuery);<br>        List&lt;Long&gt; roleIds = ConvertUtil.resultToList(userRoles, UserRole::getRoleId);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(roleIds)) &#123;<br>            <span class="hljs-comment">// 没有角色，所有没有权限</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-comment">// 角色拥有的权限</span><br>        List&lt;Long&gt; permissionIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        rolePermissionMapper.selectBatchIds(roleIds);<br>        roleIds.forEach(roleId -&gt; &#123;<br>            LambdaQueryWrapper&lt;RolePermission&gt; rolePermissionQuery = Wrappers.lambdaQuery();<br>            rolePermissionQuery.eq(RolePermission::getRoleId, roleId);<br>            List&lt;RolePermission&gt; rolePermissions = rolePermissionMapper.selectList(rolePermissionQuery);<br>            permissionIds.addAll(ConvertUtil.resultToList(rolePermissions, RolePermission::getPermissionId));<br>        &#125;);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(permissionIds)) &#123;<br>            <span class="hljs-comment">// 角色都没有分配权限</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-comment">// 查询权限对应的method</span><br>        <span class="hljs-keyword">return</span> Optional.ofNullable(permissionMapper.selectBatchIds(permissionIds))<br>                .map(permissionList -&gt; permissionList.stream().map(Permission::getMethod).collect(Collectors.toSet()))<br>                .orElse(Collections.emptySet());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>拦截器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerInterceptorAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HttpSession session;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 不拦截跨域请求相关</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;OPTIONS&quot;</span>.equalsIgnoreCase(request.getMethod())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 如果类或方法上没有加@LoginRequired或@RequiredPermission（上面叠加了@LoginRequired），直接放行</span><br>        <span class="hljs-keyword">if</span> (isLoginFree(handler)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 登录校验，session里如果没有用户信息，就抛异常给globalExceptionHandler提示“需要登录”</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> handleLogin(request, response);<br>        ThreadLocalUtil.put(WebConstant.USER_INFO, user);<br><br>        <span class="hljs-comment">// 权限校验，校验不通过就抛异常，交给全局异常处理</span><br>        checkPermission(user, handler);<br><br>        <span class="hljs-comment">// 放行到Controller</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.preHandle(request, response, handler);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 及时移除，避免ThreadLocal内存泄漏</span><br>        ThreadLocalUtil.remove(WebConstant.USER_INFO);<br>        <span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 接口是否免登录（支持Controller上添加<span class="hljs-doctag">@LoginRequired</span>）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLoginFree</span><span class="hljs-params">(Object handler)</span> &#123;<br><br>        <span class="hljs-comment">// 判断是否支持免登录</span><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br><br>            <span class="hljs-comment">// 类上是否有@LoginRequired</span><br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br>            <span class="hljs-type">LoginRequired</span> <span class="hljs-variable">ControllerLogin</span> <span class="hljs-operator">=</span> AnnotationUtils.findAnnotation(controllerClazz, LoginRequired.class);<br><br>            <span class="hljs-comment">// 方法上是否有@LoginRequired</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            <span class="hljs-type">LoginRequired</span> <span class="hljs-variable">methodLogin</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(method, LoginRequired.class);<br><br>            <span class="hljs-keyword">return</span> ControllerLogin == <span class="hljs-literal">null</span> &amp;&amp; methodLogin == <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> User <span class="hljs-title function_">handleLogin</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">currentUser</span> <span class="hljs-operator">=</span> (User) session.getAttribute(WebConstant.CURRENT_USER_IN_SESSION);<br>        <span class="hljs-keyword">if</span> (currentUser == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 抛异常，请先登录</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.NEED_LOGIN);<br>        &#125;<br>        <span class="hljs-keyword">return</span> currentUser;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 权限校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkPermission</span><span class="hljs-params">(User user, Object handler)</span> &#123;<br>        <span class="hljs-comment">// 如果类和当前方法上都没有加@RequiresPermission，说明不需要权限校验，直接放行</span><br>        <span class="hljs-keyword">if</span> (isPermissionFree(handler)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br><br>            <span class="hljs-comment">// 代码走到这，已经很明确，当前方法需要权限才能访问，那么当前用户有没有权限呢？</span><br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Set&lt;String&gt; userPermissionMethods = (Set&lt;String&gt;) session.getAttribute(WebConstant.USER_PERMISSIONS);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">currentRequestMethod</span> <span class="hljs-operator">=</span> controllerClazz.getName() + <span class="hljs-string">&quot;#&quot;</span> + method.getName();<br>            <span class="hljs-keyword">if</span> (userPermissionMethods.contains(currentRequestMethod)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 当前访问的方法需要权限，但是当前用户不具备该权限</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.PERMISSION_DENY);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否需要权限校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPermissionFree</span><span class="hljs-params">(Object handler)</span> &#123;<br>        <span class="hljs-comment">// 判断是否需要权限认证</span><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            Class&lt;?&gt; controllerClazz = handlerMethod.getBeanType();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            <span class="hljs-type">RequiresPermission</span> <span class="hljs-variable">controllerPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(controllerClazz, RequiresPermission.class);<br>            <span class="hljs-type">RequiresPermission</span> <span class="hljs-variable">methodPermission</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(method, RequiresPermission.class);<br>            <span class="hljs-comment">// 没有加@RequiresPermission，不需要权限认证</span><br>            <span class="hljs-keyword">return</span> controllerPermission == <span class="hljs-literal">null</span> &amp;&amp; methodPermission == <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="十二、统一异常处理"><a href="#十二、统一异常处理" class="headerlink" title="十二、统一异常处理"></a>十二、统一异常处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestControllerAdvice(value = &quot;cn.com.scjky.controller&quot;,basePackageClasses = CustomErrorController.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResponseEntityExceptionHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GlobalExceptionHandler</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="hljs-title function_">handleExceptionInternal</span><span class="hljs-params">(Exception ex, <span class="hljs-meta">@Nullable</span> Object body, HttpHeaders headers, HttpStatus status, WebRequest request)</span> &#123;<br>        log.error(ex.getMessage(), ex);<br>        <span class="hljs-keyword">if</span> (!(body <span class="hljs-keyword">instanceof</span> ExceptionResponse)) &#123;<br>            body = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(ex.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.handleExceptionInternal(ex, body, headers, status, request);<br><br>    &#125;<br><br>    <span class="hljs-meta">@ExceptionHandler(&#123;ParameterException.class&#125;)</span><br>    <span class="hljs-meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br>    <span class="hljs-keyword">public</span> ExceptionResponse <span class="hljs-title function_">dealParameterException</span><span class="hljs-params">(ParameterException e)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(e.getMessage());<br>    &#125;<br><br>    <span class="hljs-meta">@ExceptionHandler(&#123;BusinessException.class&#125;)</span><br>    <span class="hljs-meta">@ResponseStatus(code = HttpStatus.INTERNAL_SERVER_ERROR)</span><br>    <span class="hljs-keyword">public</span> ExceptionResponse <span class="hljs-title function_">dealParameterException</span><span class="hljs-params">(BusinessException e)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(e.getMessage());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="hljs-title function_">handleMethodArgumentNotValid</span><span class="hljs-params">(MethodArgumentNotValidException e, HttpHeaders headers, HttpStatus status, WebRequest request)</span> &#123;<br>        <span class="hljs-type">FieldError</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldError();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s:%s&quot;</span>, error.getField(), error.getDefaultMessage());<br>        log.error(message);<br>        <span class="hljs-keyword">return</span> handleExceptionInternal(e, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(error.getDefaultMessage()), headers, status, request);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="hljs-title function_">handleBindException</span><span class="hljs-params">(BindException e, HttpHeaders headers, HttpStatus status, WebRequest request)</span> &#123;<br>        <span class="hljs-type">FieldError</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> e.getFieldError();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s:%s&quot;</span>, error.getField(), error.getDefaultMessage());<br>        log.error(message);<br>        <span class="hljs-keyword">return</span> handleExceptionInternal(e, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(error.getDefaultMessage()), headers, status, request);<br>    &#125;<br><br><br>    <span class="hljs-comment">//MissingServletRequestParameterException.class,</span><br>    <span class="hljs-meta">@ExceptionHandler(&#123;</span><br><span class="hljs-meta">            IllegalArgumentException.class&#125;)</span><br>    <span class="hljs-meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br>    <span class="hljs-keyword">public</span> ExceptionResponse <span class="hljs-title function_">dealParamException</span><span class="hljs-params">(Exception e)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(e.getMessage());<br>    &#125;<br><br><span class="hljs-comment">//    @ExceptionHandler(&#123;HttpMessageNotReadableException.class&#125;)</span><br><span class="hljs-comment">//    @ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br><span class="hljs-comment">//    public ExceptionResponse dealParamException(HttpMessageNotReadableException e) &#123;</span><br><span class="hljs-comment">//        log.error(e.getMessage(), e);</span><br><span class="hljs-comment">//        return new ExceptionResponse(e.getMessage());</span><br><span class="hljs-comment">//    &#125;</span><br><br><br><span class="hljs-comment">//    @ExceptionHandler(&#123;NoHandlerFoundException.class&#125;)</span><br><span class="hljs-comment">//    @ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br><span class="hljs-comment">//    public ExceptionResponse dealOtherException(NoHandlerFoundException e) &#123;</span><br><span class="hljs-comment">//        log.error(e.getMessage(), e);</span><br><span class="hljs-comment">//        return new ExceptionResponse(&quot;接口不存在&quot;);</span><br><span class="hljs-comment">//    &#125;</span><br><br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br>    <span class="hljs-keyword">public</span> ExceptionResponse <span class="hljs-title function_">dealOtherException</span><span class="hljs-params">(Exception e, HttpServletRequest request)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(e.getMessage());<br>    &#125;<br><br>    <span class="hljs-meta">@ExceptionHandler(RuntimeException.class)</span><br>    <span class="hljs-meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br>    <span class="hljs-keyword">public</span> ExceptionResponse <span class="hljs-title function_">dealOtherException</span><span class="hljs-params">(RuntimeException e, HttpServletRequest request)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionResponse</span>(e.getMessage());<br>    &#125;<br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    @ExceptionHandler(&#123;FileSizeLimitExceededException.class&#125;)</span><br><span class="hljs-comment">//    @ResponseStatus(code = HttpStatus.BAD_REQUEST)</span><br><span class="hljs-comment">//    public ExceptionResponse dealOtherException(FileSizeLimitExceededException e) &#123;</span><br><span class="hljs-comment">//        log.error(e.getMessage(), e);</span><br><span class="hljs-comment">//        return new ExceptionResponse(e.getMessage());</span><br><span class="hljs-comment">//    &#125;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>





<h2 id="十三、多数据源配置"><a href="#十三、多数据源配置" class="headerlink" title="十三、多数据源配置"></a>十三、多数据源配置</h2><blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/api/v1/</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">review-manage</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>    <span class="hljs-attr">druid:</span><br>      <span class="hljs-attr">stat-view-servlet:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span><br>        <span class="hljs-attr">allow:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">,192.168.100.176</span><br>        <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">reset-enable:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">filter:</span><br>        <span class="hljs-attr">wall:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">config:</span><br>            <span class="hljs-attr">multi-statement-allow:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">delete-allow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">stat:</span><br>          <span class="hljs-attr">log-slow-sql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">merge-sql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">slow-sql-millis:</span> <span class="hljs-number">3000</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">slf4j:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 2次keepAlive操作的时间间隔</span><br>      <span class="hljs-attr">keep-alive-between-time-millis:</span> <span class="hljs-number">600000</span><br>        <span class="hljs-comment"># 开启web监控（web应用、url监控）</span><br>      <span class="hljs-attr">web-stat-filter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/*</span><br>      <span class="hljs-attr">aop-patterns:</span> <span class="hljs-string">cn.com.scjky.*</span><br><br>    <span class="hljs-attr">dynamic:</span><br>      <span class="hljs-attr">druid:</span><br>        <span class="hljs-attr">initial-size:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 申请连接时是否执行validationQuery的语句检测连接的有效性,影响性能</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-comment"># 归还连接时是否执行validationQuery的语句检测连接的有效性,影响性能</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">min-evictable-idle-time-millis:</span> <span class="hljs-number">30000</span><br>        <span class="hljs-attr">max-evictable-idle-time-millis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-attr">time-between-eviction-runs-millis:</span> <span class="hljs-number">30000</span><br>        <span class="hljs-attr">pool-prepared-statements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">max-pool-prepared-statement-per-connection-size:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 保持长连接</span><br>        <span class="hljs-attr">keep-alive:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">break-after-acquire-failure:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">master:</span><br>          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://36.134.190.128:33060/zhgd?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2b8&amp;useSSL=false&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">WePassW0rd@123</span><br>        <span class="hljs-attr">slave:</span><br>          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://114.132.160.23:3306/demo?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2b8&amp;useSSL=false&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">gaozhe741234</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 主库数据源</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/08/03 9:22 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@DS(&quot;master&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Master &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/08/03 9:23 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@DS(&quot;slave&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Slave &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="十四、UUID工具类"><a href="#十四、UUID工具类" class="headerlink" title="十四、UUID工具类"></a>十四、UUID工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.time.Duration;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * UUid 4种类型的生成</span><br><span class="hljs-comment"> * copy from https://github.com/eugenp/tutorials/blob/master/core-java-modules/core-java-uuid/src/main/java/com/baeldung/uuid/UUIDGenerator.java</span><br><span class="hljs-comment"> * 参考 https://www.baeldung.com/java-uuid</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2022-05-24</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UUIDUtil</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] hexArray = <span class="hljs-string">&quot;0123456789ABCDEF&quot;</span>.toCharArray();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基于时间</span><br><span class="hljs-comment">     * Type 1 UUID Generation</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">generateType1UUID</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">most64SigBits</span> <span class="hljs-operator">=</span> get64MostSignificantBitsForVersion1();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">least64SigBits</span> <span class="hljs-operator">=</span> get64LeastSignificantBitsForVersion1();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UUID</span>(most64SigBits, least64SigBits);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">get64LeastSignificantBitsForVersion1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">random63BitLong</span> <span class="hljs-operator">=</span> random.nextLong() &amp; <span class="hljs-number">0x3FFFFFFFFFFFFFFFL</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">variant3BitFlag</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x8000000000000000L</span>;<br>        <span class="hljs-keyword">return</span> random63BitLong + variant3BitFlag;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">get64MostSignificantBitsForVersion1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">1582</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, LocalDateTime.now());<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seconds</span> <span class="hljs-operator">=</span> duration.getSeconds();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> duration.getNano();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">timeForUuidIn100Nanos</span> <span class="hljs-operator">=</span> seconds * <span class="hljs-number">10000000</span> + nanos * <span class="hljs-number">100</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">least12SignificatBitOfTime</span> <span class="hljs-operator">=</span> (timeForUuidIn100Nanos &amp; <span class="hljs-number">0x000000000000FFFFL</span>) &gt;&gt; <span class="hljs-number">4</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">12</span>;<br>        <span class="hljs-keyword">return</span> (timeForUuidIn100Nanos &amp; <span class="hljs-number">0xFFFFFFFFFFFF0000L</span>) + version + least12SignificatBitOfTime;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Type 3 UUID Generation</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> UnsupportedEncodingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">generateType3UUID</span><span class="hljs-params">(String namespace, String name)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br><br>        <span class="hljs-type">byte</span>[] nameSpaceBytes = bytesFromUUID(namespace);<br>        <span class="hljs-type">byte</span>[] nameBytes = name.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">byte</span>[] result = joinBytes(nameSpaceBytes, nameBytes);<br><br>        <span class="hljs-keyword">return</span> UUID.nameUUIDFromBytes(result);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Type 4 UUID Generation</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">generateType4UUID</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UUID</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.randomUUID();<br>        <span class="hljs-keyword">return</span> uuid;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Type 5 UUID Generation</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> UnsupportedEncodingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">generateType5UUID</span><span class="hljs-params">(String namespace, String name)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br><br>        <span class="hljs-type">byte</span>[] nameSpaceBytes = bytesFromUUID(namespace);<br>        <span class="hljs-type">byte</span>[] nameBytes = name.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">byte</span>[] result = joinBytes(nameSpaceBytes, nameBytes);<br><br>        <span class="hljs-keyword">return</span> type5UUIDFromBytes(result);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">type5UUIDFromBytes</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] name)</span> &#123;<br>        MessageDigest md;<br>        <span class="hljs-keyword">try</span> &#123;<br>            md = MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-1&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException nsae) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(<span class="hljs-string">&quot;SHA-1 not supported&quot;</span>, nsae);<br>        &#125;<br>        <span class="hljs-type">byte</span>[] bytes = Arrays.copyOfRange(md.digest(name), <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);<br>        bytes[<span class="hljs-number">6</span>] &amp;= <span class="hljs-number">0x0f</span>; <span class="hljs-comment">/* clear version        */</span><br>        bytes[<span class="hljs-number">6</span>] |= <span class="hljs-number">0x50</span>; <span class="hljs-comment">/* set to version 5     */</span><br>        bytes[<span class="hljs-number">8</span>] &amp;= <span class="hljs-number">0x3f</span>; <span class="hljs-comment">/* clear variant        */</span><br>        bytes[<span class="hljs-number">8</span>] |= <span class="hljs-number">0x80</span>; <span class="hljs-comment">/* set to IETF variant  */</span><br>        <span class="hljs-keyword">return</span> constructType5UUID(bytes);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">constructType5UUID</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">msb</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">lsb</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">assert</span> data.length == <span class="hljs-number">16</span> : <span class="hljs-string">&quot;data must be 16 bytes in length&quot;</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++)<br>            msb = (msb &lt;&lt; <span class="hljs-number">8</span>) | (data[i] &amp; <span class="hljs-number">0xff</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>            lsb = (lsb &lt;&lt; <span class="hljs-number">8</span>) | (data[i] &amp; <span class="hljs-number">0xff</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UUID</span>(msb, lsb);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Unique Keys Generation Using Message Digest and Type 4 UUID</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NoSuchAlgorithmException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> UnsupportedEncodingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateUniqueKeysWithUUIDAndMessageDigest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, UnsupportedEncodingException &#123;<br>        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-256&quot;</span>);<br>        salt.update(UUID.randomUUID()<br>                .toString()<br>                .getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">digest</span> <span class="hljs-operator">=</span> bytesToHex(salt.digest());<br>        <span class="hljs-keyword">return</span> digest;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>        <span class="hljs-type">char</span>[] hexChars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[bytes.length * <span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; bytes.length; j++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> bytes[j] &amp; <span class="hljs-number">0xFF</span>;<br>            hexChars[j * <span class="hljs-number">2</span>] = hexArray[v &gt;&gt;&gt; <span class="hljs-number">4</span>];<br>            hexChars[j * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>] = hexArray[v &amp; <span class="hljs-number">0x0F</span>];<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(hexChars);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] bytesFromUUID(String uuidHexString) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">normalizedUUIDHexString</span> <span class="hljs-operator">=</span> uuidHexString.replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-keyword">assert</span> normalizedUUIDHexString.length() == <span class="hljs-number">32</span>;<br><br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> hexToByte(normalizedUUIDHexString.substring(i * <span class="hljs-number">2</span>, i * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>));<br>            bytes[i] = b;<br>        &#125;<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span> <span class="hljs-title function_">hexToByte</span><span class="hljs-params">(String hexString)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">firstDigit</span> <span class="hljs-operator">=</span> Character.digit(hexString.charAt(<span class="hljs-number">0</span>), <span class="hljs-number">16</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">secondDigit</span> <span class="hljs-operator">=</span> Character.digit(hexString.charAt(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">byte</span>) ((firstDigit &lt;&lt; <span class="hljs-number">4</span>) + secondDigit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] joinBytes(<span class="hljs-type">byte</span>[] byteArray1, <span class="hljs-type">byte</span>[] byteArray2) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">finalLength</span> <span class="hljs-operator">=</span> byteArray1.length + byteArray2.length;<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[finalLength];<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; byteArray1.length; i++) &#123;<br>            result[i] = byteArray1[i];<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; byteArray2.length; i++) &#123;<br>            result[byteArray1.length + i] = byteArray2[i];<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UUID <span class="hljs-title function_">generateType5UUID</span><span class="hljs-params">(String name)</span> &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br><br>            <span class="hljs-type">byte</span>[] bytes = name.getBytes(StandardCharsets.UTF_8);<br>            <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-1&quot;</span>);<br><br>            <span class="hljs-type">byte</span>[] hash = md.digest(bytes);<br><br>            <span class="hljs-type">long</span> <span class="hljs-variable">msb</span> <span class="hljs-operator">=</span> getLeastAndMostSignificantBitsVersion5(hash, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">lsb</span> <span class="hljs-operator">=</span> getLeastAndMostSignificantBitsVersion5(hash, <span class="hljs-number">8</span>);<br>            <span class="hljs-comment">// Set the version field</span><br>            msb &amp;= ~(<span class="hljs-number">0xfL</span> &lt;&lt; <span class="hljs-number">12</span>);<br>            msb |= ((<span class="hljs-type">long</span>) <span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-number">12</span>;<br>            <span class="hljs-comment">// Set the variant field to 2</span><br>            lsb &amp;= ~(<span class="hljs-number">0x3L</span> &lt;&lt; <span class="hljs-number">62</span>);<br>            lsb |= <span class="hljs-number">2L</span> &lt;&lt; <span class="hljs-number">62</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UUID</span>(msb, lsb);<br><br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getLeastAndMostSignificantBitsVersion5</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] src, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> offset)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">ans</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> offset + <span class="hljs-number">7</span>; i &gt;= offset; i -= <span class="hljs-number">1</span>) &#123;<br>            ans &lt;&lt;= <span class="hljs-number">8</span>;<br>            ans |= src[i] &amp; <span class="hljs-number">0xffL</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h2 id="十五、返回前端时间格式"><a href="#十五、返回前端时间格式" class="headerlink" title="十五、返回前端时间格式"></a>十五、返回前端时间格式</h2><blockquote>
<p>全局返回json时间格式处理</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy/MM/dd</span> <span class="hljs-string">HH:mm:ss</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;<br><br><br><span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span><br>  <span class="hljs-keyword">private</span> Date approvalDate;<br></code></pre></td></tr></table></figure>







<h2 id="十六、MinIO文件上传"><a href="#十六、MinIO文件上传" class="headerlink" title="十六、MinIO文件上传"></a>十六、MinIO文件上传</h2><p>设置文件上传最大大小:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">tomcat:</span><br>    <span class="hljs-attr">uri-encoding:</span> <span class="hljs-string">UTF-8</span><br>    <span class="hljs-attr">max-swallow-size:</span> <span class="hljs-number">-1</span>  <span class="hljs-comment"># tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">multipart:</span><br>      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">1302MB</span>      <span class="hljs-comment"># 文件上传大小限制，设置最大值，不能超过该值，否则报错</span><br>      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">1302MB</span>     <span class="hljs-comment"># 文件最大请求限制，用于批量上传</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>docker安装Minio</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> run -d -p <span class="hljs-number">9000</span>:<span class="hljs-number">9000</span> -p <span class="hljs-number">50000</span>:<span class="hljs-number">50000</span> --name minio \<br> -e <span class="hljs-string">&quot;MINIO_ROOT_USER=admin&quot;</span> \<br> -e <span class="hljs-string">&quot;MINIO_ROOT_PASSWORD=12345678&quot;</span> \<br> -v /mnt/data:/data \<br> -v /mnt/config:/root/.minio \<br> minio/minio server --console-address <span class="hljs-string">&quot;:50000&quot;</span> /data<br></code></pre></td></tr></table></figure>

<p>50000暴露console端口，9000暴露Api端口</p>
<blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>MinIOConfig配置类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.gz.demoproject.utils.MinIOUtils;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOConfig</span> &#123;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String endpoint;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.fileHost&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String fileHost;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.bucketName&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String bucketName;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String accessKey;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String secretKey;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.imgSize&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> Integer imgSize;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.fileSize&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> Integer fileSize;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 每次容器启动时创建MinIO客户端</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">creatMinioClient</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!endpoint.startsWith(<span class="hljs-string">&quot;http&quot;</span>)) &#123;<br>      endpoint = <span class="hljs-string">&quot;http://&quot;</span> + endpoint;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!endpoint.endsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>      endpoint = endpoint.concat(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br>    MinIOUtils.setAccessKey(accessKey);<br>    MinIOUtils.setBucketName(bucketName);<br>    MinIOUtils.setEndpoint(endpoint);<br>    MinIOUtils.setSecretKey(secretKey);<br>    MinIOUtils.setFileSize(fileSize);<br>    MinIOUtils.setImgSize(imgSize);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>yaml配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># MinIO 配置</span><br><span class="hljs-attr">minio:</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://114.132.160.23:9000/</span>      <span class="hljs-comment"># MinIO服务api地址</span><br>  <span class="hljs-attr">fileHost:</span> <span class="hljs-string">http://114.132.160.23:9000/</span>      <span class="hljs-comment"># 文件地址host</span><br>  <span class="hljs-attr">bucketName:</span> <span class="hljs-string">gz-bucket</span>                      <span class="hljs-comment"># 存储桶bucket名称</span><br>  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">admin</span>                           <span class="hljs-comment"># 用户名</span><br>  <span class="hljs-attr">secretKey:</span> <span class="hljs-number">12345678</span>                        <span class="hljs-comment"># 密码</span><br>  <span class="hljs-attr">imgSize:</span> <span class="hljs-number">1024</span>                              <span class="hljs-comment"># 图片大小限制，单位：m</span><br>  <span class="hljs-attr">fileSize:</span> <span class="hljs-number">1024</span>                             <span class="hljs-comment"># 文件大小限制，单位：m</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>minio工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.minio.BucketExistsArgs;<br><span class="hljs-keyword">import</span> io.minio.CopyObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.CopySource;<br><span class="hljs-keyword">import</span> io.minio.GetBucketPolicyArgs;<br><span class="hljs-keyword">import</span> io.minio.GetObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.GetPresignedObjectUrlArgs;<br><span class="hljs-keyword">import</span> io.minio.ListObjectsArgs;<br><span class="hljs-keyword">import</span> io.minio.MakeBucketArgs;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.ObjectStat;<br><span class="hljs-keyword">import</span> io.minio.ObjectWriteResponse;<br><span class="hljs-keyword">import</span> io.minio.PutObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.RemoveBucketArgs;<br><span class="hljs-keyword">import</span> io.minio.RemoveObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.Result;<br><span class="hljs-keyword">import</span> io.minio.StatObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.UploadObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.http.Method;<br><span class="hljs-keyword">import</span> io.minio.messages.Bucket;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteObject;<br><span class="hljs-keyword">import</span> io.minio.messages.Item;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;<br><span class="hljs-keyword">import</span> java.net.URLDecoder;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * MinIO工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOUtils</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * minio客户端</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MinioClient minioClient;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String endpoint;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String bucketName;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String accessKey;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String secretKey;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Integer imgSize;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Integer fileSize;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMinioClient</span><span class="hljs-params">(MinioClient minioClient)</span> &#123;<br>    MinIOUtils.minioClient = minioClient;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEndpoint</span><span class="hljs-params">(String endpoint)</span> &#123;<br>    MinIOUtils.endpoint = endpoint;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBucketName</span><span class="hljs-params">(String bucketName)</span> &#123;<br>    MinIOUtils.bucketName = bucketName;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccessKey</span><span class="hljs-params">(String accessKey)</span> &#123;<br>    MinIOUtils.accessKey = accessKey;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSecretKey</span><span class="hljs-params">(String secretKey)</span> &#123;<br>    MinIOUtils.secretKey = secretKey;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setImgSize</span><span class="hljs-params">(Integer imgSize)</span> &#123;<br>    MinIOUtils.imgSize = imgSize;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFileSize</span><span class="hljs-params">(Integer fileSize)</span> &#123;<br>    MinIOUtils.fileSize = fileSize;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SEPARATOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MinIOUtils</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MinIOUtils</span><span class="hljs-params">(String endpoint, String bucketName, String accessKey, String secretKey,</span><br><span class="hljs-params">      Integer imgSize, Integer fileSize)</span> &#123;<br>    MinIOUtils.endpoint = endpoint;<br>    MinIOUtils.bucketName = bucketName;<br>    MinIOUtils.accessKey = accessKey;<br>    MinIOUtils.secretKey = secretKey;<br>    MinIOUtils.imgSize = imgSize;<br>    MinIOUtils.fileSize = fileSize;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建基于Java端的MinioClient</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initMinioClient</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == minioClient) &#123;<br>        log.info(<span class="hljs-string">&quot;开始创建 MinioClient...&quot;</span>);<br>        minioClient = MinioClient<br>            .builder()<br>            .endpoint(endpoint)<br>            .credentials(accessKey, secretKey)<br>            .build();<br><br>        <span class="hljs-comment">//如果不存在bucket则创建</span><br>        createBucket(bucketName);<br>        log.info(<span class="hljs-string">&quot;创建完毕 MinioClient...&quot;</span>);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(<span class="hljs-string">&quot;MinIO服务器异常：&#123;&#125;&quot;</span>, e.getMessage());<br>    &#125;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取文件流</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 二进制流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title function_">getObjectInputStream</span><span class="hljs-params">(String bucketName, String objectName)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    initMinioClient();<br>    <span class="hljs-keyword">return</span> minioClient<br>        .getObject(GetObjectArgs.builder().bucket(bucketName).object(objectName).build());<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 下载文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName 文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> response 响应流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">downLoad</span><span class="hljs-params">(String fileName, HttpServletResponse response)</span> &#123;<br>    initMinioClient();<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">ObjectStat</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> minioClient<br>          .statObject(StatObjectArgs.builder().bucket(bucketName).object(fileName).build());<br>      response.setContentType(stat.contentType());<br>      response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>,<br>          <span class="hljs-string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(fileName, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>      in = minioClient<br>          .getObject(GetObjectArgs.builder().bucket(bucketName).object(fileName).build());<br>      IOUtils.copy(in, response.getOutputStream());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(<span class="hljs-string">&quot;文件下载失败:&#123;&#125;&quot;</span>, e.getMessage());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          in.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>          log.error(e.getMessage());<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 断点下载</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> offset     起始字节的位置</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> length     要读取的长度</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 二进制流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">downLoadFileSlice</span><span class="hljs-params">(String bucketName, String objectName, <span class="hljs-type">long</span> offset,</span><br><span class="hljs-params">      <span class="hljs-type">long</span> length)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.getObject(<br>        GetObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .offset(offset)<br>            .length(length)<br>            .build());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file 文件上传</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 上传文件url</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(MultipartFile file)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">file_url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      initMinioClient();<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> file.getInputStream();<br>      <span class="hljs-comment">// 获取文件名</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">orgName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>      <span class="hljs-keyword">if</span> (StringUtils.isBlank(orgName)) &#123;<br>        orgName = file.getName();<br>      &#125;<br>      orgName = getFileName(orgName);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> (!orgName.contains(<span class="hljs-string">&quot;.&quot;</span>)<br>          ? orgName + <span class="hljs-string">&quot;_&quot;</span> + System.currentTimeMillis()<br>          : orgName.substring(<span class="hljs-number">0</span>, orgName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)) + <span class="hljs-string">&quot;_&quot;</span> + System.currentTimeMillis()<br>              + orgName.substring(orgName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>))<br>      );<br><br>      <span class="hljs-comment">// 使用putObject上传一个本地文件到存储桶中。</span><br>      <span class="hljs-keyword">if</span> (objectName.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        objectName = objectName.substring(<span class="hljs-number">1</span>);<br>      &#125;<br>      <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">objectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder().object(objectName)<br>          .bucket(bucketName)<br>          .contentType(file.getContentType())<br>          .stream(stream, stream.available(), -<span class="hljs-number">1</span>).build();<br>      minioClient.putObject(objectArgs);<br>      stream.close();<br>      file_url = getBasisUrl() + objectName;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(e.getMessage(), e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> file_url;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传本地文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 对象名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName   本地文件路径</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ObjectWriteResponse <span class="hljs-title function_">uploadLocalFile</span><span class="hljs-params">(String objectName, String fileName)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.uploadObject(<br>        UploadObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .filename(fileName)<br>            .build());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 通过流上传文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName  文件对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> inputStream 文件流</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件url</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(String objectName, InputStream inputStream)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    minioClient.putObject(<br>        PutObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .stream(inputStream, inputStream.available(), -<span class="hljs-number">1</span>)<br>            .build());<br>    <span class="hljs-keyword">return</span> getBasisUrl() + objectName;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建文件夹或目录</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 目录路径</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ObjectWriteResponse <span class="hljs-title function_">createDir</span><span class="hljs-params">(String bucketName, String objectName)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.putObject(<br>        PutObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .stream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;&#125;), <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<br>            .build());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取文件信息, 如果抛出异常则说明文件不存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getFileStatusInfo</span><span class="hljs-params">(String bucketName, String objectName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.statObject(<br>        StatObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .build()).toString();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 拷贝文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName    存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName    文件名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> srcBucketName 目标存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> srcObjectName 目标文件名</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ObjectWriteResponse <span class="hljs-title function_">copyFile</span><span class="hljs-params">(String bucketName, String objectName,</span><br><span class="hljs-params">      String srcBucketName, String srcObjectName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.copyObject(<br>        CopyObjectArgs.builder()<br>            .source(CopySource.builder().bucket(bucketName).object(objectName).build())<br>            .bucket(srcBucketName)<br>            .object(srcObjectName)<br>            .build());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeFile</span><span class="hljs-params">(String bucketName, String objectName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    minioClient.removeObject(<br>        RemoveObjectArgs.builder()<br>            .bucket(bucketName)<br>            .object(objectName)<br>            .build());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 批量删除文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> keys       需要删除的文件列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeFiles</span><span class="hljs-params">(String bucketName, List&lt;String&gt; keys)</span> &#123;<br>    List&lt;DeleteObject&gt; objects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    keys.forEach(s -&gt; &#123;<br>      objects.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteObject</span>(s));<br>      <span class="hljs-keyword">try</span> &#123;<br>        removeFile(bucketName, s);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.error(<span class="hljs-string">&quot;批量删除失败！error:&#123;&#125;&quot;</span>, e.getMessage());<br>      &#125;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取上传文件前缀路径</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 上传文件前缀路径</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getBasisUrl</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (endpoint.endsWith(SEPARATOR)) &#123;<br>      <span class="hljs-keyword">return</span> endpoint + bucketName + SEPARATOR;<br>    &#125;<br>    <span class="hljs-keyword">return</span> endpoint + SEPARATOR + bucketName + SEPARATOR;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取路径下文件列表</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> prefix     文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> recursive  是否递归查找，false：模拟文件夹结构查找</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 二进制流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Iterable&lt;Result&lt;Item&gt;&gt; <span class="hljs-title function_">listObjects</span><span class="hljs-params">(String bucketName, String prefix,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> recursive)</span> &#123;<br>    <span class="hljs-keyword">return</span> minioClient.listObjects(<br>        ListObjectsArgs.builder()<br>            .bucket(bucketName)<br>            .prefix(prefix)<br>            .recursive(recursive)<br>            .build());<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建minioClient时初始化Bucket，如果没有Bucket则创建</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createBucket</span><span class="hljs-params">(String bucketName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (!bucketExists(bucketName)) &#123;<br>      log.info(<span class="hljs-string">&quot;bucketName: &#123;&#125;不存在，开始创建...&quot;</span>, bucketName);<br>      minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断Bucket是否存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true：存在，false：不存在</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">bucketExists</span><span class="hljs-params">(String bucketName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build());<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获得Bucket的策略</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Bucket的策略</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getBucketPolicy</span><span class="hljs-params">(String bucketName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient<br>        .getBucketPolicy(<br>            GetBucketPolicyArgs<br>                .builder()<br>                .bucket(bucketName)<br>                .build()<br>        );<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获得所有Bucket列表</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 所有Bucket列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Bucket&gt; <span class="hljs-title function_">getAllBuckets</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> minioClient.listBuckets();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据bucketName获取其相关信息</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 存储桶相关信息</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Optional&lt;Bucket&gt; <span class="hljs-title function_">getBucket</span><span class="hljs-params">(String bucketName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> getAllBuckets().stream().filter(b -&gt; b.name().equals(bucketName)).findFirst();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据bucketName删除Bucket</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBucket</span><span class="hljs-params">(String bucketName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    minioClient.removeBucket(RemoveBucketArgs.builder().bucket(bucketName).build());<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断存储桶下的文件是否存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName   文件名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true：存在，false：不存在</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isObjectExist</span><span class="hljs-params">(String bucketName, String fileName)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">exist</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      minioClient<br>          .statObject(StatObjectArgs.builder().bucket(bucketName).object(fileName).build());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      exist = <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> exist;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断存储桶下的文件夹是否存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件夹名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true：存在，false：不存在</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFolderExist</span><span class="hljs-params">(String bucketName, String objectName)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">exist</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Iterable&lt;Result&lt;Item&gt;&gt; results = minioClient.listObjects(<br>          ListObjectsArgs.builder().bucket(bucketName).prefix(objectName).recursive(<span class="hljs-literal">false</span>).build());<br>      <span class="hljs-keyword">for</span> (Result&lt;Item&gt; result : results) &#123;<br>        <span class="hljs-type">Item</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> result.get();<br>        <span class="hljs-keyword">if</span> (item.isDir() &amp;&amp; objectName.equals(item.objectName())) &#123;<br>          exist = <span class="hljs-literal">true</span>;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      exist = <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> exist;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据文件前缀查询文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> prefix     前缀</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> recursive  是否使用递归查询</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> MinioItem 列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Item&gt; <span class="hljs-title function_">getAllObjectsByPrefix</span><span class="hljs-params">(String bucketName,</span><br><span class="hljs-params">      String prefix,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> recursive)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    List&lt;Item&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    Iterable&lt;Result&lt;Item&gt;&gt; objectsIterator = minioClient.listObjects(<br>        ListObjectsArgs.builder().bucket(bucketName).prefix(prefix).recursive(recursive).build());<br>    <span class="hljs-keyword">if</span> (objectsIterator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Result&lt;Item&gt; o : objectsIterator) &#123;<br>        <span class="hljs-type">Item</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> o.get();<br>        list.add(item);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取文件外链</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储桶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName 文件名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> expires    过期时间 &lt;=7 秒 （外链有效时间（单位：秒））</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> url</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPresignedObjectUrl</span><span class="hljs-params">(String bucketName, String objectName, Integer expires)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">GetPresignedObjectUrlArgs</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> GetPresignedObjectUrlArgs.builder().expiry(expires)<br>        .bucket(bucketName).object(objectName).build();<br>    <span class="hljs-keyword">return</span> minioClient.getPresignedObjectUrl(args);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获得文件外链</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> url</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPresignedObjectUrl</span><span class="hljs-params">(String bucketName, String objectName)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">GetPresignedObjectUrlArgs</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> GetPresignedObjectUrlArgs.builder()<br>        .bucket(bucketName)<br>        .object(objectName)<br>        .method(Method.GET).build();<br>    <span class="hljs-keyword">return</span> minioClient.getPresignedObjectUrl(args);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 将URLDecoder编码转成UTF8</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> str</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> UnsupportedEncodingException</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUtf8ByURLDecoder</span><span class="hljs-params">(String str)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> str.replaceAll(<span class="hljs-string">&quot;%(?![0-9a-fA-F]&#123;2&#125;)&quot;</span>, <span class="hljs-string">&quot;%25&quot;</span>);<br>    <span class="hljs-keyword">return</span> URLDecoder.decode(url, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断文件名是否带盘符，重新处理</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName 文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 处理后的文件名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getFileName</span><span class="hljs-params">(String fileName)</span> &#123;<br>    <span class="hljs-comment">//判断是否带有盘符信息</span><br>    <span class="hljs-comment">// Check for Unix-style path</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">unixSep</span> <span class="hljs-operator">=</span> fileName.lastIndexOf(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-comment">// Check for Windows-style path</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">winSep</span> <span class="hljs-operator">=</span> fileName.lastIndexOf(<span class="hljs-string">&#x27;\\&#x27;</span>);<br>    <span class="hljs-comment">// Cut off at latest possible point</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> (Math.max(winSep, unixSep));<br>    <span class="hljs-keyword">if</span> (pos != -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// Any sort of path separator found...</span><br>      fileName = fileName.substring(pos + <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-comment">//替换上传文件名字的特殊字符</span><br>    fileName = fileName.replace(<span class="hljs-string">&quot;=&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>        .replace(<span class="hljs-string">&quot;#&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;“&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;”&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-comment">//替换上传文件名字中的空格</span><br>    fileName = fileName.replaceAll(<span class="hljs-string">&quot;\\s&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">return</span> fileName;<br>  &#125;<br><br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>测试Controller</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;上传文件&quot;)</span><br>  <span class="hljs-meta">@PostMapping(&quot;upload&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> MinIOUtils.uploadFile(file);<br>  &#125;<br><br>  <span class="hljs-meta">@ApiOperation(value = &quot;下载文件&quot;)</span><br>  <span class="hljs-meta">@GetMapping(&quot;downLoad/&#123;fileName&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">download</span><span class="hljs-params">(HttpServletResponse response, <span class="hljs-meta">@PathVariable(&quot;fileName&quot;)</span> String fileName)</span> &#123;<br>    MinIOUtils.downLoad(fileName, response);<br>  &#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>断点续传</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230205212522889-5603525.png" srcset="/img/loading.gif" lazyload alt="image-20230205212522889"></p>
<ol>
<li>前端上传文件前请求媒资接口层检查文件是否存在,如果已经存在则不再上传</li>
<li>如果文件在系统不存在则前端开始上传,首先对视频文件进行分块</li>
<li>前端分块进行上传,上传前首先检查分块是否上传,如已上传则不再上传,如果未上传则开始上传分块</li>
<li>前端请求媒资管理接口层请求上传分块</li>
<li>接口层请求服务层上传分块</li>
<li>服务端将分块信息上传到MinIO</li>
<li>前端将分块上传完毕请求接口层合并分块</li>
<li>接口层请求服务层合并分块</li>
<li>服务层根据文件信息找到MinIO中的分块文件,下载到本地临时目录,将所有分块下载完毕后开始合并</li>
<li>合并完成后将合并后的文件上传到MinIO</li>
</ol>
<blockquote>
<p>java实现</p>
</blockquote>
<p>为了更好理解分块上传的原理,下面用java实现下:</p>
<p>文件分块的流程如下：</p>
<p>1、获取源文件长度</p>
<p>2、根据设定的分块文件的大小计算出块数</p>
<p>3、从源文件读数据依次向每一个块文件写数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testChunk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/myfile/1.png&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/Users/gaozhe/Desktop/chunk/&quot;</span>;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">chunkFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(chunkPath);<br>    <span class="hljs-keyword">if</span> (!chunkFolder.exists()) &#123;<br>      chunkFolder.mkdirs();<br>    &#125;<br>    <span class="hljs-comment">//分块大小</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">chunkSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//分块数量</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">chunkNum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) Math.ceil(sourceFile.length() * <span class="hljs-number">1.0</span> / chunkSize);<br>    System.out.println(<span class="hljs-string">&quot;分块总数：&quot;</span> + chunkNum);<br>    <span class="hljs-comment">//缓冲区大小</span><br>    <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-comment">//使用RandomAccessFile访问文件</span><br>    <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_read</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(sourceFile, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-comment">//分块</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chunkNum; i++) &#123;<br>      <span class="hljs-comment">//创建分块文件</span><br>      <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(chunkPath + i);<br>      <span class="hljs-keyword">if</span> (file.exists()) &#123;<br>        file.delete();<br>      &#125;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">newFile</span> <span class="hljs-operator">=</span> file.createNewFile();<br>      <span class="hljs-keyword">if</span> (newFile) &#123;<br>        <span class="hljs-comment">//向分块文件中写数据</span><br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_write</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(file, <span class="hljs-string">&quot;rw&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> ((len = raf_read.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>          raf_write.write(b, <span class="hljs-number">0</span>, len);<br>          <span class="hljs-keyword">if</span> (file.length() &gt;= chunkSize) &#123;<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>        &#125;<br>        raf_write.close();<br>        System.out.println(<span class="hljs-string">&quot;完成分块&quot;</span> + i);<br>      &#125;<br><br>    &#125;<br>    raf_read.close();<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>文件合并流程：</p>
<p>1、找到要合并的文件并按文件合并的先后进行排序。</p>
<p>2、创建合并文件</p>
<p>3、依次从合并的文件中读取数据向合并文件写入数</p>
<p>文件合并的测试代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMerge</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//块文件目录</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">chunkFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/chunk/&quot;</span>);<br>    <span class="hljs-comment">//原始文件</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">originalFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/myfile/1.png&quot;</span>);<br>    <span class="hljs-comment">//合并文件</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">mergeFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/1.png&quot;</span>);<br>    <span class="hljs-keyword">if</span> (mergeFile.exists()) &#123;<br>      mergeFile.delete();<br>    &#125;<br>    <span class="hljs-comment">//创建新的合并文件</span><br>    mergeFile.createNewFile();<br>    <span class="hljs-comment">//用于写文件</span><br>    <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_write</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(mergeFile, <span class="hljs-string">&quot;rw&quot;</span>);<br>    <span class="hljs-comment">//指针指向文件顶端</span><br>    raf_write.seek(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//缓冲区</span><br>    <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-comment">//分块列表</span><br>    File[] fileArray = chunkFolder.listFiles();<br>    <span class="hljs-comment">// 转成集合，便于排序</span><br>    List&lt;File&gt; fileList = Arrays.asList(fileArray);<br>    <span class="hljs-comment">// 从小到大排序</span><br>    fileList.sort(Comparator.comparingInt(o -&gt; Integer.parseInt(o.getName())));<br>    <span class="hljs-comment">//合并文件</span><br>    <span class="hljs-keyword">for</span> (File chunkFile : fileList) &#123;<br>      <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_read</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(chunkFile, <span class="hljs-string">&quot;rw&quot;</span>);<br>      <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">while</span> ((len = raf_read.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>        raf_write.write(b, <span class="hljs-number">0</span>, len);<br><br>      &#125;<br>      raf_read.close();<br>    &#125;<br>    raf_write.close();<br><br>    <span class="hljs-comment">//校验文件</span><br>    <span class="hljs-keyword">try</span> (<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(originalFile);<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">mergeFileStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(mergeFile);<br>    ) &#123;<br>      <span class="hljs-comment">//取出原始文件的md5</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">originalMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>      <span class="hljs-comment">//取出合并文件的md5进行比较</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">mergeFileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(mergeFileStream);<br>      <span class="hljs-keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;<br>        System.out.println(<span class="hljs-string">&quot;合并文件成功&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;合并文件失败&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br><br></code></pre></td></tr></table></figure>







<blockquote>
<p>实例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigFilesController</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  MediaFilesService mediaFileService;<br><br><br>  <span class="hljs-meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span><br>  <span class="hljs-meta">@PostMapping(&quot;/upload/checkfile&quot;)</span><br>  <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkfile</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span><br><span class="hljs-params">  )</span> &#123;<br>    <span class="hljs-keyword">return</span> mediaFileService.checkFile(fileMd5);<br>  &#125;<br><br><br>  <span class="hljs-meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span><br>  <span class="hljs-meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span><br>  <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span> <span class="hljs-type">int</span> chunk)</span> &#123;<br>    <span class="hljs-keyword">return</span> mediaFileService.checkChunk(fileMd5, chunk);<br>  &#125;<br><br>  <span class="hljs-meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span><br>  <span class="hljs-meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span><br>  <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span> <span class="hljs-type">int</span> chunk)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> mediaFileService.uploadChunk(fileMd5, chunk, file.getBytes());<br>  &#125;<br><br>  <span class="hljs-meta">@ApiOperation(value = &quot;合并文件&quot;)</span><br>  <span class="hljs-meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span><br>  <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="hljs-type">int</span> chunkTotal)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    <span class="hljs-type">UploadFileParamsDto</span> <span class="hljs-variable">uploadFileParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileParamsDto</span>();<br>    uploadFileParamsDto.setFileType(<span class="hljs-string">&quot;001002&quot;</span>);<br>    uploadFileParamsDto.setTags(<span class="hljs-string">&quot;课程视频&quot;</span>);<br>    uploadFileParamsDto.setRemark(<span class="hljs-string">&quot;&quot;</span>);<br>    uploadFileParamsDto.setFilename(fileName);<br><br>    <span class="hljs-keyword">return</span> mediaFileService.mergechunks(companyId, fileMd5, chunkTotal, uploadFileParamsDto);<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.gz.study.base.exception.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.gz.study.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.gz.study.media.config.MinIOUtils;<br><span class="hljs-keyword">import</span> com.gz.study.media.mapper.MediaFilesMapper;<br><span class="hljs-keyword">import</span> com.gz.study.media.model.dto.UploadFileParamsDto;<br><span class="hljs-keyword">import</span> com.gz.study.media.model.dto.UploadFileResultDto;<br><span class="hljs-keyword">import</span> com.gz.study.media.model.po.MediaFiles;<br><span class="hljs-keyword">import</span> com.gz.study.media.service.MediaFilesService;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> io.minio.GetObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.PutObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.UploadObjectArgs;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 媒资信息 服务实现类</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> gzzear</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaFilesServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;MediaFilesMapper, MediaFiles&gt; <span class="hljs-keyword">implements</span><br>    <span class="hljs-title class_">MediaFilesService</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> MediaFilesMapper mediaFilesMapper;<br><br>  <span class="hljs-comment">//普通文件桶</span><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String bucket_Files;<br><br>  <span class="hljs-comment">//普通文件桶</span><br>  <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String bucket_videoFiles;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto,</span><br><span class="hljs-params">      <span class="hljs-type">byte</span>[] bytes, String folder, String objectName)</span> &#123;<br>    <span class="hljs-comment">//生成文件id，文件的md5值</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileId</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(bytes);<br>    <span class="hljs-comment">//文件名称</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>    <span class="hljs-comment">//构造objectname</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(objectName)) &#123;<br>      objectName = fileId + filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(folder)) &#123;<br>      <span class="hljs-comment">//通过日期构造文件存储路径</span><br>      folder = getFileFolder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (folder.indexOf(<span class="hljs-string">&quot;/&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>      folder = folder + <span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">//对象名称</span><br>    objectName = folder + objectName;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//转为流</span><br>      <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br><br>      <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder().bucket(bucket_Files).object(objectName)<br>          <span class="hljs-comment">//-1表示文件分片按5M(不小于5M,不大于5T),分片数量最大10000，</span><br>          .stream(byteArrayInputStream, byteArrayInputStream.available(), -<span class="hljs-number">1</span>)<br>          .contentType(uploadFileParamsDto.getContentType())<br>          .build();<br><br>      <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinIOUtils.initMinioClient();<br>      minioClient.putObject(putObjectArgs);<br>      <span class="hljs-comment">//从数据库查询文件</span><br>      mediaFiles = mediaFilesMapper.selectById(fileId);<br>      <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>        mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>        <span class="hljs-comment">//拷贝基本信息</span><br>        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>        mediaFiles.setId(fileId);<br>        mediaFiles.setFileId(fileId);<br>        mediaFiles.setCompanyId(companyId);<br>        mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket_Files + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>        mediaFiles.setBucket(bucket_Files);<br>        mediaFiles.setCreateDate(LocalDateTime.now());<br>        mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-comment">//保存文件信息到文件表</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>        <span class="hljs-keyword">if</span> (insert &lt; <span class="hljs-number">0</span>) &#123;<br>          XueChengPlusException.cast(<span class="hljs-string">&quot;保存文件信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>        BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>        <span class="hljs-keyword">return</span> uploadFileResultDto;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      e.printStackTrace();<br>      XueChengPlusException.cast(<span class="hljs-string">&quot;上传过程中出错&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//根据日期拼接目录</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFileFolder</span><span class="hljs-params">(Date date, <span class="hljs-type">boolean</span> year, <span class="hljs-type">boolean</span> month, <span class="hljs-type">boolean</span> day)</span> &#123;<br>    <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>    <span class="hljs-comment">//获取当前日期字符串</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">dateString</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-comment">//取出年、月、日</span><br>    String[] dateStringArray = dateString.split(<span class="hljs-string">&quot;-&quot;</span>);<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">folderString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">if</span> (year) &#123;<br>      folderString.append(dateStringArray[<span class="hljs-number">0</span>]);<br>      folderString.append(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (month) &#123;<br>      folderString.append(dateStringArray[<span class="hljs-number">1</span>]);<br>      folderString.append(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (day) &#123;<br>      folderString.append(dateStringArray[<span class="hljs-number">2</span>]);<br>      folderString.append(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> folderString.toString();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkFile</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>    <span class="hljs-comment">//查询文件信息</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileMd5);<br>    <span class="hljs-keyword">if</span> (mediaFiles != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">//桶</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> mediaFiles.getBucket();<br>      <span class="hljs-comment">//存储目录</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> mediaFiles.getFilePath();<br>      <span class="hljs-comment">//文件流</span><br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinIOUtils.initMinioClient();<br>        stream = minioClient.getObject(<br>            GetObjectArgs.builder()<br>                .bucket(bucket)<br>                .object(filePath)<br>                .build());<br><br>        <span class="hljs-keyword">if</span> (stream != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">//文件已存在</span><br>          <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//文件不存在</span><br>    <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>  &#125;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkChunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunkIndex)</span> &#123;<br><br>    <span class="hljs-comment">//得到分块文件目录</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br>    <span class="hljs-comment">//得到分块文件的路径</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkFilePath</span> <span class="hljs-operator">=</span> chunkFileFolderPath + chunkIndex;<br><br>    <span class="hljs-comment">//文件流</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinIOUtils.initMinioClient();<br>      fileInputStream = minioClient.getObject(<br>          GetObjectArgs.builder()<br>              .bucket(bucket_videoFiles)<br>              .object(chunkFilePath)<br>              .build());<br>      <span class="hljs-keyword">if</span> (fileInputStream != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//分块已存在</span><br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>    &#125;<br>    <span class="hljs-comment">//分块未存在</span><br>    <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">//得到分块文件的目录</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getChunkFileFolderPath</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>    <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;chunk&quot;</span><br>        + <span class="hljs-string">&quot;/&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadChunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunk, <span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>    <span class="hljs-comment">//得到分块文件的目录路径</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br>    <span class="hljs-comment">//得到分块文件的路径</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkFilePath</span> <span class="hljs-operator">=</span> chunkFileFolderPath + chunk;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//将文件存储至minIO</span><br>      addMediaFilesToMinIO(bytes, bucket_videoFiles, chunkFilePath);<br>      <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>      log.debug(<span class="hljs-string">&quot;上传分块文件:&#123;&#125;,失败:&#123;&#125;&quot;</span>, chunkFilePath, ex.getMessage());<br>    &#125;<br>    <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;上传分块失败&quot;</span>);<br>  &#125;<br><br><br>  <span class="hljs-comment">//将文件上传到文件系统</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(String filePath, String bucket, String objectName)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>          .bucket(bucket)<br>          .object(objectName)<br>          .filename(filePath)<br>          .build();<br>      <span class="hljs-comment">//上传</span><br>      MinIOUtils.uploadFile(uploadObjectArgs);<br>      log.debug(<span class="hljs-string">&quot;文件上传成功:&#123;&#125;&quot;</span>, filePath);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传到文件系统失败&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 将文件上传到分布式文件系统</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucket</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes, String bucket, String objectName)</span> &#123;<br><br>    <span class="hljs-comment">//资源的媒体类型:默认未知二进制流</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<br><br>    <span class="hljs-keyword">if</span> (objectName.indexOf(<span class="hljs-string">&quot;.&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">//取objectName中的扩展名</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> objectName.substring(objectName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>      <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(extension);<br>      <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>        contentType = extensionMatch.getMimeType();<br>      &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br><br>      <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder()<br>          .bucket(bucket)<br>          .object(objectName)<br>          <span class="hljs-comment">//InputStream stream, long objectSize 对象大小, long partSize 分片大小(-1表示5M,最大不要超过5T，最多10000)</span><br>          .stream(byteArrayInputStream, byteArrayInputStream.available(), -<span class="hljs-number">1</span>)<br>          .contentType(contentType)<br>          .build();<br>      <span class="hljs-comment">//上传到minio</span><br>      MinIOUtils.uploadFile(putObjectArgs);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.debug(<span class="hljs-string">&quot;上传文件到文件系统出错:&#123;&#125;&quot;</span>, e.getMessage());<br>      XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到文件系统出错&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//合并分块</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunks</span><span class="hljs-params">(Long companyId, String fileMd5, <span class="hljs-type">int</span> chunkTotal,</span><br><span class="hljs-params">      UploadFileParamsDto uploadFileParamsDto)</span> &#123;<br>    <span class="hljs-comment">//下载分块</span><br>    File[] chunkFiles = checkChunkStatus(fileMd5, chunkTotal);<br><br>    <span class="hljs-comment">//得到合并后文件的扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>    <span class="hljs-comment">//扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-type">File</span> <span class="hljs-variable">tempMergeFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//创建一个临时文件作为合并文件</span><br>        tempMergeFile = File.createTempFile(<span class="hljs-string">&quot;&#x27;merge&#x27;&quot;</span>, extension);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;创建临时合并文件出错&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-comment">//创建合并文件的流对象</span><br>      <span class="hljs-keyword">try</span> (<span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_write</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(tempMergeFile, <span class="hljs-string">&quot;rw&quot;</span>)) &#123;<br>        <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">for</span> (File file : chunkFiles) &#123;<br>          <span class="hljs-comment">//读取分块文件的流对象</span><br>          <span class="hljs-keyword">try</span> (<span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf_read</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(file, <span class="hljs-string">&quot;r&quot;</span>);) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> ((len = raf_read.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>              <span class="hljs-comment">//向合并文件写数据</span><br>              raf_write.write(b, <span class="hljs-number">0</span>, len);<br>            &#125;<br>          &#125;<br><br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;合并文件过程出错&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-comment">//校验合并后的文件是否正确</span><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">mergeFileStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(tempMergeFile);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mergeMd5Hex</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(mergeFileStream);<br>        <span class="hljs-keyword">if</span> (!fileMd5.equals(mergeMd5Hex)) &#123;<br>          log.debug(<span class="hljs-string">&quot;合并文件校验不通过,文件路径:&#123;&#125;,原始文件md5:&#123;&#125;&quot;</span>, tempMergeFile.getAbsolutePath(), fileMd5);<br>          XueChengPlusException.cast(<span class="hljs-string">&quot;合并文件校验不通过&quot;</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        log.debug(<span class="hljs-string">&quot;合并文件校验出错,文件路径:&#123;&#125;,原始文件md5:&#123;&#125;&quot;</span>, tempMergeFile.getAbsolutePath(), fileMd5);<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;合并文件校验出错&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-comment">//拿到合并文件在minio的存储路径</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">mergeFilePath</span> <span class="hljs-operator">=</span> getFilePathByMd5(fileMd5, extension);<br>      <span class="hljs-comment">//将合并后的文件上传到文件系统</span><br>      addMediaFilesToMinIO(tempMergeFile.getAbsolutePath(), bucket_videoFiles, mergeFilePath);<br><br>      <span class="hljs-comment">//将文件信息入库保存</span><br>      uploadFileParamsDto.setFileSize(tempMergeFile.length());<span class="hljs-comment">//合并文件的大小</span><br>      addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_videofiles, mergeFilePath);<br><br>      <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">//删除临时分块文件</span><br>      <span class="hljs-keyword">if</span> (chunkFiles != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (File chunkFile : chunkFiles) &#123;<br>          <span class="hljs-keyword">if</span> (chunkFile.exists()) &#123;<br>            chunkFile.delete();<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">//删除合并的临时文件</span><br>      <span class="hljs-keyword">if</span> (tempMergeFile != <span class="hljs-literal">null</span>) &#123;<br>        tempMergeFile.delete();<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> companyId</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileId</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> uploadFileParamsDto</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucket</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@description</span> 将文件信息入库</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@date</span> 2022/10/14 9:14</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Transactional</span><br>  <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDb</span><span class="hljs-params">(Long companyId, String fileId,</span><br><span class="hljs-params">      UploadFileParamsDto uploadFileParamsDto, String bucket, String objectName)</span> &#123;<br>    <span class="hljs-comment">//保存到数据库</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileId);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>      mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>      <span class="hljs-comment">//封装数据</span><br>      BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>      mediaFiles.setId(fileId);<br>      mediaFiles.setFileId(fileId);<br>      mediaFiles.setCompanyId(companyId);<br>      mediaFiles.setBucket(bucket);<br>      mediaFiles.setFilePath(objectName);<br>      mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>      mediaFiles.setCreateDate(LocalDateTime.now());<br>      mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>      mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>      <span class="hljs-comment">//插入文件表</span><br>      mediaFilesMapper.insert(mediaFiles);<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilePathByMd5</span><span class="hljs-params">(String fileMd5, String fileExt)</span> &#123;<br>    <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + fileMd5<br>        + fileExt;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileMd5</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> chunkTotal 分块数量</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> java.io.File[] 分块文件数组</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@description</span> 下载分块</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@date</span> 2022/10/14 15:07</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> File[] checkChunkStatus(String fileMd5, <span class="hljs-type">int</span> chunkTotal) &#123;<br><br>    <span class="hljs-comment">//得到分块文件所在目录</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br>    <span class="hljs-comment">//分块文件数组</span><br>    File[] chunkFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>[chunkTotal];<br>    <span class="hljs-comment">//开始下载</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chunkTotal; i++) &#123;<br>      <span class="hljs-comment">//分块文件的路径</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">chunkFilePath</span> <span class="hljs-operator">=</span> chunkFileFolderPath + i;<br>      <span class="hljs-comment">//分块文件</span><br>      <span class="hljs-type">File</span> <span class="hljs-variable">chunkFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        chunkFile = File.createTempFile(<span class="hljs-string">&quot;chunk&quot;</span>, <span class="hljs-literal">null</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;创建分块临时文件出错&quot;</span> + e.getMessage());<br>      &#125;<br><br>      <span class="hljs-comment">//下载分块文件</span><br>      downloadFileFromMinIO(chunkFile, bucket_videoFiles, chunkFilePath);<br>      chunkFiles[i] = chunkFile;<br><br>    &#125;<br>    <span class="hljs-keyword">return</span> chunkFiles;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据桶和文件路径从minio下载文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucket</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> objectName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> File <span class="hljs-title function_">downloadFileFromMinIO</span><span class="hljs-params">(File file, String bucket, String objectName)</span> &#123;<br>    <span class="hljs-keyword">try</span> (<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> MinIOUtils.getObjectInputStream(bucket, objectName);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>    ) &#123;<br>      IOUtils.copy(inputStream, outputStream);<br>      <span class="hljs-keyword">return</span> file;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      XueChengPlusException.cast(<span class="hljs-string">&quot;查询分块文件出错&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

















<h2 id="十七、jxls导出-导入Excel"><a href="#十七、jxls导出-导入Excel" class="headerlink" title="十七、jxls导出&#x2F;导入Excel"></a>十七、jxls导出&#x2F;导入Excel</h2><h4 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h4><blockquote>
<p>依赖导入</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--        excel导出-jxls--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jxls<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jxls<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jxls<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jxls-poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.poi.openxml4j.exceptions.InvalidFormatException;<br><span class="hljs-keyword">import</span> org.jxls.common.Context;<br><span class="hljs-keyword">import</span> org.jxls.reader.ReaderBuilder;<br><span class="hljs-keyword">import</span> org.jxls.reader.ReaderConfig;<br><span class="hljs-keyword">import</span> org.jxls.reader.XLSDataReadException;<br><span class="hljs-keyword">import</span> org.jxls.reader.XLSReader;<br><span class="hljs-keyword">import</span> org.jxls.util.JxlsHelper;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><span class="hljs-keyword">import</span> org.xml.sax.SAXException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * excel导出工具</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 高喆</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2022-07-04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelUtils</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 导出</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> data        导出的数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName    导出的文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> templateDir 模版文件的位置</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> response    响应流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(Object data, String fileName, String templateDir,</span><br><span class="hljs-params">      HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(templateDir).getInputStream();<br>    export(data, fileName, is, response);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 导出</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> data     导出的数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName 导出的文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> template 模版文件输入流</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> response 响应流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(Object data, String fileName, InputStream template,</span><br><span class="hljs-params">      HttpServletResponse response)</span> &#123;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> template;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getOutputStream()) &#123;<br>      <span class="hljs-comment">//文件名编码</span><br>      fileName = URLEncoder.encode(fileName, <span class="hljs-string">&quot;UTF-8&quot;</span>).replace(<span class="hljs-string">&quot;\\+&quot;</span>, <span class="hljs-string">&quot;%20&quot;</span>);<br>      response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename*=utf-8&#x27;&#x27;&quot;</span> + fileName);<br>      response.setContentType(<span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>      <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();<br>      context.putVar(<span class="hljs-string">&quot;data&quot;</span>, data);<br>      JxlsHelper.getInstance().processTemplate(is, out, context);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(<span class="hljs-string">&quot;导出失败&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 导入</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> configDir         配置文件路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> dataFin           导入的文件的输入流</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> targetMappingName 导入javaBean映射名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> target            导入javaBean对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importExcel</span><span class="hljs-params">(String configDir, InputStream dataFin, String targetMappingName,</span><br><span class="hljs-params">      Object target)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputXML</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(configDir).getInputStream());<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputXLS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(dataFin);<br>      Map&lt;String, Object&gt; beanParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      beanParams.put(targetMappingName, target);<br>      <span class="hljs-comment">//碰到数据类型转换异常时跳过异常,例如数字类型但是单元格中为空,默认是会抛出异常的.设置之后就会设置为null</span><br>      ReaderConfig.getInstance().setSkipErrors(<span class="hljs-literal">true</span>);<br>      <span class="hljs-type">XLSReader</span> <span class="hljs-variable">mainReader</span> <span class="hljs-operator">=</span> ReaderBuilder.buildFromXML(inputXML);<br>      <span class="hljs-comment">//从excel中读取对象,名称需和xml中对应</span><br>      mainReader.read(inputXLS, beanParams);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException | SAXException | InvalidFormatException | XLSDataReadException e) &#123;<br>      log.error(<span class="hljs-string">&quot;导入失败&quot;</span>);<br>      e.printStackTrace();<br>    &#125;<br>  &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>创建模版excel</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220814200700588.png" srcset="/img/loading.gif" lazyload alt="image-20220814200700588"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">第一行第一个单元格： jx:area(<span class="hljs-attribute">lastCell</span>=<span class="hljs-string">&quot;D2&quot;</span>)<br>第二行第一个单元格： jx:each(<span class="hljs-attribute">items</span>=<span class="hljs-string">&quot;data&quot;</span> <span class="hljs-attribute">var</span>=<span class="hljs-string">&quot;item&quot;</span> <span class="hljs-attribute">lastCell</span>=<span class="hljs-string">&quot;D2&quot;</span>)<br>图片单元格：jx:image(<span class="hljs-attribute">lastCell</span>=<span class="hljs-string">&quot;C2&quot;</span> <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;item.image&quot;</span> <span class="hljs-attribute">imageType</span>=<span class="hljs-string">&quot;PNG&quot;</span>)<br>除了图片，其他导出实体类属性设置：<span class="hljs-variable">$&#123;item&#125;</span><br></code></pre></td></tr></table></figure>









<blockquote>
<p>demo例子</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@RequestMapping(&quot;/employee&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeController</span> &#123;<br><br>  <span class="hljs-meta">@GetMapping(&quot;export&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportEmployee</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    List&lt;Employee&gt; employees = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>      <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>();<br>      employee.setAge(i);<br>      employee.setGender(<span class="hljs-number">1</span>);<br>      employee.setName(<span class="hljs-string">&quot;高喆&quot;</span> + i);<br>      <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/gaozhe/Desktop/myfile/kabishen.jpg&quot;</span>);<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>      <span class="hljs-comment">//图片属性需要设置成byte[]</span><br>      employee.setImage(StreamUtils.copyToByteArray(in));<br>      employees.add(employee);<br>    &#125;<br><br>    ExcelUtils.export(employees, <span class="hljs-string">&quot;员工考勤表.xlsx&quot;</span>, <span class="hljs-string">&quot;excel/template/员工数据列表.xlsx&quot;</span>, response);<br><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>结果</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220814200942410.png" srcset="/img/loading.gif" lazyload alt="image-20220814200942410"></p>
<blockquote>
<p>常见标签</p>
</blockquote>
<ol>
<li>合并单元格:   jx:mergeCells(rows&#x3D;”item.courses.size()” lastCell&#x3D;”A4”)</li>
</ol>
<p>有时候,我们会遇到导出的实体类集合是包含一对多的情况,这个时候我们就需要用到合并单元格的标签</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221204160334223.png" srcset="/img/loading.gif" lazyload alt="image-20221204160334223"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221205175142353.png" srcset="/img/loading.gif" lazyload alt="image-20221205175142353"></p>
<ol start="2">
<li>循环标签: jx:each</li>
</ol>
<p>示例：jx:each((items&#x3D;”employees” var&#x3D;”employee” lastCell&#x3D;”D4” area&#x3D;”[A4:D4]” select&#x3D;”employee.payment &gt; 2000”))<br>参数说明:</p>
<table>
<thead>
<tr>
<th align="left">参数名称</th>
<th align="left">示例</th>
<th align="left">必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">items</td>
<td align="left">items&#x3D;”employees”</td>
<td align="left">必填</td>
<td align="left">循环的集合对象</td>
</tr>
<tr>
<td align="left">var</td>
<td align="left">var&#x3D;”employee”</td>
<td align="left">必填</td>
<td align="left">循环中的变量名,指定之后区域内可以使用该名称访问属性</td>
</tr>
<tr>
<td align="left">lastCell</td>
<td align="left">lastCell&#x3D;”D4”</td>
<td align="left">必填</td>
<td align="left">指令对应的结束位置</td>
</tr>
<tr>
<td align="left">direction</td>
<td align="left">direction &#x3D;”RIGHT”</td>
<td align="left"></td>
<td align="left">输出的方向向下(DOWN)或向右(RIGHT),默认为DOWN</td>
</tr>
<tr>
<td align="left">area</td>
<td align="left">areas&#x3D;[“A8:F8”,”A13:F13”]</td>
<td align="left"></td>
<td align="left">循环的区域，一次循环多行则需要填写,可以指定多个区域使用逗号分隔</td>
</tr>
<tr>
<td align="left">select</td>
<td align="left">select&#x3D;”employee.payment&gt;2000”</td>
<td align="left"></td>
<td align="left">过滤条件,不需要通过${}来取值</td>
</tr>
<tr>
<td align="left">groupBy</td>
<td align="left">groupBy &#x3D;”name”</td>
<td align="left"></td>
<td align="left">jx:each(items&#x3D;”employees” var&#x3D;”nameGroup” groupBy&#x3D;”name” groupOrder&#x3D;”asc” lastCell&#x3D;”D7”)依据employee中name进行分组，分组后的集合可通过nameGroup.items来获取，官网示例中后面还有一个each指定的items就是nameGroup.items</td>
</tr>
<tr>
<td align="left">groupOrder</td>
<td align="left">groupOrder &#x3D;”asc”</td>
<td align="left"></td>
<td align="left">指定分组排序(‘desc’ or ‘asc’)</td>
</tr>
<tr>
<td align="left">multisheet</td>
<td align="left">multisheet &#x3D;”sheets”</td>
<td align="left"></td>
<td align="left">循环的sheet名称集合，指定后会产生多个sheet，指定后each的维度会变为sheet，不需要指定area</td>
</tr>
<tr>
<td align="left">shiftMode</td>
<td align="left">shiftMode &#x3D;”adjacent”</td>
<td align="left"></td>
<td align="left">adjacent指定后通过添加行的方式向指定方向输出，inner:则为通过添加单元格的方式向指定方向输出,默认为inner</td>
</tr>
<tr>
<td align="left">cellRefGenerator</td>
<td align="left">?</td>
<td align="left"></td>
<td align="left">?</td>
</tr>
</tbody></table>
<ol start="3">
<li>jx:if 条件判断</li>
</ol>
<p>示例：jx:if(condition&#x3D;”department.chief.name !&#x3D; ‘Betsy’ “ lastCell&#x3D;”F4” areas&#x3D;[“A3:F4”])</p>
<p>如果满足条件才回显示出来  </p>
<table>
<thead>
<tr>
<th align="left">参数名称</th>
<th align="left">示例</th>
<th align="left">必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">condition</td>
<td align="left">condition&#x3D;”department.chief.name !&#x3D; ‘Betsy’ “</td>
<td align="left">必填</td>
<td align="left">判断条件，字符串不需要通过${}来取值，直接访问传递对象的内容</td>
</tr>
<tr>
<td align="left">ifArea</td>
<td align="left">ifArea &#x3D;[“A3:F4”]</td>
<td align="left"></td>
<td align="left">if指令影响的范围 condition结果为true则显示指定范围</td>
</tr>
<tr>
<td align="left">elseArea</td>
<td align="left">elseArea&#x3D;[“A3:F4”]</td>
<td align="left"></td>
<td align="left">if指令影响的范围 condition结果为false则显示指定范围</td>
</tr>
</tbody></table>
<ol start="4">
<li>jx:image 输出图片</li>
</ol>
<table>
<thead>
<tr>
<th align="left">参数名称</th>
<th align="left">示例</th>
<th align="left">必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">src</td>
<td align="left">src&#x3D;”image”</td>
<td align="left">必填</td>
<td align="left">输出的图片数据源byte[]</td>
</tr>
<tr>
<td align="left">imageType</td>
<td align="left">imageType&#x3D;”PNG”</td>
<td align="left"></td>
<td align="left">输出的图片格式可不填</td>
</tr>
</tbody></table>
<h4 id="导入Excel"><a href="#导入Excel" class="headerlink" title="导入Excel"></a>导入Excel</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jxls<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jxls-reader<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml-schemas<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>要读取的Excel中的数据展示<br><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/SouthEast.jpeg" srcset="/img/loading.gif" lazyload alt="要读取的Excel文件"></p>
<blockquote>
<p>导入配置xml详解</p>
</blockquote>
<p><strong>xmlConfig.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">workbook</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--导入哪个sheet--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">worksheet</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Sheet1&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--注意：行和列都是从零开始--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;6&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;B1&quot;</span>&gt;</span>department.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;A4&quot;</span>&gt;</span>department.chief.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;B4&quot;</span>&gt;</span>department.chief.age<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;D4&quot;</span>&gt;</span>department.chief.payment<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;4&quot;</span>&gt;</span>department.chief.bonus<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--遍历，startRow=”7” endRow=”7” 表示第8行，准确的说第8行为遍历的起始行--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">loop</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">items</span>=<span class="hljs-string">&quot;employees&quot;</span> <span class="hljs-attr">var</span>=<span class="hljs-string">&quot;employee&quot;</span> <span class="hljs-attr">varType</span>=<span class="hljs-string">&quot;com.enation.app.shop.core.order.model.Staff&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;7&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span>employee.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span>employee.age<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;3&quot;</span>&gt;</span>employee.payment<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;4&quot;</span>&gt;</span>employee.bonus<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br>      <span class="hljs-comment">&lt;!--注意：loop标签必须包含loopbreakcondition标签，用作终止循环。这里是下一行的第一个单元格如果是 Employee Payment Totals: 则终止该循环--&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">loopbreakcondition</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rowcheck</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>          <span class="hljs-comment">&lt;!--不写文字代表遇到空白则终止循环--&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">cellcheck</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span>Employee Payment Totals:<span class="hljs-tag">&lt;/<span class="hljs-name">cellcheck</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rowcheck</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">loopbreakcondition</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">loop</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">worksheet</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">workbook</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>有的时候我们并不知道sheet的名字，因此jxls也为我们提供了通过索引<em>idx</em>来指定sheet</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;ISO-8859-1&quot;</span>?&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">workbook</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">worksheet</span> <span class="hljs-attr">idx</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;6&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;B1&quot;</span>&gt;</span>department.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;A4&quot;</span>&gt;</span>department.chief.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;B4&quot;</span>&gt;</span>department.chief.age<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">cell</span>=<span class="hljs-string">&quot;D4&quot;</span>&gt;</span>department.chief.payment<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;4&quot;</span>&gt;</span>department.chief.bonus<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">loop</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">items</span>=<span class="hljs-string">&quot;department.staff&quot;</span> <span class="hljs-attr">var</span>=<span class="hljs-string">&quot;employee&quot;</span> <span class="hljs-attr">varType</span>=<span class="hljs-string">&quot;org.jxls.reader.sample.Employee&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">startRow</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">endRow</span>=<span class="hljs-string">&quot;7&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span>employee.name<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span>employee.age<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;3&quot;</span>&gt;</span>employee.payment<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">row</span>=<span class="hljs-string">&quot;7&quot;</span> <span class="hljs-attr">col</span>=<span class="hljs-string">&quot;4&quot;</span>&gt;</span>employee.bonus<span class="hljs-tag">&lt;/<span class="hljs-name">mapping</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">loopbreakcondition</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">rowcheck</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">cellcheck</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span>Employee Payment Totals:<span class="hljs-tag">&lt;/<span class="hljs-name">cellcheck</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">rowcheck</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">loopbreakcondition</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">loop</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">worksheet</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">workbook</span>&gt;</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>导入demo</p>
</blockquote>
<p>Staff.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Staff</span> &#123;<br><br>        <span class="hljs-keyword">private</span>  String name;<br>        <span class="hljs-keyword">private</span>  <span class="hljs-type">int</span> age;<br>        <span class="hljs-keyword">private</span>  String  birthDateOfString;<br>        <span class="hljs-keyword">private</span>  Double payment;<br>        <span class="hljs-keyword">private</span>  Double bonus;<br>        <span class="hljs-keyword">private</span>  String superiorName;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Staff</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Staff</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, String birthDateOfString, Double payment, Double bonus, String superiorName)</span> &#123;<br>            <span class="hljs-built_in">super</span>();<br>            <span class="hljs-built_in">this</span>.name = name;<br>            <span class="hljs-built_in">this</span>.age = age;<br>            <span class="hljs-built_in">this</span>.birthDateOfString = birthDateOfString;<br>            <span class="hljs-built_in">this</span>.payment = payment;<br>            <span class="hljs-built_in">this</span>.bonus = bonus;<br>            <span class="hljs-built_in">this</span>.superiorName = superiorName;<br>        &#125;<br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> name;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-built_in">this</span>.name = name;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> age;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>            <span class="hljs-built_in">this</span>.age = age;<br>        &#125;<br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBirthDateOfString</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> birthDateOfString;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBirthDateOfString</span><span class="hljs-params">(String birthDateOfString)</span> &#123;<br>            <span class="hljs-built_in">this</span>.birthDateOfString = birthDateOfString;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPayment</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> payment;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPayment</span><span class="hljs-params">(Double payment)</span> &#123;<br>            <span class="hljs-built_in">this</span>.payment = payment;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getBonus</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> bonus;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBonus</span><span class="hljs-params">(Double bonus)</span> &#123;<br>            <span class="hljs-built_in">this</span>.bonus = bonus;<br>        &#125;<br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSuperiorName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> superiorName;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSuperiorName</span><span class="hljs-params">(String superiorName)</span> &#123;<br>            <span class="hljs-built_in">this</span>.superiorName = superiorName;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Staff [name=&quot;</span> + name + <span class="hljs-string">&quot;, age=&quot;</span> + age + <span class="hljs-string">&quot;, birthDateOfString=&quot;</span> + birthDateOfString + <span class="hljs-string">&quot;, payment=&quot;</span> + payment + <span class="hljs-string">&quot;, bonus=&quot;</span><br>                    + bonus + <span class="hljs-string">&quot;, superiorName=&quot;</span> + superiorName + <span class="hljs-string">&quot;]&quot;</span>;<br>        &#125;<br>    &#125;<br><br><br></code></pre></td></tr></table></figure>



<p>Department.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Department</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Staff</span> <span class="hljs-variable">chief</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Staff</span>();<span class="hljs-comment">//注意：这里一定要new，否则映射不了  department.chief.name</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Department</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Department</span><span class="hljs-params">(String name, Staff chief)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.chief = chief;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Staff <span class="hljs-title function_">getChief</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> chief;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChief</span><span class="hljs-params">(Staff chief)</span> &#123;<br>        <span class="hljs-built_in">this</span>.chief = chief;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Department [name=&quot;</span> + name + <span class="hljs-string">&quot;, chief=&quot;</span> + chief + <span class="hljs-string">&quot;]&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>  <br><span class="hljs-meta">@RequestMapping(&quot;employee&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeController</span> &#123;  <br>    <span class="hljs-meta">@RequestMapping(&quot;read&quot;)</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, SAXException, InvalidFormatException&#123;  <br>        <span class="hljs-comment">//配置文件</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">xmlFin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;d:/test/read/xmlConfig.xml&quot;</span>));<br>        <span class="hljs-comment">//要导入的Excel</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">dataFin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;d:/test/read/departmentdata.xls&quot;</span>));<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputXML</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(xmlFin);<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputXLS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(dataFin);<br><br>        <span class="hljs-type">Department</span> <span class="hljs-variable">department</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Department</span>();<br><br>        List&lt;Staff&gt; employees = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Staff&gt;();<br><br>        Map&lt;String,Object&gt; beanparams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String,Object&gt;();<br><br>        beanparams.put(<span class="hljs-string">&quot;department&quot;</span>,department);<br>        beanparams.put(<span class="hljs-string">&quot;employees&quot;</span>,employees);<br><br>        <span class="hljs-type">XLSReader</span> <span class="hljs-variable">mainReader</span> <span class="hljs-operator">=</span> ReaderBuilder.buildFromXML(inputXML);<br>        <span class="hljs-type">XLSReadStatus</span> <span class="hljs-variable">readStatus</span> <span class="hljs-operator">=</span> mainReader.read(inputXLS,beanparams);<br>        <span class="hljs-comment">//测试</span><br>        System.out.println(department.toString());<br>        <span class="hljs-keyword">for</span> (Staff employee : employees) &#123;<br>            System.out.println(employee.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="十八、Spring缓存"><a href="#十八、Spring缓存" class="headerlink" title="十八、Spring缓存"></a>十八、Spring缓存</h2><blockquote>
<p>原理</p>
</blockquote>
<p>自动配置类：CacheAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 会自动导入缓存配置类</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfigurationImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>			CacheType[] types = CacheType.values();<br>			String[] imports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[types.length];<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; types.length; i++) &#123;<br>				imports[i] = CacheConfigurations.getConfigurationClass(types[i]);<br>			&#125;<br>			<span class="hljs-keyword">return</span> imports;<br>		&#125;<br><br>	&#125;<br></code></pre></td></tr></table></figure>

<p>导入缓存配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">缓存的配置类:<br>      org.springframework.boot.autoconfigure.cache.GenericCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.JCacheCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.EhCacheCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.HazelcastCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.InfinispanCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.CouchbaseCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.CaffeineCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.GuavaCacheConfiguration<br>      org.springframework.boot.autoconfigure.cache.SimpleCacheConfiguration【默认】<br>      org.springframework.boot.autoconfigure.cache.NoOpCacheConfiguration<br></code></pre></td></tr></table></figure>



<p>SimpleCacheConfiguration给容器中注册了一个CacheManager：ConcurrentMapCacheManager,底层实际是使用concurrentHashMap来实现的缓存</p>
<blockquote>
<p>注解</p>
</blockquote>
<p>一、@Cacheable: </p>
<p>标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；</p>
<p>运行流程：</p>
<ol>
<li><p>方法运行之前，先去查询Cache（缓存组件），按照cacheNames指定的名字获取；（CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建。</p>
</li>
<li><p>去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；</p>
<ul>
<li><pre><code class="hljs"> key是按照某种策略生成的；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；
</code></pre>
</li>
<li><pre><code class="hljs"> SimpleKeyGenerator生成key的默认策略；
</code></pre>
</li>
<li><pre><code class="hljs"> 如果没有参数；key=new SimpleKey()；
</code></pre>
</li>
<li><pre><code class="hljs"> 如果有一个参数：key=参数的值
</code></pre>
</li>
<li><pre><code class="hljs"> 如果有多个参数：key=new SimpleKey(params)；
</code></pre>
</li>
</ul>
</li>
<li><p>没有查到缓存就调用目标方法；</p>
</li>
<li><p>将目标方法返回的结果，放进缓存中</p>
</li>
</ol>
<p>核心：</p>
<ol>
<li>使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件</li>
<li>key使用keyGenerator生成的，默认是SimpleKeyGenerator</li>
</ol>
<p>几个属性：</p>
<ul>
<li><pre><code class="hljs"> cacheNames/value：指定缓存组件的名字;将方法的返回结果放在哪个缓存中，是数组的方式，可以指定多个缓存；
</code></pre>
</li>
<li><pre><code class="hljs"> key：缓存数据使用的key；可以用它来指定。默认是使用方法参数的值 
</code></pre>
</li>
<li><pre><code class="hljs"> keyGenerator：key的生成器；可以自己指定key的生成器的组件id（key/keyGenerator：二选一使用;）
</code></pre>
</li>
<li><pre><code class="hljs"> cacheManager：指定缓存管理器；或者cacheResolver指定获取解析器
</code></pre>
</li>
<li><pre><code class="hljs">  condition：指定符合条件的情况下才缓存；比如：condition = &quot;#id&gt;0&quot;；condition = &quot;#a0&gt;1&quot;：第一个参数的值 &gt; 1的时候才进行缓
</code></pre>
</li>
<li><pre><code class="hljs"> unless:否定缓存；当unless指定的条件为true，方法的返回值就不会被缓存；可以获取到结果进行判断。比如:unless = &quot;#result == null&quot;;unless = &quot;#a0==2&quot;:如果第一个参数的值是2，结果不缓存；
</code></pre>
</li>
<li><pre><code class="hljs"> sync：是否使用异步模式
</code></pre>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  @Cacheable(value = &#123;&quot;employee&quot;&#125;,key = &quot;#root.methodName + &#x27;[&#x27; +#id + &#x27;]&#x27;&quot;)</span><br>   <span class="hljs-meta">@Cacheable(value = &#123;&quot;employee&quot;&#125;, keyGenerator = &quot;customKeyGenerator&quot;)</span><br>   <span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">getEmp</span><span class="hljs-params">(Integer id)</span>&#123;<br>       System.out.println(<span class="hljs-string">&quot;查询&quot;</span>+id+<span class="hljs-string">&quot;号员工&quot;</span>);<br>       <span class="hljs-type">Employee</span> <span class="hljs-variable">emp</span> <span class="hljs-operator">=</span> employeeMapper.getEmpById(id);<br>       <span class="hljs-keyword">return</span> emp;<br>   &#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> org.springframework.cache.interceptor.KeyGenerator;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 自定义缓存keyGenerator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/08/27 2:13 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomCacheConfig</span> &#123;<br><br>  <span class="hljs-meta">@Bean(&quot;customKeyGenerator&quot;)</span><br>  <span class="hljs-keyword">public</span> KeyGenerator <span class="hljs-title function_">keyGenerator</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> (target, method, params) -&gt;<br>        method.getName() + Arrays.asList(params).toString();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>二、@CachePut:</p>
<p>既调用方法，又更新缓存数据；同步更新缓存</p>
<p>运行时机：</p>
<p>​	1、先调用目标方法</p>
<p>​	2、将目标方法的结果缓存起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CachePut(value = &quot;emp&quot;,key = &quot;#result.id&quot;)</span><br>   <span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">updateEmp</span><span class="hljs-params">(Employee employee)</span>&#123;<br>       System.out.println(<span class="hljs-string">&quot;updateEmp:&quot;</span>+employee);<br>       employeeMapper.updateEmp(employee);<br>       <span class="hljs-keyword">return</span> employee;<br>   &#125;<br></code></pre></td></tr></table></figure>





<p>三、@CacheEvict：缓存清除</p>
<ul>
<li><p>key：指定要清除的数据</p>
</li>
<li><p>allEntries &#x3D; true：指定清除这个缓存中所有的数据</p>
</li>
<li><p>beforeInvocation &#x3D; false：缓存的清除是否在方法之前执行</p>
</li>
<li><p>默认代表缓存清除操作是在方法执行之后执行;如果出现异常缓存就不会清除</p>
</li>
<li><p>beforeInvocation &#x3D; true：</p>
</li>
<li><pre><code class="hljs"> 代表清除缓存操作是在方法运行之前执行，无论方法是否出现异常，缓存都清除
</code></pre>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(value = &quot;emp&quot;, beforeInvocation = true, key = &quot;#id&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteEmp</span><span class="hljs-params">(Integer id)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;deleteEmp:&quot;</span> + id);<br>    employeeMapper.deleteEmpById(id);<br>  &#125;<br></code></pre></td></tr></table></figure>





<p>四、@Caching 定义复杂的缓存规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Caching(</span><br><span class="hljs-meta">      cacheable = &#123;</span><br><span class="hljs-meta">          @Cacheable(/*value=&quot;emp&quot;,*/key = &quot;#lastName&quot;)</span><br><span class="hljs-meta">      &#125;,</span><br><span class="hljs-meta">      put = &#123;</span><br><span class="hljs-meta">          @CachePut(/*value=&quot;emp&quot;,*/key = &quot;#result.id&quot;),</span><br><span class="hljs-meta">          @CachePut(/*value=&quot;emp&quot;,*/key = &quot;#result.email&quot;)</span><br><span class="hljs-meta">      &#125;,</span><br><span class="hljs-meta">      evict = &#123;</span><br><span class="hljs-meta">          @CacheEvict(cacheNames = &quot;sku&quot;, key = &quot;#skuId&quot;),</span><br><span class="hljs-meta">          @CacheEvict(cacheNames = &quot;skuList&quot;, key = &quot;#prodId&quot;)</span><br><span class="hljs-meta">  )</span><br>  <span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">getEmpByLastName</span><span class="hljs-params">(String lastName)</span> &#123;<br>    <span class="hljs-keyword">return</span> employeeMapper.getEmpByLastName(lastName);<br>  &#125;<br></code></pre></td></tr></table></figure>







<h2 id="十九、canal实现监听binlog"><a href="#十九、canal实现监听binlog" class="headerlink" title="十九、canal实现监听binlog"></a>十九、canal实现监听binlog</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.otter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>canal.client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2 <span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>demo</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.protocol.Message;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 基于canal实现mysql binLog监听</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/09/08 9:41 上午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalCommandLineRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//在canal部署的conf/canal.properties ip和端口信息</span><br>    <span class="hljs-type">CanalConnector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> CanalConnectors<br>        .newSingleConnector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;114.132.160.23&quot;</span>, <span class="hljs-number">11111</span>), <span class="hljs-string">&quot;example&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//打开连接</span><br>      connector.connect();<br>      <span class="hljs-comment">//订阅数据库表,全部表q</span><br>      <span class="hljs-comment">// connector.subscribe(&quot;.*\\..*&quot;);</span><br>      connector.subscribe(<span class="hljs-string">&quot;zhgd.new_project&quot;</span>);<br>      <span class="hljs-comment">//回滚到未进行ack的地方，下次fetch的时候，可以从最后一个没有ack的地方开始拿</span><br>      connector.rollback();<br>      <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// 获取指定数量的数据</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> connector.getWithoutAck(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">batchId</span> <span class="hljs-operator">=</span> message.getId();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> message.getEntries().size();<br>        <span class="hljs-keyword">if</span> (batchId &gt; <span class="hljs-number">0</span> &amp;&amp; size != <span class="hljs-number">0</span>) &#123;<br>          handleDATAChange(message.getEntries());<br>        &#125;<br>        <span class="hljs-comment">// 提交确认</span><br>        connector.ack(batchId);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(e.toString());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      connector.disconnect();<br>      <span class="hljs-comment">//防止频繁访问数据库链接: 线程睡眠 10秒</span><br>      <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        log.error(e.toString());<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDATAChange</span><span class="hljs-params">(List&lt;CanalEntry.Entry&gt; entrys)</span> &#123;<br>    <span class="hljs-keyword">for</span> (CanalEntry.Entry entry : entrys) &#123;<br>      <span class="hljs-comment">// 只解析mysql事务的操作，其他的不解析</span><br>      <span class="hljs-keyword">if</span> (entry.getEntryType() == CanalEntry.EntryType.TRANSACTIONBEGIN<br>          || entry.getEntryType() == CanalEntry.EntryType.TRANSACTIONEND) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      <span class="hljs-comment">//RowChange对象，包含了一行数据变化的所有特征</span><br>      CanalEntry.RowChange rowChange;<br>      <span class="hljs-keyword">try</span> &#123;<br>        rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;ERROR ## parser of eromanga-event has an error , data:&quot;</span> + entry.toString(), e);<br>      &#125;<br>      CanalEntry.<span class="hljs-type">EventType</span> <span class="hljs-variable">eventType</span> <span class="hljs-operator">=</span> rowChange.getEventType();<br>      <span class="hljs-comment">// 获取当前操作所属的数据库</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">dbName</span> <span class="hljs-operator">=</span> entry.getHeader().getSchemaName();<br>      <span class="hljs-comment">// 获取当前操作所属的表</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entry.getHeader().getTableName();<br><br>      <span class="hljs-comment">// 事务提交时间</span><br>      <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> entry.getHeader().getExecuteTime();<br><br>      log.info(<span class="hljs-string">&quot;Canal监测到更新:【&#123;&#125;】库的【&#123;&#125;】表&quot;</span>, dbName, tableName);<br><br>      <span class="hljs-keyword">for</span> (CanalEntry.RowData rowData : rowChange.getRowDatasList()) &#123;<br>        dataDetails(rowData.getBeforeColumnsList(), rowData.getAfterColumnsList(), dbName,<br>            tableName, eventType, timestamp);<br>        log.info(<span class="hljs-string">&quot;-------------------------------------------------------------&quot;</span>);<br>      &#125;<br><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 解析具体一条Binlog消息的数据</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> dbName    当前操作所属数据库名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> tableName 当前操作所属表名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> eventType 当前操作类型（新增、修改、删除）</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dataDetails</span><span class="hljs-params">(List&lt;CanalEntry.Column&gt; beforeColumns,</span><br><span class="hljs-params">      List&lt;CanalEntry.Column&gt; afterColumns,</span><br><span class="hljs-params">      String dbName,</span><br><span class="hljs-params">      String tableName,</span><br><span class="hljs-params">      CanalEntry.EventType eventType,</span><br><span class="hljs-params">      <span class="hljs-type">long</span> timestamp)</span> &#123;<br><br>    log.info(<span class="hljs-string">&quot;数据库：&#123;&#125;,表名:&#123;&#125;,操作类型:&#123;&#125;&quot;</span>, dbName, tableName, eventType);<br><br>    <span class="hljs-keyword">if</span> (CanalEntry.EventType.INSERT.equals(eventType)) &#123;<br>      log.info(<span class="hljs-string">&quot;新增数据：&quot;</span>);<br>      printColumn(afterColumns);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (CanalEntry.EventType.DELETE.equals(eventType)) &#123;<br>      log.info(<span class="hljs-string">&quot;删除数据：&quot;</span>);<br>      printColumn(beforeColumns);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      log.info(<span class="hljs-string">&quot;更新数据：更新前数据-----------------------------&quot;</span>);<br>      printColumn(beforeColumns);<br>      log.info(<span class="hljs-string">&quot;更新数据：更新后数据-----------------------------&quot;</span>);<br>      printColumn(afterColumns);<br>    &#125;<br>    log.info(<span class="hljs-string">&quot;操作时间：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd MM:ss&quot;</span>).format(timestamp));<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printColumn</span><span class="hljs-params">(List&lt;CanalEntry.Column&gt; columns)</span> &#123;<br>    <span class="hljs-keyword">for</span> (CanalEntry.Column column : columns) &#123;<br>      log.info(column.getName() + <span class="hljs-string">&quot; : &quot;</span> + column.getValue() + <span class="hljs-string">&quot;    update=&quot;</span> + column.getUpdated());<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="二十、Quartz定时任务"><a href="#二十、Quartz定时任务" class="headerlink" title="二十、Quartz定时任务"></a>二十、Quartz定时任务</h2><blockquote>
<p>导入sql</p>
</blockquote>
<p>执行quartz.sql</p>
<blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br> 	<span class="hljs-comment">## quartz定时任务,采用数据库方式</span><br>  <span class="hljs-attr">quartz:</span><br>    <span class="hljs-attr">job-store-type:</span> <span class="hljs-string">jdbc</span><br>    <span class="hljs-attr">initialize-schema:</span> <span class="hljs-string">embedded</span><br>    <span class="hljs-comment">#定时任务启动开关，true-开  false-关</span><br>    <span class="hljs-attr">auto-startup:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment">#延迟1秒启动定时任务</span><br>    <span class="hljs-attr">startup-delay:</span> <span class="hljs-string">1s</span><br>    <span class="hljs-comment">#启动时更新己存在的Job</span><br>    <span class="hljs-attr">overwrite-existing-jobs:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">properties:</span><br>      <span class="hljs-attr">org:</span><br>        <span class="hljs-attr">quartz:</span><br>          <span class="hljs-attr">scheduler:</span><br>            <span class="hljs-attr">instanceName:</span> <span class="hljs-string">MyScheduler</span><br>            <span class="hljs-attr">instanceId:</span> <span class="hljs-string">AUTO</span><br>          <span class="hljs-attr">jobStore:</span><br>            <span class="hljs-attr">class:</span> <span class="hljs-string">org.springframework.scheduling.quartz.LocalDataSourceJobStore</span><br>            <span class="hljs-attr">driverDelegateClass:</span> <span class="hljs-string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span><br>            <span class="hljs-attr">tablePrefix:</span> <span class="hljs-string">QRTZ_</span><br>            <span class="hljs-attr">isClustered:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">misfireThreshold:</span> <span class="hljs-number">12000</span><br>            <span class="hljs-attr">clusterCheckinInterval:</span> <span class="hljs-number">15000</span><br>          <span class="hljs-attr">threadPool:</span><br>            <span class="hljs-attr">class:</span> <span class="hljs-string">org.quartz.simpl.SimpleThreadPool</span><br>            <span class="hljs-attr">threadCount:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">threadPriority:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">threadsInheritContextClassLoaderOfInitializingThread:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>





<blockquote>
<p>实体类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.format.annotation.DateTimeFormat;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> quartz定时任务管理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 16:09</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;sys_quartz_job&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuartzJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * id</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@TableId(type = IdType.ASSIGN_ID)</span><br>  <span class="hljs-keyword">private</span> String id;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建人</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String createBy;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建时间</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>  <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>  <span class="hljs-keyword">private</span> Date createTime;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除状态</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Integer delFlag;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 修改人</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String updateBy;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 修改时间</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>  <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>  <span class="hljs-keyword">private</span> Date updateTime;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 任务类名</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String jobClassName;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * cron表达式</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String cronExpression;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 参数</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String parameter;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 描述</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String description;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 状态 0正常 -1停止</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Integer status;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>service</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.gz.demoweb.quartz.entity.QuartzJob;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> org.quartz.SchedulerException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 定时任务在线管理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 16:17</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">QuartzJobService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;QuartzJob&gt; &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 通过类名寻找定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> jobClassName 类名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> List&lt;QuartzJob&gt;</span><br><span class="hljs-comment">   */</span><br>  List&lt;QuartzJob&gt; <span class="hljs-title function_">findByJobClassName</span><span class="hljs-params">(String jobClassName)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 保存定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveAndScheduleJob</span><span class="hljs-params">(QuartzJob quartzJob)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 编辑定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> SchedulerException</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">editAndScheduleJob</span><span class="hljs-params">(QuartzJob quartzJob)</span> <span class="hljs-keyword">throws</span> SchedulerException;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">deleteAndStopJob</span><span class="hljs-params">(QuartzJob quartzJob)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 恢复定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeJob</span><span class="hljs-params">(QuartzJob quartzJob)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 执行定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(QuartzJob quartzJob)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 暂停任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> SchedulerException</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">pause</span><span class="hljs-params">(QuartzJob quartzJob)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>mapper</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.gz.demoweb.quartz.entity.QuartzJob;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 定时任务在线管理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 16:20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">QuartzJobMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;QuartzJob&gt; &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据jobClassName查询</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> jobClassName 任务类名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  List&lt;QuartzJob&gt; <span class="hljs-title function_">findByJobClassName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;jobClassName&quot;)</span> String jobClassName)</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.gz.demoweb.quartz.mapper.QuartzJobMapper&quot;</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- 根据jobClassName查询 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByJobClassName&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.gz.demoweb.quartz.entity.QuartzJob&quot;</span>&gt;</span><br>		select * from  sys_quartz_job  where job_class_name = #&#123;jobClassName&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>







<blockquote>
<p>controller</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.metadata.IPage;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.gz.demoweb.entity.Result;<br><span class="hljs-keyword">import</span> com.gz.demoweb.quartz.entity.QuartzJob;<br><span class="hljs-keyword">import</span> com.gz.demoweb.quartz.service.QuartzJobService;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.quartz.SchedulerException;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 定时任务在线管理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 16:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/sys/quartzJob&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuartzJobController</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> QuartzJobService quartzJobService;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 分页列表查询</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> pageNo</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> pageSize</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/list&quot;, method = RequestMethod.GET)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; queryPageList(<span class="hljs-meta">@RequestParam(name = &quot;pageNo&quot;, defaultValue = &quot;1&quot;)</span> Integer pageNo,<br>      <span class="hljs-meta">@RequestParam(name = &quot;pageSize&quot;, defaultValue = &quot;10&quot;)</span> Integer pageSize) &#123;<br>    Page&lt;QuartzJob&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;QuartzJob&gt;(pageNo, pageSize);<br>    IPage&lt;QuartzJob&gt; pageList = quartzJobService.page(page);<br>    <span class="hljs-keyword">return</span> Result.ok(pageList);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 添加定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; add(<span class="hljs-meta">@RequestBody</span> QuartzJob quartzJob) &#123;<br>    quartzJobService.saveAndScheduleJob(quartzJob);<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;创建定时任务成功&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 更新定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> quartzJob</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/edit&quot;, method = &#123;RequestMethod.PUT, RequestMethod.POST&#125;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; edit(<span class="hljs-meta">@RequestBody</span> QuartzJob quartzJob) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      quartzJobService.editAndScheduleJob(quartzJob);<br>    &#125; <span class="hljs-keyword">catch</span> (SchedulerException e) &#123;<br>      log.error(e.getMessage(), e);<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;更新定时任务失败!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;更新定时任务成功!&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 通过id删除</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/delete&quot;, method = RequestMethod.DELETE)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; delete(<span class="hljs-meta">@RequestParam(name = &quot;id&quot;, required = true)</span> String id) &#123;<br>    <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">quartzJob</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>    <span class="hljs-keyword">if</span> (quartzJob == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;未找到对应实体&quot;</span>);<br>    &#125;<br>    quartzJobService.deleteAndStopJob(quartzJob);<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;删除成功!&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 批量删除</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/deleteBatch&quot;, method = RequestMethod.DELETE)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; deleteBatch(<span class="hljs-meta">@RequestParam(name = &quot;ids&quot;, required = true)</span> String ids) &#123;<br>    <span class="hljs-keyword">if</span> (ids == <span class="hljs-literal">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(ids.trim())) &#123;<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;参数不识别！&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (String id : ids.split(<span class="hljs-string">&quot;,&quot;</span>)) &#123;<br>      <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>      quartzJobService.deleteAndStopJob(job);<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;删除定时任务成功!&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 暂停定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@GetMapping(value = &quot;/pause&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;Object&gt; <span class="hljs-title function_">pauseJob</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;id&quot;)</span> String id)</span> &#123;<br>    <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>    <span class="hljs-keyword">if</span> (job == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;定时任务不存在！&quot;</span>);<br>    &#125;<br>    quartzJobService.pause(job);<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;停止定时任务成功&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 启动定时任务</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@GetMapping(value = &quot;/resume&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;Object&gt; <span class="hljs-title function_">resumeJob</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;id&quot;)</span> String id)</span> &#123;<br>    <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>    <span class="hljs-keyword">if</span> (job == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;定时任务不存在！&quot;</span>);<br>    &#125;<br>    quartzJobService.resumeJob(job);<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;启动定时任务成功&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 通过id查询</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@RequestMapping(value = &quot;/queryById&quot;, method = RequestMethod.GET)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; queryById(<span class="hljs-meta">@RequestParam(name = &quot;id&quot;, required = true)</span> String id) &#123;<br>    <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">quartzJob</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>    <span class="hljs-keyword">return</span> Result.ok(quartzJob);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 立即执行</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@GetMapping(&quot;/execute&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;?&gt; execute(<span class="hljs-meta">@RequestParam(name = &quot;id&quot;, required = true)</span> String id) &#123;<br>    <span class="hljs-type">QuartzJob</span> <span class="hljs-variable">quartzJob</span> <span class="hljs-operator">=</span> quartzJobService.getById(id);<br>    <span class="hljs-keyword">if</span> (quartzJob == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;未找到对应实体&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      quartzJobService.execute(quartzJob);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.info(<span class="hljs-string">&quot;定时任务 立即执行失败&gt;&gt;&quot;</span> + e.getMessage());<br>      <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;执行失败!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-string">&quot;执行成功!&quot;</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>实战</p>
</blockquote>
<ol>
<li>不带参数的定时任务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 示例不带参定时任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 16:48</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">sampleJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Job</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(JobExecutionContext jobExecutionContext)</span> <span class="hljs-keyword">throws</span> JobExecutionException &#123;<br>    System.out.println(<span class="hljs-string">&quot;测试不带参数定时任务: &quot;</span> + DateUtils.getTimestamp());<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>带参数的定时任务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.gz.demoweb.util.DateUtils;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.quartz.Job;<br><span class="hljs-keyword">import</span> org.quartz.JobExecutionContext;<br><span class="hljs-keyword">import</span> org.quartz.JobExecutionException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 示例带参定时任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/25 17:24</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleParamJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Job</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 若参数变量名修改 QuartzJobController中也需对应修改</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String parameter;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameter</span><span class="hljs-params">(String parameter)</span> &#123;<br>    <span class="hljs-built_in">this</span>.parameter = parameter;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(JobExecutionContext jobExecutionContext)</span> <span class="hljs-keyword">throws</span> JobExecutionException &#123;<br>    log.info(<span class="hljs-string">&quot; Job Execution key：&quot;</span> + jobExecutionContext.getJobDetail().getKey());<br>    log.info(String<br>        .format(<span class="hljs-string">&quot;welcome %s! Jeecg-Boot 带参数定时任务 SampleParamJob !   时间:&quot;</span> + DateUtils.now(),<br>            <span class="hljs-built_in">this</span>.parameter));<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>









<h2 id="二十一、SpringBoot配置动态定时任务"><a href="#二十一、SpringBoot配置动态定时任务" class="headerlink" title="二十一、SpringBoot配置动态定时任务"></a>二十一、SpringBoot配置动态定时任务</h2><blockquote>
<p>启动类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> wl</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/3/22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(DemoApplication.class, args);<br>        System.out.println(<span class="hljs-string">&quot;(*^▽^*)启动成功!!!(〃&#x27;▽&#x27;〃)&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>定时任务执行时间配置文件：task-config.ini</p>
</blockquote>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">printTime.cron</span>=<span class="hljs-number">0</span>/<span class="hljs-number">10</span> * * * * ?<br></code></pre></td></tr></table></figure>





<blockquote>
<p>定时任务执行类：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.Trigger;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.TriggerContext;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.SchedulingConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.config.ScheduledTaskRegistrar;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.support.CronTrigger;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br> <br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> wl</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/3/22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@PropertySource(&quot;classpath:/task-config.ini&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SchedulingConfigurer</span> &#123;<br> <br>    <span class="hljs-meta">@Value(&quot;$&#123;printTime.cron&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String cron;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureTasks</span><span class="hljs-params">(ScheduledTaskRegistrar taskRegistrar)</span> &#123;<br>        <span class="hljs-comment">// 动态使用cron表达式设置循环间隔</span><br>        taskRegistrar.addTriggerTask(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                log.info(<span class="hljs-string">&quot;Current time： &#123;&#125;&quot;</span>, LocalDateTime.now());<br>            &#125;<br>        &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Trigger</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">nextExecutionTime</span><span class="hljs-params">(TriggerContext triggerContext)</span> &#123;<br>                <span class="hljs-comment">// 使用CronTrigger触发器，可动态修改cron表达式来操作循环规则</span><br>                <span class="hljs-type">CronTrigger</span> <span class="hljs-variable">cronTrigger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronTrigger</span>(cron);<br>                <span class="hljs-type">Date</span> <span class="hljs-variable">nextExecutionTime</span> <span class="hljs-operator">=</span> cronTrigger.nextExecutionTime(triggerContext);<br>                <span class="hljs-keyword">return</span> nextExecutionTime;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>编写一个接口，使得可以通过调用接口动态修改该定时任务的执行时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.wl.demo.task.ScheduleTask;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> wl</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/3/22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduleTask scheduleTask;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TestController</span><span class="hljs-params">(ScheduleTask scheduleTask)</span> &#123;<br>        <span class="hljs-built_in">this</span>.scheduleTask = scheduleTask;<br>    &#125;<br> <br>    <span class="hljs-meta">@GetMapping(&quot;/updateCron&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateCron</span><span class="hljs-params">(String cron)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;new cron :&#123;&#125;&quot;</span>, cron);<br>        scheduleTask.setCron(cron);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="二十二-、pagehelper分页"><a href="#二十二-、pagehelper分页" class="headerlink" title="二十二 、pagehelper分页"></a>二十二 、pagehelper分页</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<p>有可能会出现依赖循环问题, 需要改下版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 分页插件 --&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>配置修改</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">pagehelper:</span><br>  <span class="hljs-comment">#指定数据库，不指定的话会默认自动检测数据库类型</span><br>  <span class="hljs-attr">helper-dialect:</span> <span class="hljs-string">mysql</span><br>  <span class="hljs-comment">#是否启用分页合理化。如果启用，当传入的当前页&lt;1时，会自动查询第一页的数据</span><br>  <span class="hljs-attr">reasonable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment">#默认值false，分页插件会从查询方法的参数值中，自动根据上面 params 配置的字段中取值，查找到合适的值时就会自动分页</span><br>  <span class="hljs-attr">support-methods-arguments:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment">#用于从对象中根据属性名取值</span><br>  <span class="hljs-attr">params:</span> <span class="hljs-string">count=countsql</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>实例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Page&lt;Brand&gt; <span class="hljs-title function_">selectBrandByPage</span><span class="hljs-params">(BrandConditionDTO brandConditionDTO)</span> &#123;<br>    PageHelper.startPage(brandConditionDTO.getPageNo(), brandConditionDTO.getPageSize());<br>    List&lt;Brand&gt; brands = brandMapper.findBrandByPage(brandConditionDTO.getBrandName());<br>    PageInfo&lt;Brand&gt; pageInfo = PageInfo.of(brands);<br>    <span class="hljs-keyword">return</span> PageConverter.convert2Page(pageInfo);<br>  &#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java">关于PageInfo这个类，源码如下：<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><span class="hljs-comment">//当前页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pageNum;<br><span class="hljs-comment">//每页的数量</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pageSize;<br><span class="hljs-comment">//当前页的数量</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;<br><span class="hljs-comment">//由于startRow 和endRow 不常用，这里说个具体的用法</span><br><span class="hljs-comment">//可以在页面中&quot;显示startRow 到endRow 共size 条数据&quot;</span><br><span class="hljs-comment">//当前页面第一个元素在数据库中的行号</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> startRow;<br><span class="hljs-comment">//当前页面最后一个元素在数据库中的行号</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> endRow;<br><span class="hljs-comment">//总记录数</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">long</span> total;<br><span class="hljs-comment">//总页数</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pages;<br><span class="hljs-comment">//结果集</span><br><span class="hljs-keyword">private</span> List list;<br><span class="hljs-comment">//前一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> prePage;<br><span class="hljs-comment">//下一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nextPage;<br><span class="hljs-comment">//是否为第一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isFirstPage</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//是否为最后一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isLastPage</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//是否有前一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasPreviousPage</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//是否有下一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNextPage</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//导航页码数</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> navigatePages;<br><span class="hljs-comment">//所有导航页号</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] navigatepageNums;<br><span class="hljs-comment">//导航条上的第一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> navigateFirstPage;<br><span class="hljs-comment">//导航条上的最后一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> navigateLastPage;<br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="二十三、oss对象存储"><a href="#二十三、oss对象存储" class="headerlink" title="二十三、oss对象存储"></a>二十三、oss对象存储</h2><blockquote>
<p>专业名词术语</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">存储空间</th>
<th>Bucket</th>
<th>存储空间是您用于存储对象（Object）的容器，所有的对象都必须隶属于某个存储空间。</th>
</tr>
</thead>
<tbody><tr>
<td align="center">对象&#x2F;文件</td>
<td>Object</td>
<td>对象是 OSS 存储数据的基本单元，也被称为OSS的文件。对象由元信息（Object Meta）、用户数据（Data）和文件名（Key）组成。对象由存储空间内部唯一的Key来标识。</td>
</tr>
<tr>
<td align="center">地域</td>
<td>Region</td>
<td>地域表示 OSS 的数据中心所在物理位置。您可以根据费用、请求来源等综合选择数据存储的地域。详情请查看<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31837.htm#concept-zt4-cvy-5db">OSS已经开通的Region</a>。</td>
</tr>
<tr>
<td align="center">访问域名</td>
<td>Endpoint</td>
<td>Endpoint 表示OSS对外服务的访问域名。OSS以HTTP RESTful API的形式对外提供服务，当访问不同地域的时候，需要不同的域名。通过内网和外网访问同一个地域所需要的域名也是不同的。具体的内容请参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31837.htm#concept-zt4-cvy-5db">各个Region对应的Endpoint</a>。</td>
</tr>
<tr>
<td align="center">访问密钥</td>
<td>AccessKey</td>
<td>AccessKey，简称 AK，指的是访问身份验证中用到的AccessKeyId 和AccessKeySecret。OSS通过使用AccessKeyId 和AccessKeySecret对称加密的方法来验证某个请求的发送者身份。AccessKeyId用于标识用户，AccessKeySecret是用户用于加密签名字符串和OSS用来验证签名字符串的密钥，其中AccessKeySecret 必须保密。</td>
</tr>
</tbody></table>
<blockquote>
<p>使用步骤</p>
</blockquote>
<ol>
<li>创建bucket</li>
</ol>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013212906266.png" srcset="/img/loading.gif" lazyload alt="image-20221013212906266"></p>
<ol start="2">
<li>配置accessKey</li>
</ol>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213434850.png" srcset="/img/loading.gif" lazyload alt="image-20221013213434850"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213509562.png" srcset="/img/loading.gif" lazyload alt="image-20221013213509562"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213654484.png" srcset="/img/loading.gif" lazyload alt="image-20221013213654484"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213736635.png" srcset="/img/loading.gif" lazyload alt="image-20221013213736635"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013213930585.png" srcset="/img/loading.gif" lazyload alt="image-20221013213930585"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221013214055547.png" srcset="/img/loading.gif" lazyload alt="image-20221013214055547"></p>
<blockquote>
<p>跨域配置</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221016144731903.png" srcset="/img/loading.gif" lazyload alt="image-20221016144731903"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221016144829546.png" srcset="/img/loading.gif" lazyload alt="image-20221016144829546"></p>
<blockquote>
<p>oss工具类</p>
</blockquote>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 阿里云-对象存储服务（OSS） --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun.oss<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.10.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-comment">&lt;!-- joda--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>常量配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 符号常量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 15:09</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SymbolConstants</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">COLON</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;:&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">COMMA</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;,&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPOT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SLASH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\\&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">BACKSLASH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">UNDERLINE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;_&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">LINE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">PERCENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;%&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">DOUBLE_PERCENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;%%&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">STAR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;*&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUESTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;?&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EQUAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;=&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">COMBINE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">NEW_LINE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAB</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;   &quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">STOP_SIGN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;、&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">NEXT_LINE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>文件类型枚举:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.Getter;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 图片上传类型枚举</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 15:57</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FileType</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 图片jpg</span><br><span class="hljs-comment">   */</span><br>  JPGANDPNG(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;image&quot;</span>, <span class="hljs-string">&quot;image/jpeg&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * excel</span><br><span class="hljs-comment">   */</span><br>  EXCEL(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;xls&quot;</span>, <span class="hljs-string">&quot;application/x-xls&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;xls&quot;</span>, <span class="hljs-string">&quot;xlsx&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * word</span><br><span class="hljs-comment">   */</span><br>  WORD(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;doc&quot;</span>, <span class="hljs-string">&quot;application/msword&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;doc&quot;</span>, <span class="hljs-string">&quot;docx&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * pdf</span><br><span class="hljs-comment">   */</span><br>  PDF(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;pdf&quot;</span>, <span class="hljs-string">&quot;application/pdf&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;pdf&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * ppt</span><br><span class="hljs-comment">   */</span><br>  PPT(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;ppt&quot;</span>, <span class="hljs-string">&quot;application/x-ppt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;ppt&quot;</span>, <span class="hljs-string">&quot;pptx&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * other</span><br><span class="hljs-comment">   */</span><br>  OTHER(<span class="hljs-number">5</span>, <span class="hljs-string">&quot;other&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;&quot;</span>&#125;),<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * text</span><br><span class="hljs-comment">   */</span><br>  TEXT(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-string">&quot;text/plain&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;txt&quot;</span>&#125;),<br>  ;<br><br>  <span class="hljs-keyword">private</span> Integer code;<br>  <span class="hljs-keyword">private</span> String desc;<br>  <span class="hljs-keyword">private</span> String contentType;<br>  <span class="hljs-keyword">private</span> String[] suffix;<br><br><br>  FileType(Integer code, String desc, String contentType, String[] suffix) &#123;<br>    <span class="hljs-built_in">this</span>.code = code;<br>    <span class="hljs-built_in">this</span>.desc = desc;<br>    <span class="hljs-built_in">this</span>.contentType = contentType;<br>    <span class="hljs-built_in">this</span>.suffix = suffix;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 枚举对象查询</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> code 对应的序号</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 图片上传类型</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileType <span class="hljs-title function_">getFileType</span><span class="hljs-params">(Integer code)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.nonNull(code)) &#123;<br>      FileType[] values = FileType.values();<br>      <span class="hljs-keyword">for</span> (FileType item : values) &#123;<br>        <span class="hljs-keyword">if</span> (item.getCode().equals(code)) &#123;<br>          <span class="hljs-keyword">return</span> item;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> OTHER;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 校验文件格式</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileSuffix 文件后缀</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 图片上传类型</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileType <span class="hljs-title function_">getUploadType</span><span class="hljs-params">(String fileSuffix)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(fileSuffix)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//将文件格式转为小写，方便比较</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> fileSuffix.toLowerCase();<br>    FileType[] values = FileType.values();<br>    <span class="hljs-comment">//遍历判断该后缀是否支持</span><br>    <span class="hljs-keyword">for</span> (FileType item : values) &#123;<br>      String[] suff = item.getSuffix();<br>      <span class="hljs-keyword">for</span> (String str : suff) &#123;<br>        <span class="hljs-keyword">if</span> (str.equals(suffix)) &#123;<br>          <span class="hljs-keyword">return</span> item;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断文件类型是office文档</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> code 类型序号</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否是office文档</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOfficeDocument</span><span class="hljs-params">(Integer code)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.isNull(code)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> WORD.getCode().equals(code) ||<br>        EXCEL.getCode().equals(code) ||<br>        PPT.getCode().equals(code);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断文件类型是office文档</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileType 文件类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否是office文档</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOfficeDocument</span><span class="hljs-params">(FileType fileType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.isNull(fileType)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> WORD.equals(fileType) ||<br>        EXCEL.equals(fileType) ||<br>        PPT.equals(fileType);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断需要转pdf的文件格式</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileType 文件类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否可以转pdf</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">needToPdf</span><span class="hljs-params">(FileType fileType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.isNull(fileType)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> WORD.equals(fileType) ||<br>        EXCEL.equals(fileType) ||<br>        PPT.equals(fileType) ||<br>        TEXT.equals(fileType);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断文件类型是否是excel</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> code 文件序号</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否是excel</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExcel</span><span class="hljs-params">(Integer code)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.nonNull(code)) &#123;<br>      <span class="hljs-keyword">return</span> EXCEL.getCode().equals(code);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据文件名称获取文件类型</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> name 文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件类型</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileType <span class="hljs-title function_">getUploadTypeByFileName</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(name)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//将文件名转为小写，方便比较</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> name.toLowerCase();<br>    FileType[] values = FileType.values();<br>    <span class="hljs-comment">//便利</span><br>    <span class="hljs-keyword">for</span> (FileType item : values) &#123;<br>      String[] suff = item.getSuffix();<br>      <span class="hljs-comment">//遍历</span><br>      <span class="hljs-keyword">for</span> (String str : suff) &#123;<br>        <span class="hljs-keyword">if</span> (name.contains(str)) &#123;<br>          <span class="hljs-keyword">return</span> item;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断是否为图片</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileType 文件类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否是图片</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isImage</span><span class="hljs-params">(FileType fileType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!Objects.isNull(fileType)) &#123;<br>      <span class="hljs-keyword">if</span> (fileType.getCode().equals(FileType.JPGANDPNG.getCode())) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断是否为文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileType 文件类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否为文件</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFile</span><span class="hljs-params">(FileType fileType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!Objects.isNull(fileType)) &#123;<br>      <span class="hljs-keyword">if</span> (fileType.getCode().equals(FileType.WORD.getCode()) ||<br>          fileType.getCode().equals(FileType.PDF.getCode()) ||<br>          fileType.getCode().equals(FileType.EXCEL.getCode())) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取文件后缀</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> name 文件全名</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件后缀</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">suffix</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(name)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> name.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>);<br>    <span class="hljs-keyword">return</span> name.substring(index + <span class="hljs-number">1</span>);<br>  &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>





<p>oss配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 阿里云oss配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 15:04</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliOssProperties</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 地域</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String ENDPOINT;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * AccessKey</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String ACCESS_KEY_ID;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * accessKeySecret</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String ACCESS_KEY_SECRET;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * bucketName</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String BUCKET_NAME;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 文件存储路径</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILE_DIR_LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;file/&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * dddd 过期时间，单位小时</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXPIRATION</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>  <br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 文件过期时间：10年</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HUNDRED</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 0 不可编辑 1.可编辑</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREVIEW_DOC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;imm/previewdoc,copy_0&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 默认最大大小 50M</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 默认的文件名最大长度 100</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_FILE_NAME_LENGTH</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * OSS默认的域名</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_DOMAIN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://oss-for-zhgd-file.oss-cn-shenzhen.aliyuncs.com/&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 预览用域名，需要在OSS提前配置，用这个域名替换默认的域名就可以预览</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">Second_Domain</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://pview.zghxsjy.com/&quot;</span>;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;oss.endPoint&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setENDPOINT</span><span class="hljs-params">(String ENDPOINT)</span> &#123;<br>    AliOssProperties.ENDPOINT = ENDPOINT;<br>  &#125;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;oss.accessKeyId&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccessKeyId</span><span class="hljs-params">(String accessKeyId)</span> &#123;<br>    ACCESS_KEY_ID = accessKeyId;<br>  &#125;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;oss.accessKeySecret&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccessKeySecret</span><span class="hljs-params">(String accessKeySecret)</span> &#123;<br>    ACCESS_KEY_SECRET = accessKeySecret;<br>  &#125;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;oss.bucketName&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBucketName</span><span class="hljs-params">(String bucketName)</span> &#123;<br>    BUCKET_NAME = bucketName;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">oss:</span><br>  <span class="hljs-attr">endPoint:</span> <span class="hljs-string">oss-cn-chengdu</span><br>  <span class="hljs-attr">bucketName:</span> <span class="hljs-string">gulimall-test-gz</span><br>  <span class="hljs-attr">accessKeyId:</span> <span class="hljs-string">LTAI5tAAwrmKqPqHQcpoGHzZ</span><br>  <span class="hljs-attr">accessKeySecret:</span> <span class="hljs-string">JpbNZauHLkk5nY5MiXdIqViXP0iC94</span><br></code></pre></td></tr></table></figure>







<p>文件返回信息封装:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.experimental.Accessors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 集采OSS云服务图片上传返回类型</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 14:52</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-meta">@ApiModel(&quot;上传文件返回信息&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileCloudOss</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4492385715419651734L</span>;<br><br>  <span class="hljs-meta">@ApiModelProperty(value = &quot;返回的url&quot;)</span><br>  <span class="hljs-keyword">private</span> String url;<br><br>  <span class="hljs-meta">@ApiModelProperty(&quot;文件在云存储上的key&quot;)</span><br>  <span class="hljs-keyword">private</span> String objectKey;<br><br>  <span class="hljs-meta">@ApiModelProperty(&quot;bucket&quot;)</span><br>  <span class="hljs-keyword">private</span> String bucketName;<br><br>  <span class="hljs-meta">@ApiModelProperty(&quot;fileName&quot;)</span><br>  <span class="hljs-keyword">private</span> String fileName;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>上传文件命名处理器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 命名处理抽象类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 14:56</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractNameHandle</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建名称+路径</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file 上传文件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 路径名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">createName</span><span class="hljs-params">(MultipartFile file)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.gz.mall.constant.SymbolConstants;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 通用命名处理器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 15:27</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonNameHandle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractNameHandle</span> &#123;<br>  <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createName</span><span class="hljs-params">(MultipartFile file)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/images/realtime/&quot;</span> + path + SymbolConstants.BACKSLASH + file.getOriginalFilename();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 文件名称命名器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 14:59</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileNameHandle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractNameHandle</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createName</span><span class="hljs-params">(MultipartFile file)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>));<br>    <span class="hljs-keyword">return</span> AliOssProperties.FILE_DIR_LOCATION + path + SymbolConstants.BACKSLASH + file<br>        .getOriginalFilename();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>文件上传处理器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.gz.mall.constant.FileType;<br><span class="hljs-keyword">import</span> com.gz.mall.entity.FileCloudOss;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 文件上传处理器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/13 22:33</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFileHandle</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取阿里云实例对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 阿里云实例对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AbstractFileHandle <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> OssFileHandle.getInstance();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地图片上传</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file 上传文件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件返回信息</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> FileCloudOss <span class="hljs-title function_">uploadLocal</span><span class="hljs-params">(MultipartFile file)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地图片上传</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file 上传文件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件返回信息</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">uploadLocalFile</span><span class="hljs-params">(MultipartFile file, AbstractNameHandle nameHandle)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 文件下载</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> url              文件路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> commonNameHandle 通用命名处理器</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 输入流</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> InputStream <span class="hljs-title function_">downLoad</span><span class="hljs-params">(String url, CommonNameHandle commonNameHandle)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取文件预览地址</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bucketName 存储容器名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileName   上传的文件名称</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileType   文件类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 文件预览地址</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getPreviewUrl</span><span class="hljs-params">(String bucketName, String fileName, FileType fileType)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取Oss文件名称</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file       文件上传对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> nameHandle 命名处理器</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Oss文件名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getOssFileName</span><span class="hljs-params">(MultipartFile file, AbstractNameHandle nameHandle)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.aliyun.oss.ClientException;<br><span class="hljs-keyword">import</span> com.aliyun.oss.HttpMethod;<br><span class="hljs-keyword">import</span> com.aliyun.oss.OSS;<br><span class="hljs-keyword">import</span> com.aliyun.oss.OSSClientBuilder;<br><span class="hljs-keyword">import</span> com.aliyun.oss.OSSException;<br><span class="hljs-keyword">import</span> com.aliyun.oss.model.GeneratePresignedUrlRequest;<br><span class="hljs-keyword">import</span> com.aliyun.oss.model.OSSObject;<br><span class="hljs-keyword">import</span> com.gz.mall.constant.AliOssProperties;<br><span class="hljs-keyword">import</span> com.gz.mall.constant.FileType;<br><span class="hljs-keyword">import</span> com.gz.mall.entity.FileCloudOss;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> oss文件上传处理器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 15:31</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OssFileHandle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFileHandle</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * oss 客户端</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OSS ossClient;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 初始化oss客户端</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">OssFileHandle</span><span class="hljs-params">()</span> &#123;<br>    ossClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OSSClientBuilder</span>().build(AliOssProperties.ENDPOINT,<br>        AliOssProperties.ACCESS_KEY_ID,<br>        AliOssProperties.ACCESS_KEY_SECRET);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取oss实例对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> oss实例对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OssFileHandle <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OssFileHandle</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> FileCloudOss <span class="hljs-title function_">uploadLocal</span><span class="hljs-params">(MultipartFile file)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> file.getInputStream();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">ossName</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString() + <span class="hljs-string">&quot;-&quot;</span> + file.getOriginalFilename();<br>      <span class="hljs-comment">//上传</span><br>      ossClient.putObject(AliOssProperties.BUCKET_NAME, ossName, inputStream);<br>      <span class="hljs-comment">//返回文件对象</span><br>      <span class="hljs-type">FileCloudOss</span> <span class="hljs-variable">fileCloudOss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileCloudOss</span>();<br>      fileCloudOss<br>          .setBucketName(AliOssProperties.BUCKET_NAME)<br>          .setObjectKey(ossName)<br>          .setFileName(file.getOriginalFilename())<br>          <span class="hljs-comment">//上传成功 获取访问的url</span><br>          .setUrl(getPreviewUrl(AliOssProperties.BUCKET_NAME, ossName,<br>              FileType.JPGANDPNG));<br>      ossClient.shutdown();<br>      <span class="hljs-keyword">return</span> fileCloudOss;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException | OSSException | ClientException ioException) &#123;<br>      log.error(ioException.toString());<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadLocalFile</span><span class="hljs-params">(MultipartFile file, AbstractNameHandle nameHandle)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (file.getSize() &gt; AliOssProperties.DEFAULT_MAX_SIZE) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传文件格式或者大小不正确&quot;</span>;<br>      &#125;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> FileType.suffix(file.getOriginalFilename());<br>      <span class="hljs-type">FileType</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> FileType.getUploadType(fileSuffix);<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> type.getCode();<br>      <span class="hljs-keyword">if</span> (FileType.isExcel(code) || FileType.PDF.getCode().equals(code) || FileType.WORD.getCode()<br>          .equals(code)) &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> file.getInputStream();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ossName</span> <span class="hljs-operator">=</span> getOssFileName(file, nameHandle);<br>        ossClient.putObject(AliOssProperties.BUCKET_NAME, ossName, inputStream);<br>        <span class="hljs-keyword">return</span> getPreviewUrl(AliOssProperties.BUCKET_NAME, ossName, FileType.JPGANDPNG);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传文件格式或者大小不正确&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException | OSSException | ClientException ioException) &#123;<br>      log.error(ioException.toString());<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">downLoad</span><span class="hljs-params">(String uri, CommonNameHandle commonNameHandle)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(uri)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-type">OSSObject</span> <span class="hljs-variable">ossObj</span> <span class="hljs-operator">=</span> ossClient.getObject(AliOssProperties.BUCKET_NAME, uri);<br>    <span class="hljs-keyword">return</span> ossObj.getObjectContent();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPreviewUrl</span><span class="hljs-params">(String bucketName, String fileName, FileType fileType)</span> &#123;<br>    <span class="hljs-comment">// 填写签名URL的过期时间。2小时过期</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">expiration</span> <span class="hljs-operator">=</span> DateTime.now().plusHours(AliOssProperties.EXPIRATION).toDate();<br>    <span class="hljs-comment">//如果是图片，将时间拉长</span><br>    <span class="hljs-keyword">if</span> (FileType.isImage(fileType)) &#123;<br>      <span class="hljs-comment">// 10年过期</span><br>      expiration = DateTime.now().plusYears(AliOssProperties.HUNDRED).toDate();<br>    &#125;<br>    <span class="hljs-comment">// 通过HTTP GET请求生成签名URL。</span><br>    <span class="hljs-type">GeneratePresignedUrlRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneratePresignedUrlRequest</span>(bucketName, fileName,<br>        HttpMethod.GET);<br>    <span class="hljs-comment">//如果是图片直接返回url就可以预览</span><br>    <span class="hljs-keyword">if</span> (FileType.isImage(fileType)) &#123;<br>      <span class="hljs-comment">// 设置样式，样式中包含文档预览参数。</span><br>      request.setProcess(AliOssProperties.PREVIEW_DOC);<br>    &#125;<br>    request.setExpiration(expiration);<br>    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ossClient.generatePresignedUrl(request);<br>    <span class="hljs-comment">// 关闭OSSClient。</span><br>    ossClient.shutdown();<br>    <span class="hljs-comment">//默认的浏览地址 该地址只能下载 不能预览 需要更换为二级域名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultUrl</span> <span class="hljs-operator">=</span> url.toString();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">replace</span> <span class="hljs-operator">=</span> defaultUrl<br>        .replace(AliOssProperties.DEFAULT_DOMAIN, AliOssProperties.Second_Domain);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">replace1</span> <span class="hljs-operator">=</span> replace.replace(<span class="hljs-string">&quot;https://&quot;</span>, <span class="hljs-string">&quot;http://&quot;</span>);<br>    <span class="hljs-comment">//保留简短的文件预览地址去除?Expires 以及以后的字符串</span><br>    <span class="hljs-comment">// 把http://pview.zghxsjy.com/7bc7c9dd-e873-442b-9b81-5f01cc7551d2-444444.jpg?Expires=1976949930&amp;OSSAccessKeyId=LTAI5tEXqSc4Z1ezE45rnq8x&amp;Signature=BSaj1kWxh%2FcxhPJ11vo%2FY2cdgi4%3D</span><br>    <span class="hljs-comment">// 变为http://pview.zghxsjy.com/7bc7c9dd-e873-442b-9b81-5f01cc7551d2-444444.jpg进行存储</span><br>    replace1 = replace1.substring(<span class="hljs-number">0</span>, replace1.indexOf(<span class="hljs-string">&quot;?Expires&quot;</span>));<br>    <span class="hljs-keyword">return</span> replace1;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOssFileName</span><span class="hljs-params">(MultipartFile file, AbstractNameHandle nameHandle)</span> &#123;<br>    <span class="hljs-comment">//没有命名处理器，使用默认的文件名储存 存在bucket的img目录下</span><br>    <span class="hljs-keyword">if</span> (Objects.isNull(nameHandle)) &#123;<br>      <span class="hljs-keyword">return</span> AliOssProperties.FILE_DIR_LOCATION + UUID.randomUUID().toString() + <span class="hljs-string">&quot;_&quot;</span><br>          + file<br>          .getName();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//在img目录下创建当日日期命名的文件夹，并上传到该文件夹</span><br>      <span class="hljs-keyword">return</span> nameHandle.createName(file);<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>相关接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 文件上传服务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 17:21</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UploadService</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传图片</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> multipartFile 文件上传对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 上传文件返回信息</span><br><span class="hljs-comment">   */</span><br>  FileCloudOss <span class="hljs-title function_">uploadImg</span><span class="hljs-params">(MultipartFile multipartFile)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传pdf</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> multipartFile 文件上传对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 上传文件返回信息</span><br><span class="hljs-comment">   */</span><br>  FileCloudOss <span class="hljs-title function_">uploadPdf</span><span class="hljs-params">(MultipartFile multipartFile)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 下载文件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> fileUrl  文件路径</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> response 响应流</span><br><span class="hljs-comment">   */</span><br>  InputStream <span class="hljs-title function_">download</span><span class="hljs-params">(String fileUrl, HttpServletResponse response)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 文件上传实现类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/10/14 17:23</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UploadService</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> FileCloudOss <span class="hljs-title function_">uploadImg</span><span class="hljs-params">(MultipartFile multipartFile)</span> &#123;<br>    <span class="hljs-comment">//判断是否为图片格式</span><br>    <span class="hljs-type">FileType</span> <span class="hljs-variable">fileType</span> <span class="hljs-operator">=</span> FileType.getUploadTypeByFileName(multipartFile.getOriginalFilename());<br>    <span class="hljs-keyword">if</span> (Objects.isNull(fileType) || !fileType.getCode().equals(FileType.JPGANDPNG.getCode())) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.IMAGE_FORMAT_FAIL);<br>    &#125;<br>    <span class="hljs-comment">//判断文件的大小是否大于5M</span><br>    <span class="hljs-keyword">if</span> (multipartFile.getSize() &gt; FileSizeEnum.MB.getSize() * <span class="hljs-number">5L</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.FILE_IS_TOO_LARGE);<br>    &#125;<br>    <span class="hljs-comment">//图片上传逻辑</span><br>    <span class="hljs-keyword">return</span> AbstractFileHandle.getInstance()<br>        .uploadLocal(multipartFile);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> FileCloudOss <span class="hljs-title function_">uploadPdf</span><span class="hljs-params">(MultipartFile multipartFile)</span> &#123;<br>    <span class="hljs-comment">//判断是否为图片格式</span><br>    <span class="hljs-type">FileType</span> <span class="hljs-variable">fileType</span> <span class="hljs-operator">=</span> FileType.getUploadTypeByFileName(multipartFile.getOriginalFilename());<br>    <span class="hljs-keyword">if</span> (Objects.isNull(fileType) || !fileType.getCode().equals(FileType.PDF.getCode())) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.IMAGE_FORMAT_FAIL);<br>    &#125;<br>    <span class="hljs-comment">//判断文件的大小是否大于50M</span><br>    <span class="hljs-keyword">if</span> (multipartFile.getSize() &gt; FileSizeEnum.MB.getSize() * <span class="hljs-number">5L</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(ExceptionCodeEnum.FILE_IS_TOO_LARGE);<br>    &#125;<br>    <span class="hljs-comment">//图片上传逻辑</span><br>    <span class="hljs-keyword">return</span> AbstractFileHandle.getInstance()<br>        .uploadLocal(multipartFile);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">download</span><span class="hljs-params">(String fileUrl, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-keyword">return</span> AbstractFileHandle.getInstance().downLoad(fileUrl, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonNameHandle</span>());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/licenseImgs&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(value = &quot;上传相关接口(oss)&quot;, tags = &quot;图片上传接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadController</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> UploadService uploadService;<br><br>  <span class="hljs-meta">@PostMapping(&quot;/uploadSingleImg&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(value = &quot;图片上传&quot;, notes = &quot;图片上传&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;FileCloudOss&gt; <span class="hljs-title function_">uploadImg</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestPart(&quot;file&quot;)</span> MultipartFile multipartFile)</span> &#123;<br>    <span class="hljs-type">FileCloudOss</span> <span class="hljs-variable">fileCloudDTO</span> <span class="hljs-operator">=</span> uploadService.uploadImg(multipartFile);<br>    <span class="hljs-keyword">return</span> Result.success(fileCloudDTO);<br>  &#125;<br><br>  <span class="hljs-meta">@PostMapping(&quot;/uploadBatchImgs&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(value = &quot;图片上传批量&quot;, notes = &quot;图片上传&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;List&lt;FileCloudOss&gt;&gt; <span class="hljs-title function_">uploadImgs</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-meta">@RequestPart(value = &quot;file&quot;, required = false)</span> MultipartFile[] multipartFiles)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Objects.isNull(multipartFiles) || multipartFiles.length == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    ArrayList&lt;FileCloudOss&gt; fileCloudDTOS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (MultipartFile multipartFile : multipartFiles) &#123;<br>      <span class="hljs-type">FileCloudOss</span> <span class="hljs-variable">fileCloudDTO</span> <span class="hljs-operator">=</span> uploadService.uploadImg(multipartFile);<br>      fileCloudDTOS.add(fileCloudDTO);<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.success(fileCloudDTOS);<br>  &#125;<br><br>  <span class="hljs-meta">@PostMapping(&quot;/uploadPdf&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(value = &quot;PDF文件上传&quot;, notes = &quot;文件上传&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;FileCloudOss&gt; <span class="hljs-title function_">uploadPdf</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart(&quot;file&quot;)</span> MultipartFile multipartFile)</span> &#123;<br>    <span class="hljs-type">FileCloudOss</span> <span class="hljs-variable">fileCloudDTO</span> <span class="hljs-operator">=</span> uploadService.uploadPdf(multipartFile);<br>    fileCloudDTO.setFileName(multipartFile.getOriginalFilename());<br>    <span class="hljs-keyword">return</span> Result.success(fileCloudDTO);<br>  &#125;<br><br>  <span class="hljs-meta">@GetMapping(&quot;/download&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(value = &quot;文件下载&quot;, notes = &quot;文件下载&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">download</span><span class="hljs-params">(String fileUrl, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> uploadService.download(fileUrl, response);<br>      <span class="hljs-comment">// 配置文件下载</span><br>      response.setHeader(<span class="hljs-string">&quot;content-type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>      response.setContentType(<span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>      <span class="hljs-comment">// 下载文件能正常显示中文</span><br>      response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + URLEncoder<br>          .encode(fileUrl, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>      <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>      <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>      <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">while</span> ((len = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>        os.write(b, <span class="hljs-number">0</span>, len);<br>      &#125;<br>      in.close();<br>      os.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(<span class="hljs-string">&quot;文件下载失败&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@GetMapping(value = &quot;/preview&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(value = &quot;PDF文件预览&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reviewPriceData</span><span class="hljs-params">(String pdfPath,</span><br><span class="hljs-params">      HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 获取pdf文件路径（包括文件名）</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> uploadService.download(pdfPath, response);<br>    <span class="hljs-comment">// 设置输出的格式</span><br>    response.setContentType(<span class="hljs-string">&quot;application/pdf&quot;</span>);<br>    <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">while</span> ((count = in.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>      outputStream.write(buffer, <span class="hljs-number">0</span>, count);<br>    &#125;<br>    outputStream.flush();<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>









<h2 id="二十四、redis工具类"><a href="#二十四、redis工具类" class="headerlink" title="二十四、redis工具类"></a>二十四、redis工具类</h2><blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>yaml配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-comment"># Redis服务器地址</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">19.1</span><span class="hljs-number">.5</span><span class="hljs-number">.11</span><br>    <span class="hljs-comment"># Redis服务器端口号</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-comment"># 使用的数据库索引，默认是0</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 连接超时时间</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800000</span><br>     <span class="hljs-comment"># 设置密码</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;123456&quot;</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-comment"># 最大阻塞等待时间，负数表示没有限制</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">-1</span><br>        <span class="hljs-comment"># 连接池中的最大空闲连接</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 连接池中的最小空闲连接</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 连接池中最大连接数，负数表示没有限制</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>redis序列化配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * redis配置类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2022年4月22日</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br>  <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>    RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;String, Object&gt;();<br>    template.setConnectionFactory(factory);<br>    <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(<br>        Object.class);<br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>    om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>    om.registerModule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaTimeModule</span>());<br>    jackson2JsonRedisSerializer.setObjectMapper(om);<br>    <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br><br>    <span class="hljs-comment">// key采用String的序列化方式</span><br>    template.setKeySerializer(stringRedisSerializer);<br><br>    <span class="hljs-comment">// hash的key也采用String的序列化方式</span><br>    template.setHashKeySerializer(stringRedisSerializer);<br><br>    <span class="hljs-comment">// value序列化方式采用jackson</span><br>    template.setValueSerializer(jackson2JsonRedisSerializer);<br><br>    <span class="hljs-comment">// hash的value序列化方式采用jackson</span><br>    template.setHashValueSerializer(jackson2JsonRedisSerializer);<br><br>    template.afterPropertiesSet();<br>    <span class="hljs-keyword">return</span> template;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>redis工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.hutool.core.util.BooleanUtil;<br><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;<br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.function.Function;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.dao.DataAccessException;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnection;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisStringCommands;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.BoundListOperations;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisCallback;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.types.Expiration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> redis工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/11/08 13:44</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUtils</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MUTEX_LOCK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mutex:key:&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Long</span> <span class="hljs-variable">CACHE_NULL_TTL</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//string 类型操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置新的value</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key   redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time  过期时间</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> unit  时间单位</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>    redisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置新value并返回之前的值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 之前存储的值</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">set</span><span class="hljs-params">(String k, Object value)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> redisTemplate.boundValueOps(k).getAndSet(JSONUtil.toJsonStr(value));<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == o ? <span class="hljs-literal">null</span> : (T) o;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置新value并返回之前的值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time  设置过期时间，默认毫秒</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 之前存储的值</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">set</span><span class="hljs-params">(String k, T value, <span class="hljs-type">long</span> time)</span> &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> set(k, value);<br>    expire(k, time);<br>    <span class="hljs-keyword">return</span> pre;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置新value并返回之前的值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k        redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value    key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time     设置过期时间</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeUnit 过期时间对应的时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 之前存储的值</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">set</span><span class="hljs-params">(String k, Object value, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> set(k, value);<br>    expire(k, time, timeUnit);<br>    <span class="hljs-keyword">return</span> pre;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据key获取值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 对应的value</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">get</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-keyword">return</span> (T) redisTemplate.boundValueOps(k).get();<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//list 类型操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 存储一个新的list，如果旧key存在，则会删除旧key</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lset</span><span class="hljs-params">(String k, List value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (hasKey(k)) &#123;<br>      deleteKey(k);<br>    &#125;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundListOps(k).rightPushAll(value.toArray());<br>    <span class="hljs-keyword">return</span> Objects.equals(count, Long.valueOf(value.size()));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 存储一个新的list，如果旧key存在，则会删除旧key</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time  过期时间，默认毫秒</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lset</span><span class="hljs-params">(String k, List value, <span class="hljs-type">long</span> time)</span> &#123;<br>    <span class="hljs-keyword">return</span> lset(k, value, time, TimeUnit.MILLISECONDS);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 存储一个新的list，如果旧key存在，则会删除旧key</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k        redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value    key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time     过期时间</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeUnit 过期时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lset</span><span class="hljs-params">(String k, List value, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> lset(k, value);<br>    <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>      redisTemplate.expire(k, time, timeUnit);<br>    &#125;<br>    <span class="hljs-keyword">return</span> isSuccess;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 为已有的list追加新值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#addAll(Collection)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#add(Object)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">ladd</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">preSize</span> <span class="hljs-operator">=</span> lsize(k);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundListOps(k).rightPushAll(value);<br>    <span class="hljs-keyword">return</span> Objects.equals(count, Long.valueOf(value.length + preSize));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取list的所有value</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> list value</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">lget</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-keyword">return</span> redisTemplate.boundListOps(k).range(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 由于list存在重复元素，该方法从左往右移除第一个匹配的value</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value 要移除的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#remove(Object)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#removeAll(Collection)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lremove</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-type">BoundListOperations</span> <span class="hljs-variable">operations</span> <span class="hljs-operator">=</span> redisTemplate.boundListOps(k);<br>    <span class="hljs-keyword">for</span> (Object o : value) &#123;<br>      operations.remove(<span class="hljs-number">1</span>, o);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 从左往右移除list所有匹配的value</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value 要移除的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否成功（true/false)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#remove(Object)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> List#removeAll(Collection)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lremoveAll</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-type">BoundListOperations</span> <span class="hljs-variable">operations</span> <span class="hljs-operator">=</span> redisTemplate.boundListOps(k);<br>    <span class="hljs-keyword">for</span> (Object o : value) &#123;<br>      operations.remove(<span class="hljs-number">0</span>, o);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 返回list size</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> list size</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lsize</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> redisTemplate.boundListOps(k).size();<br>    <span class="hljs-keyword">return</span> size != <span class="hljs-literal">null</span> ? size.intValue() : <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//map 类型操作 redis hash</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 为map增加一个key-value组合</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key   map的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value map的value</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Map#put(Object, Object)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hput</span><span class="hljs-params">(String k, Object key, Object value)</span> &#123;<br>    redisTemplate.boundHashOps(k).put(key, value);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 增加一个map,并设置时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key   map的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value map的value</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Map#put(Object, Object)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hput</span><span class="hljs-params">(String key, Map&lt;String, Object&gt; map, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>    redisTemplate.opsForHash().putAll(key, map);<br>    <span class="hljs-keyword">if</span> (time &gt; <span class="hljs-number">0</span>) &#123;<br>      expire(key, time);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 增加一个map</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k   redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> map 增加的map</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Map#putAll(Map)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hput</span><span class="hljs-params">(String k, Map map)</span> &#123;<br>    redisTemplate.boundHashOps(k).putAll(map);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取map里指定key的值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k   redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key map中的某一个key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">hget</span><span class="hljs-params">(String k, Object key)</span> &#123;<br>    <span class="hljs-keyword">return</span> (T) redisTemplate.boundHashOps(k).get(key);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取map所有值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> redis map</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T, R&gt; Map&lt;T, R&gt; <span class="hljs-title function_">hEntrys</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-keyword">return</span> redisTemplate.boundHashOps(k).entries();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除map中指定的key</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k   redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key map中的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 成功删除的个数</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Map#remove(Object)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hdel</span><span class="hljs-params">(String k, Object... key)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundHashOps(k).delete(key);<br>    <span class="hljs-keyword">return</span> count == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : count.intValue();<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//set 类型操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置一个新set,如果旧set存在，先移除</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value set集合值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 添加成功的数量，不包含由于重复值导致已忽略的</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sset</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (hasKey(k)) &#123;<br>      deleteKey(k);<br>    &#125;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundSetOps(k).add(value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == count ? <span class="hljs-number">0</span> : count.intValue();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置一个新set,如果旧set存在，先移除</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time  过期时间，默认毫秒</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value set集合值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 添加成功的数量，不包含由于重复值导致已忽略的</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sset</span><span class="hljs-params">(String k, <span class="hljs-type">long</span> time, Object... value)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> sset(k, value);<br>    expire(k, time);<br>    <span class="hljs-keyword">return</span> res;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置一个新set,如果旧set存在，先移除</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k        redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time     过期时间</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value    set集合值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeUnit 过期时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 添加成功的数量，不包含由于重复值导致已忽略的</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sset</span><span class="hljs-params">(String k, <span class="hljs-type">long</span> time, TimeUnit timeUnit, Object... value)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> sset(k, value);<br>    expire(k, time, timeUnit);<br>    <span class="hljs-keyword">return</span> res;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 为已存在的set追加值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value 要追加的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 添加成功的数量，不包含由于重复值导致已忽略的</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Set#addAll(Collection)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Set#add(Object)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sadd</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundSetOps(k).add(value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == count ? <span class="hljs-number">0</span> : count.intValue();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取set集合</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; Set&lt;T&gt; <span class="hljs-title function_">sget</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-keyword">return</span> redisTemplate.boundSetOps(k).members();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 移除set中指定的值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k     redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value 要移除的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 成功移除的数量</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Set#removeAll(Collection)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> Set#remove(Object)</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sremove</span><span class="hljs-params">(String k, Object... value)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.boundSetOps(k).remove(value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == count ? <span class="hljs-number">0</span> : count.intValue();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 返回set size</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> k redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> set size</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ssize</span><span class="hljs-params">(String k)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> redisTemplate.boundSetOps(k).size();<br>    <span class="hljs-keyword">return</span> size != <span class="hljs-literal">null</span> ? size.intValue() : <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//redis key相关操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置key的过期时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key  redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time 过期时间</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> time)</span> &#123;<br>    redisTemplate.expire(key, time, TimeUnit.MILLISECONDS);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置key的过期时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key      redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time     过期时间</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> timeUnit 过期时间单位</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>    redisTemplate.expire(key, time, timeUnit);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除指定的key</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key 删除的key</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteKey</span><span class="hljs-params">(String key)</span> &#123;<br>    redisTemplate.delete(key);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定key的剩余过期时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 当 key 不存在时，返回 -2 ;当 key 存在但没有设置剩余生存时间时，返回 -1 。 否则，以秒为单位，返回 key 的剩余生存时间。</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getExpire</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-keyword">return</span> redisTemplate.getExpire(key);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 查询key是否存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否存在（true/false)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasKey</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-keyword">return</span> redisTemplate.hasKey(key);<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//redis pipeline操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 功能描述: 使用pipelined批量存储</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span>: [map, seconds]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span>: void</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executePipelined</span><span class="hljs-params">(Map&lt;String, String&gt; map, <span class="hljs-type">long</span> seconds)</span> &#123;<br>    RedisSerializer&lt;String&gt; serializer = redisTemplate.getStringSerializer();<br>    redisTemplate.executePipelined(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCallback</span>&lt;String&gt;() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doInRedis</span><span class="hljs-params">(RedisConnection connection)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>        map.forEach((key, value) -&gt; &#123;<br>          connection.set(serializer.serialize(key), serializer.serialize(value),<br>              Expiration.seconds(seconds), RedisStringCommands.SetOption.UPSERT);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;, serializer);<br>  &#125;<br><br>  <span class="hljs-comment">//*****************************************************</span><br>  <span class="hljs-comment">//redis 解决缓存穿透等相关操作</span><br>  <span class="hljs-comment">//*****************************************************</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置逻辑过期时间</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key   redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value key对应的值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time  时长</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> unit  时间单位</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithLogicalExpire</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>    <span class="hljs-comment">// 设置逻辑过期</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>    redisData.setData(value);<br>    redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));<br>    <span class="hljs-comment">// 写入Redis</span><br>    redisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 缓存查询数据，并解决缓存穿透</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> keyPrefix  redis key前缀</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id         该模块的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type       返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> dbFallback 查询数据库</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time       缓存时长</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> unit       时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;R&gt;        返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;ID&gt;       id类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 返回数据</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(</span><br><span class="hljs-params">      String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time,</span><br><span class="hljs-params">      TimeUnit unit)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + id;<br>    <span class="hljs-comment">// 1.从redis查询缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.判断是否存在</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>      <span class="hljs-comment">// 3.存在，直接返回</span><br>      <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>    &#125;<br>    <span class="hljs-comment">// 判断命中的是否是空值</span><br>    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 返回一个错误信息</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 4.不存在，根据id查询数据库</span><br>    <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>    <span class="hljs-comment">// 5.不存在，返回错误</span><br>    <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 将空值写入redis</span><br>      redisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>      <span class="hljs-comment">// 返回错误信息</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 6.存在，写入redis</span><br>    <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>    <span class="hljs-keyword">return</span> r;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 利用逻辑过期解决缓存击穿问题</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> keyPrefix  redis key前缀</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id         该模块的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type       返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> dbFallback 查询数据库</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time       缓存时长</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> unit       时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;R&gt;        返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;ID&gt;       id类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 返回数据</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">(</span><br><span class="hljs-params">      String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time,</span><br><span class="hljs-params">      TimeUnit unit)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>    <span class="hljs-comment">// 1.从redis查询缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.判断是否存在</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>      <span class="hljs-comment">// 3.存在，直接返回</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 4.命中，需要先把json反序列化为对象</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>    <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-comment">// 5.判断是否过期</span><br>    <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>      <span class="hljs-comment">// 5.1.未过期，直接返回店铺信息</span><br>      <span class="hljs-keyword">return</span> r;<br>    &#125;<br>    <span class="hljs-comment">// 5.2.已过期，需要缓存重建</span><br>    <span class="hljs-comment">// 6.缓存重建</span><br>    <span class="hljs-comment">// 6.1.获取互斥锁</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> MUTEX_LOCK_KEY + id;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-comment">// 6.2.判断是否获取锁成功</span><br>    <span class="hljs-keyword">if</span> (isLock) &#123;<br>      <span class="hljs-comment">// 6.3.成功，开启独立线程，实现缓存重建</span><br>      CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// 查询数据库</span><br>          <span class="hljs-type">R</span> <span class="hljs-variable">newR</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>          <span class="hljs-comment">// 重建缓存</span><br>          <span class="hljs-built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-comment">// 释放锁</span><br>          unlock(lockKey);<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-comment">// 6.4.返回过期的商铺信息</span><br>    <span class="hljs-keyword">return</span> r;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 利用互斥锁解决缓存穿透</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> keyPrefix  redis key前缀</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> id         该模块的key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type       返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> dbFallback 查询数据库</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> time       缓存时长</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> unit       时间单位</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;R&gt;        返回值类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;ID&gt;       id类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 返回数据</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(</span><br><span class="hljs-params">      String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time,</span><br><span class="hljs-params">      TimeUnit unit)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>    <span class="hljs-comment">// 1.从redis查询缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> String.valueOf(redisTemplate.opsForValue().get(key));<br>    <span class="hljs-comment">// 2.判断是否存在</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>      <span class="hljs-comment">// 3.存在，直接返回</span><br>      <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>    &#125;<br>    <span class="hljs-comment">// 判断命中的是否是空值</span><br>    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 返回一个错误信息</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 4.实现缓存重建</span><br>    <span class="hljs-comment">// 4.1.获取互斥锁</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> MUTEX_LOCK_KEY + id;<br>    <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>      <span class="hljs-comment">// 4.2.判断是否获取成功</span><br>      <span class="hljs-keyword">if</span> (!isLock) &#123;<br>        <span class="hljs-comment">// 4.3.获取锁失败，休眠并重试</span><br>        Thread.sleep(<span class="hljs-number">50</span>);<br>        <span class="hljs-keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);<br>      &#125;<br>      <span class="hljs-comment">// 4.4.获取锁成功，根据id查询数据库</span><br>      r = dbFallback.apply(id);<br>      <span class="hljs-comment">// 5.不存在，返回错误</span><br>      <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 将空值写入redis</span><br>        redisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">// 返回错误信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-comment">// 6.存在，写入redis</span><br>      <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// 7.释放锁</span><br>      unlock(lockKey);<br>    &#125;<br>    <span class="hljs-comment">// 8.返回</span><br>    <span class="hljs-keyword">return</span> r;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 尝试加锁</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key redis key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否加锁成功 true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 解锁</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key redis key</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> &#123;<br>    redisTemplate.delete(key);<br>  &#125;<br><br>  <span class="hljs-meta">@Data</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisData</span> &#123;<br><br>    <span class="hljs-keyword">private</span> LocalDateTime expireTime;<br>    <span class="hljs-keyword">private</span> Object data;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>









<h2 id="二十五、CompletableFuture异步编排"><a href="#二十五、CompletableFuture异步编排" class="headerlink" title="二十五、CompletableFuture异步编排"></a>二十五、CompletableFuture异步编排</h2><blockquote>
<p>创建异步对象</p>
</blockquote>
<p>completableFuture使用了四个静态方法来创建异步对象</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208110514058-0468719.png" srcset="/img/loading.gif" lazyload alt="image-20221208110514058"></p>
<ol>
<li>runXXX都是没有返回结果的,supplyXXX都是可以获取返回结果的</li>
<li>可以传入自定义的线程池,否则就会用默认的线程池</li>
</ol>
<blockquote>
<p>完成后的回调方法</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208110756763-0468878.png" srcset="/img/loading.gif" lazyload alt="image-20221208110756763"></p>
<p>whenComplete可以处理正常和异常的计算结果,exceptionally处理异常情况.</p>
<p>whenComplete和whenCompleteAsync的区别:</p>
<ol>
<li>whenComplete是执行当前任务的线程执行继续执行whenComplete的任务</li>
<li>whenCompleteAsync是执行把whenCompleteAsync这个任务继续提交给线程池来进行执行</li>
</ol>
<p><strong>方法不以Async结尾,意味着Action使用相同的线程执行,而Async可能会使用其他线程执行(如果是使用相同的线程池,也可能会被同一个线程选中执行)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completableFutureDemo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    CompletableFuture&lt;Object&gt; future = CompletableFuture.supplyAsync(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Supplier</span>&lt;Object&gt;() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;\t completableFuture&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;<br>      &#125;<br>    &#125;).whenComplete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BiConsumer</span>&lt;Object, Throwable&gt;() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Object o, Throwable throwable)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;o= &quot;</span> + o.toString());<br>        System.out.println(<span class="hljs-string">&quot;throwable= &quot;</span> + throwable);<br>      &#125;<br>    &#125;).exceptionally(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>&lt;Throwable, Object&gt;() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">apply</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;throwable= &quot;</span> + throwable);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">6666</span>;<br>      &#125;<br>    &#125;);<br>    System.out.println(future.get());<br>  &#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>handle方法</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112043652.png" srcset="/img/loading.gif" lazyload alt="image-20221208112043652"></p>
<p>和complete一样,可对结果做最后的处理(可处理异常),可改变返回值</p>
<blockquote>
<p>线程串行的方法</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112259603-0469781.png" srcset="/img/loading.gif" lazyload alt="image-20221208112259603"></p>
<ul>
<li>thenApply方法: 当一个线程依赖另一个线程时,获取上一个任务返回的结果,<strong>并返回当前任务的返回值</strong></li>
<li>thenAccept方法:消息处理结果.接收任务的处理结果,并消费处理,<strong>无返回结果</strong></li>
<li>thenRun方法:只要上面的任务执行完成,就开始执行thenRun,只是处理完任务后,执行thenRun的后续操作</li>
<li>带有Async默认都是异步执行</li>
<li>以上都必须前置任务成功完成. Function&lt;? superT,? extends U&gt;    T:上一个任务返回结果的类型,U:当前任务返回结果的类型</li>
</ul>
<blockquote>
<p>两个任务中任意一个任务完成</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112927527.png" srcset="/img/loading.gif" lazyload alt="image-20221208112927527"></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208112941485.png" srcset="/img/loading.gif" lazyload alt="image-20221208112941485"></p>
<p>当两个任务中,任意一个future任务完成的时候,执行任务.</p>
<ul>
<li>applyToEither: 两个任务又一个执行完成,获取它的返回值,处理任务并有新的返回值</li>
<li>acceptEither: 两个任务有一个执行完成,获取它的返回值,处理任务,没有返回值</li>
<li>runAfterEither: 两个任务有一个执行完成,不需要获取future的结果,处理任务,也没有返回值</li>
</ul>
<blockquote>
<p>多任务组合</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221208130727584.png" srcset="/img/loading.gif" lazyload alt="image-20221208130727584"></p>
<ul>
<li>allOf: 等待所有任务完成</li>
<li>any Of: 只要有一个任务完成</li>
</ul>
<h2 id="二十六、腾讯云短信发送"><a href="#二十六、腾讯云短信发送" class="headerlink" title="二十六、腾讯云短信发送"></a>二十六、腾讯云短信发送</h2><blockquote>
<p>短信发送工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@PropertySource(&quot;classpath:tencentcloud.properties&quot;)</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;tencent.cloud&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TencentCloudProperties</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String secretId;<br>    <span class="hljs-keyword">private</span> String secretKey;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">tencent.cloud.secretId</span>=<span class="hljs-string">AKIDnQnueBWdU6VgcIitoTt3xc5JJ3YnoZ4K</span><br><span class="hljs-attr">tencent.cloud.secretKey</span>=<span class="hljs-string">2qOgjXlnbAUYMvEI6f05uTnrfEbiY7PR</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.tencentcloudapi.common.Credential;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.common.exception.TencentCloudSDKException;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.common.profile.ClientProfile;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.common.profile.HttpProfile;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.sms.v20210111.SmsClient;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.sms.v20210111.models.SendSmsRequest;<br><span class="hljs-keyword">import</span> com.tencentcloudapi.sms.v20210111.models.SendSmsResponse;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SMSUtils</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> TencentCloudProperties tencentCloudProperties;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendSMS</span><span class="hljs-params">(String phone, String code)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">/* 必要步骤：</span><br><span class="hljs-comment">       * 实例化一个认证对象，入参需要传入腾讯云账户密钥对secretId，secretKey。</span><br><span class="hljs-comment">       * 这里采用的是从环境变量读取的方式，需要在环境变量中先设置这两个值。</span><br><span class="hljs-comment">       * 你也可以直接在代码中写死密钥对，但是小心不要将代码复制、上传或者分享给他人，</span><br><span class="hljs-comment">       * 以免泄露密钥对危及你的财产安全。</span><br><span class="hljs-comment">       * CAM密匙查询获取: https://console.cloud.tencent.com/cam/capi</span><br><span class="hljs-comment">       * */</span><br>      <span class="hljs-type">Credential</span> <span class="hljs-variable">cred</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Credential</span>(tencentCloudProperties.getSecretId(),<br>          tencentCloudProperties.getSecretKey());<br><br>      <span class="hljs-comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span><br>      <span class="hljs-type">HttpProfile</span> <span class="hljs-variable">httpProfile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpProfile</span>();<br><br>      <span class="hljs-comment">/* SDK会自动指定域名。通常是不需要特地指定域名的，但是如果你访问的是金融区的服务</span><br><span class="hljs-comment">       * 则必须手动指定域名，例如sms的上海金融区域名： sms.ap-shanghai-fsi.tencentcloudapi.com */</span><br>      httpProfile.setEndpoint(<span class="hljs-string">&quot;sms.tencentcloudapi.com&quot;</span>);<br><br>      <span class="hljs-comment">// 实例化一个client选项</span><br>      <span class="hljs-type">ClientProfile</span> <span class="hljs-variable">clientProfile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientProfile</span>();<br>      clientProfile.setHttpProfile(httpProfile);<br>      <span class="hljs-comment">// 实例化要请求产品的client对象,clientProfile是可选的</span><br>      <span class="hljs-type">SmsClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsClient</span>(cred, <span class="hljs-string">&quot;ap-guangzhou&quot;</span>, clientProfile);<br><br>      <span class="hljs-comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span><br>      <span class="hljs-type">SendSmsRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendSmsRequest</span>();<br>      String[] phoneNumberSet1 = &#123;<span class="hljs-string">&quot;+86&quot;</span> + phone&#125;;<span class="hljs-comment">//电话号码</span><br>      req.setPhoneNumberSet(phoneNumberSet1);<br>      req.setSmsSdkAppId(<span class="hljs-string">&quot;1400726285&quot;</span>);   <span class="hljs-comment">// 短信应用ID: 短信SdkAppId在 [应用管理-应用列表] 添加应用后生成的实际SdkAppId</span><br>      req.setSignName(<span class="hljs-string">&quot;一颗小红豆教你开发公众号&quot;</span>);         <span class="hljs-comment">// 签名</span><br>      req.setTemplateId(<span class="hljs-string">&quot;1635274&quot;</span>);       <span class="hljs-comment">// 模板id：必须填写已审核通过的模板 ID。模板ID可登录 [短信控制台] 查看</span><br><br>      <span class="hljs-comment">/* 模板参数（自定义占位变量）: 若无模板参数，则设置为空 */</span><br>      String[] templateParamSet1 = &#123;code&#125;;<br>      req.setTemplateParamSet(templateParamSet1);<br><br>      <span class="hljs-comment">// 返回的resp是一个SendSmsResponse的实例，与请求对象对应</span><br>      <span class="hljs-type">SendSmsResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> client.SendSms(req);<br>    &#125; <span class="hljs-keyword">catch</span> (TencentCloudSDKException e) &#123;<br>      System.out.println(e.toString());<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<p>secretId 和 secretKey 可以访问获取 ：<a target="_blank" rel="noopener" href="https://console.cloud.tencent.com/cam/capi">CAM 密钥查询</a></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150100749-0742068.png" srcset="/img/loading.gif" lazyload alt="image-20221211150100749"></p>
<p>appid 获取 <a target="_blank" rel="noopener" href="https://console.cloud.tencent.com/smsv2/app-manage">AppID</a> 刚开始会有个默认应用，也可以自行创建</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150130877.png" srcset="/img/loading.gif" lazyload alt="image-20221211150130877"></p>
<p>模版id:</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20221211150202811-0742125.png" srcset="/img/loading.gif" lazyload alt="image-20221211150202811"></p>
<h2 id="二十七、脱敏工具"><a href="#二十七、脱敏工具" class="headerlink" title="二十七、脱敏工具"></a>二十七、脱敏工具</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通用脱敏工具类 可用于： 用户名 手机号 邮箱 地址等</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DesensitizationUtil</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SYMBOL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;*&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> commonDisplay(<span class="hljs-string">&quot;慕课网&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mobile</span> <span class="hljs-operator">=</span> commonDisplay(<span class="hljs-string">&quot;13900000000&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mail</span> <span class="hljs-operator">=</span> commonDisplay(<span class="hljs-string">&quot;admin@imooc.com&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> commonDisplay(<span class="hljs-string">&quot;北京大运河东路888号&quot;</span>);<br><br>    System.out.println(name);<br>    System.out.println(mobile);<br>    System.out.println(mail);<br>    System.out.println(address);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 通用脱敏方法</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">commonDisplay</span><span class="hljs-params">(String value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == value || <span class="hljs-string">&quot;&quot;</span>.equals(value)) &#123;<br>      <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> value.length();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pamaone</span> <span class="hljs-operator">=</span> len / <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pamatwo</span> <span class="hljs-operator">=</span> pamaone - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pamathree</span> <span class="hljs-operator">=</span> len % <span class="hljs-number">2</span>;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">2</span>) &#123;<br>      <span class="hljs-keyword">if</span> (pamathree == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> SYMBOL;<br>      &#125;<br>      stringBuilder.append(SYMBOL);<br>      stringBuilder.append(value.charAt(len - <span class="hljs-number">1</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (pamatwo &lt;= <span class="hljs-number">0</span>) &#123;<br>        stringBuilder.append(value.charAt(<span class="hljs-number">0</span>));<br>        stringBuilder.append(SYMBOL);<br>        stringBuilder.append(value.charAt(len - <span class="hljs-number">1</span>));<br><br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pamatwo &gt;= SIZE / <span class="hljs-number">2</span> &amp;&amp; SIZE + <span class="hljs-number">1</span> != len) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pamafive</span> <span class="hljs-operator">=</span> (len - SIZE) / <span class="hljs-number">2</span>;<br>        stringBuilder.append(value.substring(<span class="hljs-number">0</span>, pamafive));<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; SIZE; i++) &#123;<br>          stringBuilder.append(SYMBOL);<br>        &#125;<br>        stringBuilder.append(value, len - (pamafive + <span class="hljs-number">1</span>), len);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pamafour</span> <span class="hljs-operator">=</span> len - <span class="hljs-number">2</span>;<br>        stringBuilder.append(value.charAt(<span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pamafour; i++) &#123;<br>          stringBuilder.append(SYMBOL);<br>        &#125;<br>        stringBuilder.append(value.charAt(len - <span class="hljs-number">1</span>));<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> stringBuilder.toString();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="二十八、AOP日志"><a href="#二十八、AOP日志" class="headerlink" title="二十八、AOP日志"></a>二十八、AOP日志</h2><blockquote>
<p>sql</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_user_log` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `module_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>  `type` tinyint(<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>  `operator_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `operate_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `content` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB CHARSET<span class="hljs-operator">=</span>utf8mb4;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>UserLogDO</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 用户操作日志表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:12</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;sys_user_log&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLogDO</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Long id;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本次操作的系统模块</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String moduleCode;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作类型</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Integer type;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 标题</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String title;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作人</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Long operatorId;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作时间</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Date operateTime;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作内容</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String content;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>UserLogDTO</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 用户日志DTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:13</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLogDTO</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Long id;<br><br>  <span class="hljs-keyword">private</span> String moduleCode;<br><br>  <span class="hljs-keyword">private</span> Integer type;<br><br>  <span class="hljs-keyword">private</span> String title;<br><br>  <span class="hljs-keyword">private</span> Long operatorId;<br><br>  <span class="hljs-keyword">private</span> Date operateTime;<br><br>  <span class="hljs-keyword">private</span> String content;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p>UserLogService</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.gz.entity.dto.UserLogDTO;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 用户日志服务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:16</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserLogService</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 插入用户操作日志</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> userLogDTO 用户日志DTO</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 是否添加成功</span><br><span class="hljs-comment">   */</span><br>  Boolean <span class="hljs-title function_">addSysLog</span><span class="hljs-params">(UserLogDTO userLogDTO)</span>;<br><br>&#125;<br><br>-----------------------------------------------------------<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.gz.entity.UserLogDO;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 用户操作日志Mapper接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:18</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;UserLogDO&gt; &#123;<br><br>&#125;<br><br>-----------------------------------------------------------<br><span class="hljs-keyword">import</span> com.gz.entity.UserLogDO;<br><span class="hljs-keyword">import</span> com.gz.entity.dto.UserLogDTO;<br><span class="hljs-keyword">import</span> com.gz.mapper.UserLogMapper;<br><span class="hljs-keyword">import</span> com.gz.service.UserLogService;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 用户日志服务实现类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:17</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service(&quot;UserLogService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLogServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserLogService</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> UserLogMapper userLogMapper;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">addSysLog</span><span class="hljs-params">(UserLogDTO userLogDTO)</span> &#123;<br>    <span class="hljs-type">UserLogDO</span> <span class="hljs-variable">userLogDO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserLogDO</span>();<br>    userLogDO.setModuleCode(userLogDTO.getModuleCode());<br>    userLogDO.setType(userLogDTO.getType());<br>    userLogDO.setTitle(userLogDTO.getTitle());<br>    userLogDO.setOperatorId(userLogDTO.getOperatorId());<br>    userLogDO.setOperateTime(userLogDTO.getOperateTime());<br>    userLogDO.setContent(userLogDTO.getContent());<br><br>    <span class="hljs-keyword">return</span> userLogMapper.insert(userLogDO) &gt; <span class="hljs-number">0</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>OperationEnum</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.Getter;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 操作类型枚举</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:21</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationEnum</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 新建</span><br><span class="hljs-comment">   */</span><br>  ADD(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;新建&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 修改</span><br><span class="hljs-comment">   */</span><br>  MODIFY(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;修改&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除</span><br><span class="hljs-comment">   */</span><br>  DELETE(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;删除&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 导入</span><br><span class="hljs-comment">   */</span><br>  IMPORT(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;导入&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 导出</span><br><span class="hljs-comment">   */</span><br>  EXPORT(<span class="hljs-number">5</span>, <span class="hljs-string">&quot;导出&quot;</span>);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer value;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String operationType;<br><br>  OperationEnum(Integer value, String operationType) &#123;<br>    <span class="hljs-built_in">this</span>.value = value;<br>    <span class="hljs-built_in">this</span>.operationType = operationType;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>ModuleEnum</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.Getter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 系统模块枚举类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:22</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ModuleEnum</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 课程</span><br><span class="hljs-comment">   */</span><br>  COURSE(<span class="hljs-string">&quot;课程&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 用户</span><br><span class="hljs-comment">   */</span><br>  USER(<span class="hljs-string">&quot;用户&quot;</span>),<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 消息</span><br><span class="hljs-comment">   */</span><br>  MESSAGE(<span class="hljs-string">&quot;消息&quot;</span>);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String moduleCode;<br><br>  ModuleEnum(String moduleCode) &#123;<br>    <span class="hljs-built_in">this</span>.moduleCode = moduleCode;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>UserLog</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户操作日志注解</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> UserLog &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 所属模块名</span><br><span class="hljs-comment">   */</span><br>  ModuleEnum <span class="hljs-title function_">module</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作标题</span><br><span class="hljs-comment">   */</span><br>  String <span class="hljs-title function_">title</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 操作类型</span><br><span class="hljs-comment">   */</span><br>  OperationEnum <span class="hljs-title function_">type</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UserLogAspect</span><br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.gz.entity.dto.UserLogDTO;<br><span class="hljs-keyword">import</span> com.gz.service.UserLogService;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.ServletResponse;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.AfterReturning;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 操作日志注解切面实现</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:26</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLogAspect</span> &#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> HttpServletRequest request;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> ObjectMapper objectMapper;<br><br>  <span class="hljs-meta">@Resource</span><br>  UserLogService userLogService;<br><br><br>  <span class="hljs-meta">@Pointcut(&quot;@annotation(com.gz.aop.UserLog)&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-meta">@AfterReturning(&quot;pointcut()&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(JoinPoint point)</span> &#123;<br>    saveSysUserLog(point);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveSysUserLog</span><span class="hljs-params">(JoinPoint point)</span> &#123;<br>    <span class="hljs-comment">// 获取当前登录用户</span><br>    <span class="hljs-type">UserInfoDTO</span> <span class="hljs-variable">userInfoDTO</span> <span class="hljs-operator">=</span> getUserInfoDTO();<br><br>    <span class="hljs-comment">// 目标方法、以及方法上的@UserLog注解</span><br>    <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) point.getSignature();<br>    <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();<br>    <span class="hljs-type">UserLog</span> <span class="hljs-variable">userLogAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(UserLog.class);<br>    <span class="hljs-keyword">if</span> (userLogAnnotation == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 收集相关信息并保存</span><br>    <span class="hljs-type">UserLogDTO</span> <span class="hljs-variable">userLogDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserLogDTO</span>();<br>    userLogDTO.setModuleCode(userLogAnnotation.<span class="hljs-keyword">module</span>().getModuleCode());<br>    userLogDTO.setContent(getContentJson(point));<br>    userLogDTO.setTitle(userLogAnnotation.title());<br>    userLogDTO.setOperatorId(userInfoDTO.getId());<br>    userLogDTO.setOperateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    userLogDTO.setType(userLogAnnotation.type().getValue());<br><br>    userLogService.addSysLog(userLogDTO);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> UserInfoDTO <span class="hljs-title function_">getUserInfoDTO</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// UserInfoDTO userInfoDTO = (UserInfoDTO) ThreadLocalMap.get(WebConst.USER_INFO_DTO);</span><br>    <span class="hljs-comment">// 模拟从ThreadLocal获取用户信息，关于ThreadLocal请参考小册相关章节</span><br>    <span class="hljs-type">UserInfoDTO</span> <span class="hljs-variable">userInfoDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfoDTO</span>();<br>    userInfoDTO.setId(<span class="hljs-number">10086L</span>);<br>    <span class="hljs-keyword">return</span> userInfoDTO;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getContentJson</span><span class="hljs-params">(JoinPoint point)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">requestType</span> <span class="hljs-operator">=</span> request.getMethod();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;GET&quot;</span>.equals(requestType)) &#123;<br>      <span class="hljs-comment">// 如果是GET请求，直接返回QueryString（目前没有针对查询操作进行日志记录，先留着吧）</span><br>      <span class="hljs-keyword">return</span> request.getQueryString();<br>    &#125;<br><br>    Object[] args = point.getArgs();<br>    Object[] arguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[args.length];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>      <span class="hljs-comment">// 只打印客户端传递的参数，排除Spring注入的参数，比如HttpServletRequest</span><br>      <span class="hljs-keyword">if</span> (args[i] <span class="hljs-keyword">instanceof</span> ServletRequest<br>          || args[i] <span class="hljs-keyword">instanceof</span> ServletResponse<br>          || args[i] <span class="hljs-keyword">instanceof</span> MultipartFile) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      arguments[i] = args[i];<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(arguments);<br>    &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>      log.error(<span class="hljs-string">&quot;UserLogAspect#getContentJson JsonProcessingException&quot;</span>, e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">EnableUserLog</span><br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Import;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 开启用户日志记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/01/05 23:24</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Import(UserLogAspect.class)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableUserLog &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableUserLog</span><br><span class="hljs-meta">@EnableSwagger2WebMvc</span><br><span class="hljs-meta">@MapperScan(basePackages = &quot;com.gz.mapper&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityApplication</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    SpringApplication.run(SecurityApplication.class, args);<br>    System.out.println(<span class="hljs-string">&quot;security-demo running&quot;</span>);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-meta">@UserLog(module = ModuleEnum.USER, title = &quot;批量更新用户&quot;, type = OperationEnum.MODIFY)</span><br>    <span class="hljs-meta">@PostMapping(&quot;updateBatchUser&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;Boolean&gt; <span class="hljs-title function_">updateBatchUser</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> <span class="hljs-meta">@RequestBody</span> ValidationList&lt;User&gt; userList)</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@UserLog(module = ModuleEnum.USER, title = &quot;新增用户&quot;, type = OperationEnum.ADD)</span><br>    <span class="hljs-meta">@PostMapping(&quot;insertUser&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;Boolean&gt; <span class="hljs-title function_">insertUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="二十九、-阿里云消息推送工具类"><a href="#二十九、-阿里云消息推送工具类" class="headerlink" title="二十九、 阿里云消息推送工具类"></a>二十九、 阿里云消息推送工具类</h2><blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">aliyun:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">access-key-id-em:</span> <span class="hljs-string">LTAI5tA834xqY2Vk4N8oFH5k</span><br>    <span class="hljs-attr">access-key-secret-em:</span> <span class="hljs-string">PmjiAYX2YmABySnQncMFD1WtrnTsM2</span><br>    <span class="hljs-attr">app-key-android-em:</span> <span class="hljs-number">333720016</span><br>    <span class="hljs-attr">app-key-ios-em:</span> <span class="hljs-number">333720024</span><br>    <span class="hljs-attr">region-id:</span> <span class="hljs-string">cn-hangzhou</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.aliyuncs.DefaultAcsClient;<br><span class="hljs-keyword">import</span> com.aliyuncs.exceptions.ClientException;<br><span class="hljs-keyword">import</span> com.aliyuncs.profile.DefaultProfile;<br><span class="hljs-keyword">import</span> com.aliyuncs.profile.IClientProfile;<br><span class="hljs-keyword">import</span> com.aliyuncs.push.model.v20160801.PushRequest;<br><span class="hljs-keyword">import</span> com.aliyuncs.push.model.v20160801.PushResponse;<br><span class="hljs-keyword">import</span> com.jysj.hawk.entity.dto.PushParamDTO;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliPushUtil</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG_DEVICE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DEVICE&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG_ALIAS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ALIAS&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG_ACCOUNT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ACCOUNT&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG_TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TAG&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG_ALL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ALL&quot;</span>;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;aliyun.push.access-key-id-em&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String accessKeyId;<br>  <span class="hljs-meta">@Value(&quot;$&#123;aliyun.push.access-key-secret-em&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String accessKeySecret;<br>  <span class="hljs-meta">@Value(&quot;$&#123;aliyun.push.app-key-ios-em&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String appKeyIos;<br>  <span class="hljs-meta">@Value(&quot;$&#123;aliyun.push.app-key-android-em&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String appKeyAndroid;<br>  <span class="hljs-meta">@Value(&quot;$&#123;aliyun.push.region-id&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String regionId;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushAndroidMessage</span><span class="hljs-params">(String targetValue, String title, String content,</span><br><span class="hljs-params">      PushParamDTO params)</span> &#123;<br>    <span class="hljs-type">IClientProfile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);<br>    <span class="hljs-type">DefaultAcsClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAcsClient</span>(profile);<br>    <span class="hljs-type">PushRequest</span> <span class="hljs-variable">pushRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushRequest</span>();<br>    <span class="hljs-comment">// 推送目标</span><br>    pushRequest.setAppKey(Long.parseLong(appKeyAndroid));<br>    <span class="hljs-comment">//推送目标: DEVICE:按设备推送 ALIAS : 按别名推送 ACCOUNT:按帐号推送  TAG:按标签推送; ALL: 广播推送</span><br>    pushRequest.setTarget(<span class="hljs-string">&quot;ACCOUNT&quot;</span>);<br>    <span class="hljs-comment">//根据Target来设定，如Target=DEVICE, 则对应的值为 设备id1,设备id2. 多个值使用逗号分隔.(帐号与设备有一次最多100个的限制)</span><br>    pushRequest.setTargetValue(targetValue);<br><span class="hljs-comment">//        pushRequest.setTarget(&quot;ALL&quot;); //推送目标: DEVICE:推送给设备; ACCOUNT:推送给指定帐号,TAG:推送给自定义标签; ALL: 推送给全部</span><br><span class="hljs-comment">//        pushRequest.setTargetValue(&quot;ALL&quot;); //根据Target来设定，如Target=DEVICE, 则对应的值为 设备id1,设备id2. 多个值使用逗号分隔.(帐号与设备有一次最多100个的限制)</span><br>    <span class="hljs-comment">// 消息类型 MESSAGE NOTICE</span><br>    pushRequest.setPushType(<span class="hljs-string">&quot;NOTICE&quot;</span>);<br><span class="hljs-comment">//    pushRequest.setAndroidOpenType();</span><br>    <span class="hljs-comment">// 设备类型 ANDROID iOS ALL.</span><br>    pushRequest.setDeviceType(<span class="hljs-string">&quot;ALL&quot;</span>);<br>    <span class="hljs-comment">// 推送配置</span><br>    <span class="hljs-comment">// 消息的标题</span><br>    pushRequest.setTitle(title);<br>    pushRequest.setIOSRemind(Boolean.TRUE);<br>    pushRequest.setAndroidRemind(Boolean.TRUE);<br>    pushRequest.setIOSRemindBody(content);<br>    pushRequest.setAndroidPopupTitle(title);<br>    pushRequest.setAndroidPopupBody(content);<br>    pushRequest.setAndroidExtParameters(JSONObject.toJSONString(params));<br>    pushRequest.setIOSExtParameters(JSONObject.toJSONString(params));<br>    <span class="hljs-comment">// 离线消息是否保存,若保存, 在推送时候，用户即使不在线，下一次上线则会收到</span><br>    pushRequest.setStoreOffline(Boolean.TRUE);<br>    pushRequest.setAndroidNotificationChannel(<span class="hljs-string">&quot;inspection&quot;</span>);<br>    <span class="hljs-comment">//点击通知后动作 &quot;APPLICATION&quot; : 打开应用 &quot;ACTIVITY&quot; : 打开AndroidActivity &quot;URL&quot; : 打开URL &quot;NONE&quot; : 无跳转</span><br>    pushRequest.setAndroidOpenType(<span class="hljs-string">&quot;APPLICATION&quot;</span>);<br>    pushRequest.setAndroidNotifyType(<span class="hljs-string">&quot;BOTH&quot;</span>);<br>    pushRequest<br>        .setAndroidActivity(<span class="hljs-string">&quot;com.alibaba.uniplugin.android.third.push.ThirdPushPopupActivity&quot;</span>);<br>    pushRequest<br>        .setAndroidPopupActivity(<span class="hljs-string">&quot;com.alibaba.uniplugin.android.third.push.ThirdPushPopupActivity&quot;</span>);<br>    pushRequest.setAndroidVivoPushMode(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 消息的内容</span><br>    pushRequest.setBody(content);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">PushResponse</span> <span class="hljs-variable">pushResponse</span> <span class="hljs-operator">=</span> client.getAcsResponse(pushRequest);<br>      log.info(<span class="hljs-string">&quot;RequestId: &#123;&#125;, MessageID: &#123;&#125;\n&quot;</span>, pushResponse.getRequestId(),<br>          pushResponse.getMessageId());<br>    &#125; <span class="hljs-keyword">catch</span> (ClientException e) &#123;<br>      log.error(<span class="hljs-string">&quot;消息推送失败：&#123;&#125;&quot;</span>, e.toString());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushIOSMessage</span><span class="hljs-params">(String targetValue, String title, String content,</span><br><span class="hljs-params">      PushParamDTO params)</span> &#123;<br>    <span class="hljs-type">IClientProfile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);<br>    <span class="hljs-type">DefaultAcsClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAcsClient</span>(profile);<br>    <span class="hljs-type">PushRequest</span> <span class="hljs-variable">pushRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushRequest</span>();<br>    <span class="hljs-comment">// 推送目标</span><br>    pushRequest.setAppKey(Long.parseLong(appKeyIos));<br>    <span class="hljs-comment">// 消息类型 MESSAGE NOTICE</span><br>    pushRequest.setPushType(<span class="hljs-string">&quot;NOTICE&quot;</span>);<br>    <span class="hljs-comment">// 设备类型 ANDROID iOS ALL.</span><br>    pushRequest.setDeviceType(<span class="hljs-string">&quot;ALL&quot;</span>);<br>    pushRequest.setIOSRemind(Boolean.TRUE);<br>    pushRequest.setAndroidRemind(Boolean.TRUE);<br>    <span class="hljs-comment">//推送目标: DEVICE:按设备推送 ALIAS : 按别名推送 ACCOUNT:按帐号推送  TAG:按标签推送; ALL: 广播推送</span><br>    pushRequest.setTarget(<span class="hljs-string">&quot;ACCOUNT&quot;</span>);<br>    <span class="hljs-comment">//根据Target来设定，如Target=DEVICE, 则对应的值为 设备id1,设备id2. 多个值使用逗号分隔.(帐号与设备有一次最多100个的限制)</span><br>    pushRequest.setTargetValue(targetValue);<br><span class="hljs-comment">//        pushRequest.setTarget(&quot;ALL&quot;); //推送目标: DEVICE:推送给设备; ACCOUNT:推送给指定帐号,TAG:推送给自定义标签; ALL: 推送给全部</span><br><span class="hljs-comment">//        pushRequest.setTargetValue(&quot;ALL&quot;); //根据Target来设定，如Target=DEVICE, 则对应的值为 设备id1,设备id2. 多个值使用逗号分隔.(帐号与设备有一次最多100个的限制)</span><br><span class="hljs-comment">//    pushRequest.setAndroidOpenType();</span><br>    <span class="hljs-comment">// 推送配置</span><br>    <span class="hljs-comment">// 消息的标题</span><br>    pushRequest.setTitle(title);<br>    <span class="hljs-comment">// 消息的内容</span><br>    pushRequest.setBody(content);<br>    pushRequest.setIOSRemindBody(content);<br>    pushRequest.setAndroidPopupTitle(title);<br>    pushRequest.setAndroidPopupBody(content);<br>    pushRequest.setAndroidExtParameters(JSONObject.toJSONString(params));<br>    pushRequest.setIOSExtParameters(JSONObject.toJSONString(params));<br>    pushRequest.setStoreOffline(Boolean.TRUE);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">PushResponse</span> <span class="hljs-variable">pushResponse</span> <span class="hljs-operator">=</span> client.getAcsResponse(pushRequest);<br>      log.info(<span class="hljs-string">&quot;RequestId: &#123;&#125;, MessageID: &#123;&#125;\n&quot;</span>, pushResponse.getRequestId(),<br>          pushResponse.getMessageId());<br>    &#125; <span class="hljs-keyword">catch</span> (ClientException e) &#123;<br>      log.error(<span class="hljs-string">&quot;消息推送失败：&#123;&#125;&quot;</span>, e.toString());<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="三十、发送邮件"><a href="#三十、发送邮件" class="headerlink" title="三十、发送邮件"></a>三十、发送邮件</h2><blockquote>
<p>开启授权</p>
</blockquote>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230116165636730-3859398.png" srcset="/img/loading.gif" lazyload alt="image-20230116165636730"></p>
<blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>







<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.mail.MessagingException;<br><span class="hljs-keyword">import</span> javax.mail.internet.MimeMessage;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.mail.SimpleMailMessage;<br><span class="hljs-keyword">import</span> org.springframework.mail.javamail.JavaMailSender;<br><span class="hljs-keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> EmailUtil</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 邮件发送工具</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/4/6 16:06</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailUtil</span> &#123;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;spring.mail.from&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String from;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> JavaMailSender mailSender;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送纯文本邮件信息</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> to      接收方</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> subject 邮件主题</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> content 邮件内容（发送内容）</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTextMail</span><span class="hljs-params">(String to, String subject, String content)</span> &#123;<br>    <span class="hljs-comment">// 创建一个邮件对象</span><br>    <span class="hljs-type">SimpleMailMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMailMessage</span>();<br>    msg.setFrom(from); <span class="hljs-comment">// 设置发送发</span><br>    msg.setTo(to); <span class="hljs-comment">// 设置接收方</span><br>    msg.setSubject(subject); <span class="hljs-comment">// 设置邮件主题</span><br>    msg.setText(content); <span class="hljs-comment">// 设置邮件内容</span><br>    <span class="hljs-comment">// 发送邮件</span><br>    mailSender.send(msg);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送邮件</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> to      接收方</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> subject 邮件主题</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> content 邮件内容（发送内容）</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMail</span><span class="hljs-params">(String to, String subject, String content)</span> &#123;<br>    <span class="hljs-comment">// 创建一个邮件对象</span><br>    <span class="hljs-type">MimeMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> mailSender.createMimeMessage();<br>    <span class="hljs-type">MimeMessageHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeMessageHelper</span>(message, <span class="hljs-literal">true</span>);<br>      <span class="hljs-comment">// 设置发送方</span><br>      helper.setFrom(from);<br>      <span class="hljs-comment">// 设置接收方</span><br>      helper.setTo(to);<br>      <span class="hljs-comment">// 设置邮件主题</span><br>      helper.setSubject(subject);<br>      <span class="hljs-comment">// 设置邮件内容（开启html）</span><br>      helper.setText(content, <span class="hljs-literal">true</span>);<br>      <span class="hljs-comment">// 发送邮件</span><br>      mailSender.send(message);<br>      log.info(<span class="hljs-string">&quot;邮件发送成功：&#123;&#125;&quot;</span>, to);<br>    &#125; <span class="hljs-keyword">catch</span> (MessagingException e) &#123;<br>      log.info(<span class="hljs-string">&quot;给邮箱&#123;&#125;发送验证码时发生错误,&#123;&#125;&quot;</span>, to, e.toString());<br>    &#125;<br><br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送带附件的邮件信息</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> to      接收方</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> subject 邮件主题</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> content 邮件内容（发送内容）</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> files   文件数组 // 可发送多个附件</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMailWithFiles</span><span class="hljs-params">(String to, String subject, String content, File[] files)</span> &#123;<br>    <span class="hljs-type">MimeMessage</span> <span class="hljs-variable">mimeMessage</span> <span class="hljs-operator">=</span> mailSender.createMimeMessage();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MimeMessageHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeMessageHelper</span>(mimeMessage, <span class="hljs-literal">true</span>);<br>      <span class="hljs-comment">// 设置发送方</span><br>      helper.setFrom(from);<br>      <span class="hljs-comment">// 设置接收方</span><br>      helper.setTo(to);<br>      <span class="hljs-comment">// 设置邮件主题</span><br>      helper.setSubject(subject);<br>      <span class="hljs-comment">// 设置邮件内容</span><br>      helper.setText(content);<br>      <span class="hljs-comment">// 添加附件（多个）</span><br>      <span class="hljs-keyword">if</span> (files != <span class="hljs-literal">null</span> &amp;&amp; files.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">for</span> (File file : files) &#123;<br>          helper.addAttachment(file.getName(), file);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (MessagingException e) &#123;<br>      e.printStackTrace();<br>    &#125;<br>    <span class="hljs-comment">// 发送邮件</span><br>    mailSender.send(mimeMessage);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 发送带附件的邮件信息</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> to      接收方</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> subject 邮件主题</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> content 邮件内容（发送内容）</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> file    单个文件</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMailWithFile</span><span class="hljs-params">(String to, String subject, String content, File file)</span> &#123;<br>    <span class="hljs-type">MimeMessage</span> <span class="hljs-variable">mimeMessage</span> <span class="hljs-operator">=</span> mailSender.createMimeMessage();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MimeMessageHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeMessageHelper</span>(mimeMessage, <span class="hljs-literal">true</span>);<br>      <span class="hljs-comment">// 设置发送发</span><br>      helper.setFrom(from);<br>      <span class="hljs-comment">// 设置接收方</span><br>      helper.setTo(to);<br>      <span class="hljs-comment">// 设置邮件主题</span><br>      helper.setSubject(subject);<br>      <span class="hljs-comment">// 设置邮件内容</span><br>      helper.setText(content);<br>      <span class="hljs-comment">// 单个附件</span><br>      helper.addAttachment(file.getName(), file);<br>    &#125; <span class="hljs-keyword">catch</span> (MessagingException e) &#123;<br>      e.printStackTrace();<br>    &#125;<br>    <span class="hljs-comment">// 发送邮件</span><br>    mailSender.send(mimeMessage);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFrom</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> from;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFrom</span><span class="hljs-params">(String from)</span> &#123;<br>    <span class="hljs-built_in">this</span>.from = from;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h2 id="三十一、JSR303校验"><a href="#三十一、JSR303校验" class="headerlink" title="三十一、JSR303校验"></a>三十一、JSR303校验</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>加入校验</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> javax.validation.constraints.NotEmpty;<br><span class="hljs-keyword">import</span> javax.validation.constraints.Size;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 添加课程dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/7 17:40</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(value=&quot;AddCourseDto&quot;, description=&quot;新增课程基本信息&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddCourseDto</span> &#123;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;课程名称不能为空&quot;)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String name;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span><br> <span class="hljs-meta">@Size(message = &quot;适用人群内容过少&quot;,min = 10)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String users;<br><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;课程标签&quot;)</span><br> <span class="hljs-keyword">private</span> String tags;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;大分类&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String mt;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;小分类&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String st;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;课程等级不能为空&quot;)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;课程等级&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String grade;<br><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;教学模式（普通，录播，直播等）&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String teachmode;<br><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;课程介绍&quot;)</span><br> <span class="hljs-keyword">private</span> String description;<br><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;课程图片&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String pic;<br><br> <span class="hljs-meta">@NotEmpty(message = &quot;收费规则不能为空&quot;)</span><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;收费规则，对应数据字典&quot;, required = true)</span><br> <span class="hljs-keyword">private</span> String charge;<br><br> <span class="hljs-meta">@ApiModelProperty(value = &quot;价格&quot;)</span><br> <span class="hljs-keyword">private</span> BigDecimal price;<br><br>&#125;<br></code></pre></td></tr></table></figure>





<p>上边用到了@NotEmpty和@Size两个注解，@NotEmpty表示属性不能为空，@Size表示限制属性内容的长短。</p>
<p>在javax.validation.constraints包下有很多这样的校验注解</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20220908165105908.png" srcset="/img/loading.gif" lazyload alt="image-20220908165105908"></p>
<p>规则如下：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/2022091315452386.png" srcset="/img/loading.gif" lazyload alt="2022091315452386.png"></p>
<p>定义好校验规则还需要开启校验，在controller方法中添加@Validated注解，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/course&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">createCourseBase</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated</span> AddCourseDto addCourseDto)</span>&#123;<br>    <span class="hljs-comment">//机构id，由于认证系统没有上线暂时硬编码</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>  <span class="hljs-keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>如果校验出错Spring会抛出MethodArgumentNotValidException异常，我们需要在统一异常处理器中捕获异常，解析出异常信息。</p>
<p>代码 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span><br><span class="hljs-meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">doValidException</span><span class="hljs-params">(MethodArgumentNotValidException argumentNotValidException)</span> &#123;<br><br>   <span class="hljs-type">BindingResult</span> <span class="hljs-variable">bindingResult</span> <span class="hljs-operator">=</span> argumentNotValidException.getBindingResult();<br>   <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">errMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br><br>   List&lt;FieldError&gt; fieldErrors = bindingResult.getFieldErrors();<br>   fieldErrors.forEach(error -&gt; &#123;<br>      errMsg.append(error.getDefaultMessage()).append(<span class="hljs-string">&quot;,&quot;</span>);<br>   &#125;);<br>   log.error(errMsg.toString());<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(errMsg.toString());<br>&#125;<br></code></pre></td></tr></table></figure>













<h2 id="三十二、xxl-job-使用"><a href="#三十二、xxl-job-使用" class="headerlink" title="三十二、xxl-job 使用"></a>三十二、xxl-job 使用</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</a></p>
<p>XXL-JOB主要有调度中心、执行器、任务：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211154930116.png" srcset="/img/loading.gif" lazyload alt="image-20230211154930116"></p>
<p><strong>调度中心：</strong></p>
<p>​    负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p>
<p>​    主要职责为执行器管理、任务管理、监控运维、日志管理等</p>
<p><strong>任务执行器：</strong></p>
<p>​    负责接收调度请求并执行任务逻辑；</p>
<p>​    只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p>
<p><strong>任务：</strong>负责执行具体的业务处理。</p>
<p>调度中心与执行器之间的工作流程如下：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155138470.png" srcset="/img/loading.gif" lazyload alt="image-20230211155138470"></p>
<p><strong>执行流程：</strong></p>
<p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
<p>​    2.达到任务触发条件，调度中心下发任务</p>
<p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
<p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p>
<p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
<p>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155352126-6102035.png" srcset="/img/loading.gif" lazyload alt="image-20230211155352126"></p>
<ul>
<li><p>xxl-job-admin：调度中心</p>
</li>
<li><p>xxl-job-core：公共依赖</p>
</li>
<li><p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p>
<p>：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p>
<p>：xxl-job-executor-sample-frameless：无框架版本；</p>
</li>
</ul>
<p>doc :文档资料，包含数据库脚本</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><blockquote>
<p>调度中心</p>
</blockquote>
<p>修改配置文件中的数据库连接信息 <span style="color:red;">这里主要要注意端口还有默认的accessToken</span></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211155948987.png" srcset="/img/loading.gif" lazyload alt="image-20230211155948987"></p>
<blockquote>
<p>执行器</p>
</blockquote>
<p>在需要引入执行器的模块导入依赖,注意版本使用2.3.1:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>在配置文件中引入:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span> <br>      <span class="hljs-comment"># 调度中心的地址</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://localhost:8080/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>    	<span class="hljs-comment"># 执行器的名称</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">media-process-service</span><br>      <span class="hljs-attr">address:</span> <br>      <span class="hljs-attr">ip:</span> <br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br>      <span class="hljs-comment"># 日志地址</span><br>      <span class="hljs-attr">logpath:</span> <span class="hljs-string">/data/applogs/xxl-job/jobhandler</span><br>      <span class="hljs-comment"># 日志保存天数</span><br>      <span class="hljs-attr">logretentiondays:</span> <span class="hljs-number">30</span><br>    <span class="hljs-comment"># 与调度中心通讯token</span><br>    <span class="hljs-attr">accessToken:</span> <span class="hljs-string">default_token</span><br></code></pre></td></tr></table></figure>



<p>注意配置中的appname这是执行器的应用名，稍后在调度中心配置执行器时要使用。</p>
<blockquote>
<p>配置xxl-job的执行器</p>
</blockquote>
<p>将示例工程下配置类拷贝到媒资管理的service工程下</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>拷贝至：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image004.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>下边进入调度中心添加执行器: </p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160843064.png" srcset="/img/loading.gif" lazyload alt="image-20230211160843064"></p>
<p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160907458.png" srcset="/img/loading.gif" lazyload alt="image-20230211160907458"></p>
<p>添加成功：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211160925901.png" srcset="/img/loading.gif" lazyload alt="image-20230211160925901"></p>
<p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动媒资管理模块的接口工程。</p>
<p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6102973.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>同时观察调度中心中的执行器界面</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6102991.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>在线机器地址处已显示1个执行器。</p>
<blockquote>
<p>执行任务</p>
</blockquote>
<p>下边编写任务，任务类的编写方法参考示例工程，如下图：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/clip_image002-6103023.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>在service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 测试执行器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/13 20:32</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Component</span><br> <span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleJob</span> &#123;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 1、简单任务示例（Bean模式）</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-meta">@XxlJob(&quot;testJob&quot;)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  log.info(<span class="hljs-string">&quot;开始执行.....&quot;</span>);<br><br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>下边在调度中心添加任务，进入任务管理</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161207770.png" srcset="/img/loading.gif" lazyload alt="image-20230211161207770"></p>
<p>点击新增，填写任务信息</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161226797.png" srcset="/img/loading.gif" lazyload alt="image-20230211161226797"></p>
<p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p>
<p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p>
<p>JobHandler任务方法名填写@XxlJob注解中的名称。</p>
<p>添加成功，启动任务</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161257545.png" srcset="/img/loading.gif" lazyload alt="image-20230211161257545"></p>
<p>通过调度日志查看任务执行情况</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161333075.png" srcset="/img/loading.gif" lazyload alt="image-20230211161333075"></p>
<p>下边启动媒资管理的service工程，启动执行器。</p>
<p>观察执行器方法的执行。</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161346572.png" srcset="/img/loading.gif" lazyload alt="image-20230211161346572"></p>
<p>如果要停止任务需要在调度中心操作</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161359965.png" srcset="/img/loading.gif" lazyload alt="image-20230211161359965"></p>
<p>任务跑一段时间注意清理日志</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211161411074.png" srcset="/img/loading.gif" lazyload alt="image-20230211161411074"></p>
<h3 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h3><blockquote>
<p>路由策略</p>
</blockquote>
<ul>
<li>FIRST（第一个）：固定选择第一个机器；</li>
<li>LAST（最后一个）：固定选择最后一个机器；</li>
<li>ROUND（轮询）：每个节点循环选择</li>
<li>RANDOM（随机）：随机选择在线的机器；</li>
<li>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</li>
<li>LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</li>
<li>LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</li>
<li>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</li>
<li>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</li>
<li>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数(节点序号和节点总数)；可根据分片参数开发分片任务；</li>
</ul>
<blockquote>
<p>调度过期策略</p>
</blockquote>
<p>当执行器执行的过程中,调度中心开始调度下一轮的任务时的策略</p>
<ul>
<li>忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</li>
<li>立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</li>
</ul>
<blockquote>
<p>阻塞处理策略</p>
</blockquote>
<ul>
<li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</li>
<li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</li>
<li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务</li>
<li>任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</li>
<li>失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</li>
</ul>
<h3 id="分片广播"><a href="#分片广播" class="headerlink" title="分片广播"></a>分片广播</h3><p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211165820478.png" srcset="/img/loading.gif" lazyload alt="image-20230211165820478"></p>
<p>下边要重点说的是分片广播策略，分片是指是调度中心将集群中的执行器标上序号：0，1，2，3…，广播是指每次调度会向集群中所有执行器发送调度请求，请求中携带分片参数。</p>
<p>如下图：</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230211170223041.png" srcset="/img/loading.gif" lazyload alt="image-20230211170223041"></p>
<p>每个执行器收到调度请求根据分片参数自行决定是否执行任务。</p>
<p>另外xxl-job还支持动态分片，当执行器数量有变更时，调度中心会动态修改分片的数量。</p>
<blockquote>
<p>分片使用场景</p>
</blockquote>
<ul>
<li><p>分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p>
</li>
<li><p>广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p>
</li>
</ul>
<p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p>
<blockquote>
<p>作业分片方案</p>
</blockquote>
<p>对于任务,我们可以将任务堆积到数据库或者其他缓存中,任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会重复执行任务？</p>
<p>执行器收到调度请求后各自己查询属于自己的任务，这样就保证了执行器之间不会重复执行任务。</p>
<p>xxl-job设计作业分片就是为了分布式执行任务，XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号并向执行器传递分片总数、分片序号这些参数，开发者需要自行处理分片项与真实数据的对应关系。</p>
<p>下图表示了多个执行器获取视频处理任务的结构：</p>
<img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230212002758979.png" srcset="/img/loading.gif" lazyload alt="image-20230212002758979" style="zoom:67%;">

<p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p>
<p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p>
<p>1 % 2 &#x3D; 1  执行器2执行</p>
<p>2 % 2 &#x3D; 0  执行器1执行</p>
<p>3 % 2 &#x3D; 1   执行器2执行</p>
<p>以此类推.</p>
<h3 id="保证任务不重复执行"><a href="#保证任务不重复执行" class="headerlink" title="保证任务不重复执行"></a>保证任务不重复执行</h3><p>通过作业分片方案保证了执行器之间分配的任务不重复，另外如果同一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p>
<ol>
<li>首先配置调度过期策略</li>
</ol>
<p>- 调度过期策略：<br>     - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br>     - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br>   - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
<p><span style="color:red;">这里我们选择忽略，如果立即执行一次可能会重复调度。</span></p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230212003649475.png" srcset="/img/loading.gif" lazyload alt="image-20230212003649475"></p>
<ol start="2">
<li>配置阻塞处理策略</li>
</ol>
<p>阻塞处理策略就是当前执行器正在执行任务还没有结束时调度时间到达到，此时该如何处理。</p>
<p>查看文档如下：<br>     单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；<br>     丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；<br>     覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p>
<p><span style="color:red;">这里选择 丢弃后续调度，避免重复调度。</span></p>
<p>下面举个分片查询的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaProcessMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 根据分片参数获取待处理任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardTotal  分片总数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardindex  分片序号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count 任务数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt; </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/14 8:54</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Select(&quot;SELECT t.* FROM media_process t WHERE t.id % #&#123;shardTotal&#125; = #&#123;shardindex&#125; and t.status=&#x27;1&#x27; limit #&#123;count&#125;&quot;)</span><br>    List&lt;MediaProcess&gt; <span class="hljs-title function_">selectListByShardIndex</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;shardTotal&quot;)</span> <span class="hljs-type">int</span> shardTotal, <span class="hljs-meta">@Param(&quot;shardindex&quot;)</span> <span class="hljs-type">int</span> shardindex, <span class="hljs-meta">@Param(&quot;count&quot;)</span> <span class="hljs-type">int</span> count)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>















<h2 id="三十三、密码学"><a href="#三十三、密码学" class="headerlink" title="三十三、密码学"></a>三十三、密码学</h2><h3 id="常见加密方式"><a href="#常见加密方式" class="headerlink" title="常见加密方式"></a>常见加密方式</h3><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230214095745301.png" srcset="/img/loading.gif" lazyload alt="image-20230214095745301" style="zoom:50%;">



<h4 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h4><p>采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密，这种加密方法称为对称加密，也称为单密钥加密。</p>
<p>示例</p>
<ul>
<li>我们现在有一个原文3要发送给B</li>
<li>设置密钥为108, 3 * 108 &#x3D; 324, 将324作为密文发送给B</li>
<li>B拿到密文324后, 使用324&#x2F;108 &#x3D; 3 得到原文</li>
</ul>
<h5 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h5><ul>
<li><p>在Java 8中，Base64编码已经成为Java类库的标准,并内置了 Base64 编码的编码器和解码器。</p>
</li>
<li><p>是一种基于 64 个可打印字符来表示二进制数据的表示方法, 由A-Z、a-z、0-9、+、&#x2F;共64个字符组成，去掉i I o O + &#x2F;即base58</p>
</li>
<li><p>常用于在处理文本数据的场合,表示、传输、存储一些二进制数据,包括MIME的电子邮件及XML的一些复杂数据</p>
</li>
<li><p>base64以三个字节为一组，如果最后一组不足3个字节，则使用&#x3D;号补充</p>
</li>
</ul>
<blockquote>
<p>实战</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Base64Test</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 使用jdk原生来实现base64</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;这是一段测试文本&quot;</span>;<br>    <span class="hljs-comment">// 编码 1.8才提供的</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">encodedStr</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(str.getBytes(StandardCharsets.UTF_8));<br>    <span class="hljs-comment">// 5LmQ5LmL6ICFamF2YQ==</span><br>    System.out.println(<span class="hljs-string">&quot;encodedStr:&quot;</span> + encodedStr);<br>    <span class="hljs-comment">// 解码</span><br>    <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(encodedStr.getBytes(StandardCharsets.UTF_8));<br>    System.out.println(<span class="hljs-string">&quot;decodedStr:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode, StandardCharsets.UTF_8));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 使用commons-codec来实现base64</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">codec</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;这是一段测试文本&quot;</span>;<br>    <span class="hljs-comment">// 编码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">encodedStr</span> <span class="hljs-operator">=</span> org.apache.commons.codec.binary.Base64<br>        .encodeBase64String(str.getBytes(StandardCharsets.UTF_8));<br>    <span class="hljs-comment">// 5LmQ5LmL6ICFamF2YQ==</span><br>    System.out.println(<span class="hljs-string">&quot;encodedStr:&quot;</span> + encodedStr);<br>    <span class="hljs-comment">// 解码</span><br>    <span class="hljs-type">byte</span>[] decode = org.apache.commons.codec.binary.Base64<br>        .decodeBase64(encodedStr.getBytes(StandardCharsets.UTF_8));<br>    System.out.println(<span class="hljs-string">&quot;decodedStr:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode, StandardCharsets.UTF_8));<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Base64工具类</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> admin</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Base64</span><br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">BASELENGTH</span>           <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">LOOKUPLENGTH</span>         <span class="hljs-operator">=</span> <span class="hljs-number">64</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">TWENTYFOURBITGROUP</span>   <span class="hljs-operator">=</span> <span class="hljs-number">24</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">EIGHTBIT</span>             <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">SIXTEENBIT</span>           <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">FOURBYTE</span>             <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>     <span class="hljs-variable">SIGN</span>                 <span class="hljs-operator">=</span> -<span class="hljs-number">128</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>    <span class="hljs-variable">PAD</span>                  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;=&#x27;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[]  base64Alphabet       = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[BASELENGTH];<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-type">char</span>[]  lookUpBase64Alphabet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[LOOKUPLENGTH];<br><br>    <span class="hljs-keyword">static</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; BASELENGTH; ++i)<br>        &#123;<br>            base64Alphabet[i] = -<span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Z&#x27;</span>; i &gt;= <span class="hljs-string">&#x27;A&#x27;</span>; i--)<br>        &#123;<br>            base64Alphabet[i] = (<span class="hljs-type">byte</span>) (i - <span class="hljs-string">&#x27;A&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;z&#x27;</span>; i &gt;= <span class="hljs-string">&#x27;a&#x27;</span>; i--)<br>        &#123;<br>            base64Alphabet[i] = (<span class="hljs-type">byte</span>) (i - <span class="hljs-string">&#x27;a&#x27;</span> + <span class="hljs-number">26</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;9&#x27;</span>; i &gt;= <span class="hljs-string">&#x27;0&#x27;</span>; i--)<br>        &#123;<br>            base64Alphabet[i] = (<span class="hljs-type">byte</span>) (i - <span class="hljs-string">&#x27;0&#x27;</span> + <span class="hljs-number">52</span>);<br>        &#125;<br><br>        base64Alphabet[<span class="hljs-string">&#x27;+&#x27;</span>] = <span class="hljs-number">62</span>;<br>        base64Alphabet[<span class="hljs-string">&#x27;/&#x27;</span>] = <span class="hljs-number">63</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">25</span>; i++)<br>        &#123;<br>            lookUpBase64Alphabet[i] = (<span class="hljs-type">char</span>) (<span class="hljs-string">&#x27;A&#x27;</span> + i);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">26</span>, j = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">51</span>; i++, j++)<br>        &#123;<br>            lookUpBase64Alphabet[i] = (<span class="hljs-type">char</span>) (<span class="hljs-string">&#x27;a&#x27;</span> + j);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">52</span>, j = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">61</span>; i++, j++)<br>        &#123;<br>            lookUpBase64Alphabet[i] = (<span class="hljs-type">char</span>) (<span class="hljs-string">&#x27;0&#x27;</span> + j);<br>        &#125;<br>        lookUpBase64Alphabet[<span class="hljs-number">62</span>] = (<span class="hljs-type">char</span>) <span class="hljs-string">&#x27;+&#x27;</span>;<br>        lookUpBase64Alphabet[<span class="hljs-number">63</span>] = (<span class="hljs-type">char</span>) <span class="hljs-string">&#x27;/&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWhiteSpace</span><span class="hljs-params">(<span class="hljs-type">char</span> octect)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> (octect == <span class="hljs-number">0x20</span> || octect == <span class="hljs-number">0xd</span> || octect == <span class="hljs-number">0xa</span> || octect == <span class="hljs-number">0x9</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPad</span><span class="hljs-params">(<span class="hljs-type">char</span> octect)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> (octect == PAD);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isData</span><span class="hljs-params">(<span class="hljs-type">char</span> octect)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> (octect &lt; BASELENGTH &amp;&amp; base64Alphabet[octect] != -<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Encodes hex octects into Base64</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> binaryData Array containing binaryData</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Encoded Base64 array</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] binaryData)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (binaryData == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">lengthDataBits</span> <span class="hljs-operator">=</span> binaryData.length * EIGHTBIT;<br>        <span class="hljs-keyword">if</span> (lengthDataBits == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">fewerThan24bits</span> <span class="hljs-operator">=</span> lengthDataBits % TWENTYFOURBITGROUP;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numberTriplets</span> <span class="hljs-operator">=</span> lengthDataBits / TWENTYFOURBITGROUP;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numberQuartet</span> <span class="hljs-operator">=</span> fewerThan24bits != <span class="hljs-number">0</span> ? numberTriplets + <span class="hljs-number">1</span> : numberTriplets;<br>        <span class="hljs-type">char</span> encodedData[] = <span class="hljs-literal">null</span>;<br><br>        encodedData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[numberQuartet * <span class="hljs-number">4</span>];<br><br>        <span class="hljs-type">byte</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, l = <span class="hljs-number">0</span>, b1 = <span class="hljs-number">0</span>, b2 = <span class="hljs-number">0</span>, b3 = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">encodedIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dataIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numberTriplets; i++)<br>        &#123;<br>            b1 = binaryData[dataIndex++];<br>            b2 = binaryData[dataIndex++];<br>            b3 = binaryData[dataIndex++];<br><br>            l = (<span class="hljs-type">byte</span>) (b2 &amp; <span class="hljs-number">0x0f</span>);<br>            k = (<span class="hljs-type">byte</span>) (b1 &amp; <span class="hljs-number">0x03</span>);<br><br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val1</span> <span class="hljs-operator">=</span> ((b1 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b1 &gt;&gt; <span class="hljs-number">2</span>) : (<span class="hljs-type">byte</span>) ((b1) &gt;&gt; <span class="hljs-number">2</span> ^ <span class="hljs-number">0xc0</span>);<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val2</span> <span class="hljs-operator">=</span> ((b2 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b2 &gt;&gt; <span class="hljs-number">4</span>) : (<span class="hljs-type">byte</span>) ((b2) &gt;&gt; <span class="hljs-number">4</span> ^ <span class="hljs-number">0xf0</span>);<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val3</span> <span class="hljs-operator">=</span> ((b3 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b3 &gt;&gt; <span class="hljs-number">6</span>) : (<span class="hljs-type">byte</span>) ((b3) &gt;&gt; <span class="hljs-number">6</span> ^ <span class="hljs-number">0xfc</span>);<br><br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[val1];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[val2 | (k &lt;&lt; <span class="hljs-number">4</span>)];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[(l &lt;&lt; <span class="hljs-number">2</span>) | val3];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[b3 &amp; <span class="hljs-number">0x3f</span>];<br>        &#125;<br><br>        <span class="hljs-comment">// form integral number of 6-bit groups</span><br>        <span class="hljs-keyword">if</span> (fewerThan24bits == EIGHTBIT)<br>        &#123;<br>            b1 = binaryData[dataIndex];<br>            k = (<span class="hljs-type">byte</span>) (b1 &amp; <span class="hljs-number">0x03</span>);<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val1</span> <span class="hljs-operator">=</span> ((b1 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b1 &gt;&gt; <span class="hljs-number">2</span>) : (<span class="hljs-type">byte</span>) ((b1) &gt;&gt; <span class="hljs-number">2</span> ^ <span class="hljs-number">0xc0</span>);<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[val1];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[k &lt;&lt; <span class="hljs-number">4</span>];<br>            encodedData[encodedIndex++] = PAD;<br>            encodedData[encodedIndex++] = PAD;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fewerThan24bits == SIXTEENBIT)<br>        &#123;<br>            b1 = binaryData[dataIndex];<br>            b2 = binaryData[dataIndex + <span class="hljs-number">1</span>];<br>            l = (<span class="hljs-type">byte</span>) (b2 &amp; <span class="hljs-number">0x0f</span>);<br>            k = (<span class="hljs-type">byte</span>) (b1 &amp; <span class="hljs-number">0x03</span>);<br><br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val1</span> <span class="hljs-operator">=</span> ((b1 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b1 &gt;&gt; <span class="hljs-number">2</span>) : (<span class="hljs-type">byte</span>) ((b1) &gt;&gt; <span class="hljs-number">2</span> ^ <span class="hljs-number">0xc0</span>);<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">val2</span> <span class="hljs-operator">=</span> ((b2 &amp; SIGN) == <span class="hljs-number">0</span>) ? (<span class="hljs-type">byte</span>) (b2 &gt;&gt; <span class="hljs-number">4</span>) : (<span class="hljs-type">byte</span>) ((b2) &gt;&gt; <span class="hljs-number">4</span> ^ <span class="hljs-number">0xf0</span>);<br><br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[val1];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[val2 | (k &lt;&lt; <span class="hljs-number">4</span>)];<br>            encodedData[encodedIndex++] = lookUpBase64Alphabet[l &lt;&lt; <span class="hljs-number">2</span>];<br>            encodedData[encodedIndex++] = PAD;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encodedData);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Decodes Base64 data into octects</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> encoded string containing Base64 data</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Array containind decoded data.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decode(String encoded)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (encoded == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">char</span>[] base64Data = encoded.toCharArray();<br>        <span class="hljs-comment">// remove white spaces</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> removeWhiteSpace(base64Data);<br><br>        <span class="hljs-keyword">if</span> (len % FOURBYTE != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<span class="hljs-comment">// should be divisible by four</span><br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">numberQuadruple</span> <span class="hljs-operator">=</span> (len / FOURBYTE);<br><br>        <span class="hljs-keyword">if</span> (numberQuadruple == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br><br>        <span class="hljs-type">byte</span> decodedData[] = <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b2 = <span class="hljs-number">0</span>, b3 = <span class="hljs-number">0</span>, b4 = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">char</span> <span class="hljs-variable">d1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, d2 = <span class="hljs-number">0</span>, d3 = <span class="hljs-number">0</span>, d4 = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">encodedIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dataIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        decodedData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[(numberQuadruple) * <span class="hljs-number">3</span>];<br><br>        <span class="hljs-keyword">for</span> (; i &lt; numberQuadruple - <span class="hljs-number">1</span>; i++)<br>        &#123;<br><br>            <span class="hljs-keyword">if</span> (!isData((d1 = base64Data[dataIndex++])) || !isData((d2 = base64Data[dataIndex++]))<br>                    || !isData((d3 = base64Data[dataIndex++])) || !isData((d4 = base64Data[dataIndex++])))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-comment">// if found &quot;no data&quot; just return null</span><br><br>            b1 = base64Alphabet[d1];<br>            b2 = base64Alphabet[d2];<br>            b3 = base64Alphabet[d3];<br>            b4 = base64Alphabet[d4];<br><br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (b1 &lt;&lt; <span class="hljs-number">2</span> | b2 &gt;&gt; <span class="hljs-number">4</span>);<br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (((b2 &amp; <span class="hljs-number">0xf</span>) &lt;&lt; <span class="hljs-number">4</span>) | ((b3 &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xf</span>));<br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (b3 &lt;&lt; <span class="hljs-number">6</span> | b4);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!isData((d1 = base64Data[dataIndex++])) || !isData((d2 = base64Data[dataIndex++])))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<span class="hljs-comment">// if found &quot;no data&quot; just return null</span><br>        &#125;<br><br>        b1 = base64Alphabet[d1];<br>        b2 = base64Alphabet[d2];<br><br>        d3 = base64Data[dataIndex++];<br>        d4 = base64Data[dataIndex++];<br>        <span class="hljs-keyword">if</span> (!isData((d3)) || !isData((d4)))<br>        &#123;<span class="hljs-comment">// Check if they are PAD characters</span><br>            <span class="hljs-keyword">if</span> (isPad(d3) &amp;&amp; isPad(d4))<br>            &#123;<br>                <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xf</span>) != <span class="hljs-number">0</span>)<span class="hljs-comment">// last 4 bits should be zero</span><br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-type">byte</span>[] tmp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>];<br>                System.arraycopy(decodedData, <span class="hljs-number">0</span>, tmp, <span class="hljs-number">0</span>, i * <span class="hljs-number">3</span>);<br>                tmp[encodedIndex] = (<span class="hljs-type">byte</span>) (b1 &lt;&lt; <span class="hljs-number">2</span> | b2 &gt;&gt; <span class="hljs-number">4</span>);<br>                <span class="hljs-keyword">return</span> tmp;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isPad(d3) &amp;&amp; isPad(d4))<br>            &#123;<br>                b3 = base64Alphabet[d3];<br>                <span class="hljs-keyword">if</span> ((b3 &amp; <span class="hljs-number">0x3</span>) != <span class="hljs-number">0</span>)<span class="hljs-comment">// last 2 bits should be zero</span><br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-type">byte</span>[] tmp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>];<br>                System.arraycopy(decodedData, <span class="hljs-number">0</span>, tmp, <span class="hljs-number">0</span>, i * <span class="hljs-number">3</span>);<br>                tmp[encodedIndex++] = (<span class="hljs-type">byte</span>) (b1 &lt;&lt; <span class="hljs-number">2</span> | b2 &gt;&gt; <span class="hljs-number">4</span>);<br>                tmp[encodedIndex] = (<span class="hljs-type">byte</span>) (((b2 &amp; <span class="hljs-number">0xf</span>) &lt;&lt; <span class="hljs-number">4</span>) | ((b3 &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xf</span>));<br>                <span class="hljs-keyword">return</span> tmp;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123; <span class="hljs-comment">// No PAD e.g 3cQl</span><br>            b3 = base64Alphabet[d3];<br>            b4 = base64Alphabet[d4];<br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (b1 &lt;&lt; <span class="hljs-number">2</span> | b2 &gt;&gt; <span class="hljs-number">4</span>);<br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (((b2 &amp; <span class="hljs-number">0xf</span>) &lt;&lt; <span class="hljs-number">4</span>) | ((b3 &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xf</span>));<br>            decodedData[encodedIndex++] = (<span class="hljs-type">byte</span>) (b3 &lt;&lt; <span class="hljs-number">6</span> | b4);<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> decodedData;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * remove WhiteSpace from MIME containing encoded Base64 data.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data the byte array of base64 data (with WS)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the new length</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">removeWhiteSpace</span><span class="hljs-params">(<span class="hljs-type">char</span>[] data)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// count characters that&#x27;s not whitespace</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">newSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> data.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (!isWhiteSpace(data[i]))<br>            &#123;<br>                data[newSize++] = data[i];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> newSize;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h5 id="url编码"><a href="#url编码" class="headerlink" title="url编码"></a>url编码</h5><p>用来加密application&#x2F;x-www-from-urlencoded这样的数据格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">urlEncode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://test-zhgd/center/getUsername?username=gaozhe&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">encodedStr</span> <span class="hljs-operator">=</span> URLEncoder.encode(str, StandardCharsets.UTF_8.name());<br>    <span class="hljs-comment">// %E4%B9%90%E4%B9%8B%E8%80%85java</span><br>    System.out.println(<span class="hljs-string">&quot;encodedStr:&quot;</span> + encodedStr);<br>    <span class="hljs-comment">// url解码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> URLDecoder.decode(encodedStr, StandardCharsets.UTF_8.name());<br>    System.out.println(<span class="hljs-string">&quot;解码后的字符串:&quot;</span> + decode);<br>  &#125;<br></code></pre></td></tr></table></figure>







<h4 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h4><p>加密和解密使用的是两个不同的密钥（public key 和 private key).公钥可以给任何人，私钥总是自己保留。</p>
<h5 id="md5加密"><a href="#md5加密" class="headerlink" title="md5加密"></a>md5加密</h5><p>md5是不可逆的加密算法,在一定程度上保证了安全</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Md5Test</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">UTF8</span> <span class="hljs-operator">=</span> StandardCharsets.UTF_8.name();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用codec来实现md5</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;这是一段测试文本&quot;</span>;<br>        <span class="hljs-comment">// 33b7ac3e2a042a131dc1596414d8ddf7</span><br>        System.out.println(DigestUtils.md5Hex(str.getBytes(UTF8)));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用jdk原生api来实现md5</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;这是一段测试文本&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">algorithm</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MD5&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hexStr</span> <span class="hljs-operator">=</span> MessageDigestUtils.doDigest(str,algorithm);<br>        <span class="hljs-comment">// 结果: 33b7ac3e2a042a131dc1596414d8ddf7</span><br>        System.out.println(<span class="hljs-string">&quot;hexStr:&quot;</span>+hexStr);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>





<blockquote>
<p>工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MD5Utils</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SAFDSAFADS,(#336,.!F332&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String str)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>      md.update(KEY.getBytes(StandardCharsets.UTF_8));<br>      md.update(str.getBytes(StandardCharsets.UTF_8));<br>      <span class="hljs-type">byte</span>[] digest = md.digest();<br>      <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : digest) &#123;<br>        sb.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b &amp; <span class="hljs-number">0xff</span>));<br>      &#125;<br>      <span class="hljs-keyword">return</span> sb.toString();<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h2 id="三十四、枚举工具类"><a href="#三十四、枚举工具类" class="headerlink" title="三十四、枚举工具类"></a>三十四、枚举工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/18 14:38</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValueEnum</span>&lt;T&gt; &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取枚举值</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 枚举值</span><br><span class="hljs-comment">   */</span><br>  T <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/18 14:49</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NameValueEnum</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValueEnum</span>&lt;T&gt; &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取枚举名称</span><br><span class="hljs-comment">   */</span><br>  String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">EnumUtils</span><br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 枚举工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/18 15:20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumUtils</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据枚举值获取对应的枚举对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> enumClass 枚举类</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value     枚举值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 枚举对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValueEnum</span>&lt;V&gt;&gt;, V&gt; E <span class="hljs-title function_">getEnumByValue</span><span class="hljs-params">(Class&lt;E&gt; enumClass,</span><br><span class="hljs-params">      V value)</span> &#123;<br>    <span class="hljs-keyword">return</span> getEnumByValue(enumClass.getEnumConstants(), value);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据枚举值获取对应的枚举对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> enums 枚举列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 枚举对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValueEnum</span>&lt;V&gt;&gt;, V&gt; E <span class="hljs-title function_">getEnumByValue</span><span class="hljs-params">(E[] enums, V value)</span> &#123;<br>    <span class="hljs-keyword">for</span> (E e : enums) &#123;<br>      <span class="hljs-keyword">if</span> (((ValueEnum&lt;V&gt;) e).getValue().equals(value)) &#123;<br>        <span class="hljs-keyword">return</span> e;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断枚举值是否在对应枚举列表存在</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> enums 枚举列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExist</span><span class="hljs-params">(ValueEnum&lt;T&gt;[] enums, T value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (ValueEnum&lt;T&gt; e : enums) &#123;<br>      <span class="hljs-keyword">if</span> (value.equals(e.getValue())) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 判断枚举值是否存在于指定枚举类中</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> enumClass 枚举类</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value     枚举值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> true/false</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValueEnum</span>&lt;V&gt;&gt;, V&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExist</span><span class="hljs-params">(Class&lt;E&gt; enumClass,</span><br><span class="hljs-params">      V value)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Enum&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValueEnum</span>&lt;V&gt;&gt; e : enumClass.getEnumConstants()) &#123;<br>      <span class="hljs-keyword">if</span> (((ValueEnum&lt;V&gt;) e).getValue().equals(value)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<blockquote>
<p>demo</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> gzzear</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2023/03/18 15:24</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TestEnum</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NameValueEnum</span>&lt;Integer&gt; &#123;<br>  CONFIRMED(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;确认&quot;</span>),<br>  NOT_CONFIRMED(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;未确认&quot;</span>);<br><br>  <span class="hljs-keyword">private</span> Integer type;<br>  <span class="hljs-keyword">private</span> String desc;<br><br>  TestEnum(Integer type, String desc) &#123;<br>    <span class="hljs-built_in">this</span>.type = type;<br>    <span class="hljs-built_in">this</span>.desc = desc;<br>  &#125;<br><br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> desc;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> type;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h2 id="三十五、Spring事件"><a href="#三十五、Spring事件" class="headerlink" title="三十五、Spring事件"></a>三十五、Spring事件</h2><p>Spring Event是Spring的事件通知机制，可以将相互耦合的代码解耦，从而方便功能的修改与添加。Spring Event是监听者模式的一个具体实现。</p>
<p>监听者模式包含了监听者Listener、事件Event、事件发布者EventPublish，过程就是EventPublish发布一个事件，被监听者捕获到，然后执行事件相应的方法。</p>
<p>Spring Event的相关API在spring-context包中。</p>
<blockquote>
<p>入门案例</p>
</blockquote>
<p>创建OptLogDTO类，用于封装操作日志信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptLogDTO</span> &#123;<br>    <span class="hljs-keyword">private</span> String requestIp; <span class="hljs-comment">//操作IP</span><br>    <span class="hljs-keyword">private</span> String type; <span class="hljs-comment">//日志类型 LogType&#123;OPT:操作类型;EX:异常类型&#125;</span><br>    <span class="hljs-keyword">private</span> String userName; <span class="hljs-comment">//操作人</span><br>    <span class="hljs-keyword">private</span> String description; <span class="hljs-comment">//操作描述</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p>创建事件类SysLogEvent:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.itcast.dto.OptLogDTO;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationEvent;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 定义系统日志事件</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysLogEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SysLogEvent</span><span class="hljs-params">(OptLogDTO optLogDTO)</span> &#123;<br>        <span class="hljs-built_in">super</span>(optLogDTO);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>创建监听器类SysLogListener:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.itcast.dto.OptLogDTO;<br><span class="hljs-keyword">import</span> cn.itcast.event.SysLogEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.event.EventListener;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 异步监听日志事件</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysLogListener</span> &#123;<br>    <span class="hljs-meta">@Async</span><span class="hljs-comment">//异步处理</span><br>    <span class="hljs-meta">@EventListener(SysLogEvent.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveSysLog</span><span class="hljs-params">(SysLogEvent event)</span> &#123;<br>        <span class="hljs-type">OptLogDTO</span> <span class="hljs-variable">sysLog</span> <span class="hljs-operator">=</span> (OptLogDTO) event.getSource();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>        System.out.println(<span class="hljs-string">&quot;监听到日志操作事件：&quot;</span> + sysLog + <span class="hljs-string">&quot; 线程id：&quot;</span> + id);<br>        <span class="hljs-comment">//将日志信息保存到数据库...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>创建Controller，用于发布事件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.itcast.dto.OptLogDTO;<br><span class="hljs-keyword">import</span> cn.itcast.event.SysLogEvent;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationEvent;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br>    <span class="hljs-meta">@GetMapping(&quot;/getUser&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//构造操作日志信息</span><br>        <span class="hljs-type">OptLogDTO</span> <span class="hljs-variable">logInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptLogDTO</span>();<br>        logInfo.setRequestIp(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>        logInfo.setUserName(<span class="hljs-string">&quot;admin&quot;</span>);<br>        logInfo.setType(<span class="hljs-string">&quot;OPT&quot;</span>);<br>        logInfo.setDescription(<span class="hljs-string">&quot;查询用户信息&quot;</span>);<br>		<br>        <span class="hljs-comment">//构造事件对象</span><br>        <span class="hljs-type">ApplicationEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysLogEvent</span>(logInfo);<br>        <br>        <span class="hljs-comment">//发布事件</span><br>        applicationContext.publishEvent(event);<br>        <br>        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>        System.out.println(<span class="hljs-string">&quot;发布事件,线程id：&quot;</span> + id);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;OK&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>创建启动类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableAsync</span><span class="hljs-comment">//启用异步处理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringEventApp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SpringEventApp.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="三十六、图片处理"><a href="#三十六、图片处理" class="headerlink" title="三十六、图片处理"></a>三十六、图片处理</h2><blockquote>
<p>导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.coobird<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>thumbnailator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.4.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="指定大小缩放"><a href="#指定大小缩放" class="headerlink" title="指定大小缩放"></a>指定大小缩放</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//size(宽度, 高度)  </span><br>  <br><span class="hljs-comment">/*   </span><br><span class="hljs-comment"> * 若图片横比200小，高比300小，不变   </span><br><span class="hljs-comment"> * 若图片横比200小，高比300大，高缩小到300，图片比例不变   </span><br><span class="hljs-comment"> * 若图片横比200大，高比300小，横缩小到200，图片比例不变   </span><br><span class="hljs-comment"> * 若图片横比200大，高比300大，图片按比例缩小，横为200或高为300   </span><br><span class="hljs-comment"> */</span>   <br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">200</span>, <span class="hljs-number">300</span>)  <br>        .toFile(<span class="hljs-string">&quot;c:/a380_200x300.jpg&quot;</span>);  <br>  <br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">2560</span>, <span class="hljs-number">2048</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_2560x2048.jpg&quot;</span>);  <br></code></pre></td></tr></table></figure>





<h3 id="单个图片等比例缩放"><a href="#单个图片等比例缩放" class="headerlink" title="单个图片等比例缩放"></a>单个图片等比例缩放</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;c:\\test.png&quot;</span>);<br> <br>Thumbnails.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)).scale(<span class="hljs-number">3.0</span>).toFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;c:\\yyyyy.png&quot;</span>));<br></code></pre></td></tr></table></figure>

<p>  3.0是一个double类型的数字，缩放比例，大于1就是变大，小于1就是缩小</p>
<h3 id="不按照比例，指定大小进行缩放"><a href="#不按照比例，指定大小进行缩放" class="headerlink" title="不按照比例，指定大小进行缩放"></a><strong>不按照比例，指定大小进行缩放</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//keepAspectRatio(false) 默认是按照比例缩放的  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>)   <br>        .keepAspectRatio(<span class="hljs-literal">false</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_200x200.jpg&quot;</span>);  <br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">compressTest</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    res.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">500</span>);<br>    <span class="hljs-comment">// 判断上传文件是否为空</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == file || <span class="hljs-number">0</span> == file.getSize()) &#123;<br>      res.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;上传文件不能为空&quot;</span>);<br>      <span class="hljs-keyword">return</span> res;<br>    &#125;<br>    <span class="hljs-comment">// 拿到文件后缀名，例如：png</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> file.getOriginalFilename()<br>        .substring(file.getOriginalFilename().lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// UUID 作为文件名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> String.valueOf(UUID.randomUUID());<br>    <span class="hljs-comment">// 新的文件名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;4/14&quot;</span> + <span class="hljs-string">&quot;/&quot;</span> + uuid + <span class="hljs-string">&quot;.&quot;</span> + suffix;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断是否是图片</span><br><span class="hljs-comment">     * 判断是否超过了 100K</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (isPicture(suffix) &amp;&amp; (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">0.1</span>) &lt;= file.getSize()) &#123;<br>      <span class="hljs-comment">// 在项目根目录下的 upload 目录中生成临时文件</span><br>      <span class="hljs-type">File</span> <span class="hljs-variable">newFile</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;compress&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>+suffix);<br>      <span class="hljs-comment">// 小于 1M 的</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">0.1</span>) &lt;= file.getSize() &amp;&amp; file.getSize() &lt;= (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)) &#123;<br>        Thumbnails.of(file.getInputStream()).scale(<span class="hljs-number">1f</span>).outputQuality(<span class="hljs-number">0.3f</span>).toFile(newFile);<br>      &#125;<br>      <span class="hljs-comment">// 1 - 2M 的</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) &lt; file.getSize() &amp;&amp; file.getSize() &lt;= (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">2</span>)) &#123;<br>        Thumbnails.of(file.getInputStream()).scale(<span class="hljs-number">1f</span>).outputQuality(<span class="hljs-number">0.2f</span>).toFile(newFile);<br>      &#125;<br>      <span class="hljs-comment">// 2M 以上的</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">2</span>) &lt; file.getSize()) &#123;<br>        Thumbnails.of(file.getInputStream()).scale(<span class="hljs-number">1f</span>).outputQuality(<span class="hljs-number">0.1f</span>).toFile(newFile);<br>      &#125;<br>      <span class="hljs-comment">// 获取输入流</span><br>      <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(newFile);<br>      <span class="hljs-comment">// 转为 MultipartFile</span><br>      <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockMultipartFile</span>(<span class="hljs-string">&quot;file&quot;</span>, newFile.getName(), <span class="hljs-string">&quot;text/plain&quot;</span>,<br>          input);<br>      <span class="hljs-comment">// 开始上传</span><br>      MinIOUtils.uploadFile(multipartFile, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;compress&quot;</span>);<br>      <span class="hljs-comment">// 删除临时文件</span><br>      newFile.delete();<br>      <span class="hljs-comment">// 返回状态以及图片路径</span><br>      res.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">200</span>);<br>      res.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;上传成功&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 不需要压缩，直接上传</span><br>    <span class="hljs-keyword">else</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>  &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MediaFileVO <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(MultipartFile file, String folder, String bucket)</span><br>      <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">file_url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(bucket)) &#123;<br>      bucket = bucketName;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//初始化minioClient</span><br>      initMinioClient();<br>      <span class="hljs-comment">//如果不存在bucket则创建</span><br>      createBucket(bucket);<br>      <span class="hljs-type">MediaFileVO</span> <span class="hljs-variable">mediaFileVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFileVO</span>();<br>      mediaFileVO.setFileSize(file.getSize());<br>      mediaFileVO.setBucketName(bucket);<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> file.getInputStream();<br>      <span class="hljs-comment">// 获取文件名</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">orgName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>      <span class="hljs-keyword">if</span> (StringUtils.isBlank(orgName)) &#123;<br>        orgName = file.getName();<br>      &#125;<br>      orgName = getFileName(orgName);<br>      mediaFileVO.setFileName(orgName);<br>      <span class="hljs-comment">//获取文件类型</span><br>      <span class="hljs-keyword">if</span> (orgName.indexOf(<span class="hljs-string">&quot;.&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> orgName.substring(orgName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>        mediaFileVO.setFileType(extension);<br>      &#125;<br>      <span class="hljs-comment">//加密文件名称</span><br>      orgName = DigestUtils.md5Hex(file.getBytes());<br>      <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> (!orgName.contains(<span class="hljs-string">&quot;.&quot;</span>)<br>          ? orgName + <span class="hljs-string">&quot;_&quot;</span> + System.currentTimeMillis()<br>          : orgName.substring(<span class="hljs-number">0</span>, orgName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)) + <span class="hljs-string">&quot;_&quot;</span> + System.currentTimeMillis()<br>              + orgName.substring(orgName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>))) + <span class="hljs-string">&quot;.&quot;</span> + mediaFileVO.getFileType();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>));<br>      <span class="hljs-keyword">if</span> (StringUtils.isNoneEmpty(folder)) &#123;<br>        path = folder + <span class="hljs-string">&quot;/&quot;</span> + path;<br>      &#125;<br>      <span class="hljs-comment">// 使用putObject上传一个本地文件到存储桶中。</span><br>      <span class="hljs-keyword">if</span> (fileName.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        fileName = fileName.substring(<span class="hljs-number">1</span>);<br>      &#125;<br>      fileName = path + <span class="hljs-string">&quot;/&quot;</span> + fileName;<br>      mediaFileVO.setFilePath(<span class="hljs-string">&quot;/&quot;</span> + fileName);<br>      <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">objectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder().object(fileName)<br>          .bucket(bucket)<br>          .contentType(file.getContentType())<br>          .stream(stream, stream.available(), -<span class="hljs-number">1</span>).build();<br>      minioClient.putObject(objectArgs);<br>      stream.close();<br>      file_url = getBasisUrl(bucket) + fileName;<br>      mediaFileVO.setUrl(file_url);<br>      <span class="hljs-keyword">return</span> mediaFileVO;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(e.getMessage(), e);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage());<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>







<h3 id="批量产生缩略图"><a href="#批量产生缩略图" class="headerlink" title="批量产生缩略图"></a>批量产生缩略图</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Thumbnails.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\pics&quot;</span>).listFiles()).scale(<span class="hljs-number">0.2</span>).outputFormat(<span class="hljs-string">&quot;png&quot;</span>)<br> <br>.toFiles(Rename.PREFIX_DOT_THUMBNAIL);<br></code></pre></td></tr></table></figure>



<h3 id="控制图片质量，图片尺寸不变"><a href="#控制图片质量，图片尺寸不变" class="headerlink" title="控制图片质量，图片尺寸不变"></a>控制图片质量，图片尺寸不变</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cobol">File fromPic  =new File(&quot;C:\\Users\\Administrator\\Desktop\\IdCardPositive_987136936_1531741954688.jpeg&quot;);<br>File toPic =new File(&quot;C:\\Users\\Administrator\\Desktop\\IdCardPositive_987136936_08.jpeg&quot;);<br>Thumbnails.of(fromPic).scale(1f).outputQuality(0.25f).toFile(toPic);  <br></code></pre></td></tr></table></figure>

<p><strong>outputQuality就是用来控制图片质量的</strong></p>
<h3 id="给图片加水印"><a href="#给图片加水印" class="headerlink" title="给图片加水印"></a>给图片加水印</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">Thumbnails.of(fromPic).scale(<span class="hljs-number">0.8</span>)<br>          .watermark(Positions.BOTTOM_RIGHT, ImageIO.read(waterPic), <span class="hljs-number">0.5f</span>)<br>          .outputQuality(<span class="hljs-number">0.8f</span>).toFile(toPic);<br> <br><span class="hljs-comment">//watermark(位置，水印图，透明度)  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">1280</span>, <span class="hljs-number">1024</span>)  <br>        .watermark(Positions.BOTTOM_RIGHT, ImageIO.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;images/watermark.png&quot;</span>)), <span class="hljs-number">0.5f</span>)   <br>        .outputQuality(<span class="hljs-number">0.8f</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_watermark_bottom_right.jpg&quot;</span>);  <br>  <br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">1280</span>, <span class="hljs-number">1024</span>)  <br>        .watermark(Positions.CENTER, ImageIO.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;images/watermark.png&quot;</span>)), <span class="hljs-number">0.5f</span>)   <br>        .outputQuality(<span class="hljs-number">0.8f</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_watermark_center.jpg&quot;</span>);  <br></code></pre></td></tr></table></figure>





<h3 id="旋转图片"><a href="#旋转图片" class="headerlink" title="旋转图片"></a><strong>旋转图片</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Thumbnails.of(fromPic).scale(<span class="hljs-number">0.5</span>).rotate(<span class="hljs-number">90</span>).toFile(toPic);  <br></code></pre></td></tr></table></figure>





<h3 id="图片裁剪"><a href="#图片裁剪" class="headerlink" title="图片裁剪"></a><strong>图片裁剪</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">Thumbnails.of(fromPic).sourceRegion(Positions.CENTER, <span class="hljs-number">300</span>, <span class="hljs-number">300</span>).scale(<span class="hljs-number">1.0</span>).toFile(toPic);<br> <br><span class="hljs-comment">//sourceRegion()  </span><br>  <br><span class="hljs-comment">//图片中心400*400的区域  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)  <br>        .sourceRegion(Positions.CENTER, <span class="hljs-number">400</span>,<span class="hljs-number">400</span>)  <br>        .size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>)  <br>        .keepAspectRatio(<span class="hljs-literal">false</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_region_center.jpg&quot;</span>);  <br>  <br><span class="hljs-comment">//图片右下400*400的区域  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)  <br>        .sourceRegion(Positions.BOTTOM_RIGHT, <span class="hljs-number">400</span>,<span class="hljs-number">400</span>)  <br>        .size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>)  <br>        .keepAspectRatio(<span class="hljs-literal">false</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_region_bootom_right.jpg&quot;</span>);  <br>  <br><span class="hljs-comment">//指定坐标  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)  <br>        .sourceRegion(<span class="hljs-number">600</span>, <span class="hljs-number">500</span>, <span class="hljs-number">400</span>, <span class="hljs-number">400</span>)  <br>        .size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>)  <br>        .keepAspectRatio(<span class="hljs-literal">false</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_region_coord.jpg&quot;</span>);  <br></code></pre></td></tr></table></figure>





<h3 id="图像的格式转换"><a href="#图像的格式转换" class="headerlink" title="图像的格式转换"></a>图像的格式转换</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//outputFormat(图像格式)  </span><br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">1280</span>, <span class="hljs-number">1024</span>)  <br>        .outputFormat(<span class="hljs-string">&quot;png&quot;</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_1280x1024.png&quot;</span>);   <br>  <br>Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">1280</span>, <span class="hljs-number">1024</span>)  <br>        .outputFormat(<span class="hljs-string">&quot;gif&quot;</span>)   <br>        .toFile(<span class="hljs-string">&quot;c:/a380_1280x1024.gif&quot;</span>);   <br></code></pre></td></tr></table></figure>





<h3 id="输出到BufferedImage"><a href="#输出到BufferedImage" class="headerlink" title="输出到BufferedImage"></a><strong>输出到BufferedImage</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//asBufferedImage() 返回BufferedImage  </span><br><span class="hljs-type">BufferedImage</span> <span class="hljs-variable">thumbnail</span> <span class="hljs-operator">=</span> Thumbnails.of(<span class="hljs-string">&quot;images/a380_1280x1024.jpg&quot;</span>)   <br>        .size(<span class="hljs-number">1280</span>, <span class="hljs-number">1024</span>)  <br>        .asBufferedImage();  <br> <br>ImageIO.write(thumbnail, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;c:/a380_1280x1024_BufferedImage.jpg&quot;</span>));   <br></code></pre></td></tr></table></figure>









<h2 id="三十七、敏感词过滤"><a href="#三十七、敏感词过滤" class="headerlink" title="三十七、敏感词过滤"></a>三十七、敏感词过滤</h2><blockquote>
<p> 技术选型</p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>方案</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>数据库模糊查询</td>
<td>效率太低</td>
</tr>
<tr>
<td>String.indexOf(“”)查找</td>
<td>数据库量大的话也是比较慢</td>
</tr>
<tr>
<td>全文检索</td>
<td>分词再匹配</td>
</tr>
<tr>
<td>DFA算法</td>
<td>确定有穷自动机(一种数据结构)</td>
</tr>
</tbody></table>
<blockquote>
<p>DFA实现原理</p>
</blockquote>
<p>DFA全称为：Deterministic Finite Automaton,即确定有穷自动机。</p>
<p>存储：一次性的把所有的敏感词存储到了多个map中，就是下图表示这种结构</p>
<p>敏感词：冰毒、大麻、大坏蛋</p>
<p><img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20210524160517744.png" srcset="/img/loading.gif" lazyload alt="image-20210524160517744"></p>
<p>检索的过程</p>
<img src="/2022/07/02/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/image-20230625000621934.png" srcset="/img/loading.gif" lazyload alt="image-20230625000621934" style="zoom:50%;">





<blockquote>
<p>实战</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 敏感词信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_sensitive&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmSensitive</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 敏感词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;sensitives&quot;)</span><br>    <span class="hljs-keyword">private</span> String sensitives;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//.....省略</span><br><br><span class="hljs-comment">//自管理的敏感词过滤</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">isSensitive</span> <span class="hljs-operator">=</span> handleSensitiveScan((String) textAndImages.get(<span class="hljs-string">&quot;content&quot;</span>), wmNews);<br><span class="hljs-keyword">if</span>(!isSensitive) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//.....省略</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SensitiveWordUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; dictionaryMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成关键词字典库</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> words</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initMap</span><span class="hljs-params">(Collection&lt;String&gt; words)</span> &#123;<br>        <span class="hljs-keyword">if</span> (words == <span class="hljs-literal">null</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;敏感词列表不能为空&quot;</span>);<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br><br>        <span class="hljs-comment">// map初始长度words.size()，整个字典库的入口字数(小于words.size()，因为不同的词可能会有相同的首字)</span><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(words.size());<br>        <span class="hljs-comment">// 遍历过程中当前层次的数据</span><br>        Map&lt;String, Object&gt; curMap = <span class="hljs-literal">null</span>;<br>        Iterator&lt;String&gt; iterator = words.iterator();<br><br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">word</span> <span class="hljs-operator">=</span> iterator.next();<br>            curMap = map;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> word.length();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>                <span class="hljs-comment">// 遍历每个词的字</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> String.valueOf(word.charAt(i));<br>                <span class="hljs-comment">// 当前字在当前层是否存在, 不存在则新建, 当前层数据指向下一个节点, 继续判断是否存在数据</span><br>                Map&lt;String, Object&gt; wordMap = (Map&lt;String, Object&gt;) curMap.get(key);<br>                <span class="hljs-keyword">if</span> (wordMap == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// 每个节点存在两个数据: 下一个节点和isEnd(是否结束标志)</span><br>                    wordMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);<br>                    wordMap.put(<span class="hljs-string">&quot;isEnd&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>                    curMap.put(key, wordMap);<br>                &#125;<br>                curMap = wordMap;<br>                <span class="hljs-comment">// 如果当前字是词的最后一个字，则将isEnd标志置1</span><br>                <span class="hljs-keyword">if</span> (i == len -<span class="hljs-number">1</span>) &#123;<br>                    curMap.put(<span class="hljs-string">&quot;isEnd&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        dictionaryMap = map;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 搜索文本中某个文字是否匹配关键词</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> text</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beginIndex</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkWord</span><span class="hljs-params">(String text, <span class="hljs-type">int</span> beginIndex)</span> &#123;<br>        <span class="hljs-keyword">if</span> (dictionaryMap == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;字典不能为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">wordLength</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        Map&lt;String, Object&gt; curMap = dictionaryMap;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> text.length();<br>        <span class="hljs-comment">// 从文本的第beginIndex开始匹配</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> beginIndex; i &lt; len; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> String.valueOf(text.charAt(i));<br>            <span class="hljs-comment">// 获取当前key的下一个节点</span><br>            curMap = (Map&lt;String, Object&gt;) curMap.get(key);<br>            <span class="hljs-keyword">if</span> (curMap == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                wordLength ++;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(curMap.get(<span class="hljs-string">&quot;isEnd&quot;</span>))) &#123;<br>                    isEnd = <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!isEnd) &#123;<br>            wordLength = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> wordLength;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取匹配的关键词和命中次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> text</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Integer&gt; <span class="hljs-title function_">matchWords</span><span class="hljs-params">(String text)</span> &#123;<br>        Map&lt;String, Integer&gt; wordMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> text.length();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">wordLength</span> <span class="hljs-operator">=</span> checkWord(text, i);<br>            <span class="hljs-keyword">if</span> (wordLength &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">word</span> <span class="hljs-operator">=</span> text.substring(i, i + wordLength);<br>                <span class="hljs-comment">// 添加关键词匹配次数</span><br>                <span class="hljs-keyword">if</span> (wordMap.containsKey(word)) &#123;<br>                    wordMap.put(word, wordMap.get(word) + <span class="hljs-number">1</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    wordMap.put(word, <span class="hljs-number">1</span>);<br>                &#125;<br><br>                i += wordLength - <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> wordMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;法轮&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;法轮功&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;冰毒&quot;</span>);<br>        initMap(list);<br>        String content=<span class="hljs-string">&quot;我是一个好人，并不会卖冰毒，也不操练法轮功,我真的不卖冰毒&quot;</span>;<br>        Map&lt;String, Integer&gt; map = matchWords(content);<br>        System.out.println(map);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmSensitiveMapper wmSensitiveMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自管理的敏感词审核</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleSensitiveScan</span><span class="hljs-params">(String content, WmNews wmNews)</span> &#123;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">//获取所有的敏感词</span><br>    List&lt;WmSensitive&gt; wmSensitives = wmSensitiveMapper.selectList(Wrappers.&lt;WmSensitive&gt;lambdaQuery().select(WmSensitive::getSensitives));<br>    List&lt;String&gt; sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());<br><br>    <span class="hljs-comment">//初始化敏感词库</span><br>    SensitiveWordUtil.initMap(sensitiveList);<br><br>    <span class="hljs-comment">//查看文章中是否包含敏感词</span><br>    Map&lt;String, Integer&gt; map = SensitiveWordUtil.matchWords(content);<br>    <span class="hljs-keyword">if</span>(map.size() &gt;<span class="hljs-number">0</span>)&#123;<br>        updateWmNews(wmNews,(<span class="hljs-type">short</span>) <span class="hljs-number">2</span>,<span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>+map);<br>        flag = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> flag;<br>&#125;<br></code></pre></td></tr></table></figure>














                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93/" class="category-chain-item">编程技巧总结</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" class="print-no-link">#编程技巧</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>常用工具类</div>
      <div>http://example.com/2022/07/02/常用的工具类/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>gaozhe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/20/juc%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/06/16/MySQL45%E8%AE%B2/" title="MySql45讲">
                        <span class="hidden-mobile">MySql45讲</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
